  <script type="text/worker">
	var styleCount = 9; // THIS NUMBER MUST BE EQUAL TO THE NUMBER OF COLOR SETTINGS
	on("change:sheetstyle sheet:opened", function(event) {
		var styleAttrs = {};

		for(i = 0; i < styleCount; i++){
			styleAttrs["styleset"+i]="off";
		}
		
		getAttrs(["sheetstyle"] ,function(values) {
			var on = values.sheetstyle;
			styleAttrs["styleset"+on]="on";
			setAttrs(styleAttrs);
		});
	});
</script>
<input type="checkbox" name="attr_styleset0" class="color-setting color-setting-0" ></input> <!-- Used to activate the color setting rule, add one to add a new style, mind the numbering-->
<input type="checkbox" name="attr_styleset1" class="color-setting color-setting-1" ></input>
<input type="checkbox" name="attr_styleset2" class="color-setting color-setting-2" ></input>
<input type="checkbox" name="attr_styleset3" class="color-setting color-setting-3" ></input>
<input type="checkbox" name="attr_styleset4" class="color-setting color-setting-4" ></input>
<input type="checkbox" name="attr_styleset5" class="color-setting color-setting-5" ></input>
<input type="checkbox" name="attr_styleset6" class="color-setting color-setting-6" ></input>
<input type="checkbox" name="attr_styleset7" class="color-setting color-setting-7" ></input>
<input type="checkbox" name="attr_styleset8" class="color-setting color-setting-8" ></input>
<div class="default-translation-options" style="display:none;">
	<!-- define translations for fields located in sheet.json -->
	<span data-i18n="sheet-roll-modifier-option">Roll Modifier Option</span>
	<span data-i18n="sheet-roll-modifier-option-desc">Select the modifier option to use when clicking a dice roll icon on the character sheet.</span>
	<span data-i18n="sheet-chat-roll-display-option">Chat Roll Display</span>
	<span data-i18n="sheet-chat-roll-dislpay-option-desc">Select how rolls are display in chat window. <b>Private Skill Levels <em>deprecated</em></b> will default to private, since it doesn't work with rolltemplates.</span>
	<span data-i18n="sheet-basic-speed-button-option">Basic Speed Button Option</span>
	<span data-i18n="sheet-basic-speed-button-option-desc">Select how the basic speed button is displayed in chat window.</span>
	<span data-i18n="sheet-enter-unspent-points">Enter unspent points</span>
	<span data-i18n="sheet-enter-unspent-points-desc">If checked, show text box for unspent points. If unchecked, unspent points is calculated from Total Points text box.</span>
	<span data-i18n="sheet-use-malfunction">Use malfunction</span>
	<span data-i18n="sheet-use-malfunction-desc">If checked, rolltable will check for malfunction.</span>
	<span data-i18n="sheet-damage-dice-icon">Damage Dice Icon</span>
	<span data-i18n="sheet-damage-dice-icon-desc">Select icon to use for damage dice.</span>
	<span data-i18n="sheet-attribute-mods-option">Attribute Modifications</span>
	<span data-i18n="sheet-attribute-mods-option-desc">Select option on how to apply modifications to attributes.</span>
	<span data-i18n="sheet-critical-successes-option">Critical Successes</span>
	<span data-i18n="sheet-critical-successes-option-desc">Select option to determine critical success on a skill roll on rolltemplates.</span>
	<span data-i18n="sheet-show-minimum-damage-type-notes">Show Minimum Damage Type Notes</span>
	<span data-i18n="sheet-show-minimum-damage-type-notes-desc">If checked, minimum damage type notes will be added to the damage roll table.</span>
	<span data-i18n="sheet-show-damage-type-notes">Show Damage Type Notes</span>
	<span data-i18n="sheet-show-damage-type-notes-desc">If checked, damage type notes will be added to the damage roll table.</span>
	<span data-i18n="sheet-damage-type-note-spec">Damage Type Note Special</span>
	<span data-i18n="sheet-damage-type-note-spec-desc">Enter notes for Special damage type.</span>
	<span data-i18n="sheet-penalty-per-spell-on">Penalty for each spell ON</span>
	<span data-i18n="sheet-penalty-per-spell-on-desc">Enter a negative integer for the penalty.</span>
	<span data-i18n="sheet-penalty-per-spell-maintained">Penalty for each spell MAINTAINED</span>
	<span data-i18n="sheet-penalty-per-spell-maintained-desc">Enter a negative integer for the penalty.</span>
	<span data-i18n="sheet-show-casting-details">Show casting details on roll template:</span>
	<span data-i18n="sheet-show-casting-details-desc">If checked, detailed notes like casting time, duration, cost, maintain, resisted by, and class will be shown on the roll results template.</span>
	<span data-i18n="sheet-fragmentation-recoil">Fragmentation Recoil</span>
	<span data-i18n="sheet-fragmentation-recoil-desc">Recoil for Fragmentation Damage.</span>
	<span data-i18n="sheet-point-summary-layout-option">Point Summary Layout</span>
	<span data-i18n="sheet-point-summary-layout-option-desc">Select option on how to display the Point Summary Table.</span>
	<span data-i18n="sheet-show-old-techniques">Show Original Techniques Table</span>
	<span data-i18n="sheet-show-old-techniques-desc">If checked, original techniques table will be visible.</span>
	<span data-i18n="sheet-show-new-techniques">Show Revised Techniques Table</span>
	<span data-i18n="sheet-show-new-techniques-desc">If checked, revised techniques table will be visible.</span>
	<span data-i18n="sheet-show-raw-defense=notes">Show Active Defense Notes</span>
	<span data-i18n="sheet-show-raw-defense=notes-desc">If checked, show Rules as Written (RAW) for Active Defense success/fail notes.</span>
	<span data-i18n="sheet-style-option">Sheet Style</span>
	<span data-i18n="sheet-style-desc">Select a visual style for the character sheet.</span>
</div>


<div class="wrapper">
	
	<input type="hidden" name="attr_show_roll_modifiers" value="0" />
	<input type="hidden" name="attr_roll_modifier_types" value="" />
	<input type="hidden" name="attr_roll_modifier_summary" value="" />
	<input type="hidden" name="attr_roll_trait_summary" value="" />
	<input type="hidden" name="attr_roll_hit_location" value="" />
	<input type="hidden" name="attr_roll_maneuver" value=""  />
	<input type="hidden" name="attr_roll_allout_attack" value=""  />
	<input type="hidden" name="attr_roll" value=""  />
	<input type="hidden" name="attr_modifier" value="[[?{Modifier|0}]]" />
	<div class="modal">
		<div class="modal-dialog">
			<div class="modal-header">
				<div class="close-button">
					<button type="action" name="act_close_roll_modifiers" class="btn close" title="Close">X</button>
				</div>
				<h2>
					<span data-i18n="roll-modifiers-heading">Roll Modifiers</span>
				</h2>
			</div>
			<div class="modal-body">
				
				<div class="modal-sub-header">
					<!-- GRID Layout X (see css) items per row -->
					<div class="container">

						<!-- row 1 -->
						<div class="item item1">

							<div class="block add-min-height">
								<input type="number" readonly="readonly" value="0" name="attr_roll_modifier" title="macro name: @{roll_modifier}" />
								<span data-i18n="total-roll-modifier-label">Total Modifier</span>
							</div>

							<div class="block">
								<div class="item item1">
									<label>
										<select name="attr_shock_penalty" class="number-only-width" title="macro name: @{shock_penalty}">
											<option>0</option>
											<option>-1</option>
											<option>-2</option>
											<option>-3</option>
											<option>-4</option>
										</select>
										<span data-i18n="shock-label">Shock</span>
									</label>
								</div>
							</div>

						</div>

						<div class="item item2">

							<div class="block add-min-height">
								<label>
									<div>
										<input type="checkbox" name="attr_max_skill_nine" value="1" title="Macro: @{max_skill_nine}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="max-skill-9-label">Max skill of 9</span>
											<span class="tooltiptext">
												<span data-i18n="max-skill-9-tooltip">The effective skill cannot exceed 9.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="block">
								<label>
									<input type="number" value="0" step="1" name="attr_dialog_custom_roll_modifier" title="macro name: @{dialog_custom_roll_modifier}" />
									<span data-i18n="custom-modifier-label">Custom Modifier.</span>
								</label>
							</div>

						</div>

						<div class="item item3-5">
							<div class="block reason-for-mod">
								<div>
									<span data-i18n="reason-for-mod-label">Reason for Mod:</span>
								</div>	
								
								<div>
									<textarea name="attr_dialog_custom_roll_modifier_reason" title="macro: @{dialog_custom_roll_modifier_reason}"></textarea>
								</div>

							</div>
						</div>

					</div>

					<div class="container">

						<!-- Row 1 -->
						<div class="item item1-5 full-width">
							<h4>Traits</h4>
						</div>

						<!-- Row 2 -->
						<div class="item item1">
							<label>
								<div>
									<select name="attr_night_vision" class="number-only-width" title="macro name: @{night_vision}">
										<option>0</option>
										<option>1</option>
										<option>2</option>
										<option>3</option>
										<option>4</option>
										<option>5</option>
										<option>6</option>
										<option>7</option>
										<option>8</option>
										<option>9</option>
									</select>
								</div>
								<div>
									<div class="tooltip">
										<span data-i18n="night-vision-label">Night Vision</span>
										<span class="tooltiptext">
											<span data-i18n="night-vision-tooltip">This value negates darkness penalties, except for total darkness. See B71.</span>
										</span>
									</div>
								</div>
							</label>
						</div>

						<div class="item item2">
							<label>
								<div>
									<input type="checkbox" name="attr_has_dark_vision" value="1" title="macro name: @{has_dark_vision}" />
								</div>
								<div>
									<div class="tooltip">
										<span data-i18n="dark-vision-label">Dark Vision</span>
										<span class="tooltiptext">
											<span data-i18n="dark-vision-tooltip">If checked, Dark Vision negates all darkness penalties. Can see using some other means than light, radar, or sonar. See B47.</span>
										</span>
									</div>
								</div>
							</label>
						</div>

						<div class="item item3">
							<label>
								<div>
									<input type="checkbox" name="attr_is_used_to_blindness" value="1" title="macro name: @{is_used_to_blindness}" />
								</div>
								<div>
									<div class="tooltip">
										<span data-i18n="used-to-blindness-label">Used to blindess</span>
										<span class="tooltiptext">
											<span data-i18n="used-to-blindness-tooltip">If used to blindess, the max Visibility penalty is -6. See B124 and B394.</span>
										</span>
									</div>
								</div>
							</label>
						</div>
						
						<div class="item item4">
							<label>
								<div>
									<input type="checkbox" name="attr_has_high_pain_threshold" value="1" title="macro name: @{has_high_pain_threshold}" />
								</div>
								<div>
									<div class="tooltip">
										<span data-i18n="high-pain-threshold-label">High Pain Threshold</span>
										<span class="tooltiptext">
											<span data-i18n="high-pain-threshold-tooltip">If checked, High Pain Threshold negates all shock penalties and reduces pain penalties. See B59.</span>
										</span>
									</div>
								</div>
							</label>   
						</div>

						<div class="item item5">
							<label>
								<div>
									<input type="checkbox" name="attr_has_low_pain_threshold" value="1" title="macro name: @{has_low_pain_threshold}" />
								</div>
								<div>
									<div class="tooltip">
										<span data-i18n="low-pain-threshold-label">Low Pain Threshold</span>
										<span class="tooltiptext">
											<span data-i18n="low-pain-threshold-tooltip">If checked, Low Pain Threshold doubles shock and pain penalties. See B142.</span>
										</span>
									</div>
								</div>
							</label>   
						</div>

					</div>
				</div><!-- end .modal-sub-header -->
				
				<hr />
				
				<div class="modal-main-content">

					<input type="hidden" name="attr_display_ranged_maneuvers_section" value="0" />
					<div class="ranged-maneuvers section">

						<div class="container aiming-stats">
							<!-- Row 1 -->
							<div class="item item1-5">
								<h4>
									<span data-i18n="aiming-stats-label">Aiming Stats</span>
								</h4>
							</div>

							<div class="item item6-9">
								<h4>
									<span data-i18n="targeting-systems-title">Targeting Systems</span>
								</h4>
							</div>

							<!-- Row 2 -->
							<div class="item item10">
								<div>
									<div class="tooltip">
										<span data-i18n="abbreviation-accuracy-label">ACC</span>
										<span class="tooltiptext">
											<span data-i18n="accuracy-bonus-tooltip">Base Accuracy Bonus of weapon. Only enter if aimed for 1 turn <b>OR</b> you're a <i>gunslinger (see B58)</i>. See B364.</span>
										</span>
									</div>
								</div>
								<div>
									<input type="number" name="attr_ranged_accuracy_bonus" value="0" min="0" step="1" title="macro name: @{ranged_accuracy_bonus}" />
								</div>
							</div>

							<div class="item item12">
								<div>
									<div class="tooltip">
										<span data-i18n="elevation-label">Elevation</span>
										<span class="tooltiptext">
											<span data-i18n="ranged-elevation-label">If you're above the target, enter a positive number of hexes. If you're below the target, enter a negative number of hexes. See B407.</span>
										</span>
									</div>
								</div>
								<div>
									<input type="number" name="attr_ranged_elevation" value="0" step="1" title="macro name: @{ranged_elevation}" />
								</div>
							</div>
							
							<div class="item item11">
								<div>
									<div class="tooltip">
										<span data-i18n="range-speed-label">Range/Speed</span>
										<span class="tooltiptext">
											<span data-i18n="range-speed-tooltip">Enter the ranget of target and factor in relative speed if target crosses path of shooter. See B372.</span>
										</span>
									</div>
								</div>
								<div>
									<input type="number" name="attr_ranged_range_speed" value="0" min="0" step="1" title="macro name: @{ranged_range_speed}" />
									<input type="hidden" name="attr_ranged_range_speed_modifier" value="0" />
									<span name="attr_ranged_range_speed_modifier"></span>
								</div>
							</div>

							<div class="item item13">

								<div>
									<div class="tooltip">
										<span data-i18n="aim-bonus-label">Aim Bonus</span>
										<span class="tooltiptext">
											<span data-i18n="aiming-bonus-tooltip">Each turn <b>after</b> the initial aim, you get an additional bonus. See B364</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_ranged_aiming_bonus" title="macro name: @{ranged_aiming_bonus}">
										<option value="0" selected="selected">+0</option>
										<option value="1">2 turns: +1</option>
										<option value="2">3+ turns: +2</option>
									</select>
								</div>
								
							</div>

							<div class="item item14">
								<div>
									<div class="tooltip">
										<span data-i18n="abbreviation-rate-of-fire-label">RoF</span>
										<span class="tooltiptext">
											<span data-i18n="rate-of-fire-tooltip">see translation</span>
										</span>
									</div>
								</div>
								<div>
									<input type="number" name="attr_ranged_rof" value="1" min="1" step="1" title="macro name: @{ranged_rof}" />
									<input type="hidden" name="attr_ranged_rof_modifier" value="0" />
									<span name="attr_ranged_rof_modifier"></span>
								</div>
							</div>

							<div class="item item15 border-left">
								<div>
									<div class="tooltip">
										<span data-i18n="scope-label">Scope</span>
										<span class="tooltiptext">
											<span data-i18n="scope-bonus-tooltip">Each turn <b>after</b> the initial aim, you get an additional bonus up to the scope's bonus.<br />Fixed scopes, aim at least as many turns as the scope's bonus.<br />See B412</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_ranged_scope_bonus" title="macro name: @{ranged_scope_bonus}">
										<option value="0">+0</option>
										<option value="1">+1</option>
										<option value="2">+2</option>
										<option value="3">+3</option>
										<option value="4">+4</option>
									</select>
								</div>
							</div>

							<div class="item item16">
								<div>
									<div class="tooltip">
										<span data-i18n="vehicle-targeting-label">Vehicle Targeting</span>
										<span class="tooltiptext">
											<span data-i18n="vehicle-targeting-tooltip">Vehicle targeting system bonus if shooter took time to aim. See B469</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_ranged_vehicle_targeting_bonus" title="macro name: @{ranged_vehicle_targeting_bonus}">
										<option value="0">+0</option>
										<option value="1">+1</option>
										<option value="2">+2</option>
										<option value="3">+3</option>
									</select>
								</div>
							</div>

							<div class="item item17">
								<div>
									<div class="tooltip">
										<span data-i18n="laser-sight-label">Laser sight: +1</span>
										<span class="tooltiptext move-left">
											<span data-i18n="laser-sight-tooltip">Laser sight gives +1 to hit.<b>NOTE:</b> If target can see aiming dot, they got +1 dodge! See B412</span>
										</span>
									</div>
								</div>
								<div>
									<input type="checkbox" name="attr_ranged_laser_sight" value="1" title="macro name: @{ranged_laser_sight}" />
								</div>
							</div>

							<div class="item item18">
								<div>
									<div class="tooltip">
										<span data-i18n="total-label">Total</span>
										<span class="tooltiptext move-left">
											<span data-i18n="targeting-systems-description">Combined totals from all targeting systems can't exceed weapon's base Accuracy. See B364</span>
										</span>
									</div>
								</div>
								<div>
									<input type="hidden" name="attr_ranged_targeting_system_modifier" value="0" title="macro name: @{ranged_targeting_system_modifier}" />
									<span name="attr_ranged_targeting_system_modifier"></span>
								</div>
							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_attack_section" value="0" />
					<div class="attack section">

						<div class="container">

							<!-- Row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="hit-location-label">Hit Location</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">
								<div>
									<div class="tooltip">
										<span data-i18n="two-letter-abbreviation-size-modifier-label">SM</span>
										<input type="hidden" name="attr_display_ranged_maneuvers_section" value="0" />
										<span class="tooltiptext ranged">
											<span data-i18n="target-ranged-size-modifier-tooltip">Size Modifier of target. The modifier is applied AFTER location, grapple, shield, chinks in armor have been applied.</span>
										</span>
										<input type="hidden" name="attr_display_melee_maneuvers_section" value="0" />
										<span class="tooltiptext melee">
											<span data-i18n="target-melee-size-modifier-tooltip">Size Modifier of target, which will then be substracted by your size modifier to get a final <b>Relative Size Modifier</b>.<br />The modifier is applied AFTER location, grapple, shield, chinks in armor have been applied.<br />For information on Relative SM see http://www.sjgames.com/gurps/faq/FAQ4-3.html#SS3.4.2.23</span>
										</span>
									</div>
								</div>
								<div>
									<input type="number" name="attr_target_size_modifier" step="0" value="0" />
								</div>
							</div>
							
							<div class="item item7">
								<div>
									<div class="tooltip">
										<span data-i18n="type-label">Type</span>
										<span class="tooltiptext">
											<span data-i18n="hit-location-type-tooltip">Use the drop-downs to select a hit location or enter a value manually. See B552-555.<br />Humanoid Low Tech, see LT100-103.<br />Martial Arts, see MA137</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_hit_location_type" title="macro: @{hit_location_type}">
										<option>Select</option>
										<option value="arachnoid">Arachnoid (spider)</option>
										<option value="avian">Avian</option>
										<option value="cancroid">Cancroid (crab)</option>
										<option value="centaur">Centaur</option>
										<option value="hexapod">Hexapod</option>
										<option value="humanoid">Humanoid</option>
										<option value="humanoid_low_tech">Humanoid Low-tech</option>
										<option value="humanoid_martial_arts">Humanoid Martial Arts</option>
										<option value="ichthyoid">Ichthyoid (fish)</option>
										<option value="octopod">Octopod (octopus)</option>
										<option value="quadruped">Quadruped</option>
										<option value="vehicle">Vehicle</option>
										<option value="vermiform">Vermiform (snake)</option>
									</select>
								</div>
							</div>
							
							<div class="item item8">
								<div>
									<div class="tooltip">
										<span data-i18n="location-label">Location</span>
										<span class="tooltiptext">
											<span data-i18n="location-tooltip">Select a location.</span>
										</span>
									</div>
								</div>
								<div class="select-hit-location">
									<input type="hidden" name="attr_hit_location_type" />
									<select name="attr_humanoid_location" title="macro: @{humanoid_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-arm-2">-2 : Left Arm</option>
										<option value="left-hand-4">-4 : Left Hand</option>
										<option value="right-arm-2">-2 : Right Arm</option>
										<option value="right-hand-4">-4 : Right Hand</option>
										<option value="left-leg-2">-2 : Left Leg</option>
										<option value="left-foot-4">-4 : Left Foot</option>
										<option value="right-leg-2">-2 : Right Leg</option>
										<option value="right-foot-4">-4 : Right Foot</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_humanoid_low_tech_location" title="macro: @{humanoid_low_tech_location}" class="hit-location">
										<option value="chest-0">0 : Chest</option>
										<option value="abdomen-1">-1 : Abdomen</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-arm-2">-2 : Left Arm</option>
										<option value="left-hand-4">-4 : Left Hand</option>
										<option value="right-arm-2">-2 : Right Arm</option>
										<option value="right-hand-4">-4 : Right Hand</option>
										<option value="left-leg-2">-2 : Left Leg</option>
										<option value="left-foot-4">-4 : Left Foot</option>
										<option value="right-leg-2">-2 : Right Leg</option>
										<option value="right-foot-4">-4 : Right Foot</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_humanoid_martial_arts_location" title="macro: @{humanoid_martial_arts_location}" class="hit-location">
										<option value="chest-0">0 : Chest</option>
										<option value="abdomen-1">-1 : Abdomen</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="neck-veins-8">-8 : Neck Veins</option>
										<option value="jaw-6">-6 : Jaw</option>
										<option value="nose-7">-7 : Nose</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="spine-8">-8 : Spine</option>
										<option value="left-ear-7">-7 : Left ear</option>
										<option value="right-ear-7">-7 : Right ear</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-arm-2">-2 : Left Arm</option>
										<option value="left-arm-joint-5">-5 : Left Arm Joint</option>
										<option value="left-arm-veins-5">-5 : Left Arm Veins</option>
										<option value="left-hand-4">-4 : Left Hand</option>
										<option value="left-hand-joint-7">-7 : Left Hand Joint</option>
										<option value="right-arm-2">-2 : Right Arm</option>
										<option value="right-arm-joint-5">-5 : Right Arm Joint</option>
										<option value="right-arm-veins-5">-5 : Right Arm Veins</option>
										<option value="right-hand-4">-4 : Right Hand</option>
										<option value="right-hand-joint-7">-7 : Right Hand Joint</option>
										<option value="left-leg-2">-2 : Left Leg</option>
										<option value="left-leg-joint-5">-5 : Left Leg Joint</option>
										<option value="left-leg-veins-5">-5 : Left Leg Veins</option>
										<option value="left-foot-4">-4 : Left Foot</option>
										<option value="left-foot-joint-7">-7 : Left Foot Joint</option>
										<option value="right-leg-2">-2 : Right Leg</option>
										<option value="right-leg-joint-5">-5 : Right Leg Joint</option>
										<option value="right-leg-veins-5">-5 : Right Leg Veins</option>
										<option value="right-foot-4">-4 : Right Foot</option>
										<option value="right-foot-joint-4">-7 : Right Foot Joint</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_arachnoid_location" title="macro: @{arachnoid_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="brain-7">-7 : Brain</option>
										<option value="eye-#1-9">-9 : Eye #1</option>
										<option value="eye-#2-9">-9 : Eye #2</option>
										<option value="eye-#3-9">-9 : Eye #3</option>
										<option value="eye-#4-9">-9 : Eye #4</option>
										<option value="eye-#5-9">-9 : Eye #5</option>
										<option value="eye-#6-9">-9 : Eye #6</option>
										<option value="leg-#1-2">-2 : Leg #1</option>
										<option value="leg-#2-2">-2 : Leg #2</option>
										<option value="leg-#3-2">-2 : Leg #3</option>
										<option value="leg-#4-2">-2 : Leg #4</option>
										<option value="leg-#5-2">-2 : Leg #5</option>
										<option value="leg-#6-2">-2 : Leg #6</option>
										<option value="leg-#7-2">-2 : Leg #7</option>
										<option value="leg-#8-2">-2 : Leg #8</option>
									</select>

									<select name="attr_avian_location" title="macro: @{avian_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-wing-2">-2 : Left Wing</option>
										<option value="right-wing-2">-2 : Right Wing</option>
										<option value="left-leg-2">-2 : Left Leg</option>
										<option value="left-foot-4">-4 : Left Foot</option>
										<option value="right-leg-2">-2 : Right Leg</option>
										<option value="right-foot-4">-4 : Right Foot</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_cancroid_location" title="macro: @{cancroid_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-pincer-2">-2 : Left Pincer</option>
										<option value="right-pincer-2">-2 : Right Pincer</option>
										<option value="leg-#1-2">-2 : Leg #1</option>
										<option value="leg-#2-2">-2 : Leg #2</option>
										<option value="leg-#3-2">-2 : Leg #3</option>
										<option value="leg-#4-2">-2 : Leg #4</option>
										<option value="leg-#5-2">-2 : Leg #5</option>
										<option value="leg-#6-2">-2 : Leg #6</option>
										<option value="leg-#7-2">-2 : Leg #7</option>
										<option value="leg-#8-2">-2 : Leg #8</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_centaur_location" title="macro: @{centaur_location}" class="hit-location">
										<option value="human-torso-0">0 : Torso</option>
										<option value="animal-torso-0">0 : Animal Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-arm-2">-2 : Left Arm</option>
										<option value="left-hand-4">-4 : Left Hand</option>
										<option value="right-arm-2">-2 : Right Arm</option>
										<option value="right-hand-4">-4 : Right Hand</option>
										<option value="left-foreleg-2">-2 : Left Foreleg</option>
										<option value="left-foreleg-foot-4">-4 : Left Foreleg Foot</option>
										<option value="right-foreleg-2">-2 : Right Foreleg</option>
										<option value="right-foreleg-foot-4">-4 : Right Fore Foot</option>
										<option value="left-hind-leg-2">-2 : Left Hind Leg</option>
										<option value="left-hind-foot-4">-4 : Left Hind Foot</option>
										<option value="right-hind-leg-2">-2 : Right Hind Leg</option>
										<option value="right-hind-foot-4">-4 : Right Hind Foot</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_hexapod_location" title="macro: @{hexapod_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-wing-2">-2 : Left Wing</option>
										<option value="right-wing-2">-2 : Right Wing</option>
										<option value="left-foreleg-2">-2 : Left Foreleg</option>
										<option value="left-foreleg-foot-4">-4 : Left Foreleg Foot</option>
										<option value="right-foreleg-2">-2 : Right Foreleg</option>
										<option value="right-foreleg-foot-4">-4 : Right Foreleg Foot</option>
										<option value="left-mid-leg-2">-2 : Left Mid leg</option>
										<option value="left-mid-foot-4">-4 : Left Mid Foot</option>
										<option value="right-mid-leg-2">-2 : Right Mid Leg</option>
										<option value="right-mid-foot-4">-4 : Right Mid Foot</option>
										<option value="left-hind-leg-2">-2 : Left Hind Leg</option>
										<option value="left-hind-foot-4">-4 : Left Hind Foot</option>
										<option value="right-hind-leg-2">-2 : Right Hind Leg</option>
										<option value="right-hind-foot-4">-4 : Right Hind Foot</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_ichthyoid_location" title="macro: @{ichthyoid_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-8">-8 : Left Eye</option>
										<option value="right-eye-8">-8 : Right Eye</option>
										<option value="left-fin-2">-2 : Left Fin</option>
										<option value="right-fin-2">-2 : Right Fin</option>
										<option value="top-fin-4">-4 : Top Fin</option>
										<option value="bottom-fin-2">-2 : Bottom Fin</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_octopod_location" title="macro: @{octopod_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="brain-7">-7 : brain</option>
										<option value="left-eye-8">-8 : Left Eye</option>
										<option value="right-eye-8">-8 : Right Eye</option>
										<option value="arm-#1-2">-2 : Arm #1</option>
										<option value="arm-#2-2">-2 : Arm #2</option>
										<option value="arm-#3-2">-2 : Arm #3</option>
										<option value="arm-#4-2">-2 : Arm #4</option>
										<option value="arm-#5-2">-2 : Arm #5</option>
										<option value="arm-#6-2">-2 : Arm #6</option>
										<option value="arm-#7-2">-2 : Arm #7</option>
										<option value="arm-#8-2">-2 : Arm #8</option>
									</select>

									<select name="attr_quadruped_location" title="macro: @{quadruped_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-9">-9 : Left Eye</option>
										<option value="right-eye-9">-9 : Right Eye</option>
										<option value="left-wing-2">-2 : Left Wing</option>
										<option value="right-wing-2">-2 : Right Wing</option>
										<option value="left-foreleg-2">-2 : Left Foreleg</option>
										<option value="left-foreleg-foot-4">-4 : Left Foreleg Foot</option>
										<option value="right-foreleg-2">-2 : Right Foreleg</option>
										<option value="right-foreleg-foot-4">-4 : Right Foreleg Foot</option>
										<option value="left-hind-leg-2">-2 : Left Hind Leg</option>
										<option value="left-hind-foot-4">-4 : Left Hind Foot</option>
										<option value="right-hind-leg-2">-2 : Right Hind Leg</option>
										<option value="right-hind-foot-4">-4 : Right Hind Foot</option>
										<option value="tail-3">-3 : Tail</option>
									</select>

									<select name="attr_vehicle_location" title="macro: @{vehicle_location}" class="hit-location">
										<option value="body-0">0 : Body. Check occupant hit.</option>
										<option value="open-cabin-3">-3 : Open Cabin. Check occupant hit.</option>
										<option value="small-window-7">-7 : Small Window (1/2 DR). Check occupant hit.</option>
										<option value="large-window-3">-3 : Large Window (1/2 DR). Check occupant hit.</option>
										<option value="exposed-weapon-mount-7">-7 : Exposed Weapon Mount (HP/5)</option>
										<option value="small-superstructure-5">-5 : Small Superstructure (HP/3)</option>
										<option value="independent-turret-5">-5 : Independent Turrent (HP/3)</option>
										<option value="caterpillar-track-2">-2 : Caterpillar Track (HP/2)</option>
										<option value="helicopter-rotor-2">-2 : Helicoptor Rotor (HP/3)</option>
										<option value="wing-2">-2 : Wing (HP/2)</option>
										<option value="mast-2">-2 : Mast (HP/2 times # of masts)</option>
										<option value="arm-2">-2 : Arm (HP/2)</option>
										<option value="large-superstructure-2">-2 : Large Superstructure. Check occupant hit.</option>
										<option value="main-turret-2">-2 : Main Turret. Check occupant hit.</option>
										<option value="runner-skid-4">-4 : Runner or Skid (HP/3)</option>
										<option value="wheel-4">-4 : Wheel (HP/2 times # of wheels)</option>
										<option value="vital-area-3">-3 : Vital Area (extra damage)</option>
									</select>

									<select name="attr_vermiform_location" title="macro: @{vermiform_location}" class="hit-location">
										<option value="torso-0">0 : Torso</option>
										<option value="vitals-3">-3 : Vitals</option>
										<option value="groin-3">-3 : Groin</option>
										<option value="face-5">-5 : Face</option>
										<option value="neck-5">-5 : Neck</option>
										<option value="skull-7">-7 : Skull</option>
										<option value="left-eye-8">-8 : Left Eye</option>
										<option value="right-eye-8">-8 : Right Eye</option>
									</select>

									<select name="attr_weapon_location" title="macro: @{weapon_location}" class="hit-location">
										<option value="damage-reach-c-5">-5 : Damage Reach C (knife/pistol)</option>
										<option value="damage-reach-1-4">-4 : Damage Reach 1 (broadsword)</option>
										<option value="damage-reach-2+-4">-3 : Damage Reach 2+ (spear)</option>
										<option value="disarm-reach-c-5">-5 : Disarm Reach C (using non-fencing)</option>
										<option value="disarm-reach-1-4">-4 : Disarm Reach 1 (using non-fencing)</option>
										<option value="disarm-reach-2+-4">-3 : Disarm Reach 2+ (using non-fencing)</option>
										<option value="fencing-disarm-reach-c-5">-5 : Disarm Reach C (using fencing)</option>
										<option value="fencing-disarm-reach-1-4">-4 : Disarm Reach 1 (using fencing)</option>
										<option value="fencing-disarm-reach-2+-4">-3 : Disarm Reach 2+ (using fencing)</option>
									</select>

								</div>
							</div>

							<!-- only for melee attacks -->
							<input type="hidden" name="attr_display_melee_maneuvers_section" value="0" />
							<div class="item item9 melee-maneuvers">
								<div>
									<div class="tooltip">
										<span data-i18n="grapple-label">Grapple</span>
										<span class="tooltiptext">
											<span data-i18n="grapple-tooltip">Grapple halves to-hit penalty. See B370 for more information.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_grapple_modifier">
										<option value="-1"></option>
										<option value="0">0 : 1 or 2 limbs</option>
										<option value="2">+2 : 3 limbs</option>
										<option value="4">+4 : 4 limbs</option>
										<option value="6">+6 : 5 limbs</option>
										<option value="8">+8 : 6 limbs</option>
										<option value="10">+10 : 7 limbs</option>
										<option value="12">+12 : 8 limbs</option>
										<option value="14">+14 : 9 limbs</option>
										<option value="16">+16 : 10 limbs</option>
										<option value="18">+18 : 11 limbs</option>
										<option value="20">+20 : 12 limbs</option>
									</select>
								</div>
							</div>

							<div class="item item10">
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_has_shield" value="1" title="macro name: @{has_shield}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="has-shield-label">Has Shield</span>
												<span class="tooltiptext move-left">
													<span data-i18n="has-shield-tooltip">Apply additional penalty to limb for carrying a shield. Can be applied to arm, leg, foot, pincer, wing, or tail.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_target_chink_in_armor" value="1" title="macro name: @{target_chink_in_armor}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="chinks-in-armor-label">Chinks in armor</span>
												<span class="tooltiptext move-left">
													<span data-i18n="chinks-in-armor-tooltip">Target chinks in the armor for the hit location. -8 to torso, -10 to other locations. DR is halved. See B400.</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
							</div>
						</div>
						
						<!-- only for ranged attacks -->
						<input type="hidden" name="attr_display_ranged_maneuvers_section" value="0" />
						<div class="container ranged-maneuvers">
							 
							<!-- Row 1 -->
							<div class="item item1">

								<h5>
									<span data-i18n="cover-title">Cover</span>
								</h5>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_target_light_cover" value="1" title="macro name: @{target_light_cover}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="light-cover-label">Light Cover: -2</span>
												<span class="tooltiptext">
													<span data-i18n="light-cover-tooltip">Shooting through light cover is -2 to hit. See B548</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item2">

								<h5>&nbsp;</h5>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_target_down" value="1" title="macro name: @{target_down}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="target-prone-label">Target Prown: -2</span>
												<span class="tooltiptext">
													<span data-i18n="target-prone-tooltip">If target is crouching, kneeling, sitting, or lying down, apply -2 to hit torso, groin, or legs.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item2">
								
								<h5>&nbsp;</h5>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_target_partly_exposed" value="1" title="macro name: @{target_partly_exposed}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="partly-exposed-label">Partly Exposed: -2</span>
												<span class="tooltiptext">
													<span data-i18n="partly-exposed-tooltip">Target or hit location is partly exposed, add an additional -2 to hit. See B548</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item2">

								<h5>&nbsp;</h5>

								<div class="block">
									<label>
										<div>
											<input type="number" name="attr_target_intervening_figures" value="0" min="0" step="1" title="macro name: @{target_intervening_figures}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="intervening-figures-label">Intervening figures: -4 each</span>
												<span class="tooltiptext move-left">
													<span data-i18n="intervening-figures-tooltip">Enter the number of intervening figures between you and your target, penalty is -4 per figure. See B548</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>


						</div>

						<div class="container">
							
							<!-- row #1 -->
							<div class="item item1">
								<div>Mod</div>
								<div>
									<input type="number" step="1" value="0" name="attr_hit_location_modifier" title="macro: @{hit_location_modifier}" />
								</div>
							</div>
							
							<div class="item item2-5">
								<div>Description</div>
								<div>
									<input type="text" name="attr_hit_location" title="macro: @{hit_location}" />
								</div>
							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_melee_maneuvers_section" value="0" />
					<div class="melee-maneuvers section">

						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="maneuvers-posture-title">Maneuvers and Posture</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">

								<h5>
									<span data-i18n="maneuver-title">Maneuver</span>
								</h5>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_maneuver" value="step-attack" checked="checked" title="macro name: @{melee_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="step-attack-label">Step/Attack: +0</span>
												<span class="tooltiptext">
													<span data-i18n="step-attack-tooltip">Melee Attack. Movement: Step. Active Defense: Any. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_maneuver" value="step-feint" title="macro name: @{melee_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="step-feint-label">Feint: +0</span>
												<span class="tooltiptext">
													<span data-i18n="step-feint-tooltip">Feint. Contest of melee weapon skills, defender is at -1 defense per point you win by. Lasts one second! Movement: Step. Active Defense: Any, but if you parry with unbalanced, you may not attack. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_maneuver" value="move-attack" title="macro name: @{melee_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="move-attack-label">Move/Attack: -4 *</span>
												<span class="tooltiptext">
													<span data-i18n="move-attack-tooltip">During or after your move, make a single, poorly aimed attack – either unarmed or with a ready weapon. Max skill of 9. Movement: normal, but -2 to avoid obstacles. Active Defense: Dodge or Block. See B365-366</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_maneuver" value="move-wild-swing" title="macro name: @{melee_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="move-wild-label">Move/Wild: -5 *</span>
												<span class="tooltiptext">
													<span data-i18n="move-wild-tooltip">Move and Wild Swing! During or after your move, make a single, wild swing/thrust – either unarmed or with a ready weapon.<br />Max skill of 9.<br />Melee attack to your side, back, or unseen target. If visibility penalty is higher, use that penalty instead, do not use this one. Roll hit location randomly! See B388-389<br />Movement: normal, but -2 to avoid obstacles<br />Active Defense: Dodge or Block<br />See B365-366</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_maneuver" value="move-slam" title="macro name: @{melee_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="move-slam-label">Move and Slam: +0</span>
												<span class="tooltiptext">
													<span data-i18n="move-slam-tooltip">End your move with a slam. If using shield, add your shield's Defense Bonus to your damage roll. Movement: normal, but -2 to avoid obstacles. Active Defense: Dodge or Block. B371-372</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_maneuver" value="flying-tackle" title="macro name: @{melee_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="flying-tackle-label">Flying Tackle: +4</span>
												<span class="tooltiptext">
													<span data-i18n="flying-tackle-tooltip">End your move with a flying tackle, get 1 yard of extra movement and you become prone. At least two legs and one free arm. Can use Jumping to hit target. Movement: normal, but -2 to avoid obstacles. Active Defense: Dodge or Block. See B371-372</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_maneuver" value="pounce" title="macro name: @{melee_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="pounce-label">Pounce: +4</span>
												<span class="tooltiptext">
													<span data-i18n="pounce-tooltip">As slam, get 1 yard of extra movement. Roll DX, Acrobatics, or Jumping to avoid falling prone. If a mount, rider must roll Riding-4 or fall off! Must have four or more legs. Movement: normal, but -2 to avoid obstacles. Active Defense: Dodge or Block. See B371-372</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item7">

								<h5>
									<span data-i18n="all-out-attack-title">All-Out Attack</span>
								</h5>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_all_out_attack" value="0" checked="checked" title="macro name: @{melee_all_out_attack}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="none-label">None</span>
												<span class="tooltiptext">
													<span data-i18n="no-all-out-attack-tooltip">No All-Out Attack, select this to clear all-out attack option.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_all_out_attack" value="determined" title="macro name: @{melee_all_out_attack}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="all-out-attack-determined-label">Determined: +4</span>
												<span class="tooltiptext">
													<span data-i18n="all-out-attack-determined-tooltip">Determined: Make a single attack at +4 to hit! Movement: half-move, forward only. Defense: None. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_all_out_attack" value="double" title="macro name: @{melee_all_out_attack}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="all-out-attack-double-label">Double: +0</span>
												<span class="tooltiptext">
													<span data-i18n="all-out-attack-double-tooltip">Two attacks against a single foe! Two ready weapons or one weapon that doesn't need to be readied after an attack. Apply handedness for 2nd weapon. Movement: half-move, forward only. Defense: None. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_all_out_attack" value="feint" title="macro name: @{melee_all_out_attack}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="all-out-attack-feint-label">Feint: +0</span>
												<span class="tooltiptext">
													<span data-i18n="all-out-attack-feint-tooltip">Feint and attack a single foe! Contest of melee weapon skills, defender is at -1 defense per point you win by. Lasts one second! Movement: half-move, forward only. Defense: None. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_melee_all_out_attack" value="strong" title="macro name: @{melee_all_out_attack}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="all-out-attack-strong-label">Strong: +0</span>
												<span class="tooltiptext">
													<span data-i18n="all-out-attack-strong-tooltip">Single attack with +2 to damage or +1 damage per die for ST-based weapons! Movement: half-move, forward only. Defense: None. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item8-9">

								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="deceptive-strike-label">Deceptive Strike</span>
											<span class="tooltiptext">
												<span data-i18n="deceptive-strike-tooltip">Deceptive strike, effective skill can't go below <b>10</b>! See B369-370.</span>
											</span>
										</div>
									</div>
									
									<div>
										<select name="attr_deceptive_strike" title="macro name: @{deceptive_strike}">
											<option value="0" selected="selected">None</option>
											<option value="-2">-2 hit, -1 defense</option>
											<option value="-4">-4 hit, -2 defense</option>
											<option value="-6">-6 hit, -3 defense</option>
											<option value="-8">-8 hit, -4 defense</option>
											<option value="-10">-10 hit, -5 defense</option>
											<option value="-12">-12 hit, -6 defense</option>
											<option value="-14">-14 hit, -7 defense</option>
											<option value="-16">-16 hit, -8 defense</option>
											<option value="-18">-18 hit, -9 defense</option>
											<option value="-20">-20 hit, -10 defense</option>
										</select>
									</div>
									
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_evaluate" title="macro name: @{evaluate}">
												<option value="0" selected="selected">0</option>
												<option value="1">+1</option>
												<option value="2">+2</option>
												<option value="3">+3</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="evaluate-label">Evaluate</span>
												<span class="tooltiptext">
													<span data-i18n="evaluate-tooltip">Evaluate a visible target that you can melee attack. Movement: Any. Defense: Any, doesn't spoil evaluate. See B364-365.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_wild_swing" value="1" title="macro name: @{wild_swing}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="wild-swing-label">Wild Swing: -5 *</span>
												<span class="tooltiptext">
													<span data-i18n="wild-swing-tooltip">Melee attack to your side, back, or unseen target. If visibility penalty is higher, use that penalty instead, do not use this one. Max skill of 9. Roll hit location randomly! See B388-389</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_rapid_strike" value="1" title="macro name: @{rapid_strike}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="rapid-strike-label">Rapid Strike: -6</span>
												<span class="tooltiptext">
													<span data-i18n="rapid-strike-tooltip">Make two attacks at -6 each, you <b>may</b> attack multiple opponents. You must have a ready weapon. If you have more than one attack, like all-out attack double, you can replace <b>one</b> of the attacks with rapid strike. See B370</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_flurry_of_blows" value="1" title="macro name: @{flurry_of_blows}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="flurry-of-blows-label">Flurry of Blows (1 FP/attack): -3</span>
												<span class="tooltiptext">
													<span data-i18n="flurry-of-blows-tooltip">Flurry of Blows for 1 FP per attack. Similar to Rapid Strike, you make two attacks at -3 each, you <b>may</b> attack multiple opponents. You must have a ready weapon. If you have more than one attack, like all-out attack double, you can replace <b>one</b> of the attacks with rapid strike. <b>Can't</b> be combined with <b>Mighty Blow</b>. See B357</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_rapid_strike_master" value="1" title="macro name: @{rapid_strike_master}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="rapid-strike-master-label">Rapid Strike <i>Master</i>: -3</span>
												<span class="tooltiptext">
													<span data-i18n="rapid-strike-master-tooltip">Trained by a Master or Weapon Master. Make two attacks at -3 each, you <b>may</b> attack multiple opponents. You must have a ready weapon. If you have more than one attack, like all-out attack double, you can replace <b>one</b> of the attacks with rapid strike. See B370 and B547</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_attack_from_above" value="1" title="macro name: @{attack_from_above}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="attack-from-above-label">Attack from above: -2</span>
												<span class="tooltiptext">
													<span data-i18n="attack-from-above-tooltip">Roll contest of Stealth vs Vision (-2 if not looking up). If you win, target is surprised and gets <b>No defense</b> and may <i>freeze</i>. If you lose, target is at -2 defense. If target is <i>aware</i> they could use <i>stop-thrust</i>. You suffer falling damage. <b>Optional</b> do falling damage to target. See B400</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_mighty_blow" value="1" title="macro name: @{might_blow}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="mighty-blow-label">Mighty Blow (1 FP)</span>
												<span class="tooltiptext">
													<span data-i18n="mighty-blow-tooltip">Mighty Blow does extra damage for 1 FP per attack. <b>Can't</b> be combined with <b>Flurry of Blows</b>. See B357.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

							</div>

							<div class="item item10">

								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="posture-label">Posture</span>
											<span class="tooltiptext">
												<span data-i18n="posture-tooltip">Your posture when attack was made. See B547.</span>
											</span>
										</div>
									</div>
									<div>
										<select name="attr_posture" title="macro name: @{posture}">
											<option value="0" selected="selected">Upright: +0</option>
											<option value="crawling">Crawling: -4</option>
											<option value="prone">Prone: -4</option>
											<option value="crouching">Crouching: -2</option>
											<option value="kneeling">Kneeling: -2</option>
											<option value="sitting">Sitting: -2</option>
										</select>
									</div>
								</div>

								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="height-difference-label">Height Difference</span>
											<span class="tooltiptext">
												<span data-i18n="height-difference-tooltip">If you and your foe are at different levels, the vertical distance affects combat. See B402</span>
											</span>
										</div>
									</div>
								
									<div>
										<select name="attr_melee_height_difference" title="macro name: @{melee_height_difference}">
											<option value="0" selected="selected">0-1 feet: +0</option>
											<option value="2-higher-legs-feet">Higher, 1-2 feet, Legs/feet: -2</option>
											<option value="2-higher-head-neck">Higher, 1-2 feet, Head/Neck: +2</option>
											<option value="3-higher-legs-feet">Higher, 2-3 feet, Legs/feet: -2</option>
											<option value="3-higher-head-neck">Higher, 2-3 feet, Head/Neck: +2</option>
											<option value="4-higher-legs-feet">Higher, 3-4 feet, Can't hit Legs/feet!: -20</option>
											<option value="4-higher-head-neck">Higher, 3-4 feet, Head/Neck: +2</option>
											<option value="5-higher-legs-feet">Higher, 4-5 feet, Can't hit Legs/feet!: -20</option>
											<option value="5-higher-head-neck">Higher, 4-5 feet, Head/Neck: +2</option>
											<option value="6-higher-legs-feet">Higher, 5-6 feet, Can't hit Legs/feet!: -20</option>
											<option value="6-higher-head-neck">Higher, 5-6 feet, Head/Neck: +2</option>
											<option value="2-lower-legs-feet">Lower, 1-2 feet, Legs/feet: +2</option>
											<option value="2-lower-head-neck">Lower, 1-2 feet, Head/Neck: -2</option>
											<option value="3-lower-legs-feet">Lower, 2-3 feet, Legs/feet: +2</option>
											<option value="3-lower-head-neck">Lower, 2-3 feet, Head/Neck: -2</option>
											<option value="4-lower-legs-feet">Lower, 3-4 feet, Legs/feet: +2</option>
											<option value="4-lower-head-neck">Lower, 3-4 feet, Head/Neck: -2</option>
											<option value="5-lower-legs-feet">Lower, 4-5 feet, Legs/feet: +2</option>
											<option value="5-lower-head-neck">Lower, 4-5 feet, Can't hit Head/Neck!: -20</option>
											<option value="6-lower-legs-feet">Lower, 5-6 feet, Legs/feet: +2</option>
											<option value="6-lower-head-neck">Lower, 5-6 feet, Can't hit Head/Neck!: -20</option>
										</select>
									</div>
									
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_improvised_weapon" title="macro name: @{improvised_weapon}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="improvised-weapon-label">Improvised Weapon</span>
												<span class="tooltiptext move-left">
													<span data-i18n="improvised-weapon-tooltip">Improvised weapon, See B404.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_tactics" title="macro name: @{tactics}">
												<option value="0" selected="selected">0</option>
												<option>+1</option>
												<option>+2</option>
												<option>-1</option>
												<option>-2</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="tactics-label">Tactics</span>
												<span class="tooltiptext move-left">
													<span data-i18n="tactics-tooltip"><b>NOTE!</b> from Dungeon Fantasy. A teammate spends turn to observe and advise you. If accepted, roll friends tactics. Success: +1 hit. Critical Success: +2. Fail: -1 hit. Critical Fail: -2 hit. See DF Exploits 57.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_backstab" value="1" title="macro name: @{backstab}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="backstab-label">Backstab: +4</span>
												<span class="tooltiptext move-left">
													<span data-i18n="backstab-tooltip"><b>NOTE!</b> from Dungeon Fantasy. At start of combat, make Stealth roll. If successful, get backstab bonus. See DF Exploits 57-58</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
							</div>

						</div>

						<div class="container">

							<!-- row 1 -->
							<div class="item item1">

								
								<h5>
									<span data-i18n="handedness-title">Handedness</span>		
								</h5>
								
								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="single-dual-weapon-label">Single/Dual Weapon</span>
											<span class="tooltiptext">
												<span data-i18n="single-dual-weapon-tooltip">Select your hand and if you're using a dual weapon attack. <b>NOTE:</b> Don't use off-hand of you have ambidexterity.</span>
											</span>
										</div>
									</div>
									<div>
										<select name="attr_weapon_hand" title="macro name: @{weapon_hand}">
											<option value="0" selected="selected">Primary hand: +0</option>
											<option value="off-hand">Off-hand: -4</option>
											<option value="dual-weapon-primary-hand">Dual-Weapon Primary Hand: -4</option>
											<option value="dual-weapon-off-hand">Dual-Weapon Off-hand: -8</option>
										</select>
									</div>
								</div>
								
								<div class="block">
									<label>
										<div>
											<select name="attr_off_hand_training" title="macro name: @{off_hand_training}">
												<option value="0" selected="selected">0</option>
												<option>+1</option>
												<option>+2</option>
												<option>+3</option>
												<option>+4</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="off-hand-training-label">Off-Hand training</span>
												<span class="tooltiptext">
													<span data-i18n="off-hand-training-tooltip">Off-Hand weapon training. Negates the penalty for using an off-hand weapon. <b>NOTE:</b> A better approach is adding an off-hand attack to your combat table. See B232</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_dual_weapon_training" title="macro name: @{dual_weapon_training}">
												<option value="0" selected="selected">0</option>
												<option>+1</option>
												<option>+2</option>
												<option>+3</option>
												<option>+4</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="dual-weapon-training-label">Dual-Weapon training</span>
												<span class="tooltiptext">
													<span data-i18n="dual-weapon-training-tooltip">Dual-Weapon training. Negates the penalty for using a dual-weapon. <b>NOTE:</b> A better approach is adding an dual-weapon attacks to your combat table. See B230</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item2">

								<h5>
									<span data-i18n="mounted-title">Mounted</span>		
								</h5>

								<div>
									<p>
										<span data-i18n="mounted-description">When mounted, use lower value of Weapon or Riding Skill. See B397</span>
									</p>
								</div>
								
								<div class="block">
									<label>
										<div>
											<select name="attr_mounted_skill_difference" title="macro name: @{mounted_skill_difference}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
												<option>-7</option>
												<option>-8</option>
												<option>-9</option>
												<option>-10</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="skill-difference-label">Skill Difference</span>
												<span class="tooltiptext">
													<span data-i18n="riding-skill-difference-tooltip">The difference between your riding skill and weapon skill.<br /><b>NOTE:</b> You could place an attack on the melee table and use riding skill instead of melee weapon skill.</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_mount_attacked" value="1" title="macro name: @{mount_attacked}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="mount-attacked-label">Mount attacked: -2</span>
												<span class="tooltiptext">
													<span data-i18n="mount-attacked-tooltip">If mount attacked on its last turn, you're at -2 to hit. See B397</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_mount_has_velocity" value="1" title="macro name: @{mount_has_velocity" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="mount-velocity-label">Mount Velocity 7+, +1 damage: -1</span>
												<span class="tooltiptext">
													<span data-i18n="mount-velocity-tooltip">If mount's relative velocity to target is 7, apply +1 damage, -1 to hit.<br /><b>NOTE:</b> Lances have special damage rules.<br />See B397</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_ranged_maneuvers_section" value="0" />
					<div class="ranged-maneuvers section">

						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="maneuvers-posture-title">Maneuvers and Posture</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">

								<h5>
									<span data-i18n="maneuver-title">Maneuver</span>
								</h5>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_ranged_maneuver" value="step-attack" checked="checked" title="macro name: @{ranged_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="step-attack-label">Step/Attack: +0</span>
												<span class="tooltiptext">
													<span data-i18n="step-attack-tooltip">Attack. Movement: Step. Active Defense: Any. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_ranged_maneuver" value="move-attack-ranged" title="macro name: @{ranged_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="ranged-move-attack-label">Move/Attack: -2 or Bulk</span>
												<span class="tooltiptext">
													<span data-i18n="ranged-move-attack-tooltip">Attack with a ranged weapon while moving, <b>aiming</b> is not possible and you lose previous aiming. -2 to hit or bulk penalty, whichever is worse. Movement: normal, but -2 to avoid obstacles. Active Defense: Dodge or Block. See B365-366</span>
												</span>
											</div>
										</div>
									</label>
									<div>
										<input type="number" name="attr_ranged_bulk" step="1" max="0" value="-2" title="macro: @{ranged_bulk}" />
										<input type="hidden" name="attr_ranged_move_default_or_bulk" value="0" title="macro: @{ranged_move_default_or_bulk}" />
										<span data-i18n="bulk-label">Bulk</span>
									</div>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_ranged_maneuver" value="all-out-determined" title="macro name: @{ranged_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="ranged-all-out-attack-determined-label">All-Out Attack Determined: +1</span>
												<span class="tooltiptext">
													<span data-i18n="ranged-all-out-attack-determined-tooltip">Determined: Make a single attack at +1 to hit! Movement: half-move, forward only. Defense: None. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_ranged_maneuver" value="all-out-suppression" title="macro name: @{ranged_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="ranged-all-out-attack-suppression-fire-label">All-Out Attack Suppression Fire</span>
												<span class="tooltiptext">
													<span data-i18n="ranged-all-out-attack-suppression-fire-tooltip">Take entire turn to spray an area with automatic fire <b>RoF 5+</b>, see Suppression Fire B409! Movement: half-move, forward only. Defense: None. See B365</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item7">

								<h5>
									<span data-i18n="other-actions-title">Other Actions</span>
								</h5>
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_ranged_braced" value="1" title="macro name: @{ranged_braced}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="braced-label">Braced: +1</span>
												<span class="tooltiptext">
													<span data-i18n="braced-tooltip">If you haven't moved and aimed a turn, you may get the braced bonus.<br />Firearm/crossbow must rest on a sandbag, low wall, car, etc.<br />One-handed firearm is braced if using two hands.<br />Two-handed is braced if you're prone and using a bipod. See B364.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_ranged_popup" value="1" title="macro name: @{ranged_popup}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="pop-up-label">Pop-up: -2</span>
												<span class="tooltiptext">
													<span data-i18n="pop-up-tooltip">Allows you to emerge from cover, move no more than one hex, make a ranged attack, and return cover.<br />Possible with thrown weapon, firearm, or crossbow.<br />You are susceptible to oppertunity fire, only dodge is allowed. See B390.</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<select name="attr_ranged_in_close_combat" title="macro: @{ranged_in_close_combat}">
												<option selected>0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
												<option>-7</option>
												<option>-8</option>
												<option>-9</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="in-close-combat-label">Close Combat</span>
												<span class="tooltiptext">
													<span data-i18n="in-close-combat-tooltip">If using ranged weapon in close combat, apply a penalty equal to the weapon's bulk rating. See B391</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_ranged_damaged_weapon" title="macro: @{ranged_damaged_weapon}">
												<option selected>0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="damaged-weapon-label">Damaged Weapon</span>
												<span class="tooltiptext">
													<span data-i18n="damaged-weapon-tooltip">-HP of damage done to weapon last turn. See B548</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_ranged_strength_difference" title="macro: @{ranged_strength_difference}">
												<option selected>0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
												<option>-7</option>
												<option>-8</option>
												<option>-9</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="strength-difference-label">Strength Difference</span>
												<span class="tooltiptext">
													<span data-i18n="strength-difference-tooltip">Strength is below that required for weapon, -1 per point of deficit. See B548</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="watch-area-label">Watch Area</span>
											<span class="tooltiptext move-left">
												<span data-i18n="watch-area-tooltip">Area or line being covered that is within your arc of vision.<br /><b>NOTE:</b> You only Aim and wait on a single hex!<br /> See B548</span>
											</span>
										</div>
									</div>
									<div>
										<select name="attr_ranged_opportunity_fire_watched" title="macro: @{ranged_opportunity_fire_watched}">
											<option value="0" selected>0 or 1 hex: +0</option>
											<option value="-1">2 hexes: -1</option>
											<option value="-2">3-4 hexes or straight line: -2</option>
											<option value="-3">5-6 hexes: -3</option>
											<option value="-4">7-10 hexes: -4</option>
											<option value="-5">11+ hexes: -5</option>
										</select>
									</div>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_ranged_opportunity_fire_target" value="1" title="macro name: @{ranged_opportunity_fire_target}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="check-target-label">Check Target: -2</span>
												<span class="tooltiptext">
													<span data-i18n="check-target-tooltip">Opportunity Fire check target before shooting. See B390.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item10">
								
								<h5>
									<span data-i18n="handedness-title">Handedness</span>		
								</h5>
								
								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="single-dual-weapon-label">Single/Dual Weapon</span>
											<span class="tooltiptext">
												<span data-i18n="single-dual-weapon-tooltip">Select your hand and if you're using a dual weapon attack. <b>NOTE:</b> Don't use off-hand of you have ambidexterity.</span>
											</span>
										</div>
									</div>
									<div>
										<select name="attr_ranged_weapon_hand" title="macro name: @{ranged_weapon_hand}">
											<option value="0" selected="selected">Primary hand: +0</option>
											<option value="off-hand">Off-hand: -4</option>
											<option value="dual-weapon-primary-hand">Dual-Weapon Primary Hand: -4</option>
											<option value="dual-weapon-off-hand">Dual-Weapon Off-hand: -8</option>
										</select>
									</div>
								</div>
								
								<div class="block">
									<label>
										<div>
											<select name="attr_ranged_off_hand_training" title="macro name: @{ranged_off_hand_training}">
												<option value="0" selected="selected">0</option>
												<option>+1</option>
												<option>+2</option>
												<option>+3</option>
												<option>+4</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="abbreviated-off-hand-training-label">Off-Hand train.</span>
												<span class="tooltiptext">
													<span data-i18n="off-hand-training-tooltip">Off-Hand weapon training. Negates the penalty for using an off-hand weapon. <b>NOTE:</b> A better approach is adding an off-hand attack to your combat table. See B232</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_ranged_dual_weapon_training" title="macro name: @{dual_weapon_training}">
												<option value="0" selected="selected">0</option>
												<option>+1</option>
												<option>+2</option>
												<option>+3</option>
												<option>+4</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="dual-training-label">Dual training</span>
												<span class="tooltiptext">
													<span data-i18n="dual-weapon-training-tooltip">Dual-Weapon training. Negates the penalty for using a dual-weapon. <b>NOTE:</b> A better approach is adding an dual-weapon attacks to your combat table. See B230</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_ranged_tactics" title="macro name: @{ranged_tactics}">
												<option value="0" selected="selected">0</option>
												<option>+1</option>
												<option>+2</option>
												<option>-1</option>
												<option>-2</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="tactics-label">Tactics</span>
												<span class="tooltiptext move-left">
													<span data-i18n="tactics-tooltip"><b>NOTE!</b> from Dungeon Fantasy. A teammate spends turn to observe and advise you. If accepted, roll friends tactics. Success: +1 hit. Critical Success: +2. Fail: -1 hit. Critical Fail: -2 hit. See DF Exploits 57.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_ranged_backstab" value="1" title="macro name: @{ranged_backstab}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="backstab-label">Backstab: +4</span>
												<span class="tooltiptext move-left">
													<span data-i18n="backstab-tooltip"><b>NOTE!</b> from Dungeon Fantasy. At start of combat, make Stealth roll. If successful, get backstab bonus. See DF Exploits 57-58</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item8-9">

								<div class="block">
									<div>
										<div class="tooltip">
											<b><span data-i18n="moving-mount-vehicle-label">Moving Mount/Vehicle</span></b>
											<span class="tooltiptext move-left">
												<span data-i18n="moving-mount-vehicle-tooltip">Attacking from moving mount or vehicle.<br /><b>NOTE:</b>If <i>not</i> stabilized, the total of Accuracy, Aim, Bracing, and Targeting systems can't exceed vehicle's stability rating (SR). See B469 and B548</span>
											</span>
										</div>
									</div>
								</div>

								<div class="block">

									<label>
										<div>
											<input type="number" name="attr_vehicle_stability_rating" value="0" min="0" step="1" title="macro name: @{vehicle_stability_rating}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="abbreviation-stability-rating-label">SR</span>
												<span class="tooltiptext move-left">
													<span data-i18n="stability-rating-tooltip">Vehicle's stability rating. Affects Targeting systems.</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_vehicle_weapon_unstabilized" value="1" title="macro name: @{vehicle_weapon_unstabilized}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="unstabilized-label">Unstabilized</span>
												<span class="tooltiptext move-left">
													<span data-i18n="unstabilized-tooltip">The vehicle's weapon is not stabilized. The max bonus from Targeting Systems can't exceed Stability Rating of the vehicle. See B469</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="conditions-label">Conditions</span>
											<span class="tooltiptext move-left">
												<span data-i18n="vehicle-conditions-tooltip">What conditions is the vehicle experiencing. See B548.</span>
											</span>
										</div>
									</div>
									<div>
										<select name="attr_ranged_vehicle_conditions" title="macro name: @{ranged_vehicle_conditions}">
											<option value="0" selected="selected">Select</option>
											<option value="air-handheld">-1 : Air vehicle. Using handheld weapon.</option>
											<option value="ground-good-road-handheld">-1 : Ground vehicle, good road. Using handheld weapon.</option>
											<option value="ground-bad-road-fixed">-1 : Ground vehicle, bad road. Weapon in fixed mount/hardpoint/carriage.</option>
											<option value="ground-bad-road-external">-2 : Ground vehicle, bad road. Weapon in external open mount.</option>
											<option value="ground-bad-road-handheld">-3 : Ground vehicle, bad road. Using handheld weapon.</option>
											<option value="ground-off-road-stabilized-turret">-1 : Ground vehicle, off-road. Weapon in stabalized turret/open mount.</option>
											<option value="ground-off-road-fixed">-2 : Ground vehicle, off-road. Weapon in fixed mount/hardpoint/carriage.</option>
											<option value="ground-off-road-external">-3 : Ground vehicle, off-road. Weapon in external open mount.</option>
											<option value="ground-off-road-handheld">-4 : Ground vehicle, off-road. Using handheld weapon.</option>
											<option value="water-calm-fixed">-1 : Water vehicle, calm. Weapon in fixed mount/hardpoint/carriage.</option>
											<option value="water-calm-external">-2 : Water vehicle, calm. Weapon in external mount.</option>
											<option value="water-calm-handheld">-3 : Water vehicle, calm. Using handheld weapon.</option>
											<option value="water-rough-stabilized-turret">-1 : Water vehicle, rough. Weapon in stabilized turret/open mount.</option>
											<option value="water-rough-fixed">-2 : Water vehicle, rough. Weapon in fixed mount/hardpoint/carriage.</option>
											<option value="water-rough-external">-3 : Water vehicle, rough. Weapon in external mount.</option>
											<option value="water-rough-handheld">-4 : Water vehicle, rough. Using handheld weapon.</option>
										</select>
									</div>
								</div>
								
								<div class="block">
									<label>
										<div>
											<select name="attr_ranged_controll_roll" title="macro: @{ranged_ranged_controll_roll}">
												<option selected>0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
												<option>-7</option>
												<option>-8</option>
												<option>-9</option>
												<option>-10</option>
												<option>-11</option>
												<option>-12</option>
												<option>-13</option>
												<option>-14</option>
												<option>-15</option>
												<option>-16</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="failed-control-roll-label">Failed Control Roll</span>
												<span class="tooltiptext move-left">
													<span data-i18n="failed-control-roll-tooltip">Vehicle/mount failed control last turn. Penalty equal to margin of failure. See B548</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_ranged_over_under_mount" value="1" title="macro name: @{ranged_over_under_mount}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="over-under-mount-label">Over/Under Mount: -6</span>
												<span class="tooltiptext move-left">
													<span data-i18n="over-under-mount-tooltip">If you're an exposed rider hanging from side of mount/vehicle, penalty to hit is -6 to shoot over or under the mount.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_ranged_vehicle_dodge" value="1" title="macro name: @{ranged_vehicle_dodge}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="vehicle-dodged-label">Vehicle Dodged Last Turn: -2</span>
												<span class="tooltiptext move-left">
													<span data-i18n="vehicle-dodged-tooltip">Vehicle/mount dodged last turn and you're <b>not</b> the operator.</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_ranged_air_vehicle_dodge" value="1" title="macro name: @{ranged_air_vehicle_dodge}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="air-vehicle-dodged-label">Air Vehicle Dodged Last Turn: -4</span>
												<span class="tooltiptext move-left">
													<span data-i18n="vehicle-dodged-tooltip">Vehicle/mount dodged last turn and you're <b>not</b> the operator.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_defense_maneuvers_section" value="0" />
					<div class="defense-maneuvers section">

						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="maneuvers-posture-title">Maneuvers and Posture</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">

								<div class="block">
									<h5>
										<span data-i18n="maneuver-title">Maneuver</span>
									</h5>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_defense_maneuver" value="step-attack" checked="checked" title="macro name: @{defense_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="normal-defense-label">Normal Defense</span>
												<span class="tooltiptext">
													<span data-i18n="normal-defense-tooltip">Using a normal active defense.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_defense_maneuver" value="all-out-defense-increased" title="macro name: @{defense_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="all-out-defense-increased-label">All-Out Defense: +2</span>
												<span class="tooltiptext">
													<span data-i18n="all-out-defense-increased-tooltip">On your turn, you chose to do an all-out defense. Get +2 <b>one</b> active defense.</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_defense_maneuver" value="all-out-defense-double" title="macro name: @{defense_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="all-out-defense-double-label">All-Out Defense: Double</span>
												<span class="tooltiptext">
													<span data-i18n="all-out-defense-double-tooltip">Apply <b>two</b> different active defenses against the same attack. If you fail your defense, you may try a second, different defense against that attack. See B366</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="radio" name="attr_defense_maneuver" value="moved-attack" title="macro name: @{defense_maneuver}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="moved-attacked-label">Moved and Attacked</span>
												<span class="tooltiptext">
													<span data-i18n="moved-attacked-tooltip">If you moved and attacked on your last turn, you can only dodge or block, parry is not allowed. See B366</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<h5>
										<span data-i18n="defenders-posture-title">Defender's Posture</span>
									</h5>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_crawling" value="1" title="macro name: @{defense_crawling}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="defense-crawling-label">Crawling/Lying: -3</span>
												<span class="tooltiptext">
													<span data-i18n="defense-crawling-tooltip">If you're crawling or lying down, -3 to defense. See B549</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_kneeling" value="1" title="macro name: @{defense_kneeling}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="defense-kneeling-label">Kneeling/Sitting: -2</span>
												<span class="tooltiptext">
													<span data-i18n="defense-kneeling-tooltip">If you're kneeling or sitting, -2 to defense. See B549</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<h5>
										<span data-i18n="attackers-action-title">Attacker's Action</span>
									</h5>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_from_behind" value="1" title="macro name: @{defense_from_behind}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="attack-from-behind-label">Attack From Behind <i>Peripheral</i>: -2</span>
												<span class="tooltiptext">
													<span data-i18n="attack-from-behind-tooltip">Normally, if attacked from behind, you have no defense. However, if you have Peripheral Vision you can defend at -2. See B391</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_runaround" value="1" title="macro name: @{defense_runaround}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="runaround-attack-label">Runaround Attack: -2</span>
												<span class="tooltiptext">
													<span data-i18n="runaround-attack-tooltip">Your foe starts in front of you and runs behind you and attacks from behind. You can defend at -2. See B391</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<h5>
										<span data-i18n="defense-bonus-label">Defense Bonus</span>
									</h5>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_shield_db" title="macro: @{shield_db}">
												<option>0</option>
												<option>1</option>
												<option>2</option>
												<option>3</option>
												<option>4</option>
												<option>5</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="shield-abbreviate-defense-bonus-label">Shield DB</span>
												<span class="tooltiptext">
													<span data-i18n="shield-defense-bonus-tooltip">Apply defense bonus for a shield if attack came the front or from your shield side. See B374.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_magic_db" title="macro: @{magic_db}">
												<option>0</option>
												<option>1</option>
												<option>2</option>
												<option>3</option>
												<option>4</option>
												<option>5</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="magic-abbreviate-defense-bonus-label">Magic DB</span>
												<span class="tooltiptext">
													<span data-i18n="magic-defense-bonus-tooltip">Magical Defense Bonus, such as the Shield spell, which protects from <i>frontal</i> attacks. See B252.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_general_db" title="macro: @{general_db}">
												<option>0</option>
												<option>1</option>
												<option>2</option>
												<option>3</option>
												<option>4</option>
												<option>5</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="general-abbreviate-defense-bonus-label">General DB</span>
												<span class="tooltiptext">
													<span data-i18n="general-defense-bonus-tooltip">A general defense bonus, such as the Supers Meta-trait (see Supers B34), force field, etc.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item7">

								<div class="block">
									<h5>
										<span data-i18n="other-actions-title">Other Actions</span>
									</h5>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_retreat_dodge" value="1" title="macro name: @{defense_retreat_dodge}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="retreating-dodge-label">Retreating Dodge: +3</span>
												<span class="tooltiptext">
													<span data-i18n="retreating-dodge-tooltip">Move away from attacker, at least one yard or up to your <b>step</b>. See B377</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_retreat_parry" value="1" title="macro name: @{defense_retreat_parry}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="retreating-block-parry-label">Retreating Block/Parry: +1</span>
												<span class="tooltiptext">
													<span data-i18n="retreating-block-parry-tooltip">Retreating block or parry. Move away from attacker, at least one yard or up to your <b>step</b>. See B377</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_retreat_parry_fence" value="1" title="macro name: @{defense_retreat_parry_fence}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="retreating-parry-label">Retreating Parry: +3</span>
												<span class="tooltiptext">
													<span data-i18n="retreating-parry-tooltip">If using Boxing, Judo, Karate, or any fencing skill, you can get a +3 retreating bonus.<br />Move away from attacker, at least one yard or up to your <b>step</b>. See B377</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_retreating_flight" value="1" title="macro name: @{defense_retreating_flight}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="retreating-flight-label">Retreating Flight</span><span>: +1</span>
												<span class="tooltiptext">
													<span data-i18n="retreating-flight-tooltip">If flyer can <b>hover</b>, add +1 to defense to retreating defense <i>if</i> you can move 1 hex up or down. See B398</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_acrobatic_dodge_success" value="1" title="macro name: @{defense_acrobatic_dodge_success}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="acrobatic-dodge-label">Acrobatic Dodge</span><span>: +2</span>
												<span class="tooltiptext">
													<span data-i18n="acrobatic-dodge-success-tooltip">If you made a successful acrobatic/aerobatic roll, get +2 to dodge. See B375</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_acrobatic_dodge_failed" value="1" title="macro name: @{defense_acrobatic_dodge_failed}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="acrobatic-dodge-label">Acrobatic Dodge</span><span>: -2</span>
												<span class="tooltiptext">
													<span data-i18n="acrobatic-dodge-failed-tooltip">If you failed your acrobatic/aerobatic roll, you're at -2 to dodge. See B375</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_dodge_drop" value="1" title="macro name: @{defense_dodge_drop}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="dodge-drop-label">Dodge & Drop: +3</span>
												<span class="tooltiptext">
													<span data-i18n="dodge-drop-tooltip">Only against <b>ranged attacks</b>, drop to the ground and become prone.<br />Any cover you get does <i>not</i> count against the initial attack.<br /><b>NOTE:</b> Flying or Swimming is possible but only if a step would take you below concealing terrain. See B377</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_feverish" value="1" title="macro name: @{defense_feverish}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="feverish-defense-label">Feverish Defense (1 FP): +2</span>
												<span class="tooltiptext">
													<span data-i18n="feverish-defense-tooltip">Spend <b>1 FP</b> to increase active defense by 2.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_offhand_parry" value="1" title="macro name: @{defense_offhand_parry}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="offhand-parry-label">Off-Hand Parry: -2</span>
												<span class="tooltiptext">
													<span data-i18n="offhand-parry-tooltip">Off-Hand weapon parry is at -2. See B549</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_defense_parries" title="macro: @{defense_parries}">
												<option value="0">1</option>
												<option value="-4">2</option>
												<option value="-8">3</option>
												<option value="-12">4</option>
												<option value="-16">5</option>
												<option value="-20">6</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="number-of-parries-label"># of Parries</span>
												<span class="tooltiptext">
													<span data-i18n="number-of-parries-tooltip">You can more parry more than once per turn, but each additional parry is at a -4 penalty. See B376</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_defense_parries_master" title="macro: @{defense_parries_master}">
												<option value="0">1</option>
												<option value="-2">2</option>
												<option value="-4">3</option>
												<option value="-6">4</option>
												<option value="-8">5</option>
												<option value="-10">6</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="number-of-parries-master-label"># of Parries <i>Master</i></span>
												<span class="tooltiptext">
													<span data-i18n="number-of-parries-master-tooltip">If you're <b>Trained by a Master</b> or a <b>Weapon Master</b>, penalties are halved. See B376</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_defense_improvised_weapon" title="macro: @{defense_improvised_weapon}">
												<option>0</option>
												<option>-1</option>
												<option>-2</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="defense-improvised-abbreviate-weapon-label">Improvised Wpn</span>
												<span class="tooltiptext">
													<span data-i18n="defense-improvised-weapon-tooltip"><b>NOTE:</b> <i>Dungeon Fantasy:</i> if parrying with an improvised weapon, apply a penalty. See DF Exploits-37</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item10">
								
								<div class="block">
									<h5>
										<span data-i18n="situation-title">Situation</span>		
									</h5>
								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_laser_sight" value="1" title="macro name: @{defense_laser_sight}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="laser-sight-label">Laser Sight: +1</span>
												<span class="tooltiptext move-left">
													<span data-i18n="defense-laser-sight-tooltip">If you can see the laser sight, you get +1 to <b>Dodge</b>. See B548</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<select name="attr_defense_deceptive_attack" title="macro: @{defense_deceptive_attack}">
												<option selected>0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
												<option>-7</option>
												<option>-8</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="against-deceptive-attack-label">Against Deceptive Attack</span>
												<span class="tooltiptext move-left">
													<span data-i18n="against-deceptive-attack-tooltip">You're at -1 to defense for every -2 the attacker took to their to hit modifier. See B369</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<select name="attr_defense_feint" title="macro: @{defense_feint}">
												<option selected>0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
												<option>-7</option>
												<option>-8</option>
												<option>-9</option>
												<option>-10</option>
												<option>-11</option>
												<option>-12</option>
												<option>-13</option>
												<option>-14</option>
												<option>-15</option>
												<option>-16</option>
												<option>-17</option>
												<option>-18</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="feint-attack-label">Feint Attack</span>
												<span class="tooltiptext move-left">
													<span data-i18n="feint-attack-tooltip">You're at a penalty equal to the attacker's margin of victory. See B365</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">
									<div>
										<div class="tooltip">
											<span data-i18n="height-difference-label">Height Difference</span>
											<span class="tooltiptext">
												<span data-i18n="height-difference-tooltip">If you and your foe are at different levels, the vertical distance affects combat. See B402</span>
											</span>
										</div>
									</div>
								
									<div>
										<select name="attr_defense_height_difference" title="macro name: @{defense_height_difference}">
											<option value="0" selected="selected">0-2 feet: +0</option>
											<option value="2-3-higher">Above, 2-3 feet: +1</option>
											<option value="3-4-higher">Above, 3-4 feet: +2</option>
											<option value="4-6-higher">Above, 4-6 feet: +3</option>
											<option value="2-3-below">Below, 2-3 feet: -1</option>
											<option value="3-4-below">Below, 3-4 feet: -2</option>
											<option value="4-6-below">Below, 4-6 feet: -3</option>
										</select>
									</div>
									
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_defense_mounted" title="macro name: @{defense_mounted}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="mounted-label">Mounted</span>
												<span class="tooltiptext">
													<span data-i18n="defense-mounted-tooltip">If mounted, defensive penalty is equal to difference between 12 and Riding skill. See B388</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<select name="attr_defense_tactics" title="macro name: @{defense_tactics}">
												<option value="0" selected="selected">0</option>
												<option>+1</option>
												<option>+2</option>
												<option>-1</option>
												<option>-2</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="tactics-label">Tactics</span>
												<span class="tooltiptext">
													<span data-i18n="tactics-tooltip"><b>NOTE!</b> from Dungeon Fantasy. A teammate spends turn to observe and advise you. If accepted, roll friends tactics. Success: +1 hit. Critical Success: +2. Fail: -1 hit. Critical Fail: -2 hit. See DF Exploits 57.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_hidden_weapon" value="1" title="macro name: @{defense_hidden_weapon}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="hidden-weapon-label">Hidden Weapon: -2</span>
												<span class="tooltiptext">
													<span data-i18n="defense-hidden-weapon-tooltip"><b>NOTE:</b> From <i>Dungeon Fantasy</i>. If attacked by a hidden weapon, you're at -2 to your first defense. See DF Exploits-58</span>
												</span>
											</div>
										</div>
									</label>

								</div>

							</div>

							<div class="item item8-9">

								<div class="block">
									<h5>
										<span data-i18n="defenders-equipment-label">Defender's Equipment</span>
									</h5>
								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_parry_knife" value="1" title="macro name: @{defense_parry_knife}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="parrying-knife-label">Parrying with Knife/Dagger: -1</span>
												<span class="tooltiptext move-left">
													<span data-i18n="parrying-knife-tooltip">If parrying with a knife or dagger is -1. See B548<br /><b>Suggestion:</b> Add the modifier to your defense skill instead of using checkbox.</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_parry_kusari" value="1" title="macro name: @{defense_parry_kusari}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="parrying-kusari-label">Parrying with Kusari/Whip: -2</span>
												<span class="tooltiptext move-left">
													<span data-i18n="parrying-kusari-tooltip">If parrying with a kusari or whip is -2. See B548<br /><b>Suggestion:</b> Add the modifier to your defense skill instead of using checkbox.</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_unarmed_parry" value="1" title="macro name: @{defense_unarmed_parry}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="unarmed-parry-label">Unarmed Parry: -3</span>
												<span class="tooltiptext move-left">
													<span data-i18n="unarmed-parry-tooltip">Unarmed parry vesus a weapon is -3, unless it's a thrust or you are using Judo or Karate parry. See B548</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">
									<h5>
										<span data-i18n="attackers-equipment-label">Attacker's Equipment</span>
									</h5>
								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_dual_weapon" value="1" title="macro name: @{defense_dual_weapon}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="against-dual-weapon-label">Against Dual-Weapon: -1</span>
												<span class="tooltiptext move-left">
													<span data-i18n="against-dual-weapon-tooltip">If both attacks hit you, you're at -1 to defend. See B548.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_parry_flail" value="1" title="macro name: @{defense_parry_flail}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="parry-flail-label">Parry against Flail: -4</span>
												<span class="tooltiptext move-left">
													<span data-i18n="parry-flail-tooltip">If parrying against a flail, you're at -4 to defend. See B405.<br /><b>NOTE:</b> You can't parry flails with a <i>fencing</i> weapon.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_parry_nunchaku" value="1" title="macro name: @{defense_parry_nunchaku}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="parry-nunchaku-label">Parry against Nunchaku: -2</span>
												<span class="tooltiptext move-left">
													<span data-i18n="parry-nunchaku-tooltip">If parrying against a nunchaku, you're at -2 to defend. See B405.<br /><b>NOTE:</b> You can't parry nunchaku with a <i>fencing</i> weapon.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_block_flail" value="1" title="macro name: @{defense_block_flail}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="block-flail-label">Block against Flail: -2</span>
												<span class="tooltiptext move-left">
													<span data-i18n="block-flail-tooltip">If blocking against a flail, you're at -2 to defend. See B405.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_block_nunchaku" value="1" title="macro name: @{defense_block_nunchaku}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="block-nunchaku-label">Block against Nunchaku: -2</span>
												<span class="tooltiptext move-left">
													<span data-i18n="block-nunchaku-tooltip">If blocking against a nunchaku, you're at -1 to defend. See B405.</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_thrown_weapon" value="1" title="macro name: @{defense_thrown_weapon}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="parry-thrown-weapon-label">Parry thrown weapon: -1</span>
												<span class="tooltiptext move-left">
													<span data-i18n="parry-thrown-weapon-tooltip">Parry -1 against thrown weapon. See B549</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_thrown_small_weapon" value="1" title="macro name: @{defense_thrown_small_weapon}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="parry-thrown-small-weapon-label">Parry thrown small weapon: -2</span>
												<span class="tooltiptext move-left">
													<span data-i18n="parry-thrown-small-weapon-tooltip">If the weapon is 1 pound or less, parry is -2. See B549</span>
												</span>
											</div>
										</div>
									</label>

								</div>

								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_trident_dodge" value="1" title="macro name: @{defense_trident_dodge}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="trident-dodge-label">Trident: -1 Dodge</span>
												<span class="tooltiptext move-left">
													<span data-i18n="trident-dodge-tooltip"><b>NOTE:</b> From <i>Dungeon Fantasy</i>. -1 to dodge a trident. See DF Exploits-97</span>
												</span>
											</div>
										</div>
									</label>

								</div>
								
								<div class="block">

									<label>
										<div>
											<input type="checkbox" name="attr_defense_trident_block" value="1" title="macro name: @{defense_trident_block}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="trident-block-label">Trident: +1 Block</span>
												<span class="tooltiptext move-left">
													<span data-i18n="trident-block-tooltip"><b>NOTE:</b> From <i>Dungeon Fantasy</i>. +1 to <b>block</b> or <b>parry</b> a trident. See DF Exploits-97</span>
												</span>
											</div>
										</div>
									</label>

								</div>

							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_spell_modifiers_section" value="0" />
					<div class="spell-modifiers section">

						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="spell-modifiers-title">Spell Modifiers</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">

								<div class="block">
									<label>
										<div>
											<input type="number" name="attr_spell_on_penalty_total" value="0" title="Macro name: spell_on_penalty_total" readonly="readonly">
										</div>
										<div>
											<div class="tooltip">
												<span data-formula="spells-on-label">Spells On</span>
												<span class="tooltiptext">
													<span data-formula="spell-on-penalty-tooltip">
														Spell skill penalty based on number of <b>ON</b> spells.<br />
														<input type="hidden" name="attr_spell_on_count" value="0" />
														Number of spells <b>ON:</b> <span name="attr_spell_on_count"></span>.<br />
														<i>NOTE:</i> Use the options tab to adjust the penalty per spell <b>ON</b>.
													</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="number" name="attr_spell_maintained_penalty_total" value="0" title="Macro name: spell_maintained_penalty_total" readonly="readonly">
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="concentration-label">Concentration</span>
												<span class="tooltiptext">
													<span data-i18n="cocentration-penalty-tooltip">
														<b>Concentration</b> spell penalty<br>
														<input type="hidden" name="attr_spell_maintained_count" value="0">
														Number of spells: <span name="attr_spell_maintained_count">0</span>.<br>
														<i>NOTE:</i> Use options tab to adjust the penalty.
													</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_spells_low_mana" value="1" title="macro name: @{spells_low_mana}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="low-mana-label">Low Mana: -5</span>
												<span class="tooltiptext">
													<span data-i18n="low-mana-tooltip">Only <i>mages</i> can cast spells and all spells are at -5. Critical failures have mild effects or no effect at all. See B235.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item7">

								<div class="block">
									<label>
										<div>
											<input type="number" value="0" max="0" step="1" name="attr_spell_burn_hit_points" title="macro name: @{spell_burn_hit_points}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="burn-abbreviate-hit-points-label">Burn HP</span>
												<span class="tooltiptext">
													<span data-i18n="burn-hit-points-tooltip">Burn Hit Points instead of FP, but you're -1 to skill per HP. <b>High Pain Threshold</b> has no effect. See B237.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="number" value="0" min="0" step="1" name="attr_spell_ceremonial_bonus" title="macro name: @{spell_ceremonial_bonus}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="ceremonial-bonus-label">Ceremonial Bonus</span>
												<span class="tooltiptext">
													<span data-i18n="ceremonial-bonus-tooltip">Ceremonial Magic involves a group of <i>willing</i> assistants. Receive a skill bonus based on how much extra energy you receive.<ul><li>20% : +1 skill</li><li>40% : +2 skill</li><li>60% : +3 skill</li><li>100% : +4 skill</li></ul>Add another +1 per additional 100% of required energy.<br />See B238.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item8">
								
								<div class="block">
									<label>
										<div>
											<input type="number" value="0" max="0" step="1" name="attr_regular_spell_modifier" title="macro name: @{regular_spell_modifier}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="spell-range-label">Spell Range</span>
												<span class="tooltiptext move-left">
													<span data-i18n="regular-spell-range-tooltip">For regular and area spells apply a penalty of -1 per yard of distance. See B239.</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_regular_spell_cant_see_touch" value="1" title="macro name: @{regular_spell_cant_see_touch}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="cant-see-touch-label">Can't See/Touch: -5</span>
												<span class="tooltiptext move-left">
													<span data-i18n="spell-cant-see-touch-tooltip">For regular spells, if you can't see or touch your subject, you're at -5 to skill. See B239.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									
									<div>
										<div class="tooltip">
											<span data-i18n="long-distance-label">Long-Distance</span>
											<span class="tooltiptext">
												<span data-i18n="long-distance-tooltip">Use these modifiers for <i>Information</i> spells that work over long distances, such as <b>Seek</b> spells. Certain advantages use these ranges. If the distance falls between two values, use the <i>higher</i> value. See B241.</span>
											</span>
										</div>
									</div>
								
									<div>
										<select name="attr_spell_long_distance" title="macro name: @{spell_long_distance}">
											<option value="0" selected="selected">UP to 200 yards : 0</option>
											<option value="-1">1/2 mile : -1</option>
											<option value="-2">1 mile : -2</option>
											<option value="-3">3 miles : -3</option>
											<option value="-4">10 miles : -4</option>
											<option value="-5">30 miles : -5</option>
											<option value="-6">100 miles : -6</option>
											<option value="-7">300 miles : -7</option>
											<option value="-8">1,000 miles : -8</option>
											<option value="-9">10,000 miles : -9</option>
										</select>
									</div>
									
								</div>

							</div>

							<div class="item item9">

								<div class="block">
	
									<div>
										<div class="tooltip">
											<span data-i18n="natures-strength-title">Nature's Strength</span>
											<span class="tooltiptext">
												<span data-i18n="natures-strength-description"><b>NOTE:</b> From Dungeon Fantasy. Modifiers to <b>druidic</b> spells. See  2.</span>
											</span>
										</div>
									</div>
								
									<div>
										<select name="attr_spell_natures_strength" title="macro name: @{spell_natures_strength}">
											<option value="0" selected>Select</option>
											<option value="wilderness-1">Primeval Wilderness : +1</option>
											<option value="wilderness-2">Primeval Wilderness : +2</option>
											<option value="wilderness-3">Primeval Wilderness : +3</option>
											<option value="wilderness-4">Primeval Wilderness : +4</option>
											<option value="wilderness-5">Primeval Wilderness : +5</option>
											<option value="not-pristine-wilderness-1">Not Pristine Wilderness : -1</option>
											<option value="structures-2">Artificial Structures : -2</option>
											<option value="structures-3">Artificial Structures : -3</option>
											<option value="structures-4">Artificial Structures : -4</option>
											<option value="defiled-5">Nature Defiled : -5</option>
											<option value="defiled-6">Nature Defiled : -6</option>
											<option value="defiled-7">Nature Defiled : -7</option>
											<option value="defiled-8">Nature Defiled : -8</option>
											<option value="defiled-9">Nature Defiled : -9</option>
											<option value="supernatural-defiled-10">Supernaturally Defiled : -10</option>
										</select>
									</div>
	
								</div>
	
							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_defense_maneuvers_section" value="0" />
					<div class="defense-maneuvers section">

						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="afflictions-conditions-title">Afflictions & Conditions</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item2">

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_stunned" value="1" title="macro name: @{defense_stunned}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="stunned-label">Stunned: -4</span>
												<span class="tooltiptext">
													<span data-i18n="stunned-tooltip">If you're stunned, defend at -4. See B420</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_nauseated" value="1" title="macro name: @{defense_nauseated}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="defense-nauseated-label">Nauseated: -1</span>
												<span class="tooltiptext">
													<span data-i18n="defense-nauseated-tooltip">If nauseated, you're at -1 to defend. See B428</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_defense_encumbered" title="macro name: @{defense_encumbered}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="encumbered-label">Encumbered</span>
												<span class="tooltiptext">
													<span data-i18n="encumbered-tooltip">Penalty equal to your encumbrance is applied to Dodge, Judo, Karate, ar any fencing Parry. See B549</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item3">

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_cant_see_attacker" value="1" title="macro name: @{defense_cant_see_attacker}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="cant-see-attacker-label">Can't See Attacker: -4</span>
												<span class="tooltiptext">
													<span data-i18n="cant-see-attacker-tooltip">If you can't see the target you're at -4. A <b>block</b> or <b>parry</b> requires Hearing-2. See B549</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item4">

								<div class="block">
									<label>
										<div>
											<select name="attr_defense_bad_footing" title="macro name: @{defense_bad_footing}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="bad-footing-label">Bad Footing</span>
												<span class="tooltiptext">
													<span data-i18n="defense-bad-footing-tooltip">Defensive penalty for bad footing. See B547-B549.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_defense_distraction" title="macro name: @{defense_distraction}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="distraction-label">Distraction</span>
												<span class="tooltiptext">
													<span data-i18n="distraction-tooltip">-1 for Bees in your face, -2 for part clothes on fire, -3 all clothes on fire, etc. See B548.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item5">
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_grappled_dodge" value="1" title="macro name: @{defense_grappled_dodge}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="grappled-dodge-label">Grappled: -1 Dodge</span>
												<span class="tooltiptext move-left">
													<span data-i18n="grappled-dodge-tooltip"><b>NOTE!</b> from Dungeon Fantasy. If grappled, you're at -1 to dodge. See DF Exploits 41</span>
												</span>
											</div>
										</div>
									</label>
								</div>
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_defense_grappled_block" value="1" title="macro name: @{defense_grappled_block}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="grappled-block-label">Grappled: -2 Block/Parry</span>
												<span class="tooltiptext move-left">
													<span data-i18n="grappled-block-tooltip"><b>NOTE!</b> from Dungeon Fantasy. If grappled, you're at -2 to block/parry. A grappled limb can't use block/parry. See DF Exploits 41</span>
												</span>
											</div>
										</div>
									</label>
								</div>
							</div>

						</div>
						
					</div>

					<input type="hidden" name="attr_display_visibility_section" value="0" />
					<div class="visiblity section">

						<div class="container">

							<!-- Row 1 -->
							<div class="item item1">
								<h4>Visibility</h4>
							</div>

							<div class="item item2">
								<label>
									<div>
										<input type="number" name="attr_visibility_modifier" value="0" readonly="readonly" title="macro name: @{visibility_modifier}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="roll-modifier-label">Roll modifier</span>
											<span class="tooltiptext">
												<span data-i18n="visibility-roll-modifier-tooltip">Combined total can't exceed -10 or -6 if used to blindness.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

						</div>

						<div class="container">

							<!-- Row 1 -->
							<div class="item item1">
								<label>
									<div>
										<input type="radio" checked="checked" name="attr_visiblity_condition" value="0" title="macro name: @{visiblity_condition}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="no-visiblity-condition-label">No special effect</span>
											<span class="tooltiptext">
												<span data-i18n="no-visiblity-condition-tooltip">Only affected by darkness, smoke, fog, blur, or other.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="item item2">
								<label>
									<div>
										<input type="radio" name="attr_visiblity_condition" value="1" title="macro name: @{attr_visiblity_condition}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="cannot-see-anything-label">Can't see anything: -10 or -6 *</span>
											<span class="tooltiptext">
												<span data-i18n="cannot-see-anything-tooltip">If used to blindess, penalty is -6 and Max Skill is 9. See B124 and B394.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="item item3">
								<label>
									<div>
										<input type="radio" name="attr_visiblity_condition" value="2" title="macro name: @{attr_visiblity_condition}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="cannot-see-target-label">Cannot see target: -6 *</span>
											<span class="tooltiptext">
												<span data-i18n="cannot-see-target-tooltip">Max Skill is 9. B394.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="item item4">
								<label>
									<div>
										<input type="radio" name="attr_visiblity_condition" value="3" title="macro name: @{attr_visiblity_condition}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="know-location-label">Know location in 1 yard: -4 *</span>
											<span class="tooltiptext move-left">
												<span data-i18n="know-location-tooltip">If the foe is in a single smoke-filled hex or the like, no Hearing roll is required and the attack penalty is only -4. Roll for random hit location. Max Skill is 9. B394.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

						</div>

						<div class="container">

							<!-- row 1 -->
							<div class="item item1">
								<label>
									<div>
										<select name="attr_darkness_penalty" class="number-only-width" title="macro name: @{darkness_penalty}">
											<option>0</option>
											<option>-1</option>
											<option>-2</option>
											<option>-3</option>
											<option>-4</option>
											<option>-5</option>
											<option>-6</option>
											<option>-7</option>
											<option>-8</option>
											<option>-9</option>
										</select>
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="darkness-label">Darkness</span>
											<span class="tooltiptext">
												<span data-i18n="darkness-tooltip">-10 is considered total darkness, no light available. See B394.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="item item2">
								<label>
									<div>
										<select name="attr_smoke_penalty" class="number-only-width" title="macro name: @{smoke_penalty}">
											<option>0</option>
											<option>-1</option>
											<option>-2</option>
											<option>-3</option>
											<option>-4</option>
											<option>-5</option>
											<option>-6</option>
											<option>-7</option>
											<option>-8</option>
											<option>-9</option>
											<option>-10</option>
										</select>
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="smoke-label">Smoke</span>
											<span class="tooltiptext">
												<span data-i18n="obscure-vision-tooltip">-10 totally obscures vision. See Obscure B72.</span>
											</span>
										</div>
									</div>
								</label>
							</div>
							
							<div class="item item3">
								<label>
									<div>
										<select name="attr_fog_penalty" class="number-only-width" title="macro name: @{fog_penalty}">
											<option>0</option>
											<option>-1</option>
											<option>-2</option>
											<option>-3</option>
											<option>-4</option>
											<option>-5</option>
											<option>-6</option>
											<option>-7</option>
											<option>-8</option>
											<option>-9</option>
											<option>-10</option>
										</select>
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="fog-label">Fog</span>
											<span class="tooltiptext">
												<span data-i18n="obscure-vision-tooltip">-10 totally obscures vision. See Obscure B72.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="item item4">
								<label>
									<div>
										<select name="attr_blur_penalty" class="number-only-width" title="macro name: @{blur_penalty}">
											<option>0</option>
											<option>-1</option>
											<option>-2</option>
											<option>-3</option>
											<option>-4</option>
											<option>-5</option>
											<option>-6</option>
											<option>-7</option>
											<option>-8</option>
											<option>-9</option>
											<option>-10</option>
										</select>
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="blur-label">Blur</span>
											<span class="tooltiptext">
												<span data-i18n="obscure-vision-tooltip">-10 totally obscures vision. See Obscure B72.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="item item5">
								<label>
									<div>
										<select name="attr_other_vision_penalty" class="number-only-width" title="macro name: @{other_vision_penalty}">
											<option>0</option>
											<option>-1</option>
											<option>-2</option>
											<option>-3</option>
											<option>-4</option>
											<option>-5</option>
											<option>-6</option>
											<option>-7</option>
											<option>-8</option>
											<option>-9</option>
											<option>-10</option>
										</select>
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="other-label">Other</span>
											<span class="tooltiptext move-left">
												<span data-i18n="obscure-vision-tooltip">-10 totally obscures vision. See Obscure B72.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_afflictions_section" value="0" />
					<div class="afflictions section">

						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="afflictions-conditions-title">Afflictions & Conditions</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">
								
								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_coughing_sneezing_iq" value="1" title="macro name: @{coughing_sneezing_iq}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="coughing-sneezing-iq-label">Coughing/Sneezing: -1 IQ</span>
												<span class="tooltiptext">
													<span data-i18n="coughing-sneezing-iq-tooltip">-1 to IQ and IQ-based skills. Can't use Stealth. See B428.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_coughing_sneezing_dx" value="1" title="macro name: @{coughing_sneezing_dx}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="coughing-sneezing-dx-label">Coughing/Sneezing: -3 DX</span>
												<span class="tooltiptext">
													<span data-i18n="coughing-sneezing-dx-tooltip">-3 to DX and DX-based skills. Can't use Stealth. See B428.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_drowsy" value="1" title="macro name: @{drowsy}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="drowsy-label">drowsy: -2</span>
												<span class="tooltiptext">
													<span data-i18n="drowsy-tooltip">-2 to DX, IQ, and self-control rolls. Make a Will roll every two hours you're inactive to avoid falling asleep. See B428.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_tipsy" value="1" title="macro name: @{tipsy}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="tipsy-label">Tipsy: -1</span>
												<span class="tooltiptext">
													<span data-i18n="tipsy-tooltip">-2 to DX and IQ and -2 self-control rolls except to resist Cowardice. Reduce Shyness by one level. See B428.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_drunk" value="1" title="macro name: @{drunk}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="drunk-label">Drunk: -2</span>
												<span class="tooltiptext">
													<span data-i18n="drunk-tooltip">-2 to DX and IQ and -4 self-control rolls except to resist Cowardice. Reduce Shyness by <i>two</i> levels. See B428.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_euphoria" value="1" title="macro name: @{euphoria}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="euphoria-label">Euphoria: -3</span>
												<span class="tooltiptext">
													<span data-i18n="euphoria-tooltip">-3 to DX, IQ, and self-control rolls. See B428.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item2">

								<div class="block">
									<label>
										<div>
											<select name="attr_distraction" title="macro name: @{distraction}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="distraction-label">Distraction</span>
												<span class="tooltiptext">
													<span data-i18n="distraction-tooltip">-1 for Bees in your face, -2 for part clothes on fire, -3 all clothes on fire, etc. See B548.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_pain_level" title="macro name: @{pain_level}">
												<option value="0" selected="selected">No Pain</option>
												<option value="-2">-2 : Moderate</option>
												<option value="-4">-4 : Severe</option>
												<option value="-6">-6 : Terrible</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="pain-level-label">Pain Level</span>
												<span class="tooltiptext">
													<span data-i18n="pain-level-tooltip">Penalty to DX, IQ, and self-control rolls. Hight Pain Threshold halves penalty while Low Pain Threshold doubles the penalty. See B428.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_skill_encumbered" title="macro name: @{skill_encumbered}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="encumbered-label">Encumbered</span>
												<span class="tooltiptext">
													<span data-i18n="skill-encumbered-tooltip">Penalty equal to your encumbrance is applied to your skill.<br />Example: Climbing, Judo, Karate, Fencing Weapons, Stealth.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

							<div class="item item3">

								<div class="block">
									<label>
										<div>
											<select name="attr_bad_footing" title="macro name: @{bad_footing}">
												<option value="0" selected="selected">0</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
												<option>-6</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="bad-footing-label">Bad Footing</span>
												<span class="tooltiptext">
													<span data-i18n="bad-footing-tooltip">If defense, -1 or more. If attacking/skill, -2 or more. See B547-B549.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<select name="attr_shield_close_combat_penalty" title="macro name: @{shield_close_combat_penalty}">
												<option value="0" selected="selected">0</option>
												<option>-1</option>
												<option>-2</option>
												<option>-3</option>
												<option>-4</option>
												<option>-5</option>
											</select>
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="shield-close-combat-penalty-label">Close combat with shield: -1 per DB</span>
												<span class="tooltiptext">
													<span data-i18n="shield-close-combat-penalty-tooltip">See B547.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_grappled" value="1" title="macro name: @{grappled}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="grappled-label">You're grappled: -4</span>
												<span class="tooltiptext">
													<span data-i18n="grappled-tooltip">See Actions after being grappled for more information. See B371.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

								<div class="block">
									<label>
										<div>
											<input type="checkbox" name="attr_holding_large_shield" value="1" title="macro name: @{holding_large_shield}" />
										</div>
										<div>
											<div class="tooltip">
												<span data-i18n="holding-large-shield-label">Holding Large Shield: -2</span>
												<span class="tooltiptext">
													<span data-i18n="holding-large-shield-tooltip">See B547.</span>
												</span>
											</div>
										</div>
									</label>
								</div>

							</div>

						</div>

					</div>
					
					<input type="hidden" name="attr_display_tasks_section" value="0" />
					<div class="tasks section">

						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="task-modifiers-title">Task Modifiers</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">
								<div>
									<div class="tooltip">
										<span data-i18n="task-difficulty-label">Task Difficulty</span>
										<span class="tooltiptext">
											<span data-i18n="task-difficulty-tooltip">See B345 for full description.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_task_difficulty" class="medium-width" title="macro name: @{task_difficulty}">
										<option value="10">+10 : Automatic (start car)</option>
										<option value="9">+9 : Trivial (drive empty lot)</option>
										<option value="8">+8 : Trivial (drive empty lot)</option>
										<option value="7">+7 : Very Easy (drive empty street)</option>
										<option value="6">+6 : Very Easy (drive empty street)</option>
										<option value="5">+5 : Easy (drive small town)</option>
										<option value="4">+4 : Easy (drive small town)</option>
										<option value="3">+3 : Very Favorable (drive city)</option>
										<option value="2">+2 : Very Favorable (drive city)</option>
										<option value="1">+1 : Favorable (road rally)</option>
										<option value="0" selected="selected">0 : Average (Car chase)</option>
										<option value="-1">-1 : Unfavorable (High-speed chase)</option>
										<option value="-2">-2 : Very Unfavorable (Busy freeway chase)</option>
										<option value="-3">-3 : Very Unfavorable (Busy freeway chase)</option>
										<option value="-4">-4 : Hard (High-speed chase and shooting)</option>
										<option value="-5">-5 : Hard (High-speed chase and shooting)</option>
										<option value="-6">-6 : Very Hard (High-speed chase in blizzard)</option>
										<option value="-7">-7 : Very Hard (High-speed chase in blizzard)</option>
										<option value="-8">-8 : Dangerous (High-speed chase, blizzard, and shooting)</option>
										<option value="-9">-9 : Dangerous (High-speed chase, blizzard, and shooting)</option>
										<option value="-10">-10 : Impossible (Drive with knees, blizzard, shoot bazooka)</option>
									</select>
								</div>
							</div>

							<div class="item item7">
								<div>
									<div class="tooltip">
										<span data-i18n="extra-time-label">Extra Time</span>
										<span class="tooltiptext">
											<span data-i18n="extra-time-tooltip">Working slowly and deliberately on a noncombat task. See B346.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_task_extra_time" class="" title="macro name: @{task_extra_time}">
										<option value="0" selected="selected">0 : Normal Time</option>
										<option value="1">+1 : Time x 2</option>
										<option value="2">+2 : Time x 4</option>
										<option value="3">+3 : Time x 8</option>
										<option value="4">+4 : Time x 15</option>
										<option value="5">+5 : Time x 30</option>
									</select>
								</div>
							</div>

							<div class="item item8">
								<div>
									<div class="tooltip">
										<span data-i18n="haste-label">Haste</span>
										<span class="tooltiptext">
											<span data-i18n="haste-tooltip">Hurrying the noncombat task. See B346.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_task_haste" class="" title="macro name: @{task_haste}">
										<option value="0" selected="selected">0 : Normal Time</option>
										<option value="-1">-1 : Time x 90%</option>
										<option value="-2">-2 : Time x 80%</option>
										<option value="-3">-3 : Time x 70%</option>
										<option value="-4">-4 : Time x 60%</option>
										<option value="-5">-5 : Time x 50%</option>
										<option value="-6">-6 : Time x 40%</option>
										<option value="-7">-7 : Time x 30%</option>
										<option value="-8">-8 : Time x 20%</option>
										<option value="-9">-9 : Time x 10%</option>
										<option value="-10">-10 : Instant (cinematic)</option>
									</select>
								</div>
							</div>

						</div>

						<div class="container">

							<!-- row 1 -->
							<div class="item item1">
								<label>
									<div>
										<input type="checkbox" name="attr_unfamiliar_culture" value="1" title="macro name: @{unfamiliar_culture}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="unfamiliar-culture-label">Unfamiliar Culture: -3</span>
											<span class="tooltiptext">
												<span data-i18n="unfamiliar-culture-tooltip">-3 to skill with a significant cultural component; Carousing, Connoisseur, Criminology, Dancing, Detect Lies, Diplomacy, Fast-Talk, Games, Gesture, etc. See B23.</span>
											</span>
										</div>
									</div>
								</label>
							</div>

							<div class="item item2">
								<div>
									<div class="tooltip">
										<span data-i18n="language-modifier-label">Language Modifier</span>
										<span class="tooltiptext">
											<span data-i18n="language-modifier-tooltip">Based on comprehension, use Task Difficulty for additional modifiers like bad phone connection. See B24.<br />Language skills: Fast-Talk, Public Speaking, Research, Speed-Reading, teaching, and Writing.<br />Artistic Skills: Poetry, Singing, etc.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_language_modifier" class="" title="macro name: @{language_modifier}">
										<option value="0" selected="selected">0 : Native</option>
										<option value="-1">-1 : Accented (language skills)</option>
										<option value="-2">-2 : Accented (artistic skills)</option>
										<option value="-3">-3 : Broken (language skills)</option>
										<option value="-6">-6 : Broken (artisitc skills)</option>
									</select>
								</div>
							</div>

							<div class="item item3">
								<div>
									<div class="tooltip">
										<span data-i18n="iq-tech-level-modifier-label">IQ Tech Level Modifier</span>
										<span class="tooltiptext">
											<span data-i18n="iq-tech-level-modifier-tooltip">IQ-Based skills. When you work with equipment or concepts of a TL different from your own skill, you suffer a penalty. See B168.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_iq_tech_level_modifier" class="" title="macro name: @{iq_tech_level_modifier}">
										<option value="-100">Impossible : Your TL + 4</option>
										<option value="-15">-15 : Your TL + 3</option>
										<option value="-10">-10 : Your TL + 2</option>
										<option value="-5">-5 : Your TL + 1</option>
										<option value="0" selected="selected">0 : Your TL</option>
										<option value="-1">-1 : Your TL - 1</option>
										<option value="-3">-3 : Your TL - 2</option>
										<option value="-5">-5 : Your TL - 3</option>
										<option value="-7">-7 : Your TL - 4</option>
										<option value="-8">-8 : Your TL - 5</option>
										<option value="-9">-9 : Your TL - 6</option>
										<option value="-10">-10 : Your TL - 7</option>
										<option value="-11">-11 : Your TL - 8</option>
										<option value="-12">-12 : Your TL - 9</option>
										<option value="-13">-13 : Your TL - 10</option>
										<option value="-14">-14 : Your TL - 11</option>
										<option value="-15">-15 : Your TL - 12</option>
									</select>
								</div>
							</div>

							<div class="item item4">
								<div>
									<div class="tooltip">
										<span data-i18n="non-iq-tech-level-modifier-label">Non IQ TL Modifier</span>
										<span class="tooltiptext move-left">
											<span data-i18n="non-iq-tech-level-modifier-tooltip">Non IQ-Based skills. Flat penalty of -1 per TL difference. See B168.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_non_iq_tech_level_modifier" class="number-only-width" title="macro name: @{non_iq_tech_level_modifier}">
										<option selected="selected">0</option>
										<option>-1</option>
										<option>-2</option>
										<option>-3</option>
										<option>-4</option>
										<option>-5</option>
										<option>-6</option>
										<option>-7</option>
										<option>-8</option>
										<option>-9</option>
										<option>-10</option>
										<option>-11</option>
										<option>-12</option>
									</select>
								</div>
							</div>

						</div>

					</div>

					<input type="hidden" name="attr_display_equipment_section" value="0" />
					<div class="equipment section">
					
						<div class="container">

							<!-- row 1 -->
							<div class="item item1-5 full-width">
								<h4>
									<span data-i18n="equipment-modifiers-title">Equipment Modifiers</span>
								</h4>
							</div>

							<!-- row 2 -->
							<div class="item item6">
								<div>
									<div class="tooltip">
										<span data-i18n="available-equipment-label">Available Equipment</span>
										<span class="tooltiptext">
											<span data-i18n="available-equipment-tooltip">Equipment modifiers for skills. See B345.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_task_equipment_modifier" class="medium-width" title="macro name: @{task_equipment_modifier}">
										<option value="6">+6 : Best for equipment Tech Level 12</option>
										<option value="5">+5 : Best for equipment Tech Level 10 or 11</option>
										<option value="4">+4 : Best for equipment Tech Level 8 or 9</option>
										<option value="3">+3 : Best for equipment Tech Level 6 or 7</option>
										<option value="2">+2 : Fine-quality equipment</option>
										<option value="1">+1 : Good-quality equipment</option>
										<option value="0" selected="selected">0 : Base Equipment</option>
										<option value="-2">-2 : Improvised equipment for non-technological skill</option>
										<option value="-5">-5 : No equipment for non-technological skill</option>
										<option value="-5">-5 : Improvised equipment for technological skill</option>
										<option value="-10">-10 : No equipment for technological skill</option>
									</select>
								</div>
							</div>

							<div class="item item7">
								<div>
									<div class="tooltip">
										<span data-i18n="missing-items-label">Missing Items</span>
										<span class="tooltiptext">
											<span data-i18n="missing-items-tooltip">-1 per item missing. See B346.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_task_missing_items" class="" title="macro name: @{task_missing_items}">
										<option value="0" selected="selected">0</option>
										<option value="-1">-1</option>
										<option value="-2">-2</option>
										<option value="-3">-3</option>
										<option value="-4">-4</option>
										<option value="-5">-5</option>
										<option value="-6">-6</option>
										<option value="-7">-7</option>
										<option value="-8">-8</option>
										<option value="-9">-9</option>
										<option value="-10">-10</option>
									</select>
								</div>
							</div>

							<div class="item item8">
								<div>
									<div class="tooltip">
										<span data-i18n="damaged-equipment-label">Damaged Equipment</span>
										<span class="tooltiptext">
											<span data-i18n="damaged-equipment-tooltip">Damaged equipment modifier, such as -1 for first-aid kit salvaged from a wreck. See B346.</span>
										</span>
									</div>
								</div>
								<div>
									<select name="attr_task_damaged_equipment" class="" title="macro name: @{task_damaged_equipment}">
										<option value="0" selected="selected">0</option>
										<option value="-1">-1</option>
										<option value="-2">-2</option>
										<option value="-3">-3</option>
									</select>
								</div>
							</div>

							<div class="item item9">
								<label>
									<div>
										<input type="checkbox" name="attr_unfamiliar_equipment" value="1" title="macro name: @{unfamiliar_equipment}" />
									</div>
									<div>
										<div class="tooltip">
											<span data-i18n="unfamiliar-equipment-label">Unfamiliar Equipment: -2</span>
											<span class="tooltiptext move-left">
												<span data-i18n="unfamiliar-equipment-tooltip">Any skill used to operate equipment like Driving/TL7 (Autommobile) takes a penalty when faced with an unfamiliar type of item. For instance, you're used to a compact car but you need to drive a van. See B169</span>
											</span>
										</div>
									</div>
								</label>
							</div>

						</div>

					</div>

				</div>
			</div><!-- end .modal-main-content -->

			<div class="modal-footer">
				<button type="action" name="act_apply_roll_modifiers" class="btn" title="Apply modifiers and close"><span data-i18n="apply-label">Apply</span></button>
				<button type="action" name="act_reset_roll_modifiers" class="btn" title="Reset all values on dialog box."><span data-i18n="reset-label">Reset</span></button>
			</div>
		</div>
	</div>

	<!-- HIDDEN FIELDS -->
	<input type="hidden" name="attr_10" value="10" />
	<input type="hidden" name="attr_VS" value="vs:" />
	<input type="hidden" name="attr_languages_points" value="0" />
	<input type="hidden" name="attr_cf_points" value="0" />
	<input type="hidden" name="attr_advantages_points" value="0" />
	<input type="hidden" name="attr_advantages_perks" value="0" />
	<input type="hidden" name="attr_disadvantages_points" value="0" />
	<input type="hidden" name="attr_disadvantages_quirks" value="0" />
	<input type="hidden" name="attr_racial_points" value="0" />
	<input type="hidden" name="attr_skills_points" value="0" />
	<input type="hidden" name="attr_techniques_points" value="0" />
	<input type="hidden" name="attr_techniques_revised_points" value="0" />
	<input type="hidden" name="attr_skill_points" value="0" />
	<input type="hidden" name="attr_spells_points" value="0" />
	<input type="hidden" name="attr_announcements_hide" value="0" />
	<input type="hidden" name="attr_inventory_fixed_digits" value="0" />
	<input type="hidden" name="attr_base_attribute_level" value="10" />
	<!-- /HIDDEN FIELDS -->

	<div class="heading-character-name">
		
		<div style="float:right; margin-left: 15px;">

			<!-- see: https://codepen.io/YozhEzhi/pen/gcLpI/ -->
			<input type="hidden" name="attr_display_roll_modifiers_header" />
			<div class="roll-options roll-modifiers-prompt">
				
				<label>
					<input type="radio" name="attr_modifier_option_header" value="0" />
					<span data-i18n="no-prompt-label">No Prompt</span>
				</label>
				<label>
					<input type="radio" name="attr_modifier_option_header" value="1" />
					<span data-i18n="single-prompt-label">Single Prompt</span>
				</label>
				<label>
					<input type="radio" name="attr_modifier_option_header" value="2" />
					<span data-i18n="extended-prompt-label">Extended Prompts</span>
				</label>

			</div>
			
		</div>

		<div style="float:right;">

			<!-- see: https://codepen.io/YozhEzhi/pen/gcLpI/ -->
			<input type="hidden" name="attr_display_roll_option_header" />
			<div class="roll-options">
				
				<label>
					<input type="radio" name="attr_roll_option_header" value="public" />
					<span data-i18n="public-rolls-label">Public Rolls</span>
				</label>
				<label>
					<input type="radio" name="attr_roll_option_header" value="private" />
					<span data-i18n="private-rolls-label">Private Rolls</span>
				</label>

				<input type="hidden" name="attr_display_custom_roll_option_header" />
				<label class="custom-roll-button">
					<input type="radio" name="attr_roll_option_header" value="custom" />
					<span name="attr_custom_roll_macro_label"></span>
				</label>

			</div>
			
		</div>

		<div style="float:left;">
			<h3><span name="attr_character_name"></span></h3>
		</div>
			
	</div>

	<div class="update-alert">
		<div class="container">
			<input type="checkbox" class="showarrow ack-button" name="attr_announcements_show" value="1" title="Click to view announcements" />
			<label class="show-content">
				<span data-i18n="announcements">Announcements</span> <span name="attr_latest_changes"></span>
			</label>
			<div class="content">
				<h4>
					<span data-i18n="sheet-version-title">GURPS Character Sheet Version:</span>
					<input type="text" name="attr_announcement_version" readonly="readonly" value="0" title="GURPS Character Sheet Version" />
				</h4>
				
				<ul>
					<li>GCA Import Bug Fix. With the help of Gata, The Fabulous Iron Chef, and a discord user I was able to find a bug related to multiple attack modes.</li>
				</ul>

				<label class="check"><input type="checkbox" name="attr_announcements_hide" value="1">&nbsp;<b><span data-i18n="hide-until-next-update">Hide until next update</span></b></label>
				<button type="action" name="act_view_updates_tab" class="reset"><span data-i18n="view-all-updates">View All Updates</span></button>
			</div>
		</div>
	</div>
	

	<!-- ===== ===== ===== ===== TABS ===== ===== ===== ===== -->
	<input type="radio" name="attr_tab" value="1" class="tab tab1" checked="checked" /><span data-i18n="tab-general">General</span>
	<input type="radio" name="attr_tab" value="2" class="tab tab2" title="Languages, Advantages, Disadvantages, and Cultural Familiarities" /><span data-i18n="tab-traits">Traits</span>
	<input type="radio" name="attr_tab" value="1a" class="tab tab-misc" title="Miscellaneous box, Bio Notes, General Notes" /><span data-i18n="tab-bio-misc">Bio\Misc</span>
	<input type="radio" name="attr_tab" value="3" class="tab tab3" title="Skills and Techniques" /><span data-i18n="tab-skills">Skills</span>
	<input type="radio" name="attr_tab" value="4" class="tab tab4" /><span data-i18n="tab-combat">Combat</span>
	<input type="radio" name="attr_tab" value="5" class="tab tab5" /><span data-i18n="tab-inventory">Inventory</span>
	<input type="radio" name="attr_tab" value="6" class="tab tab6" /><span data-i18n="tab-grimoire">Grimoire</span>
	<input type="radio" name="attr_tab" value="7" class="tab tab7" /><span data-i18n="tab-updates">Updates</span>
	<input type="radio" name="attr_tab" value="0" class="tab tab0" title="Sheet Options" /><span>y</span>
	<div class="tab-br"></div>

	
	<!-- ===== ===== ===== ===== GENERAL TAB ===== ===== ===== ===== -->
	<div class="tab1">

		<div class="warning-messages">

			<input type="hidden" name="attr_show_size_modifier_strength_message" value="" />
			<input type="hidden" name="attr_size_modifier_cp_strength_adjustment" value="0" />
			<div class="message-box size-modifier-strength-message">
				<span data-i18n="size-modifier-strength-warning-message"><b style="color: red;">Warning!</b> Due to your Size Modifier <span name="attr_size"></span> you only need to spend <span name="attr_size_modifier_cp_strength_adjustment"></span> character points for Strength.</span>
			</div>

			<input type="hidden" name="attr_show_size_modifier_hit_point_message" value="" />
			<input type="hidden" name="attr_size_modifier_cp_hit_point_adjustment" value="0" />
			<div class="message-box size-modifier-hit-point-message">
				<span data-i18n="size-modifier-hit-point-warning-message"><b style="color: red;">Warning!</b> Due to your Size Modifier <span name="attr_size"></span> you only need to spend <span name="attr_size_modifier_cp_hit_point_adjustment"></span> character points for Extra Hit Points.</span>
			</div>

		</div>

		<div class="tab1-container">

		<!-- _____ _____ ATTRIBUTE BOX _____ _____ -->
		<div class="box attribute" style="float: left;">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="attributes-label">Attributes</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-modifier-label">Mod</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attributes-modifier-tooltip">
A modifier that will be applied to your <br />
attribute. All derived attributes draw their<br />
base from your  unmodified attributes.<br />
Therefore this MOD will generally only<br /> 
affect direct attribute rolls and skill rolls.
							</span>
						</span>
					</div>
					<div class="cell col2">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
				</div> <!-- .header -->
				<div class="main-attribute">
					<div class="row row-strength">
						<div class="cell col0 label">
							<div class="popup">
								<span data-i18n="abbreviation-strength">ST</span>
							</div>
							<span class="tooltip">
								<span data-i18n="attributes-strength-tooltip">
Strength 10pts/level - Unmodified <span name="attr_strength_base"></span><br />
Cost reduced by -10% (Max -80%) per SM+1 (B15)
								</span>
							</span>
						</div>
						<div class="cell col1">
							<input type="number" name="attr_strength_display" value="10" readonly="readonly" title="Macro: @{strength_display}" />
							<input type="hidden" name="attr_strength_halved" value="0" title="Macro: @{strength_halved}" />
							<input type="hidden" name="attr_strength" value="10" title="Macro: @{strength}" />
						</div>
						<div class="cell col2">
							<input type="number" name="attr_strength_mod" value="0" step="1" title="Macro: @{strength_mod}" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_strength_points" value="0" step="10" title="Macro: @{strength_points}" />
						</div>
						<div class="cell col4">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Strength Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{strength_display} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsST" />
						</div>
					</div> <!-- .row -->
					<div class="row row-dexterity">
						<div class="cell col0 label">
							<div class="popup">
								<span data-i18n="abbreviation-dexterity">DX</span>
							</div>
							<span class="tooltip">
								<span data-i18n="attributes-dexterity-tooltip">Dexterity 20pts/level - Unmodified:</span>
								<span name="attr_dexterity_base"></span>
							</span>
						</div>
						<div class="cell col1">
							<input type="number" name="attr_dexterity" value="10" readonly="readonly" title="Macro: @{dexterity}" >
						</div>
						<div class="cell col2">
							<input type="number" name="attr_dexterity_mod" value="0" step="1" title="Macro: @{dexterity_mod}" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_dexterity_points" value="0" step="20" title="Macro: @{dexterity_points}" />
						</div>
						<div class="cell col4">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Dexterity Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{dexterity} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsDX" />
						</div>
					</div> <!-- .row -->
					<div class="row row-intelligence">
						<div class="cell col0 label">
							<div class="popup">
								<span data-i18n="abbreviation-intelligence">IQ</span>
							</div>
							<span class="tooltip">
								<span data-i18n="attributes-intelligence-tooltip">Intelligence 20pts/level -Unmodified:</span> 
								<span name="attr_intelligence_base"></span>	
							</span>
						</div>
						<div class="cell col1">
							<input type="number" name="attr_intelligence" value="10" readonly="readonly" title="Macro name: intelligence" >
						</div>
						<div class="cell col2">
							<input type="number" name="attr_intelligence_mod" value="0" step="1" title="Macro name: intelligence_mod" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_intelligence_points" value="0" step="20" title="Macro name: intelligence_points" />
						</div>
						<div class="cell col4">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Intelligence Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{intelligence} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsIQ" />
						</div>
					</div> <!-- .row -->
					<div class="row row-health">
						<div class="cell col0 label">
							<div class="popup">
								<span data-i18n="abbreviation-health">HT</span>
							</div>
							<span class="tooltip">
								<span data-i18n="attributes-health-tooltip">Health 10pts/level - Unmodified:</span> 
								<span name="attr_health_base"></span>
							</span>
						</div>
						<div class="cell col1">
							<input type="number" name="attr_health" value="10" readonly="readonly" title="Macro name: health" >
						</div>
						<div class="cell col2">
							<input type="number" name="attr_health_mod" value="0" step="1" title="Macro name: health_mod" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_health_points" value="0" step="10" title="Macro name: health_points" />
						</div>
						<div class="cell col4">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Health Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{health} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsHT" />
						</div>
					</div> <!-- .row -->
				</div>
				<div class="row row-perception hr">
					<div class="cell col0 label">
					    <div class="whisper-box">
					        <div class="whisper-title">
						        <div class="popup">
									<span data-i18n="abbreviation-perception">Per</span>
								</div>
        						<span class="tooltip">
									<span data-i18n="attributes-perception-tooltip">
Perception: Based on Intelligence<br />
5pts/level<br />
Check the box to whisper perception roll to GM.<br />
Unmodified: <span name="attr_perception_base"></span>
									</span>
        						</span>    
						    </div>
						</div>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_perception" value="10" readonly="readonly" title="Macro name: perception" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_perception_mod" value="0" step="1" title="Macro name: perception_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_perception_points" value="0" step="5" title="Macro name: perception_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Perception Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{perception} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsPer" />
					</div>
				</div> <!-- .row -->
				<div class="row sub-row row-vision">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-vision">Vision</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attributes-vision-tooltip">
Visual Perception<br />
Based on Perception<br />
2pts/level<br />
Unmodified: <span name="attr_vision_base"></span>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_vision" value="10" readonly="readonly" title="Macro name: vision" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_vision_mod" value="0" step="1" title="Macro name: vision_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_vision_points" value="0" step="2" title="Macro name: vision_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Vision Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{vision} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsVision" />
					</div>
				</div> <!-- .row -->
				<div class="row sub-row row-hearing">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-hearing">Hearing</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-hearing-tooltip">
Audio Perception<br />
Based on Perception<br />
2pts/level<br />
Unmodified: <span name="attr_hearing_base"></span>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_hearing" value="10" readonly="readonly" title="Macro name: hearing" >
					</div>
					<div class="cell col2">
						<input type="number" name="attr_hearing_mod" value="0" step="1" title="Macro name: hearing_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_hearing_points" value="0" step="2" title="Macro name: hearing_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Hearing Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{hearing} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsHearing" />
					</div>
				</div> <!-- .row -->
				<div class="row sub-row row-taste-smell">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-smell">Smell</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-smell-tooltip">
Smell & Taste Perception (B35)<br />
Based on Perception<br />
2pts/level<br />
Unmodified: <span name="attr_taste_smell_base"></span>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_taste_smell" value="10" readonly="readonly" title="Macro name: taste_smell" >
					</div>
					<div class="cell col2">
						<input type="number" name="attr_taste_smell_mod" value="0" step="1" title="Macro name: taste_smell_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_taste_smell_points" value="0" step="2" title="Macro name: taste_smell_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Taste/Smell Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{taste_smell} + @{modifier}]]}} {{useCriticalPlusTen=[[0]]}}" name="roll_vsTasteSmell" />
					</div>
				</div> <!-- .row -->
				<div class="row sub-row margin-bottom row-touch">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-touch">Touch</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-touch-tooltip">
Touch Perception<br />
Based on Perception<br />
2pts/level<br />
Unmodified: <span name="attr_touch_base"></span>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_touch" value="10" readonly="readonly" title="Macro name: touch" >
					</div>
					<div class="cell col2">
						<input type="number" name="attr_touch_mod" value="0" step="1" title="Macro name: touch_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_touch_points" value="0" step="2" title="Macro name: touch_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Touch Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{touch} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsTouch" />
					</div>
				</div> <!-- .row -->
				<div class="row row-willpower hr">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-will">Will</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-will-tooltip">
Willpower<br />
Based on Intelligence<br />
5pts/level<br />
Unmodified: <span name="attr_willpower_base"></span>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_willpower" value="10" readonly="readonly" title="Macro name: willpower" >
					</div>
					<div class="cell col2">
						<input type="number" name="attr_willpower_mod" value="0" step="1" title="Macro name: willpower_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_willpower_points" value="0" step="5" title="Macro name: willpower_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Will Roll}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{willpower} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsWill" />
					</div>
				</div> <!-- .row -->
				<div class="row sub-row margin-bottom row-fear">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-fright">Fright</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-fright-tooltip">
Fright Check (B360)<br />
Based on Willpower<br />
2pts/level<br />
Unmodified: <span name="attr_fear_check_base"></span>
<br/>
See extensive list of Modifiers B360 & GURPS Horror p139-142.
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_fear_check" value="10" readonly="readonly" title="Macro name: willpower_fear_check" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_fear_check_mod" value="0" step="1" title="Macro name: willpower_fear_check_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_fear_check_points" value="0" step="2" title="Macro name: willpower_fear_points" />
					</div>
					<div class="cell col4">
					    <!-- For Fright Check, use "kl1" = Keep Lowest One. [[1d8 ( { 16 , 13 }kl1) ]] = 1d6 + 13 -->
					    <!-- see: https://wiki.roll20.net/Macros_-_Pathfinder_Examples : Calculated Dice Roll -->
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Attribute Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Fright Check}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[ ( {@{fear_check} + @{modifier}, @{fright_check_threshold}}kl1) ]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{useFrightLabel=[[1]]}} {{showNotes=[[1]]}} {{notes= **On a failure**, Roll 3d6, add your margin of failure on the Fright Check, compare result to the Fright Check Table B360.}}" name="roll_vsFearCheck" />
					</div>
				</div> <!-- .row -->
				<div class="row sub-row margin-bottom row-fear">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-threshold">Thresh</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-fright-check-threshold-tooltip">
Fright Check Threshold - Uses <strong>Rule of 14</strong> (B360). By default this value is 13.<br />
This means that a roll of 14 or more is automatically a failure.<br />
This Threshold can be modifier by the Perks of Brave (Dungeon Fantasy 11, p11) or Rule of 15 <br />
(Power Ups 2, p13).<br />
Will and/or Fright plus bonuses (like Fearlessness or Combat Reflexes) must total 14+ for this<br />
to be useful, of course!<br />
Note: A Fright Check can be used for Awe and Confusion. (Powers p84 under Terror) and the Awe and<br />
Confusion Check Table for failures. (Powers p85).
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_fright_check_threshold" value="13" readonly="readonly" title="Macro name: fright_check_threshold" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_fright_check_threshold_mod" value="0" step="1" title="Macro name: fright_check_threshold_mod" />
					</div>
					<div class="cell col3-fright-label">
						<i><span data-i18n="fright-check-label">Fright Check</span></i>
					</div>
				</div> <!-- .row -->
				<div class="row sub-row hr">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-unstun">Unstun</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-unstun-tooltip">
Recover from physical stun, based on Health.<br />
Roll at the end of your turn after Do Nothing 
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_stun_check" value="10" readonly="readonly" title="Macro name: stun_check" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_stun_check_mod" value="0" step="1" title="Macro name: stun_check_mod" />
					</div>
					<div class="cell col3">
						&nbsp;
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Condition Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Unstun Check (Recovering from Stun)}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{stun_check} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[1]]}} {{notes= **On a failure**, you remain stunned; your next maneuver must also be Do Nothing, but you get another roll at the end of that turn . . . and so on, until you recover from stun. You are also -4 to defenses, no retreat.\n<br /> **On a success**, you recover from stun and can act normally on subsequent turns. B420}}"  name="roll_vsUnstun" />
					</div>	
				</div> <!-- .row -->
				<div class="row sub-row row-condition-knockdown">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-knock-down">K Down</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-knock-down-tooltip">
Knockdown & Stunning Check, based on Health.<br />
Roll: <br />
Whenever you suffer a major wound. B420<br />
Whenever you are struck in the head (skull, face, or eye) or<br />
vitals for enough injury to cause a shock penalty,<br />
You must make an immediate HT roll to avoid knockdown and stunning. <br />
<i>>Modifiers:</i> <br />
-5 for a major wound to the face or vitals (or to the groin, on a humanoid male).<br />
-10 for a major wound to the skull or eye. <br />
+3 High Pain Threshold<br />
-4 Low Pain Threshold
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_knockdown_check" value="10" readonly="readonly" title="Macro name: knockdown_check" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_knockdown_check_mod" value="0" step="1" title="Macro name: knockdown_check_mod" />
					</div>
					<div class="cell col3">
						&nbsp;
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Condition Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Knockdown & Stunning Check - B420}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{knockdown_check} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[1]]}} {{notes= **On a failure**, you’re **Physically Stunned** (B420). You also fall prone (if you weren’t already), and if you were holding anything, you drop it. \n<br />**On a failure by 5 or more, or any critical failure**, you fall unconscious! B420. For Recovery see B423.}}"  name="roll_vsKnockdown" />
					</div>

				</div> <!-- .row -->
				<div class="row sub-row row-unconscious">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-unconscious">Unc.</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-unconscious-check-tooltip">
Unconscious Check, based on Health<br />
If HP zero or less, roll per turn to take an Active Action.<br />
-1 per full multiple of HP below zero.<br />
Hard/Easy to Subdue: Gives +/- per level to Unconscious Check<br />
Fit +1 to Unc. Check . Very Fit +2 to Unc.  Check
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_unconscious_check" value="10" readonly="readonly" title="Macro name: unconscious_check" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_unconscious_check_mod" value="0" step="1" title="Macro name: unconscious_check_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_unconscious_check_points" value="0" step="2" title="Macro name: unconscious_check_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Condition Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Unconscious Check}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{unconscious_check} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[1]]}} {{notes=** If you fail:**  you fall unconscious.  See 'Recovering from Unconsciousness' B423 . \n<br />**Success:** means you can act normally, but must roll again at the beginning of every turn to continue functioning (If your HP is 0 or less). Exception: If you choose Do Nothing on your turn, then no roll needed. B419}}" name="roll_vsUnconsciousCheck" />
					</div>
				</div> <!-- .row -->
				<div class="row sub-row margin-bottom row-death">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-death-check">Death</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-death-check-tooltip">
Death Check, based on Health.<br />
On damage taken: Immediately Roll a Death Check if you are<br />
at-1xHP or more.<br />
Roll again each time you suffer injury equal to a further<br />
multiple of your HP. (-2xHP, -3xHP, -4xHP) <br />
Immediate Death at -5xHP<br />
Hard/Easy to Kill: Gives +/- per level to a Death Check<br />
Fit +1 to Death Check . Very Fit +2 to Death Check
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_death_check" value="10" readonly="readonly" title="Macro name: death_check" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_death_check_mod" value="0" step="1" title="Macro name: death_check_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_death_check_points" value="0" step="2" title="Macro name: death_check_points" />
					</div>
					<div class="cell col4">
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Condition Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Death Check}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{unconscious_check} + @{modifier}]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[1]]}} {{notes= **On a failure of 1 or 2**, Your receive a Mortal Wound – See Mortal Wounds B423 \n<br /> **On a failure of 3+** ***YOU DIE*** – See Death B423.}}" name="roll_vsDeathCheck" />
					</div>
				</div> <!-- .row -->
				<div class="row row-basic-speed hr">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="speed-label">Speed</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-speed-tooltip">
Basic Speed<br />
Based on Health and Dexterity<br />
5pts/0.25<br />
Unmodified: <span name="attr_basic_speed_base" value="10"></span>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_basic_speed" value="" step="0.25" readonly="readonly" title="Macro name: basic_speed" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_basic_speed_mod" value="0" step="0.25" title="Macro name: basic_speed_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_basic_speed_points" value="0" step="5" title="Macro name: basic_speed_points" />
					</div>
					<div class="cell col4">
						<button title="Reminder: You must select your Token first.&#013;This will add the Token's Speed plus DX&#013;as a single number in the Turn Order." class="roll-tracker" type="roll" value="@{speed_tracker} [[[[@{selected|Basic_Speed}]]+[[(@{selected|dexterity}/100)]] &{tracker:=}]] &{template:addToTracker} {{characterName=@{character_name}}} {{skillName=Added to the Turn Order as [[ [[@{selected|Basic_Speed}]]+[[(@{selected|dexterity}/100)]] ]]}} {{basicSpeed=Speed: @{selected|Basic_Speed} &nbsp;&nbsp; DX: @{selected|dexterity}}}" name="roll_init" />
					</div>
				</div> <!-- .row -->
				<div class="row row-basic-move">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-move">Move</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-move-tooltip">
Basic Move - Based on Basic Speed - 5pts/level - Unmodified: <span name="attr_basic_move_base" value="0"></span><br />
Note: The Move score automatically adjusts for Encumbrance and for HP and/or FP loss below 1/3. (B419, B426)
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_basic_move" value="" readonly="readonly" title="Macro name: basic_move" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_basic_move_mod" value="0" step="1" title="Macro name: basic_move_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_basic_move_points" value="0" step="5" title="Macro name: basic_move_points" />
					</div>
				</div> <!-- .row -->
				<div class="row row-basic-move">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-enhanced">Enhncd</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-enhanced-ground-move-tooltip">
Enhanced ground move. 
<br />
10pts per half level. Can use up|down arrow keys
<br />
Level: <span name="attr_enhanced_ground_move_multiple" value="0"></span>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_enhanced_ground_move" value="0" readonly="readonly" title="Macro name: enhanced_ground_move" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_enhanced_ground_move_mod" value="0" step=".5" class="editable" title="Macro name: enhanced_ground_move_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_enhanced_ground_move_points" value="0" step="10" class="editable" title="Macro name: enhanced_ground_move_points" />
					</div>
				</div> <!-- .row -->
				<div class="row margin-bottom row-dodge">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-dodge">Dodge</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-dodge-tooltip">
Dodge - Based on Basic Speed - Unmodified: <span name="attr_dodge_base" value="0"></span><br />
Note: The Dodge score automatically adjusts for HP and/or FP loss below 1/3. (B419, B426)
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_dodge" value="" readonly="readonly" title="Macro name: dodge" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_dodge_mod" value="0" step="1" title="Macro name: dodge_mod" />
					</div>
				</div> <!-- .row -->
				<div class="row row-lift-st hr">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-lifting-strength">Lift ST</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-lifting-strength-tooltip">
Lifting Strength (B65)<br />
Based on Strength 3pts/level<br />
Unmodified: <input class="inline" type="number" name="attr_lift_st_base" readonly="readonly" >
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_lift_st" value="0" readonly="readonly" title="Macro name: lift_st" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_lift_st_mod" value="0" step="1" title="Macro name: lift_st_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_lift_st_points" value="0" step="3" title="Macro name: lift_st_points" />
					</div>
				</div> <!-- .row -->
				<div class="row margin-bottom row-basic-lift">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-lift">Lift</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-basic-lift-tooltip">Basic Lift Table B17, in pounds. (B15)</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_basic_lift" value="0" readonly="readonly" title="Macro name: basic_lift" />
					</div>
				</div> <!-- .row -->
				<div class="row row-strike-st hr">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-striking">Striking</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-striking-strength-tooltip">
Striking Strength<br />
Based on Strength<br />
5pts/level<br />
Unmodified: <input class="inline" type="number" name="attr_striking_st_base" readonly="readonly" />
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="number" name="attr_striking_st" value="0" readonly="readonly" title="Macro name: striking_st" />
					</div>
					<div class="cell col2">
						<input type="number" name="attr_striking_st_mod" value="0" step="1" title="Macro name: striking_st_mod" />
					</div>
					<div class="cell col3">
						<input type="number" name="attr_striking_st_points" value="0" step="5" title="Macro name: striking_st_points" />
					</div>
				</div> <!-- .row -->
				<div class="row row-thrust-damage">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-thrust">Thrust</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-thrust-damage-table">
								Thrust Damage<br />
								<div>See B16 for the complete table.</div>
								<table>
									<thead><tr><th>Strength</th><th>Thrust</th></tr></thead>
									<tbody>
										<tr><td>1</td><td>1d6-6</td></tr>
										<tr><td>2</td><td>1d6-6</td></tr>
										<tr><td>3</td><td>1d6-5</td></tr>
										<tr><td>4</td><td>1d6-5</td></tr>
										<tr><td>5</td><td>1d6-4</td></tr>
										<tr><td>6</td><td>1d6-4</td></tr>
										<tr><td>7</td><td>1d6-3</td></tr>
										<tr><td>8</td><td>1d6-3</td></tr>
										<tr><td>9</td><td>1d6-2</td></tr>
										<tr><td>10</td><td>1d6-2</td></tr>
										<tr><td>11</td><td>1d6-1</td></tr>
										<tr><td>12</td><td>1d6-1</td></tr>
										<tr><td>13</td><td>1d6</td></tr>
									</tbody>
								</table>
								<table>
									<thead><tr><th>Strength</th><th>Thrust</th></tr></thead>
									<tbody>
										<tr><td>14</td><td>1d6</td></tr>
										<tr><td>15</td><td>1d6+1</td></tr>
										<tr><td>16</td><td>1d6+1</td></tr>
										<tr><td>17</td><td>1d6+2</td></tr>
										<tr><td>18</td><td>1d6+2</td></tr>
										<tr><td>19</td><td>2d6-1</td></tr>
										<tr><td>20</td><td>2d6-1</td></tr>
										<tr><td>21</td><td>2d6</td></tr>
										<tr><td>22</td><td>2d6</td></tr>
										<tr><td>23</td><td>2d6+1</td></tr>
										<tr><td>24</td><td>2d6+1</td></tr>
										<tr><td>25</td><td>2d6+2</td></tr>
										<tr><td>26</td><td>2d6+2</td></tr>
									</tbody>
								</table>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_thrust" value="1d6-2" />
					</div>
					<div class="cell col4">
					    <input type="hidden" name="attr_thrust_damage_dice_icon" class="thrust-damage-dice-icon" value="explode" />
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Damage Roll}} {{characterName=@{character_name}}} {{skillName=Thrust Damage}} {{damageRoll=[[@{thrust}]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Crush min 0, else min 1}}" name="roll_dmgThrust" class="roll_damage" />
					</div>
				</div> <!-- .row -->
				<div class="row margin-bottom row-swing-damage">
				    <div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attribute-swing">Swing</span>
						</div>
						<span class="tooltip">
							<span data-i18n="attribute-swing-damage-table">
								Swing Damage<br />
								<div>See B16 for the complete table.</div>
								<table>
									<thead><tr><th>Strength</th><th>Swing</th></tr></thead>
									<tbody>
										<tr><td>1</td><td>1d6-5</td></tr>
										<tr><td>2</td><td>1d6-5</td></tr>
										<tr><td>3</td><td>1d6-4</td></tr>
										<tr><td>4</td><td>1d6-4</td></tr>
										<tr><td>5</td><td>1d6-3</td></tr>
										<tr><td>6</td><td>1d6-3</td></tr>
										<tr><td>7</td><td>1d6-2</td></tr>
										<tr><td>8</td><td>1d6-2</td></tr>
										<tr><td>9</td><td>1d6-1</td></tr>
										<tr><td>10</td><td>1d6</td></tr>
										<tr><td>11</td><td>1d6+1</td></tr>
										<tr><td>12</td><td>1d6+2</td></tr>
										<tr><td>13</td><td>2d6-1</td></tr>
									</tbody>
								</table>
								<table>
									<thead><tr><th>Strength</th><th>Swing</th></tr></thead>
									<tbody>
										<tr><td>14</td><td>2d6</td></tr>
										<tr><td>15</td><td>2d6+1</td></tr>
										<tr><td>16</td><td>2d6+2</td></tr>
										<tr><td>17</td><td>3d6-1</td></tr>
										<tr><td>18</td><td>3d6</td></tr>
										<tr><td>19</td><td>3d6+1</td></tr>
										<tr><td>20</td><td>3d6+2</td></tr>
										<tr><td>21</td><td>4d6-1</td></tr>
										<tr><td>22</td><td>4d6</td></tr>
										<tr><td>23</td><td>4d6+1</td></tr>
										<tr><td>24</td><td>4d6+2</td></tr>
										<tr><td>25</td><td>5d6-1</td></tr>
										<tr><td>26</td><td>5d6</td></tr>
									</tbody>
								</table>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_swing" value="1d6" />
					</div>
					<div class="cell col4">
						<input type="hidden" name="attr_swing_damage_dice_icon" class="swing-damage-dice-icon" value="explode" />
						<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Damage Roll}} {{characterName=@{character_name}}} {{skillName=Swing Damage}} {{damageRoll=[[@{swing}]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Crush min 0, else min 1}}" name="roll_dmgSwing" class="roll_damage" />
					</div>
				</div> <!-- .row -->
				
			</div> <!-- .table -->
		</div> <!-- .box .attributes -->

		<div class="tab1-column2">

			<div class="hp-lift-container" style="float: left; width:186px">

				<!-- HP, FP, ER, and Custom Pools -->
				<div class="box stats">
					<div class="table">
						<div class="header">
							<div class="cell col0">
								<span data-i18n="stats-title">Stats</span>
							</div>
							<div class="cell col1">
								<span data-i18n="value-title">Value</span>
							</div>
							<div class="cell col2">
								<span data-i18n="abbreviation-modifier-label">Mod</span>
							</div>
							<div class="cell col3">
								<span data-i18n="abbreviation-character-points-label">Pts</span>
							</div>
						</div> <!-- .header -->
						<div class="row row-hit-points">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="abbreviation-maximum-hit-points">Max HP</span>
								</div>
								<span class="tooltip">
									<span data-i18n="maximum-hit-poits-tooltip">
Hit Points - Based on Strength - 2pts/level<br />
Cost reduced by -10% per SM+1 (B15)
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_hit_points_max" value="10" readonly="readonly" title="Macro: @{hit_points_max}" />
							</div>
							<div class="cell col2">
								<input type="number" name="attr_hit_points_mod" value="0" step="1" title="Macro name: hit_points_max_mod" />
							</div>
							<div class="cell col3">
								<input type="number" name="attr_hit_points_points" value="0" step="2" title="Macro name: hit_points_max_points" />
							</div>
						</div> <!-- .row -->
						<div class="row sub-row row-current-points">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="abbreviation-current-hit-points">Current HP</span>
								</div>
								<span class="tooltip">
									<span data-i18n="current-hit-points-tooltip">
Current Hit Points<br />
When your HP is low, you take penalties. (B419)
									</span>
									<table>
										<tbody>
										<tbody>
											<tr>
												<td class="label">
													<span data-i18n="current-hit-points-reeling">Reeling: If your HP is less than</span>
												</td>
												<td><input type="text" name="attr_hp_reeling" value="4" readonly="readonly"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="current-hit-points-reeling-description">
- Halve Move and Dodge (round up) (B419)<br />
- These effects are cumulative with FP loss. See GURPS FAQ: 3.4.5.7<br />												
- Note: This sheet automatically calculates that for you and adjusts those values.
													</span>
												</td>
											</tr>
											<tr>
												<td class="label">
													<span data-i18n="current-hit-points-collapse">Verge of Collapse</span>
												</td>
												<td><input type="text" value="At 0 HP or less" readonly="readonly"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="current-hit-points-collaps-description">
- Roll every turn @{VS} HT or fall unconscious.<br />
- Your HT roll is at -1 for every 1xHP you are below 0.<br />
- If you do nothing, and don't defend, you don't have to roll.
													</span>
												</td>
											</tr>
											<tr>
												<td class="label">
													<span data-i18n="current-hit-points-verge-of-death">Verge of Death</span>
												</td>
												<td><input type="text" name="attr_hp_verge" value="-10" readonly="readonly"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="current-hit-points-verge-of-death-description">
- Roll once @{VS} HT to stay alive.<br />
- If you fail by 1 or 2 you are mortally wounded, but not dead. (B423)<br />
- Roll again every time you take injury that puts you below<br />
another multiple of your max HP.
													</span>
												</td>
											</tr>
											<tr>
												<td class="label">
													<span data-i18n="current-hit-points-death">Death</span>
												</td>
												<td><input type="text" name="attr_hp_death" value="-50" readonly="readonly"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="current-hit-points-death-description">- You are dead.</span>
												</td>
											</tr>
											<tr>
												<td class="label">
													<span data-i18n="current-hit-points-total-destruction">Total Destruction</span>
												</td>
												<td><input type="text" name="attr_hp_destruction" value="-100" readonly="readonly"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="current-hit-points-total-destruction-description">- Your body has been destroyed beyond recognition or resurrection.</span>
												</td>
											</tr>
										</tbody>
									</table>
								</span>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_hit_points" value="10" title="Macro: @{hit_points}" />
							</div>
							<div class="cell col2">
								<input type="hidden" class="hit-points-notes" name="attr_hit_points_notes" value="0" />
								<div class="hit-points-halved-dodge">
									<div class="popup">
										<b style="color:red;">½ <span data-i18n="attribute-move">Move</span></b>
									</div>
									<span class="tooltip">
										<span data-i18n="hit-points-half-move-tooltip">Move and Dodge is halved due to hit point loss. See B419.
										</span>
									</span>
								</div>
								<div class="hit-points-quartered-dodge">
									<div class="popup"><b style="color:red;">¼ <span data-i18n="attribute-move">Move</span></div>
									<span class="tooltip">
										<span data-i18n="hit-points-fatigue-quartered-move">Move and Dodge is quartered due to hit point and fatigue loss. See B419.</span>
									</span>
								</div>
							</div>
						</div> <!-- .row -->
						<div class="row row-fatigue-points">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="abbreviation-maximum-fatigue-points">Max FP</span>
								</div>
								<span class="tooltip">
									<span data-i18n="maximum-fatigue-points-tooltip">
	Fatigue Points<br />
	Based on Health<br />
	3pts/level
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_fatigue_points_max" value="10" readonly="readonly" title="Macro name: fatigue_points_max" />
							</div>
							<div class="cell col2">
								<input type="number" name="attr_fatigue_points_mod" value="0" step="1" title="Macro name: fatigue_points_mod" />
							</div>
							<div class="cell col3">
								<input type="number" name="attr_fatigue_points_points" value="0" step="3" title="Macro name: fatigue_points_points" />
							</div>
						</div> <!-- .row -->
						<div class="row sub-row row-current-points">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="abbreviation-current-fatigue-points">Current FP</span>
								</div>
								<span class="tooltip">
									<span data-i18n="current-fatigue-points-tool-tip">
Current Fatigue Points<br />
When your FP is low you take penalties. (B426)
									</span>
									<table>
										<tbody>
											<tr>
												<td class="label">
													<span data-i18n="fatigue-points-tired-label">Tired: If your FP is less than</span>
												</td>
												<td><input type="text" name="attr_fp_tired" value="4" readonly="readonly"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="fatigue-points-tired-description">
- Halve your Move, Dodge, and ST (round up) (B426)<br />
- These effects are cumulative with HP loss. See GURPS FAQ: 3.4.5.7<br />
- Note: This sheet automatically calculates that for you and adjusts<br />
those values – This does not affect ST-based quantities,<br />
such as HP and damage. (B426)
													</span>
												</td>
											</tr>
											<tr>
												<td class="label">
													<span data-i18n="verge-of-collapse-label">Verge of Collapse</span>
												</td>
												<td><input type="text" value="At 0 FP or less" disabled="disabled"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="verge-of-collapse-description">
														- If you suffer further fatigue, each FP you lose also causes 1 HP of injury. (B426)<br />
														- Roll against Will to do anything besides rest or talk.<br />
														- If you fail your Will roll, you fall unconscious.<br />
														- On a critical failure, roll @{VS} HT or suffer a heart attack.
													</span>
												</td>
											</tr>
											<tr>
												<td class="label">
													<span data-i18n="unconscious-label">Unconscious: When your FP is</span>
												</td>
												<td><input type="text" name="attr_fp_unconscious" value="-10" readonly="readonly"></td>
											</tr>
											<tr>
												<td colspan="2">
													<span data-i18n="unconscious-description">
- Immediately fall unconscious<br />
- FP can't drop any lower, but you still lose HP.<br />
- You regain consciousness at 0 FP
													</span>
												</td>
											</tr>
										</tbody>
									</table>
								</span>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_fatigue_points" value="10" title="Macro name: fatigue_points" />
							</div>
							<div class="cell col2">
								<input type="hidden" class="fatigue-points-notes" name="attr_fatigue_points_notes" value="0" />
								<div class="fatigue-points-halved-dodge">
									<div class="popup">
										<b style="color:red;">½ <span data-i18n="abbreviation-move-strength">MV/ST</span></b>
									</div>
									<span class="tooltip">
										<span data-i18n="half-move-strength-tooltip">
Move, Dodge, and ST are halved due to fatigue loss. See B426.<br />
Affects ST roll and using weapons with minimum ST.
										</span>
									</span>
								</div>
								<div class="fatigue-points-quartered-dodge">
									<div class="popup">
										<b style="color:red;">½ <span data-i18n="abbreviation-strength">ST</span></b>
									</div>
									<span class="tooltip">
										<span data-i18n="half-strength-tooltip">
ST is halved due to fatigue loss. See B426.<br />
Affects ST roll and using weapons with minimum ST.
										</span>
									</span>
								</div>
							</div>
						</div> <!-- .row -->
						<div class="row row-energy-points">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="abbreviation-maximum-energy-reserve">Max ER</span>
								</div>
								<span class="tooltip">
									<span data-i18n="maximum-energy-reserve-tooltip">
Energy Reserve<br />
See  Dungeon Fantasy 3, pg39 - Introduced<br />
See Powers, pg119 – More detailed<br />
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_energy_points_max" title="Macro name: energy_points_max" />
							</div>
							<div class="cell col2"></div>
							<div class="cell col3">
								<input type="number" name="attr_energy_points_points" value="0" step="3" title="Macro name: energy_points_points" />
							</div>
						</div> <!-- .row -->
						<div class="row sub-row row-current-points">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="abbreviation-current-energy-reserve">Current ER</span>
								</div>
								<span class="tooltip">
									<span data-i18n="current-energy-reserve-tooltip">
Current Energy Reserve<br />
See  Dungeon Fantasy 3, pg39 - Introduced<br />
See Powers, pg119 – More detailed
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_energy_points" value="0" title="Macro name: energy_points" />
							</div>
						</div> <!-- .row -->
						<div class="row hr">
							<div class="title custom-pools">
								<div class="popup">
									<span data-i18n="custom-pools-heading">Custom Pools</span>
								</div>
								<span class="tooltip">
									<span data-i18n="custom-pools-tooltip">
Add additional energy pools. Enter a name of the pool, max number points, cost in character points, and the current points of pool.<br />
Examples include:<br />
<strong>RP</strong> (Radiation Threshold Points), see After the End 1, p24. (ST + HT)/2, round down.<br />
<strong>LFP</strong> (Long Term Fatigue Points), see After the End 1, p24.
									</span>
								</span>
							</div>
							<div class="cell col0 label">
								<input type="text" name="attr_user_pool1_name" title="Macro name: user_pool1_name" />
							</div>
							<div class="cell col1">
								<input type="number" name="attr_user_pool1_max" title="Macro name: user_pool1_max" />
							</div>
							<div class="cell col2"></div>
							<div class="cell col3">
								<input type="number" name="attr_user_pool1_points" value=0 title="Macro name: user_pool1_points" />
							</div>
						</div> <!-- .row -->
						<div class="row sub-row row-current-points">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="custom-pool-current-points-label">Current</span>
								</div>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_user_pool1" value="0" title="Macro name: user_pool1" />
							</div>
						</div> <!-- .row -->
						<div class="row">
							<div class="cell col0 label">
								<input type="text" name="attr_user_pool2_name" title="Macro name: user_pool2_name" />
							</div>
							<div class="cell col1">
								<input type="number" name="attr_user_pool2_max" title="Macro name: user_pool2_max" />
							</div>
							<div class="cell col2"></div>
							<div class="cell col3">
								<input type="number" name="attr_user_pool2_points" value=0 title="Macro name: user_pool2_points" />
							</div>
						</div> <!-- .row -->
						<div class="row sub-row row-current-points padding-bottom">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="custom-pool-current-points-label">Current</span>
								</div>
							</div>
							<div class="cell col1">
								<input type="number" name="attr_user_pool2" value="0" title="Macro name: user_pool2" />
							</div>
						</div> <!-- .row -->
					</div>
				</div>
				<!-- HP, FP, ER, and Custom Pools: end -->

				<!-- _____ _____ LIFTING BOX _____ _____ -->
				<div class="box lift">
					<div class="table">
						<div class="header">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="lifting-moving-label">Lifting & Moving</span>
								</div>
								<span class="tooltip">
									<span data-i18n="lifting-moving-tooltip">For more information see B14.</span>
								</span>
							</div>
							<div class="cell col1">
								<span data-i18n="weight-label">Weight</span>
							</div>
						</div> <!-- .header -->
						<div class="row row-simple-lift">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="simple-lift-label">Simple Lift</span>
								</div>
								<span class="tooltip">
									<span data-i18n="simple-lift-heading-tooltip">
The weight the character can lift overhead<br />
with one hand in one second.
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="text" name="attr_simple_lift" value="round(@{basic_lift})" disabled="disabled" title="Macro name: simple_lift" />
							</div>
						</div> <!-- .row -->
						<div class="row row-one-handed-lift">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="one-handed-lift-label">One-Handed Lift</span>
								</div>
								<span class="tooltip">
									<span data-i18n="one-handed-lift-tooltip">
The weight the character can lift overhead<br />
with one hand in two seconds.
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="text" name="attr_one_hand_lift" value="round(2 * @{basic_lift})" disabled="disabled" title="Macro name: one_hand_lift" />
							</div>
						</div> <!-- .row -->
						<div class="row row-two-handed-lift">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="two-handed-lift-label">Two-Handed Lift</span>
								</div>
								<span class="tooltip">
									<span data-i18n="two-handed-lift-tooltip">
The weight the character can lift overhead<br />
with both hands in four seconds.
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="text" name="attr_two_hand_lift" value="round(8 * @{basic_lift})" disabled="disabled" title="Macro name: two_hand_lift" />
							</div>
						</div> <!-- .row -->
						<div class="row row-shove-knock-over">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="shove-and-knock-over-label">Shove &amp; Knock Over</span>
								</div>
								<span class="tooltip">
									<span data-i18n="shove-and-knock-over-tooltip">
The weight of an object the character can<br />
shove and knock over.
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="text" name="attr_shove_lift" value="round(12 * @{basic_lift})" disabled="disabled" title="Macro name: shove_lift" />
							</div>
						</div> <!-- .row -->
						<div class="row row-running-shove-knock-over">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="abbreviation-running-shove-knock-over">Running Shove &amp; KO</span>
								</div>
								<span class="tooltip">
									<span data-i18n="running-shove-knock-over-tooltip">
The weight of an object the character can<br />
shove and knock over with a running start.
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="text" name="attr_run_shove_lift" value="round(24 * @{basic_lift})" disabled="disabled" title="Macro name: run_shove_lift" />
							</div>
						</div> <!-- .row -->
						<div class="row row-carry-on-back">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="carry-on-back-label">Carry On Back</span>
								</div>
								<span class="tooltip">
									<span data-i18n="carry-on-back-tooltip">
The weight the character can carry slung<br />
over his/her back.
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="text" name="attr_carry_back_lift" value="round(15 * @{basic_lift})" disabled="disabled" title="Macro name: carry_back_lift" />
							</div>
						</div> <!-- .row -->
						<div class="row margin-bottom row-shift-slightly">
							<div class="cell col0 label">
								<div class="popup">
									<span data-i18n="shift-slightly-label">Shift Slightly</span>
								</div>
								<span class="tooltip">
									<span data-i18n="shift-slightly-tooltip">
The weight of an object that the character<br />
can shift slightly on a floor.
									</span>
								</span>
							</div>
							<div class="cell col1">
								<input type="text" name="attr_shift_lift" value="round(50 * @{basic_lift})" disabled="disabled" title="Macro name: shift_lift" />
							</div>
						</div> <!-- .row -->
					</div> <!-- .table -->
				</div> <!-- .box .lift -->

			</div>

			<!-- _____ _____ GENERAL NOTES BOX _____ _____ -->
			<div class="box general-notes-box">
				
				<div class="table">
					
					<div class="header">
						<div class="cell">
							<span data-i18n="notes-label">Notes</span>
						</div>
					</div>
					
					<div class="notes">
						<div class="cell-col-100">
							<textarea name="attr_general_tab_notes"></textarea>
						</div>
					</div>
				</div>
			</div><!-- box general-notes-box -->

			<div class="container-encumbrance-move-feats">

			<!-- _____ _____ ENCUMBERANCE BOX - Original author(s) misspelled this throughout the file_____ _____ -->
			<!-- Note: Many of the Move and Dodge calculations were complicated, this was to allow for a Minimum Move of 1 and a Minimum Dodge of 1 -->
				<div class="box encumberance">
					<div class="table">
						<input type="checkbox" name="attr_toggle_encumbrance" class="toggle toggle-encumbrance" />
						<div class="header">
							<div class="cell col0">
								<div class="colToggle">
									<input type="checkbox" name="attr_toggle_encumbrance" class="toggle toggle-encumbrance" title="View encumbrance table." />
									<span class="checkbox checkbox-encumbrance"></span>    
								</div>
								<span data-i18n="encumbrance-label">Encumbrance</span>
							</div>
							<div class="cell colAll">
								<span data-i18n="load-label">Load</span>
							</div>
							<div class="cell colAll">
								<div class="popup">
									<span data-i18n="attribute-move">Move</span>
								</div>
								<span class="tooltip">
									<span data-i18n="encumbrance-move-score-tooltip">
Note: The Move score automatically adjusts for Encumbrance<br />
and for HP and/or FP loss below 1/3. (B419, B426)					
									</span>
								</span>
							</div>
							<div class="cell colAll">
								<div class="popup">
									<span data-i18n="abbreviation-enhanced-move-label">ENH MOVE</span>
								</div>
								<span class="tooltip">
									<span data-i18n="enhanced-move-tooltip">Enhanced ground move.<br /><b>STEP:</b> The number in parentheses is the step distance.</span>
								</span>
							</div>
							<div class="cell colAll">
								<div class="popup">
									<span data-i18n="air-label">Air</span>
								</div>
								<span class="tooltip">
									<span data-i18n="air-tooltip">Air/Flying move.<br /><b>STEP:</b> The number in parentheses is the step distance.</span>
								</span>
							</div>
							<div class="cell colAll">
								<div class="popup">
									<span data-i18n="water-label">Water</span>
								</div>
								<span class="tooltip">
									<span data-i18n="water-tooltip">Water/Swimming move.<br /><b>STEP:</b> The number in parentheses is the step distance.</span>
								</span>
							</div>
							<div class="cell colAll">
								<div class="popup">
									<span data-i18n="attribute-dodge">Dodge</span>
								</div>
								<span class="tooltip">
									<span data-i18n="encumbrance-dodge-tooltip">
Note: The Dodge score automatically adjusts for Encumbrance<br />
and for HP and/or FP loss below 1/3. (B419, B426)					
									</span>
								</span>
							</div>
						</div>
						<div class="encumbrance-table-body">
							<div class="row row-encumberance-0">
								<div class="cell col0 label">
									<span data-i18n="encumbrance-none-0-label">None (0)</span>
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_lift_0" value="@{basic_lift}" disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_move_0" value="@{basic_move}" disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_enhanced_move_0" value="" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_air_0" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_water_0" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_dodge_0" value="@{dodge}" disabled="disabled" />
								</div>
							</div> <!-- .row -->
							<div class="row row-encumberance-1">
								<div class="cell col0 label">
									<span data-i18n="encumbrance-light-1-label">Light (1)</span>
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_lift_1" value="2 * @{basic_lift}" disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_move_1" value="[[((1 + floor((@{basic_move} * 0.8))) + abs(1 - floor((@{basic_move} * 0.8)))) / 2]]" disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_enhanced_move_1" value="" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_air_1" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_water_1" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_dodge_1" value="[[((1 + (@{dodge} - 1)) + abs(1 - (@{dodge} - 1))) / 2]]" disabled="disabled" />
								</div>
							</div> <!-- .row -->
							<div class="row row-encumberance-2">
								<div class="cell col0 label">
									<span data-i18n="encumbrance-medium-2-label">Medium (2)</span>
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_lift_2" value="floor(3 * @{basic_lift}*100)/100" disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_move_2" value="[[((1 + floor((@{basic_move} * 0.6))) + abs(1 - floor((@{basic_move} * 0.6)))) / 2]]"  disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_enhanced_move_2" value="" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_air_2" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_water_2" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_dodge_2" value="[[((1 + (@{dodge} - 2)) + abs(1 - (@{dodge} -2))) / 2]]" disabled="disabled" />
								</div>
							</div> <!-- .row -->
							<div class="row row-encumberance-3">
								<div class="cell col0 label">
									<span data-i18n="encumbrance-heavy-3-label">Heavy (3)</span>
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_lift_3" value="floor(6 * @{basic_lift}*100)/100" disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_move_3" value="[[((1 + floor((@{basic_move} * 0.4))) + abs(1 - floor((@{basic_move} * 0.4)))) / 2]]"  disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_enhanced_move_3" value="" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_air_3" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_water_3" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_dodge_3" value="[[((1 + (@{dodge} - 3)) + abs(1 - (@{dodge} -3))) / 2]]" disabled="disabled" />
								</div>
							</div> <!-- .row -->
							<div class="row row-encumberance-4">
								<div class="cell col0 label">
									<span data-i18n="encumbrance-extra-heavy-4-label">X-Heavy (4)</span>
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_lift_4" value="10 * @{basic_lift}"  disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_move_4" value="[[((1 + floor((@{basic_move} * 0.2))) + abs(1 - floor((@{basic_move} * 0.2)))) / 2]]"  disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_enhanced_move_4" value="" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_air_4" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_water_4" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_dodge_4" value="[[((1 + (@{dodge} -4)) + abs(1 - (@{dodge} - 4))) / 2]]" disabled="disabled" />
								</div>
							</div> <!-- .row -->
							<!-- Yes I realize encumbrance is spelled wrong here but the original authors misspelled it throughout the file so I did the same to stay backwards compatible. -->	
							<div class="row margin-bottom row-encumberance-MAX">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="encumbrance-maximum-load-label">MAX Load*</span>
									</div>
									<span class="tooltip">
										<span data-i18n="encumbrance-maximum-load-tooltip">
Carry on Back (B353) 15xBL. Thus, you can carry<br />
more than you can lift by yourself . . . but<br />
every second that your encumbrance is over 10xBL<br />
(that is Extra-Heavy encumbrance), you lose 1 FP.<br />
										</span>
									</span>
								</div>
			
								<div class="cell colAll">
									<input type="text" name="attr_lift_5" value="15 * @{basic_lift}"  disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_move_5" value="[[((1 + floor((@{basic_move} * 0.2))) + abs(1 - floor((@{basic_move} * 0.2)))) / 2]]"  disabled="disabled" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_enhanced_move_5" value="" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_air_5" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_water_5" value="0" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_dodge_5" value="[[((1 + (@{dodge} -4)) + abs(1 - (@{dodge} - 4))) / 2]]"disabled="disabled" />
								</div>
							</div> <!-- .row -->
						</div>
						<input type="checkbox" name="attr_toggle_turn_deceleration" class="toggle toggle-encumbrance" />
						<div class="row row-load hr">
							<div class="cell col0 current-label">
								<div class="colToggle">
									<input type="checkbox" name="attr_toggle_turn_deceleration" class="toggle toggle-encumbrance" title="View turning and deceleration." />
									<span class="checkbox checkbox-encumbrance"></span>    
								</div>
								<span data-i18n="current-label">Current</span> (<span name="attr_encumbrance_level" value=""></span>)
							</div>
							<div class="cell colAll">
								<input type="hidden" name="attr_total_weight" value="" />
								<input type="text" name="attr_total_weight_gravity" value="" readonly="readonly" title="Macro: @{total_weight_gravity}" />
							</div>
							<div class="cell colAll">
								<input type="text" name="attr_current_move" value="" readonly="readonly" title="Macro name: current_move" />
								<input type="hidden" name="attr_current_ground_step" value="1" />
							</div>
							<div class="cell colAll">
								<input type="text" name="attr_enhanced_move_current" value="0" readonly="readonly" title="Macro name: enhanced_move_current" />
							</div>
							<div class="cell colAll">
								<input type="text" name="attr_current_air" value="0" readonly="readonly" title="Macro name: current_air" />
								<input type="hidden" name="attr_current_air_step" value="1" />
							</div>
							<div class="cell colAll">
								<input type="text" name="attr_current_water" value="0" readonly="readonly" title="Macro name: current_water" />
								<input type="hidden" name="attr_current_water_step" />
							</div>
							<div class="cell colAll">
								<input type="text" name="attr_current_dodge" value="0" readonly="readonly" title="Macro name: @{current_dodge}" />
							</div>
						</div> <!-- .row -->
						
						<div class="turn-decelerate-container">
							
							<div class="row header">
								<div class="title">
									<span data-i18n="turning-and-velocity-modifiers-label">Turning and Velocity Modifiers</span>
								</div>
							</div>
							
							<div class="row">
								<div class="cell colAll label">
									<div class="popup" style="text-align:left;">
										<span data-i18n="movement-label">Movement</span>
									</div>
									<span class="tooltip">
										<span data-i18n="turning-velocity-movement-tooltip">Select movement type to determine turning radius and/or deceleration penalty.</span>
									</span>
								</div>
								<div class="cell colAll label">
									<div class="popup" style="text-align:center;">
										<span data-i18n="abbreviation-start-velocity-label">Start Vel.</span>
									</div>
									<span class="tooltip">
										<span data-i18n="start-velocity-tooltip">
Enter velocity (yards/second) for current turn.<br />
<b>Important:</b> Be sure to check your max allowed velocity based on movement type.
										</span>
									</span>
								</div>
								<div class="cell colAll label">
									<div class="popup" style="text-align:center;">
										<span data-i18n="change-in-velocity-label">Change</span>
									</div>
									<span class="tooltip">
										<span data-i18n="change-in-velocity-tooltip">Amount to accelerate or decelerate for the turn.</span>
									</span>
								</div>
								<div class="cell colAll label">
									<div class="popup" style="text-align:center;">
										<span data-i18n="abbreviation-final-velocity-label">Final Vel.</span>
									</div>
									<span class="tooltip">
										<span data-i18n="final-velocity-tooltip">
Final velocity. Current Velocity - Deceleration.<br />
The final velocity is how you start the turn and is used to<br />
calculate the deceleration penalty, turn radius, and tight turn penalty.
										</span>
									</span>
								</div>
								<div class="cell colAll label">
									<div class="popup" style="text-align:center;">
										<span data-i18n="abbreviation-deceleration-penalty-label">Decel. Pen.</span>
									</div>
									<span class="tooltip">
										<span data-i18n="deceleration-penalty-tooltip">
Deceleration Skill penalty to DX roll or operation skill.<br />
<i>Example:</i> Moving 12/second, need to slow to 5/second, deceleration = 12 - 5 = 7.<br /> 
Can safely decelerate up to base move, no roll needed.<br />
If over safe deceleration, then make DX+3. If in vehicle, use operation skill + handling statistic.<br />
Apply the appropriate skill penalty from the input forms to the right.<br />
<b>How it works:</b> -1 per two full yards/second beyond Basic Move by which you cut your speed.<br />
<b>NOTE:</b> make an additional roll if you're also turning.<br />
<b>Example:</b> Car with move 3/57 traveling at 16 yards/second, needs to decelerate to 6 yards/second.<br />
Driving Skill: 12, Handling: 0.<br />
Total Deceleration = 16 - 6 = 10.<br />
Can safely decelerate to 16 - 3 (base move) = 13.<br />
Penalty = 13 - 6 (goal speed) / 2 = -3.<br />
Making Driving Skill 12 - 3 to succeed.<br />
see B395.
										</span>
									</span>
								</div>
								<div class="cell colAll label">
									<div class="popup" style="text-align:center;">
										<span data-i18n="turn-radius-label">Turn Radius</span>
									</div>
									<span class="tooltip">
										<span data-i18n="turn-radius-tooltip">
Turn Radius. Minimum number of hexes to move before making a 60° facing change.<br />
Turn Radius = (Final Velocity / Base Move Score) rounded down.<br />
Example: Super Run = 6/24. Final Velocity = 18. Turn Radius = 18/6 = 3.<br />
See B394.
										</span>
									</span>
								</div>
								<div class="cell colAll label">
									<div class="popup" style="text-align:center;">
										<span data-i18n="tight-turn-label">Tight Turn</span>
									</div>
									<span class="tooltip">
										<span data-i18n="tight-turn-tooltip">
Tight Turn Skill Penalty. Allows you to make an additional facing change.<br />
120° facing change instead of 60°.<br />
Penalty = -1 per full increment of base move which your velocity exceeds your Basic Move.<br />
See B395.
										</span>
									</span>
								</div>
							</div> <!-- end row-->
							
							<div class="row">
								<div class="cell colAll">
									<select name="attr_turning_move_type" title="Field name: turning_move_type">
										<option value="Select"><span data-i18n="option-select">Select</span></option>
										<option value="Ground"><span data-i18n="option-ground">Ground</span></option>
										<option value="Air"><span data-i18n="option-air">Air</span></option>
										<option value="Water"><span data-i18n="option-water">Water</span></option>
									</select>
								</div>
								<div class="cell colAll">
									<input type="number" step="1" name="attr_start_velocity" value="0" title="Macro name: start_velocity" />
								</div>
								<div class="cell colAll">
									<input type="number" step="1" name="attr_change_velocity" value="0" title="Macro name: change_velocity" />
								</div>
								<div class="cell colAll">
								<input type="text" name="attr_final_velocity" value="0" title="Macro name: final_velocity" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_deceleration_penalty" value="0" title="Macro name: deceleration_penalty" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_turn_radius" value="0" title="Macro name: turn_radius" readonly="readonly" />
								</div>
								<div class="cell colAll">
									<input type="text" name="attr_tight_turn_penalty" value="0" title="Macro name: tight_turn_penalty" readonly="readonly" />
								</div>
							</div> <!-- end row-->
							
						</div> <!-- .end turning deceleration section -->
						
					</div> <!-- .table -->
				</div><!-- box encumberance -->
				
				<!-- _____ _____ MOVEMENT FEATS _____ _____ -->		
				<div class="box movement-feats">
					<div class="table">
						<div class="header">
							<div class="title">
								<span data-i18n="movement-feats-label">Movement Feats</span>
							</div>
						</div>
					</div>
					<div class="container-feats">
						
						<!-- Flying Feat -->
						<div class="container-flying feats-child">
							<div class="row row-flight-advantage">
								<div class="column-header">
									<span data-i18n="flying-label">Flying</span>
								</div>
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="flight-label">Flight</span>
									</div>
									<div class="tooltip">
										<span data-i18n="flight-tooltip">
Check the box to add Flight (B56) to the character. <br />
This will update the Air movement column for the encumbrance table.<br />
Use the text box to enter the number of character points used for Flight
										</span>
									</div>
								</div>
								<div class="cell col1">
									<input type="checkbox" name="attr_flight_checked" value="1" class="boolean" title="Macro name: flight_checked" />
								</div>
								<div class="cell col2">
									&nbsp;
								</div>
								<div class="cell col3">
									<input type="number" name="attr_flight_points" value="0" class="editable" title="Macro name: flight_points" />
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-air-move-label">Air Mv</span>
									</div>
									<span class="tooltip">
										<span data-i18n="air-move-tooltip">
Base Air Move = Basic Speed * 2 = <input class="inline" type="number" name="attr_basic_air_move_unmodified" readonly="readonly"><br />
2pts/level, you can use up and down arrows
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" name="attr_basic_air_move" value="0" readonly="readonly" title="Macro name: basic_air_move" />
								</div>
								<div class="cell col2">
									<input type="number" name="attr_basic_air_move_mod" value="0" step="1" class="editable" title="Macro name: basic_air_move_mod" />
								</div>
								<div class="cell col3">
									<input type="number" name="attr_basic_air_move_points" value="0" step="2" class="editable" title="Macro name: basic_air_move_points" />
								</div>
							</div> <!-- .row -->
							<div class="row margin-bottom row-enhanced-air">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-enhanced">Enhncd</span>
									</div>
									<span class="tooltip">
										<span data-i18n="enhanced-air-move-tooltip">
Enhanced Air Move<br />
Modifier box: steps of .5, you can use up and down arrows.<br />
Points box: 10 points per half-level, you can use up and down arrows.<br />
Each level doubles top air move. Half-level is a multiple of 1.5.<br />
Level: <span name="attr_enhanced_air_move_level" value="0"></span>
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" name="attr_enhanced_air_move" value="0" readonly="readonly" title="Macro name: enhanced_air_move" />
								</div>
								<div class="cell col2">
									<input type="number" name="attr_enhanced_air_level" value="0" step=".5" min="0" class="editable" title="Macro name: enhanced_air_level" />
								</div>
								<div class="cell col3">
									<input type="number" name="attr_enhanced_air_move_points" value="0" step="10" min="0" class="editable" title="Macro name: enhanced_air_move_points" />
								</div>
							</div> <!-- .row -->
						</div> <!-- .container-swimming -->
						
						<!-- Swimming Feat -->
						<div class="container-swimming feats-child">
							<div class="row row-flight-advantage">
								<div class="column-header">
									<span data-i18n="swimming-label">Swimming</span>
								</div>
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-amphibious-label">Amphib</span>
									</div>
									<div class="tooltip">
										<span data-i18n="amphibious-tooltip">
Amphibious: Check the box to apply Amphibious (B40) to character<br />
This will update the swimming movement on the encumbrance table.
										</span>
									</div>
								</div>
								<div class="cell col1">
									<input type="checkbox" name="attr_amphibious_checked" value="1" class="boolean" title="Macro name: amphibious_checked" />
								</div>
								<div class="cell col2">
									&nbsp;
								</div>
								<div class="cell col3">
									<input type="number" name="attr_amphibious_points" value="0" class="editable" title="Macro name: amphibious_points" />
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-water-move-label">Wtr Mv</span>
									</div>
									<span class="tooltip">
										<span data-i18n="water-move-tooltip">
Basic Move = <input class="inline" type="number" name="attr_basic_water_move_unmodified" readonly="readonly" /><br />
Formula = Basic Move / 5 or Basic Move if amphibious.<br />
5pts/level, you can use up and down arrows.<br />
NOTE: Max +2 water move if you have swimming skill.
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" name="attr_basic_water_move" value="0" readonly="readonly" title="Macro name: basic_water_move" />
								</div>
								<div class="cell col2">
									<input type="number" name="attr_basic_water_move_mod" value="0" step="1" class="editable" title="Macro name: basic_water_move_mod" />
								</div>
								<div class="cell col3">
									<input type="number" name="attr_basic_water_move_points" value="0" step="5" class="editable" title="Macro name: basic_water_move_points" />
								</div>
							</div> <!-- .row -->
							<div class="row margin-bottom row-enhanced-water">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-enhanced">Enhncd</span>
									</div>
									<span class="tooltip">
										<span data-i18n="enhanced-water-move-tooltip">
Enhanced Water Move<br />
Modifier box: steps of .5, you can use up and down arrows.<br />
Points box: 10 points per half-level, you can use up and down arrows.<br />
Each level doubles top water move. Half-level is a multiple of 1.5.<br />
Level: <span name="attr_enhanced_water_move_level" value="0"></span>
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" name="attr_enhanced_water_move" value="0" readonly="readonly" title="Macro name: enhanced_water_move" />
								</div>
								<div class="cell col2">
									<input type="number" name="attr_enhanced_water_level" value="0" step=".5" min="0" class="editable" title="Macro name: enhanced_water_level" />
								</div>
								<div class="cell col3">
									<input type="number" name="attr_enhanced_water_move_points" value="0" step="10" min="0" class="editable" title="Macro name: enhanced_water_move_points" />
								</div>
							</div> <!-- .row -->
						</div> <!-- .container-swimming -->
						
						<!-- Jumping Feat -->
						<div class="container-jumping feats-child">
							
							<div class="row row-flight-advantage">
								<div class="column-header">
									<span data-i18n="jumping-label">Jumping</span>
								</div>
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="skill-label">Skill</span>
									</div>
									<span class="tooltip">
										<span data-i18n="jump-skill-tooltip">
Jump Skill: If entered, automatically calculates using Jump Skill/2 (rounded down)
instead of Basic Move to calculate jumping distances. B352
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="text" name="attr_jump_skill" value="" class="editable" title="Macro name: jump_skill" />
								</div>
								<div class="cell col2">
									&nbsp;
								</div>
								<div class="cell col3">
									&nbsp;
								</div>
							</div> <!-- .row -->
							<div class="row row-flight-advantage">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="gravity-label">Gravity</span>
									</div>
									<span class="tooltip">
										<span data-i18n="jump-gravity-tooltip">Affects jumping distance. See B350.</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" value="1" min="0" step=".01" name="attr_gravity" class="editable" title="Macro: @{gravity}" />
								</div>
								<div class="cell col2">
									&nbsp;
								</div>
								<div class="cell col3">
									&nbsp;
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-use-strength">Use ST</span>
									</div>
									<span class="tooltip">
										<span data-i18n="jumping-use-strength-tooltip">
Check this box if using this <strong>Optional Rule</strong> B352.<br />
If Basic Lift (<input type="text" name="attr_display_jump_basic_lift" value="@{simple_lift}" disabled="disabled" class="textInline" />) 
> body weight, use ST/4 instead of Move or Jump skill.
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="checkbox" name="attr_use_st_for_jump" value="1" class="boolean" title="Macro name: use_st_for_jump" />
								</div>
								<div class="cell col2">
									&nbsp;
								</div>
								<div class="cell col3">
									&nbsp;
								</div>
							</div> <!-- .row -->
							<div class="row row-enhanced-air">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="super-label">Super</span>
									</div>
									<span class="tooltip">
										<span data-i18n="super-jump-tooltip">
Super Jump: use this if you have the Super Jump as an Advantage. B89<br />
<strong>1st column</strong> will show your modifier based on the entries for the 2nd and 3rd columns. <br />
<strong>2nd column</strong> is the Modifier box: steps of 1, you can use the up and down arrows to change the value. <br />
<strong>3rd column</strong> is the Points box: 10points per level, you can use the up and down arrows to change the value. Each level doubles the jump distance.
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" name="attr_super_jump_level" value="0" readonly="readonly" title="Macro name: super_jump_level" />
								</div>
								<div class="cell col2">
									<input type="number" name="attr_super_jump_entered_level" value="0" step="1" min="0" class="editable" title="Macro name: super_jump_entered_level" />
								</div>
								<div class="cell col3">
									<input type="number" name="attr_super_jump_points" value="0" step="10" min="0" class="editable" title="Macro name: super_jump_points" />
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-encumbrance-label">Enc</span>
									</div>
									<span class="tooltip">
										<span data-i18n="jump-encumbrance-penalty-tooltip">
Apply encumbrance penalty. See B352<br />
1 for None, 0.8 for Light, 0.6 for Medium, 0.4 for Heavy, and 0.2 for Extra-Heavy.
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="checkbox" name="attr_jump_encumbrance" value="1" class="boolean" checked="checked" />
								</div>
								<div class="cell col2 title">&nbsp;</div>
								<div class="cell col3 title">&nbsp;</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-preparation">Prep</span>
									</div>
									<span class="tooltip">
										<span data-i18n="jump-preparation-tooltip">
Check this box if you took 2 consecutive Concentration maneuvers to prepare. <br />
Leave unchecked otherwise, in which case you will halve all jump distances. B352
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="checkbox" name="attr_jump_concentration" value="1" class="boolean" title="Macro name: jump_concentration" />
								</div>
								<div class="cell col2 title">
									<span data-i18n="feet-measurement-label">feet</span>
								</div>
								<div class="cell col3 title">
									<span data-i18n="yards-measurement-label">yards</span>
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="standing-broad-jump-label">Broad</span>
									</div>
									<span class="tooltip">
										<span data-i18n="standing-broad-jump-tooltip">
Standing Broad Jump Distance. B352<br />
<strong>1st column</strong> will either show be (2 x Stat to use) – 3 feet or your Jump Skill/2 (rounded down). <br />
<strong>2nd column</strong> shows you how many feet you may jump. <br />
<strong>3rd column</strong> shows you how many yards you jump. <br />
Formula = (2 x Stat To use) - 3 feet<br />
Stat to use: <input type="text" name="attr_standing_broad_jump_stat_to_use" value="" readonly="readonly" class="textInline width-wide" />
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="text" name="attr_broad_jump_base" value="0" readonly="readonly" title="Macro name: broad_jump_base" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_broad_jump_distance_feet" value="0" readonly="readonly" title="Macro name: broad_jump_distance_feet" />
								</div>
								<div class="cell col3">
									<input type="text" name="attr_broad_jump_distance_yards" value="0" readonly="readonly" title="Macro name: broad_jump_distance_yards" />
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="running-broad-jump-label">Run</span>
									</div>
									<span class="tooltip">
										<span data-i18n="running-broad-jump-tooltip">
Running Broad Jump Distance, under Broad Jump decryption. B352 <br />
<strong>1st column</strong> entery how may yards you ran this turn. <br />
<strong>2nd column</strong> shows you how many feet you may jump. <br />
<strong>3rd column</strong> shows you how many yard you jump. <br />
Formula = (2 x Stat To use) - 3 feet<br />
Stat to use: <input type="text" name="attr_running_broad_jump_stat_to_use" value="" readonly="readonly" class="textInline width-wide" /><br />
Max running broad jump distance is twice standing broad jump distance.
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" step="1" name="attr_running_jump_yards_moved" value="0" class="editable" title="Macro name: running_jump_yards_moved" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_running_jump_distance_feet" value="0" readonly="readonly" title="Macro name: running_jump_distance_feet" />
								</div>
								<div class="cell col3">
									<input type="text" name="attr_running_jump_distance_yards" value="0" readonly="readonly" title="Macro name: running_jump_distance_yards" />
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="high-jump-label">High</span>
									</div>
									<span class="tooltip">
										<span data-i18n="high-jump-tooltip">
High Jump Distance. B352<br />
<strong>1st column</strong> will either be (6 x Stat to use) – 10 inches or your Jump Skill/2 (rounded down). <br />
<strong>2nd column</strong> shows you how many feet you may jump. <br />
<strong>3rd column</strong> shows you how many yard you jump. <br />
Formula = (6 x Stat To use) - 10 inches<br />
Stat to use: <input type="text" name="attr_standing_high_jump_stat_to_use" value="" readonly="readonly" class="textInline width-wide" />
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="text" name="attr_high_jump_base" value="0" readonly="readonly" title="Macro name: high_jump_base" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_high_jump_distance_feet" value="0" readonly="readonly" title="Macro name: high_jump_distance_feet" />
								</div>
								<div class="cell col3">
									<input type="text" name="attr_high_jump_distance_yards" value="0" readonly="readonly" title="Macro name: high_jump_distance_yards" />
								</div>
							</div> <!-- .row -->
							<div class="row row-basic-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="run-high-jump-label">Run</span>
									</div>
									<span class="tooltip">
										<span data-i18n="running-high-jump-tooltip">
Running High Jump Distance, under High Jump. B352.<br />
<strong>1st column</strong> enter in your (6 x Stat To use) plus how may yards you ran this turn. <br />
<strong>2nd column</strong> shows how many feet you may jump straight up. <br />
<strong>3rd column</strong> shows how many yards you jump straight up. <br />
Formula = (6 x Stat To use) - 10 inches<br />
Stat to use: <input type="text" name="attr_running_high_jump_stat_to_use" value="" readonly="readonly" class="textInline width-wide" /><br />
Max running high jump distance is twice standing high jump distance.
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="number" step="1" name="attr_running_high_jump_yards_moved" value="0" class="editable" title="Macro name: running_high_jump_yards_moved" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_running_high_jump_distance_feet" value="0" readonly="readonly" title="Macro name: running_high_jump_distance_feet" />
								</div>
								<div class="cell col3">
									<input type="text" name="attr_running_high_jump_distance_yards" value="0" readonly="readonly" title="Macro name: running_high_jump_distance_yards" />
								</div>
							</div> <!-- .row -->
							<div class="row margin-bottom row-jump-move">
								<div class="cell col0 label">
									<div class="popup">
										<span data-i18n="abbreviation-jump-move-label">JMP MV</span>
									</div>
									<span class="tooltip">
										<span data-i18n="jump-move-tooltip">
Jump move. This is actually the ‘Super Jump’ value for that Advantage. See B89<br />
Greater of Broad Jump Yards / 5 OR Normal Ground Move.<br />
										</span>
									</span>
								</div>
								<div class="cell col1">
									<input type="text" name="attr_jump_move_speed" value="0" readonly="readonly" title="Macro name: jump_move_speed" />
								</div>
								<div class="cell col2">
									&nbsp;
								</div>
								<div class="cell col3">
									&nbsp;
								</div>
							</div> <!-- .row -->
							
						</div> <!-- .container-jumping -->
						
					</div>
				</div><!-- box movement-feats -->

			</div><!-- container-encumbrance-move-feats -->

		</div><!-- tab1-column2 -->

		<!-- _____ _____ POINT SUMMARY BOX _____ _____ -->
		<div class="box points" style="float: left;">
			<div class="table">
			    <input type="hidden" name="attr_toggle_unspent_points" class="toggle-unspoint-points" value="0" />
				<div class="header">
					<div class="popup">
						<span data-i18n="abbreviation-point-summary-label">Point Sum</span>
					</div>
					<span class="tooltip">
						<span data-i18n="point-summary-tooltip">
<strong>Total</strong>: Manual input: Represents total value of the<br />
PC in Character Points (spent & unspent combined).<br />
<strong>Spent</strong>: Automatic total of Spent points: <br />
Attributes + Traits + Skills + Other.<br/>
<strong>Unspent</strong>: Has the option of being Manual or<br/>
Automatic, depending on an option selected on the<br/>
Settings page entitled ‘Enter Unspent Points’.<br/>
Manual Mode (Blue color): You manually enter your<br/>
Unspent points.<br/>
Automatic mode (Black color): It calculates the<br/>
point total difference between Total and Spent.
						</span>
					</span>
				</div> <!-- .header -->

				<div class="row margin-bottom row-other">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="total-label">Total</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="point-total-tooltip">
<strong>Total</strong>: Manual input: Represents total value of the<br/>
PC in Character Points (spent and unspent combined).
							</span>
    					</span>	
					</div>
					<div class="cell col1">
						<input type="text" name="attr_total_points" value="150" title="Macro name: total_points" />
					</div>
				</div> <!-- .row -->
				<div class="row margin-bottom row-spent hr">
					<div class="cell col0 label">
						<span data-i18n="spent-label">Spent</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_point_summary" disabled="disabled" value="@{att_points} + @{languages_points} + @{tl_pts} + @{cf_points} + @{racial_points} +  @{advantages_points} + @{advantages_perks} + @{disadvantages_points} + @{disadvantages_quirks} + @{skill_points} + @{techniques_points} + @{techniques_revised_points} + @{spells_points} + @{misc_points}" title="Macro name: point_summary" />
					</div>
				</div> <!-- .row -->
				<div class="row margin-bottom row-total hr">
					<div class="cell col0 label">
						<span data-i18n="unspent-label">Unspent</span>
					</div>
					<div class="cell col1">
					    <input type="text" name="attr_point_diff" value="@{total_points} - (@{att_points} + @{languages_points} + @{tl_pts} + @{cf_points} + @{racial_points} +  @{advantages_points} + @{advantages_perks} + @{disadvantages_points} + @{disadvantages_quirks} + @{skill_points} + @{techniques_points} + @{techniques_revised_points} + @{spells_points} + @{misc_points})" disabled="disabled" title="Macro name: point_diff" />
					</div>
				</div> <!-- .row -->
				<div class="row margin-bottom row-unspent hr">
					<div class="cell col0 label unspent-points-label">
						<span data-i18n="unspent-label">Unspent</span>
					</div>
					<div class="cell col1 unspent-points">
						<input type="text" name="attr_unspent_points" value="0" title="Macro name: unspent_points" />
					</div>
				</div> <!-- .row -->
				
				<input type="hidden" class="point-summary-layout" name="attr_point_summary_layout" value="1" />
				
				<div class="row row-traits gca hr">
					<div class="cell title">
					    <div class="popup">
							<span data-i18n="gca-format-label">GCA Format</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="gca-format-tooltip">
GURPS Character Assistant (GCA) Format<br />
To change to GCS or Detailed go to options tab<br />
and change the radio button for <b>Point Summary Layout</b>
							</span>
    					</span>
    				</div>
				</div> <!-- .row -->
				
				<div class="row row-traits gcs hr">
					<div class="cell title">
					    <div class="popup">
							<span data-i18n="gcs-format-label">GCS Format</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="gcs-format-format-tooltip">
GURPS Character Sheet (GCS) format<br />
To change to GCA or Detailed go to options tab<br />
and change the radio button for <b>Point Summary Layout</b>
							</span>
    					</span>
    				</div>
				</div> <!-- .row -->
				
				<div class="row row-traits all hr">
					<div class="cell title">
					    <div class="popup">
							<span data-i18n="detailed-format-label">Detailed Format</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="detailed-format-tooltip">
To change to GCA or GCS go to options tab<br />
and change the radio button for <b>Point Summary Layout</b>
							</span>
    					</span>
    				</div>
				</div> <!-- .row -->
				
				<div class="row row-traits gcs">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="race-label">Race</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="race-point-summary-tooltip">Point Summary for Racial Traits.</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_trait_racial_points" disabled="disabled" value="@{racial_points}" title="Macro name: trait_racial_points">
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits all">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="race-label">Race</span>
						</div>
    					<span class="tooltip">
    						<span data-i18n="race-point-summary-tooltip">Point Summary for Racial Traits.</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_trait_racial_points" disabled="disabled" value="@{racial_points}" title="Macro name: trait_racial_points">
					</div>
				</div> <!-- .row -->
				
				<div class="row row-attributes">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="attributes-label">Attributes</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="points-summary-for-attributes-tooltip">
Point Summary for: <br />
ST, DX, IQ, HT,<br />
HP, FP, Energy Reserve One, Two, and Three,<br />
Per, Vision, Hearing, Smell, Touch,<br />
Will, Fright, Unconsciousness, Death,<br />
Speed, Move, Lift ST, Striking ST,<br />
Flying, Air Move, Enhanced Air Move, Super Jump
							</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_att_points" value="@{strength_points} + @{dexterity_points} + @{intelligence_points} + @{health_points} + @{perception_points} + @{vision_points} + @{hearing_points} + @{taste_smell_points} + @{touch_points} + @{willpower_points} + @{fear_check_points} + @{hit_points_points} + @{fatigue_points_points} + @{energy_points_points} + @{user_pool1_points} + @{user_pool2_points} + @{basic_speed_points} + @{basic_move_points} + @{striking_st_points} + @{lift_st_points} + @{enhanced_ground_move_points} + @{flight_points} + @{basic_air_move_points} + racial_points@{enhanced_air_move_points} + @{amphibious_points} + @{basic_water_move_points} + @{enhanced_water_move_points} + @{super_jump_points} + @{unconscious_check_points} + @{death_check_points}" disabled="disabled" title="Macro name: @{att_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits gca">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-advantages-label">Adv.</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="gca-point-summary-for-advantages-tooltip">
Point Summary for: <br />
Languages, Tech Level, Cultural Familiarities,<br />
Advantages, and Racial traits.
							</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_trait_advantages_points" disabled="disabled" value="@{languages_points} + @{tl_pts} + @{cf_points} + @{racial_points} + @{advantages_points}" title="Macro name: @{trait_advantages_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits gcs">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-advantages-label">Adv.</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="gcs-point-summary-for-advantages-tooltip">
Point Summary for: <br />
Languages, Tech Level, Cultural Familiarities,<br />
Advantages, and Perks.
							</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_trait_advantages_points_gcs" disabled="disabled" value="@{languages_points} +  @{tl_pts} +  @{cf_points} + @{advantages_points} + @{advantages_perks}" title="Macro name: @{trait_advantages_points_gcs}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits all">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-advantages-label">Adv.</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="detailed-point-summary-for-advantages-tooltip">
Point Summary for: <br />
Languages, Tech Level, Cultural Familiarities,<br />
and Advantages.
							</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_trait_advantages_points_all" disabled="disabled" value="@{languages_points} + @{tl_pts} + @{cf_points} + @{advantages_points}" title="Macro name: @{trait_advantages_points_all}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits gca">
					<div class="cell col0 label">
						<span data-i18n="perks-label">Perks</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_advantages_perks_display" disabled="disabled" value="@{advantages_perks}" title="Macro name: @{advantages_perks_display}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits all">
					<div class="cell col0 label">
						<span data-i18n="perks-label">Perks</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_advantages_perks_display" disabled="disabled" value="@{advantages_perks}" title="Macro name: @{advantages_perks_display}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-disadvantages-label">Disadv.</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="point-summary-for-disadvantages-tooltip">Point Summary for Disadvantages</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_trait_disadvantages_points" disabled="disabled" value="@{disadvantages_points}" title="Macro name: @{trait_disadvantages_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-traits">
					<div class="cell col0 label">
						<span data-i18n="quirks-label">Quirks</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_disadvantages_quirks_display" disabled="disabled" value="@{disadvantages_quirks}" title="Macro name: @{disadvantages_quirks_display}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-skills gca">
					<div class="cell col0 label">
						<span data-i18n="skills-label">Skills</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_skill_technique_points" disabled="disabled" value="@{skills_points} + @{techniques_points} + @{techniques_revised_points}" title="Macro name: @{skill_technique_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-skills gcs">
					<div class="cell col0 label">
						<span data-i18n="skills-label">Skills</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_skill_technique_points" disabled="disabled" value="@{skills_points} + @{techniques_points} + @{techniques_revised_points}" title="Macro name: @{skill_technique_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-skills all">
					<div class="cell col0 label">
						<span data-i18n="skills-label">Skills</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_skill_points" disabled="disabled" value="@{skills_points}" title="Macro name: @{skill_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-skills all">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-techniques-label">Tech.</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="point-summary-techniques-tooltip">Techniques</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_techniques_total_points" disabled="disabled" value="@{techniques_points}" title="Macro name: @{techniques_total_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-skills all">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="abbreviation-techniques-revised-label">Tech. (r)</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="point-summary-for-techniques-revised-tooltip">Techniques Revised</span>
    					</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_techniques_total_points" disabled="disabled" value="@{techniques_revised_points}" title="Macro name: @{techniques_total_points}" />
					</div>
				</div> <!-- .row -->
				<div class="row row-skills">
					<div class="cell col0 label">
						<span data-i18n="spells-label">Spells</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_spells_total_points" disabled="disabled" value="@{spells_points}" title="Macro name: @{spell_total_points}" />
					</div>
				</div> <!-- .row -->
				
				<div class="row row-other all">
					<div class="cell col0 label">
						<span data-i18n="other-label">Other</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_misc_points" value="0" title="Macro name: misc_points" />
					</div>
				</div> <!-- .row -->
				
			</div> <!-- .table -->
		</div> <!-- box points -->

		</div>
	</div> <!-- tab1 -->

    <!-- ===== ===== ===== ===== TRAITS TAB ===== ===== ===== ===== -->
	<div class="tab2">

		<!-- _____ _____ LANGUAGE BOX _____ _____ -->

		<div class="box language">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="native-language-label">Native Language</span>
					</div>
					<div class="cell col1">
						<span data-i18n="spoken-label">Spoken</span>
					</div>
					<div class="cell col2">
						<span data-i18n="written-label">Written</span>
					</div>
					<div class="cell col3">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
				</div> <!-- .header -->
				<div class="row row-native-language">
					<div class="cell col0 label">
						<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
						<input type="hidden" name="attr_native_language_idkey" />
						<input type="text" style="font-weight:bold;" name="attr_name_native_language" placeholder="-Enter Native Language here" title="Macro name: name_native_language" />
					</div>
					<div class="cell col1">
						<select name="attr_native_language_spoken" title="Macro name: @{native_language_spoken}">
							<option value="0" selected><span data-i18n="option-native">Native</span></option>
							<option value="-1"><span data-i18n="option-accented">Accented</span></option>
							<option value="-2"><span data-i18n="option-broken">Broken</span></option>
							<option value="-3"><span data-i18n="option-none">None</span></option>
						</select>
					</div>
					<div class="cell col2">
						<select name="attr_native_language_written" title="Macro name: @{native_language_written}">
							<option value="0" selected><span data-i18n="option-native">Native</span></option>
							<option value="-1"><span data-i18n="option-literate">Literate</span></option>
							<option value="-2"><span data-i18n="option-semi-literate">Semi-literate</span></option>
							<option value="-3"><span data-i18n="option-none">None</span></option>
						</select>
					</div>
					<div class="cell col3">
						<input type="text" name="attr_native_language_points" value="@{native_language_spoken} + @{native_language_written}" disabled="disabled" title="Macro name: @{native_language_points}" />
					</div>
				</div> <!-- .row -->
				<div class="header">
					<div class="cell col0">
						<span data-i18n="learned-language-label">Learned Languages</span>
					</div>
					<div class="cell col1">
						<span data-i18n="spoken-label">Spoken</span>
					</div>
					<div class="cell col2">
						<span data-i18n="written-label">Written</span>
					</div>
					<div class="cell col3">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
				</div> <!-- .header -->
				<fieldset class="repeating_languages">
					<div class="row row-stats">
						<div class="cell col0">
							<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
							<input type="hidden" name="attr_idkey" />
							<input type="text" name="attr_name" title="Macro table name: repeating_languages. Field name: name" />
						</div>
						<div class="cell col1">
							<select name="attr_spoken" title="Macro table name: repeating_languages. Field name: @{spoken}">
								<option value="3"><span data-i18n="option-native">Native</span</option>
								<option value="2"><span data-i18n="option-accented">Accented</span></option>
								<option value="1"><span data-i18n="option-broken">Broken</span></option>
								<option value="0" selected><span data-i18n="option-none">None</span></option>
							</select>
						</div>
						<div class="cell col2">
							<select name="attr_written" title="Macro table name: repeating_languages. Field name: @{written}">
								<option value="3"><span data-i18n="option-native">Native</span</option>
								<option value="2"><span data-i18n="option-literate">Literate</span></option>
								<option value="1"><span data-i18n="option-semi-literate">Semi-literate</span></option>
								<option value="0" selected><span data-i18n="option-none">None</span></option>
							</select>
						</div>
						<div class="cell col3">
							<input type="text" name="attr_points" value="@{spoken} + @{written}" disabled="disabled" title="Macro table name: repeating_languages. Field name: points" />
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_languages -->
			</div> <!-- .table -->
		</div> <!-- .box .language -->

        <!-- _____ _____ MISCELLENEOUS BOX _____ _____ -->
		<div class="box miscelleneous">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="miscellaneous-label">Miscellaneous</span>
					</div>
					<div class="cell col1">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
				</div> <!-- .header -->
				<div class="row row-tech-level">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="technology-level-label">Tech Level</span>
						</div>
						<span class="tooltip">
							<span data-i18n="technology-level-tooltip">
This is the technology level that your character is familiar with.<br />
It costs 5 points to raise this above or below the campaign's<br />
normal TL.
<div class="clearfix"></div>
<table style="text-align: left;">
	<tbody>
		<tr><td>TL0</td><td>Stone Age (Prehistory and later). </td></tr>
		<tr><td>TL1</td><td>Bronze Age (3500 B.C.+).</td></tr>
		<tr><td>TL2</td><td>Iron Age (1200 B.C.+).</td></tr>
		<tr><td>TL3</td><td>Medieval (600 A.D.+).</td></tr>
		<tr><td>TL4</td><td>Age of Sail (1450+).</td></tr>
		<tr><td>TL5</td><td>Industrial Revolution (1730+).</td></tr>
		<tr><td>TL6</td><td>Mechanized Age (1880+).</td></tr>
		<tr><td>TL7</td><td>Nuclear Age (1940+).</td></tr>
		<tr><td>TL8</td><td>Digital Age (1980+).</td></tr>
		<tr><td>TL9</td><td>Microtech Age (2025+?).</td></tr>
		<tr><td>TL10</td><td>Robotic Age (2070+?).</td></tr>
		<tr><td>TL11</td><td>Age of Exotic Matter.</td></tr>
		<tr><td>TL12+</td><td>Whatever the GM likes!</td></tr>
	</tbody>
</table>
							</span>
						</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_tl" title="Macro name: tl" />
					</div>
					<div class="cell col2">
						<input type="number" step="5" name="attr_tl_pts" value="0" title="Macro name: @{tl_pts}" />
					</div>
				</div> <!-- .row -->
			</div> <!-- .table -->
		</div> <!-- .box .miscelleneous -->

		<!-- _____ _____ CULTURE BOX _____ _____ -->

		<div class="box culture">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="cultural-familiarities-label">Cultural Familiarities</span>
					</div>
					<div class="cell col1">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
				</div> <!-- .header -->
				<fieldset class="repeating_cultures">
					<div class="row row-stats">
						<div class="cell col0">
							<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
							<input type="hidden" name="attr_idkey" />
							<input type="text" name="attr_name" title="Macro table name: repeating_cultures. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="number" name="attr_points" title="Macro table name: repeating_cultures. Field name: points" />
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_cultures -->
			</div> <!-- .table -->
		</div> <!-- .box .culture -->

		<div class="clearfix"> </div>


		<!-- _____ _____ ADVANTAGES BOX _____ _____ -->
		<!-- this box uses the identifier "traits" for backwards compatibility -->

		<div class="box traits">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="advantages-label">Advantages</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-level-label">LVL</span>
						</div>
						<span class="tooltip">
							<span data-i18n="trait-level-tooltip">Level of the trait.</span>
						</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-frequency-of-appearance-label">FOA</span>
						</div>
						<span class="tooltip">
							<span data-i18n="frequency-of-appearance-tooltip">
Frequency of Appearance<br />
<table>
	<tbody>
		<tr><td>15 or less><td></td>
		<tr><td>12 or less><td></td>
		<tr><td>9 or less><td></td>
		<tr><td>6 or less><td></td>
	</tbody>
</table>
							</span>
						</span>
					</div>
					<div class="cell col2"></div>
					<div class="cell col3">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col4">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>
				</div> <!-- .header -->
				<fieldset class="repeating_traits">
					<input type="hidden" name="attr_foa" />
					<input class="toggle" type="checkbox" title="Click to show/hide more information." name="attr_trait_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
							<input type="hidden" name="attr_idkey" />
							<input type="text" name="attr_name" title="Macro table name: repeating_traits. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="number" name="attr_trait_level" min="0" step="1" title="Macro table name: repeating_traits. field name: trait_level" />
						</div>
						<div class="cell col1">
							<input type="number" name="attr_foa" min="3" max="18" step="1" title="Macro table name: repeating_traits. Field name: foa" />
						</div>
						<div class="cell col2">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Frequency of Appearance Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{foa} + @{modifier}]]}} {{notes=@{notes}}} {{showNotes=[[@{show_notes}]]}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsAFOA" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_points" title="Macro table name: repeating_traits. Field name: points" />
						</div>
						<div class="cell col4">
							<input type="text" name="attr_ref" title="Macro table name: repeating_traits. Field name: ref" />
						</div>
					</div> <!-- .row -->
					<div class="row row-details notebox">
						<div class="cell col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_traits. Field name: notes"></textarea>
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_traits -->
			</div> <!-- .table -->
		</div> <!-- .box .traits -->


		<!-- _____ _____ PERKS BOX _____ _____ -->
		<!-- this box uses the identifier "traits" for backwards compatibility -->

		<div class="box traits perks-disadvantages">

			<!-- PERKS AREA -->
			<div class="table half-size border perks-area">

				<div class="header">
					<div class="cell col0">
						<span data-i18n="perks-label">Perks</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-frequency-of-appearance-label">FOA</span>
						</div>
						<span class="tooltip">
							<span data-i18n="frequency-of-appearance-tooltip">
Frequency of Appearance<br />
<table>
	<tbody>
		<tr><td>15 or less><td></td>
		<tr><td>12 or less><td></td>
		<tr><td>9 or less><td></td>
		<tr><td>6 or less><td></td>
	</tbody>
</table>
							</span>
						</span>
					</div>
					<div class="cell col2"></div>
					<div class="cell col3">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col4">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip tooltip-spell-ref">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>
				</div> <!-- .header -->
				<fieldset class="repeating_perks">
					<input type="hidden" name="attr_foa" />
					<input class="toggle" type="checkbox" title="Click to show/hide more information." name="attr_perks_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
							<input type="hidden" name="attr_idkey" />
							<input type="text" name="attr_name" title="Macro table name: repeating_perks. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="number" min="3" max="18" step="1" name="attr_foa" title="Macro table name: repeating_perks. Field name: foa" />
						</div>
						<div class="cell col2">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Frequency of Appearance Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{foa} + @{modifier}]]}} {{notes=@{notes}}} {{showNotes=[[@{show_notes}]]}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsAFOA" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_points" value="1" title="Macro table name: repeating_perks. Field name: points" />
						</div>
						<div class="cell col4">
							<input type="text" name="attr_ref" title="Macro table name: repeating_perks. Field name: ref" />
						</div>
					</div> <!-- .row -->
					<div class="row row-details notebox">
						<div class="cell col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_perks. Field name: notes"></textarea>
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_perks -->
			</div> <!-- .table -->
			<!-- END PERKS AREA -->
			
			<!-- QUIRKS AREA -->
			<div class="table half-size quirks-area">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="quirks-label">Quirks</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-self-control-number-label">SCN</span>
						</div>
						<span class="tooltip">
							<span data-i18n="self-control-number-tooltip">
Self-control Number OR<br />
Frequency of Appearance<br />							
<table>
	<tbody>
		<tr><td>15 or less</td></tr>
		<tr><td>12 or less</td></tr>
		<tr><td>9 or less</td></tr>
		<tr><td>6 or less</td></tr>
	</tbody>
</table>
							</span>
						</span>
					</div>
					<div class="cell col2"></div>
					<div class="cell col3">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col4">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip tooltip-spell-ref">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>	
				</div> <!-- .header -->
				<fieldset class="repeating_quirks">
					<input type="hidden" name="attr_control_rating" />
					<input class="toggle" type="checkbox" title="Click to show/hide more information." name="attr_quirks_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
							<input type="hidden" name="attr_idkey" />
							<input type="text" name="attr_name" title="Macro table name: repeating_quirks. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="number" name="attr_control_rating" title="Macro table name: repeating_quirks. Field name: control_rating" />
						</div>
						<div class="cell col2">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Self-control Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{control_rating} + @{modifier}]]}} {{notes=@{notes}}} {{showNotes=[[@{show_notes}]]}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsDSCR" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_points" value="-1" title="Macro table name: repeating_quirks. Field name: points" />
						</div>
						<div class="cell col4">
							<input type="text" name="attr_ref" title="Macro table name: repeating_quirks. Field name: ref" />
						</div>
					</div> <!-- .row -->
					<div class="row row-details notebox">
						<div class="cell col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_quirks. Field name: notes"></textarea>
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_perks -->
			</div> <!-- .table -->
			<!-- END QUIRKS AREA -->

		</div> <!-- .box .traits -->


		<!-- _____ _____ DISADVANTAGES BOX _____ _____ -->

		<div class="box disadvantages perks-disadvantages">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="disadvantages-label">Disadvantages</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-level-label">LVL</span>
						</div>
						<span class="tooltip">
							<span data-i18n="trait-level-tooltip">Level of the trait.</span>
						</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-self-control-number-label">SCN</span>
						</div>
						<span class="tooltip">
							<span data-i18n="self-control-number-tooltip">
Self-control Number OR<br />
Frequency of Appearance<br />							
<table>
	<tbody>
		<tr><td>15 or less</td></tr>
		<tr><td>12 or less</td></tr>
		<tr><td>9 or less</td></tr>
		<tr><td>6 or less</td></tr>
	</tbody>
</table>
							</span>
						</span>
					</div>
					<div class="cell col2"></div>
					<div class="cell col3">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col4">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip tooltip-spell-ref">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>	
				</div> <!-- .header -->
				<fieldset class="repeating_disadvantages">
					<input type="hidden" name="attr_control_rating" />
					<input class="toggle" type="checkbox" title="Click to show/hide more information." name="attr_disadvantage_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
							<input type="hidden" name="attr_idkey" />
							<input type="text" name="attr_name" title="Macro table name: repeating_disadvantages. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="number" min="0" step="1" name="attr_trait_level" title="Macro table name: repeating_disadvantages. Field name: trait_level" />
						</div>
						<div class="cell col1">
							<input type="number" min="0" step="1" name="attr_control_rating" title="Macro table name: repeating_disadvantages. Field name: control_rating" />
						</div>
						<div class="cell col2">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Self-control Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{control_rating} + @{modifier}]]}} {{notes=@{notes}}} {{showNotes=[[@{show_notes}]]}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsDSCR" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_points" title="Macro table name: repeating_disadvantages. Field name: points" />
						</div>
						<div class="cell col4">
							<input type="text" name="attr_ref" title="Macro table name: repeating_disadvantages. Field name: ref" />
						</div>
					</div> <!-- .row -->
					<div class="row row-details notebox">
						<div class="cell col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_disadvantages. Field name: notes"></textarea>
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_disadvantages -->
			</div> <!-- .table -->
		</div> <!-- .box .disadvantages -->

		<!-- _____ _____ RACIAL Traits BOX _____ _____ -->

		<div class="box racial">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="racial-traits-label">Racial Traits</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-level-label">LVL</span>
						</div>
						<span class="tooltip">
							<span data-i18n="trait-level-tooltip">Level of the trait.</span>
						</span>
					</div>
					<div class="cell col1">
						<div class="popup">
							<span data-i18n="abbreviation-self-control-number-label">SCN</span>
						</div>
						<span class="tooltip">
							<span data-i18n="self-control-number-tooltip">
Self-control Number OR<br />
Frequency of Appearance<br />							
<table>
	<tbody>
		<tr><td>15 or less</td></tr>
		<tr><td>12 or less</td></tr>
		<tr><td>9 or less</td></tr>
		<tr><td>6 or less</td></tr>
	</tbody>
</table>
							</span>
						</span>
					</div>
					<div class="cell col2"></div>
					<div class="cell col3">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col4">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip tooltip-spell-ref">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>
				</div> <!-- .header -->
				<div class="row">
					<div class="cell col-race">
						 <b><span data-i18n="race-label">Race</span>:</b> <input type="text" name="attr_race" title="Macro: @{race}" />
					</div>
					<div class="cell col1"></div>
					<div class="cell col1"></div>
					<div class="cell col2"></div>
					<div class="cell col3">
					    <input type="text" name="attr_trait_racial_points" disabled="disabled" value="@{racial_points}" title="Macro name: @{trait_racial_points}" />
					</div>
					<div class="cell col4">
					    <input type="text" name="attr_race_ref" title="Macro name: race_ref" />
					</div>
				</div> 
				<div class="row">
					<div class="cell col-template">
						 <b><span data-i18n="templates-label">Templates</span>:</b> <input type="text" name="attr_template_names" title="Macro: @{templates_names}" />
					</div>
					<div class="cell col1"></div>
					<div class="cell col1"></div>
					<div class="cell col2"></div>
					<div class="cell col3"></div>
					<div class="cell col4"></div>
				</div> <!-- .header -->
				<fieldset class="repeating_racial">
					<input type="hidden" name="attr_control_rating" />
					<input class="toggle" type="checkbox" title="Click to show/hide more information." name="attr_racial_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
							<input type="hidden" name="attr_idkey" />
							<input type="text" name="attr_name" title="Macro table name: repeating_racial. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="number" min="1" step="1" name="attr_trait_level" title="Macro table name: repeating_racial. Field name: trait_level" />
						</div>
						<div class="cell col1">
							<input type="number" min="1" step="1" name="attr_control_rating" title="Macro table name: repeating_racial. Field name: control_rating" />
						</div>
						<div class="cell col2">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Self-control Check}} {{activeDefense=[[0]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{control_rating} + @{modifier}]]}} {{notes=@{notes}}} {{showNotes=[[@{show_notes}]]}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsRSCR" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_points" title="Macro table name: repeating_racial. Field name: points" />
						</div>
						<div class="cell col4">
							<input type="text" name="attr_ref" title="Macro table name: repeating_racial. Field name: ref" />
						</div>
					</div> <!-- .row -->
					<div class="row row-details notebox">
						<div class="cell col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_racial. Field name: notes"></textarea>
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_racial -->
			</div> <!-- .table -->
		</div> <!-- .box .racial -->

	</div> <!-- .tab2 -->

	<!-- ===== ===== ===== ===== MISCELLANEOUS TAB ===== ===== ===== ===== -->
	<div class="tab-misc">
	    
	    <!-- _____ _____ GENERAL BIO BOX _____ _____ -->
		<div class="box general-bio">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="general-information-label">General Information</span>
					</div>
				</div> <!-- .header -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="full-name-label">Full name</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_fullname" title="Macro name: fullname" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="player-name-label">Player name</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_playername" title="Macro: @{playername}" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="nickname-label">Nickname</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_nickname" title="Macro name: nickname" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="race-label">Race</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_race" title="Macro name: race" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="gender-label">Gender</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_gender" title="Macro name: gender" />
					</div>
				</div> <!-- .row -->

				<div class="row">
					
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="size-modifier-label">Size Modifier</span>
						</div>
						<span class="tooltip">
							<span data-i18n="size-modifier-tooltip">For more information see B15, B16, <strong>B19</strong>. <b>Note:</b> use the <i>Apply</i> checkbox to use Size Modify limitations to Strength and Extra Hit Points.</span>
						</span>
					</div>
					<div class="cell col-half">
						<input type="number" name="attr_size" value="0" title="Macro name: size" />
					</div>

					<div class="cell col-apply-size-modifier label">
						<div class="popup">
							<span data-i18n="apply-label">Apply</span>
						</div>
						<span class="tooltip">
							<span data-i18n="apply-size-modifier-tooltip">If checked, character point costs for Strength and Hit Points will be modified.<br />See B15, B16, <strong>B19</strong></span>
						</span>
					</div>
					<div class="cell col-input">
						<input type="checkbox" name="attr_apply_size_modifier" value="1" title="Macro: @{apply_size_modifier}" />
					</div>

					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="reach-modifier-label">Reach Mod</span>
						</div>
						<span class="tooltip">
							<span data-i18n="reach-modifier-tooltip">Reach Modifier.<br />See Size Modifier and Reach, B402<br />When grappling, you get +1 To Hit per size modifier difference.</span>
						</span>
					</div>
					<div class="cell col-input">
						<input type="number" name="attr_reach" value="0" readonly="readonly" title="Macro name: reach" />
					</div>

					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="close-reach-label">Has <span class="emphatic">C</span> Reach</span>
						</div>
						<span class="tooltip">
							<span data-i18n="close-reach-tooltip">If checked, a reach <span class="emphatic">C</span> weapon increases to reach 1, but no other effects.<br />See Size Modifier and Reach, B402</span>
						</span>
					</div>
					<div class="cell col-input">
						<input type="checkbox" name="attr_is_close_reach" title="Macro name: is_close_reach" />
					</div>

				</div> <!-- .row -->
				
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="main-hand-label">Main Hand</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_hand" title="Macro name: hand" />
					</div>
				</div> <!-- .row -->
				<div class="row row-textarea-reactions">
					<div class="cell col0 label">
						<span data-i18n="reactions-label">Reactions</span>
					</div>
					<div class="cell col1">
					    <textarea name="attr_reactions" title="Macro name: reactions"></textarea>
					</div>
				</div> <!-- .row -->
			</div> <!-- .table -->
		</div> <!-- .box .general-bio -->
		
		<!-- _____ _____ DESCRIPTION BOX _____ _____ -->
		<div class="box bio-description">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="physical-description-label">Physical Description</span>
					</div>
				</div> <!-- .header -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="age-label">Age</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_age" title="Macro name: age" />
					</div>
				</div> <!-- .row -->

				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="height-label">Height</span>
					</div>
					<div class="cell col-half">
						<input type="text" name="attr_height" title="Macro name: height" />
					</div>
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="weight-heading">Weight</span>
						</div>
						<span class="tooltip">
							<span data-i18n="character-weight-tooltip">
Enter a <strong>Numerical Value</strong> only.<br/>
Do not enter any type of indicator like lbs, pounds, kilos, etc.<br/>
This is because the weight is added to your Inventory’s Grand Total<br/>
Weight and thus needs to be numerical.
							</span>
						</span>
					</div>
					<div class="cell col-half">
						<input type="number" name="attr_weight" title="Macro name: weight" />
					</div>
				</div> <!-- .row -->

				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="eyes-label">Eyes</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_eyes" title="Macro name: eyes" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="build-label">Build</span>
					</div>
					<div class="cell col1">
					    <input type="text" name="attr_build" title="Macro name: build" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="hair-label">Hair</span>
					</div>
					<div class="cell col1">
					    <input type="text" name="attr_hair" title="Macro name: hair" />
					</div>
				</div> <!-- .row -->
				<div class="row row-textarea">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="physical-appearance-label">Appearance</span>
						</div>
						<span class="tooltip">
							<span data-i18n="physical-appearance-tooltip">
The appearance drop-down is for reference. If 
there's a point cost, please enter your appearance and cost on
the Traits tab under Advantages or Disadvantages.
							</span>
						</span>
					</div>
					<div class="cell col1">
					    <select name="attr_appearance" title="Macro name: appearance">
							<option value="-24"><span data-i18n="option-horrific">Horrific (-6)</span></option>
							<option value="-20"><span data-i18n="option-monstrous">Monstrous (-5)</span></option>
							<option value="-16"><span data-i18n="option-hideous">Hideous (-4)</span></option>
							<option value="-8"><span data-i18n="option-ugly">Ugly (-2)</span></option>
							<option value="-4"><span data-i18n="option-unattractive">Unattractive (-1)</span></option>
							<option value="0" selected="selected"><span data-i18n="option-average">Average</span></option>
							<option value="4"><span data-i18n="option-attractive">Attractive (+1)</span></option>
							<option value="12"><span data-i18n="option-handsome-beautiful">Handsome/Beautiful (+4/2)</span></option>
							<option value="16"><span data-i18n="option-very-handsome-beautiful">Very Handsome/Beautiful (+6/2)</span></option>
							<option value="20"><span data-i18n="option-transcendent">Transcendent (+8/2)</span></option>
						</select>
					    <textarea name="attr_general_appearance" title="Macro name: appearance"></textarea>
					</div>
				</div> <!-- .row -->
				<div class="row row-textarea-features">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="tattoos-scars-etc-label">Tattoos, scars, etc.</span>
						</div>
						<span class="tooltip">
							<span data-i18n="scars-tattooe-etc-tooltip">Scars, tattoos, distinguishing marks or features.</span>
						</span>
					</div>
					<div class="cell col1 textarea-container">
					    <textarea name="attr_distinguishing_features" title="Macro name: distinguishing_features"></textarea>
					</div>
				</div> <!-- .row -->
			</div> <!-- .table -->
		</div> <!-- .box .bio-description -->
		
		<!-- _____ _____ BACKGROUND INFO BOX _____ _____ -->
		<div class="box background-info">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="background-information-label">Background Information</span>
					</div>
				</div> <!-- .header -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="birth-date-label">Birth Date</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_birth_date" title="Macro name: birth_date" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="birth-place-label">Birth Place</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_birth_place" title="Macro name: birth_place" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="status-label">Status</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_status" title="Macro name: status" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="wealth-label">Wealth</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_wealth" title="Macro name: wealth" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="income-label">Income</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_income" title="Macro name: income" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="cost-of-living">Cost of Living</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_cost_of_living" title="Macro name: cost_of_living" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="stash-money-location-label">Stash</span>
						</div>
						<span class="tooltip">
							<span data-i18n="stash-money-location-tooltip">Total available cash stashed in banks, vaults, mattresses, etc.</span> 
						</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_stash" title="Macro name: stash" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="affiliations">Affiliations</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_affiliations" value="" title="Macro name: affiliations" />
					</div>
				</div> <!-- .row -->
				<div class="row">
					<div class="cell col0 label">
						<span data-i18n="home-base-label">Home Base</span>
					</div>
					<div class="cell col1">
						<input type="text" name="attr_home_base" title="Macro name: home_base" />
					</div>
				</div> <!-- .row -->
				<div class="row row-textarea-family">
					<div class="cell col0 label">
						<span data-i18n="family-label">Family</span>
					</div>
					<div class="cell col1">
					    <textarea name="attr_family" title="Macro name: family"></textarea>
					</div>
				</div> <!-- .row -->
			</div> <!-- .table -->
		</div> <!-- .box .background-info -->
		
		<!-- _____ _____ Background history & Notes INFO BOX _____ _____ -->
		<div class="box misc-notes">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<span data-i18n="background-history-label">Background History & Notes</span>
					</div>
				</div> <!-- .header -->
				<div class="row row-textarea">
					<div class="cell col0">
					    <textarea name="attr_misc_notes" title="Macro name: misc_notes"></textarea>
					</div>
				</div> <!-- .row -->
			</div> <!-- .table -->
		</div> <!-- .box .misc-notes -->
		
		<!-- _____ _____ TRAINING INFO BOX _____ _____ -->
		<div class="box training-notes">
			<div class="table">
				<div class="header">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="training-label">Training</span>
						</div>
						<span class="tooltip">
							<span data-i18n="training-tooltip">
Training rules can be found at ‘Improvement <br />
Through Study’ B292.<br />
Advanced rules can be found in Social<br />
Engineering: Back to School.
							</span>
						</span>
					</div>
				</div> <!-- .header -->
				<div class="row row-textarea">
					<div class="cell col0">
					    <textarea name="attr_training_notes" title="Macro name: training_notes"></textarea>
					</div>
				</div> <!-- .row -->
			</div> <!-- .table -->
		</div> <!-- .box .misc-notes -->
		
	</div> <!-- .tab-misc -->

	<!-- ===== ===== ===== ===== SKILLS TAB ===== ===== ===== ===== -->
	<div class="tab3">

		<!-- _____ _____ SKILLS BOX _____ _____ -->

		<div class="box skills">
			<div class="table">
				
				<div class="header">
					<div class="cell col0">
						<div class="popup">
							<span data-i18n="skills-label">Skills</span>	
						</div>
						<span class="tooltip">
							<span data-i18n="activate-custom-roll-modifier-tooltip">To turn on the custom modifiers and button to open the <b>Roll Modifier</b> dialog box goto the <b>Sheet Options</b> tab and check off the tools you would like to user under <b>Skill Modifier Tools</b> section.</span>
						</span>	
					</div>
					<div class="cell col1"></div>
					<div class="cell col2">
						<span data-i18n="abbreviation-technology-level-label">TL</span>
					</div>
					<div class="cell col3">
						<span data-i18n="skill-level-label">Level</span>
					</div>
					<div class="cell col4">
						<span data-i18n="abbreviation-attribute-label">Attr</span>
					</div>
					<div class="cell col5">
					    <div class="popup">
							<span data-i18n="abbreviation-difficulty-label">Diff</span>
						</div>
						<span class="tooltip">
							<span data-i18n="skill-difficulty-tooltip">
WC = Wildcard Skill.<br />
PTS = 3, 6, 12, 24, 36, etc.
							</span>
						</span>
					</div>
					<div class="cell col6">
						<div class="popup">
							<span data-i18n="abbreviation-modifier-label">Mod</span>
						</div>
						<div class="tooltip tooltip-skills-ref">
							<span data-i18n="skill-modifier-tooltip">
Modifier applied to skill level.<br />
Can be a positive or a negative number.<br />
Examples include a bonus from a Talent,<br />
default from another Skill or Technique,<br />
a piece of equipment, or a Perk.
							</span>
						</div>
					</div>
					<div class="cell col7">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col8">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip tooltip-skills-ref">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>
				</div> <!-- .header -->

				<!-- attr_use_skill_modifier_tool is linked to checkbox on options sheet -->
				<input type="hidden" name="attr_use_skill_modifier_tool" value="0" />
				<div class="row roll-modifiers">
					<div class="cell label">
						<div class="popup">
							<span data-i18n="modifier-label">Modifier:</span>
						</div>
						<div class="tooltip">
							<span data-i18n="modifier-dialog-tooltip">Enter a modifier to apply to any rolls on the this table.<br />Use the pencil/paper icon to select modifiers.<br /><b>NOTE:</b> Changing the modifier or check status of <i>Max skill of 9</i> will clear modifiers used by dialog box.</span>
						</div>
					</div>
					<div class="cell number-input">
						<input type="number" value="0" step="1" name="attr_skill_roll_modifier" />
						<input type="hidden" value="" name="attr_skill_roll_modifier_summary" />
						<input type="hidden" value="" name="attr_skill_roll_trait_summary" />
						<input type="hidden" value="" name="attr_skill_roll_hit_location" />
						<input type="hidden" value="" name="attr_skill_roll_maneuver" />
						<input type="hidden" value="" name="attr_skill_roll_allout_attack" />
					</div>
					<div class="cell">
						<button type="action" name="act_show_roll_modifiers_for_skill" class="btn" title="Select Skill Modifiers"><span data-i18n="select-skill-modifiers-button">Select Skill Modifiers</span></button>
					</div>
					<div class="cell cell-popup">
						<div>
							<input type="checkbox" name="attr_skill_roll_max_nine" value="1" title="Macro: @{skill_roll_max_nine}" />
							<input type="hidden" name="attr_skill_roll_max_nine_value" value="100" />
						</div>
						<div>
							<div class="popup">
								<span data-i18n="max-skill-9-label">Max skill of 9</span>
							</div>
							<div class="tooltip max-skill-9">
								<span data-i18n="max-skill-9-tooltip">The effective skill cannot exceed 9.</span>
							</div>
						</div>
					</div>
					<div class="cell cell-popup" style="margin-left:5px;">
						<div>
							<input type="checkbox" name="attr_skill_roll_apply_encumbrance" value="1" title="Macro: @{skill_roll_apply_encumbrance}" />
						</div>
						<div>
							<div class="popup">
								<span data-i18n="encumbrance-label">Encumbrance</span>
							</div>
							<div class="tooltip max-skill-9">
								<span data-i18n="apply-encumbrance-tooltip">Apply encumbrance penalty.</span>
								<b style="color:red;"><span name="attr_encumbrance_level"></span></b>
							</div>
						</div>
					</div>
					<div class="cell">
						<button type="action" name="act_skill_roll_reset" class="btn tool-modifier-reset" title="Reset Skill Modifiers"><span data-i18n="reset-label">Reset</span></button>
					</div>
					<div class="cell">
						<div class="summary-group">
							<div class="icon"><span data-i18n="notes-label">Notes</span></div>
							<div class="summary">
								<div class="roll-traits">
									<b>Traits:</b>
									<div>
										<span name="attr_skill_roll_trait_summary"></span>
									</div>
								</div>
								<div class="roll-summary">
									<b>Summary:</b>
									<div>
										<span name="attr_skill_roll_modifier_summary"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<fieldset class="repeating_skills">
				    <input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight" />
					<input class="toggle toggle-notes" type="checkbox" title="Click to show/hide more information." name="attr_skill_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<input type="text" name="attr_name" title="Macro table name: repeating_skills. Field name: name" />
						</div>
						<div class="cell col1">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Skill Roll}} {{activeDefense=[[0]]}} {{isSkillRoll=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{level} + @{modifier} + @{skill_roll_modifier}, @{skill_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_skill_modifier_tool}]]}} {{maxNine=[[@{skill_roll_max_nine}]]}} {{rollModifier=[[@{skill_roll_modifier}]]}} {{rollModifierSummary=@{skill_roll_modifier_summary}}} {{rollTraitSummary=@{skill_roll_trait_summary}}} {{notes=@{notes}}} {{showNotes=[[@{show_notes}]]}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{customSuccessNote=@{skill_success_note}}} {{customCriticalSuccessNote=@{skill_critical_success_note}}} {{customFailNote=@{skill_fail_note}}} {{customCriticalFailNote=@{skill_critical_fail_note}}} {{noteBoxOneShow=@{show_skill_mod_notes}}} {{noteBoxOneLabel=Skill Modifiers}} {{noteBoxOneContent=@{skill_mod_description_notes}}}" name="roll_vsSL" />
						</div>
						<div class="cell col2">
							<input type="text" name="attr_tl" title="Macro table name: repeating_skills. Field name: tl" />
						</div>
						<div class="cell col3">
						    <input type="hidden" name="attr_level_mirror" value="0" /> 
							<input type="text" name="attr_level" title="Macro table name: repeating_skills. Field name: level" disabled="disabled" value="@{base} + @{difficulty} + @{bonus} + (floor(((@{wildcard_skill_points}*@{use_wildcard_points} + @{points}*@{use_normal_points}) * 0.25) + 2) * ceil( ( ( (@{wildcard_skill_points}*@{use_wildcard_points} + @{points}*@{use_normal_points}) - 2 ) + abs( (@{wildcard_skill_points}*@{use_wildcard_points} + @{points}*@{use_normal_points}) - 2) ) / 256 ) + (@{wildcard_skill_points}*@{use_wildcard_points} + @{points}*@{use_normal_points}) * abs( ceil( ( ( (@{wildcard_skill_points}*@{use_wildcard_points} + @{points}*@{use_normal_points}) - 2 ) + abs( (@{wildcard_skill_points}*@{use_wildcard_points} + @{points}*@{use_normal_points}) - 2) ) / 256 ) - 1 ))"/>
						</div>
						<div class="cell col4">
							<select name="attr_base" title="Macro table name: repeating_skills. Field name: base">
								<option value="@{strength}"><span data-i18n="abbreviation-option-strength">ST</span></option>
								<option value="@{dexterity}" selected="selected"><span data-i18n="abbreviation-option-dexterity">DX</span></option>
								<option value="@{intelligence}"><span data-i18n="abbreviation-option-intelligence">IQ</span></option>
								<option value="@{health}"><span data-i18n="abbreviation-option-health">HT</span></option>
								<option value="@{willpower}"><span data-i18n="abbreviation-option-will">Will</span></option>
								<option value="@{perception}"><span data-i18n="abbreviation-option-perception">Per</span></option>
								<option value="10">10</option>
							</select>
						</div>
						<div class="cell col5">
							<select name="attr_difficulty" title="Macro table name: repeating_skills. Field name: difficulty">
								<option value="-1"><span data-i18n="abbreviation-option-easy">E</span></option>
								<option value="-2" selected="selected"><span data-i18n="abbreviation-option-average">A</span></option>
								<option value="-3"><span data-i18n="abbreviation-option-hard">H</span></option>
								<option value="-4"><span data-i18n="abbreviation-option-very-hard">VH</span></option>
								<option value="-5 + 1"><span data-i18n="abbreviation-option-wildcard">WC</span></option>
							</select>
						</div>
						<div class="cell col6">
							<input type="number" name="attr_bonus" value="0" title="Macro table name: repeating_skills. Field name: bonus" />
						</div>
						<div class="cell col7">
						    <input type="hidden" name="attr_use_wildcard_points" value="0" />
							<input type="hidden" name="attr_use_normal_points" value="1" />
							<input type="hidden" name="attr_wildcard_skill_points" value="0" />
							<input type="number" name="attr_points" value="0" />
						</div>
						<div class="cell col8">
							<input type="text" name="attr_ref" title="Macro table name: repeating_skills. Field name: ref" />
						</div>
					</div> <!-- .row -->
					
					<div class="row row-details notebox">

						<div class="row-misc">
							<div class="cell label">
							    <div class="popup">
									<span data-i18n="row-id-label">Row ID:</span>
								</div>
        						<span class="tooltip">
									<span data-i18n="row-id-tooltip">
The row id can be used with macros.<br />
NOTE: Future use for linking to techniques<br />
and combat skills.<br />
Example field name: repeating_skills_[the row id]_level<br />
This example would represent the skill level on that row.
									</span>
        						</span> 
							</div>
							<div class="cell">
							    <input type="text" readonly="readonly" name="attr_row_id" value="" />
							</div>
							<div class="cell label">
								<span data-i18n="abbrevation-miscellaneous-label">Misc:</span>
							</div>
							<div class="cell">
								<input type="text" name="attr_skill_misc" title="Macro table name: repeating_skills. Field name: skill_misc" />
							</div>
							<div class="cell label">
								<div class="popup">
									<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
								</div>
									<span class="tooltip">
										<span data-i18n="reason-for-modifiers-skills-tooltip">
Examples:<br />
+1 from Talent...<br />
+1 from Default Skill...<br />
+1 from Enchanted Item with...
										</span>
									</span>
							</div>
							<div class="cell">
								<input type="text" name="attr_skill_mod_notes" title="Macro table name: repeating_skills. Field name: skill_mod_notes" />
							</div>
						</div> <!-- .row -->

						<div class="col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_skills. Field name: notes"></textarea>
						</div>

						<div class="col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_skill_mod_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-skill-mod-notes-below-label">Show Skill Modifier notes (refer to the actual skill description)</span>
								</span>
						    </div>
						    <textarea name="attr_skill_mod_description_notes" title="Macro table name: repeating_skills. Field name: skill_mod_description_notes"></textarea>
						</div>

						<div class="header">
							<div class="popup">
								<span data-i18n="notes-label">Notes</span>
							</div>
							<span class="tooltip">
								<span data-i18n="custom-success-fail-notes-tooltip">
Success, critical success, fail, and critical fail<br />
notes will be added to roll results.<br />
You can add macros to these notes.<br />
The width of these note boxes are set to help you<br />
visualize what it will look like in chat.
								</span>
							</span>
						</div>
						
						<div class="rolltable-result-notes">
						    
						    <div class="note-input">
						        <div class="note-title">
    						        <span data-i18n="success-note-label">Success Note:</span>
    						    </div>
						        <textarea name="attr_skill_success_note" title="Macro table name: repeating_skills. Field name: skill_success_note"></textarea>
						    </div>
						    
						    <div class="note-input">
						        <div class="note-title"><span data-i18n="critical-success-note-label">Critical Success Note:</span></div>
						        <textarea name="attr_skill_critical_success_note" title="Macro table name: repeating_skills. Field name: skill_critical_success_note"></textarea>
						    </div>
						</div>
						
						<div class="rolltable-result-notes">
						    
						    <div class="note-input">
						        <div class="note-title"><div data-i18n="fail-note-label">Fail Note:</div></div>
						        <textarea name="attr_skill_fail_note" title="Macro table name: repeating_skills. Field name: skill_fail_note"></textarea>
						    </div>
						    
						    <div class="note-input">
						        <div class="note-title"><span data-i18n="critical-fail-note-label">Critical Fail Note:</span></div>
						        <textarea name="attr_skill_critical_fail_note" title="Macro table name: repeating_skills. Field name: skill_critical_fail_note"></textarea>
						    </div>
						    
						</div>
						
					</div> <!-- .row -->
					
				</fieldset> <!-- .repeating_skills -->
			</div> <!-- .table -->
		</div> <!-- .box .skills -->


		<!-- _____ _____ TECHNIQUES BOX _____ _____ -->

		<input type="hidden" class="box-techniques-old" name="attr_show_old_techniques" value="0" />
		<div class="box techniques">
			<div class="table">
				<div class="header">
					<div class="cell col0 label">
						<div class="popup">
							<span data-i18n="techniques-legacy-label">TECHNIQUES (LEGACY).</span>
						</div>
    					<span class="tooltip">
							<span data-i18n="techniques-legacy-tooltip">
<b>New Optional Feature Available.</b><br /> 
A revised techniques table is available by setting the options on the character sheet.<br />
This revised techniques is not final, we'll make adjustments based upon feedback.<br />
<b>New Legacy and Revised Technique Tables.</b> Options to show/hide the Legacy<br />
Techniques table and the new Revised Techniques table.<br />
Show both tables if you want to transfer your current techniques to the new table.<br />
If old technique table has no rows, then hide old table, show new table.<br />
							</span>
    					</span>
					</div>					
					<div class="cell col1">
						<span data-i18n="parent-label">Parent</span>
					</div>
					<div class="cell col2">
						<span data-i18n="abbreviation-minimum-label">Min</span>
					</div>
					<div class="cell col3">
						<span data-i18n="abbreviation-maximum-label">Max</span>
					</div>
					<div class="cell col4">
						<span data-i18n="skill-level-label">Level</span>
					</div>
					<div class="cell col5">
						<span data-i18n="cost-label">Cost</span>
					</div>
					<div class="cell col6">
						<span data-i18n="abbreviation-modifier-label">Mod</span>
					</div>
					<div class="cell col7">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col8">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>
				</div> <!-- .header -->
				<fieldset class="repeating_techniques">
					<input class="toggle" type="checkbox" title="Click to show/hide more information." name="attr_technique_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<input type="text" name="attr_name" title="Macro table name: repeating_techniques. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="text" name="attr_parent" title="Macro table name: repeating_techniques. Field name: parent" />
						</div>
						<div class="cell col2">
							<input type="number" name="attr_min" value="0" title="Macro table name: repeating_techniques. Field name: min" />
						</div>
						<div class="cell col3">
							---
						</div>
						<div class="cell col4">
							<input type="text" name="attr_level" disabled="disabled" title="Macro table name: repeating_techniques. Field name: level" value="@{min} + floor(@{points} / @{points_per_level}) + @{bonus}"/>
						</div>
						<div class="cell col5">
							<input type="number" name="attr_points_per_level" value="1" title="Macro table name: repeating_techniques. Field name: points_per_level" />
						</div>
						<div class="cell col6">
							<input type="number" name="attr_bonus" value="0" title="Macro table name: repeating_techniques. Field name: bonus" />
						</div>
						<div class="cell col7">
							<input type="number" name="attr_points" value="0" title="Macro table name: repeating_techniques. Field name: points" />
						</div>
						<div class="cell col8">
							<input type="text" name="attr_ref" title="Macro table name: repeating_techniques. Field name: ref" />
						</div>
					</div> <!-- .row -->
					<div class="row row-details notebox">
						<div class="cell col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_techniques. Field name: notes"></textarea>
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_techniques -->
			</div> <!-- .table -->
		</div> <!-- .box .techniques -->

        <!-- _____ _____ TECHNIQUES REVISED BOX _____ _____ -->

        
		<input type="hidden" class="box-techniques-new" name="attr_show_new_techniques" value="1" />
		<div class="box techniques-revised">
			<div class="table">
				<div class="header">
					<div class="cell col0">
						<div class="popup">
							<span data-i18n="techniques-revised-label">Techniques (Revised)</span></div>
						<span class="tooltip">
							<span data-i18n="activate-custom-roll-modifier-tooltip">To turn on the custom modifiers and button to open the <b>Roll Modifier</b> dialog box goto the <b>Sheet Options</b> tab and check off the tools you would like to user under <b>Skill Modifier Tools</b> section.</span>
						</span>	
					</div>
					<div class="cell col1">
						<span data-i18n="parent-label">Parent</span>
					</div>
					<div class="cell col2">
					    <div class="popup">
							<span data-i18n="base-level-label">Base</span>
						</div>
						<span class="tooltip">
							<span data-i18n="base-skill-level-tooltip">
Base skill level of technique, usually<br />
based on Parent Skill.<br />
see Techniques B229
							</span>
						</span>
					</div>
					<div class="cell col3">
					    <div class="popup">
							<span data-i18n="abbreviation-default-label">DFLT</span>
						</div>
						<span class="tooltip">
							<span data-i18n="techniques-revised-default-tooltip">
Default modifier to apply to the base skill.<br />
For example, Kicking is -2 from Brawling or Karate Skill.<br />
Enter 0 if there is no modifier.<br />
see Techniques B229
							</span>
						</span>
					</div>
					<div class="cell col4">
					    <div class="popup">
							<span data-i18n="abbreviation-maximum-label">Max</span>
						</div>
						<span class="tooltip">
							<span data-i18n="techniques-revised-maximum-modifier-tooltip">
Maximum modifier allowed for the technique.<br />
This is relative to the parent skill.<br />
For example, Kicking cannot exceed Brawling + 0<br />
or Karate + 0.<br />
see Techniques B229
							</span>
						</span>
					</div>
					<div class="cell col5">
					    <div class="popup">
							<span data-i18n="abbreviation-difficulty-label">Diff</span>
						</div>
						<span class="tooltip">
							<span data-i18n="technique-difficulty-tooltip">
Difficulty of technique.<br />
Feats with severe consequences on a failure<br />
or allow only one attempt are Hard.<br />
see Techniques B229
							</span>
						</span>
					</div>
					<div class="cell col6">
					    <div class="popup">
							<span data-i18n="abbreviation-modifier-label">Mod</span>
						</div>
						<div class="tooltip tooltip-tech-ref">
Modifier applied to skill level.<br />
Can be a positive or a negative number.<br />
Examples include a bonus from a Talent,<br />
default from another Skill or Technique,<br />
a piece of equipment, or a Perk.
						</div>    
					</div>
					<div class="cell col7">
						<span data-i18n="abbreviation-character-points-label">Pts</span>
					</div>
					<div class="cell col8">
						<span data-i18n="skill-level-label">Level</span>
					</div>
					<div class="cell col9"></div>
					<div class="cell col10">
						<div class="popup">
							<span data-i18n="abbreviation-book-reference-label">Ref</span>
						</div>
						<div class="tooltip tooltip-tech-ref">
							<span data-i18n="book-reference-tooltip">
Reference to book and page numbers.<br />
Examples:<br />
B238 = GURPS Basic, Page 238<br />
PU2:126 = Power-Ups 2. Page 126
							</span>
						</div>
					</div>
				</div> <!-- .header -->

				<!-- attr_use_technique_modifier_tool is linked to checkbox on options sheet -->
				<input type="hidden" name="attr_use_technique_modifier_tool" value="0" />
				<div class="row roll-modifiers">
					<div class="cell label">
						<div class="popup">
							<span data-i18n="modifier-label">Modifier:</span>
						</div>
						<div class="tooltip">
							<span data-i18n="modifier-dialog-tooltip">Enter a modifier to apply to any rolls on the this table.<br />Use the pencil/paper icon to select modifiers.<br /><b>NOTE:</b> Changing the modifier or check status of <i>Max skill of 9</i> will clear modifiers used by dialog box.</span>
						</div>
					</div>
					<div class="cell number-input">
						<input type="number" value="0" step="1" name="attr_technique_roll_modifier" />
						<input type="hidden" value="" name="attr_technique_roll_modifier_summary" />
						<input type="hidden" value="" name="attr_technique_roll_trait_summary" />
						<input type="hidden" value="" name="attr_technique_roll_hit_location" />
						<input type="hidden" value="" name="attr_technique_roll_maneuver" />
						<input type="hidden" value="" name="attr_technique_roll_allout_attack" />
					</div>
					<div class="cell">
						<button type="action" name="act_show_roll_modifiers_for_technique" class="btn" title="Select Skill Modifiers"><span data-i18n="select-skill-modifiers-button">Select Skill Modifiers</span></button>
					</div>
					<div class="cell cell-popup">
						<div>
							<input type="checkbox" name="attr_technique_roll_max_nine" value="1" title="Macro: @{technique_roll_max_nine}" />
							<input type="hidden" name="attr_technique_roll_max_nine_value" value="100" />
						</div>
						<div>
							<div class="popup">
								<span data-i18n="max-skill-9-label">Max skill of 9</span>
							</div>
							<div class="tooltip max-skill-9">
								<span data-i18n="max-skill-9-tooltip">The effective skill cannot exceed 9.</span>
							</div>
						</div>
					</div>
					<div class="cell cell-popup" style="margin-left:5px;">
						<div>
							<input type="checkbox" name="attr_technique_roll_apply_encumbrance" value="1" title="Macro: @{technique_roll_apply_encumbrance}" />
						</div>
						<div>
							<div class="popup">
								<span data-i18n="encumbrance-label">Encumbrance</span>
							</div>
							<div class="tooltip max-skill-9">
								<span data-i18n="apply-encumbrance-tooltip">Apply encumbrance penalty.</span>
								<b style="color:red;"><span name="attr_encumbrance_level"></span></b>
							</div>
						</div>
					</div>
					<div class="cell">
						<button type="action" name="act_technique_roll_reset" class="btn tool-modifier-reset" title="Reset Skill Modifiers"><span data-i18n="reset-label">Reset</span></button>
					</div>
					<div class="cell">
						<div class="summary-group">
							<div class="icon"><span data-i18n="notes-label">Notes</span></div>
							<div class="summary">
								<div class="roll-traits">
									<b>Traits:</b>
									<div>
										<span name="attr_technique_roll_trait_summary"></span>
									</div>
								</div>
								<div class="roll-summary">
									<b>Summary:</b>
									<div>
										<span name="attr_technique_roll_modifier_summary"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<fieldset class="repeating_techniquesrevised">
					<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight" />
					<input class="toggle toggle-notes" type="checkbox" title="Click to show/hide more information." name="attr_technique_revised_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<input type="text" name="attr_name" title="Macro table name: repeating_techniquesrevised. Field name: name" />
						</div>
						<div class="cell col1">
							<input type="text" name="attr_parent" title="Macro table name: repeating_techniquesrevised. Field name: parent" />
						</div>
						<div class="cell col2">
							<input type="number" name="attr_base_level" value="0" title="Macro table name: repeating_techniquesrevised. Field name: base_level" />
						</div>
						<div class="cell col3">
							<input type="number" name="attr_default" value="0" title="Macro table name: repeating_techniquesrevised. Field name: default" />
						</div>
						<div class="cell col4">
							<input type="number" name="attr_max_modifier" value="0" title="Macro table name: repeating_techniquesrevised. Field name: max_modifier" />
						</div>
						<div class="cell col5">
							<select name="attr_difficulty" title="Macro table name: repeating_techniquesrevised. Field name: difficulty">
								<option value="Average"><span data-i18n="option-average">Average</span></option>
								<option value="Hard"><span data-i18n="option-hard">Hard</span></option>  
							</select>
						</div>
						<div class="cell col6">
							<input type="number" name="attr_skill_modifier" value="0" title="Macro table name: repeating_techniquesrevised. Field name: skill_modifier" />
						</div>
						<div class="cell col7">
							<input type="number" name="attr_points" value="0" title="Macro table name: repeating_techniquesrevised. Field name: points" />
						</div>
						<div class="cell col8">
							<input type="hidden" name="attr_level_mirror" value="@{level}" /> 
							<input type="text" name="attr_level" readonly="readonly" title="Macro table name: repeating_techniquesrevised. Field name: level" value="10"/>
						</div>
						<div class="cell col9">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Technique Skill Roll}} {{activeDefense=[[0]]}} {{isSkillRoll=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{level} + @{modifier} + @{technique_roll_modifier}, @{technique_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_technique_modifier_tool}]]}} {{maxNine=[[@{technique_roll_max_nine}]]}} {{rollModifier=[[@{technique_roll_modifier}]]}} {{rollModifierSummary=@{technique_roll_modifier_summary}}} {{rollTraitSummary=@{technique_roll_trait_summary}}} {{notes=@{notes}}} {{showNotes=[[@{show_notes_revised}]]}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{customSuccessNote=@{skill_success_note}}} {{customCriticalSuccessNote=@{skill_critical_success_note}}} {{customFailNote=@{skill_fail_note}}} {{customCriticalFailNote=@{skill_critical_fail_note}}}" name="roll_vsSL"></button>
						</div>
						<div class="cell col10">
							<input type="text" name="attr_ref" title="Macro table name: repeating_techniquesrevised. Field name: ref" />
						</div>
					</div> <!-- .row -->
					
					<div class="row row-details notebox">
					
					    <div class="row-misc">
							<div class="cell label">
							    <div class="popup">
									<span data-i18n="row-id-label">Row ID:</span>
								</div>
        						<span class="tooltip">
									<span data-i18n="row-id-repeating-tooltip">
The row id can be used with macros.<br />
Example field name: repeating_techniquesrevised_[the row id]_level<br />
This example would represent the skill level on that row.
									</span>
        						</span> 
							</div>
							<div class="cell">
							    <input type="text" readonly="readonly" name="attr_row_id" value="" />
							</div>
							<div class="cell label">
								<span data-i18n="abbrevation-miscellaneous-label">Misc:</span>
							</div>
							<div class="cell">
								<input type="text" name="attr_skill_misc" title="Macro table name: repeating_techniquesrevised. Field name: skill_misc" />
							</div>
							<div class="cell label">
								<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
							</div>
							<div class="cell">
								<input type="text" name="attr_skill_mod_notes" title="Macro table name: repeating_techniquesrevised. Field name: skill_mod_notes" />
							</div>
						</div> <!-- .row -->
					    
						<div class="row technique-notebox">
					        <div class="cell label">
							    <div class="popup">
									<span data-i18n="link-label">Link:</span>
								</div>
        						<span class="tooltip">
									<span data-i18n="link-to-row-id-tooltip">Link this row to another row item.</span>
        						</span> 
					        </div>
							<input type="hidden" name="attr_technique_row_type" value="Skill" />
					        <div class="cell">
								<select name="attr_technique_row_type">
					                <option value="Skill"><span data-i18n="option-skill">Skill</span></option>
									<option value="Spell"><span data-i18n="option-spell">Spell</span></option>
									<option value="Technique"><span data-i18n="option-technique">Technique</span></option>
									<option value="ST"><span data-i18n="abbreviation-strength">ST</span></option>
									<option value="STRIKING"><span data-i18n="attribute-striking">Striking</span> <span data-i18n="abbreviation-strength">ST</span></option>
									<option value="DX"><span data-i18n="abbreviation-dexterity">DX</span></option>
									<option value="IQ"><span data-i18n="abbreviation-intelligence">IQ</span></option>
									<option value="WILL"><span data-i18n="will-label">WILL</span></option>
									<option value="HT"><span data-i18n="abbreviation-health">HT</span></option>
									<option value="10"><span data-i18n="abbreviation-health">10</span></option>
					            </select>
					        </div>
    					    <div class="cell col-row-id label show-hide-row-id">
    						    <div class="popup">
									<span data-i18n="row-id-label">Row ID:</span>
								</div>
        						<span class="tooltip">
									<span data-i18n="copy-paste-row-id-tooltip">
Copy/paste the Skill or Spell Row ID to link that skill to this technique.<br />
When the skill/spell is updated, the technique's parent name and base skill level<br />
will be updated.<br />
Once entered, this will change the Skill/Spell for this particular attack to match<br />
the skill/spell level of the Base Skill. Do not change this skill Level number manually.
									</span>
        						</span>	
    						</div>
    						<div class="cell col-input-medium show-hide-row-id">
    						    <input type="hidden" name="attr_technique_skill_row_id_toggle" value="0" />
								<input type="text" name="attr_technique_skill_row_id" title="Macro table name: repeating_techniquesrevised. Field name: technique_skill_row_id" />
							</div>
							<div class="cell col-wide">
								<input type="hidden" name="attr_skill" value="" />
    							<input type="hidden" name="attr_technique_skill_row_id_modifier" value="0" />
    							<input type="hidden" name="attr_technique_skill_row_id_message" value="" />
    							<b><span data-i18n="name-label">Name:</span></b><span name="attr_technique_skill_row_id_message"></span>
    							<input type="hidden" name="attr_technique_skill_row_id_level" value="" />
    							<b><span data-i18n="skill-level-label">Level</span>:</b><span name="attr_technique_skill_row_id_level"></span>
    						</div>
						</div> <!-- .row -->

						<div class="col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes_revised" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_techniquesrevised. Field name: notes" style="height: 50px"></textarea>
						</div>
					
						<div class="header">
							<div class="popup">
								<span data-i18n="notes-label">Notes</span>
							</div>
							<span class="tooltip">
								<span data-i18n="custom-success-fail-notes-tooltip">
Success, critical success, fail, and critical fail<br />
notes will be added to roll results.<br />
You can add macros to these notes.<br />
The width of these note boxes are set to help you<br />
visualize what it will look like in chat.
								</span>
							</span>
						</div>

					    <div class="rolltable-result-notes">
						    
						    <div class="note-input">
						        <div class="note-title">
    						        <span data-i18n="success-note-label">Success Note:</span>
    						    </div>
						        <textarea name="attr_skill_success_note" title="Macro table name: repeating_skills. Field name: skill_success_note"></textarea>
						    </div>
						    
						    <div class="note-input">
						        <div class="note-title"><span data-i18n="critical-success-note-label">Critical Success Note:</span></div>
						        <textarea name="attr_skill_critical_success_note" title="Macro table name: repeating_skills. Field name: skill_critical_success_note"></textarea>
						    </div>
						</div>
						
						<div class="rolltable-result-notes">
						    
						    <div class="note-input">
						        <div class="note-title">
									<div data-i18n="fail-note-label">Fail Note:</div>
								</div>
						        <textarea name="attr_skill_fail_note" title="Macro table name: repeating_skills. Field name: skill_fail_note"></textarea>
						    </div>
						    
						    <div class="note-input">
						        <div class="note-title">
									<span data-i18n="critical-fail-note-label">Critical Fail Note:</span>
								</div>
						        <textarea name="attr_skill_critical_fail_note" title="Macro table name: repeating_skills. Field name: skill_critical_fail_note"></textarea>
						    </div>
						    
						</div>
						
					</div> <!-- .row -->
					
				</fieldset> <!-- .repeating_techniques -->
			</div> <!-- .table -->
		</div> <!-- .box .techniques -->

	</div> <!-- .tab3 -->


	<!-- ===== ===== ===== ===== COMBAT TAB ===== ===== ===== ===== -->
	<div class="tab4">

		<!-- see: https://codepen.io/YozhEzhi/pen/gcLpI/ -->
		<div class="tabbed">
			
			<!-- tabs -->
			<label>
				<input type="radio" name="attr_combat_tabs" value="damage" class="tab-control" checked />
				<span data-i18n="damage-label">Damage</span>
			</label>
			<label>
				<input type="radio" name="attr_combat_tabs" value="defense" class="tab-control" />
				<span data-i18n="defense-label">Defense</span>
			</label>
			<label>
				<input type="radio" name="attr_combat_tabs" value="melee" class="tab-control" />
				<span data-i18n="melee-label">Melee</span>
			</label>
			<label>
				<input type="radio" name="attr_combat_tabs" value="ranged" class="tab-control" />
				<span data-i18n="ranged-label">Ranged</span>
			</label>
			<label>
				<input type="radio" name="attr_combat_tabs" value="tools" class="tab-control" />
				<span data-i18n="tools-label">tools</span>
			</label>

			<!-- tabbed section to display | value changes based on selected radio button -->
			<input type="hidden" name="attr_combat_tabs" value="damage" />
			<div class="tabs">

				<div class="tabbed-header">
					
					<div class="container">

						<div class="item item1">

							<div class="hit-points">

								<!-- row 1 -->
								<div class="item item1">
									<div class="popup">
										<span data-i18n="two-letter-abbreviation-size-modifier-label">SM</span>
									</div>
									<span class="tooltip">
										<span data-i18n="target-size-modifier-tooltip">Size Modifier of target. The modifier is applied AFTER location, grapple, shield, chinks in armor have been applied.</span>
									</span>
								</div>
								
								<div class="item item2">
									<div class="popup">
										<span data-i18n="abbreviation-hit-points">HP</span>
									</div>
									<span class="tooltip">
										<span data-i18n="current-hit-points-tooltip">Current Hit Points<br />When your HP is low, you take penalties. (B419)</span>
										<table>
											<tbody>
											<tbody>
												<tr>
													<td class="label">
														<span data-i18n="current-hit-points-reeling">Reeling: If your HP is less than</span>
													</td>
													<td><input type="text" name="attr_hp_reeling" value="4" readonly="readonly"></td>
												</tr>
												<tr>
													<td colspan="2">
														<span data-i18n="current-hit-points-reeling-description">
	- Halve Move and Dodge (round up) (B419)<br />
	- These effects are cumulative with FP loss. See GURPS FAQ: 3.4.5.7<br />												
	- Note: This sheet automatically calculates that for you and adjusts those values.
														</span>
													</td>
												</tr>
												<tr>
													<td class="label">
														<span data-i18n="current-hit-points-collapse">Verge of Collapse</span>
													</td>
													<td><input type="text" value="At 0 HP or less" readonly="readonly"></td>
												</tr>
												<tr>
													<td colspan="2">
														<span data-i18n="current-hit-points-collaps-description">
	- Roll every turn @{VS} HT or fall unconscious.<br />
	- Your HT roll is at -1 for every 1xHP you are below 0.<br />
	- If you do nothing, and don't defend, you don't have to roll.
														</span>
													</td>
												</tr>
												<tr>
													<td class="label">
														<span data-i18n="current-hit-points-verge-of-death">Verge of Death</span>
													</td>
													<td><input type="text" name="attr_hp_verge" value="-10" readonly="readonly"></td>
												</tr>
												<tr>
													<td colspan="2">
														<span data-i18n="current-hit-points-verge-of-death-description">
	- Roll once @{VS} HT to stay alive.<br />
	- If you fail by 1 or 2 you are mortally wounded, but not dead. (B423)<br />
	- Roll again every time you take injury that puts you below<br />
	another multiple of your max HP.
														</span>
													</td>
												</tr>
												<tr>
													<td class="label">
														<span data-i18n="current-hit-points-death">Death</span>
													</td>
													<td><input type="text" name="attr_hp_death" value="-50" readonly="readonly"></td>
												</tr>
												<tr>
													<td colspan="2">
														<span data-i18n="current-hit-points-death-description">- You are dead.</span>
													</td>
												</tr>
												<tr>
													<td class="label">
														<span data-i18n="current-hit-points-total-destruction">Total Destruction</span>
													</td>
													<td><input type="text" name="attr_hp_destruction" value="-100" readonly="readonly"></td>
												</tr>
												<tr>
													<td colspan="2">
														<span data-i18n="current-hit-points-total-destruction-description">- Your body has been destroyed beyond recognition or resurrection.</span>
													</td>
												</tr>
											</tbody>
										</table>
									</span>
								</div>

								<div class="item item3">
									<div class="popup">
										<span data-i18n="abbreviation-maximum-hit-points">Max HP</span>
									</div>
									<span class="tooltip">
										<span data-i18n="maximum-hit-poits-tooltip">Hit Points - Based on Strength - 2pts/level<br />Cost reduced by -10% per SM+1 (B15)</span>
									</span>
								</div>

								<div class="item item4">
									<div class="popup">
										<span data-i18n="abbreviation-major-label">MAJ</span>
									</div>
									<span class="tooltip">
										<span data-i18n="major-wounds-tooltip">Major wound threshold. <i>Any</i> single injury of greater than 1/2 your HP. If using hit location, any injury that disables a limb is a <b>Major Wound</b>.<br />Roll HT to avoid Knockdown and Stunning or use the <b>K Down</b> trait on the general tab. See B420.</span>
									</span>
								</div>

								<!-- row 2 -->
								<div class="item item5">
									<input type="number" name="attr_size" value="0" title="Macro: @{size}" />
								</div>
								
								<div class="item item6">
									<input type="number" name="attr_hit_points" value="10" title="Macro: @{hit_points}" />
								</div>
								
								<div class="item item7">
									<input type="number" name="attr_hit_points_max" value="10" readonly="readonly" title="Macro: @{hit_points_max}" />
								</div>

								<div class="item item8">
									<input type="number" name="attr_major_wound_threshold" value="10" readonly="readonly" title="Macro: @{major_wound_threshold}" />
								</div>

							</div>

						</div>

						<div class="item item2">
							<div class="movement-table">

								<!-- row 1 -->
								<div class="item item1">
									<div class="popup">
										<span data-i18n="abbreviation-encumbrance-label">Enc</span>
									</div>
									<span class="tooltip">
										<span data-i18n="encumbrance-tooltip">Current encumbrance level. Penalty equal to your encumbrance is applied to Dodge, Judo, Karate, ar any fencing Parry. See B549</span>
									</span>
								</div>
								<div class="item item2">
									<div class="popup">
										<span data-i18n="load-label">Load</span>
									</div>
									<span class="tooltip">
										<span data-i18n="load-tooltip">Amount of weight you're currently carrying.</span>
									</span>
								</div>
								<div class="item item3">
									<div class="popup">
										<span data-i18n="attribute-move">Move</span>
									</div>
									<span class="tooltip">
										<span data-i18n="encumbrance-move-score-tooltip">Note: The Move score automatically adjusts for Encumbrance<br />and for HP and/or FP loss below 1/3. (B419, B426)</span>
									</span>
								</div>
								<div class="item item4">
									<div class="popup">
										<span data-i18n="abbreviation-enhanced-move-label">ENH MOVE</span>
									</div>
									<span class="tooltip">
										<span data-i18n="enhanced-move-tooltip">Enhanced ground move.<br /><b>STEP:</b> The number in parentheses is the step distance.</span>
									</span>
								</div>
								<div class="item item5">
									<div class="popup">
										<span data-i18n="air-label">Air</span>
									</div>
									<span class="tooltip">
										<span data-i18n="air-tooltip">Air/Flying move.<br /><b>STEP:</b> The number in parentheses is the step distance.</span>
									</span>
								</div>
								<div class="item item6">
									<div class="popup">
										<span data-i18n="water-label">Water</span>
									</div>
									<span class="tooltip">
										<span data-i18n="water-tooltip">Water/Swimming move.<br /><b>STEP:</b> The number in parentheses is the step distance.</span>
									</span>
								</div>
								<div class="item item7">
									<div class="popup">
										<span data-i18n="attribute-dodge">Dodge</span>
									</div>
									<span class="tooltip">
										<span data-i18n="encumbrance-dodge-tooltip">Note: The Dodge score automatically adjusts for Encumbrance<br />and for HP and/or FP loss below 1/3. (B419, B426)</span>
									</span>
								</div>
							
								<!-- row 2 -->
								<div class="item item8">
									<input type="number" name="attr_encumbrance_level" value="" readonly="readonly" title="Macro: @{encumbrance_level}" />
								</div>
								<div class="item item9">
									<input type="hidden" name="attr_total_weight" value="" />
									<input type="text" name="attr_total_weight_gravity" value="" readonly="readonly" title="Macro: @{total_weight_gravity}" />
								</div>
								<div class="item item10">
									<input type="text" name="attr_current_move" value="" readonly="readonly" title="Macro name: current_move" />
								</div>
								<div class="item item11">
									<input type="text" name="attr_enhanced_move_current" value="0" readonly="readonly" title="Macro name: enhanced_move_current" />
								</div>
								<div class="item item12">
									<input type="text" name="attr_current_air" value="0" readonly="readonly" title="Macro name: current_air" />
								</div>
								<div class="item item13">
									<input type="text" name="attr_current_water" value="0" readonly="readonly" title="Macro name: current_water" />
								</div>
								<div class="item item14">
									<input type="text" name="attr_current_dodge" value="0" readonly="readonly" title="Macro name: @{current_dodge}" />
								</div>
							
							</div>
						</div>

						<div class="item item3">

							<div class="thrust-swing-damage">

								<!-- row 1 -->
								<div class="item item1">
									<div class="popup">
										<span data-i18n="attribute-thrust">Thrust</span>
									</div>
									<span class="tooltip">
										<span data-i18n="melee-thrust-tooltip">Thrust damage based on Striking ST. You can use the macro name in a weapons damage column and apply basic math. <b>Example:</b> Damage = @{thrust}+1</span>
									</span>
								</div>
								
								<div class="item item2">
									<div class="popup">
										<span data-i18n="attribute-swing">Swing</span>
									</div>
									<span class="tooltip">
										<span data-i18n="melee-swing-tooltip">Swing damage based on Striking ST. You can use the macro name in a weapons damage column and apply basic math. <b>Example:</b> Damage = @{swing}+1</span>
									</span>
								</div>

								<!-- row 2 -->
								<div class="item item3">
									<input type="text" name="attr_thrust" value="1d6-2" title="Macro: @{thrust}">
								</div>
								
								<div class="item item4">
									<input type="text" name="attr_swing" value="1d6" title="Macro: @{swing}">
								</div>
								
							</div>

						</div>

					</div>
					
				</div>

				<div class="damage">
					
					<h3>
						<span data-i18n="hit-location-armor-title">Hit Location & Armor Table</span>
					</h3>
					
					<div class="armor-layer-controller-grid">

						<!-- row1 -->
						<div class="item heading">
							<div class="popup">
								<span data-i18n="template-label">Template</span>:
							</div>
							<span class="tooltip" style="margin-left: 0;">
								<span data-i18n="character-armor-type-tooltip">Select the hit location type and click the <b>Apply</b> button.<br /><b>ALERT:</b> This will delete the current hit locations!</span>
							</span>
						</div>
						<div class="item">
							<select name="attr_armor_hit_location_type" title="macro: @{armor_hit_location_type}">
								<option selected>Select</option>
								<option value="arachnoid">Arachnoid (spider)</option>
								<option value="avian">Avian</option>
								<option value="cancroid">Cancroid (crab)</option>
								<option value="centaur">Centaur</option>
								<option value="hexapod">Hexapod</option>
								<option value="humanoid">Humanoid</option>
								<option value="humanoid_low_tech">Humanoid Low-tech</option>
								<option value="humanoid_martial_arts">Humanoid Martial Arts</option>
								<option value="ichthyoid">Ichthyoid (fish)</option>
								<option value="octopod">Octopod (octopus)</option>
								<option value="quadruped">Quadruped</option>
								<option value="vermiform">Vermiform (snake)</option>
								<option value="wagon">Wagon</option>
								<option value="automobile">Automobile</option>
								<option value="rowboat">Rowboat</option>
								<option value="speedboat">Speedboat</option>
								<option value="biplane">Biplane</option>
								<option value="monoplane">Monoplane</option>
								<option value="helicopter">Helicopter</option>
								<option value="tank">Tank</option>
							</select>
						</div>
						<div class="item">
							<button type="action" name="act_armor_apply" class="reset" title="Apply the selected hit location type"><span data-i18n="apply-label">Apply</span></button>
						</div>
						<div class="item">&nbsp;</div>
						<div class="item heading">
							<div class="popup">
								<span data-i18n="layers-label">Layers</span>:
							</div>
							<span class="tooltip" style="margin-left: 0;">
								<span data-i18n="armor-layers-tooltip">Select the number of armor layers to display.</span>
							</span>
						</div>
						<div class="item">
							<select name="attr_armor_layers" title="Macro: @{armor_layers}">
								<option selected>1</option>
								<option>2</option>
								<option>3</option>
								<option>4</option>
							</select>
						</div>
						<div class="item">
							<label>
								<div>
									<input type="checkbox" name="attr_armor_show_back" title="Macro: @{armor_show_back}" />
								</div>
								<div>
									<div class="popup">
										<span data-i18n="back-armor-label">Back</span>
									</div>
									<span class="tooltip" style="margin-left: 0;">
										<span data-i18n="back-armor-tooltip">Show back armor for each layer.</span>
									</span>
									
								</div>
							</label>
						</div>
						<div class="item heading">
							<div class="popup">
								<span data-i18n="notes-label">Notes</span>:
							</div>
							<span class="tooltip" style="margin-left: 0;">
								<span data-i18n="hit-location-notes-tooltip">Enter notes and traits here.<br />Example include adding damage ntoes for <i>Unliving</i>, <i>Homogenous</i>, <i>Diffuse</i>, <i>Unbreakable Bones (Powers 52)</i>, <i>Damage Reduction (Powers 52).</i> see B380.</span>
							</span>
						</div>
						<div class="item">
							<textarea class="hit-location-notes" name="attr_hit_location_notes"></textarea>
						</div>

					</div>

					<div class="hit-location-container">

						<input type="hidden" name="attr_armor_show_back" />
						<input type="hidden" name="attr_armor_layers" />
						<div class="hit-location-grid">

							<!-- header row -->
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<span data-i18n="location-label">Location</span>
							</div>
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<div class="popup">
									<span data-i18n="abbreviation-penalty-label">Pen</span>
								</div>
								<span class="tooltip">
									<span data-i18n="armor-penalty-tooltip">Penalty to hit this location.<br /><b>NOTE:</b> Size Modifier is factored in on <i>Applying</i> location type or changing <i>Size Modifier</i>.</span>
								</span>
							</div>
							<div class="item grid-header layer layer-1">
								<div class="popup">
									<span data-i18n="layer-1-label">Layer 1</span>
								</div>
								<span class="tooltip">
									<span data-i18n="armor-layor-tooltip">Enter DR for this location.<br />* = flexible<br />You can split the DR using with these suggested abbreviations.<br />cr = crush<br />pi = pierce<br />cut = cutting<br />imp = impaling<br />bu = burning<br /><b>Alert:</b> To enter a split DR, the first number must be the primary DR, while the second number are the exceptions, this is required in order to know how to split the armor.</span>
									<div>
										<span data-i18n="armor-layor1-tooltip">"Layer 1 <i>(Inner most)</i> is good for natural DR or concealable armor, such as cloth armor under a breastplate.</span>
									</div>
								</span>
								<div class="front">
									<span data-i18n="front-label">Front</span>
								</div>
								<div class="back">
									<span data-i18n="back-label">Back</span>
								</div>
							</div>
							<div class="item grid-header layer layer-2">
								<div class="popup">
									<span data-i18n="layer-2-label">Layer 2</span>
								</div>
								<span class="tooltip">
									<span data-i18n="armor-layor-tooltip">Enter DR for this location.<br />* = flexible<br />You can split the DR using with these suggested abbreviations.<br />cr = crush<br />pi = pierce<br />cut = cutting<br />imp = impaling<br />bu = burning<br /><b>Alert:</b> To enter a split DR, the first number must be the primary DR, while the second number are the exceptions, this is required in order to know how to split the armor.</span>
									<div>
										<span data-i18n="armor-layor2-tooltip">Layer 2 is good for your primary armor, like helmet, leather armor, gloves, etc.</span>
									</div>
								</span>
								<div class="front">
									<span data-i18n="front-label">Front</span>
								</div>
								<div class="back">
									<span data-i18n="back-label">Back</span>
								</div>
							</div>
							<div class="item grid-header layer layer-3">
								<div class="popup">
									<span data-i18n="layer-3-label">Layer 3</span>
								</div>
								<span class="tooltip">
									<span data-i18n="armor-layor-tooltip">Enter DR for this location.<br />* = flexible<br />You can split the DR using with these suggested abbreviations.<br />cr = crush<br />pi = pierce<br />cut = cutting<br />imp = impaling<br />bu = burning<br /><b>Alert:</b> To enter a split DR, the first number must be the primary DR, while the second number are the exceptions, this is required in order to know how to split the armor.</span>
									<div>
										<span data-i18n="armor-layor3-tooltip">Layer 3 is good for force shields, magic DR, etc.</span>
									</div>
								</span>
								<div class="front">
									<span data-i18n="front-label">Front</span>
								</div>
								<div class="back">
									<span data-i18n="back-label">Back</span>
								</div>
							</div>
							<div class="item grid-header layer layer-4">
								<div class="popup">
									<span data-i18n="layer-4-label">Layer 4</span>
								</div>
								<span class="tooltip">
									<span data-i18n="armor-layor-tooltip">Enter DR for this location.<br />* = flexible<br />You can split the DR using with these suggested abbreviations.<br />cr = crush<br />pi = pierce<br />cut = cutting<br />imp = impaling<br />bu = burning<br /><b>Alert:</b> To enter a split DR, the first number must be the primary DR, while the second number are the exceptions, this is required in order to know how to split the armor.<br /><b>NOTE:</b> Only <b>one</b> layer per row may have split armor.</span>
									<div>
										<span data-i18n="armor-layor4-tooltip">Layer 4 <i>(Outer most)</i> is also good for force shields, magic DR, etc.</span>
									</div>
								</span>
								<div class="back">
									<span data-i18n="back-label">Back</span>
								</div>
							</div>
							<div class="item grid-header layer summary">
								<div class="popup">
									<span data-i18n="summary-label">Summary</span>
								</div>
								<span class="tooltip">
									<span data-i18n="armor-summary-tooltip">This sums up each layer, from layer 1 <i>(inner)</i> to layer 4 <i>(outer)</i>.<br />* = flexible armor.<br /><b>Alert: </b> Only <b>one</b> layer per row may have split armor.</span>
								</span>
								<div class="front">
									<span data-i18n="front-label">Front</span>
								</div>
								<div class="back">
									<span data-i18n="back-label">Back</span>
								</div>
							</div>
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<div class="popup">
									<span data-i18n="abbreviation-defense-bonus-label">DB</span>
								</div>
								<span class="tooltip">
									<span data-i18n="defense-bonus-tooltip">Apply the defense bonus of a shield, cloak, spell (B252), or Meta-trait (Supers34). See B374<br /><b>Shield/Cloak:</b> Used against attacks from front or from your shield side. Can't be used against firearms <b>unless</b> you're using the <i>Damage to Shields</i> option.<br /><b>Shield Spell:</b> Protects from <i>frontal</i> attacks and is cumulative with a normal shield.</span>
								</span>
							</div>
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<div class="popup">
									<span data-i18n="abbreviation-damage-label">DMG</span>
								</div>
								<span class="tooltip">
									<span data-i18n="hitlocation-damage-tooltip">Enter the amount of damage this location has taken.<br /><b>NOTE:</b> The damage will <i>note</i> affect the current Hit Points.</span>
								</span>
							</div>
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<div class="popup">
									<span data-i18n="abbreviation-divisor-label">DIV</span>
								</div>
								<span class="tooltip">
									<span data-i18n="hitlocation-divisor-tooltip">Hit Point Divisor. If the number is 2 or higher, that means the location can be disabled and a value will be updated in the next column. See B421.</span>
								</span>
							</div>
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<div class="popup">
									<span data-i18n="abbreviation-disabled-label">DIS</span>
								</div>
								<span class="tooltip">
									<span data-i18n="hitlocation-disabled-tooltip">Disabled/Crippled Threshold.<br />If a <b>single</b> injury meets or exceeds this value, the extremity or structure is disabled.<br /><b>NOTE:</b> In most cases, if disabled/crippled in one injury, the excess damage is lost, except where noted, such as the <b>eyes.</b><br /><b>Dismemberment:</b> If injury is <i>twice</i> the threshold, then extremity is destroyed. <i>Cutting</i> or <i>Explosion</i> will sever the limb.<br />See B421</span>
								</span>
							</div>
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<div class="popup">
									<span data-i18n="wounds-label">Wounds</span>
								</div>
								<span class="tooltip">
									<span data-i18n="hitlocation-wounds-tooltip">Enter individual wounds here, if limb is crippled, bleeding, etc.<br />Example: -6 pi (major wound), -2 burn.</span>
								</span>
							</div>
							<div class="item grid-header">
								<h4 class="spacer">&nbsp;</h4>
								<span data-i18n="notes-label">Notes</span>
							</div>

						</div>

						<fieldset class="repeating_hitlocation">

							<div class="hit-location-grid">
								<div class="item">
									<input type="text" name="attr_where" title="Macro: @{repeating_hitlocation_$[row #]_where}" />
									<input type="hidden" name="attr_key" />
								</div>
								<div class="item">
									<input type="number" step="1" value="0" name="attr_penalty" title="Macro: @{repeating_hitlocation_$[row #]_penalty}" />
								</div>
								<div class="item layer layer-1">
									<div class="front">
										<input type="text" value="0" name="attr_layer_1_front" title="Macro: @{repeating_hitlocation_$[row #]_layer_1_front}" />
									</div>
									<div class="back">
										<input type="text" value="0" name="attr_layer_1_back" title="Macro: @{repeating_hitlocation_$[row #]_layer_1_back}" />
									</div>
								</div>
								<div class="item layer layer-2">
									<div class="front">
										<input type="text" name="attr_layer_2_front" title="Macro: @{repeating_hitlocation_$[row #]_layer_2_front}" />
									</div>
									<div class="back">
										<input type="text" name="attr_layer_2_back" title="Macro: @{repeating_hitlocation_$[row #]_layer_2_back}" />
									</div>
								</div>
								<div class="item layer layer-3">
									<div class="front">
										<input type="text" name="attr_layer_3_front" title="Macro: @{repeating_hitlocation_$[row #]_layer_3_front}" />
									</div>
									<div class="back">
										<input type="text" name="attr_layer_3_back" title="Macro: @{repeating_hitlocation_$[row #]_layer_3_back}" />
									</div>
								</div>
								<div class="item layer layer-4">
									<div class="front">
										<input type="text" name="attr_layer_4_front" title="Macro: @{repeating_hitlocation_$[row #]_layer_4_front}" />
									</div>
									<div class="back">
										<input type="text" name="attr_layer_4_back" title="Macro: @{repeating_hitlocation_$[row #]_layer_4_back}" />
									</div>
								</div>
								<div class="item layer summary">
									<div class="front">
										<input type="text" name="attr_layer_summary_front" readonly="readonly" title="Macro: @{repeating_hitlocation_$[row #]_layer_summary_front}" />
									</div>
									<div class="back">
										<input type="text" name="attr_layer_summary_back" readonly="readonly" title="Macro: @{repeating_hitlocation_$[row #]_layer_summary_back}" />
									</div>
								</div>
								<div class="item">
									<input type="number" value="0" step="1" min="0" name="attr_defense_bonus" title="Macro: @{repeating_hitlocation_$[row #]_defense_bonus}" />
								</div>
								<div class="item">
									<input type="number" value="0" step="1" max="0" name="attr_damage" title="Macro: @{repeating_hitlocation_$[row #]_damage}" />
								</div>
								<div class="item">
									<input type="number" value="1" step="1" min="1" name="attr_divisor" title="Macro: @{repeating_hitlocation_$[row #]_divisor}" />
								</div>
								<div class="item">
									<input type="text" name="attr_crippled" value="0" readonly="readonly" title="Macro: @{repeating_hitlocation_$[row #]_crippled}" />
								</div>
								<div class="item">
									<input type="text" name="attr_wounds" title="Macro: @{repeating_hitlocation_$[row #]_wounds}" />
								</div>
								<div class="item">
									<input type="text" name="attr_notes" title="Macro: @{repeating_hitlocation_$[row #]_notes}" />
								</div>
							</div>
							
						</fieldset>

					</div>

				</div>

				<div class="defense">
						
					<!-- tables -->
					<div class="box damage-reduction">
						
						<div class="table">
							<div class="header row-title">
				
								<div class="title hit-location">
									<div class="popup">
										<span data-i18n="hit-location-label">Hit Location</span>
									</div>
									<span class="tooltip">
										<span data-i18n="hit-location-tooltip">
			Basic Table B552.<br/>
			<strong>Optinal:</strong> Rules<br/> 
			New Hit Locations<br/>
			LT100-103, MA137
										</span>
									</span>
								</div>	
								
							</div>

							<div class="header">
								<div class="cell col0">
									<span data-i18n="where-label">Where</span>
								</div>
								<div class="cell col1">
									<div class="popup">
										<span data-i18n="penalty-label">Pen</span>
									</div>
									<span class="tooltip">
										<span data-i18n="hit-location-penalty-tooltip">
			This is the <strong>Penalty</strong> <br />
			applied to attack the <br />
			specific location.
										</span>
									</span>
								</div>
								
								<div class="cell col2">
									<div class="popup">
										<span data-i18n="abbreviation-damage-resistance-label">DR</span>
									</div>
									<span class="tooltip">
										<span data-i18n="damage-resistance-tooltip">
			<strong>Low-Tech</strong> #/# usually means All Attack Types / Except<br />
			this specific Type of attack.<br />
			Example: Enter as 3/2cr* means DR3 vs all attacks<br />
			except cr which uses DR2. * means it is Flexible<br />
			armor (B379).<br />
			<strong>High-Tech and Ultra-Tech</strong> #/# usually mean against<br />
			these Type Attacks / All other Attack Types.<br />
			Example: Enter as 5imp, cr /2 means DR5 vs imp and<br />
			cr type of attacks and DR2 against all other types<br />
			of attacks.
										</span>
									</span>
								</div>
								
							</div> <!-- .row -->

							<div class="row row-skull">
								<div class="cell col0 label">
									<input type="text" name="attr_name_skull" value="Skull" title="Macro name: name_skull" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_skull" value="-7" title="Macro name: hit_penalty_skull" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_skull_dr_max" value="2" title="Macro name: skull_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-face">
								<div class="cell col0 label">
									<input type="text" name="attr_name_face" value="Face" title="Macro name: name_face" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_face" value="-5" title="Macro name: hit_penalty_face" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_face_dr_max" value="0" title="Macro name: face_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-eyes">
								<div class="cell col0 label">
									<input type="text" name="attr_name_eyes" value="Eyes" title="Macro name: name_eyes" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_eyes" value="-9" title="Macro name: hit_penalty_eyes" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_eyes_dr_max" value="0" title="Macro name: eyes_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-neck">
								<div class="cell col0 label">
									<input type="text" name="attr_name_neck" value="Neck" title="Macro name: name_neck" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_neck" value="-5" title="Macro name: hit_penalty_neck" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_neck_dr_max" value="0" title="Macro name: neck_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-arms">
								<div class="cell col0 label">
									<input type="text" name="attr_name_arms" value="Arms" title="Macro name: name_arms" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_arms" value="-2" title="Macro name: hit_penalty_arms" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_arms_dr_max" value="0" title="Macro name: arms_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-hands">
								<div class="cell col0 label">
									<input type="text" name="attr_name_hands" value="Hands" title="Macro name: name_hands" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_hands" value="-4" title="Macro name: hit_penalty_hands" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_hands_dr_max" value="0" title="Macro name: hands_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-torso">
								<div class="cell col0 label">
									<input type="text" name="attr_name_torso" value="Torso" title="Macro name: name_torso" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_torso" value="0" title="Macro name: hit_penalty_torso" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_torso_dr_max" value="0" title="Macro name: torso_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-vitals">
								<div class="cell col0 label">
									<input type="text" name="attr_name_vitals" value="Vitals" title="Macro name: name_vitals" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_vitals" value="-3" title="Macro name: hit_penalty_vitals" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_vitals_dr_max" value="See Torso" title="Macro name: vitals_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-groin">
								<div class="cell col0 label">
									<input type="text" name="attr_name_groin" value="Groin" title="Macro name: name_groin" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_groin" value="-3" title="Macro name: hit_penalty_groin" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_groind_dr_max" value="0" title="Macro name: groind_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-legs">
								<div class="cell col0 label">
									<input type="text" name="attr_name_legs" value="Legs" title="Macro name: name_legs" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_legs" value="-2" title="Macro name: hit_penalty_legs" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_legs_dr_max" value="0" title="Macro name: legs_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-feet">
								<div class="cell col0 label">
									<input type="text" name="attr_name_feet" value="Feet" title="Macro name: name_feet" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_feet" value="-4" title="Macro name: hit_penalty_feet" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_feet_dr_max" value="0" title="Macro name: feet_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="row row-area">
								<div class="cell col0 label">
									<input type="text" name="attr_name_area" value="Area" title="Macro name: name_area" />
								</div>
								<div class="cell col1">
									<input type="text" name="attr_hit_penalty_area" value="n/a" title="Macro name: hit_penalty_area" />
								</div>
								<div class="cell col2">
									<input type="text" name="attr_area_dr_max" value="0" title="Macro name: area_dr_max" />
								</div>
							</div> <!-- .row -->
							<div class="header row-title">
								<div class="cell col0">
									<span data-i18n="user-created-label">User Created</span>
								</div>
							</div> <!-- .header -->
							<fieldset class="repeating_location">
								<div class="row row-stats">
									<div class="cell col0 label">
										<input type="text" name="attr_name" title="Macro table name: repeating_location. Field name: name" />
									</div>
									<div class="cell col1">
										<input type="text" name="attr_hit_penalty" value="0" title="Macro table name: repeating_location. Field name: hit_penalty" />
									</div>
									<div class="cell col2">
										<input type="text" name="attr_dr_max" value="0" title="Macro table name: repeating_location. Field name: dr_max" />
									</div>
								</div> <!-- .row -->
							</fieldset>
						</div> <!-- .table -->

					</div>

					<!-- _____ _____ ACTIVE DEFENSE BOX _____ _____ -->
					<div class="box active-defense">
						<div class="table">

							<div class="header margin-left">
								<div class="cell col0">
									<div class="popup">
										<span data-i18n="active-defenses-label">Active Defenses</span>	
									</div>
									<span class="tooltip">
										<span data-i18n="activate-custom-roll-modifier-tooltip">To turn on the custom modifiers and button to open the <b>Roll Modifier</b> dialog box goto the <b>Sheet Options</b> tab and check off the tools you would like to user under <b>Skill Modifier Tools</b> section.</span>
									</span>	
								</div>
								<div class="cell col1">
									<div class="popup">
										<span data-i18n="type-label">Type</span>
									</div>
									<span class="tooltip">
										<span data-i18n="active-defense-type-tooltip">
			Changing the Type will also update success/fail notes<br />
			for that active defense.<br />
			Parry, Block, and Block have default notes that can be<br />
			changed on the options page.<br />
			<b>NOTE</b> Changing the Type will clear any previous notes<br />
			you entered.
										</span>
									</span>
								</div>
								<div class="cell col2">
									<div class="popup">
										<span data-i18n="abbreviation-information-label">Info</span>
									</div>
									<span class="tooltip">
										<span data-i18n="active-defense-information-tooltip">
			<strong>F</strong>: this is a fencing weapon.<br />
			<strong>U</strong>: the weapon is unbalanced. You cannot use it to<br />
			parry if you've already attacked with it this turn<br />
			(and vice versa).
										</span>
									</span>
								</div>
								<div class="cell col2">
									<div class="popup">
										<span data-i18n="base-level-label">Base</span>
									</div>
									<span class="tooltip">
										<span data-i18n="base-defense-skill-tooltip">Base defense skill.</span>
									</span>
								</div>
								<div class="cell col2">
									<div class="popup">
										<span data-i18n="abbreviation-modifier-label">Mod</span>
									</div>
									<span class="tooltip">
										<span data-i18n="defense-modifiers-tooltip">Modifiers to the defense skill.</span>
									</span>
								</div>
								<div class="cell col3">
									<span style="background-color: #87CEFA">| <span data-i18n="skill-label">skill</span> |</span>
								</div>
							</div> <!-- .header -->

							<!-- attr_use_defense_modifier_tool is linked to checkbox on options sheet -->
							<input type="hidden" name="attr_use_defense_modifier_tool" value="0" />
							<div class="row roll-modifiers">
								<div class="cell label">
									<div class="popup">
										<span data-i18n="modifier-label">Modifier:</span>
									</div>
									<div class="tooltip">
										<span data-i18n="modifier-dialog-tooltip">Enter a modifier to apply to any rolls on the this table.<br />Use the pencil/paper icon to select modifiers.<br /><b>NOTE:</b> Changing the modifier or check status of <i>Max skill of 9</i> will clear modifiers used by dialog box.</span>
									</div>
								</div>
								<div class="cell number-input">
									<input type="number" value="0" step="1" name="attr_defense_roll_modifier" />
									<input type="hidden" value="" name="attr_defense_roll_modifier_summary" />
									<input type="hidden" value="" name="attr_defense_roll_trait_summary" />
									<input type="hidden" value="" name="attr_defense_roll_hit_location" />
									<input type="hidden" value="" name="attr_defense_roll_maneuver" />
									<input type="hidden" value="" name="attr_defense_roll_allout_attack" />

									<!-- not used for defense -->
									<input type="hidden" name="attr_defense_roll_max_nine" value="1" />
									<input type="hidden" name="attr_defense_roll_max_nine_value" value="100" />

								</div>
								<div class="cell">
									<button type="action" name="act_show_roll_modifiers_for_defense" class="btn" title="Select Skill Modifiers"><span data-i18n="select-skill-modifiers-button">Select Skill Modifiers</span></button>
								</div>
								<div class="cell cell-popup" style="margin-left:5px;">
									<div>
										<input type="checkbox" name="attr_defense_roll_apply_encumbrance" value="1" title="Macro: @{defense_roll_apply_encumbrance}" />
									</div>
									<div>
										<div class="popup">
											<span data-i18n="encumbrance-label">Encumbrance</span>
										</div>
										<div class="tooltip max-skill-9">
											<span data-i18n="apply-encumbrance-tooltip">Apply encumbrance penalty.</span>
											<b style="color:red;"><span name="attr_encumbrance_level"></span></b><br />
											<span data-i18n="apply-encumbrance-dodge-note-tooltip"><b>NOTE:</b> The predefined <i>dodges</i> already of encumbrance applied!</span>
										</div>
									</div>
								</div>
								<div class="cell cell-popup" style="margin-left:15px;">
									<div>
										<select name="attr_defense_apply_shield_db">
											<option>0</option>
											<option>1</option>
											<option>2</option>
											<option>3</option>
											<option>4</option>
											<option>5</option>
										</select>
									</div>
									<div>
										<div class="popup">
											<span data-i18n="shield-abbreviate-defense-bonus-label">Shield DB</span>
										</div>
										<div class="tooltip max-skill-9">
											<span data-i18n="shield-defense-bonus-tooltip">Apply defense bonus for a shield if attack came the front or from your shield side. See B374.</span>
										</div>
									</div>
								</div>
								<div class="cell cell-popup" style="margin-left:15px;">
									<div>
										<select name="attr_defense_apply_magic_db">
											<option>0</option>
											<option>1</option>
											<option>2</option>
											<option>3</option>
											<option>4</option>
											<option>5</option>
										</select>
									</div>
									<div>
										<div class="popup">
											<span data-i18n="magic-abbreviate-defense-bonus-label">Magic DB</span>
										</div>
										<div class="tooltip max-skill-9">
											<span data-i18n="magic-defense-bonus-tooltip">Magical Defense Bonus, such as the Shield spell, which protects from <i>frontal</i> attacks. See B252.</span>
										</div>
									</div>
								</div>
								<div class="cell">
									<button type="action" name="act_defense_roll_reset" class="btn tool-modifier-reset" title="Reset Skill Modifiers"><span data-i18n="reset-label">Reset</span></button>
								</div>
								<div class="cell">
									<div class="summary-group">
										<div class="icon"><span data-i18n="notes-label">Notes</span></div>
										<div class="summary">
											<div class="roll-maneuver">
												<b>Maneuver:</b>
												<div>
													<span name="attr_defense_roll_maneuver"></span>
												</div>
											</div>
											<div class="roll-traits">
												<b>Traits:</b>
												<div>
													<span name="attr_defense_roll_trait_summary"></span>
												</div>
											</div>
											<div class="roll-summary">
												<b>Summary:</b>
												<div>
													<span name="attr_defense_roll_modifier_summary"></span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							
							<div class="row-static-defense">
								<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight_dodge" />
								<input class="toggle toggle-notes static-defense" type="checkbox" title="Click to show/hide more information." name="attr_defense_dodge_toggle_notes" />
								<span class="checkbox static-defense"></span>	
								<div class="row row-stats row-standard static-defense-width">
									<div class="cell col-dodge-label">
										<span data-i18n="attribute-dodge">Dodge</span>
									</div>
									<div class="cell col-dodge">
										<input type="hidden" class="dodge-reduced-notes" name="attr_dodge_reduced_notes" value="0" />
										<div class="halved-dodge">
											<div class="popup">
												<b style="color:red;">½ <span data-i18n="attribute-dodge">Dodge</span></b>
											</div>
											<span class="tooltip">
												<span data-i18n="half-dodge-tooltip">Dodge is halved due to hit points or fatigue loss. See B418 or B426.</span>
											</span>
										</div>
										<div class="quartered-dodge">
											<div class="popup">
												<b style="color:red;">¼ <span data-i18n="attribute-dodge">Dodge</span></b>
											</div>
											<span class="tooltip">
												<span data-i18n="quarter-dodge-tooltip">Dodge is quartered due to hit points and fatigue loss. See B418 or B426.</span>
											</span>
										</div>
									</div>
									<div class="cell col1">
										<span data-i18n="attribute-dodge">Dodge</span>
									</div>
									<div class="cell col2"></div>
									<div class="cell col2"><input type="text" name="attr_ad_dodge_skill" value="@{current_dodge}" disabled="disabled" title="Macro name: @{ad_dodge_skill}" /></div>
									<div class="cell col2"><input type="number" step="1" name="attr_ad_dodge_skill_mod" value="0" title="Macro name: @{ad_dodge_skill_mod}" /></div>
									<div class="cell col3"><input type="text" name="attr_ad_dodge_skill_final" value="@{current_dodge} + @{ad_dodge_skill_mod}" disabled="disabled" title="Macro name: @{ad_dodge_skill_final}" /></div>
									<div class="cell col4">
										<input type="hidden" name="attr_raw_dodge_success_notes" />
										<input type="hidden" name="attr_raw_dodge_critical_success_notes" />
										<input type="hidden" name="attr_raw_dodge_fail_notes" />
										<input type="hidden" name="attr_raw_dodge_critical_fail_notes" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Defense Roll}} {{defenseType=[[1]]}} {{activeDefense=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Dodge}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{ad_dodge_skill_final} + @{modifier} + @{defense_roll_modifier}, @{defense_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_defense_modifier_tool}]]}} {{maxNine=[[@{defense_roll_max_nine}]]}} {{rollModifier=[[@{defense_roll_modifier}]]}} {{rollModifierSummary=@{defense_roll_modifier_summary}}} {{rollTraitSummary=@{defense_roll_trait_summary}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[@{defense_dodge_show_notes}]]}} {{notes=@{defense_dodge_notes}}} {{showRawDefenseNotes=[[@{show_raw_defensive_notes}]]}} {{rawSuccessNote=@{raw_dodge_success_notes}}} {{rawCriticalSuccessNote=@{raw_dodge_critical_success_notes}}} {{rawFailNote=@{raw_dodge_fail_notes}}} {{rawCriticalFailNote=@{raw_dodge_critical_fail_notes}}} {{customSuccessNote=@{defense_dodge_success_note}}} {{customCriticalSuccessNote=@{defense_dodge_critical_success_note}}} {{customFailNote=@{defense_dodge_fail_note}}} {{customCriticalFailNote=@{defense_dodge_critical_fail_note}}} {{showDBNotes=[[@{show_db_notes}]]}} {{DBNotes=@{defense_bonus_notes}}}" name="roll_vsDodge" />
									</div>
								</div> <!-- .row -->

								<div class="row row-details notebox">
								
									<div class="row hide-row"></div> <!-- .row needed to cause note to have background: todo: fix css -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
											</div>
											<span class="tooltip">
												<span data-i18n="reason-for-modifiers-skills-tooltip">
			Examples:<br />
			+1 from Talent...<br />
			+1 from Default Skill...<br />
			+1 from Enchanted Item with...
												</span>
											</span> 
										</div>
										<div class="cell col-input-wide">
											<input type="text" name="attr_defense_dodge_mod_reason" title="Field name: defense_dodge_mod_reason" />
										</div>
									</div>
									<div class="header">
										<div class="title">
											<div class="popup">
												<span data-i18n="notes-label">Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="custom-success-fail-notes-tooltip">
			Success, critical success, fail, and critical fail<br />
			notes will be added to roll results.<br />
			You can add macros to these notes.<br />
			The width of these note boxes are set to help you<br />
			visualize what it will look like in chat.
												</span>
											</span>
										</div>
									</div>
									<div class="row">
										
										<div class="show-notes">
											<input type="checkbox" name="attr_defense_dodge_show_notes" value="1" style="float:left; margin-right: 5px;" />
											<div class="popup" style="float:left;">
												<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
											</div>
											<span class="tooltip">
												<span data-i18n="displayed-on-rolltemplate-tooltip">Displayed on the rolltemplate.</span>
											</span>
										</div>

									</div>
								
									<div class="rolltable-result-notes">
										<div class="note-input">
											<div class="note-title">
												<div class="popup">
													<span data-i18n="custom-notes-label">Custom Notes:</span>
												</div>
												<span class="tooltip">
													<span data-i18n="custom-notes-active-defense-tooltip">Add custom notes for this active defense.</span>
												</span>
											</div>
											<textarea name="attr_defense_dodge_notes" value="@{dodge_success_notes}" title="Field name: defense_dodge_notes" style="height: 50px"></textarea>
										</div>
										
									</div>
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="success-note-label">Success Note:</span>
											</div>
											<textarea name="attr_defense_dodge_success_note" title="Field name: defense_dodge_success_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-success-note-label">Critical Success Note:</span>
											</div>
											<textarea name="attr_defense_dodge_critical_success_note" title="Field name: defense_dodge_critical_success_note"></textarea>
										</div>
										
									</div>
									
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="fail-note-label">Fail Note:</span>
											</div>
											<textarea name="attr_defense_dodge_fail_note" title="Field name: defense_dodge_fail_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-fail-note-label">Critical Fail Note:</span>
											</div>
											<textarea name="attr_defense_dodge_critical_fail_note" title="Field name: defense_dodge_critical_fail_note"></textarea>
										</div>
										
									</div>
									
								</div> <!-- .row -->

							</div>

							<div class="row-static-defense">
								<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight_dodge_retreat" />
								<input class="toggle toggle-notes static-defense" type="checkbox" title="Click to show/hide more information." name="attr_defense_dodge_retreat_toggle_notes" />
								<span class="checkbox static-defense"></span>		
								<div class="row row-stats row-standard static-defense-width">

									<div class="cell col-dodge-label">
										<div class="popup">
											<span data-i18n="dodge-retreat-versus-melee-label">Dodge and Retreat (vs. Melee Attacks Only)</span>
										</div>
										<span class="tooltip">
											<span data-i18n="dodge-retreat-versus-melee-tooltip">
			Against a <strong>Melee Attack</strong> ONLY. (B377). It cannot be used against Ranged Attacks.<br/>
			Optional Rules for Retreat can be found in MA123.
											</span>
										</span>
									</div>

									<div class="cell col-dodge">
										<input type="hidden" class="dodge-reduced-notes" name="attr_dodge_reduced_notes" value="0" />
										<div class="halved-dodge">
											<div class="popup">
												<b style="color:red;">½ <span data-i18n="attribute-dodge">Dodge</span></b>
											</div>
											<span class="tooltip">
												<span data-i18n="half-dodge-tooltip">Dodge is halved due to hit points or fatigue loss. See B418 or B426.</span>
											</span>
										</div>
										<div class="quartered-dodge">
											<div class="popup">
												<b style="color:red;">¼ <span data-i18n="attribute-dodge">Dodge</span></b>
											</div>
											<span class="tooltip">
												<span data-i18n="quarter-dodge-tooltip">Dodge is quartered due to hit points and fatigue loss. See B418 or B426.</span>
											</span>
										</div>
									</div>

									<div class="cell col1">
										<span data-i18n="attribute-dodge">Dodge</span>
									</div>
									<div class="cell col2"></div>
									<div class="cell col2"><input type="text" name="attr_ad_dodge_retreat_skill" value="@{current_dodge} + 3" disabled="disabled" title="Macro name: @{ad_dodge_retreat_skill}" /></div>
									<div class="cell col2"><input type="number" step="1" name="attr_ad_dodge_retreat_skill_mod" value="0" title="Macro name: @{ad_dodge_retreat_skill_mod}" /></div>
									<div class="cell col3"><input type="text" name="attr_ad_dodge_retreat_skill_final" value="@{current_dodge} + 3 + @{ad_dodge_retreat_skill_mod}" disabled="disabled" title="Macro name: @{ad_dodge_retreat_skill_final}" /></div>
									<div class="cell col4">
										<input type="hidden" name="attr_raw_dodge_retreat_success_notes" />
										<input type="hidden" name="attr_raw_dodge_retreat_critical_success_notes" />
										<input type="hidden" name="attr_raw_dodge_retreat_fail_notes" />
										<input type="hidden" name="attr_raw_dodge_retreat_critical_fail_notes" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Defense Roll}} {{defenseType=[[1]]}} {{activeDefense=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Dodge and Retreat}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{ad_dodge_retreat_skill_final} + @{modifier} + @{defense_roll_modifier}, @{defense_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_defense_modifier_tool}]]}} {{maxNine=[[@{defense_roll_max_nine}]]}} {{rollModifier=[[@{defense_roll_modifier}]]}} {{rollModifierSummary=@{defense_roll_modifier_summary}}} {{rollTraitSummary=@{defense_roll_trait_summary}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[@{defense_dodge_retreat_show_notes}]]}} {{notes=@{defense_dodge_retreat_notes}}} {{showRawDefenseNotes=[[@{show_raw_defensive_notes}]]}} {{rawSuccessNote=@{raw_dodge_retreat_success_notes}}} {{rawCriticalSuccessNote=@{raw_dodge_retreat_critical_success_notes}}} {{rawFailNote=@{raw_dodge_retreat_fail_notes}}} {{rawCriticalFailNote=@{raw_dodge_retreat_critical_fail_notes}}} {{customSuccessNote=@{defense_dodge_retreat_success_note}}} {{customCriticalSuccessNote=@{defense_dodge_retreat_critical_success_note}}} {{customFailNote=@{defense_dodge_retreat_fail_note}}} {{customCriticalFailNote=@{defense_dodge_retreat_critical_fail_note}}} {{showDBNotes=[[@{show_db_notes}]]}} {{DBNotes=@{defense_bonus_notes}}}" name="roll_vsDodgeRetreat" />
									</div>
								</div> <!-- .row -->

								<div class="row row-details notebox">
								
									<div class="row hide-row"></div> <!-- .row needed to cause note to have background: todo: fix css -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
											</div>
											<span class="tooltip">
												<span data-i18n="reason-for-modifiers-skills-tooltip">
			Examples:<br />
			+1 from Talent...<br />
			+1 from Default Skill...<br />
			+1 from Enchanted Item with...
												</span>
											</span> 
										</div>
										<div class="cell col-input-wide">
											<input type="text" name="attr_defense_dodge_retreat_mod_reason" title="Field name: defense_dodge_retreat_mod_reason" />
										</div>
									</div>
									<div class="header">
										<div class="title">
											<div class="popup">
												<span data-i18n="notes-label">Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="custom-success-fail-notes-tooltip">
			Success, critical success, fail, and critical fail<br />
			notes will be added to roll results.<br />
			You can add macros to these notes.<br />
			The width of these note boxes are set to help you<br />
			visualize what it will look like in chat.
												</span>
											</span>
										</div>
									</div>
									<div class="row">
										
										<div class="show-notes">
											<input type="checkbox" name="attr_defense_dodge_retreat_show_notes" value="1" style="float:left; margin-right: 5px;" />
											<div class="popup" style="float:left;">
												<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
											</div>
											<span class="tooltip">
												<span data-i18n="displayed-on-rolltemplate-tooltip">Displayed on the rolltemplate.</span>
											</span>
										</div>

									</div>
								
									<div class="rolltable-result-notes">
										<div class="note-input">
											<div class="note-title">
												<div class="popup">
													<span data-i18n="custom-notes-label">Custom Notes:</span>
												</div>
												<span class="tooltip">
													<span data-i18n="custom-notes-active-defense-tooltip">Add custom notes for this active defense.</span>
												</span>
											</div>
											<textarea name="attr_defense_dodge_retreat_notes" title="Field name: defense_dodge_notes" style="height: 50px"></textarea>
										</div>
										
									</div>

									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="success-note-label">Success Note:</span>
											</div>
											<textarea name="attr_defense_dodge_retreat_success_note" title="Field name: defense_dodge_retreat_success_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-success-note-label">Critical Success Note:</span>
											</div>
											<textarea name="attr_defense_dodge_retreat_critical_success_note" title="Field name: defense_dodge_retreat_critical_success_note"></textarea>
										</div>
										
									</div>
									
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<div data-i18n="fail-note-label">Fail Note:</div>
											</div>
											<textarea name="attr_defense_dodge_retreat_fail_note" title="Field name: defense_dodge_retreat_fail_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-fail-note-label">Critical Fail Note:</span>
											</div>
											<textarea name="attr_defense_dodge_retreat_critical_fail_note" title="Field name: defense_dodge_retreat_critical_fail_note"></textarea>
										</div>
										
									</div>
									
								</div> <!-- .row -->

							</div>

							<div class="row-static-defense">
								<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight_dodge_drop" />
								<input class="toggle toggle-notes static-defense" type="checkbox" title="Click to show/hide more information." name="attr_defense_dodge_drop_toggle_notes" />
								<span class="checkbox static-defense"></span>
								<div class="row row-stats row-standard static-defense-width">
									<div class="cell col-dodge-label">
										<div class="popup">
											<span data-i18n="dodge-drop-ranged-label">Dodge and Drop (vs. Ranged Attacks only)</span>
										</div>
										<span class="tooltip">
											<span data-i18n="dodge-drop-ranged-tooltip">
			Dodge and Drop (Also 'Sacrificial Dodge and Drop', and 'Diving for Cover').<br/>
			It is similar to a Dodge and Retreat, but only effective against <strong>Ranged Attacks</strong>. (B377)
											</span>
										</span>
									</div>
									<div class="cell col-dodge">
										<input type="hidden" class="dodge-reduced-notes" name="attr_dodge_reduced_notes" value="0" />
										<div class="halved-dodge">
											<div class="popup">
												<b style="color:red;">½ <span data-i18n="attribute-dodge">Dodge</span></b>
											</div>
											<span class="tooltip">
												<span data-i18n="half-dodge-tooltip">Dodge is halved due to hit points or fatigue loss. See B418 or B426.</span>
											</span>
										</div>
										<div class="quartered-dodge">
											<div class="popup">
												<b style="color:red;">¼ <span data-i18n="attribute-dodge">Dodge</span></b>
											</div>
											<span class="tooltip">
												<span data-i18n="quarter-dodge-tooltip">Dodge is quartered due to hit points and fatigue loss. See B418 or B426.</span>
											</span>
										</div>
									</div>
									<div class="cell col1">
										<span data-i18n="attribute-dodge">Dodge</span>
									</div>
									<div class="cell col2"></div>
									<div class="cell col2"><input type="text" name="attr_ad_dodge_drop_skill" value="@{current_dodge} + 3" disabled="disabled" title="Macro name: @{ad_dodge_drop_skill}" /></div>
									<div class="cell col2"><input type="number" step="1" name="attr_ad_dodge_drop_skill_mod" value="0" title="Macro name: ad_dodge_drop_skill_mod" /></div>
									<div class="cell col3"><input type="text" name="attr_ad_dodge_drop_skill_final" value="@{current_dodge} + 3 + @{ad_dodge_drop_skill_mod}" disabled="disabled" title="Macro name: @{ad_dodge_drop_skill_final}" /></div>
									<div class="cell col4">
										<input type="hidden" name="attr_raw_dodge_drop_success_notes" />
										<input type="hidden" name="attr_raw_dodge_drop_critical_success_notes" />
										<input type="hidden" name="attr_raw_dodge_drop_fail_notes" />
										<input type="hidden" name="attr_raw_dodge_drop_critical_fail_notes" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Defense Roll}} {{defenseType=[[1]]}} {{activeDefense=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Dodge and Drop}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{ad_dodge_drop_skill_final} + @{modifier} + @{defense_roll_modifier}, @{defense_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_defense_modifier_tool}]]}} {{maxNine=[[@{defense_roll_max_nine}]]}} {{rollModifier=[[@{defense_roll_modifier}]]}} {{rollModifierSummary=@{defense_roll_modifier_summary}}} {{rollTraitSummary=@{defense_roll_trait_summary}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[@{defense_dodge_drop_show_notes}]]}} {{notes=@{defense_dodge_drop_notes}}} {{showRawDefenseNotes=[[@{show_raw_defensive_notes}]]}} {{rawSuccessNote=@{raw_dodge_drop_success_notes}}} {{rawCriticalSuccessNote=@{raw_dodge_drop_critical_success_notes}}} {{rawFailNote=@{raw_dodge_drop_fail_notes}}} {{rawCriticalFailNote=@{raw_dodge_drop_critical_fail_notes}}} {{customSuccessNote=@{defense_dodge_drop_success_note}}} {{customCriticalSuccessNote=@{defense_dodge_drop_critical_success_note}}} {{customFailNote=@{defense_dodge_drop_fail_note}}} {{customCriticalFailNote=@{defense_dodge_drop_critical_fail_note}}} {{showDBNotes=[[@{show_db_notes}]]}} {{DBNotes=@{defense_bonus_notes}}}" name="roll_vsDodgeDrop" />
									</div>
								</div> <!-- .row -->

								<div class="row row-details notebox">
								
									<div class="row hide-row"></div> <!-- .row needed to cause note to have background: todo: fix css -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
											</div>
											<span class="tooltip">
												<span data-i18n="reason-for-modifiers-skills-tooltip">
			Examples:<br />
			+1 from Talent...<br />
			+1 from Default Skill...<br />
			+1 from Enchanted Item with...
												</span>
											</span> 
										</div>
										<div class="cell col-input-wide">
											<input type="text" name="attr_defense_dodge_drop_mod_reason" title="Field name: defense_dodge_drop_mod_reason" />
										</div>
									</div>
									<div class="header">
										<div class="title">
											<div class="popup">
												<span data-i18n="notes-label">Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="custom-success-fail-notes-tooltip">
			Success, critical success, fail, and critical fail<br />
			notes will be added to roll results.<br />
			You can add macros to these notes.<br />
			The width of these note boxes are set to help you<br />
			visualize what it will look like in chat.
												</span>
											</span>
										</div>
									</div>
									<div class="row">
										
										<div class="show-notes">
											<input type="checkbox" name="attr_defense_dodge_drop_show_notes" value="1" style="float:left; margin-right: 5px;" />
											<div class="popup" style="float:left;">
												<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
											</div>
											<span class="tooltip">
												<span data-i18n="displayed-on-rolltemplate-tooltip">Displayed on the rolltemplate.</span>
											</span>
										</div>

									</div>
								
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<div class="popup">
													<span data-i18n="custom-notes-label">Custom Notes:</span>
												</div>
												<span class="tooltip">
													<span data-i18n="custom-notes-active-defense-tooltip">Add custom notes for this active defense.</span>
												</span>
											</div>
											<textarea name="attr_defense_dodge_drop_notes" title="Field name: defense_dodge_drop_notes" style="height: 50px"></textarea>
										</div>
										
									</div>

									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="success-note-label">Success Note:</span>
											</div>
											<textarea name="attr_defense_dodge_drop_success_note" title="Field name: defense_dodge_drop_success_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-success-note-label">Critical Success Note:</span>
											</div>
											<textarea name="attr_defense_dodge_drop_critical_success_note" title="Field name: defense_dodge_drop_critical_success_note"></textarea>
										</div>
										
									</div>
									
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<div data-i18n="fail-note-label">Fail Note:</div>
											</div>
											<textarea name="attr_defense_dodge_drop_fail_note" title="Field name: defense_dodge_drop_fail_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-fail-note-label">Critical Fail Note:</span>
											</div>
											<textarea name="attr_defense_dodge_drop_critical_fail_note" title="Field name: defense_dodge_drop_critical_fail_note"></textarea>
										</div>
										
									</div>
									
								</div> <!-- .row -->

							</div>
							
							<div class="row-static-defense">
								<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight_knockback" />
								<input class="toggle toggle-notes static-defense" type="checkbox" title="Click to show/hide more information." name="attr_defense_knockback_toggle_notes" />
								<span class="checkbox static-defense"></span>
								<div class="row row-stats row-standard static-defense-width">
									<div class="cell col-dodge-label">
										<div class="popup">
											<span data-i18n="knockback-label">Knockback save vs crushing or cutting attacks</span>
										</div>
										<span class="tooltip">
											<span data-i18n="knockback-tooltip">
			A <b>crushing</b> attack can cause knockback regardless of whether it penetrates DR.<br />
			A <b>cutting</b> attack can cause knockback only if it fails to penetrate DR.<br />
			For every full ST-2 damage (<b>BEFORE</b> subtracting DR) target is moved yard <i>away</i> from attacker.<br />
			<i>NOTE:</i> If target has no ST score (like a wall) or is not resisting, use HP instead.<br /><br />
			<b>If knocked back</b>, Roll against DX, Acrobatics, or Judo.<br />
			-1 per yard of knockback <b>AFTER</b> the first yard.<br />
			+4 for Perfect Balance. see B378.<br />
			If target collides with an object, use yards knocked back to calculate <i>Collisions and Falls</i> (see Combat Tools).
										</span>
									</div>
									<div class="cell col-dodge"></div>
									<div class="cell col1-plus-col2">
										<input type="hidden" name="attr_knockback_points" value="" />
										<span data-i18n="knockback-calculation-description">1 yard per <b><span name="attr_knockback_points"></span></b> points</span> 
									</div>
									<div class="cell col2"><input type="text" name="attr_ad_knockback_skill" value="10" title="Macro name: @{ad_knockback_skill}" /></div>
									<div class="cell col2"><input type="number" step="1" name="attr_ad_knockback_skill_mod" value="0" title="Macro name: @{ad_knockback_skill_skill_mod}" /></div>
									<div class="cell col3"><input type="text" name="attr_ad_knockback_skill_final" value="@{ad_knockback_skill} + @{ad_knockback_skill_mod}" disabled="disabled" title="Macro name: @{ad_knockback_skill_final}" /></div>
									<div class="cell col4">
										<input type="hidden" name="attr_raw_knockback_success_notes" value="Avoided falling prone, but check for collision." />
										<input type="hidden" name="attr_raw_knockback_critical_success_notes" value="Avoided falling prone, but check for collision." />
										<input type="hidden" name="attr_raw_knockback_fail_notes" value="Fall prone, but check for collision." />
										<input type="hidden" name="attr_raw_knockback_critical_fail_notes" value="Fall prone, but check for collision." />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Defense Roll}} {{defenseType=[[1]]}} {{activeDefense=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Avoid Knockback}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{ad_knockback_skill_final} + @{modifier} + @{defense_roll_modifier}, @{defense_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_defense_modifier_tool}]]}} {{maxNine=[[@{defense_roll_max_nine}]]}} {{rollModifier=[[@{defense_roll_modifier}]]}} {{rollModifierSummary=@{defense_roll_modifier_summary}}} {{rollTraitSummary=@{defense_roll_trait_summary}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showNotes=[[@{defense_knockback_show_notes}]]}} {{notes=@{defense_knockback_notes}}} {{showRawDefenseNotes=[[@{show_raw_defensive_notes}]]}} {{rawSuccessNote=@{raw_knockback_success_notes}}} {{rawCriticalSuccessNote=@{raw_knockback_critical_success_notes}}} {{rawFailNote=@{raw_knockback_fail_notes}}} {{rawCriticalFailNote=@{raw_knockback_critical_fail_notes}}} {{customSuccessNote=@{defense_knockback_success_note}}} {{customCriticalSuccessNote=@{defense_knockback_critical_success_note}}} {{customFailNote=@{defense_knockback_fail_note}}} {{customCriticalFailNote=@{defense_knockback_critical_fail_note}}} {{showDBNotes=[[@{show_db_notes}]]}} {{DBNotes=@{defense_bonus_notes}}}" name="roll_vsKnockback" />
									</div>
								</div> <!-- .row -->

								<div class="row row-details notebox">
								
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="link-label">Link:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="link-to-row-id-tooltip">Link this row to another row item.</span>
											</span> 
										</div>
										<input type="hidden" name="attr_knockback_defense_row_type" value="Skill" />
										<div class="cell">
											<select name="attr_knockback_defense_row_type">
												<option value=""><span data-i18n="option-select">--Select--</span></option>
												<option value="Skill"><span data-i18n="option-skill">Skill</span></option>
												<option value="Technique"><span data-i18n="option-technique">Technique</span></option>
												<option value="Spell"><span data-i18n="option-spell">Spell</span></option>
												<option value="ST"><span data-i18n="abbreviation-strength">ST</span></option>
												<option value="STRIKING"><span data-i18n="attribute-striking">Striking</span> <span data-i18n="abbreviation-strength">ST</span></option>
												<option value="DX" selected="selected"><span data-i18n="abbreviation-dexterity">DX</span></option>
												<option value="IQ"><span data-i18n="abbreviation-intelligence">IQ</span></option>
												<option value="WILL"><span data-i18n="will-label">WILL</span></option>
												<option value="HT"><span data-i18n="abbreviation-health">HT</span></option>
												<option value="10"><span data-i18n="abbreviation-health">10</span></option>
											</select>
										</div>
										<div class="cell col-row-id label show-hide-row-id">
											<div class="popup">
												<span data-i18n="row-id-label">Row ID:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="copy-paste-row-id-tooltip">
			Copy/paste the Skill or Spell Row ID to link that skill to this technique.<br />
			When the skill/spell is updated, the technique's parent name and base skill level<br />
			will be updated.<br />
			Once entered, this will change the Skill/Spell for this particular attack to match<br />
			the skill/spell level of the Base Skill. Do not change this skill Level number manually.
												</span>
											</span>	
										</div>
										<div class="cell col-input-medium show-hide-row-id">
											<input type="text" name="attr_defense_knockback_skill_row_id" title="Field name: defense_knockback_skill_row_id" />
										</div>
										<div class="cell col-wide">
										
											<b><span data-i18n="name-label">Name:</span></b>
											<input type="hidden" name="attr_defense_knockback_skill_row_id_message" value="" />
											<span name="attr_defense_knockback_skill_row_id_message"></span>
											
											<b><span data-i18n="skill-level-label">Level</span>:</b>
											<input type="hidden" name="attr_defense_knockback_skill_row_id_level" value="" />
											<span name="attr_defense_knockback_skill_row_id_level"></span>
										
										</div>
									</div> <!-- .row -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
											</div>
											<span class="tooltip">
												<span data-i18n="reason-for-modifiers-skills-tooltip">
			Examples:<br />
			+1 from Talent...<br />
			+1 from Default Skill...<br />
			+1 from Enchanted Item with...
												</span>
											</span> 
										</div>
										<div class="cell col-input-wide">
											<input type="number" value="0" step="1" name="attr_defense_knockback_mod_reason" title="Field name: defense_knockback_mod_reason" />
										</div>
									</div>
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="knockback-hitpoints-modifier-label">HP per yard Modifier:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="knockback-hitpoints-modifier-tooltip">Modify the number of hit points required for knockback.<br />For skinny, special rules, etc.</span>
											</span> 
										</div>
										<div class="cell col-input-number">
											<input type="text" name="attr_defense_knockback_hitpoints_mod" title="Field name: defense_knockback_hitpoints_mod" />
										</div>
									</div>

									<div class="header">
										<div class="title">
											<div class="popup">
												<span data-i18n="notes-label">Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="custom-success-fail-notes-tooltip">
			Success, critical success, fail, and critical fail<br />
			notes will be added to roll results.<br />
			You can add macros to these notes.<br />
			The width of these note boxes are set to help you<br />
			visualize what it will look like in chat.
												</span>
											</span>
										</div>
									</div>
									<div class="row">
										
										<div class="show-notes">
											<input type="checkbox" name="attr_defense_knockback_show_notes" value="1" style="float:left; margin-right: 5px;" />
											<div class="popup" style="float:left;">
												<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
											</div>
											<span class="tooltip">
												<span data-i18n="displayed-on-rolltemplate-tooltip">Displayed on the rolltemplate.</span>
											</span>
										</div>

									</div>
								
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<div class="popup">
													<span data-i18n="custom-notes-label">Custom Notes:</span>
												</div>
												<span class="tooltip">
													<span data-i18n="custom-notes-active-defense-tooltip">Add custom notes for this active defense.</span>
												</span>
											</div>
											<textarea name="attr_defense_knockback_notes" title="Field name: defense_knockback_notes" style="height: 50px"></textarea>
										</div>
										
									</div>

									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="success-note-label">Success Note:</span>
											</div>
											<textarea name="attr_defense_knockback_success_note" title="Field name: defense_knockback_success_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-success-note-label">Critical Success Note:</span>
											</div>
											<textarea name="attr_defense_knockback_critical_success_note" title="Field name: defense_knockback_critical_success_note"></textarea>
										</div>
										
									</div>
									
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<div data-i18n="fail-note-label">Fail Note:</div>
											</div>
											<textarea name="attr_defense_knockback_fail_note" title="Field name: defense_knockback_fail_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-fail-note-label">Critical Fail Note:</span>
											</div>
											<textarea name="attr_defense_knockback_critical_fail_note" title="Field name: defense_knockback_critical_fail_note"></textarea>
										</div>
										
									</div>
									
								</div> <!-- .row -->

							</div>

							<fieldset class="repeating_defense">
								<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight" />
								<input class="toggle toggle-notes" type="checkbox" title="Click to show/hide more information." name="attr_defense_toggle_notes" />
								<span class="checkbox"></span>
								<div class="row row-stats">
									<div class="cell col0">
										<input type="text" name="attr_name" title="Macro table name: repeating_defense. Field name: name" />
									</div>
									<div class="cell col1">
										<input type="hidden" name="attr_defense_type" value="0" />
										<select name="attr_type" title="Macro table name: repeating_defense. Field name: type">
											<option value="Dodge"><span data-i18n="option-dodge">Dodge</span></option>
											<option value="Parry"><span data-i18n="option-parry">Parry</span></option>
											<option value="Unarmed Parry"><span data-i18n="option-unarmed-parry">Unarmed Parry</span></option>
											<option value="Block"><span data-i18n="option-block">Block</span></option>
											<option value="Magic"><span data-i18n="option-magic">Magic</span></option>
											<option value="Power Dodge"><span data-i18n="option-power-dodge">Power Dodge</span></option>
											<option value="Power Parry"><span data-i18n="option-power-parry">Power Parry</span></option>
											<option value="Power Block"><span data-i18n="option-power-block">Power Block - Physical</span></option>
											<option value="Power Block Mental"><span data-i18n="option-power-block">Power Block - Mental</span></option>
											<option value="Other"><span data-i18n="option-other">Other</span></option>
										</select>
									</div>
									<div class="cell col2">
										<input type="text" name="attr_info" title="Macro table name: repeating_defense. Field name: info" />
									</div>
									<div class="cell col2">
										<input type="number" step="1" value="10" name="attr_skill" title="Macro table name: repeating_defense. Field name: @{skill}" />
									</div>
									<div class="cell col2">
										<input type="number" step="1" value="0" name="attr_skill_mod" title="Macro table name: repeating_defense. Field name: skill_mod" />
									</div>
									<div class="cell col3">
										<input type="text" name="attr_skill_final" value="@{skill} + @{skill_mod}" disabled="disabled" title="Macro table name: repeating_defense. Field name: skill_final" />
									</div>
									<div class="cell col4">
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Defense Roll (@{type})}} {{defenseType=[[@{defense_type}]]}} {{activeDefense=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{skill_final} + @{modifier} + @{defense_roll_modifier}, @{defense_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_defense_modifier_tool}]]}} {{maxNine=[[@{defense_roll_max_nine}]]}} {{rollModifier=[[@{defense_roll_modifier}]]}} {{rollModifierSummary=@{defense_roll_modifier_summary}}} {{rollTraitSummary=@{defense_roll_trait_summary}}} {{showNotes=[[@{show_notes}]]}} {{notes=@{info_description} @{notes} }} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{showRawDefenseNotes=[[@{show_raw_defensive_notes}]]}} {{rawSuccessNote=@{raw_success_note}}} {{rawCriticalSuccessNote=@{raw_critical_success_note}}} {{rawFailNote=@{raw_fail_note}}} {{rawCriticalFailNote=@{raw_critical_fail_note}}} {{customSuccessNote=@{defense_success_note}}} {{customCriticalSuccessNote=@{defense_critical_success_note}}} {{customFailNote=@{defense_fail_note}}} {{customCriticalFailNote=@{defense_critical_fail_note}}}" name="roll_vsSL" />
									</div>
								</div> <!-- .row -->
								
								<div class="row row-details notebox">
								
									<input type="hidden" name="attr_type" />
									<div class="row active-defense-formula">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="formula-label">Formula:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="active-defense-formula-tooltip">Formula is based upon the active defense type.</span>
											</span> 
										</div>
										<div class="cell col-input-wide">
											<div class="formula formula-as-is">
												<span data-i18n="formula-as-is-description">Enter a value or use the linked item value as is.</span>
											</div>
											<div class="formula formula-parry">
												<span data-i18n="formula-parry-description">3 + (Skill or DX)/2, rounded down.</span>
											</div>
											<div class="formula formula-block">
												<span data-i18n="formula-block-description">3 + (Shield or Cloak skill)/2, rounded down.</span>
											</div>
											<div class="formula formula-power-dodge">
												<span data-i18n="power-dodge-description">Basic Speed + 3 + Talent/2, rounded down.</span>
											</div>
											<div class="formula formula-power-parry">
												<span data-i18n="power-parry-description">3 + (Innate Attack Skill + Talent)/2, rounded down.</span>
											</div>
											<div class="formula formula-power-block-physical">
												<span data-i18n="power-block-physical-description">3 + (HT + Talent)/2, rounded down.</span>
											</div>
											<div class="formula formula-power-block-mental">
												<span data-i18n="power-block-mental-description">3 + (WILL + Talent)/2, rounded down.</span>
											</div>
										</div>
									</div>

									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="link-label">Link:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="link-to-row-id-tooltip">Link this row to another row item.</span>
											</span> 
										</div>
										<div class="cell">
											<select name="attr_defense_row_type">
												<option value=""><span data-i18n="option-select">--Select--</span></option>
												<option value="Skill"><span data-i18n="option-skill">Skill</span></option>
												<option value="Technique"><span data-i18n="option-technique">Technique</span></option>
												<option value="Spell"><span data-i18n="option-spell">Spell</span></option>
												<option value="Melee"><span data-i18n="option-melee-weapon">Melee Weapon</span></option>
												<option value="ST"><span data-i18n="abbreviation-strength">ST</span></option>
												<option value="STRIKING"><span data-i18n="attribute-striking">Striking</span> <span data-i18n="abbreviation-strength">ST</span></option>
												<option value="DX"><span data-i18n="abbreviation-dexterity">DX</span></option>
												<option value="IQ"><span data-i18n="abbreviation-intelligence">IQ</span></option>
												<option value="WILL"><span data-i18n="will-label">WILL</span></option>
												<option value="HT"><span data-i18n="abbreviation-health">HT</span></option>
												<option value="SPEED"><span data-i18n="option-basic-speed">Basic Speed</span></option>
												<option value="DODGE"><span data-i18n="option-dodge">Dodge</span></option>
												<option value="10"><span data-i18n="abbreviation-health">10</span></option>
											</select>
										</div>
										<div class="cell col-row-id label show-hide-row-id">
											<div class="popup">
												<span data-i18n="row-id-label">Row ID:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="copy-paste-row-id-tooltip">
			Copy/paste the Skill or Spell Row ID to link that skill to this technique.<br />
			When the skill/spell is updated, the technique's parent name and base skill level<br />
			will be updated.<br />
			Once entered, this will change the Skill/Spell for this particular attack to match<br />
			the skill/spell level of the Base Skill. Do not change this skill Level number manually.
												</span>
											</span>	
										</div>
										<div class="cell col-input-medium show-hide-row-id">
											<input type="hidden" name="attr_defense_skill_row_id_toggle" value="0" />
											<input type="text" name="attr_defense_skill_row_id" title="Macro table name: repeating_defense. Field name: defense_skill_row_id" />
										</div>
										
									</div> <!-- .row -->

									<div class="row linked-stats">

										<div class="cell">
											<input type="hidden" name="attr_skill" value="" />
											<b><span data-i18n="name-label">Name:</span></b>
											<input type="hidden" name="attr_defense_skill_row_id_message" value="" />
											<span name="attr_defense_skill_row_id_message"></span>
										</div>		
										
										<div class="cell">
											<b><span data-i18n="skill-level-label">Level</span>:</b>
											<input type="hidden" name="attr_defense_skill_row_id_level" value="" />
											<span name="attr_defense_skill_row_id_level"></span>
										</div>

										<div class="cell formula-talent">
											<b><span data-i18n="talent-level-label">Talent Level:</span></b>
											<input type="number" value="0" step="1" min="0" name="attr_defense_talent_level" />
										</div>

										<div class="cell">
											<b><span data-i18n="formula-level-label">Formula Level:</span></b>
											<input type="hidden" name="attr_defense_formula_level" value="" />
											<span name="attr_defense_formula_level"></span>
										</div>
											
									</div> <!-- .row -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
											</div>
											<span class="tooltip">
												<span data-i18n="reason-for-modifiers-skills-tooltip">
			Examples:<br />
			+1 from Talent...<br />
			+1 from Default Skill...<br />
			+1 from Enchanted Item with...
												</span>
											</span> 
										</div>
										<div class="cell col-input-wide">
											<input type="text" name="attr_defense_mod_reason" title="Field name: defense_mod_reason" />
										</div>
									</div>

									<div class="header">
										<div class="popup">
											<span data-i18n="notes-label">Notes</span>
										</div>
										<span class="tooltip">
											<span data-i18n="custom-success-fail-notes-tooltip">
			Success, critical success, fail, and critical fail<br />
			notes will be added to roll results.<br />
			You can add macros to these notes.<br />
			The width of these note boxes are set to help you<br />
			visualize what it will look like in chat.
											</span>
										</span>
									</div>
									<div class="row">
										
										<div class="show-notes">
											<input type="checkbox" name="attr_show_notes" value="1" style="float:left; margin-right: 5px;" />
											<div class="popup" style="float:left;">
												<span data-i18n="show-notes-below-label">Show notes below in roll template</span>	
											</div>
											<span class="tooltip">
												<span data-i18n="displayed-on-rolltemplate-tooltip">Displayed on the rolltemplate.</span>
											</span>
										</div>

									</div>
								
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<div class="popup">
													<span data-i18n="abbreviation-information-notes">INFO Notes</span>
												</div>
												<span class="tooltip">
													<span data-i18n="fencing-unbalanced-tooltip">
			If you enter F or U under the <b>INFO</b> column, the notes <br />
			below will be <b>replaced</b> with appropriate notes. <br />
			Any other value, and the text box will get <b>cleared</b> out.<br />
													</span>
												</span>
											</div>
											<textarea name="attr_info_description" title="Macro table name: repeating_defense. Field name: info_description" style="height: 50px"></textarea>
										</div>

										<div class="note-input">
											<div class="note-title">
												<div class="popup">
													<span data-i18n="custom-notes-label">Custom Notes:</span>
												</div>
												<span class="tooltip">
													<span data-i18n="custom-notes-active-defense-tooltip">Add custom notes for this active defense.</span>
												</span>
											</div>
											<textarea name="attr_notes" title="Macro table name: repeating_defense. Field name: notes" style="height: 50px"></textarea>
										</div>
										
									</div>

									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="success-note-label">Success Note:</span>
											</div>
											<input type="hidden" name="attr_raw_success_note" />
											<textarea name="attr_defense_success_note" title="Macro table name: repeating_defense. Field name: defense_success_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-success-note-label">Critical Success Note:</span>
											</div>
											<input type="hidden" name="attr_raw_critical_success_note" />
											<textarea name="attr_defense_critical_success_note" title="Macro table name: repeating_defense. Field name: defense_critical_success_note"></textarea>
										</div>
										
									</div>
									
									<div class="rolltable-result-notes">
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="fail-note-label">Fail Note:</span>
											</div>
											<input type="hidden" name="attr_raw_fail_note" />
											<textarea name="attr_defense_fail_note" title="Macro table name: repeating_defense. Field name: defense_fail_note"></textarea>
										</div>
										
										<div class="note-input">
											<div class="note-title">
												<span data-i18n="critical-fail-note-label">Critical Fail Note:</span>
											</div>
											<input type="hidden" name="attr_raw_critical_fail_note" />
											<textarea name="attr_defense_critical_fail_note" title="Macro table name: repeating_defense. Field name: defense_critical_fail_note"></textarea>
										</div>
										
									</div>
									
								</div> <!-- .row -->
								
							</fieldset> <!-- .repeating_defense -->

							<!-- _____ _____ DEFENSE BONUS BOX _____ _____ -->
							<div class="box defense-bonus-notes textarea">
								
								<div class="combat-reflexes">
									
									<div style="float: left;">
										<input type="checkbox" class="boolean combat-reflex-check" name="attr_combat_reflexes" value="1" />
										<div class="popup">
											<span data-i18n="apply-combat-reflexes-label">Apply Combat Reflexes</span>
										</div>
										<span class="tooltip">
											<span data-i18n="apply-combat-reflexes-tooltip">Quickly add +1 Dodge modifier and +2 Fright modifier on the General page. (B43)</span>
										</span>
									</div>

									<div style="float: left;"   >
										<input type="checkbox" class="boolean combat-reflex-check" name="attr_show_db_notes" value="1" />
										<div class="popup">
											<span data-i18n="show-defense-bonus-label">Show DB Notes</span>
										</div>
										<span class="tooltip">
											<span data-i18n="show-defense-bonus-tooltip">Show Defense Bonus Notes in roll results.</span>
										</span>
									</div>

								</div> <!-- .row -->
								
								<div class="header">
									<div>
										<div class="popup">
											<span data-i18n="defense-bonus-notes-label">Defense Bonus (DB) Notes</span>
										</div>
										<span class="tooltip">
											<span data-i18n="defense-bonus-notes-tooltip">
				<strong>Examples:</strong><br/>
				+2 DB for Torso (Front Only), Skull, Neck, Hands, Head (1/6 Face), and Feet. Armor Enchantment: Deflect.<br/>
				+1 DB SHIELD SIDE (Left): from Small Shield.<br/>
				+1 DB for Rear only - (All but head unless hood is up). From Heavy Cloak.
											</span>
										</span>
									</div>
								</div>
								<div class="defense-bonus-notes-textarea">
									<textarea name="attr_defense_bonus_notes" title="Macro name: defense_bonus_notes"></textarea>
								</div>
							</div>
							
						</div> <!-- .table -->
					</div> <!-- .box .active-defense -->

					
				</div>

				<div class="melee">

					<div class="box speed-range-images">
						
						<div class="group">
							<div class="custom-checkbox">
								<label class="switch">
									<!-- if checked, user has option to select token before rolling -->
									<input type="hidden" name="attr_selected_token_macro" />
									<input type="checkbox" name="attr_selected_token" />
									<span class="icon select"></span>
								</label>
							</div>
							<div class="select-popup">
								<div class="popup">
									<span>Select</span>
								</div>
								<span class="tooltip">
									<span data-i18n="select-token-tooltip">Click the button to turn on <b>select a token</b> before the skill roll.<br />The token name will appear in the results.</span>
								</span>
							</div>
							<div class="custom-checkbox target">
								<label class="switch">
									<!-- if checked, user has option to target token before rolling -->
									<input type="hidden" name="attr_target_token_macro" />
									<input type="checkbox" name="attr_target_token" />
									<span class="icon target"></span>
								</label>
							</div>
							<div>
								<div class="popup">
									<span>Target</span>
								</div>
								<span class="tooltip">
									<span data-i18n="target-token-tooltip">Click the button to turn on <b>target a token</b> before the skill roll.<br />The token name will appear in the results.</span>
								</span>
							</div>
						</div>
						
					</div>

					<!-- _____ _____ MELEE ATTACKS BOX _____ _____ -->
					<div class="box melee-attacks">
						<div class="table">
							<div class="header">
								<div class="cell col-mod-tool">
									<!-- <input class="toggle-mod-tool" disabled="disabled" value="1" type="checkbox" title="Click to show/hide attack modifiers." name="attr_toggle_melee_mod_tool" /> -->
									<span class="icon">y</span>
								</div>
								<div class="cell col0">
									<div class="popup">
										<span data-i18n="melee-attacks-label">Melee Attacks</span>	
									</div>
									<span class="tooltip">
										<span data-i18n="activate-custom-roll-modifier-tooltip">To turn on the custom modifiers and button to open the <b>Roll Modifier</b> dialog box goto the <b>Sheet Options</b> tab and check off the tools you would like to user under <b>Skill Modifier Tools</b> section.</span>
									</span>
								</div>
								<div class="cell col1">
									<div class="popup"><span data-i18n="damage-label">Damage</span></div>
									<span class="tooltip">
										<span data-i18n="melee-attack-damage-tooltip">For an <strong>Armor Divisor</strong>: A number in parenthesis after<br />the damage - eg. (2) - is an armor divisor.<br />Enter this number in the <strong>Damage Notes</strong> as AD(#)  or as<br />Armor Divisor(#).<br /><strong>ex</strong>: indicates the attack causes an explosion.<br />See B269. Enter in the <strong>Damage Notes</strong></span>
									</span>
								</div>
								<div class="cell col2"> </div>
								<div class="cell col3">
									<div class="popup">
										<span data-i18n="type-label">Type</span>
									</div>
									<span class="tooltip">
										<span data-i18n="damage-type-tooltip">
			<table>
				<thead>
					<tr>
						<th>Abbr</th>
						<th>Name</th>
					</tr>
				</thead>
				<tbody>
					<tr><td>aff</td> <td>Affliction</td></tr>
					<tr><td>burn</td><td>Burning</td></tr>
					<tr><td>cor</td> <td>Corrosion</td></tr>
					<tr><td>cr</td>  <td>Crushing</td></tr>
					<tr><td>cut</td> <td>Cutting</td></tr>
					<tr><td>fat</td> <td>Fatigue</td></tr>
					<tr><td>imp</td> <td>Impaling</td></tr>
					<tr><td>pi-</td> <td>Small Piercing</td></tr>
					<tr><td>pi</td>  <td>Piercing</td></tr>
					<tr><td>pi+</td> <td>Large Piercing</td></tr>
					<tr><td>pi++</td><td>Huge Piercing</td></tr>
					<tr><td>spec</td><td>Special</td></tr>
					<tr><td>tox</td> <td>Toxic</td></tr>
				</tbody> 
			</table>
										</span>
									</span>
								</div>
								<div class="cell col4">
									<div class="popup">
										<span data-i18n="reach-label">Reach</span>
									</div>
									<span class="tooltip">
										<span data-i18n="melee-reach-tooltip">
			The distance in yards that the weapon can reach.<br />
			<strong>C</strong>: this weapon can be used in close combat.<br />
			<strong>*</strong>: the weapon is awkward, and requires a Ready<br />
			maneuver to switch between different reaches.
										</span>
									</span>
								</div>
								<div class="cell col5">
									<span style="background-color: #87CEFA">| <span data-i18n="skill-label">skill</span> |</span>
								</div>

							</div> <!-- .header -->

							<!-- attr_use_melee_modifier_tool is linked to checkbox on options sheet -->
							<input type="hidden" name="attr_use_melee_modifier_tool" value="0" />
							<div class="row roll-modifiers">
								<div class="cell label">
									<div class="popup">
										<span data-i18n="modifier-label">Modifier:</span>
									</div>
									<div class="tooltip">
										<span data-i18n="modifier-dialog-tooltip">Enter a modifier to apply to any rolls on the this table.<br />Use the pencil/paper icon to select modifiers.<br /><b>NOTE:</b> Changing the modifier or check status of <i>Max skill of 9</i> will clear modifiers used by dialog box.</span>
									</div>
								</div>
								<div class="cell number-input">
									<input type="number" value="0" step="1" name="attr_melee_roll_modifier" />
									<input type="hidden" value="" name="attr_melee_roll_modifier_summary" />
									<input type="hidden" value="" name="attr_melee_roll_trait_summary" />
									<input type="hidden" value="" name="attr_melee_roll_hit_location" />
									<input type="hidden" value="" name="attr_melee_roll_maneuver" />
									<input type="hidden" value="" name="attr_melee_roll_allout_attack" />
								</div>
								<div class="cell">
									<button type="action" name="act_show_roll_modifiers_for_melee" class="btn" title="Select Skill Modifiers"><span data-i18n="select-skill-modifiers-button">Select Skill Modifiers</span></button>
								</div>
								<div class="cell cell-popup">
									<div>
										<input type="checkbox" name="attr_melee_roll_max_nine" value="1" title="Macro: @{melee_roll_max_nine}" />
										<input type="hidden" name="attr_melee_roll_max_nine_value" value="100" />
									</div>
									<div>
										<div class="popup">
											<span data-i18n="max-skill-9-label">Max skill of 9</span>
										</div>
										<div class="tooltip max-skill-9">
											<span data-i18n="max-skill-9-tooltip">The effective skill cannot exceed 9.</span>
										</div>
									</div>
								</div>
								<div class="cell">
									<button type="action" name="act_melee_roll_reset" class="btn tool-modifier-reset" title="Reset Skill Modifiers"><span data-i18n="reset-label">Reset</span></button>
								</div>
								<div class="cell">
									<div class="summary-group">
										<div class="icon"><span data-i18n="notes-label">Notes</span></div>
										<div class="summary">
											<div class="roll-maneuver">
												<b>Maneuver:</b>
												<div>
													<span name="attr_melee_roll_hit_location"></span>
												</div>
											</div>
											<div class="roll-maneuver">
												<b>All-Out Attack:</b>
												<div>
													<span name="attr_melee_roll_allout_attack"></span>
												</div>
											</div>
											<div class="roll-maneuver">
												<b>Hit Location:</b>
												<div>
													<span name="attr_melee_roll_maneuver"></span>
												</div>
											</div>
											<div class="roll-traits">
												<b>Traits:</b>
												<div>
													<span name="attr_melee_roll_trait_summary"></span>
												</div>
											</div>
											<div class="roll-summary">
												<b>Summary:</b>
												<div>
													<span name="attr_melee_roll_modifier_summary"></span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							
							<fieldset class="repeating_melee">
								<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight" />
								<input class="toggle toggle-notes" type="checkbox" title="Click to show/hide more information." name="attr_melee_toggle_notes" />
								<span class="checkbox"></span>
								<div class="row row-stats">
									<div class="cell col0">
										<!-- idkey is the key used by either GCA or GCS. Can be used to update and advantage instead of just adding -->
										<input type="hidden" name="attr_idkey" />
										<input type="text" name="attr_name" title="Macro table name: repeating_melee. Field name: name" />
									</div>
									<div class="cell col1">
										<input type="text" name="attr_damage" title="Macro table name: repeating_melee. Field name: damage" />
									</div>
									<div class="cell col2">
										<input type="hidden" name="attr_damage_dice_icon" class="melee-damage-dice-icon" value="explode" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Melee Damage}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{damageRoll=[[@{damage}]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=@{minimum_damage_note}}} {{damageType=@{type}}} {{useDamageTypeNotes=[[@{use_damage_type_notes}]]}} {{damageTypeNote=@{damage_type_note}}} {{showNotes=[[1]]}} {{notes=@{damage_notes}}} {{armorDivisor=[[@{armor_divisor}]]}}" name="roll_damage" class="roll_damage" />
									</div>
									<div class="cell col3">
										<select name="attr_type" title="Macro table name: repeating_melee. Field name: type">
											<option value="Affliction (aff)"><span data-i18n="abbreviation-option-affliction">aff</span></option>
											<option value="Burning (burn)"><span data-i18n="abbreviation-option-burning">burn</span></option>
											<option value="Corrosion (cor)"><span data-i18n="abbreviation-option-corrosion">cor</span></option>
											<option value="Crushing (cr)"><span data-i18n="abbreviation-option-crushing">cr</span></option>
											<option value="Cutting (cut)"><span data-i18n="abbreviation-option-cutting">cut</span></option>
											<option value="Fatigue (fat)"><span data-i18n="abbreviation-option-fatigue">fat</span></option>
											<option value="Impaling (imp)"><span data-i18n="abbreviation-option-impaling">imp</span></option>
											<option value="Small Piercing (pi-)"><span data-i18n="abbreviation-option-piercing-minus">pi-</span></option>
											<option value="Piercing (pi)"><span data-i18n="abbreviation-option-piercing">pi</span></option>
											<option value="Large Piercing (pi+)"><span data-i18n="abbreviation-option-piercing-plus">pi+</span></option>
											<option value="Huge Piercing (pi++)"><span data-i18n="abbreviation-option-piercing-plus-plus">pi++</span></option>
											<option value="Special (spec)"><span data-i18n="abbreviation-option-special">spec</span></option>
											<option value="Knockback (knock)"><span data-i18n="abbreviation-option-knockback">knock</span></option>
											<option value="Toxic (tox)"><span data-i18n="abbreviation-option-toxic">tox</span></option>
										</select>
										<input type="hidden" name="attr_damage_type_note" value="@{damage_type_note_aff}" />
										<input type="hidden" name="attr_minimum_damage_note" value="Min 1" />
									</div>
									<div class="cell col4">
										<input type="text" name="attr_reach" title="Macro table name: repeating_melee. Field name: reach" />
									</div>
									<div class="cell col5">
										<input type="text" name="attr_skill" title="Macro table name: repeating_melee. Field name: skill" />
									</div>
									<div class="cell col6">
										<button type="roll" class="template-attack-roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Melee Attack}} {{selected=@{selected_token_macro}}} {{target1=@{target_token_macro}}} {{activeDefense=[[0]]}} {{isSkillRoll=[[1]]}} {{showHitLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{skill} + @{modifier} + @{melee_roll_modifier}, @{melee_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_melee_modifier_tool}]]}} {{maxNine=[[@{melee_roll_max_nine}]]}} {{rollModifier=[[@{melee_roll_modifier}]]}} {{rollModifierSummary=@{melee_roll_modifier_summary}}} {{rollTraitSummary=@{melee_roll_trait_summary}}} {{hitLocation=@{melee_roll_hit_location}}} {{maneuver=@{melee_roll_maneuver}}} {{allOutAttack=@{melee_roll_allout_attack}}} {{reach=@{reach}}} {{notes=@{notes}}} {{showNotes=[[1]]}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsSL" />
									</div>
								</div> <!-- .row -->
								<div class="melee-notebox">

									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="row-id-label">Row ID:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="melee-row-id-tooltip">Use the melee row id to link an active defense to this skill.<br />This allows you to use your enhanced skill with this weapon for parries.</span>
											</span> 
										</div>
										<div class="cell">
											<input type="text" readonly="readonly" name="attr_row_id" value="" />
										</div>
										
									</div> <!-- .row -->


									<div class="row">
										<!-- hidden input is used to show/hide Row ID: based on selection -->
										<input type="hidden" name="attr_melee_row_type" value="Skill" />
										<div class="cell margin-right">
											<select name="attr_melee_row_type">
												<option value="Skill"><span data-i18n="option-skill">Skill</span></option>
												<option value="Spell"><span data-i18n="option-spell">Spell</span></option>
												<option value="Technique"><span data-i18n="option-technique">Technique</span></option>
												<option value="ST"><span data-i18n="abbreviation-strength">ST</span></option>
												<option value="STRIKING"><span data-i18n="attribute-striking">Striking</span> <span data-i18n="abbreviation-strength">ST</span></option>
												<option value="DX"><span data-i18n="abbreviation-dexterity">DX</span></option>
												<option value="IQ"><span data-i18n="abbreviation-intelligence">IQ</span></option>
												<option value="WILL"><span data-i18n="will-label">WILL</span></option>
												<option value="HT"><span data-i18n="abbreviation-health">HT</span></option>
												<option value="10"><span data-i18n="abbreviation-health">10</span></option>
											</select>
										</div>
										<div class="cell col-row-id label show-hide-row-id">
											<div class="popup">
												<span data-i18n="row-id-label">Row ID:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="copy-paste-row-id-tooltip">
			Copy/paste the Skill or Spell Row ID to link that skill to this technique.<br />
			When the skill/spell is updated, the technique's parent name and base skill level<br />
			will be updated.<br />
			Once entered, this will change the Skill/Spell for this particular attack to match<br />
			the skill/spell level of the Base Skill. Do not change this skill Level number manually.
												</span>
											</span>	
										</div>
										<div class="cell col-input-medium show-hide-row-id">
											<input type="hidden" name="attr_melee_skill_row_id_toggle" value="0" />
											<input type="text" name="attr_melee_skill_row_id" title="Macro table name: repeating_melee. Field name: melee_skill_row_id" />
										</div>
										
										<div class="cell">
											<div class="popup">
												<span data-i18n="abbreviation-modifier-label">Mod</span>
											</div>
											<div class="tooltip tooltip-skills-ref">
												<span data-i18n="modifier-tooltip">
			Enter the net value of all modifiers combined.<br />
			Can be a positive or a negative number.<br />
			Example: Enter 2 for Weapon’s Bond (+1) plus Magic (Accuracy: +1).<br />
			Once entered, this will change the Skill/Spell Level for this <b>particular</b><br />
			weapon to match the Base Skill/Spell level plus this MOD (Modifier).<br />
			Do not change this level number manually.
												</span>
											</div>
										</div>
										<div class="cell">
											<input type="number" value="0" name="attr_melee_skill_row_id_modifier" class="inline" title="Macro table name: repeating_melee. Field name: melee_skill_row_id_modifier" />
										</div>
								
										<div class="cell col-wide">
											<input type="hidden" name="attr_melee_skill_row_id_message" value="" />
											<b><span data-i18n="name-label">Name:</span></b>
											<span name="attr_melee_skill_row_id_message"></span>
											<input type="hidden" name="attr_melee_skill_row_id_level" value="" />
											<b><span data-i18n="skill-level-label">Level</span>:</b>
											<span name="attr_melee_skill_row_id_level"></span>
										</div>
									</div> <!-- .row -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
											</div>
											<span class="tooltip">
												<span data-i18n="reason-for-modifiers-skills-tooltip">
			Examples:<br />
			+1 from Talent...<br />
			+1 from Default Skill...<br />
			+1 from Enchanted Item with...
												</span>
											</span>
										</div>
									
										<div class="cell reason-for-mod">
											<input type="text" name="attr_reason_for_mod" title="Macro table name: repeating_melee. Field name: reason_for_mod" />
										</div>

									</div><!-- .row -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="armor-divisor-label">Armor Divisor</span>:
											</div>
											<span class="tooltip">
												<span data-i18n="armor-divisor-tooltip">Divide the target's armor DR by this number before subtracting damage<br />or (adding it adding it to the HT roll for an affliction). See B268.<br /><b>Explosive</b> attacks (optional house rule: area effect attacks) only apply divisor to target of direct hit. See B269.<br /><b>Afflictions</b> divide the armor DR <i>before</i> determining bonus to HT roll. See B269</span>
											</span>	
										</div>
										<div class="cell">
											<input type="number" class="inline" name="attr_armor_divisor" value="1" min="1" step="1" title="Macro table name: repeating_melee. Field name: armor_divisor" />
										</div>
									</div> <!-- .row -->
									
									<div class="row">
										<div class="cell">
											<div class="popup">
												<span data-i18n="weapon-notes-label">Weapon Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="melee-weapon-notes-tooltip">
			<strong>Hint:</strong> Enter inline rolls for additional results. To show the selected arrow.<br />
			Example: Select Location: ?{Location|Head|Torso}
												</span>
											</span>
											<textarea class="text-left chat-size" name="attr_notes" title="Macro table name: repeating_melee. Field name: notes"></textarea>
										</div>
										<div class="cell">
											<div class="popup">
												<span data-i18n="damage-notes-label">Damage Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="melee-damage-notes-tooltip">
			<strong>Hint:</strong> Enter inline rolls for additional results.<br />
			Example: Does an additional [[1d6]] fire damage.
												</span>
											</span>
											<textarea class="text-left chat-size" name="attr_damage_notes" title="Macro table name: repeating_melee. Field name: damage_notes"></textarea>
										</div>
									</div> <!-- .row -->
									
								</div> <!-- .ranged-notebox -->
							</fieldset> <!-- .repeating_melee -->
						</div> <!-- .table -->
					</div> <!-- .box .melee-attacks -->

				</div>

				<div class="ranged">

					<!-- tables -->
					<div class="box speed-range-images">

						<div class="group">
							<div class="custom-checkbox">
								<label class="switch">
									<!-- if checked, user has option to select token before rolling -->
									<input type="hidden" name="attr_selected_token_macro" />
									<input type="checkbox" name="attr_selected_token" />
									<span class="icon select"></span>
								</label>
							</div>
							<div class="select-popup">
								<div class="popup">
									<span>Select</span>
								</div>
								<span class="tooltip">
									<span data-i18n="select-token-tooltip">Click the button to turn on <b>select a token</b> before the skill roll.<br />The token name will appear in the results.</span>
								</span>
							</div>
							<div class="custom-checkbox target">
								<label class="switch">
									<!-- if checked, user has option to target token before rolling -->
									<input type="hidden" name="attr_target_token_macro" />
									<input type="checkbox" name="attr_target_token" />
									<span class="icon target"></span>
								</label>
							</div>
							<div>
								<div class="popup">
									<span>Target</span>
								</div>
								<span class="tooltip">
									<span data-i18n="target-token-tooltip">Click the button to turn on <b>target a token</b> before the skill roll.<br />The token name will appear in the results.</span>
								</span>
							</div>
						</div>
						
						<div class="rapid-fire-table">
							<img src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/GURPS/Images/Rapid_Fire_Table.png" title="Rapid Fire Table: B373. Additional Rules B408." alt="Rapid Fire Table" />
						</div>
						<div class="speed-range-table"> <!-- .speed-range-table image-->
							<img src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/GURPS/Images/Speed_Range_Table.PNG"  title="Speed/Range Table: B550" alt="GURPS Speed/Range Table" /> 
						</div> <!-- .speed-range-table image-->

					</div>
					
					<!-- _____ _____ RANGED ATTACKS BOX _____ _____ -->
					<div class="box ranged-attacks">
						<div class="table">
							<div class="header">
								<div class="cell col0">
									<div class="popup">
										<span data-i18n="ranged-attacks-label">Ranged Attacks</span>
									</div>
									<span class="tooltip">
										<span data-i18n="activate-custom-roll-modifier-tooltip">To turn on the custom modifiers and button to open the <b>Roll Modifier</b> dialog box goto the <b>Sheet Options</b> tab and check off the tools you would like to user under <b>Skill Modifier Tools</b> section.</span>
									</span>
								</div>
								<div class="cell col1">
									<div class="popup">
										<span data-i18n="damage-label">Damage</span>
									</div>
									<span class="tooltip">
										<span data-i18n="ranged-damage-tooltip">
			For an <strong>Armor Divisor</strong>: A number in parenthesis after<br />
			the damage - eg. (2) - is an armor divisor.<br />
			Enter this number in the <strong>Damage Notes</string> as AD(#)  or as<br />
			Armor Divisor(#).<br />
			<strong>ex</strong>: indicates the attack causes an explosion.<br />
			<strong>[#d]</strong>: indicates the attack causes fragmentation.<br />
			See B269. Enter in the <string>Damage Notes</string>
										</span>
									</span>
								</div>
								<div class="cell col2"></div>
								<div class="cell col3">
									<div class="popup">
										<span data-i18n="type-label">Type</span>
									</div>
									<span class="tooltip">
										<span data-i18n="damage-type-tooltip">
			<table>
				<thead>
					<tr>
						<th>Abbr</th>
						<th>Name</th>
					</tr>
				</thead>
				<tbody>
					<tr><td>aff</td> <td>Affliction</td></tr>
					<tr><td>burn</td><td>Burning</td></tr>
					<tr><td>cor</td> <td>Corrosion</td></tr>
					<tr><td>cr</td>  <td>Crushing</td></tr>
					<tr><td>cut</td> <td>Cutting</td></tr>
					<tr><td>fat</td> <td>Fatigue</td></tr>
					<tr><td>imp</td> <td>Impaling</td></tr>
					<tr><td>pi-</td> <td>Small Piercing</td></tr>
					<tr><td>pi</td>  <td>Piercing</td></tr>
					<tr><td>pi+</td> <td>Large Piercing</td></tr>
					<tr><td>pi++</td><td>Huge Piercing</td></tr>
					<tr><td>spec</td><td>Special</td></tr>
					<tr><td>tox</td> <td>Toxic</td></tr>
				</tbody>
			</table>
										</span>
									</span>
								</div>					
								<div class="cell col4">
									<span data-i18n="abbreviation-accuracy-label">Acc</span>
								</div>
								<div class="cell col5">
									<div class="popup">
										<span data-i18n="abbreviation-range-label">RNG</span>
									</div>
									<span class="tooltip">
										<span data-i18n="range-tooltip">Range. See B269.</span>
									</span>
								</div>					
								<div class="cell col6">
									<div class="popup">
										<span data-i18n="abbreviation-rate-of-fire-label">RoF</span>
									</div>
									<span class="tooltip">
										<span data-i18n="rate-of-fire-tooltip">
			Rate of Fire<br />
			The maximum number of shots that can be fired in <br />
			one turn (by a regular person).<br />
			The minimum number of shots is 1.<br /><br />
			<strong>!</strong>: minimum RoF is 1/4 of the maximum, rounded up.<br />
			<strong>mxn</strong>: fires the first number of shots, which each then<br />
			split into the second number (eg. shotguns)<br />
			<strong>Jet</strong>: shoots a continuous stream of fluid. See page 106.
										</span>
									</span>
								</div>
								<div class="cell col7">
									<div class="popup">
										<span data-i18n="shots-label">Shots</span>
									</div>
									<span class="tooltip">
										<span data-i18n="shots-tooltip">
			The number of shots that can be fired before the<br />
			weapon must be reloaded.<br />
			The parenthetical number indicates the number of 1<br />
			second ready maneuvers required to reload the<br />
			weapon.<br />
			<strong>T</strong>: the weapon is thrown. To "reload" it, pick it up.<br />
			<strong>i</strong>: you must load the shots individually. the listed<br />
			time is for each shot.
										</span>
									</span>
								</div>
								<div class="cell col8">
									<div class="popup">
										<span data-i18n="bulk-label">Bulk</span>
									</div>
									<span class="tooltip">
										<span data-i18n="bulk-tooltip">
			<strong>Move and Attack</strong>: If you are making a ranged attack,<br />
			you have a penalty of -2 or the weapon’s Bulk rating,<br />
			whichever is worse (B365, B469, B548).<br />
			<strong>Close Combat</strong>: If using a ranged weapon, ignore the usual<br />
			speed/range penalty and apply the weapon’s Bulk<br />
			statistic as a penalty to hit. B391<br />
			It also serves as a penalty to <strong>Holdout</strong> skill when you<br />
			attempt to conceal the weapon. B370<br />
										</span>
									</span>
								</div>
								<div class="cell col9">
									<div class="popup">
										<span data-i18n="abbreviation-recoil-label">RCL</span>
									</div>
									<span class="tooltip">
										<span data-i18n="recoil-tooltip">
			When firing at RoF 2+, every full multiple of Rcl<br />
			by which you make your attack roll means you score<br />
			one extra hit, to a maximum number of hits equal<br />
			to total shots fired. See page 373.
										</span>
									</span>
								</div>
								<div class="cell col10">
									<span style="background-color: #87CEFA">| <span data-i18n="skill-label">skill</span> |</span>
								</div>
							</div> <!-- .header -->

							<!-- attr_use_ranged_modifier_tool is linked to checkbox on options sheet -->
							<input type="hidden" name="attr_use_ranged_modifier_tool" value="0" />
							<div class="row roll-modifiers">
								<div class="cell label">
									<div class="popup">
										<span data-i18n="modifier-label">Modifier:</span>
									</div>
									<div class="tooltip">
										<span data-i18n="modifier-dialog-tooltip">Enter a modifier to apply to any rolls on the this table.<br />Use the pencil/paper icon to select modifiers.<br /><b>NOTE:</b> Changing the modifier or check status of <i>Max skill of 9</i> will clear modifiers used by dialog box.</span>
									</div>
								</div>
								<div class="cell number-input">
									<input type="number" value="0" step="1" name="attr_ranged_roll_modifier" />
									<input type="hidden" value="" name="attr_ranged_roll_modifier_summary" />
									<input type="hidden" value="" name="attr_ranged_roll_trait_summary" />
									<input type="hidden" value="" name="attr_ranged_roll_hit_location" />
									<input type="hidden" value="" name="attr_ranged_roll_maneuver" />
									<input type="hidden" value="" name="attr_ranged_roll_allout_attack" />
								</div>
								<div class="cell">
									<button type="action" name="act_show_roll_modifiers_for_ranged" class="btn" title="Select Skill Modifiers"><span data-i18n="select-skill-modifiers-button">Select Skill Modifiers</span></button>
								</div>
								<div class="cell cell-popup">
									<div>
										<input type="checkbox" name="attr_ranged_roll_max_nine" value="1" title="Macro: @{ranged_roll_max_nine}" />
										<input type="hidden" name="attr_ranged_roll_max_nine_value" value="100" />
									</div>
									<div>
										<div class="popup">
											<span data-i18n="max-skill-9-label">Max skill of 9</span>
										</div>
										<div class="tooltip max-skill-9">
											<span data-i18n="max-skill-9-tooltip">The effective skill cannot exceed 9.</span>
										</div>
									</div>
								</div>
								<div class="cell">
									<button type="action" name="act_ranged_roll_reset" class="btn tool-modifier-reset" title="Reset Skill Modifiers"><span data-i18n="reset-label">Reset</span></button>
								</div>
								<div class="cell">
									<div class="summary-group">
										<div class="icon"><span data-i18n="notes-label">Notes</span></div>
										<div class="summary">
											<div class="roll-maneuver">
												<b>Maneuver:</b>
												<div>
													<span name="attr_ranged_roll_hit_location"></span>
												</div>
											</div>
											<div class="roll-maneuver">
												<b>Hit Location:</b>
												<div>
													<span name="attr_ranged_roll_maneuver"></span>
												</div>
											</div>
											<div class="roll-traits">
												<b>Traits:</b>
												<div>
													<span name="attr_ranged_roll_trait_summary"></span>
												</div>
											</div>
											<div class="roll-summary">
												<b>Summary:</b>
												<div>
													<span name="attr_ranged_roll_modifier_summary"></span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							
							<fieldset class="repeating_ranged">
								<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight" />
								<input class="toggle toggle-notes" type="checkbox" title="Click to show/hide more information." name="attr_ranged_toggle_notes" />
								<span class="checkbox"></span>
								<div class="row row-stats">
									<div class="cell col0">
										<input type="text" name="attr_name" title="Macro table name: repeating_ranged. Field name: name" />
									</div>
									<div class="cell col1">
										<input type="text" name="attr_damage" title="Macro table name: repeating_ranged. Field name: damage" />
									</div>
									<div class="cell col2">
										<input type="hidden" name="attr_damage_dice_icon" class="range-damage-dice-icon" value="explode" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Ranged Damage}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{damageRoll=[[@{damage}]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=@{minimum_damage_note}}} {{damageType=@{type}}} {{useDamageTypeNotes=[[@{use_damage_type_notes}]]}} {{damageTypeNote=@{damage_type_note}}} {{showNotes=[[1]]}} {{notes=@{damage_notes}}} {{armorDivisor=[[@{armor_divisor}]]}}" name="roll_damage" class="roll_damage" />
									</div>
									<div class="cell col3">
										<select name="attr_type" title="Macro table name: repeating_ranged. Field name: type">
											<option value="Affliction (aff)"><span data-i18n="abbreviation-option-affliction">aff</span></option>
											<option value="Burning (burn)"><span data-i18n="abbreviation-option-burning">burn</span></option>
											<option value="Corrosion (cor)"><span data-i18n="abbreviation-option-corrosion">cor</span></option>
											<option value="Crushing (cr)"><span data-i18n="abbreviation--option-crushing">cr</span></option>
											<option value="Cutting (cut)"><span data-i18n="abbreviation-option-cutting">cut</span></option>
											<option value="Fatigue (fat)"><span data-i18n="abbreviation-option-fatigue">fat</span></option>
											<option value="Impaling (imp)"><span data-i18n="abbreviation-option-impaling">imp</span></option>
											<option value="Small Piercing (pi-)"><span data-i18n="abbreviation-option-piercing-minus">pi-</span></option>
											<option value="Piercing (pi)"><span data-i18n="abbreviation-option-piercing">pi</span></option>
											<option value="Large Piercing (pi+)"><span data-i18n="abbreviation-option-piercing-plus">pi+</span></option>
											<option value="Huge Piercing (pi++)"><span data-i18n="abbreviation-option-piercing-plus-plus">pi++</span></option>
											<option value="Special (spec)"><span data-i18n="abbreviation-option-special">spec</span></option>
											<option value="Knockback (knock)"><span data-i18n="abbreviation-option-knockback">knock</span></option>
											<option value="Toxic (tox)"><span data-i18n="abbreviation-option-toxic">tox</span></option>
										</select>
										<input type="hidden" name="attr_damage_type_note" value="@{damage_type_note_aff}" />
										<input type="hidden" name="attr_minimum_damage_note" value="Min 1" />
									</div>
									<div class="cell col4">
										<input type="text" name="attr_acc" title="Macro table name: repeating_ranged. Field name: acc" />
									</div>
									<div class="cell col5">
										<input type="text" name="attr_range" title="Macro table name: repeating_ranged. Field name: range" />
									</div>
									<div class="cell col6">
										<input type="text" name="attr_rof" title="Macro table name: repeating_ranged. Field name: rof" />
									</div>
									<div class="cell col7">
										<input type="text" name="attr_shots" title="Macro table name: repeating_ranged. Field name: shots" />
									</div>
									<div class="cell col8">
										<input type="text" name="attr_bulk" title="Macro table name: repeating_ranged. Field name: bulk" />
									</div>
									<div class="cell col9">
										<input type="text" name="attr_recoil" title="Macro table name: repeating_ranged. Field name: recoil" />
									</div>
									<div class="cell col10">
										<input type="text" name="attr_skill" title="Macro table name: repeating_ranged. Field name: skill" />
									</div>
									<div class="cell col11">
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Ranged Attack}} {{rangedAttack=[[1]]}} {{selected=@{selected_token_macro}}} {{target1=@{target_token_macro}}} {{activeDefense=[[0]]}} {{isSkillRoll=[[1]]}} {{showHitLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{skill} + @{modifier} + @{ranged_roll_modifier}, @{ranged_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_ranged_modifier_tool}]]}} {{maxNine=[[@{ranged_roll_max_nine}]]}} {{rollModifier=[[@{ranged_roll_modifier}]]}} {{rollModifierSummary=@{ranged_roll_modifier_summary}}} {{rollTraitSummary=@{ranged_roll_trait_summary}}} {{hitLocation=@{ranged_roll_hit_location}}} {{maneuver=@{ranged_roll_maneuver}}} {{allOutAttack=@{ranged_roll_allout_attack}}} {{notes=@{notes}}} {{showNotes=[[1]]}} {{rof=@{rof}}} {{recoil=@{recoil}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{useMalfunction=[[@{use_malfunction}]]}} {{malfunction=[[@{malfunction}]]}} {{verifyMalfunction=[[ @{malfunction_verify} ]]}}" name="roll_vsSL" />
									</div>
								</div> <!-- .row -->
								
								<div class="ranged-notebox">
									
									<div class="row">
										<input type="hidden" name="attr_ranged_row_type" value="Skill" />
										<div class="cell">
											<select name="attr_ranged_row_type">
												<option value=""><span data-i18n="option-select">--Select--</span></option>
												<option value="Skill"><span data-i18n="option-skill">Skill</span></option>
												<option value="Spell"><span data-i18n="option-spell">Spell</span></option>
												<option value="Technique"><span data-i18n="option-technique">Technique</span></option>
												<option value="ST"><span data-i18n="abbreviation-strength">ST</span></option>
												<option value="STRIKING"><span data-i18n="attribute-striking">Striking</span> <span data-i18n="abbreviation-strength">ST</span></option>
												<option value="DX"><span data-i18n="abbreviation-dexterity">DX</span></option>
												<option value="IQ"><span data-i18n="abbreviation-intelligence">IQ</span></option>
												<option value="WILL"><span data-i18n="will-label">WILL</span></option>
												<option value="HT"><span data-i18n="abbreviation-health">HT</span></option>
												<option value="10"><span data-i18n="abbreviation-health">10</span></option>
											</select>
										</div>
										<div class="cell col-row-id label show-hide-row-id">
											<div class="popup">
												<span data-i18n="row-id-label">Row ID:</span>
											</div>
											<span class="tooltip">
												<span data-i18n="copy-paste-row-id-tooltip">
			Copy/paste the Skill or Spell Row ID to link that skill to this technique.<br />
			When the skill/spell is updated, the technique's parent name and base skill level<br />
			will be updated.<br />
			Once entered, this will change the Skill/Spell for this particular attack to match<br />
			the skill/spell level of the Base Skill. Do not change this skill Level number manually.
												</span>
											</span>	
										</div>
										<div class="cell col-input-medium show-hide-row-id">
											<input type="hidden" name="attr_ranged_skill_row_id_toggle" value="0" />
											<input type="text" name="attr_ranged_skill_row_id" title="Macro table name: repeating_ranged. Field name: ranged_skill_row_id" />
										</div>
										<div class="cell">
											<div class="popup">
												<span data-i18n="abbreviation-modifier-label">Mod</span>
											</div>
											<div class="tooltip tooltip-skills-ref">
												<span data-i18n="modifier-tooltip">
			Enter the net value of all modifiers combined.<br />
			Can be a positive or a negative number.<br />
			Example: Enter 2 for Weapon’s Bond (+1) plus Magic (Accuracy: +1).<br />
			Once entered, this will change the Skill/Spell Level for this <b>particular</b><br />
			weapon to match the Base Skill/Spell level plus this MOD (Modifier).<br />
			Do not change this level number manually.
												</span>
											</div>
										</div>
										<div class="cell">
											<input type="number" value="0" name="attr_ranged_skill_row_id_modifier" class="inline" title="Macro table name: repeating_ranged. Field name: ranged_skill_row_id_modifier" />
										</div>
										<div class="cell col-wide">
											<input type="hidden" name="attr_ranged_skill_row_id_message" value="" />
											<b><span data-i18n="name-label">Name:</span></b>
											<span name="attr_ranged_skill_row_id_message"></span>
											<input type="hidden" name="attr_ranged_skill_row_id_level" value="" />
											<b><span data-i18n="skill-level-label">Level</span>:</b>
											<span name="attr_ranged_skill_row_id_level"></span>
										</div>
									</div> <!-- .row -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
											</div>
											<span class="tooltip">
												<span data-i18n="reason-for-modifiers-skills-tooltip">
			Examples:<br />
			+1 from Talent...<br />
			+1 from Default Skill...<br />
			+1 from Enchanted Item with...
												</span>
											</span>
										</div>
										<div class="cell reason-for-mod">
											<input type="text" name="attr_reason_for_mod" title="Macro table name: repeating_ranged. Field name: reason_for_mod" />
										</div>
									</div><!-- .row -->
									
									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="malfunction-label">Malfunction</span>
											</div>
											<span class="tooltip">
												<span data-i18n="malfunction-tooltip">
			Malfunction is an <strong>Optional Rule</strong>. B278, <strong>B279</strong>, B382, tables <strong>B407</strong> & HT179, with more detailed info HT79-81. If the option <i>Use Malfunction</i> is<br />
			checked [see Sheet Options page], and if the # entered here is greater than 0, then the roll result will check for weapon malfunction.<br />
			<b style="color:red;">Malfunction has "priority" over a critical miss: if both would occur, only the malfunction takes place. See Critical Misses B382.
												</span>
											</span>	
										</div>
										<div class="cell col-input">
											<input type="number" default="0" name="attr_malfunction" value="0" title="Macro table name: repeating_ranged. Field name: malfunction" />
										</div>
										<div class="cell col-verify custom-checkbox">
											<div class="popup">
												<strong>...<span data-i18n="verify-label">Verify</span></strong>
											</div>
											<span class="tooltip">
												<span data-i18n="verify-malfunction-tooltip">If Verify is checked, then roll again to verify the malfunction. see HT79</span>
											</span>	
										</div>
										<div class="cell col-verifycheck custom-checkbox">
											<input type="checkbox" name="attr_malfunction_verify" value="1" class="inline" title="Macro table name: repeating_ranged. Field name: malfunction_verify" />
										</div>
									</div> <!-- .row -->

									<div class="row">
										<div class="cell label">
											<div class="popup">
												<span data-i18n="armor-divisor-label">Armor Divisor</span>:
											</div>
											<span class="tooltip">
												<span data-i18n="armor-divisor-tooltip">Divide the target's armor DR by this number before subtracting damage<br />or (adding it adding it to the HT roll for an affliction). See B268.<br /><b>Explosive</b> attacks (optional house rule: area effect attacks) only apply divisor to target of direct hit. See B269.<br /><b>Afflictions</b> divide the armor DR <i>before</i> determining bonus to HT roll. See B269</span>
											</span>	
										</div>
										<div class="cell">
											<input type="number" class="inline" name="attr_armor_divisor" value="1" min="1" step="1" title="Macro table name: repeating_ranged. Field name: armor_divisor" />
										</div>
									</div> <!-- .row -->
									
									<div class="row">
										<div class="cell">
											<div class="popup">
												<span data-i18n="weapon-notes-label">Weapon Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="ranged-weapon-notes-tooltip">
			<strong>Hint:</strong> Enter inline rolls for additional results. To show the selected arrow.<br />
			Example: Arrow: ?{Arrow Type|Bodkin|Normal}
												</span>
											</span>
											<textarea class="text-left chat-size" name="attr_notes" title="Macro table name: repeating_ranged. Field name: notes"></textarea>
										</div>
										<div class="cell">
											<div class="popup">
												<span data-i18n="damage-notes-label">Damage Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="ranged-damage-notes-tooltip">
			<strong>Hint:</strong> Enter inline rolls for additional results.<br />
			Example: Does an additional [[1d6]] fire damage.
												</span>
											</span>
											<textarea class="text-left chat-size" name="attr_damage_notes" title="Macro table name: repeating_ranged. Field name: damage_notes"></textarea>
										</div>
									</div> <!-- .row -->
									
								</div> <!-- .note-box -->
								
							</fieldset> <!-- .repeating_ranged -->
						</div> <!-- .table -->
					</div> <!-- .box .ranged-attacks -->

					<!-- _____ _____ THROWING _____ _____ -->
					<div class="box ranged-attacks thrown-object">
						<div class="table">
							<div class="header">
								<div class="cell col0-st">
									<span data-i18n="abbreviation-thrown-pounds-label">Thrown (lbs)</span>
								</div>
								<div class="cell col8">
									<div class="popup">
										<span data-i18n="abbreviation-strength">ST</span>
									</div>
									<div class="tooltip">
										<span data-i18n="thrown-strength-tooltip">
			Based on Striking ST<br />
			<i>Note:</i> future versions will add ability to choose ST source or enter ST.
										</span>
									</div>
								</div>
								<div class="cell col8">
									<div class="popup">
										<span data-i18n="abbreviation-modifier-label">Mod</span>
									</div>
									<div class="tooltip">
										<span data-i18n="thrown-modifier-tooltip">
			Strength Modifier to distance only<br />
			Throwing or Throwing Art at DX Level = +1 ST<br />
			Throwing or Throwing Art at DX+1 Level = +2 ST<br />	
										</span>
									</div>
								</div>
								<div class="cell col8">
									<div class="popup">
										<span data-i18n="super-label">Super</span>
									</div>
									<div class="tooltip">
										<span data-i18n="thrown-super-tooltip">
			Super Throw Level<br />
			Each level of Super Throw, double range.<br />
			Each level of Super Throw increases damage by +2 per die.
										</span>
									</div>
								</div>
								<div class="cell col1">
									<div class="popup">
										<span data-i18n="damage-label">Damage</span>
									</div>
									<div class="tooltip">
										<span data-i18n="thrown-damage-tooltip">Final damage based on ST, super throw, and damage modifier.</span>
									</div>
								</div>
								<div class="cell col8">
									<div class="popup">
										<span data-i18n="abbreviation-modifier-label">Mod</span>
									</div>
									<div class="tooltip">
										<span data-i18n="thrown-modifier-tooltip">
			Bonus or penalty per die<br />
			Throwing Art at DX Level = +1 per die<br />
			Throwing Art at DX+1 Level = +2 per die
										</span>
									</div>
								</div>
								<div class="cell col2"> </div>
								<div class="cell col3">
									<div class="popup">
										<span data-i18n="type-label">Type</span>
									</div>
									<span class="tooltip">
										<span data-i18n="damage-type-tooltip">
			<table>
				<thead>
					<tr>
						<th>Abbr</th>
						<th>Name</th>
					</tr>
				</thead>
				<tbody>
					<tr><td>aff</td> <td>Affliction</td></tr>
					<tr><td>burn</td><td>Burning</td></tr>
					<tr><td>cor</td> <td>Corrosion</td></tr>
					<tr><td>cr</td>  <td>Crushing</td></tr>
					<tr><td>cut</td> <td>Cutting</td></tr>
					<tr><td>fat</td> <td>Fatigue</td></tr>
					<tr><td>imp</td> <td>Impaling</td></tr>
					<tr><td>pi-</td> <td>Small Piercing</td></tr>
					<tr><td>pi</td>  <td>Piercing</td></tr>
					<tr><td>pi+</td> <td>Large Piercing</td></tr>
					<tr><td>pi++</td><td>Huge Piercing</td></tr>
					<tr><td>spec</td><td>Special</td></tr>
					<tr><td>tox</td> <td>Toxic</td></tr>
				</tbody> 
			</table>
										</span>
									</span>
								</div>					
								<div class="cell col4">
									<span data-i18n="abbreviation-accuracy-label">Acc</span>
								</div>
								<div class="cell col5-thrown">
									<div class="popup">
										<span data-i18n="abbreviation-gravity-label">GRAV</span>
									</div>
									<span class="tooltip">
										<span data-i18n="gravity-thrown-tooltip">Gravity, affects throwing distance. See B350.<br /></span>
									</span>
								</div>					
								<div class="cell col5-thrown">
									<div class="popup">
										<span data-i18n="abbreviation-range-label">RNG</span>
									</div>
									<span class="tooltip">
										<span data-i18n="throwing-range-tooltip">See GURPS Campaigns Page 355 for formula</span>
									</span>
								</div>					
								<div class="cell col6">
									<div class="popup">
										<span data-i18n="abbreviation-rate-of-fire-label">RoF</span>
									</div>
									<span class="tooltip">
										<span data-i18n="rate-of-fire-tooltip">
			Rate of Fire<br />
			The maximum number of shots that can be fired in <br />
			one turn (by a regular person).<br />
			The minimum number of shots is 1.<br /><br />
			<strong>!</strong>: minimum RoF is 1/4 of the maximum, rounded up.<br />
			<strong>mxn</strong>: fires the first number of shots, which each then<br />
			split into the second number (eg. shotguns)<br />
			<strong>Jet</strong>: shoots a continuous stream of fluid. See page 106.
										</span>
									</span>
								</div>
								<div class="cell col5-thrown">
									<div class="popup">
										<span data-i18n="shots-label">Shots</span>
									</div>
									<span class="tooltip">
										<span data-i18n="shots-tooltip">
			The number of shots that can be fired before the<br />
			weapon must be reloaded.<br />
			The parenthetical number indicates the number of 1<br />
			second ready maneuvers required to reload the<br />
			weapon.<br />
			<strong>T</strong>: the weapon is thrown. To "reload" it, pick it up.<br />
			<strong>i</strong>: you must load the shots individually. the listed<br />
			time is for each shot.
										</span>
									</span>
								</div>
								<div class="cell col9">
									<div class="popup">
										<span data-i18n="abbreviation-recoil-label">RCL</span>
									</div>
									<span class="tooltip">
										<span data-i18n="recoil-tooltip">
			When firing at RoF 2+, every full multiple of Rcl<br />
			by which you make your attack roll means you score<br />
			one extra hit, to a maximum number of hits equal<br />
			to total shots fired. See page 373.
										</span>
									</span>
								</div>
								<div class="cell col10">
									<span style="background-color: #87CEFA">| <span data-i18n="skill-label">skill</span> |</span>
								</div>
							</div> <!-- .header -->
							
							<div class="repcontainer">
								<div class="repitem">
								   
									<input class="toggle" type="checkbox" title="Click to show/hide more information." name="attr_thrown_toggle_notes" />
									<span class="checkbox"></span>
									
									<div class="row row-stats row-thrown-object">
										<div class="cell col0-st">
											<input type="number" step="1" value="1" min="1" name="attr_thrown_object_weight" title="Macro name: thrown_object_weight" />
										</div>
										<div class="cell col8">
											<input type="text" name="attr_thrown_object_strength" readonly="readonly" value="10" title="Macro name: thrown_object_strength" />
										</div>
										<div class="cell col8">
											<input type="number" name="attr_thrown_object_strength_mod" value="0" step="1" title="Macro name: thrown_object_strength_mod" />
										</div>
										<div class="cell col8">
											<input type="number" name="attr_super_throw_level" value="0" step="1" title="Macro name: super_throw_level" />
										</div>
										<div class="cell col1">
											<input type="text" name="attr_thrown_object_damage" readonly="readonly" value="@{thrust}" title="Macro name: thrown_object_damage" />
										</div>
										<div class="cell col8">
											<input type="number" step="1" name="attr_thrown_object_damage_mod" value="0" title="Macro name: thrown_object_damage_mod" />
										</div>
										<div class="cell col2">
											<input type="hidden" name="attr_damage_dice_icon" class="range-damage-dice-icon" value="explode" />
											<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Ranged Damage}} {{selected=@{selected_token_macro}}} {{target1=@{target_token_macro}}} {{characterName=@{character_name}}} {{skillName=Thrown Object @{thrown_object_weight} lbs.}} {{damageRoll=[[@{thrown_object_damage}]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=@{thrown_minimum_damage_note}}} {{damageType=@{thrown_object_damage_type}}} {{useDamageTypeNotes=[[@{use_damage_type_notes}]]}} {{damageTypeNote=@{thrown_object_damage_type_note}}} {{showNotes=[[1]]}} {{notes=@{thrown_object_damage_notes}}}" name="roll_damage" class="roll_damage" />
										</div>
										<div class="cell col3">
											<select name="attr_thrown_object_damage_type" title="Macro name: thrown_object_damage_type">
												<option value="Cutting (cut)"><span data-i18n="abbreviation-option-cutting">cut</span></option>
												<option value="Impaling (imp)"><span data-i18n="abbreviation-option-impaling">imp</span></option>
												<option value="Crushing (cr)"><span data-i18n="abbreviation-option-crushing">cr</span></option>
												<option value="Small Piercing (pi-)"><span data-i18n="abbreviation-option-piercing-minus">pi-</span></option>
												<option value="Piercing (pi)"><span data-i18n="abbreviation-option-piercing">pi</span></option>
												<option value="Large Piercing (pi+)"><span data-i18n="abbreviation-option-piercing-plus">pi+</span></option>
												<option value="Huge Piercing (pi++)"><span data-i18n="abbreviation-option-piercing-plus-plus">pi++</span></option>
												<option value="Affliction (aff)"><span data-i18n="abbreviation-option-affliction">aff</span></option>
												<option value="Burning (burn)"><span data-i18n="abbreviation-option-burning">burn</span></option>
												<option value="Corrosion (cor)"><span data-i18n="abbreviation-option-corrosion">cor</span></option>
												<option value="Fatigue (fat)"><span data-i18n="abbreviation-option-fatigue">fat</span></option>
												<option value="Toxic (tox)"><span data-i18n="abbreviation-option-toxic">tox</span></option>
												<option value="Knockback (knock)"><span data-i18n="abbreviation-option-knockback">knock</span></option>
												<option value="Special (spec)"><span data-i18n="abbreviation-option-special">spec</span></option>
											</select>
											<input type="hidden" name="attr_thrown_object_damage_type_note" value="@{damage_type_note_cut}" />
											<input type="hidden" name="attr_thrown_minimum_damage_note" value="Min 1" />
										</div>
										<div class="cell col4">
											<input type="number" step="1" name="attr_thrown_object_acc" value="0" title="Macro name: thrown_object_acc" />
										</div>
										<div class="cell col5-thrown thrown-object-input">
											<input type="number" name="attr_gravity" value="1" min="0" step=".01" title="Macro: @{gravity}" />
										</div>
										<div class="cell col5-thrown thrown-object-input">
											<input type="text" name="attr_thrown_object_range" readonly="readonly" value="10" title="Macro name: thrown_object_range" />
										</div>
										<div class="cell col6">
											<input type="text" name="attr_thrown_object_rof" value="1" title="Macro name: thrown_object_rof" />
										</div>
										<div class="cell col5-thrown">
											<input type="text" name="attr_thrown_object_shots" value="1" title="Macro name: thrown_object_shots" />
										</div>
										<div class="cell col9">
											<input type="text" name="attr_thrown_object_recoil" value="-1" title="Macro name: thrown_object_recoil" />
										</div>
										<div class="cell col10">
											<input type="text" name="attr_thrown_object_skill" value="10" title="Macro name: thrown_object_skill" />
										</div>
										<div class="cell col11">
											<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Ranged Attack}} {{activeDefense=[[0]]}} {{isSkillRoll=[[1]]}} {{showHitLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Thrown Object @{thrown_object_weight} lbs.}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{thrown_object_skill} + @{modifier} + @{ranged_roll_modifier}, @{ranged_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_ranged_modifier_tool}]]}} {{maxNine=[[@{ranged_roll_max_nine}]]}} {{rollModifier=[[@{ranged_roll_modifier}]]}} {{rollModifierSummary=@{ranged_roll_modifier_summary}}} {{rollTraitSummary=@{ranged_roll_trait_summary}}} {{hitLocation=@{ranged_roll_hit_location}}} {{maneuver=@{ranged_roll_maneuver}}} {{allOutAttack=@{ranged_roll_allout_attack}}} {{showNotes=[[1]]}} {{notes=@{thrown_object_notes}}} {{rof=@{thrown_object_rof}}} {{recoil=@{thrown_object_recoil}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" name="roll_vsSL" />
										</div>
									</div> <!-- .row -->
									<div class="row row-details2">
										<div class="cell col0 label">
											<span data-i18n="weapon-notes-label">Weapon Notes</span>
										</div>
										<div class="cell col1">
											<input type="text" name="attr_thrown_object_notes" title="Macro name: thrown_object_notes" />
										</div>
										<div class="cell col2 label">
											<div class="popup">
												<span data-i18n="damage-notes-label">Damage Notes</span>
											</div>
											<span class="tooltip">
												<span data-i18n="ranged-damage-notes-tooltip">
			<strong>Hint:</strong> Enter inline rolls for additional results.<br />
			Example: Does an additional [[1d6]] fire damage.
												</span>
											</span>
										</div>
										<div class="cell col3">
											<input type="text" name="attr_thrown_object_damage_notes" title="Macro name: thrown_object_damage_notes" />
										</div>
									</div>
								</div> <!-- .row -->
							</div>
							<!-- .end repcontainer -->
							
						</div> <!-- .table -->
					</div> <!-- .box .ranged-attacks -->
					
					<!-- _____ _____ Firing Up or Down _____ _____ -->
					<div class="box firing-up-down">
						<div class="table">
							<div class="row title">
								<div class="cell">
									<span data-i18n="range-calculator-label">Range Calculator</span>
								</div>
							</div>
							<div class="header">
								<div class="cell linear-range">
									<div class="popup">
										<span data-i18n="range-label">Range</span>
									</div>
									<div class="tooltip">
										<span data-i18n="firing-up-down-range-tooltip">
			Distance between shooter and target.<br />
			See B372-373
										</span>
									</div>
								</div>
								<div class="cell speed">
									<div class="popup">
										<span data-i18n="speed-label">Speed</span>
									</div>
									<div class="tooltip">
										<span data-i18n="firing-up-down-speed-tooltip">
			(2 mph = 1 yard/second).<br />
			Ignore if human like target moving 10 yards or less.<br />
			See B372-373
										</span>
									</div>
								</div>
								<div class="cell fire-up-dwn-distance">
									<div class="popup">
										<span data-i18n="abbreviation-elevation-label">Elev</span>
									</div>
									<div class="tooltip">
										<span data-i18n="ranged-elevation-label">Elevation. If you're above the target, enter a positive number of hexes. If you're below the target, enter a negative number of hexes. See B407.</span>
									</div>
								</div>
								<div class="cell new-range">
									<div class="popup">
										<span data-i18n="abbreviation-effective-label">EFF</span>
									</div>
									<div class="tooltip">
										<span data-i18n="effective-speed-range-tooltip">Effective speed/range based on range, speed, and elevation.</span>
									</div>
								</div>
								<div class="cell speed">
									<div class="popup">
										<span data-i18n="abbreviation-accuracy-label">Acc</span>
									</div>
									<div class="tooltip">
										<span data-i18n="accuracy-bonus-tooltip">Accuracy</span>
									</div>
								</div>
								<div class="cell aiming">
									<div class="popup">
										<span data-i18n="aim-bonus-label">Aim Bonus</span>
									</div>
									<div class="tooltip">
										<span data-i18n="aiming-bonus-tooltip">Each turn <b>after</b> the initial aim, you get an additional bonus. See B364</span>
									</div>
								</div>
								<div class="cell rof">
									<div class="popup">
										<span data-i18n="abbreviation-rate-of-fire-label">RoF</span>
									</div>
									<div class="tooltip">
										<span data-i18n="rate-of-fire-tooltip">see translation</span>
									</div>
								</div>
								<div class="cell size">
									<div class="popup">
										<span data-i18n="two-letter-abbreviation-size-modifier-label">SM</span>
									</div>
									<span class="tooltip">
										<span data-i18n="target-size-modifier-tooltip">Size Modifier of target.</span>
									</span>
								</div>
								<div class="cell hit-mod">
									<span data-i18n="abbreviation-hit-modifier-label">Hit Mod</span>
								</div>
								<div class="cell reset">
									&nbsp;
								</div>
								<input type="hidden" name="attr_use_ranged_modifier_tool" value="1">
								<div class="cell reset apply-button">
									<div class="popup">
										<span data-i18n="help-label">Help</span>
									</div>
									<div class="tooltip">
										<span data-i18n="apply-firing-tooltip">Apply this modifier to the ranged <b>Modifier</b> box and <b>Roll Modifiers</b> tool.</span>
									</div>
								</div>
							</div> <!-- .header -->
							
							<div class="container">
								
								<div class="row">
									<div class="cell linear-range">
										<input type="number" step="1" value="0" min="0" name="attr_firing_distance" title="Macro name: firing_distance" />
									</div>
									<div class="cell speed">
										<input type="number" step="1" value="0" min="0" name="attr_firing_speed_difference" title="Macro name: firing_speed_difference" />
									</div>
									<div class="cell fire-up-dwn-distance">
										<input type="number" step="1" value="0" min="0" name="attr_firing_elevation" title="Macro name: firing_elevation" />
									</div>
									<div class="cell new-range">
										<input type="number" step="1" value="0" min="0" name="attr_firing_new_range" readonly="readonly" title="Macro name: firing_new_range" />
									</div>
									<div class="cell speed">
										<input type="number" step="1" value="0" min="0" name="attr_firing_acc" title="Macro name: firing_acc" />
									</div>
									<div class="cell aiming">
										<select name="attr_firing_aiming_bonus" title="macro name: @{firing_aiming_bonus}">
											<option value="0" selected="selected">+0</option>
											<option value="1">2 turns: +1</option>
											<option value="2">3+ turns: +2</option>
										</select>
									</div>
									<div class="cell rof">
										<input type="number" step="1" value="0" min="1" name="attr_firing_rof" title="Macro name: firing_acc" />
									</div>
									<div class="cell size">
										<input type="number" step="1" value="0" name="attr_firing_size_mod" title="Macro name: firing_size_mod" />
									</div>
									<div class="cell hit-mod">
										<input type="number" step="1" value="0" name="attr_firing_hit_mod" readonly="readonly" title="Macro name: firing_hit_mod" />
									</div>
									<div class="cell reset">
										<button type="action" name="act_range_calc_reset" class="reset"><span data-i18n="reset-label">Reset</span></button>
									</div>
									<input type="hidden" name="attr_use_ranged_modifier_tool" value="1">
									<div class="cell reset apply-button">
										<button type="action" name="act_apply_firing_modifiers" class="reset"><span data-i18n="apply-label">Apply</span></button>
									</div>
								</div>
							</div> <!-- .container -->
							
						</div> <!-- .table -->
					</div> <!-- .box .ranged-attacks firing-up-or-down -->
					
					<!-- _____ _____ Shotgun Tool _____ _____ -->
					<div class="box shotgun-tool">
						<div class="table">
							
							<div class="row title">
								<div class="cell">
									<span data-i18n="close-range-shotgun-label">Close Range Shotgun Damage Tool</span>
								</div>
							</div>
							
							<div class="header">
								<div class="cell damage">
									<span data-i18n="abbreviation-damage-label">DMG</span>
								</div>
								<div class="cell rof">
									<span data-i18n="abbreviation-rate-of-fire-label">RoF</span>
								</div>
								<div class="cell damage-type">
									<span data-i18n="type-label">Type</span>
								</div>
								<div class="cell range">
									<div class="popup">
										<span class="one-half">1/2</span> <span data-i18n="range-label">Range</span>
									</div>
									<div class="tooltip">
										<span data-i18n="shotgun-half-damage-tooltip">Enter half-damage range of shotgun.</span>
									</div>
								</div>
								<div class="cell close-range">
									<div class="popup">
										<span data-i18n="close-label">Close</span>
									</div>
									<div class="tooltip">
										<span data-i18n="shotgun-close-range-tooltip">Close range.</span>
									</div>
								</div>
								<div class="cell close-rof">
									<div class="popup">
										<span data-i18n="abbreviation-rate-of-fire-label">RoF</span>
									</div>
									<span class="tooltip">
										<span data-i18n="shotgun-new-rate-of-fire-tooltip">New Rate of Fire</span>
									</span>
								</div>
								<div class="cell close-damage">
									<div class="popup">
										<span data-i18n="abbreviation-damage-label">DMG</span>
									</div>
									<div class="tooltip">
										<span data-i18n="shotgun-new-damage-tooltip">New Damage</span>
									</div>
								</div>
								<div class="cell close-damage">
									<div class="popup">
										<span data-i18n="abbreviation-damage-resistance-multiplier-label">DR Mult.</span>
									</div>
									<div class="tooltip">
										<div data-i18n="shotgun-damage-resistance-multiplier-tooltip">Damage Resistance Multiplier.</div>
									</div>
								</div>
								<div class="cell roll-damage">
									&nbsp;
								</div>
								<div class="cell reset">
									&nbsp;
								</div>
							</div> <!-- .header -->
							
							<div class="container">
								
								<div class="row">
									<div class="cell damage">
										<input type="text" value="1d6+1" name="attr_shotgun_damage" title="Macro name: shotgun_damage" />
									</div>
									<div class="cell rof">
										<input type="text" value="2x9" name="attr_shotgun_rof" title="Macro name: shotgun_rof" />
									</div>
									<div class="cell type">
										<select name="attr_shotgun_damage_type" title="Macro name: shotgun_damage_type">
											<option value="Affliction (aff)"><span data-i18n="abbreviation-affliction">aff</span></option>
											<option value="Burning (burn)"><span data-i18n="abbreviation-option-burning">burn</span></option>
											<option value="Corrosion (cor)"><span data-i18n="abbreviation-option-corrosion">cor</span></option>
											<option value="Crushing (cr)"><span data-i18n="abbreviation-option-crushing">cr</span></option>
											<option value="Cutting (cut)"><span data-i18n="abbreviation-option-cutting">cut</span></option>
											<option value="Fatigue (fat)"><span data-i18n="abbreviation-option-fatigue">fat</span></option>
											<option value="Impaling (imp)"><span data-i18n="abbreviation-option-impaling">imp</span></option>
											<option value="Small Piercing (pi-)"><span data-i18n="abbreviation-option-piercing-minus">pi-</span></option>
											<option value="Piercing (pi)" selected="selected"><span data-i18n="abbreviation-option-piercing">pi</span></option>
											<option value="Large Piercing (pi+)"><span data-i18n="abbreviation-option-piercing-plus">pi+</span></option>
											<option value="Huge Piercing (pi++)"><span data-i18n="abbreviation-option-piercing-plus-plus">pi++</span></option>
											<option value="Special (spec)"><span data-i18n="abbreviation-option-special">spec</span></option>
											<option value="Knockback (knock)"><span data-i18n="abbreviation-option-knockback">knock</span></option>
											<option value="Toxic (tox)"><span data-i18n="abbreviation-option-toxic">tox</span></option>
										</select>
									</div>
									<div class="cell range">
										<input type="number" value="50" step="1" min="0" name="attr_shotgun_half_range" title="Macro name: shotgun_half_range" />
									</div>
									<div class="cell close-range">
										<input type="text" value="5" name="attr_shotgun_close_range" readonly="readonly" title="Macro name: shotgun_close_range" />
									</div>
									<div class="cell close-rof">
										<input type="text" value="2" name="attr_shotgun_close_rof" readonly="readonly" title="Macro name: shotgun_close_row" />
									</div>
									<div class="cell close-damage">
										<input type="text" value="4d6+4" name="attr_shotgun_close_damage" readonly="readonly" title="Macro name: shotgun_close_damage" />
									</div>
									<div class="cell close-damage">
										<input type="text" value="DR x 4" name="attr_shotgun_dr_multiplier" readonly="readonly" title="Macro name: shotgun_dr_multiplier" />
									</div>
									<div class="cell roll-damage">
										<input type="hidden" name="attr_thrust_damage_dice_icon" class="thrust-damage-dice-icon" value="explode" />
										<input type="hidden" name="attr_shotgun_damage_type_note" value="PIERCING
			Damage x1
			Vitals Damage x3
			Skull Damage x4" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Damage Roll}} {{characterName=@{character_name}}} {{skillName=Close Shotgun Damage}} {{damageRoll=[[@{shotgun_close_damage}]]}} {{useDamageTypeNotes=[[@{use_damage_type_notes}]]}} {{damageTypeNote=@{shotgun_damage_type_note}}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Crush min 0, else min 1}}" name="roll_dmgCloseShotgunDamage" class="roll_damage" />
									</div>
									<div class="cell reset">
										<button type="action" name="act_shotgun_reset" class="reset"><span data-i18n="reset-label">Reset</span></button>
									</div>
								</div>
								
								<div class="row shotgun-notes">
									<span data-i18n="shotgun-notes-description">
			Enter the stats of the shotgun, be sure to use half-damage range. The tool will calculate how 
			close you need to be with the shotgun, the RoF, close range damage, and DR multiplier.
			For more information, see B409.
									</span>
								</div>
							</div> <!-- .container -->
							
						</div> <!-- .table -->
					</div> <!-- .box .shotgun tool -->
					
				</div>

				<div class="tools">
					
					<!-- _____ _____ Falling and Collision _____ _____ -->
					<div class="box falling-collision">
						<div class="table">
							
							<div class="row title">
								<div class="cell">
									<span data-i18n="falling-collision-label">Falling and Collision</span>
								</div>
							</div>
							
							<div class="header">
								<div class="cell row-title">
									&nbsp;
								</div>
								<div class="cell yards-fallen">
									<span data-i18n="abbreviation-yards-fallen-label">Yds Fallen</span>
								</div>
								<div class="cell gravity">
									<span data-i18n="gravity-label">Gravity</span>
								</div>
								<div class="cell atmosphere">
									<div class="popup">
										<span data-i18n="abbreviation-atmosphere-label">Atm.</span>
									</div>
									<div class="tooltip">
										<span data-i18n="atmosphere-tooltip">Atmosphere</span>
									</div>
								</div>
								<div class="cell velocity">
									<div class="popup">
										<span data-i18n="velocity-label">Velocity</span>
									</div>
									<span class="tooltip">
										<span data-i18n="falling-velocity-tooltip">
			If collision, use relative velocity.<br />
			Head-on collision = Add velocity of both objects<br />
			Rearend collision = Faster object - slower object<br />
			Side collision = Speed of object causing collision<br />
										</span>
									</span>
								</div>
								<div class="cell hit-points">
									<div class="popup">
										<span data-i18n="abbreviation-hit-points-label">HP</span>
									</div>
									<div class="tooltip">
										<span data-i18n="falling-hit-points-tooltip">
			Hit Points of falling object or object initiating <br />
			collision.<br />
			If hitting immovable object, use HP*2<br />
			NOTE: If collision, if the other object is moving<br />
			it will inflict its own damage to object that initiated<br />
			the collision.<br />
			See B430
										</span>
									</div>
								</div>
								<div class="cell damage">
									<span data-i18n="damage-label">Damage</span>
								</div>
								<div class="cell roll-damage">
									&nbsp;
								</div>
								<div class="cell reset">
									&nbsp;
								</div>
							</div> <!-- .header -->
							
							<div class="container">
								
								<div class="row">
									<div class="cell row-title">
										<span data-i18n="falling-label">Falling</span>
									</div>
									<div class="cell yards-fallen">
										<input type="number" step="1" value="1" min="1" name="attr_yards_fallen" title="Macro name: yards_fallen" />
									</div>
									<div class="cell gravity">
										<input type="number" value="1" min="0" step=".01" name="attr_gravity" title="Macro name: gravity" />
									</div>
									<div class="cell atmosphere">
										<input type="number" value="1" min="0" name="attr_atmosphere" title="Macro name: atmosphere" />
									</div>
									<div class="cell velocity">
										<input type="number" value="5" readonly="readonly" name="attr_falling_velocity" title="Macro name: velocity" />
									</div>
									<div class="cell hit-points">
										<input type="number" step="1" value="10" min="1" name="attr_falling_hit_points" title="Macro name: falling_hit_points" />
									</div>
									<div class="cell damage">
										<input type="text" value="1d6-2" name="attr_falling_damage" readonly="readonly" title="Macro name: falling_damage" />
									</div>
									<div class="cell roll-damage">
										<input type="hidden" name="attr_thrust_damage_dice_icon" class="thrust-damage-dice-icon" value="explode" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Damage Roll}} {{characterName=@{character_name}}} {{skillName=Falling Damage}} {{damageRoll=[[@{falling_damage}]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Crush min 0, else min 1}} {{showNotes=[[1]]}} {{notes=@{falling_collision_damage_notes}}}" name="roll_dmgFalling" class="roll_damage" />
									</div>
									<div class="cell reset">
										<button type="action" name="act_falling_reset" class="reset"><span data-i18n="reset-label">Reset</span></button>
									</div>
								</div>
								
								<div class="row">
									<div class="cell row-title">
										<span data-i18n="collision-label">Collision</span>
									</div>
									<div class="cell yards-fallen">
										&nbsp;
									</div>
									<div class="cell gravity">
										&nbsp;
									</div>
									<div class="cell atmosphere">
										&nbsp;
									</div>
									<div class="cell velocity">
										<input type="number" value="1" step="1" min="1" name="attr_collision_velocity" title="Macro name: collision_velocity" />
									</div>
									<div class="cell hit-points">
										<input type="number" step="1" value="10" min="1" name="attr_collision_hit_points" title="Macro name: collision_hit_points" />
									</div>
									<div class="cell damage">
										<input type="text" value="1d6-3" name="attr_collision_damage" readonly="readonly" title="Macro name: collision_damage" />
									</div>
									<div class="cell roll-damage">
										<input type="hidden" name="attr_thrust_damage_dice_icon" class="thrust-damage-dice-icon" value="explode" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Damage Roll}} {{characterName=@{character_name}}} {{skillName=Collision Damage}} {{damageRoll=[[@{collision_damage}]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Crush min 0, else min 1}} {{showNotes=[[1]]}} {{notes=@{falling_collision_damage_notes}}}" name="roll_dmgFalling" class="roll_damage" />
									</div>
									<div class="cell reset">
										<button type="action" name="act_collision_reset" class="reset"><span data-i18n="reset-label">Reset</span></button>
									</div>
								</div>
								
							</div> <!-- .container -->
							
						</div> <!-- .table -->
					</div> <!-- .box .falling and collision -->
			
			
					<!-- Demolition -->
					<div class="box demolition">
						<div class="table">
							
							<div class="row title">
								<div class="cell">
									<span data-i18n="demolition-label">Demolition</span>
								</div>
							</div>
							
							<div class="header">
								<div class="cell row-title">&nbsp;</div>
								<div class="cell select-box">
									<div class="popup">
										<span data-i18n="select-label">Select</span>
									</div>
									<span class="tooltip">
										<span data-i18n="demolition-select-tooltip">Select an explosion type to use. This will populate Type and REF fields.</span>
									</span>
								</div>
								<div class="cell text-box">
									<div class="popup">
										<span data-i18n="type-label">Type</span>
									</div>
									<span class="tooltip">
										<span data-i18n="demolition-type-tooltip"><strong>Type</strong><br />Refer to the REF table B415.</span>
									</span>
								</div>
								<div class="cell input">
									<div class="popup">
										<span data-i18n="abbreviation-relative-explosive-force-label">REF</span>
									</div>
									<span class="tooltip">
										<span data-i18n="relative-explosive-force-tooltip">
			Relative Explosive Force, equivalence in pounds of TNT.<br />
			TNT = 1.0. See B415.
										</span>
									</span>
								</div>
								<div class="cell input">
									<div class="popup">
										<span data-i18n="abbreviation-pounds-label">lbs</span>
									</div>
									<span class="tooltip">
										<span data-i18n="demolition-pounds-tooltip">Weight in pounds required by its REF.</span>
									</span>
								</div>
								<div class="cell input">
									<div class="popup">
										<span data-i18n="base-level-label">Base</span>
									</div>
									<span class="tooltip">
										<span data-i18n="demolition-base-damage-tooltip">Base damage role. Rules as written is 6d6.</span>
									</span>
								</div>
								<div class="cell six-d-spacer">&nbsp;</div>
								<div class="cell damage">
									<div class="popup">
										<span data-i18n="abbreviation-multiplier-label">Multi</span>
									</div>
									<span class="tooltip">
										<span data-i18n="damage-multiplier-tooltip">
			<strong>Damage Multiplier:</strong><br />Enter the number to multiply 6d6 by.<br />
			An explosion doing 6dx<i>n</i> damage takes (<i>n</i>x<i>n</i>)/4 pounds of TNT.<br />
			<b>NOTE:</b> Anyone caught in a blast may attempt an active defense<br />
			roll to dive for cover from the explosion’s collateral damage and<br />
			fragmentation; see Dodge and Drop B377.
										</span>
									</span>
								</div>
								<div class="cell roll-damage">
									<div class="popup">
										<span data-i18n="abbreviation-radius-label">Rad</span>
									</div>
									<span class="tooltip">
										<span data-i18n="radius-collateral-damage-tooltip">
			Radius of collateral damage. See B414<br />
			For instance, if an explosion does 6dx2 damage,<br />
			everyone within 24 yards is vulnerable.<br />
			<br />
			For fragmentation damage, the radius is<br />
			5 x dice of fragmentation damage.
										</span>
									</span>
								</div>
								<div class="cell roll-damage">
									<div class="popup">
										<span data-i18n="abbreviation-divisor-label">Div</span>
									</div>
									<span class="tooltip">
										<span data-i18n="demolition-armor-devisor-tooltip">
			Divisor. Amount to divide damage by based on<br />
			distance from blast. See B414<br />
			You can enter: <b>3</b> (default), 2, or 1.<br />
			Default: Damage rolled / (3 x distance blast).<br />
			Damage Modifiers Explosion, see B104.<br />
			Exp. +100% = Damage rolled / (2 x distance from blast).<br />
			Exp. +150% = Damage rolled / (1 x distance from blast).<br />
										</span>
									</span>
								</div>
								<div class="cell roll-damage">
									<div class="popup">
										<span data-i18n="abbreviation-target-label">TGT</span>
									</div>
									<span class="tooltip">
										<span data-i18n="demolition-target-tooltip">
			Target's distance from center of blast.<br />
			Damage / (3 x distance from blast). Round down.<br />
			See B414
										</span>
									</span>
								</div>
								<div class="cell roll-damage">
									&nbsp;
								</div>
								<div class="cell reset">
									&nbsp;
								</div>
							</div> <!-- .header -->
							
							<div class="container">
								
								<div class="row">
									<div class="cell row-title">
										<div class="popup">
											<span data-i18n="how-much-label">How Much?</span>
										</div>
										<span class="tooltip">
											<span data-i18n="demolition-how-much-tooltip">
			Determine how much explosive to use based on damage. TNT = 1.0<br />
			See B415.
											</span>
										</span>
									</div>
									<div class="cell select-box">
										<select name="attr_demo_how_much_selected_type">
											<option>TNT</option>
											<option>Serpentine Powder</option>
											<option>Ammonium Nitrate</option>
											<option>TL4 Black Powder</option>
											<option>TL5 Black Powder</option>
											<option>Diesel/Fertilizer</option>
											<option>Dynamite</option>
											<option>Amatol</option>
											<option>Nitroglycerine</option>
											<option>Tetryl</option>
											<option>Composition B</option>
											<option>C4</option>
											<option>Octanitrocubane</option>
											<option>Metallic Hydrogen</option>
										</select>
									</div>
									<div class="cell text-box">
										<input type="text" value="TNT" name="attr_demo_how_much_type" title="Macro name: demo_how_much_type" />
									</div>
									<div class="cell input">
										<input type="number" value="1.0" min="0" step=".01" name="attr_demo_how_much_ref" title="Macro name: demo_how_much_ref" />
									</div>
									<div class="cell input">
										<input type="number" value="1" readonly="readonly" name="attr_demo_how_much_weight" title="Macro name: demo_how_much_weight" />
									</div>
									<div class="cell input">
										<input type="text" value="6d6" name="attr_demo_how_much_base_damage" title="Macro name: demo_how_much_base_damage" />
									</div>
									<div class="cell six-d-spacer">X</div>
									<div class="cell damage">
										<input type="number" value="1" min="1" step="1" name="attr_demo_how_much_damage_multiplier" title="Macro name: demo_how_much_damage_multiplier" />
									</div>
									<div class="cell roll-damage">
										<input type="text" readonly="readonly" value="12" name="attr_demo_how_much_radius" title="Macro name: demo_how_much_radius" />
									</div>
									<div class="cell roll-damage">
										<input type="number" value="3" min="1" step="1" max="3" name="attr_demo_how_much_divisor" title="Macro name: demo_how_much_divisor" />
									</div>
									<div class="cell roll-damage">
										<input type="number" value="0" min="0" step="1" name="attr_demo_how_much_target_distance" title="Macro name: demo_how_much_target_distance" />
									</div>
									<div class="cell roll-damage">
										<input type="hidden" name="attr_demo_how_much_damage_dice_icon" class="thrust-damage-dice-icon" value="explode" />
										<input type="hidden" name="attr_demo_how_much_damage_divisor" value="1" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type='crush ex' or 'burn ex'}} {{characterName=@{character_name}}} {{skillName=Demolition Damage @{demo_how_much_type}}} {{damageRoll=[[ floor( (@{demo_how_much_base_damage} * @{demo_how_much_damage_multiplier}) / @{demo_how_much_damage_divisor} )]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Crush min 0, else min 1}} {{showNotes=[[1]]}} {{notes=@{demolition_damage_notes}}}" name="roll_dmgDemo" class="roll_damage" />
									</div>
									<div class="cell reset">
										<button type="action" name="act_demo_how_much_reset" class="reset"><span data-i18n="reset-label">Reset</span></button>
									</div>
								</div>
								
								<div class="row">
									<div class="cell row-title">
										<div class="popup">
											<span data-i18n="how-big-label">How Big?</span>
										</div>
										<span class="tooltip">
											<span data-i18n="demolition-how-big-tooltip">
			Determine how big the explosion is based on weight.<br />
			See B415.
											</span>
										</span>
									</div>
									<div class="cell select-box">
										<select name="attr_demo_how_big_selected_type">
											<option>TNT</option>
											<option>Serpentine Powder</option>
											<option>Ammonium Nitrate</option>
											<option>TL4 Black Powder</option>
											<option>TL5 Black Powder</option>
											<option>Diesel/Fertilizer</option>
											<option>Dynamite</option>
											<option>Amatol</option>
											<option>Nitroglycerine</option>
											<option>Tetryl</option>
											<option>Composition B</option>
											<option>C4</option>
											<option>Octanitrocubane</option>
											<option>Metallic Hydrogen</option>
										</select>
									</div>
									<div class="cell text-box">
										<input type="text" value="TNT" name="attr_demo_how_big_type" title="Macro name: demo_how_big_type" />
									</div>
									<div class="cell input">
										<input type="number" value="1.0" min="0" step=".01" name="attr_demo_how_big_ref" title="Macro name: demo_how_big_ref" />
									</div>
									<div class="cell input">
										<input type="number" value="1" min=".01" step=".01" name="attr_demo_how_big_weight" title="Macro name: demo_how_big_weight" />
									</div>
									<div class="cell input">
										<input type="text" value="6d6" name="attr_demo_how_big_base_damage" title="Macro name: demo_how_big_base_damage" />
									</div>
									<div class="cell six-d-spacer">X</div>
									<div class="cell damage">
										<input type="number" value="1" readonly="readonly" name="attr_demo_how_big_damage_multiplier" title="Macro name: demo_how_big_damage_multiplier" />
									</div>
									<div class="cell roll-damage">
										<input type="text" readonly="readonly" value="12" name="attr_demo_how_big_radius" title="Macro name: demo_how_big_radius" />
									</div>
									<div class="cell roll-damage">
										<input type="number" value="3" min="1" step="1" max="3" name="attr_demo_how_big_divisor" title="Macro name: demo_how_big_divisor" />
									</div>
									<div class="cell roll-damage">
										<input type="number" value="0" min="0" step="1" name="attr_demo_how_big_target_distance" title="Macro name: demo_how_big_target_distance" />
									</div>
									<div class="cell roll-damage">
										<input type="hidden" name="attr_demo_how_big_damage_dice_icon" class="thrust-damage-dice-icon" value="explode" />
										<input type="hidden" name="attr_demo_how_big_damage_divisor" value="1" />
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type='crush ex' or 'burn ex'}} {{characterName=@{character_name}}} {{skillName=Demolition Damage @{demo_how_big_type}}} {{damageRoll=[[ floor( (@{demo_how_big_base_damage} * @{demo_how_big_damage_multiplier}) / @{demo_how_big_damage_divisor} )]]}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Crush min 0, else min 1}} {{showNotes=[[1]]}} {{notes=@{demolition_damage_notes}}}" name="roll_dmgDemo" class="roll_damage" />
									</div>
									<div class="cell reset">
										<button type="action" name="act_demo_how_big_reset" class="reset"><span data-i18n="reset-label">Reset</span></button>
									</div>
								</div>
								
								<div class="row">
									<div class="cell row-title">
										<div class="popup">
											<span data-i18n="fragmentation-label">Fragmentation</span>
										</div>
										<span class="tooltip">
											<span data-i18n="fragmentation-damage-tooltip">
			Fragmentation damage.<br />
			See B415.
											</span>
										</span>
									</div>
									<div class="cell select-box"></div>
									<div class="cell text-box">
										<div class="popup frag-label">
											<span data-i18n="skill-label">Skill</span>
										</div>
										<span class="tooltip">
											<span data-i18n="fragmentation-skill-tooltip">
			Base skill level for a fragmentation damage to hit a target.<br />
			A hit is <b>automatic</b> if the explosive attack actually strikes the target.<br />
			Only three modifiers apply: the <b>range modifier</b> for the distance from the center<br />
			of the blast to the target, the modifier for the <b>target’s posture</b> (prone, etc.),<br />
			and the target’s <b>Size Modifier</b>. It is possible for several fragments to hit! For<br />
			every <b>three points</b> by which the attack roll succeeds, one additional fragment
			<br />strikes the target.
											</span>
										</span>
									</div>
									<div class="cell input">
										<input type="number" value="15" step="1" name="attr_fragmentation_skill" />
									</div>
									<div class="cell input">
										<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Ranged Attack}} {{activeDefense=[[0]]}} {{isSkillRoll=[[1]]}} {{showHitLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=Fragmentation Damage}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[@{fragmentation_skill} + @{modifier}]]}} {{notes=@{fragmentation_skill_notes}}} {{showNotes=[[1]]}} {{recoil=@{fragmentation_recoil}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}}" />
									</div>
									<div class="cell input">
										<input type="text" value="1d6" name="attr_fragmentation_damage" title="Macro name: fragmentation_damage" />
									</div>
									<div class="cell six-d-spacer"></div>
									<div class="cell damage">
									</div>
									<div class="cell roll-damage">
										<input type="text" readonly="readonly" value="12" name="attr_fragmentation_radius" title="Macro name: fragmentation_radius" />
									</div>
									<div class="cell roll-damage">
									</div>
									<div class="cell roll-damage">
									</div>
									<div class="cell roll-damage">
										<input type="hidden" name="attr_damage_dice_icon" class="thrust-damage-dice-icon" value="explode" />
										<button type="roll" name="roll_vsSL" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Ranged Damage}} {{characterName=@{character_name}}} {{skillName=Fragmentation Damage}} {{damageRoll=[[ @{fragmentation_damage} ]]}} {{damageType=Cutting (cut)}} {{showMinimumDmgNote=[[@{show_minimum_damage_notes}]]}} {{minDamageNote=Cutting min 1}} {{showNotes=[[1]]}} {{notes=@{fragmentation_damage_notes}}}" name="roll_dmgDemo" class="roll_damage" />
									</div>
									<div class="cell reset">
									</div>
								</div>
								
							</div> <!-- .container -->
							
						</div> <!-- .table -->
					</div> 
					<!-- end demolition -->
			
				</div>	

			</div>

		</div>

	</div> <!-- .tab4 -->


	<!-- ===== ===== ===== ===== ITEMS TAB ===== ===== ===== ===== -->
	<div class="tab5">

		<!-- _____ _____ QUICK INVENTORY BOX _____ _____ -->

		<div class="box quick-inventory textarea">
			<div class="header"> 
				<div class="cell col0"><span data-i18n="quick-inventory-label">Quick Inventory</span></div>
			</div>
			<div class="quick-inventory-textarea">
			    <textarea name="attr_quick_inventory" title="Macro name: quick_inventory"></textarea>
			</div>
		</div>

		<!-- _____ _____ INVENTORY BOX _____ _____ -->

		<div class="box items">
			<div class="table">
				<div class="header">
					<div class="cell col0"><span data-i18n="inventory-label">Inventory</span></div>
					<div class="cell col-location"><span data-i18n="location-label">Location</span></div>
					<div class="cell col1"><span data-i18n="abbreviation-technology-level-label">TL</span></div>
					<div class="cell col1">
						<div class="popup"><span data-i18n="abbreviation-legality-class-label">LC</span></div>
						<div class="tooltip tooltip-spell-ref">
							<span data-i18n="legality-class-tooltip">
								Legality Class B267.
							</span>
						</div>
					</div>
					<div class="cell col2">
						<div class="popup"><span data-i18n="abbreviation-book-reference-label">Ref</span></div>
						<div class="tooltip tooltip-spell-ref">
							<span data-i18n="book-reference-tooltip">
								Reference to book and page numbers.<br />
								Examples:<br />
								B238 = GURPS Basic, Page 238<br />
								PU2:126 = Power-Ups 2. Page 126<br />
							</span>
						</div>
					</div>
					<div class="cell col3">
						<div class="popup"><span data-i18n="on-label">On</span></div>
						<span class="tooltip">
							<span data-i18n="inventory-carried-tooltip">
								Carried<br />
								Is the item being carried at the moment?
							</span>
						</span>
					</div>
					<div class="cell col4">#</div>
					<div class="cell col5">$</div>
					<div class="cell col6">W</div>
					<div class="cell col7">$+</div>
					<div class="cell col8">W+</div>
				</div>
				<fieldset class="repeating_item">
					<input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight" />
					<input class="toggle toggle-notes" type="checkbox" title="Click to show/hide more information." name="attr_item_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<input type="text" name="attr_name" title="Macro table name: repeating_item. Field name: name" />
						</div>
						<div class="cell col-location">
							<input type="text" name="attr_location" title="Macro table name: repeating_item. Field name: location" />
						</div>
						<div class="cell col1">
							<input type="text" name="attr_tl" title="Macro table name: repeating_item. Field name: tl" />
						</div>
						<div class="cell col1">
							<input type="number" step="1" min="0" max="4" name="attr_legality_class" title="Macro table name: repeating_item. Field name: legality_class" />
						</div>
						<div class="cell col2">
							<input type="text" name="attr_ref" title="Macro table name: repeating_item. Field name: ref" />
						</div>
						<div class="cell col3">
							<input class="boolean" type="checkbox" name="attr_carried" value="1" checked title="Macro table name: repeating_item. Field name: carried" />
						</div>
						<div class="cell col4">
							<input type="number" name="attr_count" value="1" title="Macro table name: repeating_item. Field name: count" />
						</div>
						<div class="cell col5">
							<input type="number" name="attr_cost" value="0.00" step="0.01" title="Macro table name: repeating_item. Field name: cost" />
						</div>
						<div class="cell col6">
							<input type="number" name="attr_weight" value="0.000" step="0.001" title="Macro table name: repeating_item. Field name: weight" />
						</div>
						<div class="cell col7" style="text-align: right;background-color: #c9c9c9;border-bottom: 1px solid white;border-right: 1px solid white;">
							<span name="attr_costtotal" value="0.00" title="Macro table name: repeating_item. Field name: costtotal" />
						</div>
						<div class="cell col8" style="text-align: right;background-color: #c9c9c9;border-bottom: 1px solid white;border-right: 1px solid white;">
							<input type="hidden" name="attr_inventory_item_carried" value="1" />
							<span name="attr_weighttotal" value="0.000" class="item-weight-total" title="Macro table name: repeating_item. Field name: weighttotal" />
						</div>
					</div> <!-- .row -->
					<div class="row row-details notebox">
						<div class="cell col-notebox">
						    <div class="show-notes">
						        <span class="label">
									<span data-i18n="notes-label">Notes</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_item. Field name: notes"></textarea>
						</div>
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_item -->
				<div class="row row-totals">
					<div class="cell col0">
						<div class="cell" style="width: 50px;">
							<div class="popup" style="font-weight: bold;">
								<span data-i18n="gravity-label">Gravity</span><span>:</span>
							</div>
							<div class="tooltip">
								<span data-i18n="gravity-tooltip">Standard gravity is based on 1G, earth normal.<br />If gravity is over 1G, then add <i>your</i> weight and encumberance then multiply by Gravity - 1. Add this value to your encumbrance.<br />If gravity is less than 1G, multiply the weight of your gear by the Gravity value, this is your new encumbrance.<br />See B350.</span>
							</div>
						</div>
						<div class="cell" style="width: 35px;">
							<input type="number" value="1" step=".01" min=".01" name="attr_gravity" title="Macro: @{gravity}" />
						</div>
					</div>
					<div class="cell col1">
						<div style="text-align: right; font-weight: bold;" class="popup">
							<span data-i18n="total-inventory-value-label">Total Inventory Value:</span>
						</div>
						<div class="tooltip">
							<span data-i18n="total-inventory-value-tooltip">
								Total monetary value of all items (carried or not).
							</span>
						</div>
					</div>
					<div class="cell col2">
						<input type="number" style="font-weight: bold;" step=".01" name="attr_total_value" value="0" readonly="readonly" title="Macro name: total_value" />
					</div>
					<div class="cell col3">
						<div style="text-align: right; font-weight: bold;" class="popup">
							<span data-i18n="total-inventory-weight-label">Total Inventory Weight:</span>
						</div>
						<div class="tooltip">
							<span data-i18n="total-inventory-weight-tooltip">
								Total weight of all items carried.
							</span>
						</div>
					</div>
					<div class="cell col4">
						<input type="hidden" name="attr_total_weight" value="" />
						<input type="text" style="font-weight: bold; text-align: center;" name="attr_total_weight_gravity" value="" readonly="readonly" title="Macro: @{total_weight_gravity}" />
					</div>
					<div class="cell col5">
						<div style="text-align: right; font-weight: bold;" class="popup">
							<span data-i18n="grand-total-weight-label">Grand Total Weight:</span>
						</div>
						<div class="tooltip">
							<span data-i18n="grand-total-weight-tooltip">
								Grand total of PC's weight: <span style="background-color: white; font-weight: bold; text-decoration: underline;" name="attr_weight" value="0"></span>, and all items carried.
							</span>
						</div>
					</div>
					<div class="cell col6">
						<input type="number" style="font-weight: bold; text-align: center;" step=".001" name="attr_grand_total_weight" value="0" readonly="readonly" title="Macro name: grand_total_weight" />

					</div>					
				</div> <!-- .row -->
			</div> <!-- .table -->
		</div> <!-- .box .items -->

	</div> <!-- .tab5 -->


	<!-- ===== ===== ===== ===== GRIMOIRE TAB ===== ===== ===== ===== -->
	<div class="tab6">

		<!-- _____ _____ SPELLS SETUP _____ _____ -->
		<div class="box spells spell-stats">
			<div class="table">
				<div class="header spell-stats-header">
					<div class="cell"><span data-i18n="spells-based-on-label">Spells Based on:</span></div>
					<div class="cell margin-right">
						<select name="attr_spell_base" title="Macro name: spell_base">
							<option value="@{strength}"><span data-i18n="abbreviation-option-strength">ST</span></option>
							<option value="@{dexterity}"><span data-i18n="abbreviation-option-dexterity">DX</span></option>
							<option value="@{intelligence}" selected><span data-i18n="abbreviation-option-intelligence">IQ</span></option>
							<option value="@{health}"><span data-i18n="abbreviation-option-health">HT</span></option>
							<option value="@{willpower}"><span data-i18n="abbreviation-option-will">Will</span></option>
							<option value="@{perception}"><span data-i18n="abbreviation-option-perception">Per</span></option>
							<option value="10">10</option>
						</select>
					</div>
					<div class="cell"><span data-i18n="magery-power-investiture-bonus-label">Magery/PI/Bonus Level:</span></div>
					<div class="cell margin-right">
						<input type="number" name="attr_spell_bonus" value="0" title="Macro name: spell_bonus" />
					</div>
					<div class="cell">
					    <div class="popup"><span data-formula="on-penalty-label">On Penalty</span></div>
						<div class="tooltip">
							<span data-formula="spell-on-penalty-tooltip">
								Spell skill penalty based on number of <b>ON</b> spells.<br />
								<input type="hidden" name="attr_spell_on_count" value="0" />
								Number of spells <b>ON:</b> <span name="attr_spell_on_count"></span>.<br />
								<i>NOTE:</i> Use the options tab to adjust the penalty per spell <b>ON</b>.
							</span>
						</div>
					</div>
					<div class="cell margin-right">
						<input type="number" name="attr_spell_on_penalty_total" value="0" title="Macro name: spell_on_penalty_total" readonly="readonly" />
					</div>
					<div class="cell">
					    <div class="popup"><span data-i18n="cencentration-penalty-label">Concentration Penalty</span></div>
						<div class="tooltip">
							<span data-i18n="cocentration-penalty-tooltip">
								<b>Concentration</b> spell penalty<br />
								<input type="hidden" name="attr_spell_maintained_count" value="0" />
								Number of spells: <span name="attr_spell_maintained_count"></span>.<br />
								<i>NOTE:</i> Use options tab to adjust the penalty.
							</span>
						</div>
					</div>
					<div class="cell margin-right">
						<input type="number" name="attr_spell_maintained_penalty_total" value="0" title="Macro name: spell_maintained_penalty_total" readonly="readonly" />
					</div>
				</div>
			</div>
		</div>


		<!-- _____ _____ SPELLS BOX _____ _____ -->

		<div class="box spells">
			<div class="table">
				<div class="header">
					<div class="cell col0">
					    <div class="popup"><span data-i18n="spell-label">Spell</span></div>
						<div class="tooltip">
							<span data-i18n="activate-custom-roll-modifier-tooltip">To turn on the custom modifiers and button to open the <b>Roll Modifier</b> dialog box goto the <b>Sheet Options</b> tab and check off the tools you would like to user under <b>Skill Modifier Tools</b> section.</span>
						</div>
					</div>
					<div class="cell col1"></div>
					<div class="cell col2">
					    <div class="popup"><span data-i18n="abbreviation-level-label">LVL</span></div>
						<div class="tooltip">
							<span data-i18n="spell-skill-level-tooltip">
								Skill level with spell
							</span>
						</div>
					</div>
					<div class="cell col3">
					    <div class="popup"><span data-i18n="abbreviation-difficulty-label">Diff</span></div>
						<div class="tooltip">
							<span data-i18n="spell-difficulty-tooltip">Difficulty</span>
						</div>
					</div>
					<div class="cell col4">
					    <div class="popup"><span data-i18n="abbreviation-modifier-label">Mod</span></div>
						<div class="tooltip">
							<span data-i18n="spell-skill-level-modifier-tooltip">
								Modifier applied to skill level.<br />
								Can be a positive or a negative number.<br />
								Examples include a bonus from a Talent,<br />
								default from another Skill or Technique,<br />
								a piece of equipment, or a Perk.
							</span>
						</div>
					 </div>
					<div class="cell col5">
					    <div class="popup"><span data-i18n="abbreviation-character-points-label">Pts</span></div>
						<div class="tooltip">
						   <span data-i18n="points-tooltip">Points</span>
						</div>
					</div>
					<div class="cell col12">
					    <div class="popup"><span data-i18n="on-label">On</span></div>
						<div class="tooltip">
							<span data-i18n="spell-is-on-tooltip">
								Enter a 1 or more to mark the spell as <b>ON</b><br />
								<b><span name="attr_penalty_per_spell_on"></span></b> skill penalty for each spell that is <b>ON</b>.<br />
								See B238 or M10.<br/>
								Click one at a time, wait until each penalty is applied before clicking the next one.
							</span>
						</div>
					</div>
					<div class="cell col12">
					    <div class="popup"><span data-i18n="abbreviation-concentration-label">CT</span></div>
						<div class="tooltip">
							<span data-i18n="spell-concentration-tooltip">
								Enter a 1 or more to mark the spell as <b>Under Concentration</b>.<br />
								<b><span name="attr_penalty_per_spell_maintained"></span></b> skill penalty for each spell.<br />
								See B238 or M10.<br/>
								Click one at a time, wait until each penalty is applied before clicking the next one.
							</span>
						</div>
					</div>
					<div class="cell col7">
					    <div class="popup"><span data-i18n="abbreviation-resisted-by-label">RESIST</span></div>
						<div class="tooltip">
							<span data-i18n="spell-resisted-by-tooltip">
								Resisted By
							</span>
						</div>
					</div>
					<div class="cell col8">
					    <div class="popup"><span data-i18n="duration-label">Duration</span></div>
						<div class="tooltip">
							<span data-i18n="spell-duration-tooltip">
								Duration of Spell
							</span>
						</div>
					</div>
					<div class="cell col9">
					    <div class="popup"><span data-i18n="cost-label">Cost</span></div>
						<div class="tooltip">
							<span data-i18n="spell-energy-cost-tooltip">
								Energy cost for casting the spell.
							</span>
						</div>
					</div>
					<div class="cell col10">
					    <div class="popup"><span data-i18n="time-label">Time</span></div>
						<div class="tooltip tooltip-spell-time">
							<span data-i18n="spell-casting-time-tooltip">
								Amount of time to cast the spell.
							</span>
						</div>
					</div>
					<div class="cell col11">
					    <div class="popup"><span data-i18n="maintain-label">Maintain</span></div>
						<div class="tooltip">
							<span data-i18n="spell-cost-to-maintain-tooltip">
								Energy cost to maintain the spell.
							</span>
						</div>
					</div>
				</div> <!-- .header -->

				<!-- attr_use_spell_modifier_tool is linked to checkbox on options sheet -->
				<input type="hidden" name="attr_use_spell_modifier_tool" value="0" />
				<div class="row roll-modifiers">
					<div class="cell label">
						<div class="popup">
							<span data-i18n="modifier-label">Modifier:</span>
						</div>
						<div class="tooltip">
							<span data-i18n="modifier-dialog-tooltip">Enter a modifier to apply to any rolls on the this table.<br />Use the pencil/paper icon to select modifiers.<br /><b>NOTE:</b> Changing the modifier or check status of <i>Max skill of 9</i> will clear modifiers used by dialog box.</span>
						</div>
					</div>
					<div class="cell number-input">
						<input type="number" value="0" step="1" name="attr_spell_roll_modifier" />
						<input type="hidden" value="" name="attr_spell_roll_modifier_summary" />
						<input type="hidden" value="" name="attr_spell_roll_trait_summary" />
						<input type="hidden" value="" name="attr_spell_roll_hit_location" />
						<input type="hidden" value="" name="attr_spell_roll_maneuver" />
						<input type="hidden" value="" name="attr_spell_roll_allout_attack" />
					</div>
					<div class="cell">
						<button type="action" name="act_show_roll_modifiers_for_spell" class="btn" title="Select Skill Modifiers"><span data-i18n="select-skill-modifiers-button">Select Skill Modifiers</span></button>
					</div>
					<div class="cell cell-popup">
						<div>
							<input type="checkbox" name="attr_spell_roll_max_nine" value="1" title="Macro: @{spell_roll_max_nine}" />
							<input type="hidden" name="attr_spell_roll_max_nine_value" value="100" />
						</div>
						<div>
							<div class="popup">
								<span data-i18n="max-skill-9-label">Max skill of 9</span>
							</div>
							<div class="tooltip max-skill-9">
								<span data-i18n="max-skill-9-tooltip">The effective skill cannot exceed 9.</span>
							</div>
						</div>
					</div>
					<div class="cell">
						<button type="action" name="act_spell_roll_reset" class="btn tool-modifier-reset" title="Reset Skill Modifiers"><span data-i18n="reset-label">Reset</span></button>
					</div>
					<div class="cell">
						<div class="summary-group">
							<div class="icon"><span data-i18n="notes-label">Notes</span></div>
							<div class="summary">
								<div class="roll-traits">
									<b>Traits:</b>
									<div>
										<span name="attr_spell_roll_trait_summary"></span>
									</div>
								</div>
								<div class="roll-summary">
									<b>Summary:</b>
									<div>
										<span name="attr_spell_roll_modifier_summary"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<fieldset class="repeating_spells">
				    <input class="toggle-highlight" type="checkbox" title="Check to highlight row" name="attr_highlight" />
					<input class="toggle toggle-notes" type="checkbox" title="Click to show/hide more information." name="attr_spell_toggle_notes" />
					<span class="checkbox"></span>
					<div class="row row-stats">
						<div class="cell col0">
							<input type="text" name="attr_name" title="Macro table name: repeating_spells. Field name: name" />
						</div>
						<div class="cell col1">
							<button type="roll" value="@{roll}&{template:skillRoll} {{sheetStyle=@{sheetstyle}}} {{type=Spell Skill Roll}} {{activeDefense=[[0]]}} {{isSkillRoll=[[1]]}} {{showSuccessLabel=[[1]]}} {{characterName=@{character_name}}} {{skillName=@{name}}} {{rollResult=[[3d6]]}} {{effectiveSkill=[[{@{level} + @{modifier} + @{spell_roll_modifier}, @{spell_roll_max_nine_value} }kl1]]}} {{useModToll=[[@{use_spell_modifier_tool}]]}} {{maxNine=[[@{spell_roll_max_nine}]]}} {{rollModifier=[[@{spell_roll_modifier}]]}} {{rollModifierSummary=@{spell_roll_modifier_summary}}} {{rollTraitSummary=@{spell_roll_trait_summary}}} {{notes=@{notes}}} {{showNotes=[[@{show_notes}]]}} {{castingTime=@{casttime}}} {{castingDuration=@{duration}}} {{castingCost=@{cost}}} {{castingMaintain=@{maintain}}} {{castingResist=@{spell_resisted_by}}} {{castingClass=@{spell_class}}} {{bookReference=@{ref}}} {{useCriticalPlusTen=[[@{use_critical_plus_10}]]}} {{customSuccessNote=@{spell_success_note}}} {{customCriticalSuccessNote=@{spell_critical_success_note}}} {{customFailNote=@{spell_fail_note}}} {{customCriticalFailNote=@{spell_critical_fail_note}}} {{spellRoll=true}} {{spellCriticalSuccessNote=@{spell_critical_success_notes}}} {{spellFailNote=@{spell_fail_notes}}} {{spellCriticalFailureNote=@{spell_critical_failure_notes}}} {{showCastingDetails=[[@{show_casting_details}]]}} {{showSpellNotes=[[@{show_spell_notes}]]}} {{spellNotes=@{spell_notes}}}" name="roll_vsSL" />
						</div>
						<div class="cell col2">
						    <input type="hidden" name="attr_level_mirror" value="0" />
							<input type="text" name="attr_level" title="Macro table name: repeating_spells. Field name: level" disabled="disabled" value="@{spell_base} + @{difficulty} +@{spell_modifier} + @{spell_bonus} + (floor((@{points} * 0.25) + 2) * ceil( ( ( @{points} - 2 ) + abs( @{points} - 2) ) / 256 ) + @{points} * abs( ceil( ( ( @{points} - 2 ) + abs( @{points} - 2) ) / 256 ) - 1 ))"/>
						</div>
						<div class="cell col3">
							<select name="attr_difficulty" title="Macro table name: repeating_spells. Field name: difficulty">
								<option value="-3" selected="selected"><span data-i18n="abbreviation-option-hard">H</span></option>
								<option value="-4"><span data-i18n="abbreviation-option-very-hard">VH</span></option>
							</select>
						</div>
						<div class="cell col4">
							<input type="number" name="attr_spell_modifier" value="0" title="Macro table name: repeating_spells. Field name: spell_modifier" />
						</div>
						<div class="cell col5">
							<input type="number" name="attr_points" value="1" title="Macro table name: repeating_spells. Field name: points" />
						</div>
						<div class="cell col12">
							<input type="number" value="" min="0" max="20" step="1" title="Adjust to mark spell as on." name="attr_spell_on_checked" />
						</div>
						<div class="cell col12">
							<input type="number" value="" min="0" max="20" step="1" title="Adjust to mark spell as on." name="attr_spell_maintained_checked" />
						</div>
						<div class="cell col7">
							<input type="text" name="attr_spell_resisted_by" placeholder="Resist" title="Macro table name: repeating_spells. Field name: spell_resisted_by" />
						</div>
						<div class="cell col8">
							<input type="text" name="attr_duration" placeholder="Duration" title="Macro table name: repeating_spells. Field name: duration" />
						</div>
						<div class="cell col9">
							<input type="text" name="attr_cost" placeholder="Cost to Cast" title="Macro table name: repeating_spells. Field name: cost" />
						</div>
						<div class="cell col10">
							<input type="text" name="attr_casttime" placeholder="Casting Time" title="Macro table name: repeating_spells. Field name: casttime" />
						</div>
						<div class="cell col11">
							<input type="text" name="attr_maintain" placeholder="Cost to Maintain" title="Macro table name: repeating_spells. Field name: maintain" />
						</div>
					</div> <!-- .row -->
					
					<div class="row row-details notebox">
						
						<div class="row-misc row-college">
							<div class="cell label">
							    <div class="popup"><span data-i18n="row-id-label">Row ID:</span></div>
        						<span class="tooltip">
        							<span data-i18n="row-id-tooltip">
										The row id can be used with macros.<br />
										NOTE: Future use for linking to techniques<br />
										and combat skills.<br />
										Example field name: repeating_skills_[the row id]_level<br />
										This example would represent the skill level on that row.
									</span>
        						</span> 
							</div>
							<div class="cell">
							    <input type="text" readonly="readonly" name="attr_row_id" value="" />
							</div>
							<div class="cell align-right col3">
								<input type="text" name="attr_ref" title="Macro table name: repeating_spells. Field name: ref" />	
							</div>
							<div class="cell align-right ref-label">
								<div class="popup"><span data-i18n="abbreviation-book-reference-label">Ref</span></div>
								<div class="tooltip tooltip-spell-ref">
									<span data-i18n="book-reference-tooltip">
										Reference to book and page numbers.<br />
										Examples:<br />
										B238 = GURPS Basic, Page 238<br />
										PU2:126 = Power-Ups 2. Page 126<br />
									</span>
								</div>
							</div>
						</div> <!-- .row -->

						<div class="row-misc row-college">
							<div class="cell label">
							    <span data-i18n="reason-for-modifier-label">Reason for MOD (Modifier):</span>
							</div>
							<div class="cell spell-mod-notes">
							    <input type="text" name="attr_spell_mod_notes" title="Macro table name: repeating_spells. Field name: spell_mod_notes" />
							</div>
						</div> <!-- .row -->
						
						<div class="row-misc row-college">
							<div class="cell label">
							    <div class="popup">
									<span data-i18n="class-label">Class</span>
								</div>
        						<div class="tooltip">
									<span data-i18n="spell-class-tooltip">
										Spell class; Area, Blocking, Information, Melee,<br />
										Missile, Regular, Regular (Jet), Resisted, Special
									</span>
        						</div>
							</div>
							<div class="cell">
							    <input type="text" name="attr_spell_class" title="Macro table name: repeating_spells. Field name: spell_class" />
							</div>
							<div class="cell label">
								<span data-i18n="colleges-label">Primary College:</span>
							</div>
							<div class="cell text-college-width">
								<input type="text" name="attr_spell_college" title="Macro table name: repeating_spells. Field name: spell_college" />
							</div>
							<div class="cell label">
								<span data-i18n="colleges-secondary-label">Secondary College:</span>
							</div>
							<div class="cell text-college-width">
								<input type="text" name="attr_spell_college_secondary" title="Macro table name: repeating_spells. Field name: spell_college_secondary" />
							</div>
							
						</div> <!-- .row -->

						<div class="header">
							<div class="popup"><span data-i18n="notes-label">Notes</span></div>
							<span class="tooltip">
								<span data-i18n="custom-success-fail-notes-tooltip">
									Success, critical success, fail, and critical fail<br />
									notes will be added to roll results.<br />
									You can add macros to these notes.<br />
									The width of these note boxes are set to help you<br />
									visualize what it will look like in chat.
								</span>
							</span>
						</div>
						<div class="col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-notes-below-label">Show notes below in roll template</span>
								</span>
						    </div>
						    <textarea name="attr_notes" title="Macro table name: repeating_spells. Field name: notes"></textarea>
						</div>
						
						<div class="col-notebox">
						    <div class="show-notes">
						        <input type="checkbox" name="attr_show_spell_notes" value="1" />
						        <span class="label">
									<span data-i18n="show-spell-modifier-notes-label">Show Spell Modifier notes (see actual spell description)</span>
								</span>
						    </div>
						    <textarea name="attr_spell_notes" title="Macro table name: repeating_spells. Field name: spell_notes"></textarea>
						</div>
						
						<div class="rolltable-result-notes">
						    
						    <div class="note-input">
						        <div class="note-title">
    						        <span data-i18n="success-note-label">Success Note:</span>
    						    </div>
						        <textarea name="attr_spell_success_note" title="Macro table name: repeating_spells. Field name: spell_success_note"></textarea>
						    </div>
						    
						    <div class="note-input">
						        <div class="note-title"><span data-i18n="critical-success-note-label">Critical Success Note:</span></div>
						        <textarea name="attr_spell_critical_success_note" title="Macro table name: repeating_spells. Field name: spell_critical_success_note"></textarea>
						    </div>
						    
						</div>
						
						<div class="rolltable-result-notes">
						    
						    <div class="note-input">
						        <div class="note-title"><div data-i18n="fail-note-label">Fail Note:</div></div>
						        <textarea name="attr_spell_fail_note" title="Macro table name: repeating_spells. Field name: spell_fail_note"></textarea>
						    </div>
						    
						    <div class="note-input">
						        <div class="note-title"><span data-i18n="critical-fail-note-label">Critical Fail Note:</span></div>
						        <textarea name="attr_spell_critical_fail_note" title="Macro table name: repeating_spells. Field name: spell_critical_fail_note"></textarea>
						    </div>
						    
						</div>
						
					</div> <!-- .row -->
				</fieldset> <!-- .repeating_spells -->
			</div> <!-- .table -->
		</div> <!-- .box .spells -->
	</div> <!-- .tab6 -->

    <!-- ===== ===== ===== ===== Revision History TAB ===== ===== ===== ===== -->
	<div class="tab7">

		<div>

			<h3>
				<span data-i18n="latest-changes-updated-label">Latest Changes: Updated</span>
				<!-- NOTE: set value by using var latestChangesDate = "DATE";  -->
				<input type="text" style="font-size: 20px; font-weight: bold; border-style: none;" name="attr_latest_changes" readonly="readonly"/>
			</h3>
			
			<h3>Point Summary</h3>
				
			<p>
				One of the most commented part about this character sheet is the Point Summary 
				which does not correspond to GCA nor GCS, and for that matter - any manual process. 
				Because of this, we have made a major change to the way the Point Summary totals are 
				shown on the General page. This is to take make it much easier for users of GCA and 
				GCS to compare the points allocated in GCA /GCS to their input into this sheet. To 
				take advantage of these changes you will have to make some manual changes to your existing PCs.
			</p>
				
			<p>
				Under Traits:
			</p>
				
			<ul>
				<li>
					Copy/Paste your current Perks that you have under Advantages and Quirks 
					under Disadvantages, to their newly created Repeating Sections respectively.
				</li>
				<li>
					Verify/Create or Copy/Paste your Racial Traits to its associate Repeating Section if you haven’t already.
				</li>
				<li>
					Appearance has been moved to the Bio/Misc page. The drop down is still there 
					BUT the points have been removed. You need to manually enter those points in 
					the appropriate Traits Repeating Section.
				</li>
				<li>
					Verify your Point Summary now under your chosen format of GCA or GCS. Those 
					that do not use either application should use the format they like best.
				</li>
			</ul>
			
			<h3>Suggestions</h3>
			
			<ul>
				<p>Please note: I, Mike W, and MadCoder are not one of the original authors of this sheet. All we have done is to fix a number of small issues, changed some formatting, and implemented some suggested changes. The basic functionality of the sheet has remained the same.</p>
						
				<p>To report any Issues or a Suggestion, please use the Roll20 forum under Character Sheets & Compendium. I have created a thread named: [GURPS] - Sheet #1 - Thread 1 (that seems to be similar to the naming convention used by other sheets).</p>
				
				<p>https://app.roll20.net/forum/post/6616836/gurps-number-1-thread-1/</p>
					
				<p>In your post, please specify if it is an Issue or Suggestion with as much detail information as possible. Screen shots help a lot! I am just learning to work with HTML and CSS so I may not be able to do everything requested. I make no promises on how fast I may be able to implement a Fix or a Suggestion - so please be patient. -Thanks, Mike W.</p>

				<p>If there are others that are working on or wish to work on this sheet, lets coordinate using the Roll20 forum for now - perhaps later we can use GitHub.</p>
			</ul>
			
			<h4>Version: <span name="attr_announcement_version"></span></h4>

			<p>Pull Request: <span name="attr_latest_changes"></span></p>

			<ul>
				<li>GCA Import Bug Fix. With the help of Gata, The Fabulous Iron Chef, and a discord user I was able to find a bug related to multiple attack modes.</li>
			</ul>

			<h4>Version: 2.6.5</h4>

			<p>Pull Request: 3/15/2021</p>

			<ul>
				<li>GCA Import Bug Fix. This could have prevented a language from importing correctly.</li>
				<li>Updated tooltip text for Unstun (aka Recover from stun) and death check. Suggestions provided by Justin. S.</li>
				<li>Fix display of Chat box roll results for Modifier when character sheet sytle is assigned to <b>Fabric</b>. Reported by Jared.</li>
			</ul>

			<h4>Version: 2.6.4</h4>

			<p>Pull Request: 2/22/2021</p>

			<ul>
				<li>Bug fix for Roll Options. If you selected <b>Private Roll</b>, the next time the sheet opens, it changed the option to <b>Custom Roll</b>. Reported by PL M.</li>
				<li>Chat Box, update display of Armor Divisor when rolling damage to use the same style as skill. Reported by Jared.</li>
				<li>GCA Import bug. Added some error checking to try to capture null data values for an advantage. Reported by Bob G.</li>
				<li>Combat Location Tab. Added character and campaign settings options to update <b>Current Hit Points</b> when location damage is changed.</li>
			</ul>

			<h4>Version: 2.6.3</h4>

			<p>Pull Request: 2/15/2021</p>
			<ul>
				<li>Added optional Header Buttons for selecting the <b>modifier types</b> for for skill rolls. Option can be selected on the sheet and campaign options.</li>
				<li>GCA Import, modifier notes. Updated import to handle cases modifiers of modifiers for a advantage/disadvantage. Reported by Valter</li>
				<li>GCA Import, fixed bug incorrect wealth level name.</li>
				<li>GCA Import, added more rules to capture frequency of appearance and self-control rolls for advantages/disadvantages.</li>
			</ul>

			<h4>Version 2.6.2</h4>

			<p>Pull Request: 2/1/2021</p>
			
			<ul>
				<li><b>Bio\Misc</b> tab. Added <b>Apply</b> checkbox for Size Modifier. If checked, the Size Modifier will change the required character points for <b>Strength</b> and <b>Hit Points</b>. If you spent too many character points on Strength, you will get a warning message.</li>
				<li>GCA Import. If character has Size Modifier 1 or higher, the <b>Apply</b> Size Modifier will be checked.</li>
				<li>Combat Tab. Moved Shotgun damage tool to the Ranged sub-tab.</li>
				<li>Combat Tool for Melee. Updated Size Modifier to use relative Size Modifier. Relative Size Modifier is Target Size - Your Size.
					<ul>
						<li>Requested by Charles and confirmed by PL M as addendum rule on FAQ site.</li>
						<li>See: http://www.sjgames.com/gurps/faq/FAQ4-3.html#SS3.4.2.23</li>
					</ul>
				</li>
				<li>
					Chat Roll Options. Added a campaign setting and sheet option to display <b>Public</b> and <b>Private</b> roll options in the header. Added an optional <b>Custom</b> roll options.
					<ul>
						<li><b>Note:</b> The custom option requires an API script that can intercept the roll template.</li>
						<li>For an example, see the <b>Blind Roll</b> API script, https://app.roll20.net/forum/permalink/5064809/</li>
					</ul>
				</li>
			</ul>

			<h4>Version: 2.6.1</h4>

			<p>Pull Request: 1/9/2021</p>

			<ul>
				<li>Fix spelling error for drowsy. Reported by Charles</li>
				<li>Fix bug with checkbox <b>Show casting details on roll template:</b>. The bug was if checked no roll is made, if unchecked the roll is made. Reported by Charles.</li>
				<li>Fix bug for mini-roll modifier tool. If Encumbrance level changed, the total may not calculate correctly. Reported by PL M.</li>
				<li>Fix but with range calculator. Math error calculating total distance when firing up. Reported by Idle</li>
			</ul>

			<h4>Version: 2.6.0</h4>

			<p>Pull Request: 1/4/2021</p>

			<ul>
				<li>Options tab. Created sub-tabs for <b>Sheet Options</b>, <b>Rules</b>, <b>Import</b></li>
				<li>Added GURPS Character Assistant Importer.</li>
				<li>Added Knockback as a damage type.</li>
				<li>Repeating Ranged Table. Fixed Malfuction Verify alignment.</li>
				<li>Repeating Melee and Ranged Tables. Added new field in expanded notes for Armor Divisor. If higher than 1, the AD will show on damage rolls.</li>
			</ul>

			<h4>Version: 2.5.4</h4>

			<p>Pull Request: 12/09/2020</p>
			
			<ul>
				<li>Melee and Ranged weapon tables. Added new tool to turn on option to use a selected token or target a token. This might allow more advanced features when using the Roll20 API.</li>
				<li>Roll Modifier Tool. Added a reset button and a note icons to view the summary of the roll modifiers.</li>
				<li>Roll Modifier Tool. Added a checkbox to apply encumbrance penalty skills, techniques, and active defenses.</li>
				<li>Roll Modifier Tool for Defense. Added drop-down to apply Shield DB and Magic DB to active defenses.</li>
				<li>Combat tab > Defense. Added option to display Defense Bonus Notes on roll result table. Requested by <i>Charles</i>.</li>
				<li>Roll Modifier Tool. Melee Attacks. Added <b>Flurry of Blows</b> and <b>Might Blow</b>. Requested by <i>Hypnobeard</i></li>
			</ul>

			<h4>Version: 2.5.3</h4>

			<p>Pull Request: 11/30/2020</p>

			<ul>
				<li>Urgent bugfix. Remove target option from melee button. </li>
				<li>Combat Tab > Melee table. Display swing & thrust damage, also widened the damage column a little to make easier to enter field values and formulas. Requested by PL M.</li>
				<li>Combat Tab. An Active Defense can now be linked to a melee weapon. This allows you assign a defense to melee weapon that has additional skill bonuses, like weapon bond.</li>
				<li>New Rolltemplate. A generic, simple template for use with macros. See below.</li>
			</ul>

			<h5>Rolltemplate for Macros</h5>

			<h6>Example Macro</h6>

			<div style="padding: 5px; background: #ccc;">
				&{template:macro}  {{templateType=dnd5e}} {{sheetStyle=4}} {{roll=[[3d6]]}} {{target=[[13]]}} {{title=Drake}} {{subtitle=Attacks Orc}} {{Damage=[[1d6-1]] crush}} {{Location=[[3d6]]}} {{Note=Groin shots don't count}} {{desc=**Roll** HT-2 to avoid stun. If stunned roll HT each turn to recover.}}
			</div>

			<ul style="margin-top: 20px; margin-bottom: 20px;">
				<li>templateType = basic | dnd5e | pathfinder.</li>
				<li>sheetStyle = #. Matches the Sheet Style drop-down option on the character sheet. 
					<ul>
						<li>0 = Green</li>
						<li>1 = Blue</li>
						<li>2 = Beige</li>
						<li>3 = Gray</li>
						<li>4 = Classic White</li>
						<li>5 = Pastel Pink</li>
						<li>6 = Pastel Earth</li>
						<li>7 = Purple</li>
						<li>8 = Fabric</li>
					</ul>
				</li>
				<li>title = Main title</li>
				<li>subtitle = Sub Title</li>
				<li>desc = Description, full-width, placed at the bottom of the template.</li>
				<li>roll = Macro for making a die roll.</li>
				<li>target = Skill level for the die roll. If it exists in the macro, then it will appear to the right of the roll result.</li>
				<li>All other properties will be automatically added to the template as key/value pairs. Key = Label, Value = displayed in second column.
					<ul>
						<li>Example: {{note=This is a test}}</li>
						<li><b>note</b> is the <i>key</i> and would populate the first column.</li>
						<li><b>This is a test</b> is the <i>value</i> would populate the second column.</li>
						<li><b style="color: red;">Important</b> The key would need to be a single word, no spaces.</li>
					</ul>
				</li>
			</ul>

			<h4>Version: 2.5.2</h4>

			<p>Pull Request: 11/17/2020</p>

			<ul>
				<li>Current Move Bug. Fix issue where current move wasn't updated when inventory total changes. Reported by Adam .</li>
				<li>Combat Tab > Defense Sub-tab > Roll Modifier Tool. Add Defense Bonus modifier.</li>
				<li>Bugfix: Roll template Pastelle Pink not showing correctly for rolls and dex rolls. Reported by Ian.</li>
				<li>New Sheet and Campaign Option: <b>Show casting details on roll template</b>. If checked, detailed notes like casting time, duration, cost, maintain, resisted by, and class will be shown on the roll results template.</li>
			</ul>

			<h4>Version: 2.5.1</h4>

			<p>Pull Request: 10/27/2020</p>
			<ul>
				<li>Combat tab > Defense. Increased the width of the original <b>Hit Location</b> table. Requested by <i>PL M.</i></li>
				<li>Combat tab > Damage sub-tab. 
					<ul>
						<li>Add: Major wound field and tooltip.</li>
						<li>Add: When updating HP Divisor for a hit location update the Disabled HP column.</li>
						<li>Add: Add a <b>Notes</b> box, could be used to enter notes for <i>Unliving</i>, <i>Homogenous</i>, <i>Diffuse</i>, etc.</li>
						<li>Revision: Updated tooltip for Layer armor. Added notes on how to identify armor as <i>Hardened</i>.</li>
						<li>Renamed Type to Template.</li>
						<li>Bugfix: When updating Max Hit Points the penalty for a hit location may be set to nothing or set to repeating zeros.</li>
						<li>Bugfix: When changing size modifier, fix bug where penalty for a hit location did not total correctly.</li>
					</ul>
				</li>
				<li>Combat tab > Range
					<ul>
						<li>Move Thrown table just below repeating ranged weapons. If using Modifier dialog box, modifiers are now applied to thrown table.</li>
						<li>Range Calculator. Added ACC and ROF to the table. Added button that can be applied to the modifiers and roll modifier dialog box.</li>
					</ul>
				</li>
			</ul>

			<h4>Version: 2.5.0</h4>

			<p>Pull Request: 10/20/2020</p>

			<ul>
				<li>Combat tab: First iteration of Combat sub tab. This tab contains a hit location table and layored armor. You can select a hit location type and update the table. There are options for how many layers to display and if you want to use a back armor location.</li>
			</ul>

			
			<h4>Version: 2.4.0</h4>

			<p>Pull Request: 10/13/2020</p>

			<ul>
				<li>Combat tab: Added sub tabs for Defense, Melee, Ranged, and Tools. Preliminary updates to improving Damage and Armor sections.</li>
				<li>Combat tab -> Combat Tools: Remove redundant elevation direction, replaced by simple elevation field, if you're above the target, enter a positive number. If below the target, enter a negative number.</li>
				<li>Gravity Field. Added a gravity field that can be applied to jumping distance and total inventory weight. <b>Note:</b> Gravity value can be updated in three places; Combat Tab -> Tools, Thrown Weapon. Inventory Tab on the totals line. General tab under the Jumping feat.</li>
			</ul>

			<h4>Version: 2.3.12</h4>

			<p>Pull Request: 9/29/2020</p>

			<ul>
				<li>Roll Modifier Tool. Added an Encumbered modifier, useful skills like Stealth, that may be affected by encumbrance level. Based on original suggestion by <i>Ian</i>.</li>
				<li>Roll Modifier Tool. Added modifiers that can be applied to spells.</li>
				<li>Performance Improvement. Refactored events for Spells, Techniques, and Skills that should improve responsiveness.</li>
				<li>If a new character sheet is created, the latest announcements will not be displayed.</li>
				<li>Bug fix - General Tab. Fix calculation errors for <b>Turning and Velocity Modifiers</b></li>
				<li>Bug fix. Remove mystery characters, <b>$[[3]]</b> that was added to all the translation files for the modifier label translation.</li>
			</ul>

			<h4>Version: 2.3.11</h4>

			<p>Pull Request: 9/22/2020</p>

			<ul>
				<li>Roll Modifier Tools. First Iteration.
					<ul>
						<li>New <b>Sheet Options</b> under the section titled <b>Skill Modifier Tool</b>.</li>
						<li>If checked, a custom modifier and action button will appear above a section of skills.</li>
						<li>You can enter a modifier or click the action button to open a dialog box.</li>
						<li><b>Max skill of 9</b> will limit your skill level to 9 or the modified skill that is less than 9.</li>
						<li>Action button will open the <b>Roll Modifiers</b> box. You can enter own custom modifiers or check the ones that apply.</li>
						<li>The modifiers can be helpful for new players and GMs.</li>
						<li>There are a new set of campaign <b>Game Settings</b> to turn on the tools by default.</li>
						<li><b>Roll Modifiers Dialog Box:</b> Enter and/or select options. If ready, click the apply button. When make a roll, you will see the summary of modifiers on the roll results table.</li>
					</ul>
				</li>
				<li>
					Added new character sheet and campaign option to turn on/off minimum damage notes. Requested by <i>The Fabulous Iron Chef</i>.
				</li>
				<li>
					Bug fix. Refactored how items linked to spells, skills, techniques, or attributes are updated. 
					If you had multiple character sheets open, certain conditions would create empty 
					rows for techniques, melee attacks, or range attacks.
				</li>
				<li>
					Bug fix. Resolved a number javascript and html warning messages, which was only visible if viewing developer tools.
				</li>
			</ul>
			
			<h4>Version: 2.3.10</h4>

			<p>Pull Request: 7/9/2020</p>

			<ul>
				<li>Bio\Misc Tab. Calculate Reach based on Size Modifier.</li>
				<li>General Tab - Current Move table. Added the step disance for each movement type.</li>
				<li>Grimoire Tab - Repeating Spells. Changed the checkboxes for <b>ON</b> and <b>CT</b> to input boxes, since a person can cast the same spell more than once.</li>
			</ul>

			<h4>Version: 2.3.9</h4>

			<p>Pull Request: </p>

			<ul>
				<li>Combat tab. Active Defenses - Link to an attribute and calculate the base defense.</li>
				<li>Combat tab. Knockback Defenses - Link to an attribute and calculate the base defense. Added a field to adjust the HP per yard amount.</li>
				<li>Repeating Defense, Melee, and Ranged tables. Added ability to link a skill to WILL.</li>
				<li>Fixed text description for Unconsciousness check, changed Hard to Kill to Hard to Subdue. Reported by Ben.</li>
			</ul>

			<h4>Version: 2.3.8</h4>

			<p>Pull Request: 6/30/2020</p>

			<ul>
				<li>Combat tab. Added Knockback save as an active defense.</li>
			</ul>

			<h4>Version: 2.3.7</h4>

			<p>Pull Request: 06/09/2020</p>

			<ul>
				<li>Rolltemplate, Fabric sheet. Fixed display issue, reported by Ian.</li>
				<li>Repeating Techniques, melee attacks, and ranged attacks can be linked to ST, Striking ST, DX, IQ, HT, or 10.</li>
				<li>Traits Tab. Added a level column for repeating advantages, disadvantages, and racial traits.</li>
			</ul>

			<h4>Version: 2.3.6</h4>

			<p>Pull Request: 06/02/2020</p>

			<ul>
				<li>Rolltemplate results now match the selected sheet style, contributed by TamedFlame.</li>
				<li>Text areas size can be resized in the browser but this caused overlapping issues. Reported by eVie fixed by TamedFlame.</li>
				<li>Skills Tab. Expanded notes area. Added new text box to enter Skill Modifier notes normally found in the description of the skill. Added highlight row checbox.</li>
				<li>Grimoire Tab. Changes College(s) to two text boxes; Primary College and Secondary College. Widened the text box for <b>Reason for Mod (Modifier)</b>.</li>
				<li>Rolltemplate Ranged Attack Notes to help clarify rules. If failed by 10 or more, a note will show that critical miss doesn't apply to ranged attacks.</li>
				<li>Inventory table. Add a location column.</li>
			</ul>

		</div>
	
	</div> <!-- .tab7 -->
	
	<div class="tab0">

		<!-- see: https://codepen.io/YozhEzhi/pen/gcLpI/ -->
		<div class="tabbed">
			
			<!-- tabs -->
			<label>
				<input type="radio" name="attr_options_tabs" value="sheet" class="tab-control" checked />
				<span data-i18n="sheet-options-label">Sheet Options</span>
			</label>
			<label>
				<input type="radio" name="attr_options_tabs" value="rules" class="tab-control" />
				<span data-i18n="rules-label">Rules</span>
			</label>
			<label>
				<input type="radio" name="attr_options_tabs" value="import" class="tab-control" />
				<span data-i18n="import-label">Import</span>
			</label>

		</div>
		
		<!-- tabbed section to display | value changes based on selected radio button -->
		<input type="hidden" name="attr_options_tabs" value="sheet" />
		<div class="tabs options">

			<div class="options sheet-options">
				
				<div class="option-column">
					
					<div class="option-container">
						
						<h4>
							<span data-i18n="critical-roll-options-label">Critical Roll Options</span>
						</h4>
						
						<input type="radio" name="attr_use_critical_plus_10" value="1" checked="checked" />
						<span data-i18n="user-rules-as-written-label">Use rules as written</span>
						<br />
						
						<input type="radio" name="attr_use_critical_plus_10" value="0" />
						<span data-i18n="only-on-3-or-4-label">Only on a 3 or 4</span>
						<br />
						
						<input type="radio" name="attr_use_critical_plus_10" value="2" /> 
						<span data-i18n="turn-off-label">Turn Off</span>

					</div><!-- end critical roll options -->
					
					<!-- roll modifiers -->
					<div class="option-container">
						<h4>
							<span data-i18n="skill-modifier-options-label">Skill Modifier Options</span>
						</h4>
						
						<input type="checkbox" name="attr_display_roll_modifiers_header" value="1" />
						<span class="popup">
							<span data-i18n="display-modifier-in-header-label">Display Roll Modifier Options in Header</span>
						</span>
						<span class="tooltip">
							<span data-i18n="display-modifier-in-header-tooltip">
								If checked, the options for <b>No Modifier Prompt</b>, <b>Single Modifier Prompt</b> and <b>Extended Modifier Prompts</b> will be displayed to the right of the character name above the tabs.
							</span>
						</span>
						<br />
						
						<input type="radio" name="attr_modifier_option" value="0" />
						<span class="popup">
							<span data-i18n="no-modifier-prompt-label">No Modifier Prompt</span>
						</span>
						<span class="tooltip">
							<span data-i18n="no-modifier-prompt-tooltip">
								Rolls will be made immediately with no prompt.
							</span>
						</span>
						<br />
						
						<input type="radio" name="attr_modifier_option" value="1" checked="true" />
						<span class="popup">
							<span data-i18n="single-modifier-prompt-label">Single Modifier Prompt</span>
						</span>
						<span class="tooltip">
							<span data-i18n="single-modifier-prompt-tooltip">
								Ask for a bonus or penalty to be added to dice rolls.<br />
								This will not affect damage rolls.
							</span>
						</span>
						<br />
						
						<input type="radio" name="attr_modifier_option" value="2" />
						<span class="popup">
							<span data-i18n="extended-modifier-prompt-label">Extended Modifier Prompts</span>
						</span>
						<span class="tooltip">
							<span data-i18n="extended-modifier-prompt-tooltip">
								Instead of a single modifier, rolls will ask for a series of modifiers,<br />
								to remind you about potential bonuses/penalties.<br />
								This will not affect damage rolls.
							</span>
						</span>
						
					</div><!-- end roll modifiers -->
					
					<!-- roll modifiers -->
					<div class="option-container">
						<h4>
							<span data-i18n="skill-modifier-tools-label">Skill Modifier Tools</span>
						</h4>
						
						<input type="checkbox" name="attr_use_skill_modifier_tool" value="1" />
						<span class="popup">
							<span data-i18n="use-skill-modifier-tool-label">Use Skill Modifier Tool</span>
						</span>
						<span class="tooltip">
							<span data-i18n="use-skill-modifier-tool-tooltip">Displays a modifier text box, a button to open a tool to modify effective skill, and to check off Max skill of 9.</span>
						</span>
						<br />
						
						<input type="checkbox" name="attr_use_technique_modifier_tool" value="1" />
						<span class="popup">
							<span data-i18n="use-technique-modifier-tool-label">Use Technique Modifier Tool</span>
						</span>
						<span class="tooltip">
							<span data-i18n="use-skill-modifier-tool-tooltip">
								Displays a modifier text box, a button to open a tool to modify effective skill, and
								to check off Max skill of 9.
							</span>
						</span>
						<br />
						
						<input type="checkbox" name="attr_use_defense_modifier_tool" value="1" />
						<span class="popup">
							<span data-i18n="use-defense-modifier-tool-label">Use Defense Modifier Tool</span>
						</span>
						<span class="tooltip">
							<span data-i18n="use-skill-modifier-tool-tooltip">
								Displays a modifier text box, a button to open a tool to modify effective skill, and
								to check off Max skill of 9.
							</span>
						</span>
						<br />

						<input type="checkbox" name="attr_use_melee_modifier_tool" value="1" />
						<span class="popup">
							<span data-i18n="use-melee-modifier-tool-label">Use Melee Attack Modifier Tool</span>
						</span>
						<span class="tooltip">
							<span data-i18n="use-skill-modifier-tool-tooltip">
								Displays a modifier text box, a button to open a tool to modify effective skill, and
								to check off Max skill of 9.
							</span>
						</span>
						<br />
						
						<input type="checkbox" name="attr_use_ranged_modifier_tool" value="1" />
						<span class="popup">
							<span data-i18n="use-ranged-modifier-tool-label">Use Ranged Attack Modifier Tool</span>
						</span>
						<span class="tooltip">
							<span data-i18n="use-skill-modifier-tool-tooltip">
								Displays a modifier text box, a button to open a tool to modify effective skill, and
								to check off Max skill of 9.
							</span>
						</span>
						<br />
						
						<input type="checkbox" name="attr_use_spell_modifier_tool" value="1" />
						<span class="popup">
							<span data-i18n="use-spell-modifier-tool-label">Use Spell Modifier Tool</span>
						</span>
						<span class="tooltip">
							<span data-i18n="use-skill-modifier-tool-tooltip">
								Displays a modifier text box, a button to open a tool to modify effective skill, and
								to check off Max skill of 9.
							</span>
						</span>
						<br />

					</div><!-- end roll modifiers -->
					
					<div class="option-container">
						<h4>
							<span data-i18n="public-or-private-rolls-label">Public or Private Rolls</span>
						</h4>
						
						<input type="checkbox" name="attr_display_roll_option_header" value="1" />
						<span class="popup">
							<span data-i18n="display-in-header-label">Display Roll Options in Header</span>
						</span>
						<span class="tooltip">
							<span data-i18n="display-in-header-tooltip">
								If checked, the options for <b>Public Rolls</b> and <b>Private Rolls</b> will be displayed to the right of the character name above the tabs.
							</span>
						</span>
						<br />

						<input type="checkbox" name="attr_display_custom_roll_option_header" value="1" />
						<span class="popup">
							<span data-i18n="display-custom-in-header-label">Display Custom Option in Header</span>
						</span>
						<span class="tooltip">
							<span data-i18n="display-custom-in-header-tooltip">
								If checked, button name for <b>Custom Rolls</b> will be displayed to the right of the character name above the tabs.
							</span>
						</span>
						<br />

						<input type="radio" name="attr_roll_option" value="public" checked="checked">
						<span class="popup">
							<span data-i18n="public-rolls-label">Public Rolls</span>
						</span>
						<span class="tooltip">
							<span data-i18n="public-rolls-tooltip">All players will be able to see<br>your skill level, roll and results.</span>
						</span>
						<br>
						
						<input type="radio" name="attr_roll_option" value="deprecated">
						<span class="popup">
							<span data-i18n="private-skill-levels-label">Private Skill Levels <em>deprecated</em></span>
						</span>
						<span class="tooltip">
							<span data-i18n="private-skill-levels-tooltip">Only the GM will be able to see<br>your skill level, but all players<br>will see the result.<br><b>NOTE:</b> This now behaves just like Private Rolls</span>
						</span>
						<br>
						
						<input type="radio" name="attr_roll_option" value="private">
						<span class="popup">
							<span data-i18n="private-rolls-label">Private Rolls</span>
						</span>
						<span class="tooltip">
							<span data-i18n="private-rolls-tooltip">Only the GM will see your skill<br>level and the result.</span>
						</span>
						<br>

						<input type="radio" name="attr_roll_option" value="custom">
						<span class="popup">
							<span data-i18n="custom-rolls-label">Custom Rolls</span>
						</span>
						<span class="tooltip">
							<span data-i18n="custom-rolls-tooltip">Use this option to use a custom macro with the Roll Template.<br><br><b style="color:red;">Important:</b> When entering the macro, be sure to add a <i>space</i> character to the end!<br><br>Add a <b>Button Label</b> to display a button in the header.<br><br>For example, the Private Rolls option adds <i style="color:gray;">/w gm</i> to the beginning of the roll, which means whisper to GM.<br><br>Another example is adding a blind roll option, where <b>only</b> the GM sees the roll. This example uses the <i>Blind Roll</i> API script, see https://app.roll20.net/forum/permalink/5064809/.<br>Set Label = <b>Blind Roll</b>, set Macro = <b>!broll</b></span>
						</span>

						<div>
							<div>
								<b>
									<span data-i18n="button-label">Button Name</span>
								</b><br>
								<input type="text" name="attr_custom_roll_macro_label" value="Blind Roll">
							</div>
							<div>
								<span class="popup">
									<span data-i18n="macro-label">Macro</span>
								</span>
								<span class="tooltip">
									<span data-i18n="macro-label-tooltip"><b>NOTE:</b> In order to use this option, you will need an API script that can intercept the data for the roll and then send a message to the GM.<br /><br />For an example, see the <b>Blind Roll</b> API script, https://app.roll20.net/forum/permalink/5064809/</span>
								</span>
								<br />
								<input type="text" name="attr_custom_roll_macro" value="">
							</div>
						</div>

					</div>
					
					<div class="option-container">
						<h4>
							<span data-i18n="repeating-technique-tables-label">Repeating Technique Tables</span>
						</h4>

						<div>
							<input type="checkbox" name="attr_show_old_techniques" value="1" />
							<span class="popup">
								<span data-i18n="show-original-label">Show Original</span>
							</span>
							<span class="tooltip">
								<span data-i18n="show-original-tooltip">Show the original techniques table.</span>
							</span>
						</div>

						<div>
							<input type="checkbox" name="attr_show_new_techniques" checked="checked" value="1" />
							<span class="popup">
								<span data-i18n="show-revised-label">Show Revised</span>
							</span>
							<span class="tooltip">
								<span data-i18n="show-revised-tooltip">Show the revised techniques table.</span>
							</span>
						</div>
						
					</div><!-- end public/private rolls -->
					
				</div><!-- end option-column -->
				
				<div class="option-column">
					
					<div class="option-container">
						
						<h4>
							<span data-i18n="point-summary-layout-label">Point Summary Layout</span>
						</h4>
						
						<div>
							<input type="radio" name="attr_point_summary_layout" value="1"  checked="checked" />
							<span class="popup">
								<span data-i18n="abbreviation-gurps-character-assistant-label">GCA</span>
							</span>
							<span class="tooltip" style="margin-left: 0;">
								<span data-i18n="gurps-character-assistant-tooltip">GURPS Character Assistant.</span>
							</span>
						</div>
						<div>
							<input type="radio" name="attr_point_summary_layout" value="2" />
							<span class="popup">
								<span data-i18n="abbreviation-gurps-character-sheet-label">GCS</span>
							</span>
							<span class="tooltip" style="margin-left: 0;">
								<span data-i18n="gurps-character-sheet-tooltip">GURPS Character Sheet.</span>
							</span>
						</div>
						<div>
							<input type="radio" name="attr_point_summary_layout" value="3" />
							<span class="popup">
								<span data-i18n="detailed-label">Detailed</span>
							</span>
							<span class="tooltip" style="margin-left: -10px;">
								<span data-i18n="point-summary-detailed-tooltip">
									Custom view displaying each section total.<br />
									Including the deprecated Misc. Points box.
								</span>
							</span>
						</div>
					</div><!-- end point summary layout -->
					
					<div class="option-container">
						<div>
							<input type="checkbox" name="attr_use_unspent_box" value="1" />
							<span class="popup">
								<span data-i18n="enter-unspent-points-label">Enter Unspent Points</span>
							</span>
							<span class="tooltip">
								<span data-i18n="enter-unspent-points-tooltip">Check if you would like to manually track your unspent points</span>
							</span>
						</div>
					</div><!-- end enter unspent points -->
				
					<div class="option-container">
						
						<h4>
							<span data-i18n="add-to-combat-tracker-label">Add to combat tracker</span>
						</h4>
						
						<input type="radio" name="attr_speed_tracker" value="/em" checked="true" />
						<span class="popup">
							<span data-i18n="public-speed-tracker-label">Public Speed Tracker</span>
						</span>
						<span class="tooltip">
							<span data-i18n="public-speed-tracker-tooltip">Show basic speed and add to Chat message to public.</span>
						</span>
						<br />
						
						<input type="radio" name="attr_speed_tracker" value="/w gm" />
						<span class="popup">
							<span data-i18n="private-speed-tracker-label">Private Speed Tracker</span>
						</span>
						<span class="tooltip">
							<span data-i18n="private-speed-tracker-tooltip">Show basic speed and add to Chat message to GM.</span>
						</span>
						
					</div><!-- end combat-tracker -->
					
					<div class="option-container">
						
						<h4>
							<span data-i18n="spell-options-label">Spell Options (See B238, M10)</span>
						</h4>
						
						<span data-i18n="spell-options-table">
							<table>
								<tr>
									<td>
										Penalty for each spell <b>ON:</b>      
									</td>
									<td>
										<input type="number" step="1" value="-1" name="attr_penalty_per_spell_on"></input>
									</td>
								</tr>
								<tr>
									<td>
										Penalty for each spell <b>Concentrated On:</b>             
									</td>
									<td>
										<input type="number" step="1" value="-3" name="attr_penalty_per_spell_maintained"></input>
									</td>
								</tr>
								<tr>
									<td>
										Show casting details on roll template:
									</td>
									<td>
										<input type="checkbox" name="attr_show_casting_details" value="1" checked="checked" />
									</td>
								</tr>
							</table>
						</span>
						
					</div><!-- end option-container -->
					
					<div class="option-container">
						
						<h4><span data-i18n="active-defenses-label">Active Defenses</span></h4>
						
						<div>
							<input type="checkbox" name="attr_show_raw_defensive_notes" value="1" checked="checked" />
							<span class="popup">
								<span data-i18n="abbreviation-show-rules-as-written-notes-label">Show Active Defenses RAW Notes</span>
							</span>
							<span class="tooltip">
								<span data-i18n="abbreviation-show-rules-as-written-notes-tooltip">
									Show Rules as Written Success/Fail notes
								</span>
							</span>
						</div>
						
					</div><!-- end option-container -->

					<div class="option-container">
						
						<h4><span data-i18n="damage-table-label">Damage Table</span></h4>
						
						<div>
							<input type="checkbox" name="attr_damage_update_hit_points" value="1" />
							<span class="popup">
								<span data-i18n="update-hit-points-label">Update Hit Points</span>
							</span>
							<span class="tooltip">
								<span data-i18n="update-hit-points-tooltip">
									If checked, when applying damage to a location, current <b>Hit Points</b> is updated.
								</span>
							</span>
						</div>
						
					</div><!-- end option-container -->
					
				</div><!-- end option-column -->
				
				<div class="option-column">
					
					<div class="option-container damage-dice">
						<h4>
							<span data-i18n="damage-dice-icon">Damage Dice Icon</span>
						</h4>
						
						<div>
							<input type="radio" name="attr_damage_dice_type" value="explode" checked="true" />
							<button type="roll" value="0" name="btn_damage_dice_explode" class="roll_explode btn" disabled="disabled" />
						</div>
						<div>
							<input type="radio" name="attr_damage_dice_type" value="d6black" />
							<button type="roll" value="0" name="btn_damage_dice_d6black" class="btn" disabled="disabled" />
						</div>
						<div>
							<input type="radio" name="attr_damage_dice_type" value="d20blank" />
							<button type="roll" value="0" name="btn_damage_dice_d20blank" class="btn roll_d20blank" disabled="disabled" />
						</div>
						<div>
							<input type="radio" name="attr_damage_dice_type" value="d4skull" />
							<button type="roll" value="0" name="btn_damage_dice_d4skull" class="btn roll_d4skull" disabled="disabled" />
						</div> 
					</div><!-- end damage dice icon -->

					<div class="option-container">
						<div>
							<input type="checkbox" name="attr_use_malfunction" value="1" />
							<span class="popup">
								<span data-i18n="use-malfunction-label">Use Malfunction</span>
							</span>
							<span class="tooltip">
								<span data-i18n="use-malfunction-tooltip">If checked, roll results will check for malfunction.</span>
							</span>
						</div>
					</div><!-- end malfunction -->
					
					<div class="option-container">

						<h4>
							<span data-i18n="stat-modifier-options-label">Stat Modifier Options</span>
						</h4>
						
						<div>
							<input type="radio" name="attr_mod_cascade" value="all" checked="true" />
							<span data-i18n="modifiers-to-attributes-increase-all-label">Mods to attributes increase all derived stats (including HP, FP)</span>
						</div>
						<div>
							<input type="radio" name="attr_mod_cascade" value="some" />
							<span data-i18n="modifiers-to-attributes-increase-most-label">Mods to attributes increase most derived stats (not HP, FP)</span>
						</div>
						<div>
							<input type="radio" name="attr_mod_cascade" value="none" />
							<span data-i18n="modifiers-to-attributes-increase-none-label">Mods to attributes do not increase derived stats</span>
						</div>
					</div><!-- end stat modifier options -->
					<div class="option-container">
						
						<h4>
							<span data-i18n="sheet-style-label">Sheet Style</span>
						</h4>
						
						<span data-i18n="sheet-style-description">Selects a visual style for the character sheet</span>
						
						<div>
							<select name="attr_sheetstyle"/>
							<option class="color-option-0" value="0"><span data-i18n="sheet-style-green-option">Green</span></option> <!-- Color Style options, remember to add one to add a new option-->>
							<option class="color-option-1" value="1"><span data-i18n="sheet-style-blue-option">Blue</span></option>
							<option class="color-option-2" value="2"><span data-i18n="sheet-style-beige-option">Beige</span></option>
							<option class="color-option-3" value="3"><span data-i18n="sheet-style-gray-option-">Gray</span></option>
							<option class="color-option-5" value="5"><span data-i18n="sheet-style-pastel-pink-option">Pastel Pink</span></option>
							<option class="color-option-6" value="6"><span data-i18n="sheet-style-pastel-earth">Pastel Earth</span></option>
							<option class="color-option-7" value="7"><span data-i18n="sheet-style-purple-option">Purple</span></option>
							<option class="color-option-8" value="8"><span data-i18n="sheet-style-fabric-option">Fabric</span></option>
							<option class="color-option-4" value="4" selected="selected"><span data-i18n="sheet-style-classic-white-option">Classic White</span></option>
							</select>
						</div>
					</div><!-- end style selector options -->
				</div><!-- end option-column -->
				
			</div><!-- end options row -->
				
			<div class="options rule-options">
				
				<div class="option-column">
				
					<div class="option-container collision-falling-options">
						<h4>
							<span data-i18n="falling-collision-damage-notes-label">Falling & Collision Damage Notes</span>
						</h4>
						<textarea name="attr_falling_collision_damage_notes">Collisions: If an object is bullet-shaped, sharp, or spiked, it does half damage, but this damage is piercing, cutting, or impaling, rather than crushing.
					
	Falling Damage: If using hit locations, roll randomly for the hit location damaged in a fall. If the injury is to an extremity or a limb, do not ignore injury in excess of that required to cripple it. Instead, subtract the full amount from HP! If the fall would cripple a limb, roll 1d. On 5-6, all limbs of that type are crippled, although there is no extra injury. B431</textarea>
					</div>
					
					<div class="option-container collision-falling-options">
						<h4>
							<span data-i18n="demolition-damage-notes-label">Demolition Damage Notes</span>
						</h4>
						<textarea name="attr_demolition_damage_notes">Explosion damage. Targets struck directly takes listed damage. Apply "collateral damage" of Damage / (3 x distance from center of blast) rounded down.
					
	* Use torso armor to determine DR against explosion.
	* If the explosion has an armor divisor, do NOT apply to "collateral damage.
	* Explosions are considered incendiary. see Catching Fire B434.
	* Can use Dodge and Drop (B377) to avoid collateral damage.
	* See B414</textarea>    
					</div><!-- end option-container -->
				
					<div class="option-container collision-falling-options">
						<h4>
							<span data-i18n="fragmentation-skill-notes-label">Fragmentation Skill Notes</span>
						</h4>
						<textarea name="attr_fragmentation_skill_notes">For every three points by which the attack roll succeeds, one additional fragment strikes the target.

	The only active defense against fragments is to dive away from the explosion that produced them; see Dodge and Drop and Diving for Cober (B377).

	For each hit, roll hit location randomly. If that location is behind cover, the fragment hits cover.
	</textarea>    
					</div><!-- end option-container -->
					
					<div class="option-container collision-falling-options">
						<h4>
							<span data-i18n="fragmentation-damage-notes-label">Fragmentation Damage Notes</span>
						</h4>
						<textarea name="attr_fragmentation_damage_notes">Fragmentation damage is cutting. Note that if an explosive attack has an armor divisor, this does not apply to the fragments it produces.</textarea>    
					</div><!-- end option-container -->
					
					<div class="option-container">
						
						<table>
							<tr>
								<td>
									<b><span data-i18n="fragmentation-recoil-label">Fragmentation Recoil:</span></b>      
								</td>
								<td>
									<input type="number" step="1" value="3" name="attr_fragmentation_recoil"></input>
								</td>
							</tr>
						</table>
						
					</div><!-- end option-container -->
					
				</div><!-- end option-column -->
				
				<div class="option-column">
					
					<div class="option-container collision-falling-options">
						<h4>
							<span data-i18n="spell-critical-success-notes-label">Spell Critical Success Notes</span>
						</h4>
						<textarea name="attr_spell_critical_success_notes">The spell works especially well. **Details are up to the GM**, who should be both generous and creative. Whatever else occurs, there is never an energy cost if you get a critical success when you cast a spell. B235, M7</textarea>    
					</div><!-- end option-container -->
					
					<div class="option-container collision-falling-options">
						<h4>
							<span data-i18n="spell-fail-notes-label">Spell Fail Notes</span>
						</h4>
						<textarea name="attr_spell_fail_notes">The spell does not work. If success would have cost energy, you lose one energy point; otherwise, you lose nothing. (Exception: You must pay the full energy cost even on a failure for an Information spell; see Information Spells. B235, M7.
						
	**In Very High Mana Areas**, all Failures are treated as Critical Failures. M6.</textarea>    
					</div><!-- end option-container -->
					
					<div class="option-container collision-falling-options">
						<h4>
							<span data-i18n="spell-critical-failure-notes-label">Spell Critical Failure Notes</span>
						</h4>
						<textarea name="attr_spell_critical_failure_notes">You must spend the full energy cost and the spell fails . . . badly! **The GM may** use the Critical Spell Failure Table on B236 or, M7, or improvise some other “backfire” he finds amusing. (B235, M7.)
						
	**In Very High Mana Areas**, all actual Critical Failures produce spectacular disasters! (M6)

	**In Low Mana Areas**, Critical Failures have mild effects or no effect at all. (M6)</textarea>    
					</div><!-- end option-container -->
						
				</div><!-- end option-column -->
				
				<div class="option-column">

					<div class="option-container damage-type-notes">

						<h4>
							<span data-i18n="minimum-damage-notes-label">Minimum Damage Notes</span>
						</h4>

						<div class="toggle-notes">
							<input type="checkbox" name="attr_show_minimum_damage_notes" value="1" checked="checked" />
							<span data-i18n="show-notes-in-roll-template-label">Show notes in roll template</span>
						</div>
						
					</div>

					<div class="option-container damage-type-notes">
					
						<h4>
							<span data-i18n="editable-wound-modifier-notes-label">Editable Wound Modifier Notes</span>
						</h4>
					
						<div>
							<span data-i18n="editable-wound-modifier-notes-description">Initial wound modifier notes based on GURPS 4th Edition - Campaigns</span>
						</div>

						<div class="toggle-notes">
							<input type="checkbox" name="attr_use_damage_type_notes" value="1" checked="checked" />
							<span data-i18n="show-notes-in-roll-template-label">Show notes in roll template</span>
						</div>
					
						<table>
							<tr>
								<th>
									<span data-i18n="type-label">Type</span>
								</th>
								<th>
									<span data-i18n="notes-label">Notes</span>
								</th>
							</tr>
							<tr>
								<td>
									<span data-i18n="cutting-label">Cutting</span>
								</td>
								<td>
									<textarea name="attr_damage_type_note_cut">CUTTING
	Damage x1.5
	Neck Damage x2
	Skull Damage x4</textarea>
									</td>
							</tr>
							<tr>
								<td>
									<span data-i18n="impaling-label">Impaling</span>
								</td>
								<td>
									<textarea name="attr_damage_type_note_imp">IMPALING
	Damage x2
	Arm, Leg, Foot, or Hand x1 (B399)
	Vitals Damage x3
	Skull Damage x4</textarea>
								</td>
							</tr>
							<tr>
								<td>
									<span data-i18n="crushing-label">Crushing</span>
								</td>
								<td>
									<textarea name="attr_damage_type_note_cr">CRUSHING
	Damage x1
	Neck Damage x1.5
	Skull Damage x4</textarea>
								</td>
							</tr>
							<tr>
								<td>
									<span data-i18n="abbreviation-piercing-label">PI</span>-
								</td>
								<td>
									<textarea name="attr_damage_type_note_pi_minus">PIERCING-
	Damage x .5
	Vitals Damage x3
	Skull Damage x4</textarea>
								</td>
							</tr>
							<tr>
								<td>
									<span data-i18n="abbreviation-piercing-label">PI</span>
								</td>
								<td>
									<textarea name="attr_damage_type_note_pi">PIERCING
	Damage x1
	Vitals Damage x3
	Skull Damage x4</textarea>
								</td>
							</tr>
							<tr>
								<td>
									<span data-i18n="abbreviation-piercing-label">PI</span>+
								</td>
								<td>
									<textarea name="attr_damage_type_note_pi_plus">PIERCING+
	Damage x1.5
	Arm, Leg, Foot, or Hand x1 (B399)
	Vitals Damage x3
	Skull Damage x4</textarea>
								</td>
							</tr>
							<tr>
								<td>
									<span data-i18n="abbreviation-piercing-label">PI</span>++
								</td>
								<td>
									<textarea name="attr_damage_type_note_pi_plus_plus">PIERCING++
	Damage x2
	Arm, Leg, Foot, or Hand x1 (B399)
	Vitals Damage x3
	Skull Damage x4</textarea>
								</td>
							</tr>
							<tr>
								<td>
									<span data-i18n="afflication-label">Affliction</span>
								</td>
								<td>
									<textarea name="attr_damage_type_note_aff">AFFLICTION
	Special damage and affects based on affliction description</textarea>
								</td>
							</tr>
							<tr>
								<td><span data-i18n="burn-label">Burn</span></td>
								<td>
									<textarea name="attr_damage_type_note_burn">BURN 
	Damage x1
	Skull Damage x4</textarea>
								</td>
							</tr>
							<tr>
								<td><span data-i18n="corrosion-label">Corrosion</span></td>
								<td>
									<textarea name="attr_damage_type_note_cor">CORRROSION 
	Damage x1
	Face Damage x1.5, blind eye if major wound, both eyes if full HP
	Neck Damage x1.5
	Skull Damage x4
	-1 DR per 5 points damage</textarea>
									</td>
								</tr>
								<tr>
									<td>
										<span data-i18n="fatigue-label">Fatigue</span>
									</td>
									<td>
										<textarea name="attr_damage_type_note_fat">FATIGUE 
	Damage x1</textarea>
									</td>
								</tr>
								<tr>
									<td>
										<span data-i18n="toxic-label">Toxic</span>
									</td>
									<td>
										<textarea name="attr_damage_type_note_tox">TOXIC 
	Damage x1</textarea>
									</td>
								</tr>
								<tr>
									<td>
										<span data-i18n="special-label">Special</span>
									</td>
									<td>
										<textarea name="attr_damage_type_note_spec">SPECIAL 
	See notes for weapon.</textarea>
									</td>
								</tr>
								<tr>
									<td>
										<span data-i18n="special-label">Knockback</span>
									</td>
									<td>
										<textarea name="attr_damage_type_note_knockback">Knockback only.</textarea>
									</td>
								</tr>
							</table>
							
					</div><!-- end option-container -->	
						
				</div><!-- end option-column -->
				
			</div><!-- end options row -->

			<div class="options import">

				<div class="instructions" style="width: 33%; float: left;">

					<h3>Import Tool [BETA]</h3>

					<p>
						Initial version is designed for a one time import. Future iterations will allow re-import and adding GURPS Character Sheet (GCS).
					</p>
	
					<h4>GCA Import</h4>
	
					<ol>
						<li>Export your character sheet to an XML file.
							<ul>
								<li>File > Export ... > <b>Check</b> Export XML File.</li>
							</ul>
						</li>
						<li>Convert the XML file to json.
							<ul>
								<li>https://convertxmljson.com/</li>
								<li>https://jsonformatter.org/xml-to-json</li>
								<li>Initial testing worked with both sites. <b>Alert</b> if you use a different one make sure it <b>doesn't</b> create fields named <b>__cdata</b></li>
							</ul>
						</li>
						<li>Copy/Past the json data to the text box below.</li>
						<li>Press the <b>[Import CGA]</b> button</li>
						<li>Wait for the process to complete.</li>
						<li>Review the sheet and notify the Forum of any errors or feature requests.</li>
					</ol>
	
				</div>

				<div class="importer">

					<div class="json-data">
						<h4>JSON DATA</h4>

						<textarea name="attr_json_data" class="json-data"></textarea>
					</div>

					<div class="controls">

						<div class="import-reset">
							<button type="action" name="act_import_reset" class="btn">Reset</button>
						</div>

						<div class="import-button">
							<button type="action" name="act_import_gca" class="btn">Import GCA</button>
						</div>

						<div style="display: none;">
							<button type="action" name="act_import_gcs" class="btn">Import GCS</button>
						</div>

						<div class="import-message">
							<input type="hidden" name="attr_import_message" value="Start Import" />
							<span name="attr_import_message"></span>
						</div>

					</div>

					<div class="controls">

						<div class="import-option">
							
							<div class="import-notes">
								<input type="checkbox" name="attr_import_notes" value="1" checked="checked" title="macro: @{import_notes}" />
							</div>

							<div class="popup import-notes-popup">
								<span data-i18n="import-notes-label">Import Notes</span>
							</div>
							<span class="tooltip">
								<span data-i18n="import-notes-tooltip">Import notes into <i>Bio\Misc</i> fields and into <i>Notes</i> textboxes for repeating tables.</span>
							</span>

						</div>

					</div>

					<div class="control">
						<div>
							<h4 style="color:red;">Alert</h4>
							<p>
								Since the JSON data is large, please only press the button <b>once.</b> Then wait for the <b>Processing...</b> message to show.
								It might take more than 5 to 10 seconds to run, depending on your processing power. If the <b>Processing...</b> doesn't disappear 
								after 20 seconds or so, then something probably broke during the import.
							</p>
						</div>
					</div>

				</div>

			</div>

		</div>

		
	</div> <!-- .tab0 -->

</div>

<div>
	
	<!-- ===== ===== ===== ===== LOGO ===== ===== ===== ===== -->

	<div class="logo">
	
		<div class="control">
		    <button type="roll" class="no-decoration" name="roll_blank" value="https://wiki.roll20.net/GURPS_4th_Edition" title="Show link in chat. NOTE: Right-click to open in new window">
		        <span data-i18n="gurps-4th-edition-wiki-button">GURPS 4th Edition Roll20 Wiki Page</span>
		    </button>
		</div>
	
		<h3> Your feedback is most welcomed! See link below.</h3>
	
		<div class="control">
		    <button type="roll" class="no-decoration" name="roll_blank" value="https://app.roll20.net/forum/post/6616836/gurps-number-1-thread-1/" title="Show link in chat. NOTE: Right-click to open in new window">
		        <span data-i18n="gurps-sheet-thread-link-button">Roll20 Forum - [GURPS] - Sheet #1 - Thread 1</span>
		    </button>
		</div>
	
	</div>
	
</div>

<!-- ROLL TEMPLATES -->
<div class="rolltemplates">
    
    <rolltemplate class="sheet-rolltemplate-addToTracker">
        <div class="container sheet-rolltemplatecolor-setting-{{sheetStyle}}">
            <table class="result">
                <tr>
                    <th colspan="2">{{characterName}}</th>
                </tr>
				
				<tr>
					<td colspan="2" class="subhead">{{skillName}}</td>
				</tr>

                <tr>
                    <td class="label"><span data-i18n="base-label">BASE</span>:</td>
                    <td>{{basicSpeed}}</td>
                </tr>
            </table>
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-skillRoll">
        <div class="container sheet-rolltemplate-color-setting-{{sheetStyle}}">
            <table class="result">
                <tr>
                    <th colspan="2">{{characterName}}</th>
                </tr>
				<tr>
					<td colspan="2" class="subhead">{{skillName}}</td>
				</tr>				
                {{#type}}
                <tr>
                    <td class="label"><span data-i18n="type-label">Type</span>:</td>
                    <td>
                        {{type}}
                        {{#bookReference}}
                        <span class="ref-label"><b><span data-i18n="abbreviation-book-reference-label">Ref</span>:</b> {{bookReference}}</span>
                        {{/bookReference}}
                    </td>
                </tr>
				{{/type}}
				{{#selected}}
                <tr>
                    <td class="label"><span data-i18n="selected-label">Selected</span>:</td>
                    <td>
                        {{selected}}
                    </td>
                </tr>
                {{/selected}}
                {{#target1}}
                <tr>
                    <td class="label"><span data-i18n="target-one-label">Target 1</span>:</td>
                    <td>
                        {{target1}}
                    </td>
                </tr>
                {{/target1}}
                {{#rollResult}}
                <tr>
                    <td class="label"><span data-i18n="roll-label">Roll:</span></td>
                    <td>
                        
                        <!-- WARNING THIS IS GOING TO GET UGLY AND HARD TO FOLLOW -->
                        
                        <!-- NOTE: Regardless of the score you are rolling against, -->
                        <!-- a roll of 3 or 4 is always a success, while a roll of 17 or 18 is always a failure. -->
                        
                        <!-- Roll of 18 is always critical failure -->
                        {{#rollTotal() rollResult 18}}
                            <span class="failure">
                                {{rollResult}}
                                <span class="failure-text">
                                    {{#showHitLabel}}Critical Miss{{/showHitLabel}}
                                    {{#showSuccessLabel}}Critical Failure{{/showSuccessLabel}}
                                </span>
                                
                                <!-- block custom critical failure note -->
								{{#rawCriticalFailNote}}
                                    <p><span class="failure-note-label"></span> {{rawCriticalFailNote}}</p>
								{{/rawCriticalFailNote}}
								
								{{#customCriticalFailNote}}
                                    <p><span class="failure-note-label"></span> {{customCriticalFailNote}}</p>
                                {{/customCriticalFailNote}}
                                    
                            </span>
                        {{/rollTotal() rollResult 18}}
                        
                        <!-- Roll of 17 is always a failure -->
                        {{#rollTotal() rollResult 17}}
                            <span class="failure">
                                {{rollResult}}
                                <span class="failure-text">
                                    
                                    <!-- skill of 15 or less is critical -->
                                    {{#rollLess() effectiveSkill 16}}Critical{{/rollLess() effectiveSkill 16}}
                                    
                                    {{#showHitLabel}}Miss{{/showHitLabel}}
                                    {{#showSuccessLabel}}Failure{{/showSuccessLabel}}
                                    
                                </span>
                                
                                <!-- skill of 16 or higher is normal failure, add helper text -->
                                {{#rollGreater() effectiveSkill 15}}
                                
                                    <!-- block custom failure note -->
                                    {{#rawFailNote}}
                                        <p>{{rawFailNote}}</p>
                                    {{/rawFailNote}}
									
									{{#customFailNote}}
                                        <p>{{customFailNote}}</p>
                                    {{/customFailNote}}
                                    
                                {{/rollGreater() effectiveSkill 15}}
                                
                                <!-- skill of 15 or less is critical, add helper text -->
                                {{#rollLess() effectiveSkill 16}}
                                
                                    <!-- block custom critical failure note -->
                                    {{#rawCriticalFailNote}}
                                        <p><span class="failure-note-label"></span> {{rawCriticalFailNote}}</p>
                                    {{/rawCriticalFailNote}}
									
									{{#customCriticalFailNote}}
                                        <p><span class="failure-note-label"></span> {{customCriticalFailNote}}</p>
                                    {{/customCriticalFailNote}}
                                    
                                {{/rollLess() effectiveSkill 16}}
                                
                            </span>
                        {{/rollTotal() rollResult 17}}
                        
                        <!-- A roll of 3 or 4 always succeeds -->
                        {{#rollBetween() rollResult 3 4}}
                            <span class="success">
                                {{rollResult}}
                                <span class="success-text">
                                    
                                    <!-- if critical success is turned on, show text -->
                                    {{#rollLess() useCriticalPlusTen 2}}Critical{{/rollLess() useCriticalPlusTen 2}}
                                    
                                    {{#showHitLabel}}Hit{{/showHitLabel}}
                                    {{#showSuccessLabel}}Success{{/showSuccessLabel}}
                                </span>
                                
                                <!-- normal success area -->
                                {{#rollTotal() useCriticalPlusTen 2}}
                                
									<!-- block custom success note -->
									{{#rollTotal() showRawDefenseNotes 1}}
                                    {{#rawSuccessNote}}
                                        <p>{{rawSuccessNote}}</p>
                                    {{/rawSuccessNote}}
									{{/rollTotal() showRawDefenseNotes 1}}
                                    
									{{#customSuccessNote}}
                                        <p>{{customSuccessNote}}</p>
                                    {{/customSuccessNote}}
                                    
                                {{/rollTotal() useCriticalPlusTen 2}}
                                
                                <!-- Check if Critical Success was turned on -->
                                <!-- attr_use_critical_plus_10: 0 = only on 3 or 4, 1 = rules as written, 2 = turn off -->
                                {{#rollLess() useCriticalPlusTen 2}}
                                
                                    <!-- block custom critical success note -->
                                    {{#rollTotal() showRawDefenseNotes 1}}
                                    {{#rawCriticalSuccessNote}}
                                        <p>{{rawCriticalSuccessNote}}</p>
                                    {{/rawCriticalSuccessNote}}
									{{/rollTotal() showRawDefenseNotes 1}}
                                    
									{{#customCriticalSuccessNote}}
                                        <p>{{customCriticalSuccessNote}}</p>
                                    {{/customCriticalSuccessNote}}
                                    
                                {{/rollLess() useCriticalPlusTen 2}}
                                                    
                            </span>
                        {{/rollBetween() rollResult 3 4}}
                        
                        <!-- Roll from 5 to 16 means we have a chance at hit or miss -->
                        <!-- NOTE: A roll of 3 or 4 always succeeds, handled above -->
                        {{#rollBetween() rollResult 5 16}}

                            <!-- Check for failure, where roll is greater than effective skill -->
                            {{#rollGreater() rollResult effectiveSkill}}
                                <span class="failure">
                                    {{rollResult}}
                                    <span class="failure-text">
                                        
										<!-- if effective skill is 3 or less, critical failure is 13 or higher -->
										<!-- does not apply to ranged attacks -->
										{{^rangedAttack}}
                                        {{#rollLess() effectiveSkill 4}}
                                            {{#rollGreater() rollResult 12}}Critical{{/rollGreater() rollResult 12}}
                                        {{/rollLess() effectiveSkill 4}}
										{{/rangedAttack}}
										
										<!-- if effective skill is 4, critical failure is 14 or higher -->
										{{^rangedAttack}}
                                        {{#rollTotal() effectiveSkill 4}}
                                            {{#rollGreater() rollResult 13}}Critical{{/rollGreater() rollResult 13}}
                                        {{/rollTotal() effectiveSkill 4}}
										{{/rangedAttack}}
										
                                        <!-- if effective skill is 5, critical failure is 15 or higher -->
										{{^rangedAttack}}
										{{#rollTotal() effectiveSkill 5}}
                                            {{#rollGreater() rollResult 14}}Critical{{/rollGreater() rollResult 14}}
                                        {{/rollTotal() effectiveSkill 5}}
										{{/rangedAttack}}
										
										<!-- if effective skill is 6, critical failure is 16 or higher -->
										{{^rangedAttack}}
                                        {{#rollTotal() effectiveSkill 6}}
                                            {{#rollGreater() rollResult 15}}Critical{{/rollGreater() rollResult 15}}
                                        {{/rollTotal() effectiveSkill 6}}
                                        {{/rangedAttack}}
                                        
                                        <!-- if effective skill is 7 to 15, critical failure is 17 or 18 -->
                                        {{^rangedAttack}}
                                        {{#rollBetween() effectiveSkill 7 15}}
                                            {{#rollGreater() rollResult 16}}Critical{{/rollGreater() rollResult 16}}
                                        {{/rollBetween() effectiveSkill 7 15}}
                                        {{/rangedAttack}}
                                        
                                        <!-- NOTE: Roll of 18 check has already been made -->

                                        {{#showHitLabel}}Miss{{/showHitLabel}}
										{{#showSuccessLabel}}Failure{{/showSuccessLabel}}
										
                                    </span>
									
									<!-- if ranged attack, show additional note about 10 or more not applied to ranged attacks -->
									{{#rangedAttack}}
									{{#rollLess() effectiveSkill 4}}
										{{#rollGreater() rollResult 12}}
											<div style="margin-top: 5px;">
												<span data-i18n="ranged-critical-miss-by-10-description">Critical miss by 10 or more doesn't apply to ranged weapons. See B382</span>
											</div>
										{{/rollGreater() rollResult 12}}
									{{/rollLess() effectiveSkill 4}}
									{{/rangedAttack}}
									
									{{#rangedAttack}}
									{{#rollTotal() effectiveSkill 4}}
										{{#rollGreater() rollResult 13}}
											<div style="margin-top: 5px;">
												<span data-i18n="ranged-critical-miss-by-10-description">Critical miss by 10 or more doesn't apply to ranged weapons. See B382</span>
											</div>
										{{/rollGreater() rollResult 13}}
									{{/rollTotal() effectiveSkill 4}}
									{{/rangedAttack}}
									
									{{#rangedAttack}}
									{{#rollTotal() effectiveSkill 5}}
										{{#rollGreater() rollResult 14}}
											<div style="margin-top: 5px;">
												<span data-i18n="ranged-critical-miss-by-10-description">Critical miss by 10 or more doesn't apply to ranged weapons. See B382</span>
											</div>
										{{/rollGreater() rollResult 14}}
									{{/rollTotal() effectiveSkill 5}}
									{{/rangedAttack}}
									
									{{#rangedAttack}}
									{{#rollTotal() effectiveSkill 6}}
										{{#rollGreater() rollResult 15}}
											<div style="margin-top: 5px;">
												<span data-i18n="ranged-critical-miss-by-10-description">Critical miss by 10 or more doesn't apply to ranged weapons. See B382</span>
											</div>
										{{/rollGreater() rollResult 15}}
									{{/rollTotal() effectiveSkill 6}}
									{{/rangedAttack}}
									
									{{#rangedAttack}}
									{{#rollBetween() effectiveSkill 7 15}}
										{{#rollGreater() rollResult 16}}
											<div style="margin-top: 5px;">
												<span data-i18n="ranged-critical-miss-by-10-description">Critical miss by 10 or more doesn't apply to ranged weapons. See B382</span>
											</div>
										{{/rollGreater() rollResult 16}}
									{{/rollBetween() effectiveSkill 7 15}}
									{{/rangedAttack}}
                                  
                                    <!-- additional critical failure text -->
                                    <!-- if effective skill is 3 or less, critical failure is 13 or higher -->
                                    {{#rollLess() effectiveSkill 4}}
                                        
                                        <!-- normal failure -->
                                        {{#rollLess() rollResult 13}}
                                        
                                            <!-- block custom fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawFailNote}}
                                                <p>{{rawFailNote}}</p>
											{{/rawFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customFailNote}}
                                                <p>{{customFailNote}}</p>
                                            {{/customFailNote}}
                                            
                                        {{/rollLess() rollResult 13}}
                                        
                                        <!-- critical failure -->
                                        {{#rollGreater() rollResult 12}}
                                        
                                            <!-- dodge critical failure -->
                                            {{#rollTotal() defenseType 1}}
                                                <p>Lose your footing and fall prone. (B382)</p>
                                            {{/rollTotal() defenseType 1}}
                                        
                                            <!-- parry critical failure -->
                                            {{#rollTotal() defenseType 2}}
                                                <p>Roll on the appropriate Critical Miss Table B556. (B382). Apply the result immediately.</p>
                                            {{/rollTotal() defenseType 2}}
                                            
                                            <!-- block critical failure -->
                                            {{#rollTotal() defenseType 3}}
                                                <p>You lose your grip on whatever you were Blocking with and must take a turn to ready it before you can use it to block again. (B382)</p>
                                            {{/rollTotal() defenseType 3}}
                                            
                                            <!-- block custom critical fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{rawCriticalFailNote}}</p>
                                            {{/rawCriticalFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{customCriticalFailNote}}</p>
                                            {{/customCriticalFailNote}}
                                            
                                        {{/rollGreater() rollResult 12}}
                                        
                                    {{/rollLess() effectiveSkill 4}}
                                    
                                    <!-- if effective skill is 4, critical failure is 14 or higher -->
                                    {{#rollTotal() effectiveSkill 4}}
                                        
                                        <!-- normal failure -->
                                        {{#rollLess() rollResult 15}}
                                        
                                            <!-- block custom fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawFailNote}}
                                                <p>{{rawFailNote}}</p>
                                            {{/rawFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customFailNote}}
                                                <p>{{customFailNote}}</p>
                                            {{/customFailNote}}
                                            
                                        {{/rollLess() rollResult 15}}
                                        
                                        <!-- critical failure -->
                                        {{#rollGreater() rollResult 13}}
                                        
                                            <!-- dodge critical failure -->
                                            {{#rollTotal() defenseType 1}}
                                                <p>Lose your footing and fall prone. (B382)</p>
                                            {{/rollTotal() defenseType 1}}
                                        
                                            <!-- parry critical failure -->
                                            {{#rollTotal() defenseType 2}}
                                                <p>Roll on the appropriate Critical Miss Table B556. (B382). Apply the result immediately.</p>
                                            {{/rollTotal() defenseType 2}}
                                            
                                            <!-- block critical failure -->
                                            {{#rollTotal() defenseType 3}}
                                                <p>You lose your grip on whatever you were Blocking with and must take a turn to ready it before you can use it to block again. (B382)</p>
                                            {{/rollTotal() defenseType 3}}
                                            
                                            <!-- block custom critical fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{rawCriticalFailNote}}</p>
											{{/rawCriticalFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{customCriticalFailNote}}</p>
                                            {{/customCriticalFailNote}}
                                            
                                        {{/rollGreater() rollResult 13}}
                                        
                                    {{/rollTotal() effectiveSkill 4}}
                                    
                                    <!-- if effective skill is 5, critical failure is 15 or higher -->
                                    {{#rollTotal() effectiveSkill 5}}
                                        
                                        <!-- normal failure -->
                                        {{#rollLess() rollResult 15}}
                                        
                                            <!-- block custom fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawFailNote}}
                                                <p>{{rawFailNote}}</p>
                                            {{/rawFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customFailNote}}
                                                <p>{{customFailNote}}</p>
                                            {{/customFailNote}}
                                            
                                        {{/rollLess() rollResult 15}}
                                        
                                        <!-- critical failure -->
                                        {{#rollGreater() rollResult 14}}
                                        
                                            <!-- dodge critical failure -->
                                            {{#rollTotal() defenseType 1}}
                                                <p>Lose your footing and fall prone. (B382)</p>
                                            {{/rollTotal() defenseType 1}}
                                        
                                            <!-- parry critical failure -->
                                            {{#rollTotal() defenseType 2}}
                                                <p>Roll on the appropriate Critical Miss Table B556. (B382). Apply the result immediately.</p>
                                            {{/rollTotal() defenseType 2}}
                                            
                                            <!-- block critical failure -->
                                            {{#rollTotal() defenseType 3}}
                                                <p>You lose your grip on whatever you were Blocking with and must take a turn to ready it before you can use it to block again. (B382)</p>
                                            {{/rollTotal() defenseType 3}}
                                            
                                            <!-- block custom critical fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{rawCriticalFailNote}}</p>
                                            {{/rawCriticalFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{customCriticalFailNote}}</p>
                                            {{/customCriticalFailNote}}
                                            
                                        {{/rollGreater() rollResult 14}}
                                        
                                    {{/rollTotal() effectiveSkill 5}}
                                    
                                    <!-- if effective skill is 6, critical failure is 16 or higher -->
                                    {{#rollTotal() effectiveSkill 6}}
                                        
                                        <!-- normal failure -->
                                        {{#rollLess() rollResult 16}}
                                        
                                            <!-- block custom fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawFailNote}}
                                                <p>{{rawFailNote}}</p>
                                            {{/rawFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customFailNote}}
                                                <p>{{customFailNote}}</p>
                                            {{/customFailNote}}
                                            
                                        {{/rollLess() rollResult 16}}
                                        
                                        <!-- critical failure -->
                                        {{#rollGreater() rollResult 15}}
                                        
                                            <!-- dodge critical failure -->
                                            {{#rollTotal() defenseType 1}}
                                                <p>Lose your footing and fall prone. (B382)</p>
                                            {{/rollTotal() defenseType 1}}
                                            
                                            <!-- parry critical failure -->
                                            {{#rollTotal() defenseType 2}}
                                                <p>Roll on the appropriate Critical Miss Table B556. (B382). Apply the result immediately.</p>
                                            {{/rollTotal() defenseType 2}}
                                            
                                            <!-- block critical failure -->
                                            {{#rollTotal() defenseType 3}}
                                                <p>You lose your grip on whatever you were Blocking with and must take a turn to ready it before you can use it to block again. (B382)</p>
                                            {{/rollTotal() defenseType 3}}
                                            
                                            <!-- block custom critical fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{rawCriticalFailNote}}</p>
                                            {{/rawCriticalFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{customCriticalFailNote}}</p>
                                            {{/customCriticalFailNote}}
                                            
                                        {{/rollGreater() rollResult 15}}
                                        
                                    {{/rollTotal() effectiveSkill 6}}
                                    
                                    <!-- if effective skill is 7 to 15, critical failure is 17 or 18 -->
                                    {{#rollBetween() effectiveSkill 7 15}}
                                        
                                        <!-- normal failure -->
                                        {{#rollLess() rollResult 17}}
                                        
                                            <!-- block custom fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawFailNote}}
                                                <p>{{rawFailNote}}</p>
                                            {{/rawFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customFailNote}}
                                                <p>{{customFailNote}}</p>
                                            {{/customFailNote}}
                                            
                                        {{/rollLess() rollResult 17}}
                                        
                                        <!-- critical failure -->
                                        {{#rollGreater() rollResult 16}}
                                        
                                            <!-- dodge critical failure -->
                                            {{#rollTotal() defenseType 1}}
                                                <p>Lose your footing and fall prone. (B382)</p>
                                            {{/rollTotal() defenseType 1}}
                                            
                                            <!-- parry critical failure -->
                                            {{#rollTotal() defenseType 2}}
                                                <p>Roll on the appropriate Critical Miss Table B556. (B382). Apply the result immediately.</p>
                                            {{/rollTotal() defenseType 2}}
                                            
                                            <!-- block critical failure -->
                                            {{#rollTotal() defenseType 3}}
                                                <p>You lose your grip on whatever you were Blocking with and must take a turn to ready it before you can use it to block again. (B382)</p>
                                            {{/rollTotal() defenseType 3}}
                                            
                                            <!-- block custom critical fail note -->
                                            {{#rollTotal() showRawDefenseNotes 1}}
                                    		{{#rawCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{rawCriticalFailNote}}</p>
                                            {{/rawCriticalFailNote}}
											{{/rollTotal() showRawDefenseNotes 1}}
                                    
											{{#customCriticalFailNote}}
                                                <p><span class="failure-note-label"></span> {{customCriticalFailNote}}</p>
                                            {{/customCriticalFailNote}}
                                            
                                        {{/rollGreater() rollResult 16}}
                                        
                                    {{/rollBetween() effectiveSkill 7 15}}
                                        
                                </span>
                            {{/rollGreater() rollResult effectiveSkill}}

                            <!-- check for success, roll from 5 to effective skill -->
                            <!-- NOTE: roll 3 or 4 has already been handled -->
                            {{#rollBetween() rollResult 5 effectiveSkill}}

                                <span class="success">
                                    {{rollResult}}
                                    <span class="success-text">
                                        
                                        <!-- Check if Critical Success was turned on -->
                                        <!-- attr_use_critical_plus_10: 0 = only on 3 or 4, 1 = rules as written, 2 = turn off -->
                                        {{#rollLess() useCriticalPlusTen 2}}
                                        
                                            <!-- If rules as written -->
                                            {{#rollTotal() useCriticalPlusTen 1}}
                                            
                                                <!-- if effective skill is 16 or higher, check for critical success on a 6 -->
                                                {{#rollGreater() effectiveSkill 15}}
                                                    {{#rollTotal() rollResult 6}}Critical{{/rollTotal() rollResult 6}}
                                                    {{#rollTotal() rollResult 5}}Critical{{/rollTotal() rollResult 5}}
                                                {{/rollGreater() effectiveSkill 15}}

                                                <!-- If rules as written and if effectiveSkill is 15, check for critical success on a 5 -->
                                                {{#rollTotal() effectiveSkill 15}}
                                                    {{#rollTotal() rollResult 5}}Critical{{/rollTotal() rollResult 5}}
                                                {{/rollTotal() effectiveSkill 15}}

                                            {{/rollTotal() useCriticalPlusTen 1}}

                                        {{/rollLess() useCriticalPlusTen 2}}
                                        
                                        {{#showHitLabel}}Hit{{/showHitLabel}}
                                        {{#showSuccessLabel}}Success{{/showSuccessLabel}}
                                    </span>
                                    
                                    <!-- check if critical success is off -->
                                    <!-- attr_use_critical_plus_10: 0 = only on 3 or 4, 1 = rules as written, 2 = turn off -->
                                    {{#rollTotal() useCriticalPlusTen 2}}
                                        <!-- block custom success note -->
                                        {{#rollTotal() showRawDefenseNotes 1}}
                                    	{{#rawSuccessNote}}
                                            <p>{{rawSuccessNote}}</p>
										{{/rawSuccessNote}}
										{{/rollTotal() showRawDefenseNotes 1}}
                                    
										{{#customSuccessNote}}
                                            <p>{{customSuccessNote}}</p>
                                        {{/customSuccessNote}}
                                    {{/rollTotal() useCriticalPlusTen 2}}
                                    
                                    <!-- Check if Critical Success was turned on -->
                                    <!-- attr_use_critical_plus_10: 0 = only on 3 or 4, 1 = rules as written, 2 = turn off -->
                                    <!-- show additional notes -->
                                    {{#rollLess() useCriticalPlusTen 2}}
                                    
                                        <!-- If rules as written -->
                                        {{#rollTotal() useCriticalPlusTen 1}}
                                        
                                            <!-- if effective skill is less than 15, then show success note -->
                                            {{#rollLess() effectiveSkill 15}}
                                                <!-- block custom success note -->
                                                {{#rollTotal() showRawDefenseNotes 1}}
                                    			{{#rawSuccessNote}}
                                                    <p>{{rawSuccessNote}}</p>
												{{/rawSuccessNote}}
												{{/rollTotal() showRawDefenseNotes 1}}
                                    
												{{#customSuccessNote}}
                                                    <p>{{customSuccessNote}}</p>
                                                {{/customSuccessNote}}
                                            {{/rollLess() effectiveSkill 15}}
                                            
                                            <!-- if effective skill is 16 or higher, check for critical success on a 6 -->
                                            {{#rollGreater() effectiveSkill 15}}
                                                
                                                <!-- normal success -->
                                                {{#rollGreater() rollResult 6}}
                                                
                                                    <!-- block custom success note -->
                                                    {{#rollTotal() showRawDefenseNotes 1}}
                                    				{{#rawSuccessNote}}
                                                        <p>{{rawSuccessNote}}</p>
                                                    {{/rawSuccessNote}}
													{{/rollTotal() showRawDefenseNotes 1}}
                                    
													{{#customSuccessNote}}
                                                        <p>{{customSuccessNote}}</p>
                                                    {{/customSuccessNote}}
                                                    
                                                {{/rollGreater() rollResult 6}}
                                                
                                                <!-- critical success -->
                                                {{#rollBetween() rollResult 5 6}}
                                                
                                                    <!-- block custom critical success note -->
                                                    {{#rollTotal() showRawDefenseNotes 1}}
                                    				{{#rawCriticalSuccessNote}}
                                                        <p>{{rawCriticalSuccessNote}}</p>
                                                    {{/rawCriticalSuccessNote}}
													{{/rollTotal() showRawDefenseNotes 1}}
                                    
													{{#customCriticalSuccessNote}}
                                                        <p>{{customCriticalSuccessNote}}</p>
                                                    {{/customCriticalSuccessNote}}
                                                    
                                                {{/rollBetween() rollResult 5 6}}
                                                
                                            {{/rollGreater() effectiveSkill 15}}

                                            <!-- If rules as written and if effectiveSkill is 15, check for critical success on a 5 -->
                                            {{#rollTotal() effectiveSkill 15}}
                                            
                                                <!-- normal success -->
                                                {{#rollGreater() rollResult 5}}
                                                
                                                    <!-- block custom success note -->
                                                    {{#rollTotal() showRawDefenseNotes 1}}
                                    				{{#rawSuccessNote}}
                                                        <p>{{rawSuccessNote}}</p>
													{{/rawSuccessNote}}
													{{/rollTotal() showRawDefenseNotes 1}}
                                    
													{{#customSuccessNote}}
                                                        <p>{{customSuccessNote}}</p>
                                                    {{/customSuccessNote}}
                                                    
                                                {{/rollGreater() rollResult 5}}
                                                
                                                <!-- critical success -->
                                                {{#rollTotal() rollResult 5}}
                                                    
                                                    <!-- block custom critical success note -->
                                                    {{#rollTotal() showRawDefenseNotes 1}}
                                    				{{#rawCriticalSuccessNote}}
                                                        <p>{{rawCriticalSuccessNote}}</p>
                                                    {{/rawCriticalSuccessNote}}
													{{/rollTotal() showRawDefenseNotes 1}}
                                    
													{{#customCriticalSuccessNote}}
                                                        <p>{{customCriticalSuccessNote}}</p>
                                                    {{/customCriticalSuccessNote}}
                                                    
                                                {{/rollTotal() rollResult 5}}
                                            
                                            {{/rollTotal() effectiveSkill 15}}

                                        {{/rollTotal() useCriticalPlusTen 1}}

                                    {{/rollLess() useCriticalPlusTen 2}}
                                    
                                </span>                            
                            {{/rollBetween() rollResult 5 effectiveSkill}}

                        {{/rollBetween() rollResult 5 16}}
                        
                    </td>
                </tr>
                {{/rollResult}}
                
                {{#effectiveSkill}}
                <tr>
                    <td class="label"><span data-i18n="target-label">Target</span>:</td>
                    <td class="effective-skill">
                        {{effectiveSkill}}
                        {{#useFrightLabel}}
                            <i>Fright Threshold</i>
                        {{/useFrightLabel}}
						
						{{#isSkillRoll}}
							<i>(Effective Skill)</i>
						{{/isSkillRoll}}
						
                        <!-- If defense roll, check for effective skill below 1 -->
                        {{#rollTotal() activeDefense 1}}
                            {{#rollLess() effectiveSkill 1}}
							<div style="color: red; margin-top: 6px;">
								<span data-i18n="rolltemplate-warning-less-than-three-description"><b>WARNING:</b> You may not attempt a success roll if your effective skill (Target) is less than 3. (See B345)</span>
							</div> 
                            {{/rollLess() effectiveSkill 1}}
                        {{/rollTotal() activeDefense 1}}
                        
                        <!-- For other rolls, check for effective skill below 3 -->
						{{#rollTotal() activeDefense 0}}
							{{#rollLess() effectiveSkill 3}}
							<div style="color: red; margin-top: 6px;">
								<span data-i18n="rolltemplate-warning-less-than-three-description"><b>WARNING:</b> You may not attempt a success roll if your effective skill (Target) is less than 3. (See B345)</span>
							</div> 
                            {{/rollLess() effectiveSkill 3}}
                        {{/rollTotal() activeDefense 0}}
                        
                    </td>
                </tr>
                {{/effectiveSkill}}
				
				<!-- Roll Modifier Tool Sections -->
				{{#rollTotal() useModToll 1}}
				
				<tr>
					<td colspan="2" class="tool-modifier-title">
						<span data-i18n="rolltemplate-tool-modifiers-label">Tool Modifiers</span>
					</td>
				</tr>
				
				<tr>
                    <td class="label"><span data-i18n="modifier-label">Modifier:</span></td>
                    <td class="effective-skill">{{rollModifier}}</td>
				</tr>
				
				{{#maneuver}}
				<tr>
                    <td class="label"><span data-i18n="maneuver-label">Maneuver</span>:</td>
                    <td>{{maneuver}}</td>
				</tr>
				{{/maneuver}}
				
				{{#allOutAttack}}
				<tr>
                    <td class="label"><span data-i18n="all-out-attack-label">All-Out Attack</span>:</td>
                    <td>{{allOutAttack}}</td>
				</tr>
				{{/allOutAttack}}
				
				{{#hitLocation}}
				<tr>
                    <td class="label"><span data-i18n="hit-location-label">Hit Location</span>:</td>
                    <td>{{hitLocation}}</td>
				</tr>
				{{/hitLocation}}
				
				{{#rollTotal() maxNine 1}}
				<tr>
					<td class="label alert-notice">
						<span data-i18n="alert-label">Alert</span>:
					</td>
					<td>
						<span data-i18n="rolltemplate-max-9-description">Max effective skill is <b>9</b></span>
					</td>
				</tr>
				{{/rollTotal() maxNine 1}}

				{{#rollTraitSummary}}
				<tr>
                    <td class="label"><span data-i18n="traits-label">Traits</span>:</td>
                    <td>{{rollTraitSummary}}</td>
				</tr>
				{{/rollTraitSummary}}

				{{#rollModifierSummary}}
				<tr>
                    <td class="label"><span data-i18n="summary-label">Summary</span>:</td>
                    <td>{{rollModifierSummary}}</td>
				</tr>
				{{/rollModifierSummary}}

				{{/rollTotal() useModToll 1}}
				
                <!-- NOTE: Need to replicate the complicated success/fail checks to display spell notes. -->
                {{#rollResult}}
                {{#spellRoll}}
                <tr class="rollResult">
                    <td colspan="2">
                            <!-- WARNING THIS IS GOING TO GET UGLY AND HARD TO FOLLOW -->
                        
                        <!-- NOTE: Regardless of the score you are rolling against, -->
                        <!-- a roll of 3 or 4 is always a success, while a roll of 17 or 18 is always a failure. -->
                        
                        <!-- Roll of 18 is always critical failure -->
                        {{#rollTotal() rollResult 18}}
                            {{spellCriticalFailureNote}}
                        {{/rollTotal() rollResult 18}}
                        
                        <!-- Roll of 17 is always a failure -->
                        {{#rollTotal() rollResult 17}}
                        
                            <!-- skill of 15 or less is critical -->
                            {{#rollLess() effectiveSkill 16}}
                                {{spellCriticalFailureNote}}
                            {{/rollLess() effectiveSkill 16}}
                               
                             <!-- skill of 16 or higher is normal failure, add helper text -->
                            {{#rollGreater() effectiveSkill 15}}
                                {{spellFailNote}}
                            {{/rollGreater() effectiveSkill 15}}
                            
                        {{/rollTotal() rollResult 17}}
                        
                        <!-- A roll of 3 or 4 always succeeds -->
                        {{#rollBetween() rollResult 3 4}}
                        
                            <!-- if critical success is turned on, show text -->
                            {{#rollLess() useCriticalPlusTen 2}}
                                {{spellCriticalSuccessNote}}
                            {{/rollLess() useCriticalPlusTen 2}}
                                
                            <!-- normal success area -->
                            {{#rollTotal() useCriticalPlusTen 2}}
                                <!-- block custom success note -->
                            {{/rollTotal() useCriticalPlusTen 2}}
                                
                        {{/rollBetween() rollResult 3 4}}
                        
                        <!-- Roll from 5 to 16 means we have a chance at hit or miss -->
                        <!-- NOTE: A roll of 3 or 4 always succeeds, handled above -->
                        {{#rollBetween() rollResult 5 16}}

                            <!-- Check for failure, where roll is greater than effective skill -->
                            {{#rollGreater() rollResult effectiveSkill}}
                            
                                <!-- if effective skill is 3 or less, critical failure is 13 or higher -->
                                {{#rollLess() effectiveSkill 4}}
                                    {{#rollGreater() rollResult 12}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 12}}
                                {{/rollLess() effectiveSkill 4}}
                                
                                <!-- if effective skill is 4, critical failure is 14 or higher -->
                                {{#rollTotal() effectiveSkill 4}}
                                    {{#rollGreater() rollResult 13}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 13}}
                                {{/rollTotal() effectiveSkill 4}}
                                
                                <!-- if effective skill is 5, critical failure is 15 or higher -->
                                {{#rollTotal() effectiveSkill 5}}
                                    {{#rollGreater() rollResult 14}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 14}}
                                {{/rollTotal() effectiveSkill 5}}
                                
                                <!-- if effective skill is 6, critical failure is 16 or higher -->
                                {{#rollTotal() effectiveSkill 6}}
                                    {{#rollGreater() rollResult 15}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 15}}
                                {{/rollTotal() effectiveSkill 6}}
                                
                                <!-- if effective skill is 7 to 15, critical failure is 17 or 18 -->
                                {{#rollBetween() effectiveSkill 7 15}}
                                    {{#rollGreater() rollResult 16}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 16}}
                                {{/rollBetween() effectiveSkill 7 15}}
                                
                                <!-- NOTE: Roll of 18 check has already been made -->
                                  
                                <!-- additional critical failure text -->
                                <!-- if effective skill is 3 or less, critical failure is 13 or higher -->
                                {{#rollLess() effectiveSkill 4}}
                                    
                                    <!-- normal failure -->
									{{#rollLess() rollResult 13}}
                                        {{spellFailNote}}
                                    {{/rollLess() rollResult 13}}
                                    
                                    <!-- critical failure -->
                                    {{#rollGreater() rollResult 12}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 12}}
                                    
                                {{/rollLess() effectiveSkill 4}}
                                
                                <!-- if effective skill is 4, critical failure is 14 or higher -->
                                {{#rollTotal() effectiveSkill 4}}
                                    
                                    <!-- normal failure -->
                                    {{#rollLess() rollResult 15}}
                                        {{spellFailNote}}
                                    {{/rollLess() rollResult 15}}
                                    
                                    <!-- critical failure -->
                                    {{#rollGreater() rollResult 13}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 13}}
                                    
                                {{/rollTotal() effectiveSkill 4}}
                                
                                <!-- if effective skill is 5, critical failure is 15 or higher -->
                                {{#rollTotal() effectiveSkill 5}}
                                    
                                    <!-- normal failure -->
                                    {{#rollLess() rollResult 15}}
                                        {{spellFailNote}}
                                    {{/rollLess() rollResult 15}}
                                    
                                    <!-- critical failure -->
                                    {{#rollGreater() rollResult 14}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 14}}
                                    
                                {{/rollTotal() effectiveSkill 5}}
                                
                                <!-- if effective skill is 6, critical failure is 16 or higher -->
                                {{#rollTotal() effectiveSkill 6}}
                                    
                                    <!-- normal failure -->
                                    {{#rollLess() rollResult 16}}
                                        {{spellFailNote}}
                                    {{/rollLess() rollResult 16}}
                                    
                                    <!-- critical failure -->
                                    {{#rollGreater() rollResult 15}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 15}}
                                    
                                {{/rollTotal() effectiveSkill 6}}
                                
                                <!-- if effective skill is 7 to 15, critical failure is 17 or 18 -->
                                {{#rollBetween() effectiveSkill 7 15}}
                                    
                                    <!-- normal failure -->
                                    {{#rollLess() rollResult 17}}
                                        {{spellFailNote}}
                                    {{/rollLess() rollResult 17}}
                                    
                                    <!-- critical failure -->
                                    {{#rollGreater() rollResult 16}}
                                        {{spellCriticalFailureNote}}
                                    {{/rollGreater() rollResult 16}}
                                    
                                {{/rollBetween() effectiveSkill 7 15}}
                                
                            {{/rollGreater() rollResult effectiveSkill}}

                            <!-- check for success, roll from 5 to effective skill -->
                            <!-- NOTE: roll 3 or 4 has already been handled -->
                            {{#rollBetween() rollResult 5 effectiveSkill}}

                                <!-- Check if Critical Success was turned on -->
                                <!-- attr_use_critical_plus_10: 0 = only on 3 or 4, 1 = rules as written, 2 = turn off -->
                                <!-- NOTE: 3 or 4 has already been handled at the beginning -->
                                {{#rollLess() useCriticalPlusTen 2}}
                                
                                    <!-- If rules as written -->
                                    {{#rollTotal() useCriticalPlusTen 1}}
                                    
                                        <!-- normal success -->
                                        {{#rollGreater() rollResult 6}}
                                            <!-- block custom success note -->
                                        {{/rollGreater() rollResult 6}}
                                            
                                        <!-- if effective skill is 16 or higher, check for critical success on a 5 or 6 -->
                                        {{#rollGreater() effectiveSkill 15}}
                                            {{#rollBetween() rollResult 5 6}}
                                                {{spellCriticalSuccessNote}}
                                            {{/rollBetween() rollResult 5 6}}
                                        {{/rollGreater() effectiveSkill 15}}

                                        <!-- If rules as written and if effectiveSkill is 15, check for critical success on a 5 -->
                                        {{#rollTotal() effectiveSkill 15}}
                                            {{#rollTotal() rollResult 5}}
                                                {{spellCriticalSuccessNote}}
                                            {{/rollTotal() rollResult 5}}
                                        {{/rollTotal() effectiveSkill 15}}

                                    {{/rollTotal() useCriticalPlusTen 1}}

                                {{/rollLess() useCriticalPlusTen 2}}
                                
                                <!-- check if critical success is off -->
                                <!-- attr_use_critical_plus_10: 0 = only on 3 or 4, 1 = rules as written, 2 = turn off -->
                                {{#rollTotal() useCriticalPlusTen 2}}
                                    <!-- block custom success note -->
                                {{/rollTotal() useCriticalPlusTen 2}}
                                                          
                            {{/rollBetween() rollResult 5 effectiveSkill}}

                        {{/rollBetween() rollResult 5 16}}
                    
                    </td>
                </tr>
                {{/spellRoll}}
                {{/rollResult}}
                
                {{#useMalfunction}}
                {{#rollGreater() malfunction 0}}
                {{#rollBetween() rollResult malfunction 18}}
                <tr class="malfunction">
                    <td colspan="2">
						<span style="color: red; font-weight:bold;">
							<span data-i18n="rolltemplate-malfunction-label">Malfunction!</span>
						</span><br />
						{{#rollTotal() verifyMalfunction 1}}
							<span data-i18n="rolltemplate-verify-malfunction-description">
								<span style="color: red; font-weight:bold;">Verify!</span> roll 3d6 again to verify the results. See HT79.<br />
							</span>
						{{/rollTotal() verifyMalfunction 1}}
						<span data-i18n="rolltemplate-malfunction-description">
							For effect, Roll 3d6 and see table on B407 or use custom table.<br />
							<b style="color:red;">NOTE:</b> Malfunction has "priority" over a critical miss: if both would occur,
							only the malfunction takes place. Critical Misses, Basic Set, page 382.
						</span>
                    </td>
                </tr>
                {{/rollBetween() rollResult malfunction 18}}
                {{/rollGreater() malfunction 0}}
                {{/useMalfunction}}
                
                {{#damageRoll}}
                <tr>
                    <td class="label">
						<span data-i18n="damage-label">Damage</span>:
					</td>
                    <td class="damage-roll">
                        {{damageRoll}} <span class="damageType">{{damageType}}</span>
                    </td>
				</tr>
				{{#rollTotal() showMinimumDmgNote 1}}
                {{#minDamageNote}}
                <tr>
                    <td class="label">
						<span data-i18n="minimum-label">Minimum</span>:
					</td>
                    <td class="damage-roll">
						{{minDamageNote}}: 
						<span data-i18n="rolltemplate-minimum-damage-description">
							Applied to Target's DR<br />
							See B378 <b>Damage Roll</b>
						</span>
                    </td>
                </tr>
				{{/minDamageNote}}
				{{/rollTotal() showMinimumDmgNote 1}}
				{{/damageRoll}}
				
				{{#rollGreater() armorDivisor 1}}
				<tr>
                    <td class="label">
						<span data-i18n="armor-divisor-label">Armor Divisor</span>:
					</td>
                    <td class="effective-skill">{{armorDivisor}}</td>
				</tr>
				{{/rollGreater() armorDivisor 1}}
                
                {{#rollTotal() useDamageTypeNotes 1}}
                    {{#damageTypeNote}}
                    <tr class="damageTypeNote">
                        <td colspan="2"><span>{{damageTypeNote}}</span></td>
                    </tr>
                    {{/damageTypeNote}}
                {{/rollTotal() useDamageTypeNotes 1}}
                
                {{#rollTotal() showNotes 1}}
                    {{#notes}}
                    <tr class="notes">
                        <td colspan="2">{{notes}}</td>
                    </tr>
                    {{/notes}}
                {{/rollTotal() showNotes 1}}
				
				{{#rollTotal() showDBNotes 1}}
					{{#DBNotes}}
					<tr>
						<td class="label">DB:</td>
						<td>
							{{DBNotes}}
						</td>
					</tr>
					{{/DBNotes}}
				{{/rollTotal() showDBNotes 1}}

				{{#rollTotal() showCastingDetails 1}}
                
					{{#rollTotal() showSpellNotes 1}}
					{{#spellNotes}}
					<tr>
						<td class="label">Mods:</td>
						<td>
							{{spellNotes}}<br />
						</td>
					</tr>
					{{/spellNotes}}
					{{/rollTotal() showSpellNotes 1}}
					
					{{#castingTime}}
					<tr>
						<td class="label">
							<span data-i18n="time-label">Time</span>:
						</td>
						<td>{{castingTime}}</td>
					</tr>
					{{/castingTime}}
					
					{{#castingDuration}}
					<tr>
						<td class="label">
							<span data-i18n="duration-label">Duration</span>:
						</td>
						<td>{{castingDuration}}</td>
					</tr>
					{{/castingDuration}}
					
					{{#castingCost}}
					<tr>
						<td class="label">
							<span data-i18n="cost-label">Cost</span>:
						</td>
						<td>{{castingCost}}</td>
					</tr>
					{{/castingCost}}
					
					{{#castingMaintain}}
					<tr>
						<td class="label">
							<span data-i18n="maintain-label">Maintain</span>:
						</td>
						<td>{{castingMaintain}}</td>
					</tr>
					{{/castingMaintain}}				
					
					{{#castingResist}}
					<tr>
						<td class="label"><span data-i18n="resisted-by-label">Resisted by</span>:</td>
						<td>{{castingResist}}</td>
					</tr>
					{{/castingResist}}
					
					{{#castingClass}}
					<tr>
						<td class="label">
							<span data-i18n="class-label">Class</span>:
						</td>
						<td>{{castingClass}}</td>
					</tr>
					{{/castingClass}}
				{{/rollTotal() showCastingDetails 1}}
				
                
                {{#recoil}}
                <tr>
                    <td colspan="2">
                        <span class="title">
							<span data-i18n="recoil-label">Recoil</span>: 
						</span>{{recoil}}
                        {{#rollGreater() malfunction 0}}
                            <span class="title"><span data-i18n="abbreviation-malfunction-label">Malf</span>: </span>{{malfunction}}
                        {{/rollGreater() malfunction 0}}
                    </td>
                </tr>
				{{/recoil}}
				
        {{#rollTotal() noteBoxOneShow 1}}
                {{#noteBoxOneContent}}
                <tr>
                    <td class="label">{{noteBoxOneLabel}}</td>
                    <td>
                        {{noteBoxOneContent}}
                    </td>
                </tr>
                {{/noteBoxOneContent}}
        {{/rollTotal() noteBoxOneShow 1}}

        {{#rollTotal() noteBoxTwoShow 1}}
                {{#noteBoxTwoContent}}
                <tr>
                    <td class="label">{{noteBoxTwoLabel}}</td>
                    <td>
                        {{noteBoxTwoContent}}
                    </td>
                </tr>
                {{/noteBoxTwoContent}}
        {{/rollTotal() noteBoxTwoShow 1}}

        {{#rollTotal() noteBoxThreeShow 1}}
                {{#noteBoxThreeContent}}
                <tr>
                    <td class="label">{{noteBoxThreeLabel}}</td>
                    <td>
                        {{noteBoxThreeContent}}
                    </td>
                </tr>
                {{/noteBoxThreeContent}}
        {{/rollTotal() noteBoxThreeShow 1}}

        {{#rollTotal() noteBoxFourShow 1}}
                {{#noteBoxFourContent}}
                <tr>
                    <td class="label">{{noteBoxFourLabel}}</td>
                    <td>
                        {{noteBoxFourContent}}
                    </td>
                </tr>
                {{/noteBoxFourContent}}
        {{/rollTotal() noteBoxFourShow 1}}

            </table>
        </div>
	</rolltemplate>
	
	<rolltemplate class="sheet-rolltemplate-macro">
        <div class="container template-{{templateType}} rolltemplate-color-setting-{{sheetStyle}}">
			
			<div class="header">
				{{#title}}
				<div class="title">
					<div class="text">{{title}}</div>
				</div>
				{{/title}}
				{{#subtitle}}
				<div class="subtitle">
					<div class="text">{{subtitle}}</div>
				</div>
				{{/subtitle}}
			</div>

			<div class="arrow-container">
				<div class="arrow-right"></div>
			</div>

			<div class="content">

				{{#roll}}
				{{#target}}
				<div class="key">Roll</div>
				<div class="value">
					<span class="roll">{{roll}}</span> <span class="versus">vs</span> <span class="target">{{target}}</span>
				</div>
				{{/target}}
				{{/roll}}
				
				{{#roll}}
				{{#^target}}
				<div class="key">Roll</div>
				<div class="value">
					<span class="roll">{{roll}}</span>
				</div>
				{{/^target}}
				{{/roll}}
				
				<!-- list all the other properties that were not defined -->
				{{#allprops() title subtitle roll target desc templateType sheetStyle}}
				<div class="key">{{key}}</div>
      			<div class="value">{{value}}</div>
				{{/allprops() title subtitle roll target desc templateType sheetStyle}}

				{{#desc}}
				<div class="desc">{{desc}}</div>
				{{/desc}}

			</div>

        </div>
    </rolltemplate>
    
</div>

<script type="text/worker">
	 
	// this type is required by roll20, be sure to set before uploading
	// type="text/worker"
	
	// if using VS code or similar coding tool, use the type listed below
	// type="application/javascript"

	var noop = function () {}; // do nothing callback function.

	var version = "2.6.6";

	var latestChangesDate = "3/17/2021";

	var modCascade = true;
	
	var modCascadeAll = true;

	// add global variable
	var damageTable = [];
	
	const decelerationDivisor = 2;
	
	// see: https://app.roll20.net/forum/post/7251390/slug%7D
	const modBySpeedRange = [ 
                    	{r:1, m:0},
                    	{r:2, m:0},
                    	{r:3, m:-1},
                    	{r:5, m:-2},
                    	{r:7, m:-3},
                    	{r:10, m:-4},
                    	{r:15, m:-5},
                    	{r:20, m:-6},
                    	{r:30, m:-7},
                    	{r:50, m:-8},
                    	{r:70, m:-9},
                    	{r:100, m:-10},
                    	{r:150, m:-11},
                    	{r:200, m:-12},
                    	{r:300, m:-13},
                    	{r:500, m:-14},
                    	{r:700, m:-15},
                    	{r:1000, m:-16},
                    	{r:1500, m:-17},
                    	{r:2000, m:-18},
                    	{r:3000, m:-19},
                    	{r:5000, m:-20},
                    	{r:7000, m:-21},
                    	{r:10000, m:-22},
                    	{r:15000, m:-23},
						{r:20000, m:-24},
						{r:30000, m:-25},
						{r:50000, m:-26},
						{r:70000, m:-27},
						{r:100000, m:-28},
						{r:150000, m:-29},
						{r:200000, m:-30},
					];

    /**
     * Create global function
     * use: var mod = getModBySpeedRange(14);
     * Uses the array of json object objects
     * to get the modifier based on speed/range
     **/
    const getModBySpeedRange = (d) => {
    	
    	// find first matching entry where range is greater than or equal to distance
    	// Distance = 4, first entry where range is greater than 4. 
    	// Range = 5, which is greater than 4. return that object. Modifier = -2
    	const entry = modBySpeedRange.find((o)=>o.r>=d );
		
		// TODO: use formula. Each 10x increase in linear measurement, give +6 SM or -6 speed/range modifier
		
    	// if no matches, return -24.
    	return (entry != undefined ? entry.m : -30);
    
	};
	
	/**
	 * Defines all the skill modifiers
	 * used to total modifier, determine max9, and description summary.
	 * If isDropDown, value modifier is pulled from the drop-down value or special value based on radio button
	 * Map => key = field_name. value = { int modifier, string description, bool affectsVisibility, bool isDropDown, bool isMax9, bool isTrait, bool checkPain}
	 */
	const rollModifiers = new Map([
		["night_vision", {modifier: 0, description: "Night Vision", affectsVisibility: true, isDropDown: true, isMax9: false, isTrait: true, checkPain: false}],
		["has_dark_vision", {modifier: 0, description: "Dark Vision", affectsVisibility: true, isDropDown: false, isMax9: false, isTrait: true, checkPain: false}],
		["is_used_to_blindness", {modifier: 0, description: "Used to blindness", affectsVisibility: true, isDropDown: false, isMax9: false, isTrait: true, checkPain: false}],
		["has_high_pain_threshold", {modifier: 0, description: "High Pain Threshold", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: true, checkPain: false}],
		["shock_penalty", {modifier: 0, description: "Shock", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: true}],
		["dialog_custom_roll_modifier", {modifier: 0, description: "Custom modifier", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["darkness_penalty", {modifier: 0, description: "Darkness", affectsVisibility: true, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["visiblity_condition", {modifier: 0, description: "Based on selected condition", affectsVisibility: true, isDropDown: false, isMax9: true, isTrait: false, checkPain: false}],
		["darkness_penalty", {modifier: 0, description: "Darkness", affectsVisibility: true, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["smoke_penalty", {modifier: 0, description: "Smoke", affectsVisibility: true, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["fog_penalty", {modifier: 0, description: "Fog", affectsVisibility: true, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["blur_penalty", {modifier: 0, description: "Blur", affectsVisibility: true, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["other_vision_penalty", {modifier: 0, description: "Other vision penalty", affectsVisibility: true, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["coughing_sneezing_iq", {modifier: -1, description: "IQ Coughing/Sneezing", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["coughing_sneezing_dx", {modifier: -3, description: "DX Coughing/Sneezing", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["drowsy", {modifier: -2, description: "drowsy", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["tipsy", {modifier: -1, description: "Tipsy", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["drunk", {modifier: -2, description: "Drunk", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["euphoria", {modifier: -3, description: "Euphoria", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["distraction", {modifier: 0, description: "Distraction", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["pain_level", {modifier: 0, description: "Pain", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: true}],
		["skill_encumbered", {modifier: 0, description: "Encumbered", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["bad_footing", {modifier: 0, description: "Bad Footing", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["shield_close_combat_penalty", {modifier: 0, description: "Close combat with shield", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["grappled", {modifier: -4, description: "Grappled", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["holding_large_shield", {modifier: -2, description: "Holding Large Shield", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["task_difficulty", {modifier: 0, description: "Task Difficulty", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["task_extra_time", {modifier: 0, description: "Extra time for task", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["task_haste", {modifier: 0, description: "Hurry task", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["unfamiliar_culture", {modifier: -3, description: "Unfamiliar Culture", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["language_modifier", {modifier: 0, description: "Language Modifier", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["iq_tech_level_modifier", {modifier: 0, description: "IQ based Tech Level Modifier", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["non_iq_tech_level_modifier", {modifier: 0, description: "Non-IQ based Tech Level Modifier", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["task_equipment_modifier", {modifier: 0, description: "Equipment modifier", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["task_missing_items", {modifier: 0, description: "Missing items from equipment", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["task_damaged_equipment", {modifier: 0, description: "Damaged equipment", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["unfamiliar_equipment", {modifier: -2, description: "Unfamiliar Equipment", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["hit_location_modifier", {modifier: 0, description: "From hit_location field", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["melee_maneuver", {modifier: 0, description: "A function returns description", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["melee_all_out_attack", {modifier: 0, description: "A function returns description", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["deceptive_strike", {modifier: 0, description: "A function returns description", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["evaluate", {modifier: 0, description: "Evaluate", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["wild_swing", {modifier: -5, description: "Wild Swing", affectsVisibility: false, isDropDown: false, isMax9: true, isTrait: false, checkPain: false}],
		["rapid_strike", {modifier: -6, description: "Rapid Strike", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["flurry_of_blows", {modifier: -3, description: "Flurry of Blows. 1 FP per attack", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["rapid_strike_master", {modifier: -3, description: "Rapid Strike (master)", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["attack_from_above", {modifier: -2, description: "Attack from above", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["mighty_blow", {modifier: 0, description: "Mighty Blow 1 FP per attack. +2 Damage or +1 per die!", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["posture", {modifier: 0, description: "From a function", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: true, checkPain: false}],
		["melee_height_difference", {modifier: 0, description: "From a function", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["improvised_weapon", {modifier: 0, description: "Improvised Weapon", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["tactics", {modifier: 0, description: "Tactics", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["backstab", {modifier: 4, description: "Backstab", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_tactics", {modifier: 0, description: "Tactics", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_backstab", {modifier: 4, description: "Backstab", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["weapon_hand", {modifier: 0, description: "Weapon hand description from function", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_weapon_hand", {modifier: 0, description: "Weapon hand description from function", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["mounted_skill_difference", {modifier: 0, description: "Mount attack, difference between skills", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["mount_attacked", {modifier: -2, description: "Mount attacked last turn", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["mount_has_velocity", {modifier: -1, description: "Mount relative velocity 7+. +1 damage, lances special damage", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_accuracy_bonus", {modifier: 0, description: "Accuracy bonus.", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_range_speed_modifier", {modifier: 0, description: "Range/Speed Modifier.", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_aiming_bonus", {modifier: 0, description: "Aiming bonus.", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_rof_modifier", {modifier: 0, description: "Rate of Fire.", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_targeting_system_modifier", {modifier: 0, description: "Targeting system.", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_maneuver", {modifier: 0, description: "A function returns description.", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_in_close_combat", {modifier: 0, description: "Close combat", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_damaged_weapon", {modifier: 0, description: "Damaged weapon", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_strength_difference", {modifier: 0, description: "Strength Difference", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_opportunity_fire_watched", {modifier: 0, description: "Opportunity fire, Watched area", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_opportunity_fire_target", {modifier: -2, description: "Opportunity fire, check target first", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_braced", {modifier: 1, description: "Braced weapon", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_popup", {modifier: -2, description: "Pop-up attack", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_vehicle_conditions", {modifier: 0, description: "Function gets description", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_controll_roll", {modifier: 0, description: "Failed control roll", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_over_under_mount", {modifier: -6, description: "Over/under mount", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_vehicle_dodge", {modifier: -2, description: "Vehicle dodge", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["ranged_air_vehicle_dodge", {modifier: -4, description: "Vehicle dodge", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_maneuver", {modifier: 0, description: "A function returns description", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_crawling", {modifier: -3, description: "Crawling/Lying down", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_kneeling", {modifier: -2, description: "Kneeling/Sitting", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_from_behind", {modifier: -2, description: "Attacked from behind, you have peripheral vision", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_runaround", {modifier: -2, description: "Ranaround attack", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["shield_db", {modifier: 0, description: "Shield DB", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["magic_db", {modifier: 0, description: "Magic DB", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["general_db", {modifier: 0, description: "General DB", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_retreat_dodge", {modifier: 3, description: "Retreating Dodge", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_retreat_parry", {modifier: 1, description: "Retreating Block/Parry", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_retreat_parry_fence", {modifier: 3, description: "Retreating Parry using fencing, boxing, judo, karate", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_retreating_flight", {modifier: 1, description: "Retreating while flying, must be able to hover", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_acrobatic_dodge_success", {modifier: 2, description: "Acrobatic Dodge", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_acrobatic_dodge_failed", {modifier: -2, description: "Failed Acrobatic Dodge", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_dodge_drop", {modifier: 3, description: "Dodge & Drop", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_feverish", {modifier: 2, description: "Feverish defense (costs 1 FP)", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_offhand_parry", {modifier: -2, description: "Off-Hand Parry", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_parries", {modifier: 0, description: "Multiple parries", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_parries_master", {modifier: 0, description: "Multiple parries by a master", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_improvised_weapon", {modifier: 0, description: "Parry with improvised weapon", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_laser_sight", {modifier: 1, description: "Laster Sight", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_deceptive_attack", {modifier: 0, description: "Defending against deceptive attack", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_feint", {modifier: 0, description: "Defending against a feint", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_height_difference", {modifier: 0, description: "From a function", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_mounted", {modifier: 0, description: "Defending while mounted", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_tactics", {modifier: 0, description: "Tactics", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_hidden_weapon", {modifier: -2, description: "Defending against hidden weapon", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_parry_knife", {modifier: -1, description: "Parrying with knife/dagger", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_parry_kusari", {modifier: -2, description: "Parrying with kusari/whip", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_unarmed_parry", {modifier: -3, description: "Unarmed parry against a swung weapon", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_dual_weapon", {modifier: -1, description: "Defending against a dual-weapon attack", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_parry_flail", {modifier: -4, description: "Parrying against a flail", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_parry_nunchaku", {modifier: -2, description: "Parrying against a nunchaku", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_block_flail", {modifier: -2, description: "Blocking against a flail", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_block_nunchaku", {modifier: -1, description: "Blocking against a nunchaku", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_thrown_weapon", {modifier: -1, description: "Parry a thrown weapon", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_thrown_small_weapon", {modifier: -2, description: "Parry a small thrown weapon", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_trident_dodge", {modifier: -1, description: "Dodging a trident", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_trident_block", {modifier: -1, description: "Block/parry against a trident", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_stunned", {modifier: -4, description: "Stunned", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_nauseated", {modifier: -1, description: "Nauseated", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_encumbered", {modifier: 0, description: "Encumbered", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_cant_see_attacker", {modifier: -4, description: "Can't see attacker", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_bad_footing", {modifier: 0, description: "Bad footing", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_distraction", {modifier: 0, description: "Distraction", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["defense_grappled_dodge", {modifier: -1, description: "Grappled dodge penalty", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["defense_grappled_block", {modifier: -2, description: "Grappled block/parry penalty", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["spell_on_penalty_total", {modifier: 0, description: "Spells On penalty", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["spell_maintained_penalty_total", {modifier: 0, description: "Spells Concentration penalty", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["spells_low_mana", {modifier: -5, description: "Low Mana", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["spell_burn_hit_points", {modifier: 0, description: "Spell Burn HP", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["spell_ceremonial_bonus", {modifier: 0, description: "Spell Ceremonial Bonus", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["regular_spell_modifier", {modifier: 0, description: "Regular Spell Range Modifier", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["regular_spell_cant_see_touch", {modifier: -5, description: "Regular Spell Can't See or Touch", affectsVisibility: false, isDropDown: false, isMax9: false, isTrait: false, checkPain: false}],
		["spell_long_distance", {modifier: 0, description: "Spell Long Distance Modifier", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
		["spell_natures_strength", {modifier: 0, description: "Spell Nature's Strength", affectsVisibility: false, isDropDown: true, isMax9: false, isTrait: false, checkPain: false}],
	]);

	const traitFields = [
		"night_vision",
		"has_dark_vision",
		"has_high_pain_threshold",
		"has_low_pain_threshold",
		"is_used_to_blindness",
	];

	/**
	 * These fields modify a skill
	 **/
	const skillModifierFields = [
		"shock_penalty",
		"dialog_custom_roll_modifier",
		"dialog_custom_roll_modifier_reason",
		"night_vision",
		"has_dark_vision",
		"has_high_pain_threshold",
		"has_low_pain_threshold",
		"is_used_to_blindness",
		"coughing_sneezing_iq",
		"coughing_sneezing_dx",
		"drowsy",
		"tipsy",
		"drunk",
		"euphoria",
		"distraction",
		"pain_level",
		"skill_encumbered",
		"bad_footing",
		"shield_close_combat_penalty",
		"grappled",
		"holding_large_shield",
		"visiblity_condition",
		"darkness_penalty",
		"smoke_penalty",
		"fog_penalty",
		"blur_penalty",
		"other_vision_penalty",
		"task_difficulty",
		"task_extra_time",
		"task_haste",
		"unfamiliar_culture",
		"language_modifier",
		"iq_tech_level_modifier",
		"non_iq_tech_level_modifier",
		"task_equipment_modifier",
		"task_missing_items",
		"task_damaged_equipment",
		"unfamiliar_equipment",
	];

	/**
	 * These fields modify a technique rolls.
	 **/
	 const techniqueModifierFields = [
	 	"shock_penalty",
		"dialog_custom_roll_modifier",
		"dialog_custom_roll_modifier_reason",
		"night_vision",
		"has_dark_vision",
		"has_high_pain_threshold",
		"has_low_pain_threshold",
		"is_used_to_blindness",
		"coughing_sneezing_iq",
		"coughing_sneezing_dx",
		"drowsy",
		"tipsy",
		"drunk",
		"euphoria",
		"distraction",
		"pain_level",
		"skill_encumbered",
		"bad_footing",
		"shield_close_combat_penalty",
		"grappled",
		"holding_large_shield",
		"visiblity_condition",
		"darkness_penalty",
		"smoke_penalty",
		"fog_penalty",
		"blur_penalty",
		"other_vision_penalty",
		"task_difficulty",
		"task_extra_time",
		"task_haste",
		"unfamiliar_culture",
		"language_modifier",
		"iq_tech_level_modifier",
		"non_iq_tech_level_modifier",
		"task_equipment_modifier",
		"task_missing_items",
		"task_damaged_equipment",
		"unfamiliar_equipment",
	];

	/**
	 * These fields modify a skill
	 **/
	 const meleeModifierFields = [
		"shock_penalty",
		"dialog_custom_roll_modifier",
		"dialog_custom_roll_modifier_reason",
		"night_vision",
		"has_dark_vision",
		"has_high_pain_threshold",
		"has_low_pain_threshold",
		"is_used_to_blindness",
		"coughing_sneezing_iq",
		"coughing_sneezing_dx",
		"drowsy",
		"tipsy",
		"drunk",
		"euphoria",
		"distraction",
		"pain_level",
		"skill_encumbered",
		"bad_footing",
		"shield_close_combat_penalty",
		"grappled",
		"holding_large_shield",
		"visiblity_condition",
		"darkness_penalty",
		"smoke_penalty",
		"fog_penalty",
		"blur_penalty",
		"other_vision_penalty",
		"hit_location_modifier",
		"hit_location",
		"melee_maneuver",
		"melee_all_out_attack",
		"posture",
		"deceptive_strike",
		"evaluate",
		"rapid_strike",
		"flurry_of_blows",
		"rapid_strike_master",
		"attack_from_above",
		"mighty_blow",
		"melee_height_difference",
		"improvised_weapon",
		"tactics",
		"backstab",
		"weapon_hand",
		"off_hand_training",
		"dual_weapon_training",
		"mounted_skill_difference",
		"mount_attacked",
		"mount_has_velocity",
		"wild_swing",
	];

	/**
	 * These fields modify a skill
	 **/
	 const rangedModifierFields = [
		"shock_penalty",
		"dialog_custom_roll_modifier",
		"dialog_custom_roll_modifier_reason",
		"night_vision",
		"has_dark_vision",
		"has_high_pain_threshold",
		"has_low_pain_threshold",
		"is_used_to_blindness",
		"coughing_sneezing_iq",
		"coughing_sneezing_dx",
		"drowsy",
		"tipsy",
		"drunk",
		"euphoria",
		"distraction",
		"pain_level",
		"skill_encumbered",
		"bad_footing",
		"shield_close_combat_penalty",
		"grappled",
		"holding_large_shield",
		"visiblity_condition",
		"darkness_penalty",
		"smoke_penalty",
		"fog_penalty",
		"blur_penalty",
		"other_vision_penalty",
		"hit_location_modifier",
		"hit_location",
		"ranged_tactics",
		"ranged_backstab",
		"ranged_weapon_hand",
		"ranged_off_hand_training",
		"ranged_dual_weapon_training",
		"ranged_accuracy_bonus",
		"ranged_range_speed_modifier",
		"ranged_aiming_bonus",
		"ranged_rof_modifier",
		"ranged_targeting_system_modifier",
		"ranged_maneuver",
		"ranged_move_default_or_bulk",
		"ranged_in_close_combat",
		"ranged_damaged_weapon",
		"ranged_strength_difference",
		"ranged_opportunity_fire_watched",
		"ranged_opportunity_fire_target",
		"ranged_braced",
		"ranged_popup",
		"ranged_vehicle_conditions",
		"ranged_controll_roll",
		"ranged_over_under_mount",
		"ranged_vehicle_dodge",
		"ranged_air_vehicle_dodge",
	];

	/**
	 * These fields modify a skill
	 **/
	const defenseModifierFields = [
		"shock_penalty",
		"dialog_custom_roll_modifier",
		"dialog_custom_roll_modifier_reason",
		"night_vision",
		"has_dark_vision",
		"has_high_pain_threshold",
		"has_low_pain_threshold",
		"is_used_to_blindness",
		"defense_maneuver",
		"defense_crawling",
		"defense_kneeling",
		"defense_from_behind",
		"defense_runaround",
		"shield_db",
		"magic_db",
		"general_db",
		"defense_retreat_dodge",
		"defense_retreat_parry",
		"defense_retreat_parry_fence",
		"defense_retreating_flight",
		"defense_acrobatic_dodge_success",
		"defense_acrobatic_dodge_failed",
		"defense_dodge_drop",
		"defense_feverish",
		"defense_offhand_parry",
		"defense_parries",
		"defense_parries_master",
		"defense_improvised_weapon",
		"defense_laser_sight",
		"defense_deceptive_attack",
		"defense_feint",
		"defense_height_difference",
		"defense_mounted",
		"defense_tactics",
		"defense_hidden_weapon",
		"defense_parry_knife",
		"defense_parry_kusari",
		"defense_unarmed_parry",
		"defense_dual_weapon",
		"defense_parry_flail",
		"defense_parry_nunchaku",
		"defense_block_flail",
		"defense_block_nunchaku",
		"defense_thrown_weapon",
		"defense_thrown_small_weapon",
		"defense_trident_dodge",
		"defense_trident_block",
		"defense_stunned",
		"defense_nauseated",
		"defense_encumbered",
		"defense_cant_see_attacker",
		"defense_bad_footing",
		"defense_distraction",
		"defense_grappled_dodge",
		"defense_grappled_block",
	];

	/**
	 * These fields modify a skill
	 **/
	const spellModifierFields = [
		"shock_penalty",
		"dialog_custom_roll_modifier",
		"dialog_custom_roll_modifier_reason",
		"night_vision",
		"has_dark_vision",
		"has_high_pain_threshold",
		"has_low_pain_threshold",
		"is_used_to_blindness",
		"coughing_sneezing_iq",
		"coughing_sneezing_dx",
		"drowsy",
		"tipsy",
		"drunk",
		"euphoria",
		"distraction",
		"pain_level",
		"skill_encumbered",
		"bad_footing",
		"shield_close_combat_penalty",
		"grappled",
		"holding_large_shield",
		"spell_on_penalty_total",
		"spell_maintained_penalty_total",
		"spells_low_mana",
		"spell_burn_hit_points",
		"spell_ceremonial_bonus",
		"regular_spell_modifier",
		"regular_spell_cant_see_touch",
		"spell_long_distance",
		"spell_natures_strength",
	];

	// predefined hit locations
	const HIT_LOCATIONS_JSON = new Map([
		["arachnoid", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "brain", display: "Brain", penalty: -7, DR: 0, hp_divisor: 1, notes:""},
			{key: "eye-1", display: "Eye #1", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "eye-2", display: "Eye #2", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "eye-3", display: "Eye #3", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "eye-4", display: "Eye #4", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "eye-5", display: "Eye #5", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "eye-6", display: "Eye #6", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "leg-1", display: "Leg #1", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-2", display: "Leg #2", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-3", display: "Leg #3", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-4", display: "Leg #4", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-5", display: "Leg #5", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-6", display: "Leg #6", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-7", display: "Leg #7", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-8", display: "Leg #8", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
		]],
		["avian", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-wing", display: "Left Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-wing", display: "Right Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-leg", display: "Left Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foot", display: "Left Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-leg", display: "Right Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-foot", display: "Right Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
		]],
		["cancroid", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-pincer", display: "Left Pincer", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-pincer", display: "Right Pincer", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-1", display: "Leg #1", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-2", display: "Leg #2", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-3", display: "Leg #3", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-4", display: "Leg #4", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-5", display: "Leg #5", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-6", display: "Leg #6", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-7", display: "Leg #7", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "leg-8", display: "Leg #8", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "tail", display: "Tail", penalty: -3, DR: 0, hp_divisor: 3, notes:""},
		]],
		["centaur", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "animal-torso", display: "Animal Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-arm", display: "Left Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-hand", display: "Left Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-arm", display: "Right Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-hand", display: "Right Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-foreleg", display: "Left Foreleg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foreleg-foot", display: "Left Foreleg Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-foreleg", display: "Right Foreleg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-foreleg-foot", display: "Right Foreleg Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-hind-leg", display: "Left Hind Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-hind-foot", display: "Left Hind Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-hind-leg", display: "Right Hind Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-hind-foot", display: "Right Hind Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "tail", display: "Tail", penalty: -3, DR: 0, hp_divisor: 3, notes:""},
		]],
		["hexapod", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-wing", display: "Left Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-wing", display: "Right Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foreleg", display: "Left Foreleg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foreleg-foot", display: "Left Foreleg Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-foreleg", display: "Right Foreleg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-foreleg-foot", display: "Right Foreleg Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-mid-leg", display: "Left Mid Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-mid-foot", display: "Left Mid Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-mid-leg", display: "Right Mid Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-mid-foot", display: "Right Mid Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-hind-leg", display: "Left Hind Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-hind-foot", display: "Left Hind Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-hind-leg", display: "Right Hind Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-hind-foot", display: "Right Hind Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "tail", display: "Tail", penalty: -3, DR: 0, hp_divisor: 3, notes:""},
		]],
		["humanoid", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-arm", display: "Left Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-hand", display: "Left Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-arm", display: "Right Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-hand", display: "Right Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-leg", display: "Left Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foot", display: "Left Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-leg", display: "Right Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-foot", display: "Right Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
		]],
		["humanoid_low_tech", [
			{key: "chest", display: "Chest", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "abdomen", display: "Abdomen", penalty: -1, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-arm", display: "Left Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-hand", display: "Left Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-arm", display: "Right Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-hand", display: "Right Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-leg", display: "Left Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foot", display: "Left Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-leg", display: "Right Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-foot", display: "Right Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
		]],
		["humanoid_martial_arts", [
			{key: "chest", display: "Chest", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "abdomen", display: "Abdomen", penalty: -1, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck-veins", display: "Neck Veins", penalty: -8, DR: 0, hp_divisor: 1, notes:""},
			{key: "jaw", display: "Jaw", penalty: -6, DR: 0, hp_divisor: 1, notes:""},
			{key: "nose", display: "Nose", penalty: -7, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "spine", display: "Spine", penalty: -8, DR: 0, hp_divisor: 1, notes:""},
			{key: "left-ear", display: "Left Ear", penalty: -7, DR: 0, hp_divisor: 4, notes:""},
			{key: "right-ear", display: "Right Ear", penalty: -7, DR: 0, hp_divisor: 4, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-arm", display: "Left Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-arm-joints", display: "Left Arm Joints", penalty: -5, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-arm-veins", display: "Left Arm Veins", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "left-hand", display: "Left Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-hand-joints", display: "Left Hand Joints", penalty: -7, DR: 0, hp_divisor: 4, notes:""},
			{key: "right-arm", display: "Right Arm", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-arm-joints", display: "Right Arm Joints", penalty: -5, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-arm-veins", display: "Right Arm Veins", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "right-hand", display: "Right Hand", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-hand-joints", display: "Right Hand Joints", penalty: -7, DR: 0, hp_divisor: 4, notes:""},
			{key: "left-leg", display: "Left Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-leg-joints", display: "Left Leg Joints", penalty: -5, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-leg-veins", display: "Left Leg Veins", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "left-foot", display: "Left Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-foot-joint", display: "Left Foot Joint", penalty: -7, DR: 0, hp_divisor: 4, notes:""},
			{key: "right-leg", display: "Right Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-leg-joints", display: "Right Leg Joints", penalty: -5, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-leg-veins", display: "Right Leg Veins", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "right-foot", display: "Right Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-foot-joint", display: "Right Foot Joint", penalty: -7, DR: 0, hp_divisor: 4, notes:""},
		]],
		["ichthyoid", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -8, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -8, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-fin", display: "Left Fin", penalty: -2, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-fin", display: "Right Fin", penalty: -2, DR: 0, hp_divisor: 3, notes:""},
			{key: "top-fin", display: "Top Fin", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "bottom-fin", display: "Bottom Fin", penalty: -2, DR: 0, hp_divisor: 3, notes:""},
			{key: "tail", display: "Tail", penalty: -3, DR: 0, hp_divisor: 3, notes:""},
		]],
		["octopod", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "brain", display: "Brain", penalty: -7, DR: 0, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -8, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -8, DR: 0, hp_divisor: 10, notes:""},
			{key: "arm-1", display: "Arm #1", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "arm-2", display: "Arm #2", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "arm-3", display: "Arm #3", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "arm-4", display: "Arm #4", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "arm-5", display: "Arm #5", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "arm-6", display: "Arm #6", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "arm-7", display: "Arm #7", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "arm-8", display: "Arm #8", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
		]],
		["quadruped", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -9, DR: 0, hp_divisor: 10, notes:""},
			{key: "left-wing", display: "Left Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-wing", display: "Right Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foreleg", display: "Left Foreleg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-foreleg-foot", display: "Left Foreleg Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-foreleg", display: "Right Foreleg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-foreleg-foot", display: "Right Foreleg Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "left-hind-leg", display: "Left Hind Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "left-hind-foot", display: "Left Hind Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-hind-leg", display: "Right Hind Leg", penalty: -2, DR: 0, hp_divisor: 2, notes:""},
			{key: "right-hind-foot", display: "Right Hind Foot", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "tail", display: "Tail", penalty: -3, DR: 0, hp_divisor: 3, notes:""},
		]],
		["vermiform", [
			{key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			{key: "vitals", display: "Vitals", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "groin", display: "Groin", penalty: -3, DR: 0, hp_divisor: 1, notes:""},
			{key: "face", display: "Face", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "neck", display: "Neck", penalty: -5, DR: 0, hp_divisor: 1, notes:""},
			{key: "skull", display: "Skull", penalty: -7, DR: 2, hp_divisor: 1, notes:""},
			{key: "left-eye", display: "Left Eye", penalty: -8, DR: 0, hp_divisor: 10, notes:""},
			{key: "right-eye", display: "Right Eye", penalty: -8, DR: 0, hp_divisor: 10, notes:""},
		]],
		["wagon", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "wheel-1", display: "Wheel #1", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-2", display: "Wheel #2", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-3", display: "Wheel #3", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-3", display: "Wheel #3", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
		]],
		["automobile", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "vital-area", display: "Vital Area", penalty: -3, DR: 0, hp_divisor: 1, notes:"Tight-beam burning x2 damage. Impaling/piercing x3 damage."},
			{key: "large-windows", display: "Large Windows", penalty: -3, DR: 0, hp_divisor: 1, notes:"1/2 DR. Check occupant hit."},
			{key: "wheel-1", display: "Wheel #1", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-2", display: "Wheel #2", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-3", display: "Wheel #3", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-3", display: "Wheel #3", penalty: -4, DR: 0, hp_divisor: 8, notes:"If damaged, roll HT to avoid flat tire."},
		]],
		["rowboat", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "open-body", display: "Open Body", penalty: -3, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "open-body", display: "Open Body", penalty: -3, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
		]],
		["speedboat", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "vital-area", display: "Vital Area", penalty: -3, DR: 0, hp_divisor: 1, notes:"Tight-beam burning x2 damage. Impaling/piercing x3 damage."},
			{key: "open-body", display: "Open Body", penalty: -3, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
		]],
		["biplane", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "vital-area", display: "Vital Area", penalty: -3, DR: 0, hp_divisor: 1, notes:"Tight-beam burning x2 damage. Impaling/piercing x3 damage."},
			{key: "open-body", display: "Open Body", penalty: -3, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "wheel-1", display: "Wheel #1", penalty: -4, DR: 0, hp_divisor: 4, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-2", display: "Wheel #2", penalty: -4, DR: 0, hp_divisor: 4, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "left-wing", display: "Left Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:"If disabled, lose control and crash."},
			{key: "right-wing", display: "Right Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:"If disabled, lose control and crash."},
		]],
		["monoplane", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "vital-area", display: "Vital Area", penalty: -3, DR: 0, hp_divisor: 1, notes:"Tight-beam burning x2 damage. Impaling/piercing x3 damage."},
			{key: "large-windows", display: "Large Windows", penalty: -3, DR: 0, hp_divisor: 1, notes:"1/2 DR. Check occupant hit."},
			{key: "wheel-1", display: "Wheel #1", penalty: -4, DR: 0, hp_divisor: 4, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "wheel-2", display: "Wheel #2", penalty: -4, DR: 0, hp_divisor: 4, notes:"If damaged, roll HT to avoid flat tire."},
			{key: "left-wing", display: "Left Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:"If disabled, lose control and crash."},
			{key: "right-wing", display: "Right Wing", penalty: -2, DR: 0, hp_divisor: 2, notes:"If disabled, lose control and crash."},
		]],
		["helicopter", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "vital-area", display: "Vital Area", penalty: -3, DR: 0, hp_divisor: 1, notes:"Tight-beam burning x2 damage. Impaling/piercing x3 damage."},
			{key: "large-windows", display: "Large Windows", penalty: -3, DR: 0, hp_divisor: 1, notes:"1/2 DR. Check occupant hit."},
			{key: "rotor-main", display: "Main Rotor", penalty: -2, DR: 0, hp_divisor: 2, notes:"If disabled, lose control and crash."},
			{key: "rotor-tail", display: "Tail Rotor", penalty: -2, DR: 0, hp_divisor: 3, notes:"If disabled, lose control and crash."},
			{key: "left-skid", display: "Left Skid", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
			{key: "right-skid", display: "Right Skid", penalty: -4, DR: 0, hp_divisor: 3, notes:""},
		]],
		["tank", [
			{key: "body", display: "Body", penalty: 0, DR: 0, hp_divisor: 1, notes:"Check occupant hit."},
			{key: "vital-area", display: "Vital Area", penalty: -3, DR: 0, hp_divisor: 1, notes:"Tight-beam burning x2 damage. Impaling/piercing x3 damage."},
			{key: "caterpillar-track-left", display: "Left Track", penalty: -2, DR: 0, hp_divisor: 2, notes:"If track disabled, move is 0."},
			{key: "caterpillar-track-left", display: "Main Rotor", penalty: -2, DR: 0, hp_divisor: 2, notes:"If track disabled, move is 0."},
			{key: "main-turrent", display: "Main Turrent", penalty: -2, DR: 0, hp_divisor: 2, notes:"If major wound and failed HT roll, turret is knocked out."},
			{key: "exposed-weapon", display: "Exposed Weapon", penalty: -7, DR: 0, hp_divisor: 5, notes:""},
		]],
	]);

	const rawDefenseNotes = getRawActiveDefensesNotes();

	/* Due to the change from auto-calc fields to helper scripts,
	 * I'm running a "on open" to set various fields. At some point
	 * in the future this might no longer be needed.
	 */
	on('sheet:opened', function() {
	    
		console.log('********* Sheet Opened *********');

		syncRollOptions();

		syncModifierPromptOptions();

		setAttrs({inventory_fixed_digits: 1}); 

		sumRepeating('repeating_item', 'weighttotal', function(v) {
			setAttrs({ total_weight: Number(Math.round(v * 1000) / 1000).toFixed(3) });
		});
		sumRepeating('repeating_item', 'costtotal', function(v) {
			setAttrs({ total_value: Number((v * 100) / 100).toFixed(2) }, {silent: true});
		});
		
		getAttrs(['sheet_version', 'mod_cascade', 'modCascade', 'modCascadeAll'], function(v) {
		    
			if (v.modCascade && v.modCascadeAll) {
				modCascade = v.modCascade;
				modCascadeAll = v.modCascadeAll;
			}
			
			if (!v.sheet_version || v.sheet_version != version) {
				
				let hide = 0;

				// if this is a brand new sheet. don't show announcements
				if (!v.sheet_version) {
					hide = 1;
				}
				
				// Set sheet version:
				// show announcements div
				setAttrs({ 
                    sheet_version: version,
                    announcement_version: version,
                    latest_changes: latestChangesDate,
                    announcements_hide: hide,
                    announcements_show: 0
                });


				// initialize any empty fields in repeating sections since the default values were removed.
				loadRepeating('repeating_languages', 'spoken', 0);
				loadRepeating('repeating_languages', 'written', 0);
				loadRepeating('repeating_skills', 'points', 1);
				loadRepeating('repeating_cultures', 'points', 1);
				loadRepeating('repeating_techniques', 'points', 1);
				loadRepeating('repeating_spells', 'points', 1);

				// initialize all calculated stats
				resetAll(v.mod_cascade);
				
			} 
			
		});

		damageTable = generateDamageTable();
		
	});

	on('change:mod_cascade', function (e) {
		getAttrs(['mod_cascade'], function (v) {
			resetAll(v.mod_cascade);
		})
	});

	function resetAll(mod_cascade) {
		switch(mod_cascade) {
			case 'all':
				modCascade = true;
				modCascadeAll = true;
				break;
			case 'some':
				modCascade = true;
				modCascadeAll = false;
				break;
			default:
				modCascade = false;
				modCascadeAll = false;
		}
		setAttrs({
			modCascade: modCascade,
			modCascadeAll: modCascadeAll
		});
		
		// last thing to update is movement
		var thenMovementStats = _.after(1, function () {
		    
            // last thing to update is movement tables
		    updateToggleUnspentCheckBox();
            updateDiceDamageIcons();
            updateEnhancedMove();
            updateFlightValues();
            updateWaterMoveValues();
            updateJumpDistanceValues();
		    
		    // update conditions
		    updateHealthConditionChecks(); 

			updateFatiguePointThresholds();

			updateReach();

		});

		// After move, dodge, encumbrance, HP, and FP
		var thenCurrentMoveDodge = _.after(2, function () {
			updateMoveDodge(thenMovementStats);
		});

		// After DX and HT
		var thenSpeedMoveDodge = _.after(2, function () {
			
			updateBasicSpeed(function () {
			
				// After Basic Speed...
				updateBasicMove(thenCurrentMoveDodge);
				updateDodge(thenCurrentMoveDodge);
			
			});
			
		});
		
		// After Lift and weight...
		var thenEncumbrance = _.after(2, function () {
			updateEncLevel(thenCurrentMoveDodge);
		});
		
		// After Striking st damage
		var thenUpdateThrownObjectStats = _.after(1, function() {
		    updateThrownObjectStats();
		});

		sumRepeating('repeating_item', 'weighttotal', function (v) {
			setAttrs({ total_weight: Math.round(v * 1000) / 1000 }, {silent: false}, thenEncumbrance);
		});

		// Update attributes, then secondary characteristics, and so on...
		updateST(function () {
			
			// After ST...
			updateHP(thenCurrentMoveDodge);
			
			updateLift(thenEncumbrance);
			
			updateStrikingST();
			
			// updateStrikingST damage rolls
			// after completed, then update thrown object
			updateStrikingStrengthDamage(thenUpdateThrownObjectStats);
			
		});
		
		updateDX(thenSpeedMoveDodge);
		
		updateIQ(function () {
			
			// After IQ...
			updateWill();
			
			updatePer(function () {
				// After Per...
				updateSense();
			});
			
		});
		
		updateHT(function () {
		    
			updateFP(thenCurrentMoveDodge);
			
			thenSpeedMoveDodge();

		});
		
		updateDamageNotes();
		
		updateFrightCheckThreshold();
		
		updateRepeatingDefenseTypes();

		updateStaticDefenseNotes();
		
		updateRepeatingDefenseNotes();
		
		// use underscore wrap to update skills, then update melee/ranged linked skills
		runUpdateRepeatingSkillLevels = _.wrap(updateRepeatingSkillLevels, function() {
		    
		    thenUpdateLinkedAttacksSkills(); 
		    
		});
		
		runUpdateRepeatingSkillLevels();
		
		runUpdateRepeatingSpellLevels = _.wrap(updateRepeatingSpellLevels, function() {
		    
		    thenUpdateLinkedAttacksSpells(); 
		    
		});
		
		runUpdateRepeatingSpellLevels();

		updateHitPointThresholds();
			
	}
	
	function thenUpdateLinkedAttacksSkills() {
		
	    updateLinkedSkills("repeating_melee", "melee");
    
        updateLinkedSkills("repeating_ranged", "ranged");
		
		updateLinkedSkills("repeating_techniquesrevised", "technique");

		updateLinkedSkills("repeating_defense", "defense");

	}

	function thenUpdateLinkedAttacksSpells() {
		
	    updateLinkedSkills("repeating_melee", "melee");
    
        updateLinkedSkills("repeating_ranged", "ranged");
		
		updateLinkedSkills("repeating_techniquesrevised", "technique");

		updateLinkedSkills("repeating_defense", "defense");

	}

	// Sum values, used in reduce
	function getSum(total, num) {
		return (+total || 0) + (+num || 0);
	}

	// function to sum a field from a repeating section
	function sumRepeating(sectionName, fieldName, callback) {
		getSectionIDs(sectionName, function (ids) {
			if (ids.length === 0 ) {
				callback(0);
				return;
			}
			var fieldArray = [];
			for (var i = 0; i < ids.length; i++) {
				fieldArray.push(sectionName + '_' + ids[i] + '_' + fieldName);
			}
			getAttrs(fieldArray, function (fieldValues) {
				var vals = Object.values(fieldValues);
				vals.push(0);
				var total = vals.reduce(getSum);
				callback(total);
			});
		});
	}

	// load values of a repeating section
	function loadRepeating(sectionName, fieldName, defaultValue) {
		
		console.log('********* loadRepeating ' + sectionName + '.' + fieldName + '*********');
		
		getSectionIDs(sectionName, function (ids) {
		
			if (ids.length === 0 ) {
				return;
			}
		
			var fieldArray = [];
		
			var update = {};
		
			for (var i = 0; i < ids.length; i++) {
			
				var propName = sectionName + '_' + ids[i] + '_' + fieldName;
			
				fieldArray.push(propName);
			
				update[propName] = defaultValue;
			}
		
			getAttrs(fieldArray, function (fieldValues) {
				Object.assign(update, fieldValues);
				setAttrs(update);
			});
			
		});
		
	}
	
	// Strength Change
	on('change:strength_points change:strength_mod change:defense_knockback_hitpoints_mod change:size change:apply_size_modifier', function (e) {
		updateST();
	});

	/**
	 * Get the size modifier percentage for use with 
	 * Strength and extra HP character point costs
	 * 
	 * @param int sizeModifier size of character
	 * 
	 * @return int
	 */
	function getSizeModifierPercentage(sizeModifier) {

		let percentModifier = 0;

		// make sure we have an integer
		if (Number.isInteger(sizeModifier) === false) {
			sizeModifier = Math.floor(sizeModifier);
		}

		if (1 <= sizeModifier && sizeModifier <= 8) {
			percentModifier = -10 * sizeModifier;
		} else if (sizeModifier > 8) {
			percentModifier = -80;
		}
		
		return percentModifier;

	}

	/**
	 * Get the point cost per level based on size modifier.
	 * 
	 * @param bool applySizeModifier Should size modifier by applied?
	 * @param int  sizeModifier      Size of character
	 * @param int  basePointsPerLevel Cost per level for an attribute. ST is 10 per level. HP is 2 per level
	 */
	function getSizeModifierPointsPerLevel(applySizeModifier, sizeModifier, basePointsPerLevel) {

		let pointsPerLevel = basePointsPerLevel;

		// make sure we have an integer
		if (Number.isInteger(sizeModifier) === false) {
			sizeModifier = Math.floor(sizeModifier);
		}

		if (applySizeModifier && sizeModifier > 0) {

			let percentModifier = getSizeModifierPercentage(sizeModifier);

			let decimalModifier = percentModifier / 100;

			// formula ST example: points per level = 10
			//                     basePointsPerLevel + (basePointsPerLevel * percentModifier) = pointsPerLevel
			//                     10 + (10 * 0) = 10		-- size modifier = 0
			//                     10 + (10 * -10%) = 9		-- size mofifier = 1 | -10% = -.1
			//                     10 + (10 * -20%) = 8		-- size modifier = 2
			// formula HP example: points per level = 2
			//                     2 + (2 * -10%) = 2
			pointsPerLevel = basePointsPerLevel + (basePointsPerLevel * decimalModifier);

		}

		return pointsPerLevel;

	}

	// Update Strength
	function updateST(callback) {

		callback = callback || noop;
		
		console.log('********* updateST *********');
		
		getAttrs(['strength_points', 'strength_mod', 'strength_halved', 'defense_knockback_hitpoints_mod', 'apply_size_modifier', 'size'], function(v) {
		    
			let applySizeModifier = (v.apply_size_modifier == "1");

			let sizeModifier = Number(v.size) || 0;

			let characterPoints = Number(v.strength_points) || 0;

			let pointsPerLevel = getSizeModifierPointsPerLevel(applySizeModifier, sizeModifier, 10);

			let strengthModByCharacterPoints = Math.floor(characterPoints/pointsPerLevel);

			// check for remainder. 
			let hasRemainder = (characterPoints % pointsPerLevel) >= 1;

			let pointsNeededForStrength = 0;

			let showMessage = 0;

			if (applySizeModifier && sizeModifier > 0 && hasRemainder) {

				showMessage = 1;

				pointsNeededForStrength = Math.floor(pointsPerLevel * strengthModByCharacterPoints);

			}

			let base = 10 + strengthModByCharacterPoints;
			
			let mod = +v.strength_mod || 0;
			
			let st_halved = +v.strength_halved;
			
			let st_display = base + mod;
			
			let knockbackMod = +v.defense_knockback_hitpoints_mod;

			// check if ST was halved due to fatigue.
			if (st_halved === 1) {
			    
			    st_display = st_display/2;
			
			}
			
			setAttrs({
				strength_base: base,
				strength: base + mod,
				strength_display: st_display,
				knockback_points: st_display - 2 + knockbackMod,
				show_size_modifier_strength_message: showMessage,
				size_modifier_cp_strength_adjustment: pointsNeededForStrength
			}, {silent: false}, callback);
		});
	}

	// Dexterity Change
	on('change:dexterity_points change:dexterity_mod', function (e) {
		updateDX();
	});

	// Update Dexterity
	function updateDX(callback) {
		callback = callback || noop;
		console.log('********* updateDX *********');
		getAttrs(['dexterity_points', 'dexterity_mod'], function(v) {
			var base = 10 + ((+v.dexterity_points || 0) / 20 | 0);
			var mod = +v.dexterity_mod || 0;
			setAttrs({
				dexterity_base: base,
				dexterity: base + mod
			}, {silent: false}, callback);
		});
	}

	// Intelligence
	on('change:intelligence_points change:intelligence_mod', function (e) {
		updateIQ();
	});

	// Update Intelligence
	function updateIQ(callback) {
		callback = callback || noop;
		console.log('********* updateIQ *********');
		getAttrs(['intelligence_points', 'intelligence_mod'], function(v) {
			var base = 10 + ((+v.intelligence_points || 0) / 20 | 0);
			var mod = +v.intelligence_mod || 0;
			setAttrs({
				intelligence_base: base,
				intelligence: base + mod
			}, {silent: false}, callback);
		});
	}

	// Health
	on('change:health_points change:health_mod', function (e) {
		updateHT();
	});

	// Update Health
	function updateHT(callback) {
		callback = callback || noop;
		console.log('********* updateHT *********');
		getAttrs(['health_points', 'health_mod'], function(v) {
			var base = 10 + ((+v.health_points || 0) / 10 | 0);
			var mod = +v.health_mod || 0;
			setAttrs({
				health_base: base,
				health: base + mod
			}, {silent: false}, callback);
		});
	}

	// HP
	on('change:strength change:hit_points_points change:hit_points_mod change:apply_size_modifier change:size', function (e) {
		
		// after updating hit points, update thresholds
		updateHP(updateHitPointThresholds);
	
	});
	
	// Update HP
	function updateHP(callback) {
		
		console.log('********* updateHP *********');
		
		callback = callback || noop;
		
		getAttrs(['strength', 'strength_base', 'hit_points_points', 'hit_points_mod', 'apply_size_modifier', 'size'], function(v) {
		
			let applySizeModifier = (v.apply_size_modifier == "1");

			let sizeModifier = Number(v.size) || 0;

			let characterPoints = Number(v.hit_points_points) || 0;

			let pointsPerLevel = getSizeModifierPointsPerLevel(applySizeModifier, sizeModifier, 2);

			let modByCharacterPoints = Math.floor(characterPoints/pointsPerLevel);

			// check for remainder. 
			let hasRemainder = (characterPoints % pointsPerLevel) >= 1;

			let pointsNeededForHitPoints = 0;

			let showMessage = 0;

			if (applySizeModifier && sizeModifier > 0 && hasRemainder) {

				showMessage = 1;

				pointsNeededForHitPoints = Math.floor(pointsPerLevel * modByCharacterPoints);

			}
			
			let base = (modCascadeAll ? +v.strength : +v.strength_base) + modByCharacterPoints;
		
			let mod = +v.hit_points_mod || 0;

			let hitPoints = base + mod;

			let majorWound = Math.floor(hitPoints/2) + 1;
		
			setAttrs({
				hit_points_max: hitPoints,
				major_wound_threshold: majorWound,
				show_size_modifier_hit_point_message: showMessage,
				size_modifier_cp_hit_point_adjustment: pointsNeededForHitPoints
			}, {silent: false}, callback);
		
		});
	}

	// FP
	on('change:health change:fatigue_points_points change:fatigue_points_mod', function (e) {
		updateFP(updateFatiguePointThresholds);
	});

	// Update FP
	function updateFP(callback) {
		console.log('********* updateFP *********');
		callback = callback || noop;
		getAttrs(['health', 'health_base', 'fatigue_points_points', 'fatigue_points_mod'], function(v) {
			var base = (modCascadeAll ? +v.health : +v.health_base) +
				((+v.fatigue_points_points || 0) / 3 | 0);
			var mod = +v.fatigue_points_mod;
			setAttrs({
				fatigue_points_max: base + mod
			}, {silent: false}, callback);
		});
	}

	// Perception
	on('change:intelligence change:perception_points change:perception_mod', function (e) {
		updatePer();
	});
	// Update Perception
	function updatePer(callback) {
		console.log('********* updatePer *********');
		callback = callback || noop;
		getAttrs(['intelligence', 'intelligence_base', 'perception_points', 'perception_mod'], function(v) {
			var base = (modCascade ? +v.intelligence : +v.intelligence_base) +
				((+v.perception_points || 0) / 5 | 0);
			var mod = +v.perception_mod || 0;
			setAttrs({
				perception_base: base,
				perception: base + mod
			}, {silent: false}, callback);
		});
	}

	// Vision, Hearing, Smell, Touch
	on('change:perception change:vision_points change:vision_mod change:hearing_points change:hearing_mod change:taste_smell_points change:taste_smell_mod change:touch_points change:touch_mod', function (e) {
		updateSense();
	});

	// Update Vision, Hearing, Smell, Touch
	function updateSense() {
		console.log('********* updateSense *********');
		getAttrs(['perception', 'perception_base', 'vision_points', 'vision_mod', 'hearing_points', 'hearing_mod', 'taste_smell_points', 'taste_smell_mod', 'touch_points', 'touch_mod'], function(v) {
			var base = (modCascade ? +v.perception : +v.perception_base);
			var visionBase = base + ((+v.vision_points || 0) / 2 | 0);
			var visionMod = +v.vision_mod || 0;
			var hearingBase = base + ((+v.hearing_points || 0) / 2 | 0);
			var hearingMod = +v.hearing_mod || 0;
			var tasteSmellBase = base + ((+v.taste_smell_points || 0) / 2 | 0);
			var tasteSmellMod = +v.taste_smell_mod || 0;
			var touchBase = base + ((+v.touch_points || 0) / 2 | 0);
			var touchMod = +v.touch_mod || 0;
			setAttrs({
				vision_base: visionBase,
				vision: visionBase + visionMod,
				hearing_base: hearingBase,
				hearing: hearingBase + hearingMod,
				taste_smell_base: tasteSmellBase,
				taste_smell: tasteSmellBase + tasteSmellMod,
				touch_base: touchBase,
				touch: touchBase + touchMod
			});
		});
	}

	// Updage Willpower, Fear (This is actually called Fright Check - the General page reflects this)
	on('change:intelligence change:willpower_points change:willpower_mod change:fear_check_points change:fear_check_mod', function (e) {
		updateWill();
	});

	// Updage Willpower, Fear (This is actually called Fright Check - the General page reflects this)
	function updateWill() {
		console.log('********* updateWill *********');
		getAttrs(['intelligence', 'intelligence_base', 'willpower_points', 'willpower_mod', 'fear_check_points', 'fear_check_mod'], function(v) {
			var wBase = (modCascade ? +v.intelligence : +v.intelligence_base) +
				((+v.willpower_points || 0) / 5 | 0);
			var wMod = +v.willpower_mod || 0;
			var fBase = wBase + (modCascade ? +wMod : 0) +
				((+v.fear_check_points || 0) / 2 | 0);
			var fMod = +v.fear_check_mod || 0;
			setAttrs({
				willpower_base: wBase,
				willpower: wBase + wMod,
				fear_check_base: fBase,
				fear_check: fBase + fMod
			});
		});
	}
	
	// Check for conditions to HT and conditions
	on('change:health change:stun_check_mod change:knockdown_check_mod change:unconscious_check_mod change:unconscious_check_points change:death_check_mod change:death_check_points', function (e) {
		updateHealthConditionChecks();
	});
	
	// Update HT, update Stun, Knockdown, Unconscious, and Death Checks
	function updateHealthConditionChecks() {
		console.log('********* updateHealthConditionChecks *********');
		getAttrs(['health', 'health_base', 'stun_check_mod', 'knockdown_check_mod', 'unconscious_check_mod', 'unconscious_check_points', 'death_check_mod', 'death_check_points'], function(v) {
			
			var healthBase = (modCascade ? +v.health : +v.health_base);
			
			// stun
			var stunMod = +v.stun_check_mod || 0;
			
			var stunCheck = healthBase + stunMod;
			
			// knockdown	
			var knockDownMod = +v.knockdown_check_mod || 0;
			
			var knockDownCheck = healthBase + knockDownMod;
			
			// unconscious
			var unconsciousMod = +v.unconscious_check_mod || 0; 
			
			var unconsciousCheck = healthBase + (modCascade ? +unconsciousMod : 0) + ((+v.unconscious_check_points || 0) / 2 | 0);
			
			// death
			var deathMod = +v.death_check_mod || 0;
			
			var deathCheck = healthBase + (modCascade ? +deathMod : 0) + ((+v.death_check_points || 0) / 2 | 0);
			
			setAttrs({
			    stun_check: stunCheck,
				knockdown_check: knockDownCheck,
				unconscious_check: unconsciousCheck,
				death_check: deathCheck
			});
		});
	}
	
	

	// Speed
	on('change:dexterity change:health change:basic_speed_points change:basic_speed_mod', function (e) {
		updateBasicSpeed();
	});

	// Update Speed
	function updateBasicSpeed(callback) {
		console.log('********* updateBasicSpeed *********');
		callback = callback || noop;
		getAttrs(['dexterity', 'dexterity_base', 'health', 'health_base', 'basic_speed_points', 'basic_speed_mod'], function(v) {
			var dx = (modCascade ? +v.dexterity : +v.dexterity_base);
			var ht = (modCascade ? +v.health : +v.health_base);
			var base = (dx + ht) / 4 + (((+v.basic_speed_points || 0) / 5 | 0) * 0.25);
			var mod = +v.basic_speed_mod || 0;
			setAttrs({
				basic_speed_base: base,
				basic_speed: base + mod
			}, {silent: false}, callback);
		});
	}

	// Move
	on('change:basic_speed change:basic_move_points change:basic_move_mod', function (e) {
		updateBasicMove();
	});

	// Update Move
	function updateBasicMove(callback) {
		console.log('********* updateBasicMove *********');
		callback = callback || noop;
		getAttrs(['basic_speed', 'basic_speed_base', 'basic_move_points', 'basic_move_mod'], function(v) {
			var speed = (modCascade ? +v.basic_speed : +v.basic_speed_base);
			var base = Math.floor(speed) + ((+v.basic_move_points || 0) / 5 | 0);
			var mod = +v.basic_move_mod || 0;
			setAttrs({
				basic_move_base: base,
				basic_move: base + mod
			}, {silent: false}, callback);
		});
	}

	// Dodge
	on('change:basic_speed change:dodge_mod', function (e) {
		updateDodge();
	});

	// Update Dodge
	function updateDodge(callback) {
		console.log('********* updateDodge *********');
		callback = callback || noop;
		getAttrs(['basic_speed', 'basic_speed_base', 'dodge_mod'], function(v) {
			var speed = (modCascade ? +v.basic_speed : +v.basic_speed_base);
			var base = Math.floor(speed) + 3;
			var mod = +v.dodge_mod || 0;
			setAttrs({
				dodge_base: base,
				dodge: base + mod
			}, {silent: false}, callback);
		});
	}

	// Encumbered/injured move and dodge
	on('change:encumbrance_level change:dodge change:basic_move change:hit_points change:fatigue_points', function (e) {
	    
		updateMoveDodge();
	
	});
	
	// Update encumbered/injured move and dodge
	function updateMoveDodge(callback) {
	    
		console.log('***** UPDATE MOVE/DODGE *****');
		
		callback = callback || noop;
		
		getAttrs(['encumbrance_level', 'dodge', 'basic_move', 'hit_points', 'hit_points_max', 'fatigue_points', 'fatigue_points_max', 'strength'], function(v) {
		
		    var dodge = +v.dodge;
		
			var move = +v.basic_move;

			let groundStep = 0;
		
			var hitPointsNotes = 0;
			
			var fatiguePointNotes = 0;
			
			var dodgeNotes = 0;
			
			var strengthDisplay = +v.strength;
			
			var strengthHalved = 0;
		
			if (v.encumbrance_level === 5) {
			    
				dodge = 1;
				
				move = 1;
				
			} else {
				
				dodge = dodge - +v.encumbrance_level;
			
			    // There is some math error when calculating Encumbrance which requires the modifier of 1.01 instead of 1 below
				move = Math.floor(+v.basic_move * (1.01 - (0.2 * +v.encumbrance_level)));
				
				dodge = dodge < 1 ? 1 : dodge;
				
				move = move < 1 ? 1 : move;
			}
			// check for reduced move for low hit points
			if (+v.hit_points < +v.hit_points_max / 3) {
				
				hitPointsNotes = 1;
				
				dodgeNotes = 1;
				
				dodge = Math.ceil(dodge / 2);
				
				move = Math.ceil(move / 2);
				
			}
			
			// check for reduced move for low fatigue points
			if (+v.fatigue_points < +v.fatigue_points_max / 3 ) {
			    
			    fatiguePointNotes = 1;
			    
			    dodgeNotes = 1; 
			    
				dodge = Math.ceil(dodge / 2);
				
				move = Math.ceil(move / 2);
				
				// reduce strength_display in half
				strengthDisplay = Math.ceil(strengthDisplay / 2);
				
				strengthHalved = 1;
				
			}
			
			// if both hit and fatigue were reduced, then change trigger to value
			if ( hitPointsNotes === 1 && fatiguePointNotes == 1 ) {
			    
			    hitPointsNotes = 2;
			    
			    fatiguePointNotes = 2;
			    
			    dodgeNotes = 2;
			    
			}

			groundStep = Math.ceil(move/10);

			setAttrs({
				current_move: `${move} (${groundStep})`,
				current_ground_step: groundStep,
				current_dodge: dodge,
				hit_points_notes: hitPointsNotes,
				fatigue_points_notes: fatiguePointNotes,
				dodge_reduced_notes: dodgeNotes,
				strength_display: strengthDisplay,
				strength_halved: strengthHalved
			}, {silent: false}, callback);
			
		});
	}

	// Lifting ST
	on('change:strength change:lift_st_points change:lift_st_mod', function (e) {
		updateLift();
	});

	// Update Lift
	function updateLift(callback) {
		console.log('********* updateLift *********');
		callback = callback || noop;
		getAttrs(['strength', 'strength_base', 'lift_st_points', 'lift_st_mod'], function(v) {
			var base = (modCascade ? +v.strength : +v.strength_base) +
				((+v.lift_st_points || 0) / 3 | 0);
			var modded = base + +v.lift_st_mod;
			var basicLift = (modded * modded) / 5;
			if (basicLift >= 10) {
				basicLift = Math.round(basicLift);
			}
			setAttrs({
				lift_st_base: base,
				lift_st: modded,
				basic_lift: basicLift
			}, {silent: false}, callback);
		});
	}

	// Striking ST
	on('change:strength change:striking_st_points change:striking_st_mod', function (e) {
		updateStrikingST();
	});

	// Update Striking
	function updateStrikingST() {

		console.log('********* updateStrikingST *********');

		getAttrs(['strength', 'strength_base', 'striking_st_points', 'striking_st_mod'], function(v) {
		
			var base = (modCascade ? +v.strength : +v.strength_base) + ((+v.striking_st_points || 0) / 5 | 0);
			
			var mod = +v.striking_st_mod;
			
			setAttrs({
				striking_st_base: base,
				striking_st: base + mod
			});

		});
	}

	// Update the total cost of Languages
	on('change:native_language_spoken change:native_language_written change:repeating_languages:spoken change:repeating_languages:written remove:repeating_languages', function (e) {
		console.log('**** Languages Changed ****');
		var total = 0;
		var tally = _.after(2, function () {
			setAttrs({ languages_points: total });
		});
		getAttrs(['native_language_spoken', 'native_language_written'], function(v) {
			total += +v.native_language_spoken;
			total += +v.native_language_written;
			tally();
		});
		sumRepeating('repeating_languages', 'spoken', function(v) {
			total += +v;
			tally();
		});
		sumRepeating('repeating_languages', 'written', function(v) {
		    total += +v;
			tally();
		});
	});

	// Update the total cost of Cultural Familiarities
	on('change:repeating_cultures:points remove:repeating_cultures', function (e) {
		sumRepeating('repeating_cultures', 'points', function(v) {
			setAttrs({ cf_points: v });
		});
	});

	// Update the total cost of Advantages
	on('change:repeating_traits:points remove:repeating_traits', function (e) {
		sumRepeating('repeating_traits', 'points', function(v) {
			setAttrs({ advantages_points: v });
		});
	});

	// Update the total cost of Perks
	on('change:repeating_perks remove:repeating_perks', function (e) {
		sumRepeating('repeating_perks', 'points', function(v) {
			setAttrs({ advantages_perks: v });
		});
	});

	// Update the total cost of Disadvantages
	on('change:repeating_disadvantages:points remove:repeating_disadvantages', function (e) {
		sumRepeating('repeating_disadvantages', 'points', function(v) {
			setAttrs({ disadvantages_points: v });
		});
	});

	// Update the total cost of Quirks
	on('change:repeating_quirks remove:repeating_quirks', function (e) {
		sumRepeating('repeating_quirks', 'points', function(v) {
			setAttrs({ disadvantages_quirks: v });
		});
	});

	// Update the total cost of Racial Traits
	on('change:repeating_racial:points remove:repeating_racial', function (e) {
		sumRepeating('repeating_racial', 'points', function(v) {
			setAttrs({ racial_points: v });
		});
	});

	// Update the total cost of Skills
	on('change:repeating_skills:points change:repeating_skills:difficulty remove:repeating_skills', function (e) {
	    
	    // checkForWildCardSkill(e);
        getAttrs(['repeating_skills_points', 'repeating_skills_difficulty'], function (skill) {
            
            var skill_points = +skill.repeating_skills_points;
            
            var adjusted_points = 0;
            
            var use_wildcard_points = 0;
            
            var use_normal_skill = 0; 
            
            if (String(skill.repeating_skills_difficulty) == "-5 + 1") {
                
                use_wildcard_points = 1;
                
                use_normal_points = 0;
                
                // minimum point cost is 3
                if (skill_points < 3) {
                    
                    wildcard_skill_points = 0;
                
                } else {
                
                    wildcard_skill_points = Math.floor(skill_points/3);
                    
                }
                
            } else {
                
                use_wildcard_points = 0;
                
                use_normal_points = 1;
                
                wildcard_skill_points = skill.repeating_skills_points;
                
            }
            
			setAttrs({
			    repeating_skills_wildcard_skill_points: wildcard_skill_points,
			    repeating_skills_use_wildcard_points: use_wildcard_points,
			    repeating_skills_use_normal_points: use_normal_points
			});
			
		    sumRepeating('repeating_skills', 'points', function(v) {
			    setAttrs({ skills_points: v });
		    });
		
		});
		
	});
	
	// watches for a change in a single row, updates row id and skill level
	// event = {sourceAttribute, sourceType, triggerName, sourceAttribute, previousValue, newValue}
	on("change:repeating_spells change:repeating_skills change:repeating_techniquesrevised change:repeating_melee", event => {

		let source = event.sourceType;

		if (event.sourceAttribute === event.triggerName) {
			//exit. row is being deleted
			return;
		}
		
		let row = event.triggerName;

		let [section, rowId] = getSectionRowIdFromChangeEvent(event);

		switch (section) {
			case "repeating_spells":
				updateRowIdDisplay(section, rowId, updateSpellLevelForRow(section, rowId));
				break;
		
			case "repeating_skills":
				updateRowIdDisplay(section, rowId, updateSkillLevelForRow(section, rowId));
				break;

			case "repeating_techniquesrevised":
				updateRowIdDisplay(section, rowId);
				break;
			
			case "repeating_melee":
				updateRowIdDisplay(section, rowId);
				break;
		}
		
	});

	/**
	 * Updates the display row id for a repeating section
	 * 
	 * @param string   section  Repeating section name
	 * @param string   rowId    Row id of repeating section
	 * @param function callback Optional callback function
	 *
	 * @return void
	 */
	function updateRowIdDisplay(section, rowId, callback) {

		// check for optional callback function
		callback = callback || noop;

		// initialize an object to hold fields to update.
		const items = {};

		// set the field value
		items[`${section}_${rowId}_row_id`] = rowId;
              
		// update the field values
		setAttrs(items, {silent: true}, callback);

	}

	// Update the total cost of Techniques
	on('change:repeating_techniques:points remove:repeating_techniques', function (e) {
		sumRepeating('repeating_techniques', 'points', function(v) {
			setAttrs({ techniques_points: v}, {silent: true} );
		});
	});

	// Update the total cost of Techniques revised
	on('change:repeating_techniquesrevised:points remove:repeating_techniquesrevised', function (e) {
		sumRepeating('repeating_techniquesrevised', 'points', function(v) {
			setAttrs({ techniques_revised_points: v}, {silent: true} );
		});
	});
	
	// Update the total cost of Spells
	on('change:repeating_spells:points remove:repeating_spells', function (e) {
		sumRepeating('repeating_spells', 'points', function(v) {
			setAttrs({ spells_points: v }, {silent: true});
		});
	});

	// Update the line total weight and cost
	on('change:repeating_item:count change:repeating_item:cost change:repeating_item:carried change:repeating_item:weight', function (e) {
		getAttrs(['repeating_item_count', 'repeating_item_cost', 'repeating_item_weight', 'repeating_item_carried'], function (item) {
			setAttrs({
				repeating_item_weighttotal: Number(Math.round(item.repeating_item_count * item.repeating_item_weight * item.repeating_item_carried * 1000) / 1000).toFixed(3),
				repeating_item_costtotal: Number(Math.round(item.repeating_item_count * item.repeating_item_cost * 100) / 100).toFixed(2)
			});
		});
	});

	// Update the total weight of all carried items.
	on('change:repeating_item:weighttotal remove:repeating_item', function (e) {
		sumRepeating('repeating_item', 'weighttotal', function(v) {
			setAttrs({ total_weight: Number(Math.round(v * 1000) / 1000).toFixed(3) });
		});
	});

	// Update the line Format for existing inventory weight and cost - Script provided by GiGs ID:157788 (Roll20)
	on('change:inventory_fixed_digits',function()  {

    // getSectionIDs gives an array of all the row ids.
    getSectionIDs('item', function (ids) {
        if (ids.length === 0) return;
        // need to get an array of all the attributes used in the repeating_items calculations, for getAttrs
        const fieldArray = [];
        ids.forEach(id => fieldArray.push(
            `repeating_item_${id}_count`, `repeating_item_${id}_cost`, `repeating_item_${id}_weight`, `repeating_item_${id}_carried`
        ));
        getAttrs(fieldArray, function (item) {
            const items = {}; // initialize an object to hold the total weights and costs.
            ids.forEach(id => {
                // for each row of the table, calculate the total weight and cost
                const weight = (+item[`repeating_item_${id}_count`]||0) * (+item[`repeating_item_${id}_weight`]||0) * (+item[`repeating_item_${id}_carried`]||0);
                const cost = (+item[`repeating_item_${id}_count`]||0) * (+item[`repeating_item_${id}_cost`]||0);
                // save the totals, in the correct format 
                items[`repeating_item_${id}_weighttotal`] = Number(Math.round(weight * 1000)/1000).toFixed(3);
                items[`repeating_item_${id}_costtotal`] = Number(Math.round(cost * 100)/100).toFixed(2);
				});
				setAttrs(items);
			});
		});
	});

	// Get Encumbrance Level:
	on('change:total_weight change:weight change:basic_lift change:gravity', function (e) {
		updateEncLevel();
	});

	// factor in gravity difference
	function updateEncLevel(callback) {

		getAttrs(['basic_lift', 'total_weight', 'gravity', 'weight'], function(v) {
			
			callback = callback || noop;
			
			let basicLift = Number(v.basic_lift);

			let totalWeight = Number(v.total_weight);

			let totalGravityWeight = totalWeight;

			let gravity = Number(v.gravity);

			let characterWeight = Number(v.weight);

			// don't factor in grand total weight
			let grandTotalWeight = characterWeight + totalWeight;

			// round to three decimal places
            grandTotalWeight =  Math.round( grandTotalWeight * 1000) / 1000;
            
            // remove trailing zeros
            grandTotalWeight = grandTotalWeight.toString(); 
            
            // make sure it's a number again
			grandTotalWeight = Number(grandTotalWeight);  
			
			if (gravity < 1 ) {

				totalGravityWeight = totalWeight * gravity;

				totalGravityWeight = Number(Math.round(totalGravityWeight * 1000) / 1000).toFixed(3)

			} else if (gravity > 1) {

				let gravityMod = (totalWeight + characterWeight) * (gravity - 1);

				totalGravityWeight = totalWeight + gravityMod;

				totalGravityWeight = Number(Math.round(totalGravityWeight * 1000) / 1000).toFixed(3)

			}
			
			var encumbranceLevel = Math.floor(totalGravityWeight / basicLift);
			
			if (encumbranceLevel > 0 && (totalGravityWeight % basicLift) === 0) {
				encumbranceLevel--;
			} 
			
			if (encumbranceLevel >= 10) {
				encumbranceLevel = 4;
			} else if (encumbranceLevel >= 6) {
				encumbranceLevel = 4;
			} else if (encumbranceLevel >= 3) {
				encumbranceLevel = 3;
			}

			setAttrs({ 
					encumbrance_level: encumbranceLevel,
					total_weight_gravity: totalGravityWeight,
					grand_total_weight: grandTotalWeight
				},
				{silent: false},
				callback
			);

		});
	}

	// Update the total cost of all items.
	on('change:repeating_item:costtotal remove:repeating_item', function (e) {
		sumRepeating('repeating_item', 'costtotal', function(v) {
			setAttrs({ total_value: Number((v * 100) / 100).toFixed(2) }, {silent: true});
		});
	});

	// Update thrust and swing when striking st is updated
	on('change:striking_st', function(e){

		updateStrikingStrengthDamage();
		
	});

	/**
	 * Get the striking ST value and then get the damage type
	 * update Thrust and Swing
	 */
	function updateStrikingStrengthDamage(callback) {
	    
		console.log("******** updateStrikingStrengthDamage ********");
		
		// get striking strength
		getAttrs(['striking_st'], function(values) {

			callback = callback || noop;

			// + means to convert variable to number
			var strikingST = +values.striking_st;

			// get the damageType object (strength, thrust, swing)
			var damageType = getDamageType(strikingST);

			// set thrust and swing
			setAttrs({ 
				thrust: damageType.thrust,
				swing: damageType.swing
			}, {silent: false}, callback);

		});

	}

	/**
	 * Returns the damage type object 
	 * based on ST
	 * damageType {strength, thrust, swing}
	 *
	 * @param int strikingST ST of attack
	 *
	 * @return object 
	 */
	function getDamageType(strikingST) {

		// return value
		var damageType = null;

		var modifier = 0;

		var baseThrust = 11;

		var baseSwing = 13;

		// prevent bad ST from causing issue
		if (isNaN(strikingST) || strikingST < 0) {
			strikingST = 1;
		}

		if (strikingST <= 100) {

			// get damageType from table
			damageType = damageTable[strikingST];

		} else {

			// calculate the total 
			// Add 1d6 to thrust and swing for every full 10 points over 100
			modifier = Math.floor((strikingST - 100) / 10);
			
			baseThrust = baseThrust + modifier;

			baseSwing = baseSwing + modifier;

			damageType = {strength:strikingST, thrust:baseThrust + "d6", swing:baseSwing + "d6"}; 

		}

		return damageType;
	} 

	/**
	 * Populates the global variable damageTable
	 */
	function generateDamageTable() {

		var damageTable = [];

		damageTable[0] = {strength:"0", thrust:"1d6-6", swing:"1d6-6"};
		damageTable[1] = {strength:"1", thrust:"1d6-6", swing:"1d6-5"};
		damageTable[2] = {strength:"2", thrust:"1d6-6", swing:"1d6-5"};
		damageTable[3] = {strength:"3", thrust:"1d6-5", swing:"1d6-4"};
		damageTable[4] = {strength:"4", thrust:"1d6-5", swing:"1d6-4"};
		damageTable[5] = {strength:"5", thrust:"1d6-4", swing:"1d6-3"};
		damageTable[6] = {strength:"6", thrust:"1d6-4", swing:"1d6-3"};
		damageTable[7] = {strength:"7", thrust:"1d6-3", swing:"1d6-2"};
		damageTable[8] = {strength:"8", thrust:"1d6-3", swing:"1d6-2"};
		damageTable[9] = {strength:"9", thrust:"1d6-2", swing:"1d6-1"};
		damageTable[10] = {strength:"10", thrust:"1d6-2", swing:"1d6"};
		damageTable[11] = {strength:"11", thrust:"1d6-1", swing:"1d6+1"};
		damageTable[12] = {strength:"12", thrust:"1d6-1", swing:"1d6+2"};
		damageTable[13] = {strength:"13", thrust:"1d6", swing:"2d6-1"};
		damageTable[14] = {strength:"14", thrust:"1d6", swing:"2d6"};
		damageTable[15] = {strength:"15", thrust:"1d6+1", swing:"2d6+1"};
		damageTable[16] = {strength:"16", thrust:"1d6+1", swing:"2d6+2"};
		damageTable[17] = {strength:"17", thrust:"1d6+2", swing:"3d6-1"};
		damageTable[18] = {strength:"18", thrust:"1d6+2", swing:"3d6"};
		damageTable[19] = {strength:"19", thrust:"2d6-1", swing:"3d6+1"};
		damageTable[20] = {strength:"20", thrust:"2d6-1", swing:"3d6+2"};
		damageTable[21] = {strength:"21", thrust:"2d6", swing:"4d6-1"};
		damageTable[22] = {strength:"22", thrust:"2d6", swing:"4d6"};
		damageTable[23] = {strength:"23", thrust:"2d6+1", swing:"4d6+1"};
		damageTable[24] = {strength:"24", thrust:"2d6+1", swing:"4d6+2"};
		damageTable[25] = {strength:"25", thrust:"2d6+2", swing:"5d6-1"};
		damageTable[26] = {strength:"26", thrust:"2d6+2", swing:"5d6"};
		damageTable[27] = {strength:"27", thrust:"3d6-1", swing:"5d6+1"};
		damageTable[28] = {strength:"28", thrust:"3d6-1", swing:"5d6+1"};
		damageTable[29] = {strength:"29", thrust:"3d6", swing:"5d6+2"};
		damageTable[30] = {strength:"30", thrust:"3d6", swing:"5d6+2"};
		damageTable[31] = {strength:"31", thrust:"3d6+1", swing:"6d6-1"};
		damageTable[32] = {strength:"32", thrust:"3d6+1", swing:"6d6-1"};
		damageTable[33] = {strength:"33", thrust:"3d6+2", swing:"6d6"};
		damageTable[34] = {strength:"34", thrust:"3d6+2", swing:"6d6"};
		damageTable[35] = {strength:"35", thrust:"4d6-1", swing:"6d6+1"};
		damageTable[36] = {strength:"36", thrust:"4d6-1", swing:"6d6+1"};
		damageTable[37] = {strength:"37", thrust:"4d6", swing:"6d6+2"};
		damageTable[38] = {strength:"38", thrust:"4d6", swing:"6d6+2"};
		damageTable[39] = {strength:"39", thrust:"4d6+1", swing:"7d6-1"};
		damageTable[40] = {strength:"40", thrust:"4d6+1", swing:"7d6-1"};
		damageTable[41] = {strength:"41", thrust:"4d6+1", swing:"7d6-1"};
		damageTable[42] = {strength:"42", thrust:"4d6+1", swing:"7d6-1"};
		damageTable[43] = {strength:"43", thrust:"4d6+1", swing:"7d6-1"};
		damageTable[44] = {strength:"44", thrust:"4d6+1", swing:"7d6-1"};
		damageTable[45] = {strength:"45", thrust:"5d6", swing:"7d6+1"};
		damageTable[46] = {strength:"46", thrust:"5d6", swing:"7d6+1"};
		damageTable[47] = {strength:"47", thrust:"5d6", swing:"7d6+1"};
		damageTable[48] = {strength:"48", thrust:"5d6", swing:"7d6+1"};
		damageTable[49] = {strength:"49", thrust:"5d6", swing:"7d6+1"};
		damageTable[50] = {strength:"50", thrust:"5d6+2", swing:"8d6-1"};
		damageTable[51] = {strength:"51", thrust:"5d6+2", swing:"8d6-1"};
		damageTable[52] = {strength:"52", thrust:"5d6+2", swing:"8d6-1"};
		damageTable[53] = {strength:"53", thrust:"5d6+2", swing:"8d6-1"};
		damageTable[54] = {strength:"54", thrust:"5d6+2", swing:"8d6-1"};
		damageTable[55] = {strength:"55", thrust:"6d6", swing:"8d6+1"};	
		damageTable[56] = {strength:"56", thrust:"6d6", swing:"8d6+1"};	
		damageTable[57] = {strength:"57", thrust:"6d6", swing:"8d6+1"};	
		damageTable[58] = {strength:"58", thrust:"6d6", swing:"8d6+1"};	
		damageTable[59] = {strength:"59", thrust:"6d6", swing:"8d6+1"};	
		damageTable[60] = {strength:"60", thrust:"7d6-1", swing:"9d6"};	
		damageTable[61] = {strength:"61", thrust:"7d6-1", swing:"9d6"};	
		damageTable[62] = {strength:"62", thrust:"7d6-1", swing:"9d6"};	
		damageTable[63] = {strength:"63", thrust:"7d6-1", swing:"9d6"};	
		damageTable[64] = {strength:"64", thrust:"7d6-1", swing:"9d6"};	
		damageTable[65] = {strength:"65", thrust:"7d6+1", swing:"9d6+2"};	
		damageTable[66] = {strength:"66", thrust:"7d6+1", swing:"9d6+2"};	
		damageTable[67] = {strength:"67", thrust:"7d6+1", swing:"9d6+2"};	
		damageTable[68] = {strength:"68", thrust:"7d6+1", swing:"9d6+2"};	
		damageTable[69] = {strength:"69", thrust:"7d6+1", swing:"9d6+2"};	
		damageTable[70] = {strength:"70", thrust:"8d6", swing:"10d6"};	
		damageTable[71] = {strength:"71", thrust:"8d6", swing:"10d6"};	
		damageTable[72] = {strength:"72", thrust:"8d6", swing:"10d6"};	
		damageTable[73] = {strength:"73", thrust:"8d6", swing:"10d6"};	
		damageTable[74] = {strength:"74", thrust:"8d6", swing:"10d6"};	
		damageTable[75] = {strength:"75", thrust:"8d6+2", swing:"10d6+2"};
		damageTable[76] = {strength:"76", thrust:"8d6+2", swing:"10d6+2"};
		damageTable[77] = {strength:"77", thrust:"8d6+2", swing:"10d6+2"};
		damageTable[78] = {strength:"78", thrust:"8d6+2", swing:"10d6+2"};
		damageTable[79] = {strength:"79", thrust:"8d6+2", swing:"10d6+2"};
		damageTable[80] = {strength:"80", thrust:"9d6", swing:"11d6"};
		damageTable[81] = {strength:"81", thrust:"9d6", swing:"11d6"};
		damageTable[82] = {strength:"82", thrust:"9d6", swing:"11d6"};
		damageTable[83] = {strength:"83", thrust:"9d6", swing:"11d6"};
		damageTable[84] = {strength:"84", thrust:"9d6", swing:"11d6"};
		damageTable[85] = {strength:"85", thrust:"9d6+2", swing:"11d6+2"};
		damageTable[86] = {strength:"86", thrust:"9d6+2", swing:"11d6+2"};
		damageTable[87] = {strength:"87", thrust:"9d6+2", swing:"11d6+2"};
		damageTable[88] = {strength:"88", thrust:"9d6+2", swing:"11d6+2"};
		damageTable[89] = {strength:"89", thrust:"9d6+2", swing:"11d6+2"};
		damageTable[90] = {strength:"90", thrust:"10d6", swing:"12d6"};
		damageTable[91] = {strength:"91", thrust:"10d6", swing:"12d6"};
		damageTable[92] = {strength:"92", thrust:"10d6", swing:"12d6"};
		damageTable[93] = {strength:"93", thrust:"10d6", swing:"12d6"};
		damageTable[94] = {strength:"94", thrust:"10d6", swing:"12d6"};
		damageTable[95] = {strength:"95", thrust:"10d6+2", swing:"12d6+2"};
		damageTable[96] = {strength:"96", thrust:"10d6+2", swing:"12d6+2"};
		damageTable[97] = {strength:"97", thrust:"10d6+2", swing:"12d6+2"};
		damageTable[98] = {strength:"98", thrust:"10d6+2", swing:"12d6+2"};
		damageTable[99] = {strength:"99", thrust:"10d6+2", swing:"12d6+2"};
		damageTable[100] = {strength:"100", thrust:"11d6", swing:"13d6"};

		return damageTable;

	}
	
	// check for combat reflexes toggle box
	on('change:combat_reflexes', function(e){

        updateActiveDefenses();

	});

	/**
	* Get combat reflexes. Update active defenses
	*/
	function updateActiveDefenses(callback) {

		// get the defense values
		getAttrs(['combat_reflexes', 'dodge_mod', 'fear_check_mod'], function(values) {

			callback = callback || noop;

			// + means to convert variable to number
			let chkCombatReflexes = Number(values.combat_reflexes);

			let modDodge = 0;

			let modFear = 0;

			if (chkCombatReflexes == 1) {
				
				modDodge = 1;

				modFear = 2;

			} else {
				
				modDodge = -1;

				modFear = -2;

			}

			// update dodge modifier
			let orig_dodge_mod = Number(values.dodge_mod);

			if (isNaN(orig_dodge_mod)) {
				orig_dodge_mod = 0;
			} 

			let new_dodge_mod = orig_dodge_mod +  modDodge;

			// update fear check
			let orig_fear_check_mod = Number(values.fear_check_mod);

			if (isNaN(orig_fear_check_mod)) {
				orig_fear_check_mod = 0;
			} 

			let new_fear_check_mod = orig_fear_check_mod + modFear;

			// update 

			// set thrust and swing
			setAttrs({ 
				dodge_mod: new_dodge_mod,
				fear_check_mod: new_fear_check_mod
			});

		});

	}

    // check for manual or calculated option
	on("change:use_unspent_box", function (e) {
	    
	    updateToggleUnspentCheckBox();
	    
	});

    /**
     * Updates the hidden toggle_unspent_points. Used by 
     * css to show/hide unspent boxes
     * see: gurps.css -> input.toggle-unspoint-points[value="1"]
     * 
     */
    function updateToggleUnspentCheckBox() {
        
        getAttrs(['use_unspent_box'], function(values) {

		    setAttrs({ 
				toggle_unspent_points: values.use_unspent_box
			});
			
		});
        
    }
    
    // check for selected damage dice change
    on("change:damage_dice_type", function (e) {
        
        updateDiceDamageIcons();
        
    });
    
    /**
     * Controller function to update each section of 
     * damage dice icons
     */
    function updateDiceDamageIcons() {
        
        updateThrustSwingDamageIcons();
        
        updateRepeatingDamageDice("repeating_melee");
        
        updateRepeatingDamageDice("repeating_ranged");
        
    }
    
    /**
     * Update the Thrust and Swing Damage Icons
     * on the general tab by setting the hidden inputs
     */
    function updateThrustSwingDamageIcons() {
        
        getAttrs(['damage_dice_type'], function(values) {
         
            setAttrs({ 
				thrust_damage_dice_icon: values.damage_dice_type,
				swing_damage_dice_icon: values.damage_dice_type
			});
            
        });
        
    }
    
    /**
     * Gets the repeating sections ids. loop through 
     * each id, must use getAttrs() inside the loop, 
     * then set the hidden input for dice damage icon
     * 
     * @param string sectionID Repeating section id
     */
    function updateRepeatingDamageDice(sectionID) {
        
        // get all the ids for each repeating section
        getSectionIDs(sectionID, function (ids) {
                
            // loop though each ids using underscores
            // see: https://underscorejs.org/#each 
            _.each(ids,function(id) {
                
                getAttrs(['damage_dice_type'], function(values) {
         
                    // set the hidden input attribute
                    setAttrs({
                        [sectionID + "_" + id + "_damage_dice_icon"]: values.damage_dice_type
                    });
                    
                });
                
            });
                
        });
        
    }
    
    // check to see if ground move mod or move points changed
    on("change:enhanced_ground_move_mod change:enhanced_ground_move_points change:basic_move change:encumbrance_level change:hit_points change:fatigue_points", function(e) {
        
        updateEnhancedMove();
        
    });
    
    /**
     * Get the attributes for enhanced ground move modifier and points spent
     * Update the fields for ground multiple and ground move based on mod and points
     */
    function updateEnhancedMove() {
        
        console.log('***** UPDATE ENHANCED MOVE *****');
		    
        getAttrs(["enhanced_ground_move_mod", "enhanced_ground_move_points", "basic_move", "encumbrance_level", "hit_points", "hit_points_max", "fatigue_points", "fatigue_points_max"], function(values) {

            // + sign converts value to a number
            var groundModifier = +values.enhanced_ground_move_mod;
            
            var groundPoints = +values.enhanced_ground_move_points;
            
            var groundModifierFromPoints = 0;
            
            var totalModifier = 0;
            
            var basicMove = +values.basic_move;
            
            var enhancedMove = 0;
            
            // encumbrance levels
            var enhancedMove0 = "";
            
            var enhancedMove1 = "";
            
            var enhancedMove2 = "";
            
            var enhancedMove3 = "";
            
            var enhancedMove4 = "";
            
            var enhancedMove5 = "";
            
            var encumberedEnhancedMove1 = 0;
            
            var encumberedEnhancedMove2 = 0;
            
            var encumberedEnhancedMove3 = 0; 
            
            var encumberedEnhancedMove4 = 0; 
            
            // current speed based on encumbrance and pain/fatigue
            var currentEnhancedMove = "";
            
			var injuryFatigueMoveModifier = 1;
			
			let step = 0;

			let baseGroundMove = 0;
            
            // validate groundModifer
            if (groundModifier < 0) {
                groundModifier = 0;
            }
            
            // make sure groundModifier is multiple of .5
            // https://stackoverflow.com/questions/25209849/javascript-round-up-to-nearest-5 
            groundModifier = Math.ceil(groundModifier * 2) / 2;
            
            // validate groundPoints
            if (groundPoints < 0) {
                groundPoints = 0;
            }
            
            // make sure groundPoints is multiple of 10
            // https://stackoverflow.com/questions/18953384/javascript-round-up-to-the-next-multiple-of-5 
            groundPoints = Math.ceil(groundPoints / 10) * 10;
            
            groundModifierFromPoints = groundPoints / 20;
            
            totalModifier = groundModifier + groundModifierFromPoints;
            
            enhancedMove = getEnhancedValue(basicMove, totalModifier);
            
            if (totalModifier == 0) {
                
                enhancedMove0 = "";
            
                enhancedMove1 = "";
                
                enhancedMove2 = "";
                
                enhancedMove3 = "";
                
                enhancedMove4 = "";
                
                enhancedMove5 = "";
                
                currentBasicMove = "";
                
                currentEnhancedMove = "";
                
            } else {
            
                enhancedMove0 = basicMove + "/" + enhancedMove;
                
                move1 = getEncumberedMove(basicMove, 1);
                encumberedEnhancedMove1 = getEncumberedMove(enhancedMove, 1);
                enhancedMove1 = move1 + "/" + encumberedEnhancedMove1;
                
                move2 = getEncumberedMove(basicMove, 2);
                encumberedEnhancedMove2 = getEncumberedMove(enhancedMove, 2);
                enhancedMove2 = move2 + "/" + encumberedEnhancedMove2;
                
                move3 = getEncumberedMove(basicMove, 3);
                encumberedEnhancedMove3 = getEncumberedMove(enhancedMove, 3);
                enhancedMove3 = move3 + "/" + encumberedEnhancedMove3;
                    
                move4 = getEncumberedMove(basicMove, 4);
                encumberedEnhancedMove4 = getEncumberedMove(enhancedMove, 4);
                enhancedMove4 = move4 + "/" + encumberedEnhancedMove4;
                
                enhancedMove5 = enhancedMove4;
                
                // check for half move
                injuryFatigueMoveModifier = getInjuryFatigueModifier(values.hit_points, values.hit_points_max, values.fatigue_points, values.fatigue_points_max);
                
                // determine the current encumbrance move
                switch(Number(values.encumbrance_level)) {
                    
					case 0:
						baseGroundMove = Math.floor(+basicMove * injuryFatigueMoveModifier);
						step = Math.ceil(baseGroundMove/10)
                        currentEnhancedMove = baseGroundMove + "/" + Math.floor(+enhancedMove * injuryFatigueMoveModifier);
                        break;
                        
                    case 1:
						baseGroundMove = Math.floor(+move1 * injuryFatigueMoveModifier);
						step = Math.ceil(baseGroundMove/10)
						currentEnhancedMove = baseGroundMove + "/" + Math.floor(+encumberedEnhancedMove1 * injuryFatigueMoveModifier);
                        break;
                        
                    case 2:
						baseGroundMove = Math.floor(+move2 * injuryFatigueMoveModifier);
						step = Math.ceil(baseGroundMove/10)
						currentEnhancedMove = baseGroundMove + "/" + Math.floor(+encumberedEnhancedMove2 * injuryFatigueMoveModifier);
                        break;
                        
                    case 3:
						baseGroundMove = Math.floor(+move3 * injuryFatigueMoveModifier);
						step = Math.ceil(baseGroundMove/10)
						currentEnhancedMove = baseGroundMove + "/" + Math.floor(+encumberedEnhancedMove3 * injuryFatigueMoveModifier);
                        break;
                        
                    case 4:
                    case 5:
                    default:
						baseGroundMove = Math.floor(+move4 * injuryFatigueMoveModifier);
						step = Math.ceil(baseGroundMove/10)
						currentEnhancedMove = baseGroundMove + "/" + Math.floor(+encumberedEnhancedMove4 * injuryFatigueMoveModifier);
                        break;
                    
				}
				
				currentEnhancedMove = `${currentEnhancedMove} (${step})`;
                
            }
            
            // set values and making sure modifiers are correct multiples
            setAttrs({
                "enhanced_ground_move_mod": groundModifier, 
                "enhanced_ground_move_points": groundPoints,
                "enhanced_ground_move_multiple": totalModifier,
                "enhanced_ground_move": enhancedMove,
                "enhanced_move_0": enhancedMove0,
                "enhanced_move_1": enhancedMove1,
                "enhanced_move_2": enhancedMove2,
                "enhanced_move_3": enhancedMove3,
                "enhanced_move_4": enhancedMove4,
                "enhanced_move_5": enhancedMove5,
                "enhanced_move_current": currentEnhancedMove
            });

			
		});
        
    }
    
    /**
     * Calculates move based on encumbrance level
     * encumbrance level 1-4. 5 is the same as 4, just costs fatigue
     * 
     * @param int    basicMove Starting basic move
     * @param string encumbranceLevel Encumbrance level 1-4
     * 
     * @return int
     */
    function getEncumberedMove(basicMove, encumbranceLevel) {
        
        var newMove = 0;
        
        var encumbranceModifier = 0;
        
        // make sure we have a good value
        if (encumbranceLevel < 1) {
            encumbranceLevel = 1;    
        } else if (encumbranceLevel > 4) {
            encumbranceLevel = 4;
        }
        
        encumbranceModifier = 1 - ((encumbranceLevel*2)/10);
        
        // fix floating point bug
        // see: https://stackoverflow.com/questions/11832914/round-to-at-most-2-decimal-places-only-if-necessary
        encumbranceModifier = Math.round(encumbranceModifier * 100) / 100; 
        
        newMove = Math.floor(basicMove * encumbranceModifier);
        
        // minimum move is 1
        if (newMove <= 0) {
            newMove = 1;
        }
        
        return newMove;
        
    }
    
    /**
     * Calculate the enhanced value for multiples of 2. 
     * If .5 value, then multiply by 1.5
     * see GURPS Basic Set, page 52 enhanced move
     * 
     * @param int     baseValue Value to multiply
     * @param decimal level     Level of enhanced move to apply to baseValue
     * 
     * @return int
     */
    function getEnhancedValue(baseValue, level) {
        
        var enhancedValue = 0;
        
        // check for formula to use
        if (level == 0) {
            
            enhancedValue = 0;
            
        } else if (level % 1 == 0) {
        
            // if no remainder, use this formula
            enhancedValue = baseValue * Math.pow(2, level);
            
        } else {
            
            // if there is a remainder, use this formula
            // remove the .5 and then multiply by 1.5
            enhancedValue = (baseValue * Math.pow(2, Math.floor(level))) * 1.5;
            
            enhancedValue = Math.floor(enhancedValue);
            
        }
        return enhancedValue;
            
    }
    
    /**
     * Checks for 1/3 HP and 1/3 FP. 
     * Apply move modifies
     * 
     * @param int hit_points         Current hit points of character
     * @param int hit_points_max     Max HP of character
     * @param int fatigue_points     Current FP of character
     * @param int fatigue_points_max Max FP of character
     * 
     * @return decimal
     */
    function getInjuryFatigueModifier(hit_points, hit_points_max, fatigue_points, fatigue_points_max) {
        
        var modifier = 1;
        
        if (+hit_points < +hit_points_max / 3) {
				
			modifier = modifier / 2;
			
		}
		
		if (+fatigue_points < +fatigue_points_max / 3 ) {
			
			modifier = modifier / 2;
			
		}
			
        return modifier;
        
    } 
    
    // check for changes that affect flight speed
    on("change:flight_checked change:basic_speed change:basic_air_move_points change:basic_air_move_mod change:enhanced_air_level change:enhanced_air_move_points change:encumbrance_level change:hit_points change:fatigue_points", function(e) {
        
        updateFlightValues();
        
    });
    
    /**
     * Update flight values, including encumbered and current speed
     * 
     * @return void
     */
    function updateFlightValues() {
        
        console.log('***** UPDATE FLIGHT VALUES *****');
		    
        getAttrs(["flight_checked", "basic_speed", "enhanced_air_level", "basic_air_move", "basic_air_move_mod", 
                  "basic_air_move_points", "enhanced_air_level", "enhanced_air_move_points", 
                  "encumbrance_level", "hit_points", "hit_points_max", "fatigue_points", "fatigue_points_max"], function(values) {
            
            // + sign converts value to a number
            var airMovePoints = +values.basic_air_move_points;
            
            var basicAirMoveMod = +values.basic_air_move_mod;
            
            var airMoveUnmodified = 0;
            
			var airMove = 0;
			
			let baseAirMove = 0;
            
            var airModifierFromPoints = 0;
            
            var baseEnhancedAirMove = "";
            
            var enhancedAirLevel = 0;
            
            var enhancedEnteredLevel = +values.enhanced_air_level;
            
            var encumberedDisplayMove0 = "";
            
            var encumberedDisplayMove1 = "";
            
            var encumberedDisplayMove2 = "";
            
            var encumberedDisplayMove3 = "";
            
            var encumberedDisplayMove4 = "";
            
            var encumberedDisplayMove5 = "";
            
            var currentAirMove = "";
            
            // ensure valid enhancedEnteredLevel
            if (enhancedEnteredLevel < 0) {
                enhancedEnteredLevel = 0;
            }    
            
            var enhancedEnteredPoints = +values.enhanced_air_move_points;
            
            // ensure valid enhancedEnteredPoints
            if (enhancedEnteredPoints < 0) {
                enhancedEnteredPoints = 0;
            }
            
            var enhancedAirLevelFromPoints = 0;
            
            var totalEnhancedLevel = 0;
            
            var injuryFatigueMoveModifier = 1;
            
            // if flight is checked, calculate the values
            if (values.flight_checked == 1) {
                
                //----------------
                // calculate air move
                airMoveUnmodified = Math.floor(+values.basic_speed * 2);
                
                // base is basis_speed * 2
                airMove = Math.floor(+values.basic_speed * 2);
                
                // add air move modifier
                airMove = airMove + basicAirMoveMod;
                
                // make sure airMovePoints is multiple of 2
                // https://stackoverflow.com/questions/18953384/javascript-round-up-to-the-next-multiple-of-5 
                airMovePoints = Math.ceil(airMovePoints / 2) * 2;    
                
                airModifierFromPoints = airMovePoints/2;
                
                // add in the air move from spent points
                airMove = airMove + airModifierFromPoints;
                
                //-----------------
                // calculate top air speed
                // make sure groundPoints is multiple of 10
                // https://stackoverflow.com/questions/18953384/javascript-round-up-to-the-next-multiple-of-5 
                enhancedEnteredPoints = Math.ceil(enhancedEnteredPoints / 10) * 10;
                
                enhancedAirLevelFromPoints = enhancedEnteredPoints / 20;
                
                // make sure enhancedEnteredLevel is multiple of .5
                // https://stackoverflow.com/questions/25209849/javascript-round-up-to-nearest-5 
                enhancedEnteredLevel = Math.ceil(enhancedEnteredLevel * 2) / 2;
                
                totalEnhancedLevel = enhancedEnteredLevel + enhancedAirLevelFromPoints;
                
                baseEnhancedAirMove = getEnhancedValue(airMove, totalEnhancedLevel);
                
                // get the encumbered levels
                if (baseEnhancedAirMove > 0) {
                
                    // show the enhanced move
                    encumberedDisplayMove0 = airMove + "/" + baseEnhancedAirMove;
                
                    encumberedDisplayMove1 = getEncumberedMove(airMove, 1) + "/" + getEncumberedMove(baseEnhancedAirMove, 1);
                    
                    encumberedDisplayMove2 = getEncumberedMove(airMove, 2) + "/" + getEncumberedMove(baseEnhancedAirMove, 2);
                    
                    encumberedDisplayMove3 = getEncumberedMove(airMove, 3) + "/" + getEncumberedMove(baseEnhancedAirMove, 3);
                    
                    encumberedDisplayMove4 = getEncumberedMove(airMove, 4) + "/" + getEncumberedMove(baseEnhancedAirMove, 4);
                    
                    encumberedDisplayMove5 = encumberedDisplayMove4;
                        
                } else {
                    
                    // don't need the enhanced move
                    encumberedDisplayMove0 = airMove;
                
                    encumberedDisplayMove1 = getEncumberedMove(airMove, 1);
                    
                    encumberedDisplayMove2 = getEncumberedMove(airMove, 2);
                    
                    encumberedDisplayMove3 = getEncumberedMove(airMove, 3);
                    
                    encumberedDisplayMove4 = getEncumberedMove(airMove, 4);
                    
                    encumberedDisplayMove5 = encumberedDisplayMove4;
                
                }
                
                // check for half move
                injuryFatigueMoveModifier = getInjuryFatigueModifier(values.hit_points, values.hit_points_max, values.fatigue_points, values.fatigue_points_max);
                
                // determine the current encumbrance move
                switch(Number(values.encumbrance_level)) {
                    
                    case 0:
						currentAirMove = (airMove * injuryFatigueMoveModifier);
						
						baseAirMove = (airMove * injuryFatigueMoveModifier);
                        
                        if (baseEnhancedAirMove > 0) {
                            
                            currentAirMove = currentAirMove + "/" + (baseEnhancedAirMove * injuryFatigueMoveModifier);
                        }
                        
                        break;
                        
                    case 1:
                        
						currentAirMove = (getEncumberedMove(airMove, 1) * injuryFatigueMoveModifier);
						
						baseAirMove = (getEncumberedMove(airMove, 1) * injuryFatigueMoveModifier);
                        
                        if (baseEnhancedAirMove > 0) {
                            
                            currentAirMove = currentAirMove + "/" + (getEncumberedMove(baseEnhancedAirMove, 1) * injuryFatigueMoveModifier);
                        }
                        
                        break;
                        
                    case 2:
                        
						currentAirMove = (getEncumberedMove(airMove, 2) * injuryFatigueMoveModifier);
						
						baseAirMove = (getEncumberedMove(airMove, 2) * injuryFatigueMoveModifier);
                        
                        if (baseEnhancedAirMove > 0) {
                            
                            currentAirMove = currentAirMove + "/" + (getEncumberedMove(baseEnhancedAirMove, 2) * injuryFatigueMoveModifier);
                        }
                        
                        break;
                        
                    case 3:
                        
						currentAirMove = (getEncumberedMove(airMove, 3) * injuryFatigueMoveModifier);
						
						baseAirMove = (getEncumberedMove(airMove, 3) * injuryFatigueMoveModifier);
                        
                        if (baseEnhancedAirMove > 0) {
                            
                            currentAirMove = currentAirMove + "/" + (getEncumberedMove(baseEnhancedAirMove, 3) * injuryFatigueMoveModifier);
                        }
                        
                        break;
                        
                    case 4:
                    case 5:
                    default:
                        
						currentAirMove = (getEncumberedMove(airMove, 4) * injuryFatigueMoveModifier);
						
						baseAirMove = (getEncumberedMove(airMove, 4) * injuryFatigueMoveModifier);
                        
                        if (baseEnhancedAirMove > 0) {
                            
                            currentAirMove = currentAirMove + "/" + (getEncumberedMove(baseEnhancedAirMove, 4) * injuryFatigueMoveModifier);
                        }
                        
                        break;
                    
                }
                        

            } else {
                
                airMove = 0;
				
				baseAirMove = 0;

                baseEnhancedAirMove = 0;
                
				currentAirMove = 0;
				
			}
			
			let step = Math.ceil(baseAirMove/10);
            
            // set air moves
            setAttrs({
                "basic_air_move": airMove, 
                "basic_air_move_unmodified": airMoveUnmodified, 
                "enhanced_air_move": baseEnhancedAirMove,
                "enhanced_air_move_level": totalEnhancedLevel,
                "basic_air_move_points": airMovePoints,
                "enhanced_air_move_points": enhancedEnteredPoints,
                "air_0": encumberedDisplayMove0,
                "air_1": encumberedDisplayMove1,
                "air_2": encumberedDisplayMove2,
                "air_3": encumberedDisplayMove3,
                "air_4": encumberedDisplayMove4,
                "air_5": encumberedDisplayMove5,
				"current_air": `${currentAirMove} (${step})`,
				"current_air_step": step
            });
                
            
        });
        
    }
    
    // check for changes that affect water speed
    on("change:amphibious_checked change:basic_move change:basic_water_move_points change:basic_water_move_mod change:enhanced_water_level change:enhanced_water_move_points change:encumbrance_level change:hit_points change:fatigue_points", function(e) {
        
        updateWaterMoveValues();
        
    });
    
    /**
     * Update water move values, including encumbered and current speed
     * 
     * @return void
     */
    function updateWaterMoveValues() {
        
        console.log('***** UPDATE WATER MOVE VALUES *****');
		    
        getAttrs(["amphibious_checked", "basic_move", "enhanced_water_level", "basic_water_move", "basic_water_move_mod", 
                  "basic_water_move_points", "enhanced_water_level", "enhanced_water_move_points", 
                  "encumbrance_level", "hit_points", "hit_points_max", "fatigue_points", "fatigue_points_max"], function(values) {
            
            // + sign converts value to a number
            var waterMovePoints = +values.basic_water_move_points;
            
            var basicWaterMoveMod = +values.basic_water_move_mod;
            
            var waterMoveUnmodified = 0;
            
			var waterMove = 0;
			
			let baseWaterMove = 0;
            
            var waterModifierFromPoints = 0;
            
            var baseEnhancedWaterMove = "";
            
            var enhancedWaterLevel = 0;
            
            var enhancedEnteredLevel = +values.enhanced_water_level;
            
            var encumberedDisplayMove0 = "";
            
            var encumberedDisplayMove1 = "";
            
            var encumberedDisplayMove2 = "";
            
            var encumberedDisplayMove3 = "";
            
            var encumberedDisplayMove4 = "";
            
            var encumberedDisplayMove5 = "";
            
            var currentWaterMove = "";
            
            // ensure valid enhancedEnteredLevel
            if (enhancedEnteredLevel < 0) {
                enhancedEnteredLevel = 0;
            }    
            
            var enhancedEnteredPoints = +values.enhanced_water_move_points;
            
            // ensure valid enhancedEnteredPoints
            if (enhancedEnteredPoints < 0) {
                enhancedEnteredPoints = 0;
            }
            
            var enhancedWaterLevelFromPoints = 0;
            
            var totalEnhancedLevel = 0;
            
            var injuryFatigueMoveModifier = 1;
            
            // if flight is checked, calculate the values
            if (values.amphibious_checked == 1 && (enhancedEnteredPoints > 0 || enhancedEnteredLevel > 0)) {
                
                //----------------
                // calculate water move
                waterMoveUnmodified = +values.basic_move;
                
                // determine move
                if (values.amphibious_checked == 1) {
                    // base is basis_move
                    waterMove = +values.basic_move;    
                    
                } else {
                
                    // base is basis_move / 5
                    waterMove = +values.basic_move / 5;    
                }
                
                // add water move modifier
                waterMove = waterMove + basicWaterMoveMod;
                
                // make sure waterMovePoints is multiple of 5
                // https://stackoverflow.com/questions/18953384/javascript-round-up-to-the-next-multiple-of-5 
                waterMovePoints = Math.ceil(waterMovePoints / 5) * 5;    
                
                waterModifierFromPoints = waterMovePoints/5;
                
                // add in the water move from spent points
                waterMove = waterMove + waterModifierFromPoints;
                
                waterMove = Math.floor(waterMove);
                
                // make sure it's a minimum of 1.
                if (waterMove <= 0) {
                    waterMove = 1;
                }
                
                //-----------------
                // calculate top water speed
                // make sure groundPoints is multiple of 10
                // https://stackoverflow.com/questions/18953384/javascript-round-up-to-the-next-multiple-of-5 
                enhancedEnteredPoints = Math.ceil(enhancedEnteredPoints / 10) * 10;
                
                enhancedWaterLevelFromPoints = enhancedEnteredPoints / 20;
                
                // make sure enhancedEnteredLevel is multiple of .5
                // https://stackoverflow.com/questions/25209849/javascript-round-up-to-nearest-5 
                enhancedEnteredLevel = Math.ceil(enhancedEnteredLevel * 2) / 2;
                
                totalEnhancedLevel = enhancedEnteredLevel + enhancedWaterLevelFromPoints;
                
                baseEnhancedWaterMove = getEnhancedValue(waterMove, totalEnhancedLevel);
                
                // get the encumbered levels
                encumberedDisplayMove0 = waterMove + "/" + baseEnhancedWaterMove;
                
                encumberedDisplayMove1 = getEncumberedMove(waterMove, 1) + "/" + getEncumberedMove(baseEnhancedWaterMove, 1);
                
                encumberedDisplayMove2 = getEncumberedMove(waterMove, 2) + "/" + getEncumberedMove(baseEnhancedWaterMove, 2);
                
                encumberedDisplayMove3 = getEncumberedMove(waterMove, 3) + "/" + getEncumberedMove(baseEnhancedWaterMove, 3);
                
                encumberedDisplayMove4 = getEncumberedMove(waterMove, 4) + "/" + getEncumberedMove(baseEnhancedWaterMove, 4);
                
                encumberedDisplayMove5 = encumberedDisplayMove4;
                
                // check for half move
                injuryFatigueMoveModifier = getInjuryFatigueModifier(values.hit_points, values.hit_points_max, values.fatigue_points, values.fatigue_points_max);
                
                // determine the current encumbrance move
                switch(Number(values.encumbrance_level)) {
                    
                    case 0:
						currentWaterMove = (waterMove * injuryFatigueMoveModifier) + "/" + (baseEnhancedWaterMove * injuryFatigueMoveModifier);
						baseWaterMove = (waterMove * injuryFatigueMoveModifier);
                        break;
                        
                    case 1:
						currentWaterMove = (getEncumberedMove(waterMove, 1) * injuryFatigueMoveModifier) + "/" + (getEncumberedMove(baseEnhancedWaterMove, 1) * injuryFatigueMoveModifier);
						baseWaterMove = (getEncumberedMove(waterMove, 1) * injuryFatigueMoveModifier);
                        break;
                        
                    case 2:
						currentWaterMove = (getEncumberedMove(waterMove, 2) * injuryFatigueMoveModifier) + "/" + (getEncumberedMove(baseEnhancedWaterMove, 2) * injuryFatigueMoveModifier);
						baseWaterMove = (getEncumberedMove(waterMove, 2) * injuryFatigueMoveModifier);
                        break;
                        
                    case 3:
						currentWaterMove = (getEncumberedMove(waterMove, 3) * injuryFatigueMoveModifier) + "/" + (getEncumberedMove(baseEnhancedWaterMove, 3) * injuryFatigueMoveModifier);
						baseWaterMove = (getEncumberedMove(waterMove, 3) * injuryFatigueMoveModifier);
                        break;
                        
                    case 4:
                    case 5:
                    default:
						currentWaterMove = (getEncumberedMove(waterMove, 4) * injuryFatigueMoveModifier) + "/" + (getEncumberedMove(baseEnhancedWaterMove, 4) * injuryFatigueMoveModifier);
						baseWaterMove = (getEncumberedMove(waterMove, 4) * injuryFatigueMoveModifier);
                        break;
                    
                }

            } else {
                
                //----------------
                // calculate water move
                waterMoveUnmodified = +values.basic_move;
                
                // determine move
                if (values.amphibious_checked == 1) {
                    // base is basis_move
                    waterMove = +values.basic_move;    
                    
                } else {
                
                    // base is basis_move / 5
                    waterMove = +values.basic_move / 5;    
                }
                
                // add water move modifier
                waterMove = waterMove + basicWaterMoveMod;
                
                waterMove = Math.floor(waterMove);
                
                // make sure it's a minimum of 1.
                if (waterMove <= 0) {
                    waterMove = 1;
                }
                
                // make sure waterMovePoints is multiple of 5
                // https://stackoverflow.com/questions/18953384/javascript-round-up-to-the-next-multiple-of-5 
                waterMovePoints = Math.ceil(waterMovePoints / 5) * 5;    
                
                waterModifierFromPoints = waterMovePoints/5;
                
                // add in the water move from spent points
                waterMove = waterMove + waterModifierFromPoints;
                
                baseEnhancedWaterMove = 0;
                
                currentWaterMove = 0;
                
                // get the encumbered levels
                encumberedDisplayMove0 = waterMove;
                
                encumberedDisplayMove1 = getEncumberedMove(waterMove, 1);
                
                encumberedDisplayMove2 = getEncumberedMove(waterMove, 2);
                
                encumberedDisplayMove3 = getEncumberedMove(waterMove, 3);
                
                encumberedDisplayMove4 = getEncumberedMove(waterMove, 4);
                
                encumberedDisplayMove5 = encumberedDisplayMove4;
                
                // check for half move
                injuryFatigueMoveModifier = getInjuryFatigueModifier(values.hit_points, values.hit_points_max, values.fatigue_points, values.fatigue_points_max);
                
                // determine the current encumbrance move
                switch(Number(values.encumbrance_level)) {
                    
                    case 0:
						currentWaterMove = (waterMove * injuryFatigueMoveModifier);
						baseWaterMove = currentWaterMove;
                        break;
                        
                    case 1:
                        currentWaterMove = (getEncumberedMove(waterMove, 1) * injuryFatigueMoveModifier);
                        baseWaterMove = currentWaterMove;
                        break;
                        
                    case 2:
                        currentWaterMove = (getEncumberedMove(waterMove, 2) * injuryFatigueMoveModifier);
                        baseWaterMove = currentWaterMove;
                        break;
                        
                    case 3:
                        currentWaterMove = (getEncumberedMove(waterMove, 3) * injuryFatigueMoveModifier);
                        baseWaterMove = currentWaterMove;
                        break;
                        
                    case 4:
                    case 5:
                    default:
                        currentWaterMove = (getEncumberedMove(waterMove, 4) * injuryFatigueMoveModifier);
                        baseWaterMove = currentWaterMove;
                        break;
                    
                }
                
			}
			
			let step = Math.ceil(baseWaterMove/10);
            
            // set water moves
            setAttrs({
                "basic_water_move": waterMove, 
                "basic_water_move_unmodified": waterMoveUnmodified, 
                "enhanced_water_move": baseEnhancedWaterMove,
                "enhanced_water_move_level": totalEnhancedLevel,
                "basic_water_move_points": waterMovePoints,
                "enhanced_water_move_points": enhancedEnteredPoints,
                "water_0": encumberedDisplayMove0,
                "water_1": encumberedDisplayMove1,
                "water_2": encumberedDisplayMove2,
                "water_3": encumberedDisplayMove3,
                "water_4": encumberedDisplayMove4,
                "water_5": encumberedDisplayMove5,
				"current_water": `${currentWaterMove} (${step})`,
				"current_water_step": step
            });
                
            
        });
        
    }
    
    // check for changes that affect jump distance
    on("change:use_st_for_jump change:jump_skill change:basic_move change:enhanced_ground_move change:super_jump_entered_level change:super_jump_points change:jump_encumbrance change:encumbrance_level change:jump_concentration change:running_jump_yards_moved change:running_high_jump_yards_moved change:strength change:encumbrance_level change:hit_points change:fatigue_points change:gravity", function(e) {
        
        updateJumpDistanceValues();
        
    });
    
    /**
     * Update jump distance values
     */
    function updateJumpDistanceValues() {
        
		console.log('***** UPDATE JUMP VALUES *****');
		
		let fields = [
			"use_st_for_jump", 
			"jump_skill", 
			"basic_move", 
			"enhanced_ground_move", 
			"super_jump_entered_level", 
			"super_jump_points", 
			"strength", 
			"jump_concentration", 
			"running_jump_yards_moved", 
			"running_high_jump_yards_moved", 
			"encumbrance_level", 
			"hit_points", 
			"hit_points_max", 
			"fatigue_points", 
			"fatigue_points_max", 
			"jump_encumbrance", 
			"gravity",
		];
		    
		getAttrs(fields, function(values) {
			
			let gravity = Number(values.gravity);

			let gravityRatio = 1 / gravity;

            let jumpSkill = Number(values.jump_skill);
            
            if (jumpSkill < 0) {
                jumpSkill = 0;
            }
            
            let jumpST = Number(values.strength);
            
            if (jumpST < 0) {
                jumpST = 0;
            }
            
            let superJumpPoints = Number(values.super_jump_points);
            
            // ensure valid superJumpPoints
            if (superJumpPoints < 0) {
                superJumpPoints = 0;
            }
            
            let superJumpEnteredLevel = Number(values.super_jump_entered_level);
            
            if (superJumpEnteredLevel < 0) {
                superJumpEnteredLevel = 0;
            }
            
            let basicMove = Number(values.basic_move);
            
            // check for super move
            let enhancedGroundMove = Number(values.enhanced_ground_move);
            
            if (enhancedGroundMove < 0) {
                enhancedGroundMove = 0;
            }
            
            // check for running jump
            let runningJumpYardsMoved = Number(values.running_jump_yards_moved);
            
            runningJumpYardsMoved = Math.floor(runningJumpYardsMoved);
            
            let runningHighJumpYardsMoved = Number(values.running_high_jump_yards_moved);
            
            runningHighJumpYardsMoved = Math.floor(runningHighJumpYardsMoved);
            
            let runningMoveToUse = 0;
            
            let runningHighMoveToUse = 0;
            
            let jumpBroadFeet = 0;
            
            let jumpBroadYards = 0;
            
            let runningBroadJumpFeet = 0;
            
            let runningBroadJumpYards = 0;
            
            let jumpHighFeet = 0;
            
            let jumpHighYards = 0;
            
            let runningHighJumpFeet = 0;
            
            let runningHighJumpYards = 0;
            
            let superJumpLevelFromPoints = 0;
            
            let totalSuperJumpLevel = 0;
            
            let encumberedDisplayMove0 = "";
            
            let encumberedDisplayMove1 = "";
            
            let encumberedDisplayMove2 = "";
            
            let encumberedDisplayMove3 = "";
            
            let encumberedDisplayMove4 = "";
            
            let encumberedDisplayMove5 = "";
            
            let injuryFatigueMoveModifier = 1;
            
            let jumpMoveSpeed = 0;
            
            let finalJumpMoveSpeed = 0;
            
            let statUsedForJump = "";
            
            let statUsedForRunningJump = "";
            
            let baseJumpMove = "";
            
            // calculate broad and high jump
            if (jumpSkill > 0) {
                
                // -------------
                // USE JUMP SKILL
                baseJumpMove = Math.floor(jumpSkill/2);
                
                // calc. standing broad jump
                jumpBroadFeet = baseJumpMove;
                
                if (jumpBroadFeet <= 0) {
                    jumpBroadFeet = 1;
                }
				
				jumpBroadFeet = jumpBroadFeet * gravityRatio;

                statUsedForJump = "Jump Skill/2 = " + jumpBroadFeet;
                
                jumpBroadFeet = (jumpBroadFeet * 2) - 3;
                
                if (jumpBroadFeet <= 0) {
                    jumpBroadFeet = 1;
                }
				
                // calc. running broad jump
                if (enhancedGroundMove > Math.floor(jumpSkill/2)) {
                    
                    // use enhanced move instead of jump skill
                    statUsedForRunningJump = "Basic Move * (2 ^ Enh MV Mod)";
                    
                    runningMoveToUse = enhancedGroundMove * gravityRatio
                    
                    runningHighMoveToUse = enhancedGroundMove * gravityRatio;
                    
                } else {
                    
                    // use jump skill for running jump
                    statUsedForRunningJump = statUsedForJump + " + Yards Run";
                    
                    runningMoveToUse = (Math.floor(jumpSkill/2) + runningJumpYardsMoved) * gravityRatio;
					
					// do not apply gravity ratio to running start
                    runningHighMoveToUse = (Math.floor(jumpSkill/2 ) * gravityRatio) + runningHighJumpYardsMoved;
                    
                }
                
                runningBroadJumpFeet = (runningMoveToUse * 2) - 3;
                
                if (runningBroadJumpFeet <= 0) {
                    
                    runningBroadJumpFeet = 1;
                    
                }
                
                // calc. standing high jump
                jumpHighFeet = Math.floor(jumpSkill/2);
                
                if (jumpHighFeet <= 0) {
                    jumpHighFeet = 1;
                }
				
				jumpHighFeet = jumpHighFeet * gravityRatio;
				
                jumpHighFeet = (6 * jumpHighFeet) - 10;
                
                if (jumpHighFeet <= 0) {
                    jumpHighFeet = 1;
                }
                
                // convert to feet
                jumpHighFeet = jumpHighFeet / 12;
                
                if (jumpHighFeet <= 0) {
                    jumpHighFeet = 1;
				}
				
                // calc. running high jump
                runningHighJumpFeet = (6 * runningHighMoveToUse) - 10;
                
                if (runningHighJumpFeet <= 0) {
                    runningHighJumpFeet = 1;
                }
                
                // convert to feet
                runningHighJumpFeet = Math.floor(runningHighJumpFeet / 12);
                
                if (runningHighJumpFeet <= 0) {
                    
                    runningHighJumpFeet = 1;
                    
                } else if (runningHighJumpFeet > jumpHighFeet * 2) {
                    
                    // can't be greater than twice standing broad jump
                    runningHighJumpFeet = jumpHighFeet * 2;
                    
                }
                
            } else if (values.use_st_for_jump == "1") {
                
                //-------------------------------
                // USE Strength to determine jump
                baseJumpMove = Math.floor(jumpST/4);
                
                // calc. standing broad jump
                jumpBroadFeet = baseJumpMove;
                
                if (jumpBroadFeet <= 0) {
                    jumpBroadFeet = 1;
                }
				
				jumpBroadFeet = jumpBroadFeet * gravityRatio;

                statUsedForJump = "ST / 4 = " + jumpBroadFeet;
                
                jumpBroadFeet = (jumpBroadFeet * 2) - 3;
                
                if (jumpBroadFeet <= 0) {
                    jumpBroadFeet = 1;
                }
                
                // calc. running broad jump
                if (enhancedGroundMove > Math.floor(jumpST/4)) {
                    
                    // use enhanced move instead of strength
                    statUsedForRunningJump = "Basic Move * (2 ^ Enh MV Mod)";
                    
                    runningMoveToUse = enhancedGroundMove * gravityRatio;
                    
                    runningHighMoveToUse = enhancedGroundMove * gravityRatio;
                    
                } else {
                    
                    statUsedForRunningJump = statUsedForJump + " + Yards Run";
                    
                    runningMoveToUse = (Math.floor(jumpST/4) + runningJumpYardsMoved) * gravityRatio;
					
					// do not apply gravity ratio to running start
                    runningHighMoveToUse = (Math.floor(jumpST/2) * gravityRatio) + runningHighJumpYardsMoved;
                }
                
                runningBroadJumpFeet = (runningMoveToUse * 2) - 3;
                
                if (runningBroadJumpFeet <= 0) {
                    
                    runningBroadJumpFeet = 1;
                    
                }
                
                // calc. standing high jump
                jumpHighFeet = Math.floor(jumpST/4);
                
                if (jumpHighFeet <= 0) {
                    jumpHighFeet = 1;
                }
				
				jumpHighFeet = jumpHighFeet * gravityRatio;

                jumpHighFeet = (6 * jumpHighFeet) - 10;
                
                if (jumpHighFeet <= 0) {
                    jumpHighFeet = 1;
                }
                
                // convert to feet
                jumpHighFeet = jumpHighFeet / 12;
            
                // calc. running high jump
                runningHighJumpFeet = (6 * runningHighMoveToUse) - 10;
                
                if (runningHighJumpFeet <= 0) {
                    runningHighJumpFeet = 1;
                }
                
                // convert to feet
                runningHighJumpFeet = Math.floor(runningHighJumpFeet / 12);
                
                if (runningHighJumpFeet <= 0) {
                
                    runningHighJumpFeet = 1;
                    
                } else if (runningHighJumpFeet > jumpHighFeet * 2) {
                    
                    // can't be greater than twice standing broad jump
                    runningHighJumpFeet = jumpHighFeet * 2;
                    
                }
                
            } else {
                
                //---------------
                // USE Basic Move
                baseJumpMove = basicMove;
                
                statUsedForJump = "Basic Move = " + basicMove;
                
                // calc. standing broad jump
                jumpBroadFeet = (basicMove * 2) - 3;
                
                if (jumpBroadFeet <= 0) {
                    jumpBroadFeet = 1;
				}
				
				jumpBroadFeet = jumpBroadFeet * gravityRatio;
                
                // calc. running broad jump
                if (enhancedGroundMove > basicMove) {
                    
                    // use enhanced move instead of strength
                    statUsedForRunningJump = "Basic Move * (2 ^ Enh MV Mod)";
                    
                    runningMoveToUse = enhancedGroundMove * gravityRatio;
                    
                    runningHighMoveToUse = enhancedGroundMove * gravityRatio;
                    
                } else {
                    
                    statUsedForRunningJump = statUsedForJump + " + Yards Run";
                    
                    runningMoveToUse = (basicMove + runningJumpYardsMoved) * gravityRatio;
					
					// do not apply gravity ratio to running start
					runningHighMoveToUse = (basicMove * gravityRatio) + runningHighJumpYardsMoved;
                    
                }
                
                runningBroadJumpFeet = (runningMoveToUse * 2) - 3;
                
                if (runningBroadJumpFeet <= 0) {
                
                    runningBroadJumpFeet = 1;
                    
                } else if (runningBroadJumpFeet > jumpBroadFeet * 2) {
                    
                    // can't be greater than twice standing broad jump
                    runningBroadJumpFeet = jumpBroadFeet * 2;
                    
                }
                
                // calc. high jump
                jumpHighFeet = (6 * basicMove) - 10;
                
                if (jumpHighFeet <= 0) {
                    jumpHighFeet = 1;
                }
				
				jumpHighFeet = jumpHighFeet * gravityRatio;
				
                // convert to feet
                jumpHighFeet = jumpHighFeet / 12;
                
                // calc. running high jump
                runningHighJumpFeet = (6 * runningHighMoveToUse) - 10;
                
                if (runningHighJumpFeet <= 0) {
                    runningHighJumpFeet = 1;
                }
                
                // convert to feet
                runningHighJumpFeet = Math.floor(runningHighJumpFeet / 12);
                
                if (runningHighJumpFeet <= 0) {
                    
                    runningHighJumpFeet = 1;
                    
                } else if (runningHighJumpFeet > jumpHighFeet * 2) {
                    
                    // can't be greater than twice standing broad jump
                    runningHighJumpFeet = jumpHighFeet * 2;
                    
                }
                
            }
            
            // If no concentration, divide distance by 2
            if (values.jump_concentration != "1") {
                
                jumpBroadFeet = Math.floor(jumpBroadFeet / 2);
                
                if (jumpBroadFeet <= 0) {
                    jumpBroadFeet = 1;
                }
                
                runningBroadJumpFeet = Math.floor(runningBroadJumpFeet / 2);    
                
                if (runningBroadJumpFeet <= 0 ) {
                    runningBroadJumpFeet = 1;
                }
                
                // reduce in half
                jumpHighFeet = jumpHighFeet / 2;
                
                if (jumpHighFeet <= 0) {
                    jumpHighFeet = 1;
                }
                
                runningHighJumpFeet = Math.floor(runningHighJumpFeet / 2);
                
                if (runningHighJumpFeet <= 0) {
                    
                    runningHighJumpFeet = 1;
                }
                
            }
            
            // check for super jump
            if (superJumpPoints > 0 || superJumpEnteredLevel > 0) {
                
                //-----------------
                // calculate super jump
                // make sure points is multiple of 10
                // https://stackoverflow.com/questions/18953384/javascript-round-up-to-the-next-multiple-of-5 
                superJumpPoints = Math.ceil(superJumpPoints / 10) * 10;
                
                superJumpLevelFromPoints = superJumpPoints / 10;
                
                // -------
                // make sure entered super jump level is an integer, min of 1
                superJumpEnteredLevel = Math.floor(superJumpEnteredLevel);
                
                if (superJumpEnteredLevel < 0) {
                    superJumpEnteredLevel = 0;
                }
                
                totalSuperJumpLevel = superJumpEnteredLevel + superJumpLevelFromPoints;
                
                // get the new jump feet values based on super level
                jumpBroadFeet = getEnhancedValue(jumpBroadFeet, totalSuperJumpLevel);
                
                runningBroadJumpFeet = getEnhancedValue(runningBroadJumpFeet, totalSuperJumpLevel);
                
                jumpHighFeet = getEnhancedValue(jumpHighFeet, totalSuperJumpLevel);
                
                runningHighJumpFeet = getEnhancedValue(runningHighJumpFeet, totalSuperJumpLevel);
                
			}

			// check if encumbrance should be factored in.
			if (+values.jump_encumbrance === 1) {

				switch(Number(values.encumbrance_level)) {
                    
					default:
					case 0:
						// round everything to two decimals
						jumpBroadFeet = Math.round( jumpBroadFeet * 100 ) / 100;
						
						runningBroadJumpFeet = Math.round( runningBroadJumpFeet * 100) / 100;
						
						jumpHighFeet = Math.round( jumpHighFeet * 100) / 100;
					
						runningHighJumpFeet = Math.round( runningHighJumpFeet * 100) / 100;
						
						break;
						
					case 1:
						// Light
						jumpBroadFeet = Math.round( (jumpBroadFeet * .8) * 100) / 100;
						
						runningBroadJumpFeet = Math.round( (runningBroadJumpFeet * .8) * 100) / 100;
						
						jumpHighFeet = Math.round( (jumpHighFeet * .8) * 100) / 100;
					
						runningHighJumpFeet = Math.round( (runningHighJumpFeet * .8) * 100) / 100;
						
						break;
						
					case 2:
						// Medium
						jumpBroadFeet = Math.round( (jumpBroadFeet * .6) * 100) / 100;
						
						runningBroadJumpFeet = Math.round( (runningBroadJumpFeet * .6) * 100) / 100;
						
						jumpHighFeet = Math.round( (jumpHighFeet * .6) * 100) / 100;
					
						runningHighJumpFeet = Math.round( (runningHighJumpFeet * .6) * 100) / 100;
						
						break;
						
					case 3:
						// Heavy
						jumpBroadFeet = Math.round( (jumpBroadFeet * .4) * 100) / 100;
						
						runningBroadJumpFeet = Math.round( (runningBroadJumpFeet * .4) * 100) / 100;
						
						jumpHighFeet = Math.round( (jumpHighFeet * .4) * 100) / 100;
					
						runningHighJumpFeet = Math.round( (runningHighJumpFeet * .4) * 100) / 100;
						
						break;
						
					case 4:
						// Extra-Heavy
						jumpBroadFeet = Math.round( (jumpBroadFeet * .2) * 100) / 100;
						
						runningBroadJumpFeet = Math.round( (runningBroadJumpFeet * .2) * 100) / 100;
						
						jumpHighFeet = Math.round( (jumpHighFeet * .2) * 100) / 100;
					
						runningHighJumpFeet = Math.round( (runningHighJumpFeet * .2) * 100) / 100;
						
						break;
						
				}

			} else {

				// make sure to round final values
				jumpBroadFeet = Math.round( jumpBroadFeet * 100 ) / 100;
				
				runningBroadJumpFeet = Math.round( runningBroadJumpFeet * 100) / 100;
				
				jumpHighFeet = Math.round( jumpHighFeet * 100) / 100;
			
				runningHighJumpFeet = Math.round( runningHighJumpFeet * 100) / 100;

			}
			
            // get broad jump in yards. Minimum of 1
            jumpBroadYards = Math.round( (jumpBroadFeet / 3) * 100) / 100;
            
            // get running jump in yards. Min of 1
            runningBroadJumpYards = Math.round( (runningBroadJumpFeet / 3) * 100) / 100;
            
            // get high jump in yards
            jumpHighYards = Math.round( (jumpHighFeet / 3) * 100) / 100;
            
            // get running high in yards
            runningHighJumpYards = Math.round( (runningHighJumpFeet / 3) * 100) / 100;
            
            // calculate jump move speed
            jumpMoveSpeed = Math.floor(jumpBroadYards / 5);
            
            if (jumpMoveSpeed <= 0) {
                jumpMoveSpeed = 1;
            }
            
            // determine which one to use
            if (jumpMoveSpeed > basicMove) {
                
                finalJumpMoveSpeed = jumpMoveSpeed;
                
            } else {
                
                finalJumpMoveSpeed = basicMove;
                
            }
            
            // set jump distances
            setAttrs({
                "broad_jump_distance_feet": jumpBroadFeet, 
                "broad_jump_distance_yards": jumpBroadYards, 
                "high_jump_distance_feet": jumpHighFeet,
                "high_jump_distance_yards": jumpHighYards,
                "super_jump_level": totalSuperJumpLevel,
                "super_jump_entered_level": superJumpEnteredLevel,
                "super_jump_points": superJumpPoints,
                "running_jump_distance_feet": runningBroadJumpFeet,
                "running_jump_distance_yards": runningBroadJumpYards,
                "running_high_jump_distance_feet": runningHighJumpFeet,
                "running_high_jump_distance_yards": runningHighJumpYards,
                "broad_jump_base": baseJumpMove,
                "standing_broad_jump_stat_to_use": statUsedForJump,
                "running_broad_jump_stat_to_use": statUsedForRunningJump,
                "high_jump_base": baseJumpMove,
                "standing_high_jump_stat_to_use": statUsedForJump,
                "running_high_jump_stat_to_use": statUsedForRunningJump,
                "jump_move_speed": finalJumpMoveSpeed
            });
            
        });
        
    }
    
    // set note values for damage types
    // Update thrust and swing when striking st is updated
	on('change:repeating_melee:type', function(event){

		getAttrs(['repeating_melee_type',
		    'damage_type_note_cut',
		    'damage_type_note_imp',
		    'damage_type_note_cr',
		    'damage_type_note_pi_minus',
		    'damage_type_note_pi',
		    'damage_type_note_pi_plus',
		    'damage_type_note_pi_plus_plus',
		    'damage_type_note_aff',
		    'damage_type_note_burn',
		    'damage_type_note_cor',
		    'damage_type_note_fat',
		    'damage_type_note_tox',
			'damage_type_note_spec',
			'damage_type_note_knockback'
		], function(values) {
		    
		    var typeNote = getDamageTypeNote(values.repeating_melee_type, values);
		    
		    var minDamageNote = getMinimumDamageNote(values.repeating_melee_type);
		    
		    setAttrs({
		        "repeating_melee_damage_type_note": typeNote,
		        "repeating_melee_minimum_damage_note": minDamageNote,
		    });
		    
		});
		
	});
    
    // set note values for damage types
    // Update thrust and swing when striking st is updated
	on('change:repeating_ranged:type', function(event){

		getAttrs(['repeating_ranged_type',
		    'damage_type_note_cut',
		    'damage_type_note_imp',
		    'damage_type_note_cr',
		    'damage_type_note_pi_minus',
		    'damage_type_note_pi',
		    'damage_type_note_pi_plus',
		    'damage_type_note_pi_plus_plus',
		    'damage_type_note_aff',
		    'damage_type_note_burn',
		    'damage_type_note_cor',
		    'damage_type_note_fat',
		    'damage_type_note_tox',
			'damage_type_note_spec',
			'damage_type_note_knockback'
		], function(values) {
		    
		    var typeNote = getDamageTypeNote(values.repeating_ranged_type, values);
		    
		    var minDamageNote = getMinimumDamageNote(values.repeating_ranged_type);
		    
		    setAttrs({
		        "repeating_ranged_damage_type_note": typeNote,
		        "repeating_ranged_minimum_damage_note": minDamageNote,
		    });
		    
		});
		
	});
	
	// update damage notes for thrown object
	on('change:thrown_object_damage_type', function(event) {
	    
	    updateThrownObject();
	    
	});
	
	/*
	 * Update the thrown object weight damage notes
	 */
	function updateThrownObject() {
	    
	    getAttrs(['thrown_object_damage_type',
		    'damage_type_note_cut',
		    'damage_type_note_imp',
		    'damage_type_note_cr',
		    'damage_type_note_pi_minus',
		    'damage_type_note_pi',
		    'damage_type_note_pi_plus',
		    'damage_type_note_pi_plus_plus',
		    'damage_type_note_aff',
		    'damage_type_note_burn',
		    'damage_type_note_cor',
		    'damage_type_note_fat',
		    'damage_type_note_tox',
			'damage_type_note_spec',
			'damage_type_note_knockback'
		    ], function(values) {
	        
	        var typeNote = getDamageTypeNote(values.thrown_object_damage_type, values);
		    
		    var minDamageNote = getMinimumDamageNote(values.thrown_object_damage_type);
		    
		    setAttrs({
		        "thrown_object_damage_type_note": typeNote,
		        "thrown_minimum_damage_note": minDamageNote,
		    });
	        
	    } );
	    
	} 
	
	/**
	 * Get Damage Type Note for damage type string
	 * Used for adding custom notes to rolltemplates
	 */
	function getDamageTypeNote(damageType, values) {
	    
		var typeNote = "";
		    
	    switch(damageType) {
	        
	        case "Cutting (cut)":
                typeNote = values.damage_type_note_cut;
                break;
            
            case "Impaling (imp)":
                typeNote = values.damage_type_note_imp;
                break;
            
            case "Crushing (cr)":
                typeNote = values.damage_type_note_cr;
                break;
            
            case "Small Piercing (pi-)":
                typeNote = values.damage_type_note_pi_minus;
                break;
            
            case "Piercing (pi)":
                typeNote = values.damage_type_note_pi;
                break;
            
            case "Large Piercing (pi+)":
                typeNote = values.damage_type_note_pi_plus;
                break;
            
            case "Huge Piercing (pi++)":
                typeNote = values.damage_type_note_pi_plus_plus;
                break;
            
            case "Affliction (aff)":
                typeNote = values.damage_type_note_aff;
                break;
            
            case "Burning (burn)":
                typeNote = values.damage_type_note_burn;
                break;
            
            case "Corrosion (cor)":
                typeNote = values.damage_type_note_cor;
                break;
            
            case "Fatigue (fat)":
                typeNote = values.damage_type_note_fat;
                break;
            
            case "Toxic (tox)":
                typeNote = values.damage_type_note_tox;
                break;
            
            case "Special (spec)":
                typeNote = values.damage_type_note_spec;
                break;
            
			case "Knockback (knock)":
                typeNote = values.damage_type_note_knockback;
                break;
            
            default:
                typeNote = values.damage_type_note_cut;
                
	    }
	    
	    return typeNote;
	    
	}
	
	/*
	 * Loop through each repeating section 
	 * for melee and ranged and update
	 * damage notes to match damage type
	 *
	 */
	function updateDamageNotes() {
	 
	    // note field values
	    var noteFields = ['damage_type_note_cut',
	        'damage_type_note_imp',
	        'damage_type_note_cr',
	        'damage_type_note_pi_minus',
	        'damage_type_note_pi',
	        'damage_type_note_pi_plus',
	        'damage_type_note_pi_plus_plus',
	        'damage_type_note_aff',
	        'damage_type_note_burn',
	        'damage_type_note_cor',
	        'damage_type_note_fat',
	        'damage_type_note_tox',
			'damage_type_note_spec',
			'damage_type_note_knockback'
	    ];
	    
	    getAttrs(noteFields, function(noteFieldValues) {
	        
	        updateDamageNotesBySection("melee", noteFieldValues);
	    
	        updateDamageNotesBySection("ranged", noteFieldValues);
	        
	    });
	    
        
	}
    
    /*
     * Update damage notes for a section
     *
     * @param string sectionName     melee | ranged
     * @param object noteFieldValues Note Content for each damage type
     */
    function updateDamageNotesBySection(sectionName, noteFieldValues) {
		
		console.log('********* updateDamageNotesBySection ' + sectionName + '*********');
		
		getSectionIDs(sectionName, function (ids) {
		
			if (ids.length === 0 ) {
				return;
			}
		
		    let getFields = [];
		        
		    // loop through the rows
			for (var i = 0; i < ids.length; i++) {
		
		        // field that determines note
                let damageTypeField = "repeating_" + sectionName + '_' + ids[i] + '_type';
				
				getFields.push(damageTypeField);
				
			}
			
			getAttrs(getFields, function (values) {
		    
		        let updateFields = {};
		    
		        // loop through the row ids again so we can get the values
		        // and fill array of note values to update
		        _.each(ids, function(id) {
		        
		            let damageTypeField = "repeating_" + sectionName + '_' + id + '_type';
			
			        // field we need to update
			        let damageTypeNoteField = "repeating_" + sectionName + '_' + id + '_damage_type_note';
				    
		            let type = values[damageTypeField];
		            
		            var note = getDamageTypeNote(type, noteFieldValues);
		            
		            var minDamageNote = getMinimumDamageNote(type);
		            
		            var minDamageNoteField = `repeating_${sectionName}_${id}_minimum_damage_note`;
		            
		            updateFields[damageTypeNoteField] = note;
		            
		            updateFields[minDamageNoteField] = minDamageNote;
		            
                });
                
				setAttrs(updateFields);
			    
			});		
		
		});
		
	}
	
	// check for changes that affect thrown object stats
	on('change:thrown_object_weight change:basic_lift change:thrust change:super_throw_level change:thrown_object_strength_mod change:thrown_object_damage_mod change:gravity', function(event) {
	    
	    updateThrownObjectStats();
	    
	});
	
	/**
	 * Update thrown objects stats
	 * Damage, range, etc.
	 */
	function updateThrownObjectStats() {
	
	    console.log("*********** Updating Thrown Object Stats ***********");
	    
	    var fields = ['thrown_object_weight',
            'striking_st',
            'thrown_object_strength_mod',
            'super_throw_level',
            'thrust',
            'basic_lift',
			'thrown_object_damage_mod',
			'gravity'
        ];
	    
	    getAttrs(fields, function (values) {
	        
	        var weight = +values.thrown_object_weight;
	        
	        var basicLift = +values.basic_lift;
	        
	        var throwingST = +values.striking_st;
	        
	        var throwingStMod = parseInt(values.thrown_object_strength_mod);
	        
	        var superThrowLvl = parseInt(values.super_throw_level);
	        
	        var enteredDamageMod = parseInt(values.thrown_object_damage_mod);
	        
			var damageMod = 0;
			
			let gravity = Number(values.gravity);
	        
	        throwingST = throwingST + throwingStMod;
	        
	        if (weight < 1) {
	            weight = 0;
	        }
	        
	        if (basicLift < 0) {
	            basicLift = 1;
	        }
	        
	        if (superThrowLvl < 0) {
	            superThrowLvl = 0;
	        }
	        
	        var weightRatio = weight/basicLift;
	        
	        var distanceMod = distanceModifier(weightRatio);
	        
	        var distance = throwingST * distanceMod;
	        
	        var damageMod = getThrownDamageModifier(basicLift, weight);
	        
	        // check for super throw
	        if (superThrowLvl > 0) {
	            
	            distance = distance * Math.pow(2,superThrowLvl);
	            
	            damageMod = damageMod + (superThrowLvl * 2);
	            
	        }
	        
	        // check to see if they entered a modifier
	        if (enteredDamageMod != 0) {
	            damageMod = damageMod + enteredDamageMod; 
			}
			
			// factor in gravity
			let gravityRatio = 1 / gravity;
	        
	        distance = Math.floor(distance * gravityRatio);
	        
	        var finalDamage = getModifiedDamage(values.thrust, damageMod);
	        
	        setAttrs({
	            'thrown_object_strength': throwingST,
	            'thrown_object_range': distance,
	            'thrown_object_damage': finalDamage
	        });
	        
	    });
	    
	}
	
	/*
	 * Get damage modifier
	 *
	 * @param int basicLift In pounds
	 * @param int weight    Weight of thrown object
	 *
	 * @return int
	 */
	function getThrownDamageModifier(basicLift, weight) {
	    
	    var damageMod = 0;
	    
	    if (weight <= Math.floor(basicLift/8)) {
	        damageMod = -2;
	    } else if (Math.floor(basicLift/8) < weight && weight <= Math.floor(basicLift/4)) {
	        damageMod = -1;
	    } else if (Math.floor(basicLift/4) < weight && weight <= Math.floor(basicLift/2)) {
	        damageMod = 0;
	    } else if (Math.floor(basicLift/2) < weight && weight <= Math.floor(basicLift)) {
	        damageMod = 1;
	    } else if (Math.floor(basicLift) < weight && weight <= Math.floor(basicLift*2)) {
	        damageMod = 0;
	    } else if (Math.floor(basicLift*2) < weight && weight <= Math.floor(basicLift*4)) {
	        damageMod = -.5;
	    } else if (Math.floor(basicLift*4) < weight && weight <= Math.floor(basicLift*8)) {
	        damageMod = -1;
	    } else {
	        damageMod = -10;
	    }
	    
	    return damageMod;
	    
	}
	
	/*
	 * Get distance modifier based on ratio
	 *
	 * @param decimal weightRatio Object Weight/Basic Lift
	 *
	 * @return decimal
	 */
	function distanceModifier(weightRatio) {
	    
	    var distanceMod = 0;
	    
	    if (weightRatio <= .05) {
	        distanceMod = 3.5;
	    } else if (.05 < weightRatio && weightRatio <= .10) {
	        distanceMod = 2.5;
	    } else if (.10 < weightRatio && weightRatio <= .15) {
	        distanceMod = 2.0;
	    } else if (.15 < weightRatio && weightRatio <= .20) {
	        distanceMod = 1.5;
	    } else if (.20 < weightRatio && weightRatio <= .25) {
	        distanceMod = 1.2;
	    } else if (.25 < weightRatio && weightRatio <= .30) {
	        distanceMod = 1.1;
	    } else if (.30 < weightRatio && weightRatio <= .40) {
	        distanceMod = 1.0;
	    } else if (.40 < weightRatio && weightRatio <= .50) {
	        distanceMod = .8;
	    } else if (.50 < weightRatio && weightRatio <= .75) {
	        distanceMod = .7;
	    } else if (.75 < weightRatio && weightRatio <= 1.00) {
	        distanceMod = .6;
	    } else if (1.00 < weightRatio && weightRatio <= 1.50) {
	        distanceMod = .4;
	    } else if (1.50 < weightRatio && weightRatio <= 2.0) {
	        distanceMod = .30;
	    } else if (2.0 < weightRatio && weightRatio <= 2.5) {
	        distanceMod = .25;
	    } else if (2.5 < weightRatio && weightRatio <= 3.0) {
	        distanceMod = .20;
	    } else if (3.0 < weightRatio && weightRatio <= 4.0) {
	        distanceMod = .15;
	    } else if (4.0 < weightRatio && weightRatio <= 5.0) {
	        distanceMod = .12;
	    } else if (5.0 < weightRatio && weightRatio <= 6.0) {
	        distanceMod = .10;
	    } else if (6.0 < weightRatio && weightRatio <= 7.0) {
	        distanceMod = .09;
	    } else if (7.0 < weightRatio && weightRatio <= 8.0) {
	        distanceMod = .08;
	    } else if (8.0 < weightRatio && weightRatio <= 9.0) {
	        distanceMod = .07;
	    } else if (9.0 < weightRatio && weightRatio <= 10.0) {
	        distanceMod = .06;
	    } else if (10.0 < weightRatio && weightRatio <= 12.0) {
	        distanceMod = .05;
	    } else {
	        distanceMod = 0;
	    }
	    
	    return distanceMod;
	    
	}
	
	/**
	 * Determines the final damage dice + modifier
	 * 
	 * @param string damageDice Original damage dice; 3d6
	 * @param int    damageMod  Damage modifier per dice; +1 per dice
	 * 
	 * @return string Modified damage dice
	 */
	function getModifiedDamage(damageDice, damageMod) {
	    
	    var newDamageDice = damageDice;
	    
	    damageDice = damageDice.toLowerCase();
	    
	    // split into array. 
	    // 3d6 = [3,6]
	    var arrDice = damageDice.split("d");
	    
	    if (arrDice.length == 2) {

            var diceCount = parseInt(arrDice[0]);
	    
    	    var diceType = arrDice[1];
    	    
    	    var arrDiceTypeModifier = [];
    	    
    	    var diceModifier = "";
	        
	        if (diceCount < 1) {
	            diceCount = 1;
	        }
	        
	        // check for dice modifier
	        // 3d6+1; diceType = 6+1; diceType=6; diceModifier=1;
	        if (diceType && diceType.includes("+")) {
	            
	            arrDiceTypeModifier = diceType.split("+");
	            
	            diceType = arrDiceTypeModifier[0];
	            
	            diceModifier = parseInt(arrDiceTypeModifier[1]);
	            
	        } else if (diceType && diceType.includes("-")) { 
	            
	            arrDiceTypeModifier = diceType.split("-");
	            
	            diceType = arrDiceTypeModifier[0];
	            
	            diceModifier = -1 * parseInt(arrDiceTypeModifier[1]);
	            
	        } else {
	            
	            diceModifier = 0;
	            
	        }
	        
	        newDamageDice = diceCount + "d" + diceType;
	        
	        // get the final damage modifier
	        damageMod = Math.floor(damageMod + diceModifier);
	        
	        if (damageMod < 0) {
	            
	            damageMod = Math.abs(damageMod) * diceCount;
	            
	            newDamageDice = newDamageDice + "-" + damageMod;
	            
	        } else if (damageMod > 0) {
	            
	            damageMod = Math.abs(damageMod) * diceCount;
	            
	            newDamageDice = newDamageDice + "+" + damageMod;
	            
	        }
	        
	    }
	    
	    return newDamageDice;
	    
	}
	
	on("clicked:range_calc_reset", function() {
	    resetRangeCalculator();
	});
	
	function resetRangeCalculator() {
	    
	    setAttrs(
	        {
	            "firing_distance": 0,
	            "firing_speed_difference": 0,
	            "firing_size_mod": 0,
				"firing_elevation": 0,
				"firing_acc": 0,
				"firing_aiming_bonus": 0,
				"firing_rof": 0,
	        });
	    
	}
	
	// Range Calculator
	on('change:firing_distance change:firing_speed_difference change:firing_size_mod change:firing_elevation change:firing_acc change:firing_aiming_bonus change:firing_rof', function(event) {
	    
	    updateRangeModifier("calculator");
	    
	});
	
	on("clicked:apply_firing_modifiers", function() {
	    updateRangeModifier("tool");
	});

	/**
	 * Determine new range based on fields
	 * and then get the final to hit modifier
	 * applyTo = calculator. Update the ranged calculator
	 *         = tool. Update the modifier boxes and the roll modifier dialog tool.
	 * 
	 * @param string applyTo Select set of fields: calculator | tool
	 */
	function updateRangeModifier(applyTo) {
	    
		let fields = [
			"firing_distance",
			"firing_speed_difference",
			"firing_size_mod",
			"firing_elevation",
			"firing_acc",
			"firing_aiming_bonus",
			"firing_rof",
			"size"
		];
			
		getAttrs(fields, function(values) {
			
			let linearDistance = Number(values.firing_distance);
			
			let sizeMod = Number(values.firing_size_mod);

			let characterSize = Number(values.size) || 0;

			// calculate the final size modifier
			sizeMod = sizeMod + characterSize;
			
			let speed = Number(values.firing_speed_difference);
			
			let elevation = Number(values.firing_elevation);
			
			let acc = Number(values.firing_acc);

			let aiming = Number(values.firing_aiming_bonus);

			let rof = Number(values.firing_rof);

			let rofModifier = getRateOfFireModifier(rof);

			let elevationDown = 0;
			
			let rangeToTarget = 0;
			
			let speedRangeValue = 0;
			
			let finalSpeedRangeValue = 0;
			
			let rangedRollModSummary = "";
			
			// make sure value is valid
			if (linearDistance < 0) 
				linearDistance = 0;
			
			if (elevation < 0) {
				
				rangeToTarget = linearDistance - elevation;
				
			} else if (elevation > 0) {
				
				elevationDown = Math.floor(elevation/2);
				
				// max elevation is half of ground distance
				if (elevationDown > Math.floor(linearDistance/2)) {
					
					elevationDown = Math.floor(linearDistance/2);
					
				}
				
				rangeToTarget = linearDistance - elevationDown;
				
			} else {
			
				rangeToTarget = linearDistance;
				
			}
			
			finalSpeedRangeValue = rangeToTarget + speed;
			
			let rangeModifier = getModBySpeedRange(finalSpeedRangeValue);
			
			// add in size modifier
			hitModifier = rangeModifier + sizeMod + acc + aiming + rofModifier;

			let updates;
			
			if (applyTo == "tool") {

				if (acc) {

					rangedRollModSummary += `+${acc} ACC\n`;

				}
				
				if (aiming) {

					rangedRollModSummary += `+${aiming} Aiming\n`;
						
				}
				
				if (rofModifier) {

					rangedRollModSummary += `+${rofModifier} RoF\n`;
						
				}
				
				if (rangeModifier) {

					rangedRollModSummary += `${rangeModifier} Speed/Range\n`;
						
				}
				
				if (sizeMod) {

					rangedRollModSummary += `${sizeMod} Size Modifier\n`;
						
				}

				updates = {
					ranged_roll_modifier: hitModifier,
					ranged_roll_modifier_summary: rangedRollModSummary,
					target_size_modifier: sizeMod,
					ranged_accuracy_bonus: acc,
					ranged_aiming_bonus: aiming,
					ranged_rof: rof,
					ranged_elevation: elevation,
					ranged_range_speed: linearDistance + speed
				};

			} else {

				updates = {
					firing_new_range: finalSpeedRangeValue,
					firing_hit_mod: hitModifier
				};

			}

			setAttrs(updates);
			
		});
	    
	}

	// check to see if modifier for fright check threshold changed
	on("change:fright_check_threshold_mod", function(event) {
	    
	    updateFrightCheckThreshold();
	    
	});
	
	function updateFrightCheckThreshold() {
	    
	    var fields = [
	        "fright_check_threshold_mod"
	        ];
	    
	    getAttrs(fields, function(values) {
	        
	        var base = 13;
	        
	        var mod = +values.fright_check_threshold_mod;
	        
	        var final = base + mod;
	        
	        setAttrs({
	            "fright_check_threshold": final 
	        });
	        
	    });
	    
	}
	
	// when button is clicked, show the updates tab
	on("clicked:view_updates_tab", function() {
	   
	   setAttrs({
	       "tab": 7
	   });
	    
	});

	on("change:yards_fallen change:gravity change:atmosphere", function() {
	    
	    var fields = [
	        "yards_fallen",
	        "gravity",
	        "atmosphere"
        ];
        
        getAttrs(fields, function(values) {
            
            var yards = Math.floor(+values.yards_fallen);
            
            var gravity = +values.gravity;
            
            var atmosphere = +values.atmosphere;
            
            if (yards <= 0)
                yards = 1;
                
            if (gravity < 0)
                gravity = 1;
                
            if (atmosphere < 0)
                atmosphere = 1;
                
            var velocity = (Math.sqrt(gravity * 21.4 * yards) / Math.sqrt(atmosphere));
            
            velocity = Math.round(velocity);
            
            setAttrs({
                falling_velocity: velocity
            });
            
        });
	    
	});
	
	// handle falling/collision damage
	on("change:falling_velocity change:falling_hit_points", function() {
	    
	    var strDmg = "";
	    
	    getAttrs(["falling_velocity", "falling_hit_points"], function(values) {
	        
	        strDmg = getCollisionDamage(values.falling_velocity, values.falling_hit_points);
	        
	        setAttrs({
	            "falling_damage": strDmg
	        });
	        
	    });
	    
	});
    
    on("change:collision_velocity change:collision_hit_points", function() {
        
        var strDmg = "";
	    
	    getAttrs(["collision_velocity", "collision_hit_points"], function(values) {
	        
	        strDmg = getCollisionDamage(values.collision_velocity, values.collision_hit_points);
	        
	        setAttrs({
	            "collision_damage": strDmg
	        });
	        
	    });
	    
    });
    
    function getCollisionDamage(velocity, hit_points) {
        
        var strDmg = "1d6-3";
        
        var remainder = 0;
        
        velocity = +velocity;
        
        if (velocity <= 0) {
            velocity = 1;
        }
        
        hit_points = +hit_points;
        
        if (hit_points <= 0) {
            hit_points = 1;
        }
        
        var ratio = (hit_points*velocity)/100;

        if (ratio <= .25) {
            
            strDmg = "1d6-3";
            
        } else if (ratio <= .5) {
            
            strDmg = "1d6-2";
            
        } else if (ratio < 1) {
            
            strDmg = "1d6-1";
            
        } else {
            
            remainder = ratio % 1;
            
            if (remainder < .5) {
                strDmg = Math.floor(ratio) + "d6";
            } else {
                strDmg = Math.ceil(ratio) + "d6";
            }
            
        }
        
        return strDmg;
    }
    
    on("clicked:falling_reset", function() {
        
        setAttrs({
            "yards_fallen": 1,
            "gravity": 1,
            "atmosphere": 1,
            "falling_hit_points": 10
        });
        
    });    
    
    on("clicked:collision_reset", function() {
        
        setAttrs({
            "collision_velocity": 1,
            "collision_hit_points": 10
        });
        
    });

    // TODO: Update to check for new defense types
    // If defense type changed, update hidden defense type
	on('change:repeating_defense:type', function(event){
	    
	    getAttrs(['repeating_defense_type'], function(v) {
			
			var defenseTypeName = v.repeating_defense_type;
			
			var defenseTypeId = 1;
			
// 		    <option>Dodge</option> = 1
// 			<option>Parry</option> = 2
// 			<option>Block</option> = 3
// 			<option>Magic</option> = 4
// 			<option>Other</option> = 5
			
			defenseTypeName = defenseTypeName.toLowerCase();
			
			switch(defenseTypeName) {
			    
			    case "parry":
			        defenseTypeId = 2;
			        break;
			    
			    case "block":
			        defenseTypeId = 3;
			        break;
			    
			    case "magic":
			        defenseTypeId = 4;
			        break;
			    
			    case "block":
			        defenseTypeId = 5;
			        break;
			    
			    default:
			    case "dodge":
			        defenseTypeId = 1;
			        break;
			        
			}
			
			// set the hidden value
			setAttrs({
			    repeating_defense_defense_type: defenseTypeId
			});
			
		});
	    
	});
	
	/**
	 * When loading a new version, make sure defense_type is updated
	 * for each item in the row.
	 */
	function updateRepeatingDefenseTypes() {
	    
	    console.log('********* updateRepeatingDefenseTypes *********');
	    
	    var sectionName = "repeating_defense";
		
		getSectionIDs(sectionName, function (ids) {
		
			if (ids.length === 0 ) {
				return;
			}
		
		    var getFields = [];
		        
		    // loop through the rows
			for (var i = 0; i < ids.length; i++) {
		
		        // field that determines defense type
                var damageTypeField = "repeating_defense_" + ids[i] + '_type';
				
				getFields.push(damageTypeField);
				
			}
			
			getAttrs(getFields, function (values) {
		    
		        var updateFields = {};
		    
		        // loop through the row ids again so we can get the values
		        // and fill array of defense_type id numbers
		        _.each(ids, function(id) {
		        
		            var defenseTypeField = "repeating_defense_" + id + '_type';
			
			        // field we need to update
			        var defenseTypeIdField = "repeating_defense_" + id + '_defense_type';
				    
		            var defenseName = values[defenseTypeField];
		            
		            // determine id based on defense type name
                    var defenseTypeId = 0;
                    
					// TODO: Update for new defense types
                    switch (defenseName.toLowerCase()) {
                        
                        case "parry":
        			        defenseTypeId = 2;
        			        break;
        			    
        			    case "block":
        			        defenseTypeId = 3;
        			        break;
        			    
        			    case "magic":
        			        defenseTypeId = 4;
        			        break;
        			    
        			    case "block":
        			        defenseTypeId = 5;
        			        break;
        			    
        			    default:
        			    case "dodge":
        			        defenseTypeId = 1;
        			        break;
                        
                    }

		            // update the defense type id number
		            updateFields[defenseTypeIdField] = defenseTypeId;
		            
                });
                
				setAttrs(updateFields);
			    
			});		
		
		});
		
	}
	
	on("change:damage_type_note_cut", function() {
        
	    getAttrs(["damage_type_note_cut"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Cutting (cut)", values.damage_type_note_cut);
	        
	        updateRangedCombatWoundNotes("Cutting (cut)", values.damage_type_note_cut);
	        
	        updateCombatToolThrownDamageType("Cutting (cut)", values.damage_type_note_cut);
	        
	    });
	    
    });
    
    on("change:damage_type_note_imp", function() {
        
	    getAttrs(["damage_type_note_imp"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Impaling (imp)", values.damage_type_note_imp);
	        
	        updateRangedCombatWoundNotes("Impaling (imp)", values.damage_type_note_imp);
	        
	        updateCombatToolThrownDamageType("Impaling (imp)", values.damage_type_note_imp);
	        
	    });
	    
    });
    
    on("change:damage_type_note_cr", function() {
        
	    getAttrs(["damage_type_note_cr"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Crushing (cr)", values.damage_type_note_cr);
	        
	        updateRangedCombatWoundNotes("Crushing (cr)", values.damage_type_note_cr);
	        
	        updateCombatToolThrownDamageType("Crushing (cr)", values.damage_type_note_cr);
	        
	    });
	    
    });
    
    on("change:damage_type_note_pi_minus", function() {
        
	    getAttrs(["damage_type_note_pi_minus"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Small Piercing (pi-)", values.damage_type_note_pi_minus);
	        
	        updateRangedCombatWoundNotes("Small Piercing (pi-)", values.damage_type_note_pi_minus);
	        
	        updateCombatToolThrownDamageType("Small Piercing (pi-)", values.damage_type_note_pi_minus);
	        
	    });
	    
    });
    
    on("change:damage_type_note_pi", function() {
        
	    getAttrs(["damage_type_note_pi"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Piercing (pi)", values.damage_type_note_pi);
	        
	        updateRangedCombatWoundNotes("Piercing (pi)", values.damage_type_note_pi);
	        
	        updateCombatToolThrownDamageType("Piercing (pi)", values.damage_type_note_pi);
	        
	    });
	    
    });
    
    on("change:damage_type_note_pi_plus", function() {
        
	    getAttrs(["damage_type_note_pi_plus"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Large Piercing (pi+)", values.damage_type_note_pi_plus);
	        
	        updateRangedCombatWoundNotes("Large Piercing (pi+)", values.damage_type_note_pi_plus);
	        
	        updateCombatToolThrownDamageType("Large Piercing (pi+)", values.damage_type_note_pi_plus);
	        
	    });
	    
    });
    
    on("change:damage_type_note_pi_plus_plus", function() {
        
	    getAttrs(["damage_type_note_pi_plus_plus"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Huge Piercing (pi++)", values.damage_type_note_pi_plus_plus);
	        
	        updateRangedCombatWoundNotes("Huge Piercing (pi++)", values.damage_type_note_pi_plus_plus);
	        
	        updateCombatToolThrownDamageType("Huge Piercing (pi++)", values.damage_type_note_pi_plus_plus);
	        
	    });
	    
    });
    
    on("change:damage_type_note_aff", function() {
        
	    getAttrs(["damage_type_note_aff"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Affliction (aff)", values.damage_type_note_aff);
	        
	        updateRangedCombatWoundNotes("Affliction (aff)", values.damage_type_note_aff);
	        
	        updateCombatToolThrownDamageType("Affliction (aff)", values.damage_type_note_aff);
	        
	    });
	    
    });
    
    on("change:damage_type_note_burn", function() {
        
	    getAttrs(["damage_type_note_burn"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Burning (burn)", values.damage_type_note_burn);
	        
	        updateRangedCombatWoundNotes("Burning (burn)", values.damage_type_note_burn);
	        
	        updateCombatToolThrownDamageType("Burning (burn)", values.damage_type_note_burn);
	        
	    });
	    
    });
    
    on("change:damage_type_note_cor", function() {
        
	    getAttrs(["damage_type_note_cor"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Corrosion (cor)", values.damage_type_note_cor);
	        
	        updateRangedCombatWoundNotes("Corrosion (cor)", values.damage_type_note_cor);
	        
	        updateCombatToolThrownDamageType("Corrosion (cor)", values.damage_type_note_cor);
	        
	    });
	    
    });
    
    on("change:damage_type_note_fat", function() {
        
	    getAttrs(["damage_type_note_fat"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Fatigue (fat)", values.damage_type_note_fat);
	        
	        updateRangedCombatWoundNotes("Fatigue (fat)", values.damage_type_note_fat);
	        
	        updateCombatToolThrownDamageType("Fatigue (fat)", values.damage_type_note_fat);
	        
	    });
	    
    });
    
    on("change:damage_type_note_tox", function() {
        
	    getAttrs(["damage_type_note_tox"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Toxic (tox)", values.damage_type_note_tox);
	        
	        updateRangedCombatWoundNotes("Toxic (tox)", values.damage_type_note_tox);
	        
	        updateCombatToolThrownDamageType("Toxic (tox)", values.damage_type_note_tox);
	        
	    });
	    
    });
    
    on("change:damage_type_note_spec", function() {
        
	    getAttrs(["damage_type_note_spec"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Special (spec)", values.damage_type_note_spec);
	        
	        updateRangedCombatWoundNotes("Special (spec)", values.damage_type_note_spec);
	        
	        updateCombatToolThrownDamageType("Special (spec)", values.damage_type_note_spec);
	        
	    });
	    
	});
	
	on("change:damage_type_note_knockback", function() {
        
	    getAttrs(["damage_type_note_knockback"], function(values) {
	        
	        updateMeleeCombatWoundNotes("Knockback (knock)", values.damage_type_note_knockback);
	        
	        updateRangedCombatWoundNotes("Knockback (knock)", values.damage_type_note_knockback);
	        
	        updateCombatToolThrownDamageType("Knockback (knock)", values.damage_type_note_knockback);
	        
	    });
	    
    });
    
    /**
     * Update the damage types for repeating tables
     * Find damage types that match the one that was updated.
     * Replace the note with the new note.
     * 
     * @param damageType Type of damage to update
     * @param damageNote Damage note to use
     */
    function updateMeleeCombatWoundNotes(damageType, damageNote) {
        
        var updateAttrs = {};
        
        // repeating_melee | repeating_ranged
        
		getSectionIDs("repeating_melee", function (ids) {
		
			if (ids.length === 0 ) {
				return;
			}
		
		    var getFields = [];
		        
		    // loop through the rows
			for (var i = 0; i < ids.length; i++) {
		
		        // field that determines defense type
                var damageTypeField = "repeating_melee_" + ids[i] + '_type';
				
				getFields.push(damageTypeField);
				
			}
			
			getAttrs(getFields, function (values) {
			    
			    var updateFields = {};
			    
		        // loop through the row ids again so we can get the values
		        // and fill array of defense_type id numbers
		        _.each(ids, function(id) {
		        
		            var damageTypeField = "repeating_melee_" + id + '_type';
			
			        // field we need to update
			        var fieldToUpdate = "repeating_melee_" + id + '_damage_type_note';
			        
		            var damageTypeValue = values[damageTypeField];
		            
		            if (damageTypeValue === damageType) {
		                
		                // update the defense type id number
		                updateFields[fieldToUpdate] = damageNote;
		                
		            }
		            
                });
                
				setAttrs(updateFields);
			    
			});
			
		});
        
    }
    
    /**
     * Update the damage types for repeating tables
     * Find damage types that match the one that was updated.
     * Replace the note with the new note.
     * 
     * @param damageType Type of damage to update
     * @param damageNote Damage not to use
     */
    function updateRangedCombatWoundNotes(damageType, damageNote) {
        
        var updateAttrs = {};
        
		getSectionIDs("repeating_ranged", function (ids) {
		
			if (ids.length === 0 ) {
				return;
			}
		
		    var getFields = [];
		        
		    // loop through the rows
			for (var i = 0; i < ids.length; i++) {
		
		        // field that determines defense type
                var damageTypeField = "repeating_ranged_" + ids[i] + '_type';
				
				getFields.push(damageTypeField);
				
			}
			
			getAttrs(getFields, function (values) {
			    
			    var updateFields = {};
			    
		        // loop through the row ids again so we can get the values
		        // and fill array of defense_type id numbers
		        _.each(ids, function(id) {
		        
		            var damageTypeField = "repeating_ranged_" + id + '_type';
			
			        // field we need to update
			        var fieldToUpdate = "repeating_ranged_" + id + '_damage_type_note';
				    
		            var damageTypeValue = values[damageTypeField];
		            
		            if (damageTypeValue === damageType) {
		                
		                // update the defense type id number
		                updateFields[fieldToUpdate] = damageNote;
		            
		            }
		            
                });
                
				setAttrs(updateFields);
			    
			});
			
		});
        
    }
    
    /**
     * Update the damage type now for the combat tool thrown damage
     * 
     * @param damageType
     * @param damageNote
     */
    function updateCombatToolThrownDamageType(damageType, damageNote) {
    
        getAttrs(["thrown_object_damage_type"], function (values) {
            
            if (damageType === values.thrown_object_damage_type) {
                
                setAttrs({ 
                    "thrown_object_damage_type_note": damageNote,
                });
            
            }
            
        });
        
    }
    
    on("change:repeating_defense:info", function(event) {
        
        updateDefenseNote();
        
    });
    
    /**
     * Update the defense note.
     */
    function updateDefenseNote() {

        getAttrs(['repeating_defense_info'], function(values) {

            var defenseInfo = "";

            if (values) {
                defenseInfo = values.repeating_defense_info;
            }

            var note = getDefenseNote(defenseInfo);

            // update the note
            setAttrs({
                repeating_defense_info_description: note
            });

        });

    }

    /**
     * Get defense note based on initial defense info field
     * 
     * @param defenseInfo
     * 
     * @return string
     */
    function getDefenseNote(defenseInfo) {

        var note = "";

        if (defenseInfo) {

            switch(defenseInfo.toLowerCase()) {

                case "u":
                    note = "Info: U\nThe weapon is unbalanced. You cannot use it to parry if you've already attacked with it this turn.\nSee B208";
                    break;

                case "f":
                    note = "Info: F\nThis is a fencing weapon. +3 to retreat, instead of +1. -2 for each additional parry for the round.\nSee B208";
                    break;

            }

        }

        return note;

    }

	/**
	 * Update the static defense success/fail notes
	 */
	function updateStaticDefenseNotes() {

		const fields = {
			"raw_dodge_success_notes":                  getDefenseNotesByCode("dodge_success_notes"),
			"raw_dodge_critical_success_notes":         getDefenseNotesByCode("dodge_critical_success_notes"),
			"raw_dodge_fail_notes":                     getDefenseNotesByCode("dodge_fail_notes"),
			"raw_dodge_critical_fail_notes":            getDefenseNotesByCode("dodge_critical_failure_notes"),
			"raw_dodge_retreat_success_notes":          getDefenseNotesByCode("dodge_success_notes"),
			"raw_dodge_retreat_critical_success_notes": getDefenseNotesByCode("dodge_critical_success_notes"),
			"raw_dodge_retreat_fail_notes":             getDefenseNotesByCode("dodge_fail_notes"),
			"raw_dodge_retreat_critical_fail_notes":    getDefenseNotesByCode("dodge_critical_failure_notes"),
			"raw_dodge_drop_success_notes":             getDefenseNotesByCode("dodge_success_notes"),
			"raw_dodge_drop_critical_success_notes":    getDefenseNotesByCode("dodge_critical_success_notes"),
			"raw_dodge_drop_fail_notes":                getDefenseNotesByCode("dodge_fail_notes"),
			"raw_dodge_drop_critical_fail_notes":       getDefenseNotesByCode("dodge_critical_failure_notes"),
		};

		setAttrs(fields);

	}
    
    /**
     * If new version, make sure to update the 
     * defensive informaton notes and the raw success/fail notes
     */
    function updateRepeatingDefenseNotes() {
        
        getSectionIDs("repeating_defense", function (ids) {
		
			if (ids.length === 0 ) {
				return;
			}
		
			let getFields = [];

		    // loop through the rows
			for (var i = 0; i < ids.length; i++) {
		
		        // field that determines defense info box
                let defenseInfoField = "repeating_defense_" + ids[i] + "_info";
				
				getFields.push(defenseInfoField);

				// field that determines defense type
				let defenseTypeField = "repeating_defense_" + ids[i] + "_type";

				getFields.push(defenseTypeField);
				
			}

			getAttrs(getFields, function (values) {
			    
			    let updateFields = {};

		        // loop through the row ids again so we can get the values
		        // and fill array of defense_type id numbers
		        _.each(ids, function(id) {
		        
		            let infoField = "repeating_defense_" + id + "_info";
			
			        // field we need to update
			        let fieldToUpdate = "repeating_defense_" + id + "_info_description";
				    
		            let infoValue = values[infoField];
		            
		            // update the defense type id number
		            updateFields[fieldToUpdate] = getDefenseNote(infoValue);

					// active defense RAW notes
					let typeField = "repeating_defense_" + id + "_type";

					let rawNotes = getRawDefenseNotesByType(values[typeField]);

					updateFields["repeating_defense_" + id + "_raw_success_note"] = rawNotes.success;
		            
					updateFields["repeating_defense_" + id + "_raw_critical_success_note"] = rawNotes.successCritical;

					updateFields["repeating_defense_" + id + "_raw_fail_note"] = rawNotes.fail;

					updateFields["repeating_defense_" + id + "_raw_critical_fail_note"] = rawNotes.failCritical;
		            
                });

				setAttrs(updateFields);
			    
			});
			
		});
        
    }
    
    on("change:repeating_item:carried", function(event) {
        
        markItemRowAsCarried();
        
    });
    
    /**
     * Update the hidden input field on/off
     * If ON, the row will bold the weight text.
     * 
     */
    function markItemRowAsCarried() {
        
        getAttrs(["repeating_item_carried"], function(values) {
            
            setAttrs({
                "repeating_item_inventory_item_carried": values.repeating_item_carried
            });
            
        });
        
    }
    
    /**
     * Returns min. damage note based on damage type
     * Crush = min. of 0
     * others = min. of 1
     *  
     * @param string damageTypeValue
     * 
     * @return string
     */
    function getMinimumDamageNote(damageTypeValue) {
        
        var minDamageNote = "";
        
        if (damageTypeValue === "Crushing (cr)") {
		                
            minDamageNote = "Min 0";
            
        } else {
            
            minDamageNote = "Min 1";
        
        }
        
        return minDamageNote; 
        
    }
    
    on("change:turning_move_type change:start_velocity change:current_move change:enhanced_move_current change:current_air change:current_water change:change_velocity", function(event) {
        
        updateTurnRadiusMovements();
        
    });
    
    /**
     * Updates the turn radius and deceleration for selected movement type
     * based on velocity.
     * 
     */
    function updateTurnRadiusMovements() {
        
        getAttrs(["turning_move_type", "start_velocity", "current_move", "enhanced_move_current", "current_air", "current_water", "change_velocity"], function(values) {
            
            var moveType = values.turning_move_type;
            
            var velocityStart = Number(values.start_velocity);
            
            var velocityChange = Number(values.change_velocity);
            
            var velocityFinal = 0;
            
            var baseMove = 0;
            
            var turnRadius = 0;
            
            var tightTurnPenalty = 0;
            
            var decelerationPenalty = 0;
            
            if (velocityStart < 0) {
                velocityStart = 0;
            }
            
            velocityFinal = velocityStart + velocityChange;
            
            if ( isNaN(velocityFinal) || velocityFinal < 0) {
                velocityFinal = 0;
            }
            
            // get turn penalty based on type.
            switch ( moveType.toLowerCase() ) {
                
                case "ground":
                    
                    if ( values.enhanced_move_current === "0" ) {
                        
                        // normal move, no tight turn penalty
                        tightTurnPenalty = 0;
                        
                        baseMove = getBaseMove(values.current_move);
                        
                    } else {
                        
                        baseMove = getBaseMove(values.enhanced_move_current);
                        
                        // enhanced move has tight turn penalty
                        tightTurnPenalty = getTightTurnPenalty(velocityFinal, baseMove);
                        
                    }
                    break;
                    
                case "air":
                    
                    baseMove = getBaseMove(values.current_air);
					
                    tightTurnPenalty = getTightTurnPenalty(velocityFinal, baseMove);
					
                    break;
                    
                case "water":
                    baseMove = getBaseMove(values.current_water);
                    
                    tightTurnPenalty = getTightTurnPenalty(velocityFinal, baseMove);
                    break;
                
                default:
                    baseMove = 0;
                    
                    tightTurnPenalty = 0;
            }
			
            // --
            if (velocityChange < 0) {
            
                decelerationPenalty = getDecelerationPenalty(velocityChange, baseMove, velocityFinal);
                
            } else {
                
                decelerationPenalty = 0;
                
            }
			
            // --
            if (baseMove && velocityFinal) {
                
                turnRadius = velocityFinal/baseMove;
                
                if (turnRadius <= 1) {
                    turnRadius = 1;
                } else {
                    turnRadius = Math.floor(turnRadius);
                }
                
            } else {
                turnRadius = 1;
            }
            
            setAttrs({
                "final_velocity": velocityFinal,
                "deceleration_penalty": decelerationPenalty,
                "turn_radius": turnRadius,
                "tight_turn_penalty": tightTurnPenalty,
            });
            
        });
        
    }
    
    /**
	 * Calculate deceleration penalty
	 * See B395
     * -1 per two full yards/second beyond basic move
     * 
     * @param int deceleration How much is thing/vehicle slows down by
     * @param int baseMove     base move. 
     * 
     * @return int
     */
    function getDecelerationPenalty(deceleration, baseMove) {
        
        // deceleration needs to be a postive number
        if (deceleration < 0) {
            deceleration = -1 * deceleration;
        }
        
        let difference = 0;
        
        let penalty = 0;
		
		// only get penalty if deceleration is greater than base move
		if (deceleration > baseMove) {

			// example: deceleration = 10, baseMove = 3
			//          difference = 10 - 3 = 7
			//          penalty = 7/2 = -3
			difference = deceleration - baseMove;
			
			// note: decelerationDivisor is a constant declared at top of javascript 
			penalty = -1 * Math.floor(difference/decelerationDivisor);
			
		}
        
        return penalty;
    }
    
    /**
     * Gets base move from a number or two values.
     * If move = 8/16, basemove = 8.
     * If move = 8, basemove = 8.
     * If move = 8/16 (1), basemove = 8.
     * if move = 8 (1), basemove = 8.
     */
    function getBaseMove(moveValue) {
        
        var move = 0;
        
        if (moveValue) {
    
            // Remove number in parentheses
            moveValue = moveValue.toString().replace(/ *\([^)]*\)/g, "");

            if (moveValue.includes("/")) {
              
                // split the value
                // move = 8/16
                // 8 = base move
                // 16 = enhanced move
                arrMoveValue = moveValue.split("/");
                
                // get first part, convert to number
                move = Number(arrMoveValue[0]);
                
            } else {
                
                move = Number(moveValue);
                
            }
            
        }

        if (isNaN(move)) {
            move = 0;
        }

        return move;
    }
    
    /**
     * Determines max velocity for a movement type.
     * Entered move can't exceed move value.
     * Example moveValue = 8/16
     *   if enteredMove = 8, then use it
     *   if enteredMove = 20, then use 16
     * @param string moveValue   Example: 8/16 or 8
     * @param string enteredMove Velocity entered by user
     * 
     * @return int
     */
    function getMaxVelocity(moveValue, enteredMove) {
        
        var maxVelocity = 0;
        
        var move = 0;
        
        var arrMoveValue;
        
        if ( moveValue && moveValue.toString().includes("/") ) {
                
            // split the value
            // move = 8/16
            // 8 = base move
            // 16 = max move
            arrMoveValue = moveValue.split("/");
            
            // get second part, convert to number
            move = +arrMoveValue[1];
            
        } else {
            
            move = +moveValue;
            
        }
        
        // i.e. entered move = 20, top speed = 16
        // if 20 > 16, then use 16
        if (enteredMove > move ) {
            
            maxVelocity = move;
            
        } else {
            
            maxVelocity = enteredMove;
            
        }
        
        return maxVelocity;
        
    }
    
    /**
     * Determines the tight turn penalty
     * 
     * @param int    velocity  Current velocity
     * @param string baseMove Base move used to determine turn penalty
     * 
     * @return int
     */
    function getTightTurnPenalty(velocity, baseMove) {
        
        var penalty = 0;
        
		var arrMoveValue;
		
        if ( isNaN(baseMove) || velocity === 0 || velocity <= baseMove || baseMove === 0 ) {
            
            penalty = 0;
            
		} else {
            
            let difference = velocity - baseMove;
            
            penalty = Math.floor(difference/baseMove) * -1;
            
        }
        
        return penalty;
    }
    
    // check if skill level mirror changed, if so update repeating sections that match the item that changed
    on("change:repeating_skills:level_mirror", function(event) {
          
        var rowId = getRowIdFromEventInfo(event, "repeating_skills");
        
        updateSectionSkillsLinkedToUpdatedRow(rowId);
        
    });
    
    // check if spell level mirror changed
    on("change:repeating_spells:level_mirror", function(event) {
        
		var rowId = getRowIdFromEventInfo(event, "repeating_spells");
        
		updateSectionSkillsLinkedToUpdatedRow(rowId);
        
	});
	
	// check if technique level changed
	on("change:repeating_techniquesrevised:level", function(event) {
        
        var rowId = getRowIdFromEventInfo(event, "repeating_techniquesrevised");
        
		updateSectionSkillsLinkedToUpdatedRow(rowId);
        
    });

	// if an attribute is updated, update linked items
	on("change:strength_display", event => {

		updateSectionSkillsLinkedToUpdatedRow("ST");

	});

	on("change:striking_st", event => {

		updateSectionSkillsLinkedToUpdatedRow("STRIKING");

	});

	on("change:dexterity", event => {

		updateSectionSkillsLinkedToUpdatedRow("DX");

	});

	on("change:intelligence", event => {

		updateSectionSkillsLinkedToUpdatedRow("IQ");

	});

	on("change:willpower", event => {

		updateSectionSkillsLinkedToUpdatedRow("WILL");

	});

	on("change:health", event => {

		updateSectionSkillsLinkedToUpdatedRow("HT");

	});

	on("change:dodge", event => {

		updateSectionSkillsLinkedToUpdatedRow("DODGE");

	});

	on("change:basic_speed", event => {

		updateSectionSkillsLinkedToUpdatedRow("SPEED");

	});

	// check if melee level changed
    on("change:repeating_melee:skill", function(event) {
        
		var rowId = getRowIdFromEventInfo(event, "repeating_melee");
        
		updateSectionSkillsLinkedToUpdatedRow(rowId);
        
	});

	/**
	 * Checks to see if the knockback defense skill is linked to this rowId
	 *
	 * @param string rowId Row ID of a skill or the Attribute that might be linked to a weapon
	 */
	function updateKnockbackLinkedToRow(rowId) {

		let fields = ["knockback_defense_row_type", "defense_knockback_skill_row_id"];

		getAttrs(fields, values => {

			let updateFields = {};

			// convert the values object into an array
			let entries = Object.entries(values);

			// loop through each entry
			for (const [field, value] of entries) {

				// NOTE: This match based on either skill/technique ID or against an attribute
				// the field name lets us know which.
				if (value == rowId) {

					updateLinkedKnockbackSkill();

					break; // we found a match, no reason to continue

				}

			}

		});

	}
    
    /**
     * Finds repeating sections that are linked to the rowId or attribute value
	 * Then triggers the toggle for the repeating section that tells it to update 
	 * the skill level.
     * 
     * @param string rowId Row ID of a skill or the Attribute that might be linked to a weapon  
     */
    function updateSectionSkillsLinkedToUpdatedRow(rowId) {
        
        let sections = [
			{sectionName: "repeating_melee", prefix: "melee"},
			{sectionName: "repeating_ranged", prefix: "ranged"},
			{sectionName: "repeating_techniquesrevised", prefix: "technique"},
			{sectionName: "repeating_defense", prefix: "defense"}
		];
		
		// loop through each section and update items that match the rowId
		sections.forEach((section) => {

			toggleRepeatingSectionLinkedToRow(rowId, section.sectionName, section.prefix)

		});
		
		updateKnockbackLinkedToRow(rowId);

    }

	/**
	 * Loop throuch item in a repeating section. If row type OR skill row id 
	 * matches the rowID value, then mark that row as needing to update.
	 * This will trigger the skill level for that repeating section
	 *
	 * @param string rowId       A skill/spell/technique row id or an attribute, like ST, DX, IQ, etc.
	 * @param string sectionName Repeating section to loop through
	 * @param string prefix      The prefix used for the field names in that section
	 */
	function toggleRepeatingSectionLinkedToRow(rowId, sectionName, prefix) {

		// find items in this repeating section that use the skill/technique/attribute
		getSectionIDs(sectionName, function(ids) {
			
			// a list of data fields
			let fields = [];
		
			// loop through each row
			_.each(ids,function(id) {
			
				// example: repeating_melee_-m1z2saaqh577ah99q6d_skill_row_id
				let linkedRowId = `${sectionName}_${id}_${prefix}_skill_row_id`;
				
				let linkedType = `${sectionName}_${id}_${prefix}_row_type`;
				
				fields.push(linkedRowId);

				fields.push(linkedType);
				
			});

			// lets get all the values
			getAttrs(fields, values => {

				let updateFields = {};

				// convert the values object into an array
				let entries = Object.entries(values);

				let foundMatch = false;

				// loop through each entry
				for (const [field, value] of entries) {

					// NOTE: This match based on either skill/technique ID or against an attribute
					// the field name lets us know which.
					if (value == rowId) {

						// we have a match, get the row id
						// example: repeating_melee_-m1z2saaqh577ah99q6d_skill_row_id
						// split = ["repeating", "melee", "-m1z2saaqh577ah99q6d", "skill", "row", "id"]
						let arrField = field.split("_");

						// the id will always be the 3rd element
						let currentId = arrField[2];

						// toggle the update field for that row
						let toggleField = `${sectionName}_${currentId}_${prefix}_skill_row_id_toggle`;

						updateFields[toggleField] = 1;

						// we have at least one match
						foundMatch = true;

					}

					if (foundMatch) {

						// don't run silently, the toggle fields forces the row to update the skill level
						setAttrs(updateFields);

					}

				}

			});

		});

	}

	/**
	 * finds the row id for an on change event and repeating section name
	 *
	 * @param object event       A change event object
	 * @param string sectionName The name of a repeating section
	 */
    function getRowIdFromEventInfo(event, sectionName) {
        
        var rowId = "";
        
        // example: repeating_skills_-l6zk36zhcjhsyvc-kax_level_mirror
        var sourceAttr = event.sourceAttribute;
		
		if (sourceAttr) {

			// remove the sectionname
			var regReplace = new RegExp(sectionName+ '_', "ig");
			
			// example: -l6zk36zhcjhsyvc-kax_level_mirror
			sourceAttr = sourceAttr.replace(regReplace, "");
			
			// now split by the _
			var arrSource = sourceAttr.split("_");
			
			// first element should be rowId
			rowId = arrSource[0];
			
			rowId = rowId.toLowerCase();

		}
        
        return rowId;
        
	}

	/**
	 * finds the row id for row field key for a repeating section name
	 * example:  repeating_skills_-l6zk36zhcjhsyvc-kax_level_mirror
	 * 
	 * @param object fieldKey    Field Key name
	 * @param string sectionName The name of a repeating section
	 */
	 function getRowIdFromRowFieldKey(fieldKey, sectionName) {
		
		 // repeating_skills_-l6zk36zhcjhsyvc-kax_level_mirror
		if (fieldKey) {

			// remove the sectionname
			var regReplace = new RegExp(sectionName+ '_', "ig");
			
			// example: -l6zk36zhcjhsyvc-kax_level_mirror
			fieldKey = fieldKey.replace(regReplace, "");
			
			// now split by the _
			let arrKey = fieldKey.split("_");
			
			// first element should be rowId
			rowId = arrKey[0];
			
			rowId = rowId.toLowerCase();

		}
        
        return rowId;
        
	}
	
	/**
	 * Simplified function to get section name and row id based on event
	 * see: https://roll20.zendesk.com/hc/en-us/articles/360037773513-Sheet-Worker-Scripts#events-0-3
	 * 
	 * @param object event Event Info triggered by an action
	 *
	 * @return array [sectioName, rowId]
	 */
	function getSectionRowIdFromChangeEvent(event) {

		// example: repeating_spells_-mi2gev09xkxzckxltdw
		let triggerName = event.triggerName;

		// split into an array
		// example: ["repeating", "spells", "-mi2gev09xkxzckxltdw"]
		let arrName = triggerName.split("_");

		let rowId = arrName.pop();

		rowId = rowId.toLowerCase();

		let sectionName = `${arrName[0]}_${arrName[1]}`;

		sectionName = sectionName.toLowerCase();

		return [sectionName, rowId];

	}
    
    // if linked data for repeating range changes update the skill level
	on('change:repeating_ranged:ranged_row_type change:repeating_ranged:ranged_skill_row_id change:repeating_ranged:ranged_skill_row_id_modifier change:repeating_ranged:ranged_skill_row_id_toggle', function(event){

		getAttrs(["repeating_ranged_ranged_row_type"], function(values) {
        
            updateLinkedWeaponSkill("repeating_ranged", "ranged", values.repeating_ranged_ranged_row_type, "", 0);
    		
        });
		
		
	});
	
	// if linked data for repeating melee changes update the skill level
	on('change:repeating_melee:melee_row_type change:repeating_melee:melee_skill_row_id change:repeating_melee:melee_skill_row_id_modifier change:repeating_melee:melee_skill_row_id_toggle', function(event){

        getAttrs(["repeating_melee_melee_row_type"], function(values) {
        
            updateLinkedWeaponSkill("repeating_melee", "melee", values.repeating_melee_melee_row_type, "", 0);
    		
        });
        
	});

	// if linked data for repeating techniques changes update the skill level
	on('change:repeating_techniquesrevised:technique_row_type change:repeating_techniquesrevised:technique_skill_row_id change:repeating_techniquesrevised:technique_skill_row_id_toggle', function(event){

		getAttrs(["repeating_techniquesrevised_technique_row_type"], function(values) {

			updateLinkedWeaponSkill("repeating_techniquesrevised", "technique", values.repeating_techniquesrevised_technique_row_type, "", 0);
			
		});

	});

	// if linked data for repeating defense is changed, get the new linked skill values
	on('change:repeating_defense:type change:repeating_defense:defense_row_type change:repeating_defense:defense_talent_level change:repeating_defense:defense_skill_row_id change:repeating_defense:defense_skill_row_id_toggle', function(event){

		getAttrs(["repeating_defense_defense_row_type", "repeating_defense_type", "repeating_defense_defense_talent_level"], function(values) {

			updateLinkedWeaponSkill("repeating_defense", "defense", values.repeating_defense_defense_row_type, values.repeating_defense_type, +values.repeating_defense_defense_talent_level);
			
		});

	});

	// if linked information changed for Knockback save, update the base skill level
	on('change:knockback_defense_row_type change:defense_knockback_skill_row_id', (event) => {

		updateLinkedKnockbackSkill();

	});

	/**
	 * Update the Knockback skill based on selected attribute and/or skill
	 *
	 * @param function callBack Optional call back function
	 */
	function updateLinkedKnockbackSkill(callback) {

		// check if we need to set default value
		callback = callback || noop;

		getAttrs(["knockback_defense_row_type", "defense_knockback_skill_row_id"], (values) => {

			let rowType = values.knockback_defense_row_type;

			let skillRowId = values.defense_knockback_skill_row_id;

			let skillMod = +values.ad_knockback_skill_mod;

			let {updateMethod, repeatingTableToUse} = getLinkedSkillUpdateMethod(rowType);

			let skillName = "";

			let skillLevel = "";

			let updateFields = {};
		        
			// if updating using a repeating field AND no row id, clear the fields
		    if (updateMethod != "attribute" && skillRowId.length === 0 ) {
		        
				updateFields["defense_knockback_skill_row_id_message"] = "";
    	            
    	        updateFields["defense_knockback_skill_row_id_level"] = "";

    	        setAttrs(updateFields, {silent: false}, callback);
    	        
			} else if (updateMethod == "attribute") {

				updateLinkedKnockbackSkillByAttribute(rowType, callback);
				
			} else {

				updateLinkedKnockbackSkillByTable(repeatingTableToUse, skillRowId, rowType, callback);

			}
							
		});

	}

	/**
	 * Update the melee, ranged, or technique associated with the skill row id
	 * 
	 * @param string sectionName Should be either repeating_melee or repeating_ranged
	 * @param string prefix      Placed before skill attribute names to follow rules for unique names, even inside repeating sections.
	 * @param string rowType     Where to get the level. Skill | Spell 
	 * @param string defenseType If there's a defense type (Parry, Dodge, etc.) a formula will be used to calculate the skill level
	 * @param int    talentLevel Used with defense type to calculate skill level
	 * @param object callback    A function to run after everything is done
	 */
	function updateLinkedWeaponSkill(sectionName, prefix, rowType, defenseType, talentLevel, callback) {
		
		callback = callback || noop;
		
		let {updateMethod, repeatingTableToUse} = getLinkedSkillUpdateMethod(rowType);

		let skillRowIdFieldName = `${sectionName}_${prefix}_skill_row_id`;
	    
	    let skillRowModFieldName = `${sectionName}_${prefix}_skill_row_id_modifier`;
	    
	    let skillMessageFieldName = `${sectionName}_${prefix}_skill_row_id_message`;
	    
		let skillMessageFieldLevel = `${sectionName}_${prefix}_skill_row_id_level`;
		
		// for updating technique values
		let parentFieldName = `${sectionName}_parent`;
		        
		// for updating technique values
		let baseSkillFieldName = `${sectionName}_base_level`;
		
	    let weaponSkillFieldName = `${sectionName}_skill`;
	    
	    // if this gets changed, then the update linked weapon skill gets triggered
	    let skillRowIdToggleFieldName = `${sectionName}_${prefix}_skill_row_id_toggle`;
	    
	    getAttrs([skillRowIdFieldName,
		          skillRowModFieldName
		         ], function(values) {
			
		    let skillRowId = values[skillRowIdFieldName];
		    
			let skillMod = Number(values[skillRowModFieldName]);
			
			if (isNaN(skillMod)) {
				skillMod = 0;
			}
		    
		    // if updating using a repeating field make sure there's a row id to search for
		    if (updateMethod != "attribute" && skillRowId.length === 0 ) {
		        
		        // clear the field
		        let updateFields = {};
		        
		        updateFields[skillMessageFieldName] = ``;
    	            
    	        updateFields[skillMessageFieldLevel] = "";
    	        
    	        setAttrs(updateFields, {silent: false}, callback);
    	        
			} else if (updateMethod == "attribute") {

				updateLinkWeaponSkillByAttribute(sectionName, skillRowIdFieldName, weaponSkillFieldName, skillMessageFieldName, skillMessageFieldLevel, skillRowIdToggleFieldName, parentFieldName, baseSkillFieldName, rowType, skillMod, defenseType, talentLevel, callback);
			
			} else {
		        
				updateLinkedWeaponSkillByRepeatingRow(sectionName, weaponSkillFieldName, skillMessageFieldName, skillMessageFieldLevel, skillRowIdToggleFieldName, parentFieldName, baseSkillFieldName, repeatingTableToUse, skillRowId, skillMod, defenseType, talentLevel, callback);
			  
		    }

		});
	    
	}

	/**
	 * Returns method and repeating table to use
	 * 
	 * @param string rowType What type of skill/attribute are we linking to.
	 * @return object {updateMethod, repeatingTableToUse}
	 */
	function getLinkedSkillUpdateMethod(rowType) {

		// can be repeating | attribute
		let method = "repeating";

		let table = ""; 

	    switch (rowType) {
	        
			case "ST":
				method = "attribute";
				break;

			case "STRIKING":
				method = "attribute";
				break;

			case "DX":
				method = "attribute";
				break;

			case "IQ":
				method = "attribute";
				break;

			case "WILL":
				method = "attribute";
				break;

			case "HT":
				method = "attribute";
				break;

			case "DODGE":
				method = "attribute";
				break;

			case "SPEED":
				method = "attribute";
				break;

	        case "10":
				method = "attribute";
				break;

	        case "Technique":
				table = "repeating_techniquesrevised";
	            break;
	            
	        case "Spell":
				table = "repeating_spells";
	            break;
	            
			case "Melee":
				table = "repeating_melee";
	            break;
	            
	        case "Skill":
	        default:
				table = "repeating_skills";
	            break;
	            
		}

		let objMethod = {
			updateMethod: method,
			repeatingTableToUse: table
		};

		return objMethod;

	}
	
	/**
	 * Update the selected weapon skill by linking to another skill, technique, spell, or melee weapon
	 * 
	 * @param string   sectionName               Name of section that is getting udpated
	 * @param string   weaponSkillFieldName      For Weapon that is getting updated
	 * @param string   skillMessageFieldName     For Weapon that is getting updated
	 * @param string   skillMessageFieldLevel    For Weapon that is getting updated
	 * @param string   skillRowIdToggleFieldName For Weapon that is getting updated
	 * @param string   parentFieldName           For Weapon that is getting updated
	 * @param string   baseSkillFieldName        For Weapon that is getting updated
	 * @param string   repeatingTableToUse       Which table to get the skill level from
	 * @param string   skillRowId                Row Id that will get updated
	 * @param int      skillMod                  Modifier to skill level 
	 * @param string   defenseType				 Used by active defense to determine skill calculation formula
	 * @param int      talentLevel				 Talent level is used by active defense to determine skill calculation formula
	 * @param function callback                  Callback function 
	 */
	function updateLinkedWeaponSkillByRepeatingRow(sectionName, weaponSkillFieldName, skillMessageFieldName, skillMessageFieldLevel, skillRowIdToggleFieldName, parentFieldName, baseSkillFieldName, repeatingTableToUse, skillRowId, skillMod, defenseType, talentLevel, callback)
	{
		// if it's a good row id, let's update stuff
		let skillFieldName = `${repeatingTableToUse}_${skillRowId}_level_mirror`;
		        
		let skillFieldNameOfSkill = `${repeatingTableToUse}_${skillRowId}_name`;
		
		// if we're getting values from the techniques table, don't use level_mirror
		if (repeatingTableToUse == "repeating_techniquesrevised" ) {

			skillFieldName = `${repeatingTableToUse}_${skillRowId}_level`;
		
		} else if (repeatingTableToUse == "repeating_melee") {

			skillFieldName = `${repeatingTableToUse}_${skillRowId}_skill`;

		}
		
		// update the skill level for weapon.
		getAttrs([skillFieldName, skillFieldNameOfSkill], function(skillValues) {

			let skillLevel = +skillValues[skillFieldName];
			
			let skillLevelFinal = skillLevel + skillMod;
			
			let updateFields = {};

			if (skillLevel > 0) {

				updateFields[weaponSkillFieldName] = skillLevelFinal;
			
				updateFields[skillMessageFieldName] = skillValues[skillFieldNameOfSkill];
				
				updateFields[skillMessageFieldLevel] = skillLevel;
				
				// reset toggle to zero
				updateFields[skillRowIdToggleFieldName] = 0;
				
				// if repeating_techniquesrevised, also update the Parent skill name and base skill level
				if (sectionName == "repeating_techniquesrevised") {

					updateFields[parentFieldName] = skillValues[skillFieldNameOfSkill];
				
					updateFields[baseSkillFieldName] = skillLevel;

				}
				
				// check for repeating active defense
				if (sectionName == "repeating_defense") {

					let calculatedSkillLevel = getCalculatedSkillByDefenseType(defenseType, talentLevel, skillLevel);

					updateFields["repeating_defense_defense_formula_level"] = calculatedSkillLevel;

					updateFields["repeating_defense_skill"] = calculatedSkillLevel;

				}

				setAttrs(updateFields, {silent: false}, callback);
				
			} else {

				updateFields[skillMessageFieldName] = `Could not find ${rowType}.`;
    	            
    	        setAttrs(updateFields, {silent: false}, callback);
    	        
			}
			
		});

	}

	/**
	 * Update the linked weapon skill by using an attribute stat
	 *
	 * @param string   sectionName               Name of section that is getting udpated
	 * @param string   skillRowIdFieldName       Copy the attribute used to this field.
	 * @param string   weaponSkillFieldName      For Weapon that is getting updated
	 * @param string   skillMessageFieldName     For Weapon that is getting updated
	 * @param string   skillMessageFieldLevel    For Weapon that is getting updated
	 * @param string   skillRowIdToggleFieldName For Weapon that is getting updated
	 * @param string   parentFieldName           For Weapon that is getting updated
	 * @param string   baseSkillFieldName        For Weapon that is getting updated
	 * @param string   rowType                   The attribute to use for setting weapon skill level
	 * @param int      skillMod                  Modifier to skill level
	 * @param string   defenseType				 Used by active defense to determine skill calculation formula
	 * @param int      talentLevel				 Talent level is used by active defense to determine skill calculation formula
	 * @param int      callBack 				 Callback function 
	 */
	function updateLinkWeaponSkillByAttribute(sectionName, skillRowIdFieldName, weaponSkillFieldName, skillMessageFieldName, skillMessageFieldLevel, skillRowIdToggleFieldName, parentFieldName, baseSkillFieldName, rowType, skillMod, defenseType, talentLevel, callback)
	{
		let fieldName;

		switch (rowType) {
			case "ST":
				fieldName = "strength_display";
				break;
		
			case "STRIKING":
				fieldName = "striking_st";
				break;
		
			case "DX":
				fieldName = "dexterity";
				break;
		
			case "IQ":
				fieldName = "intelligence";
				break;
		
			case "WILL":
				fieldName = "willpower";
				break;
		
			case "HT":
				fieldName = "health";
				break;
		
			case "SPEED":
				fieldName = "basic_speed";
				break;
		
			case "DODGE":
				fieldName = "dodge";
				break;
		
			case "10":
			default:
				fieldName = "base_attribute_level";
				break;
		}

		// update the skill level for weapon.
		getAttrs([fieldName], function(skillValues) {

			let skillLevel = +skillValues[fieldName];
			
			let skillLevelFinal = skillLevel + skillMod;
			
			let updateFields = {};

			updateFields[skillRowIdFieldName] = rowType;
		
			updateFields[weaponSkillFieldName] = skillLevelFinal;
			
			updateFields[skillMessageFieldName] = rowType;
			
			updateFields[skillMessageFieldLevel] = skillLevel;
			
			// reset toggle to zero
			updateFields[skillRowIdToggleFieldName] = 0;
			
			// if repeating_techniquesrevised, also update the Parent skill name and base skill level
			if (sectionName == "repeating_techniquesrevised") {

				updateFields[parentFieldName] = rowType;
			
				updateFields[baseSkillFieldName] = skillLevel;

			}

			// check for repeating active defense
			if (sectionName == "repeating_defense") {

				let calculatedSkillLevel = getCalculatedSkillByDefenseType(defenseType, talentLevel, skillLevel);

				updateFields["repeating_defense_defense_formula_level"] = calculatedSkillLevel;

				updateFields["repeating_defense_skill"] = calculatedSkillLevel;

			}

			setAttrs(updateFields);
			
		});
		
	} 
	
	/**
	 * Calculates the final active defense skill based on selected options
	 *
	 * @param string defenseType Type of defense that was selected
	 * @param int    talentLevel Level of talent used
	 * @param int    skillLevel  skill to base calculation on
	 * 
	 * @return int
	 */
	function getCalculatedSkillByDefenseType(defenseType, talentLevel, skillLevel)
	{
		let calculatedSkillLevel = skillLevel;

		switch (defenseType) {
			case "Parry":
			case "Unarmed Parry":
			case "Block":
				// 3 + (skilllevel/2) rounded down
				calculatedSkillLevel = 3 + (skillLevel/2);
				break;

			case "Power Dodge":
				// Basic Speed + 3 + Talent/2, rounded down. User's should select basic speed from drop-down
				calculatedSkillLevel = skillLevel + 3 + (talentLevel/2);
				break;
		
			case "Power Parry":
			case "Power Block":
			case "Power Block Mental":
				// 3 + ( (Innate attack skill + talent)/2). User's should select either HT or WILL from drop-down
				calculatedSkillLevel = 3 + ( (skillLevel + talentLevel)/2 );
				break;
		
			default:
				// no formula needed
				break;
		}

		calculatedSkillLevel = Math.floor(calculatedSkillLevel);
				
		return calculatedSkillLevel;

	}

	/**
	 * Update the linked knocked back skill by using an attribute stat
	 *
	 * @param string   rowType                   The attribute to use for setting weapon skill level
	 * @param function callback                  Callback function 
	 */
	function updateLinkedKnockbackSkillByAttribute(rowType, callback)
	{
		callback = callback || noop;

		let fieldName;

		switch (rowType) {
			case "ST":
				fieldName = "strength_display";
				break;
		
			case "STRIKING":
				fieldName = "striking_st";
				break;
		
			case "DX":
				fieldName = "dexterity";
				break;
		
			case "IQ":
				fieldName = "intelligence";
				break;
		
			case "WILL":
				fieldName = "willpower";
				break;
		
			case "HT":
				fieldName = "health";
				break;
		
			case "SPEED":
				fieldName = "basic_speed";
				break;
		
			case "DODGE":
				fieldName = "dodge";
				break;
		
			case "10":
			default:
				fieldName = "base_attribute_level";
				break;
		}

		// update the skill level for knockback save.
		getAttrs([fieldName], function(skillValues) {

			let skillLevel = +skillValues[fieldName];
			
			let updateFields = {};

			updateFields["defense_knockback_skill_row_id_message"] = rowType;
		
			updateFields["defense_knockback_skill_row_id_level"] = skillLevel;
			
			updateFields["ad_knockback_skill"] = skillLevel;
			
			setAttrs(updateFields, {silent: true}, callback);
    	    
		});
		
	} 

	/**
	 * Update the Knockback sill based on a repeating item
	 *
	 * @param string   repeatingTableToUse Name of table that contains the row id
	 * @param string   skillRowId          The Row that has the information we need for name and skill level to use
	 * @param string   rowType             Type of knockback defense
	 * @param function callBack            An optional call back function  
	 */
	function updateLinkedKnockbackSkillByTable(repeatingTableToUse, skillRowId, rowType, callback)
	{
		// if it's a good row id, let's update stuff
		let skillFieldName = `${repeatingTableToUse}_${skillRowId}_level_mirror`;
		        
		let skillFieldNameOfSkill = `${repeatingTableToUse}_${skillRowId}_name`;
		
		// if we're getting values from the techniques table, don't use level_mirror
		if (repeatingTableToUse == "repeating_techniquesrevised") {

			skillFieldName = `${repeatingTableToUse}_${skillRowId}_level`;
		
		}

		// update the skill level for weapon.
		getAttrs([skillFieldName, skillFieldNameOfSkill], function(skillValues) {

			let skillLevel = +skillValues[skillFieldName];
			
			let updateFields = {};

			// check for valid skill level
			if (skillLevel > 0) {
				
				updateFields["defense_knockback_skill_row_id_message"] = skillValues[skillFieldNameOfSkill];
				
				updateFields["defense_knockback_skill_row_id_level"] = skillLevel;
				
				updateFields["ad_knockback_skill"] = skillLevel;
				
				setAttrs(updateFields, {silent: false}, callback);
				
			} else {

				// show an error message
				updateFields["defense_knockback_skill_row_id_message"] = `Could not find ${rowType}.`;
					
				setAttrs(updateFields, {silent: true}, callback);
				
			}
			
		});
	}

	/**
	 * This function is used to make sure the repeating 
	 * skill levels are updated when the version has changed
	 */
	function updateRepeatingSkillLevels() {
	    
	    var sectionName = "repeating_skills";
	    
	    getSectionIDs(sectionName, function(ids) {
	        
	        updateSkillLevel(sectionName, ids);
	        
	    });
	    
	}
	
	/**
	 * Update the mirrored skill level when any field
	 * is updated for skill or spell
	 */
	function updateSkillLevel(sectionName, ids) {
	    
        _.each(ids,function(id) {
            
            var rowId = id;
	        
	        var baseFieldName = `${sectionName}_${id}_base`;
	        
	        var difficultyFieldName = `${sectionName}_${id}_difficulty`;
	        
	        var bonusFieldName = `${sectionName}_${id}_bonus`;
	        
	        var wildcardSkillPointsFieldName = `${sectionName}_${id}_wildcard_skill_points`;
	        
	        var useWildcardPointsFieldName = `${sectionName}_${id}_use_wildcard_points`;
	        
	        var pointsFieldName = `${sectionName}_${id}_points`;
	        
	        var useNormalPointsFieldName = `${sectionName}_${id}_use_normal_points`;
	        
            fields = [
	            baseFieldName,
	            difficultyFieldName,
	            bonusFieldName,
	            wildcardSkillPointsFieldName,
	            useWildcardPointsFieldName,
	            pointsFieldName,
	            useNormalPointsFieldName,
	            "strength",
	            "dexterity",
	            "intelligence",
	            "health",
	            "perception",
	            "willpower"
	        ];
	        
	        getAttrs(fields, function(values) {
	            
	            var base = getBaseSkillLevel(values[baseFieldName], values);
	            
	            var difficulty = values[difficultyFieldName];
	            
	            var bonus = +values[bonusFieldName];
	            
	            var wildcardSkillPoints = +values[wildcardSkillPointsFieldName];
	            
	            var useWildcardSkillPoints = +values[useWildcardPointsFieldName];
	            
	            var points = +values[pointsFieldName];
	            
	            var useNormalPoints = +values[useNormalPointsFieldName];
	            
	            // check for wildcard
	            if ( String(difficulty) === "-5 + 1") {
	                difficulty = -4;
	            } else {
	               difficulty = +difficulty; 
	            }
	            
	            var skillLevel = getSkillLevelUsingRaw(base, difficulty, bonus, wildcardSkillPoints, useWildcardSkillPoints, points, useNormalPoints);
	            
	            var fieldToUpdate = `${sectionName}_${rowId}_level_mirror`;
	            
	            var updateFields = {};
	            
	            updateFields[fieldToUpdate] = skillLevel;
	            
	            setAttrs(updateFields, {silent: false});
	            
	        });
	        
	    });
	    
	}

	/**
	 * Updates the skill level and the display of the row id
	 * 
	 * @param string section Repeating section name
	 * @param string rowId   Row id
	 *
	 * @return void
	 */
	function updateSkillLevelForRow(sectionName, rowId) {

		let baseFieldName = `${sectionName}_${rowId}_base`;
	        
		let difficultyFieldName = `${sectionName}_${rowId}_difficulty`;
		
		let bonusFieldName = `${sectionName}_${rowId}_bonus`;
		
		let wildcardSkillPointsFieldName = `${sectionName}_${rowId}_wildcard_skill_points`;
		
		let useWildcardPointsFieldName = `${sectionName}_${rowId}_use_wildcard_points`;
		
		let pointsFieldName = `${sectionName}_${rowId}_points`;
		
		let useNormalPointsFieldName = `${sectionName}_${rowId}_use_normal_points`;
		
		fields = [
			baseFieldName,
			difficultyFieldName,
			bonusFieldName,
			wildcardSkillPointsFieldName,
			useWildcardPointsFieldName,
			pointsFieldName,
			useNormalPointsFieldName,
			"strength",
			"dexterity",
			"intelligence",
			"health",
			"perception",
			"willpower"
		];
		
		getAttrs(fields, function(values) {
			
			let base = getBaseSkillLevel(values[baseFieldName], values);
			
			let difficulty = values[difficultyFieldName];
			
			let bonus = +values[bonusFieldName];
			
			let wildcardSkillPoints = +values[wildcardSkillPointsFieldName];
			
			let useWildcardSkillPoints = +values[useWildcardPointsFieldName];
			
			let points = +values[pointsFieldName];
			
			let useNormalPoints = +values[useNormalPointsFieldName];
			
			// check for wildcard
			if ( String(difficulty) === "-5 + 1") {
				difficulty = -4;
			} else {
				difficulty = +difficulty; 
			}
			
			let skillLevel = getSkillLevelUsingRaw(base, difficulty, bonus, wildcardSkillPoints, useWildcardSkillPoints, points, useNormalPoints);
			
			let fieldToUpdate = `${sectionName}_${rowId}_level_mirror`;

			let updateFields = {};
			
			updateFields[fieldToUpdate] = skillLevel;

			setAttrs(updateFields, {silent: false});
			
		});
	}
	
	function getBaseSkillLevel(baseFieldName, values) {
	    
	    var baseLevel = 10;
	    
	    switch(baseFieldName) {
	        
	        case "@{strength}":
	            baseLevel = +values.strength;
	            break;
	        
	        case "@{dexterity}":
	            baseLevel = +values.dexterity;
	            break;
	            
	        case "@{intelligence}":
	            baseLevel = +values.intelligence;
	            break;
	            
	        case "@{health}":
	            baseLevel = +values.health;
	            break;
	            
	        case "@{willpower}":
	            baseLevel = +values.willpower;
	            break;
	           
	        case "@{perception}":
	            baseLevel = +values.perception;
	            break;
	            
	        default:
	            baseLevel = 10;
	            break;
	            
	    }
	    
	    return baseLevel;
	}
	
	/**
	 * This function is used to make sure the repeating 
	 * skill levels are updated when the version has changed
	 */
	function updateRepeatingSpellLevels() {
	    
	    var sectionName = "repeating_spells";
	    
	    // get the base spell level and bonus
	    getAttrs(["spell_base", "spell_bonus"], function(values) {
	        
	        var spellBase = values.spell_base;
	        
	        var spellBonus = parseInt(values.spell_bonus);
	        
	        if ( isNaN(spellBonus) ) {
	            spellBonus = 0;
	        }
	        
    	    getSectionIDs(sectionName, function(ids) {
    	        
    	        updateSpellLevel( sectionName, ids, spellBase, spellBonus );
    	        
    	    });    
	        
	    });
	     
	}

	function updateSpellLevel(sectionName, ids, spellBase, spellBonus) {
	    
	    _.each(ids,function(id) {
            
            var rowId = id;
	        
	        var difficultyFieldName = `${sectionName}_${id}_difficulty`;
	        
	        var bonusFieldName = `${sectionName}_${id}_spell_modifier`;
	        
	        var pointsFieldName = `${sectionName}_${id}_points`;
	        
            fields = [
	            difficultyFieldName,
	            bonusFieldName,
	            pointsFieldName,
	            "strength",
	            "dexterity",
	            "intelligence",
	            "health",
	            "perception",
	            "willpower"
	        ];
	        
	        getAttrs(fields, function(values) {
	            
	            var base = getBaseSkillLevel(spellBase, values);
	            
	            var difficulty = +values[difficultyFieldName];
	            
	            var bonus = +values[bonusFieldName] + spellBonus;
	            
	            var points = +values[pointsFieldName];
	            
	            var skillLevel = getSkillLevelUsingRaw(base, difficulty, bonus, 0, false, points, true);
	            
	            var fieldToUpdate = `${sectionName}_${rowId}_level_mirror`;
	            
	            var updateFields = {};
	            
	            updateFields[fieldToUpdate] = skillLevel;
	             
	            setAttrs(updateFields, {silent: false});
	            
	        });
	        
	    });
	    
	}

	/**
	 * Update the spell level and display row id
	 * 
	 * @param string sectionName Repeating section name
	 * @param string rowId       Row Id that was updated
	 * 
	 * @return void
	 */
	function updateSpellLevelForRow(sectionName, rowId) {

		let difficultyFieldName = `${sectionName}_${rowId}_difficulty`;
	        
		let bonusFieldName = `${sectionName}_${rowId}_spell_modifier`;
		
		let pointsFieldName = `${sectionName}_${rowId}_points`;
		
		fields = [
			difficultyFieldName,
			bonusFieldName,
			pointsFieldName,
			"strength",
			"dexterity",
			"intelligence",
			"health",
			"perception",
			"willpower",
			"spell_base",
			"spell_bonus",
		];
		
		getAttrs(fields, function(values) {
			
			let spellBonus = parseInt(values.spell_bonus);
	        
	        if ( isNaN(spellBonus) ) {
	            spellBonus = 0;
	        }

			let base = getBaseSkillLevel(values.spell_base, values);
			
			let difficulty = +values[difficultyFieldName];
			
			let bonus = +values[bonusFieldName] + spellBonus;
			
			let points = +values[pointsFieldName];
			
			let skillLevel = getSkillLevelUsingRaw(base, difficulty, bonus, 0, false, points, true);
			
			let fieldToUpdate = `${sectionName}_${rowId}_level_mirror`;

			let updateFields = {};
			
			updateFields[fieldToUpdate] = skillLevel;
				
			setAttrs(updateFields, {silent: false});
			
		});

	}
	
	/**
	 * Calculate skill level using GURPS rules as written
	 * 
	 * @param int base       Base skill level
	 * @param int difficulty Modifier selected from drop-down
	 * @param int bonus      Modifier entered by user
	 * @param int 
	 * 
	 */
	function getSkillLevelUsingRaw(base, difficulty, bonus, wildcardSkillPoints, useWildcardSkillPoints, points, useNormalPoints) {
	    
	    var skill = 10;
	    
	    var skillPoints = 0;
	    
	    // determine which points to use
	    if (useNormalPoints) {
	        
	        skillPoints = points;
	        
	    } else {
	        
	        skillPoints = wildcardSkillPoints;
	        
	    }
	    
	    var levelFromPoints = Math.floor((skillPoints * 0.25) + 2)
                              * Math.ceil( ( ( skillPoints - 2 ) + Math.abs( skillPoints - 2) ) / 256 ) 
                              + skillPoints 
                              * Math.abs( Math.ceil( ( ( skillPoints - 2 ) + Math.abs( skillPoints - 2) ) / 256 ) - 1 );
                              
        skill = base + difficulty + bonus + levelFromPoints;
	    
        return skill;
        
	}
	
	/**
	 * Loops through each designated section and make sure the
	 * linked skills have the correct information.
	 */
	function updateLinkedSkills(sectionName, subName) {
	    
	    getSectionIDs(sectionName, function(ids) {
    	
    	    // loop through each row
    	    _.each(ids,function(id) {
            
				let rowType = `${sectionName}_${id}_${subName}`;
	   
	            let linkedRowId = `${sectionName}_${id}_${subName}_skill_row_id`;
	            
	            let linkedSkillMod = `${sectionName}_${id}_${subName}_skill_row_id_modifier`;
			
			    let skillMessageFieldName = `${sectionName}_${id}_${subName}_skill_row_id_message`;
	    
	            let skillMessageFieldLevel = `${sectionName}_${id}_${subName}_skill_row_id_level`;
	            
	            let weaponSkillFieldName = `${sectionName}_${id}_${subName}_skill`;
	    
	            // if this gets changed, then the update linked weapon skill gets triggered
	            let skillRowIdToggleFieldName = `${sectionName}_${id}_${subName}_skill_row_id_toggle`;
	    
	            let attributes = [
			            rowType,
			            linkedRowId,
			            linkedSkillMod,
			            skillMessageFieldName,
			            skillMessageFieldLevel,
			            weaponSkillFieldName
			        ];
			        
			    getAttrs(attributes, function(values) {
			        
			        let repeatingTableToUse = "";
			        
			        let rowTypeValue = values[rowType];
	    
            	    switch (rowTypeValue) {
            	        
            	        case "Technique":
            	            repeatingTableToUse = "repeating_techniquesrevised";
            	            break;
            	            
            	        case "Spell":
            	            repeatingTableToUse = "repeating_spells";
            	            break;
            	            
            	        case "Skill":
            	        default:
                            repeatingTableToUse = "repeating_skills";
            	            break;
            	            
            	    }
            	    
            	    let skillRowId = values[linkedRowId];
		    
        		    let skillMod = +values[linkedSkillMod];
        		    
        		    // exit if there's no value
        		    if (skillRowId.length === 0) {
        		        
        		        // clear the field
        		        let updateFields = {};
        		        
        		        updateFields[skillMessageFieldName] = ``;
            	            
            	        updateFields[skillMessageFieldLevel] = "";
            	        
            	        setAttrs(updateFields);
            	        
        		    } else {
        		        
        		        // if there's a row id, let's update stuff
        		        let skillFieldName = `${repeatingTableToUse}_${skillRowId}_level_mirror`;
        		        
        		        let skillFieldNameOfSkill = `${repeatingTableToUse}_${skillRowId}_name`;
        		        
        		        // update the skill level for weapon or linked technique.
        		        getAttrs([skillFieldName, skillFieldNameOfSkill], function(values) {
        
        		            let skillLevel = +values[skillFieldName];
        		            
							let updateFields = {};

							// check for a valid skill level							
							if (skillLevel > 0) {
						
								let skillLevelFinal = skillLevel + linkedSkillMod;
        		            
								updateFields[weaponSkillFieldName] = skillLevelFinal;
								
								updateFields[skillMessageFieldName] = values[skillFieldNameOfSkill];
								
								updateFields[skillMessageFieldLevel] = skillLevel;
								
								// reset toggle to zero
								updateFields[skillRowIdToggleFieldName] = 0;
								
								setAttrs(updateFields);
								
							} else {
        		        
								// show an error message
								updateFields[skillMessageFieldName] = `Could not find ${rowTypeValue}.`;
									
								setAttrs(updateFields);
									
							}
							
        		        });
        		        
        		    }

			    });
			
			});
    	
    	});
    	
	}
	
	// see: https://stackoverflow.com/questions/3954438/how-to-remove-item-from-array-by-value
	Array.prototype.remove = function() {
        var what, a = arguments, L = a.length, ax;
        while (L && this.length) {
            what = a[--L];
            while ((ax = this.indexOf(what)) !== -1) {
                this.splice(ax, 1);
            }
        }
        return this;
    };

	function removeArray(arr) {
        var what, a = arguments, L = a.length, ax;
        while (L > 1 && arr.length) {
            what = a[--L];
            while ((ax= arr.indexOf(what)) !== -1) {
                arr.splice(ax, 1);
            }
        }
        return arr;
    }
    
	// method to reduce async calls.
	['on','maintained'].forEach(onormaintained => {
		
		on(`change:repeating_spells:spell_${onormaintained}_checked change:penalty_per_spell_${onormaintained} remove:repeating_spells`, function (event) {
		
			getSectionIDs('repeating_spells', ids => {
		
				const fieldnames = [];
		
				ids.forEach(id => fieldnames.push(`repeating_spells_${id}_spell_${onormaintained}_checked`));

				getAttrs([`penalty_per_spell_${onormaintained}`, ...fieldnames], values => {
					const penalty = +values[`penalty_per_spell_${onormaintained}`] ||0;
		
					let checkedcount = 0;
		
					ids.forEach(id => {

						// get the value entered into the input number box. NOTE: converted from checkbox to number.
						checkedcount += +values[`repeating_spells_${id}_spell_${onormaintained}_checked`] ?? 0;

					});

					const totalpenalty = checkedcount * penalty;
		
					setAttrs({
						[`spell_${onormaintained}_penalty_total`]: totalpenalty
					})
		
				});
			});
		});
	});
							 

	/* ---- DEMOLITION SECTION ---- */
	
	const DEMO_TYPES = [
	    {type: "TNT", ref: "1.0"},
	    {type: "Serpentine Powder", ref: "0.3"},
	    {type: "Ammonium Nitrate", ref: "0.4"},
	    {type: "TL4 Black Powder", ref: "0.4"},
	    {type: "TL5 Black Powder", ref: "0.5"},
	    {type: "Diesel/Fertilizer", ref: "0.5"},
	    {type: "Dynamite", ref: "0.8"},
	    {type: "Amatol", ref: "1.2"},
	    {type: "Nitroglycerine", ref: "1.5"},
	    {type: "Tetryl", ref: "1.3"},
	    {type: "Composition B", ref: "1.4"},
	    {type: "C4", ref: "1.4"},
	    {type: "Octanitrocubane", ref: "4"},
	    {type: "Metallic Hydrogen", ref: "6"},
	];
	
	// check for how much? damage
	on("change:demo_how_much_ref change:demo_how_much_damage_multiplier change:demo_how_much_base_damage change:demo_how_much_divisor change:demo_how_much_target_distance", function (event) {
	    
	    getAttrs(["demo_how_much_ref", "demo_how_much_base_damage", "demo_how_much_damage_multiplier", "demo_how_much_divisor", "demo_how_much_target_distance"], function(values) {
	        
	        var multiplier = +values.demo_how_much_damage_multiplier;
	        
	        var REF = +values.demo_how_much_ref;
	        
	        var weight = (multiplier * multiplier) / (4 * REF);
	        
	        var result = weight.toFixed(2);
	        
	        // determine damage divisor
	        var divisor = 1;
	        
	        var targetDistance = parseInt(values.demo_how_much_target_distance);
	        
	        var baseDivisor = parseInt(values.demo_how_much_divisor);
	        
	        // if target is 1 or more yards away, determine divisor
	        if (targetDistance > 0) {
	            
	            divisor = baseDivisor * targetDistance;
	            
	        }
	        
	        // determine blast radius
	        var diceCount = getNumberOfDiceToRoll(values.demo_how_much_base_damage);
	        
	        // see B414
	        var blastRadius = diceCount * multiplier * 2;
	        
	        setAttrs({
	            demo_how_much_weight: result,
	            demo_how_much_damage_divisor: divisor,
	            demo_how_much_radius: blastRadius
	        });
	        
	    });
	    
	});
	
	/**
	 * Determines the number of dice in a simple roll value
	 * If 3d6+2, it will return 3. The number of dice to roll.
	 * 
	 * @param string rollString Roll value to parse
	 * 
	 * @return int
	 */
	function getNumberOfDiceToRoll(rollString) {
	    
	    rollString = rollString.toLowerCase();
	    
	    var arrRoll = rollString.split("d");
	    
	    var diceCount = +arrRoll[0];
	    
	    return diceCount;
	    
	}
	
	// check for how big? damage
	on("change:demo_how_big_ref chage:demo_how_big_base_damage change:demo_how_big_weight change:demo_how_big_divisor change:demo_how_big_target_distance", function (event) {
	    
	    getAttrs(["demo_how_big_ref", "demo_how_big_base_damage", "demo_how_big_weight", "demo_how_big_divisor", "demo_how_big_target_distance"], function(values) {
	        
	        var multiplier = 0;
	        
	        var REF = +values.demo_how_big_ref;
	        
	        var weight = +values.demo_how_big_weight;
	        
	        if (weight > 0) {
	            
    	        multiplier = Math.sqrt(weight * 4 * REF);
    	        
    	        multiplier = Math.floor(1 * multiplier);
    	        
	        }
	        
	        // determine damage divisor
	        var divisor = 1;
	        
	        var targetDistance = parseInt(values.demo_how_big_target_distance);
	        
	        var baseDivisor = parseInt(values.demo_how_big_divisor);
	        
	        // if target is 1 or more yards away, determine divisor
	        if (targetDistance > 0) {
	            
	            divisor = baseDivisor * targetDistance;
	            
	        }
	        
	        // determine blast radius
	        var diceCount = getNumberOfDiceToRoll(values.demo_how_big_base_damage);
	        
	        // see B414
	        var blastRadius = diceCount * multiplier * 2;
	        
	        setAttrs({
	            demo_how_big_damage_multiplier: multiplier,
	            demo_how_big_damage_divisor: divisor,
	            demo_how_big_radius: blastRadius
	        });
	        
	    });
	    
	});
	
	// check for selecting an demolition type for how much.
	on("change:demo_how_much_selected_type", function(event) {
	    
	    getAttrs(["demo_how_much_selected_type"], function(values) {
	        
	        var demoType = getDemoTypeObject(values.demo_how_much_selected_type);
	        
	        setAttrs({
	            demo_how_much_type: demoType.type,
	            demo_how_much_ref: demoType.ref
	        });
	        
	    });
	    
	});
	
	// check for selectin an demolition type for how big
	on("change:demo_how_big_selected_type", function(event) {
	    
	    getAttrs(["demo_how_big_selected_type"], function(values) {
	        
	        var demoType = getDemoTypeObject(values.demo_how_big_selected_type);
	        
	        setAttrs({
	            demo_how_big_type: demoType.type,
	            demo_how_big_ref: demoType.ref
	        });
	        
	    });
	    
	});
	
	/**
	 * Find the demo type objects in the DEMO_TYPES constant array
	 * 
	 * @param string type Demolition Type name
	 * 
	 * @return object {type, ref}
	 */
	function getDemoTypeObject(type) {
	    
	    var object = DEMO_TYPES.find( element => element.type === type); 
	    
	    return object;
	    
	}
	
    on("clicked:demo_how_much_reset", function() {
        
        setAttrs({
            demo_how_much_selected_type: "TNT",
            demo_how_much_type: "TNT",
            demo_how_much_ref: 1.0,
            demo_how_much_damage_multiplier: 1
        });
        
    });
    
    on("clicked:demo_how_big_reset", function() {
        
        setAttrs({
            demo_how_big_selected_type: "TNT",
            demo_how_big_type: "TNT",
            demo_how_big_ref: 1.0,
            demo_how_big_weight: 1
        });
        
    });
    
    on("change:fragmentation_damage", function(event) {
        
        getAttrs(["fragmentation_damage"], function(values) {
            
             var diceCount = getNumberOfDiceToRoll(values.fragmentation_damage);
             
             var radius = 5 * diceCount;
             
             setAttrs({
                 fragmentation_radius: radius
             });
            
        });
        
	});
	
	/* ====================== */
	/*   TECHNIQUES REVISED   */
	/* ====================== */
		
	// check for changes that effect final technique level
	on("change:repeating_techniquesrevised:base_level change:repeating_techniquesrevised:default change:repeating_techniquesrevised:max_modifier change:repeating_techniquesrevised:difficulty change:repeating_techniquesrevised:skill_modifier change:repeating_techniquesrevised:points", function(event) {

		var technigueFields = [
			"repeating_techniquesrevised_base_level",
			"repeating_techniquesrevised_default",
			"repeating_techniquesrevised_max_modifier",
			"repeating_techniquesrevised_difficulty",
			"repeating_techniquesrevised_skill_modifier",
			"repeating_techniquesrevised_points"
		];

		getAttrs(technigueFields, function(values) {

			var finalLevel = 10;

			var baseLevel = +values.repeating_techniquesrevised_base_level;

			var defaultMod = +values.repeating_techniquesrevised_default;

			var customSkillModifier = +values.repeating_techniquesrevised_skill_modifier;
			
			var maxModifier = 0;

			var maxLevel = 0;

			var techPoints = +values.repeating_techniquesrevised_points;

			var technigueSkillMod = getModifierForTechniqueDifficulty(values.repeating_techniquesrevised_difficulty, techPoints);

			if (values.repeating_techniquesrevised_max_modifier) {

				maxModifier = +values.repeating_techniquesrevised_max_modifier;

				maxLevel = baseLevel + maxModifier;	

			}
			
			finalLevel = baseLevel + defaultMod + technigueSkillMod + customSkillModifier;

			// check for max level
			if (maxLevel > 0 && finalLevel > maxLevel) {

				// the finalLevel can't exceed maxLevel
				finalLevel = maxLevel;

			} 
			
			setAttrs({
				repeating_techniquesrevised_level: finalLevel
			});

		});

	});

	/**
	 * Calculate the technique skill modifier based
	 * difficulty level. see B230
	 */
	function getModifierForTechniqueDifficulty(difficultyLevel, points) {

		var mod = 0;

		if (points > 0) {

			if (difficultyLevel.toLowerCase() == "average") {

				mod = points;

			} else if (points > 1) {

				// Hard requires a minimum of 2 spoint be spent.
				mod = points - 1;
			}

		}

		return mod;

	}

	//------------------------------------
	// Active Defense Methods
	//------------------------------------

	// check if an repeating active defense type changed
	// update raw success/fail notes based on selected defense Type
	on("change:repeating_defense:type", (event) => {

		const fields = [
			"repeating_defense_type"
		]

		getAttrs(fields, (values) => {

			let defenseType = values.repeating_defense_type;

			let successNote;

			let successCritNote;

			let failNote;

			let failCriticalNote;

			let rawNotes = getRawDefenseNotesByType(defenseType);

			const updateFields = {
				repeating_defense_raw_success_note:          rawNotes.success,
				repeating_defense_raw_critical_success_note: rawNotes.successCritical,
				repeating_defense_raw_fail_note:             rawNotes.fail,
				repeating_defense_raw_critical_fail_note:    rawNotes.failCritical	
			};

			setAttrs(updateFields);

		});
		
	});

	/**
	 * Get an array of defense notes based on defense type
	 *
	 * @param string defenseType Type of defense
	 *
	 * @return object {success, successCritical, fail, failCritical}
	 */
	function getRawDefenseNotesByType(defenseType) {

		let successNote;

		let successCritNote;

		let failNote;

		let failCriticalNote;

		switch (defenseType) {
			case "Dodge":
				successNote      = getDefenseNotesByCode("dodge_success_notes");
				successCritNote  = getDefenseNotesByCode("dodge_critical_success_notes");
				failNote         = getDefenseNotesByCode("dodge_fail_notes");
				failCriticalNote = getDefenseNotesByCode("dodge_critical_failure_notes");
				break;
		
			case "Parry":
				successNote      = getDefenseNotesByCode("parry_success_notes");
				successCritNote  = getDefenseNotesByCode("parry_critical_success_notes");
				failNote         = getDefenseNotesByCode("parry_fail_notes");
				failCriticalNote = getDefenseNotesByCode("parry_critical_failure_notes");
				break;
		
			case "Unarmed Parry":
				successNote      = getDefenseNotesByCode("unarmed_parry_success_notes");
				successCritNote  = getDefenseNotesByCode("unarmed_parry_critical_success_notes");
				failNote         = getDefenseNotesByCode("unarmed_parry_fail_notes");
				failCriticalNote = getDefenseNotesByCode("unarmed_parry_critical_failure_notes");
				break;
		
			case "Block":
				successNote      = getDefenseNotesByCode("block_success_notes");
				successCritNote  = getDefenseNotesByCode("block_critical_success_notes");
				failNote         = getDefenseNotesByCode("block_fail_notes");
				failCriticalNote = getDefenseNotesByCode("block_critical_failure_notes");
				break;
		
			default:
				successNote      = " ";
				successCritNote  = " ";
				failNote         = " ";
				failCriticalNote = " ";
				break;

		}

		notes = {
			"success": successNote,
			"successCritical": successCritNote,
			"fail": failNote,
			"failCritical": failCriticalNote
		};

		return notes;

	}

	/**
	 * Update hit point thresholds
	 */
	function updateHitPointThresholds() {

		getAttrs(["hit_points_max"], (values) => {

			let max = +values.hit_points_max;

			let reeling = Math.ceil(max / 3);

			let verge = max * -1;

			let death = max * -5;

			let destruction = max * -10;

			const fields = {
				hp_reeling:     reeling,
				hp_verge:       verge,
				hp_death:       death,
				hp_destruction: destruction
			};

			setAttrs(fields);

		});

	}

	/**
	 * Update fatigue point thresholds
	 */
	 function updateFatiguePointThresholds() {

		getAttrs(["fatigue_points_max"], (values) => {

			let max = +values.fatigue_points_max;

			let tired = Math.ceil(max / 3);

			let unconscious = max * -1;

			const fields = {
				fp_tired:       tired,
				fp_unconscious: unconscious,
			};

			setAttrs(fields);

		});

	}

	/**
	 * Generate a table for storing active defense notes.
	 */
	function getRawActiveDefensesNotes() {

		const dodgeSuccessNotes = `If a single rapid-fire attack, avoid one hit, plus additional hits equal to your margin of success. See B375.`;

		const dodgeCriticalSuccessNotes = `If melee attack, foe goes immediately to the Critical Miss Table on B556. See B381. 

If a single rapid-fire attack, dodge <i>all</i> hits. See B375.`;

		const dodgeFailNotes = ""; 

		const dodgeCriticalFailureNotes = `You lose your footing and fall prone (no effect if already prone). See B382`;

		const parrySuccessNotes = `If parrying a weapon 3 times your weapons weight, roll for breakage. See B376.`;

		const parryCriticalSuccessNotes = `If melee attack, foe goes immediately to the Critical Miss Table on B556. See B381. 

If parrying a weapon 3 times your weapons weight, roll for breakage. See B376.`;

		const parryFailNotes = ``;

		const parryCriticalFailureNotes = `Roll on the appropriate <i>Critical Miss Table</i> B556. See B382.`;

		const unarmedParrySuccessNotes = ""; 

		const unarmedParryCriticalSuccessNotes = `If melee attack, foe goes immediately to the Critical Miss Table on B556. See B381. 

If attack is a thrown weapon, a bare handed parry lets you <i>catch</i> the incoming weapon without hurting yourself. See B381.`;

		const unarmedParryFailNotes = `The attacker may choose to hit the original target or the limb you used to parry with. See B376.`;

		const unarmedParryCriticalFailureNotes = `Roll on the appropriate <i>Critical Miss Table</i> B556. See B382.

The attacker may choose to hit the original target or the limb you used to parry with. See B376.`;

		const blockSuccessNotes = ``;

		const blockCriticalSuccessNotes = `If melee attack, foe goes immediately to the Critical Miss Table on B556. See B381.`;

		const blockFailNotes = "";

		const blockCriticalFailureNotes = `Lose your grip on the your shield and you must take a turn to ready it before you can use it to block again. See B382.`;

		const notes = [
			{code: "dodge_success_notes",                  value: dodgeSuccessNotes},
			{code: "dodge_critical_success_notes",         value: dodgeCriticalSuccessNotes},
			{code: "dodge_fail_notes",                     value: dodgeFailNotes},
			{code: "dodge_critical_failure_notes",         value: dodgeCriticalFailureNotes},
			{code: "parry_success_notes",                  value: parrySuccessNotes},
			{code: "parry_critical_success_notes",         value: parryCriticalSuccessNotes},
			{code: "parry_fail_notes",                     value: parryFailNotes},
			{code: "parry_critical_failure_notes",         value: parryCriticalFailureNotes},
			{code: "unarmed_parry_success_notes",          value: unarmedParrySuccessNotes},
			{code: "unarmed_parry_critical_success_notes", value: unarmedParryCriticalSuccessNotes},
			{code: "unarmed_parry_fail_notes",             value: unarmedParryFailNotes},
			{code: "unarmed_parry_critical_failure_notes", value: unarmedParryCriticalFailureNotes},
			{code: "block_success_notes",                  value: blockSuccessNotes},
			{code: "block_critical_success_notes",         value: blockCriticalSuccessNotes},
			{code: "block_fail_notes",                     value: blockFailNotes},
			{code: "block_critical_failure_notes",         value: blockCriticalFailureNotes},
		];

		return notes; 

	}

	/**
     * Create global function
     * use: var mod = getDefenseNotesByCode("blah");
     * Uses the array of json object objects
     * to get the modifier based on speed/range
     **/
	 const getDefenseNotesByCode = (code) => {
    	
    	const entry = rawDefenseNotes.find( (notes) => notes.code === code );
    	
    	// if no matches, return no string
    	return (entry != undefined ? entry.value : "");
    
    };

	// when reset close range shotgun fields is clicked
	on("clicked:shotgun_reset", function() {
	   
		resetShotgunFields();
	    
	});

    function resetShotgunFields() {

		const updateFields = {
			shotgun_damage: "1d6+1",
			shotgun_damage_rof: "2x9",
			shotgun_damage_type: "Piercing (pi)",
			shotgun_half_range: "50",
			shotgun_close_range: "5",
			shotgun_close_rof: "2",
			shotgun_close_damage: "4d6+4",
			shotgun_dr_multiplier: "DR x 4"
		};

		setAttrs(updateFields);

	}

	on("change:shotgun_damage change:shotgun_rof change:shotgun_damage_type change:shotgun_half_range", () => {

		updateShotgunTool();

	});

	/**
     * Updates the fields for the shotgun tool
	 */
	function updateShotgunTool() {

		const fields = [
			"shotgun_damage",
			"shotgun_rof",
			"shotgun_damage_type",
			"shotgun_half_range",
			"damage_type_note_cut",
		    "damage_type_note_imp",
		    "damage_type_note_cr",
		    "damage_type_note_pi_minus",
		    "damage_type_note_pi",
		    "damage_type_note_pi_plus",
		    "damage_type_note_pi_plus_plus",
		    "damage_type_note_aff",
		    "damage_type_note_burn",
		    "damage_type_note_cor",
		    "damage_type_note_fat",
		    "damage_type_note_tox",
			"damage_type_note_spec",
			"damage_type_note_knockback"
		];

		getAttrs(fields, (values) => {

			let closeRange = 1;

			let closeDamage = "4d6";

			let halfDamageRange = parseInt(values.shotgun_half_range, values);

			if ( isNaN(halfDamageRange) ) {
				closeRange = 0;
			} else {
				closeRange = Math.floor( .1 * halfDamageRange);
			}

			let {closeRof, modifier} = getShotGunModifiers(values.shotgun_rof);

			// calculate close damage: 1d6+2
			let arrDamage = values.shotgun_damage.toLowerCase().split("d");

			let damageDie = 1;

			let damageMod = 0;

			let damageTypeNote = getDamageTypeNote(values.shotgun_damage_type, values);

			// try to get the base damage die for shotgun
			// 1d6+1. arrDamage = [1][6+1]
			if (Array.isArray(arrDamage)) {

				damageDie = parseInt(arrDamage[0]);

				// check for a bad number
				if (isNaN(damageDie)) {
					damageDie = 1;
				}

				// check for the second half die modifier
				if (arrDamage.length === 2) {

					// get rid of the 6 
					// 6+1. we just need the +1 or -1.
					damageMod = parseInt(arrDamage[1].replace("6", ""));

				}

			}

			let closeDamageDie = damageDie * modifier;

			let closeDamageDieMod = damageMod * modifier;

			closeDamage = `${closeDamageDie}d6`;

			// check if we should add the damage die mod
			if ( closeDamageDieMod > 0) {

				closeDamage = `${closeDamage}+${closeDamageDieMod}`;
			
			} else if (damageMod < 0) {
			
				closeDamage = `${closeDamage}${closeDamageDieMod}`;
			
			}

			let drMultiplier = `DR x ${modifier}`;

			const updateFields = {
				"shotgun_close_range": closeRange,
				"shotgun_close_rof": closeRof,
				"shotgun_close_damage": closeDamage,
				"shotgun_dr_multiplier": drMultiplier,
				"shotgun_damage_type_note": damageTypeNote
			};

			setAttrs(updateFields);
			
		});

	}

	/**
	* Get shotgun modifier based on rate of fire
	*
	* @param string rateOfFire Shotgun rate of fire, i.e.: 2x9
	* 
	* @return object {baseDamage, Modifier}
	*/
	function getShotGunModifiers(rateOfFire) {

		// just in case, remmove any negative numbers
		if (rateOfFire) {
			rateOfFire = rateOfFire.replace("-", "");
		} else {
			rateOfFire = "1x9";
		}
		
		// rateOfFire = shotes x Mulitplier
		// example: 2 x 9
		let arrRof = rateOfFire.toLowerCase().split("x");

		let baseRof = 1;

		let multiplier = 1;

		let modifier = 1;

		if (arrRof.length === 2) {

			baseRof = parseInt(arrRof[0]);

			// make sure we have good number
			if (isNaN(baseRof)) {
				baseRof = 1;
			}

			multiplier = parseInt(arrRof[1]);

			// make sure we have a number
			if (isNaN(multiplier)) {

				modifier = 1;

			} else {

				modifier = Math.floor(multiplier/2);		

			}

		}

		let modifiers = {
			closeRof: baseRof,
			modifier: modifier 
		};

		return modifiers;

	}

	on("change:size", (event) => {

		let sizeDiff = Number(event.newValue) - Number(event.previousValue);

		if (isNaN(sizeDiff)) {
			sizeDiff = 0;
		}

		updateReach();

		updateRepeatingHitLocationPenaltyCrippledValues(sizeDiff);

	});

	on("change:hit_points_max", (event) => {

		updateRepeatingHitLocationPenaltyCrippledValues(0);

	});


	function updateReach() {

		getAttrs(["size"], (values) => {

			const size = +values.size;

			let isCloseReachOne = "off";

			let reach = 0;

			switch (size) {
				case 0:
					reach = 0;
					break;
		
				case 1:
					reach = 1;
					isCloseReachOne = "on";
					break;
		
				case 2:
					reach = 1;
					break;

				case 3: 
					reach = 2;
					break;

				case 4: 
					reach = 3;
					break;

				case 5: 
					reach = 5;
					break;

				case 6: 
					reach = 7;
					break;

				case 7: 
					reach = 10;
					break;

				case 8: 
					reach = 15;
					break;

				case 9:
					reach = 20;
					break;

				case 10: 
					reach = 30;
					break;

				default:
					reach = 0;
					break;
			}

			let fields = {
				"reach": reach,
				"is_close_reach": isCloseReachOne
			};

			setAttrs(fields, {silent:true});

		});

	}
	
	/* ROLL MODIFIERS BOX */

	// close roll modifiers, no updates
	on("clicked:close_roll_modifiers", (event) => {

		let fields = {
			"show_roll_modifiers": 0,
			"roll_modifier_types": ""
		};

		setAttrs(fields, {silent:true});

	});

	// apply and close the roll modifiers modal box
	on("clicked:apply_roll_modifiers", (event) => {

		let fields = [
			"roll_modifier_types",
			"max_skill_nine", 
			"roll_modifier", 
			"roll_modifier_summary", 
			"roll_trait_summary",
			"roll_hit_location",
			"roll_maneuver",
			"roll_allout_attack",
		];

		getAttrs(fields, values => {

			// roll_modifier_types stores which repeating section we're applying modifiers to.
			// roll_modifier_types = skill | technique | defense | melee | ranged
			let section = values.roll_modifier_types;

			// If max 9 is not used, set value to 100, so it will never be used
			// If max 9 is used, then limit effective skill to 9 by setting value to 9
			let maxSkillNine = 100;

			if ( Number(values.max_skill_nine) === 1) {
				maxSkillNine = 9;
			}

			// fields to get updated 
			const updateFields = {
				"show_roll_modifiers": 0,
				"roll_modifier_types": "",
				[`${section}_roll_modifier`]: Number(values.roll_modifier),
				[`${section}_roll_modifier_summary`]: values.roll_modifier_summary,
				[`${section}_roll_trait_summary`]: values.roll_trait_summary,
				[`${section}_roll_max_nine`]: values.max_skill_nine,
				[`${section}_roll_max_nine_value`]: maxSkillNine,
				[`${section}_roll_hit_location`]: values.roll_hit_location, 
				[`${section}_roll_maneuver`]: values.roll_maneuver,
				[`${section}_roll_allout_attack`]: values.roll_allout_attack,
			};

			setAttrs(updateFields, {silent: true});

		});

	});

	// reset modifiers but keep traits
	on("clicked:reset_roll_modifiers", event => {

		resetRollModifiersToolBox();

	});

	/**
	 * Resets the roll modifiers fields in the dialog box
	 * Doesn't change the traits fields, since they are usually static
	 **/
	function resetRollModifiersToolBox() {

		getAttrs(["roll_modifier_types", "spell_on_penalty_total", "spell_maintained_penalty_total"], values => {

			let modType = values.roll_modifier_types;

			let modFields;

			let key = "";

			let value = "";

			let rollModifier = 0;

			let rollSummary = "";

			if (modType == "spell") {

				let onPenalty = parseInt(values.spell_on_penalty_total);

				let concentrationPenalty = parseInt(values.spell_maintained_penalty_total);

				if (onPenalty < 0) {

					rollModifier += onPenalty;

					rollSummary = `${onPenalty} Spells On penalty.\n`;
				}

				if (concentrationPenalty < 0) {

					rollModifier += concentrationPenalty;

					rollSummary = `${concentrationPenalty} Spells Concentration penalty.\n`;
				}

			}

			// TODO: split this up modType.
			let updateFields = {
				roll_modifier: rollModifier,
				max_skill_nine: 0,
				visibility_modifier: 0,
				roll_modifier_summary: rollSummary,
				roll_trait_summary: "",
				roll_hit_location: "",
				roll_maneuver: "",
				roll_allout_attack: "",
				hit_location_type: "",
				humanoid_location: "torso-0",
				target_size_modifier: 0,
				grapple_modifier: -1,
				has_shield: 0,
				target_chink_in_armor: 0,
				target_light_cover: 0,
				target_down: 0,
				target_partly_exposed: 0,
				target_intervening_figures: 0,
				ranged_range_speed: 0,
				ranged_rof: 1,
				ranged_scope_bonus: 0,
				ranged_laser_sight: 0,
				ranged_bulk: -2,
				ranged_move_default_or_bulk: 0,
				vehicle_stability_rating: 0,
				vehicle_weapon_unstabilized: 0,
				ranged_elevation: 0,
			};

			switch (modType) {
				
				case "technique":
					modFields = [...techniqueModifierFields];
					break;
			
				case "melee":
					modFields = [...meleeModifierFields];
					break;
				
				case "ranged":
					modFields = [...rangedModifierFields];
					break;
			
				case "defense":
					modFields = [...defenseModifierFields];
					break;

				case "spell":

					modFields = [...spellModifierFields];

					// remove spells on and maintained. do NOT reset
					modFields.splice(modFields.indexOf("spell_on_penalty_total"), 1);
					modFields.splice(modFields.indexOf("spell_maintained_penalty_total"), 1);
				
					break;

				case "skill":
				default:
					// NOTE: Need to do a deep copy, since we don't want to reference the original array
					modFields = [...skillModifierFields];
					break;

			}

			// loop through each item in the array
			// if a modifier add to udpatefields, clear value
			for (let i = 0; i < modFields.length; i++) {

				key = modFields[i];

				// ignore traits
				if (traitFields.indexOf(key) === -1) {

					// check for reason field, which is a text value
					if (key == "dialog_custom_roll_modifier_reason" || 
					    key == "hit_location" ) {
						
						value = "";

					} else if (key == "melee_maneuver") {

						value = "step-attack";

					} else if (key == "ranged_maneuver") { 

						value = "step-attack";

					} else if (key == "defense_maneuver" ) {

						value = "step-attack";

					} else {
						
						value = 0;
						
					}

					// add a new property
					updateFields[key] = value;

				}

			}

			setAttrs(updateFields, {silent: true});

		});

	} 

	const arrChangeSkillRollMods = [
		"change:show_roll_modifiers", 
		"change:shock_penalty",
		"change:dialog_custom_roll_modifier",
		"change:dialog_custom_roll_modifier_reason",
		"change:night_vision",
		"change:has_dark_vision", 
		"change:has_high_pain_threshold",
		"change:has_low_pain_threshold",
		"change:is_used_to_blindness",
		"change:coughing_sneezing_iq",
		"change:coughing_sneezing_dx",
		"change:drowsy",
		"change:tipsy",
		"change:drunk",
		"change:euphoria",
		"change:distraction",
		"change:pain_level",
		"change:skill_encumbered",
		"change:bad_footing",
		"change:shield_close_combat_penalty",
		"change:grappled",
		"change:holding_large_shield",
		"change:visiblity_condition", 
		"change:darkness_penalty",
		"change:smoke_penalty",
		"change:fog_penalty",
		"change:blur_penalty", 
		"change:other_vision_penalty",
		"change:task_difficulty",
		"change:task_extra_time",
		"change:task_haste",
		"change:unfamiliar_culture",
		"change:language_modifier",
		"change:iq_tech_level_modifier",
		"change:non_iq_tech_level_modifier",
		"change:task_equipment_modifier",
		"change:task_missing_items",
		"change:task_damaged_equipment",
		"change:unfamiliar_equipment",
		"change:target_size_modifier",
		"change:hit_location_modifier",
		"change:hit_location",
		"change:melee_maneuver",
		"change:melee_all_out_attack",
		"change:posture",
		"change:deceptive_strike",
		"change:evaluate",
		"change:rapid_strike",
		"change:flurry_of_blows",
		"change:rapid_strike_master",
		"change:attack_from_above",
		"change:mighty_blow",
		"change:melee_height_difference",
		"change:improvised_weapon",
		"change:tactics",
		"change:backstab",
		"change:ranged_tactics",
		"change:ranged_backstab",
		"change:weapon_hand",
		"change:off_hand_training",
		"change:dual_weapon_training",
		"change:ranged_weapon_hand",
		"change:ranged_off_hand_training",
		"change:ranged_dual_weapon_training",
		"change:mounted_skill_difference",
		"change:mount_attacked",
		"change:mount_has_velocity",
		"change:wild_swing",
		"change:ranged_weapon_hand",
		"change:ranged_off_hand_training",
		"change:ranged_dual_weapon_training",
		"change:ranged_accuracy_bonus",
		"change:ranged_range_speed_modifier",
		"change:ranged_aiming_bonus",
		"change:ranged_rof_modifier",
		"change:ranged_targeting_system_modifier",
		"change:ranged_maneuver",
		"change:ranged_move_default_or_bulk",
		"change:ranged_in_close_combat",
		"change:ranged_damaged_weapon",
		"change:ranged_strength_difference",
		"change:ranged_opportunity_fire_watched",
		"change:ranged_opportunity_fire_target",
		"change:ranged_braced",
		"change:ranged_popup",
		"change:ranged_vehicle_conditions",
		"change:ranged_controll_roll",
		"change:ranged_over_under_mount",
		"change:ranged_vehicle_dodge",
		"change:ranged_air_vehicle_dodge",
		"change:defense_maneuver",
		"change:defense_crawling",
		"change:defense_kneeling",
		"change:defense_from_behind",
		"change:defense_runaround",
		"change:shield_db",
		"change:magic_db",
		"change:general_db",
		"change:defense_retreat_dodge",
		"change:defense_retreat_parry",
		"change:defense_retreat_parry_fence",
		"change:defense_retreating_flight",
		"change:defense_acrobatic_dodge_success",
		"change:defense_acrobatic_dodge_failed",
		"change:defense_dodge_drop",
		"change:defense_feverish",
		"change:defense_offhand_parry",
		"change:defense_parries",
		"change:defense_parries_master",
		"change:defense_improvised_weapon",
		"change:defense_laser_sight",
		"change:defense_deceptive_attack",
		"change:defense_feint",
		"change:defense_height_difference",
		"change:defense_mounted",
		"change:defense_tactics",
		"change:defense_hidden_weapon",
		"change:defense_parry_knife",
		"change:defense_parry_kusari",
		"change:defense_unarmed_parry",
		"change:defense_dual_weapon",
		"change:defense_parry_flail",
		"change:defense_parry_nunchaku",
		"change:defense_block_flail",
		"change:defense_block_nunchaku",
		"change:defense_thrown_weapon",
		"change:defense_thrown_small_weapon",
		"change:defense_trident_dodge",
		"change:defense_trident_block",
		"change:defense_stunned",
		"change:defense_nauseated",
		"change:defense_encumbered",
		"change:defense_cant_see_attacker",
		"change:defense_bad_footing",
		"change:defense_distraction",
		"change:defense_grappled_dodge",
		"change:defense_grappled_block",
		"change:spell_on_penalty_total",
		"change:spell_maintained_penalty_total",
		"change:spells_low_mana",
		"change:spell_burn_hit_points",
		"change:spell_ceremonial_bonus",
		"change:regular_spell_modifier",
		"change:regular_spell_cant_see_touch",
		"change:spell_long_distance",
		"change:spell_natures_strength",
	];

	const changeSkillRollMods = arrChangeSkillRollMods.join(" ");

	// total skill roll modifiers
	on(changeSkillRollMods, (event) => {

		getAttrs(["show_roll_modifiers", "roll_modifier_types"], (values) => {

			let showRollDialog = +values.show_roll_modifiers;

			let modifierType = values.roll_modifier_types

			if (showRollDialog && modifierType) {

				totalRollModifiersDialogBox(modifierType);

			}

		});

	});

	/**
	 * Total up the modifiers and check for special conditions
	 * based on modifier type.
	 * 
	 * @param string modifierType skill | technique | melee | range | spell
	 */
	function totalRollModifiersDialogBox(modifierType) {

		let fields;

		// fields are defined constants, see beginning of script
		switch (modifierType) {

			case "spell":
				fields = [...spellModifierFields];
				break;

			case "technique":
				fields = [...techniqueModifierFields];
				break;
			
			case "melee":
				fields = [...meleeModifierFields];
				break;
		
			case "ranged":
				fields = [...rangedModifierFields];
				break;
		
			case "defense":
				fields = [...defenseModifierFields];
				break;

			case "skill":
			default:
				fields = [...skillModifierFields];
				break;
		}

		getAttrs(fields, (values) => {

			let max9 = 0;

			let rollMax9 = false;

			let visibilityMax9 = false;

			let visibilityMod = 0;

			let visibilitySummary;

			let rollModifierSummary;

			let rollModifier = 0;

			let traitSummary;

			let hitLocationDescription = "";

			let maneuver = "";

			let allOutAttack = "";

			[rollModifier, rollMax9, rollModifierSummary, traitSummary, hitLocationDescription, maneuver, allOutAttack] = getRollModifiers(values);
		 
			[visibilityMod, visibilityMax9, visibilitySummary] = getVisibilityModifiers(values);

			if (rollMax9 || visibilityMax9) {
				max9 = 1;
			}
			
			// use javascript spread operator to copy values and then merge into finalSummary
			let finalSummary = new Map([...rollModifierSummary, ...visibilitySummary]);

			let strSummary = mapToString(finalSummary);

			let strTraitSummary = mapToString(traitSummary);

			let updateFields = {
				"max_skill_nine": max9,
				"visibility_modifier": visibilityMod,
				"roll_modifier": rollModifier + visibilityMod,
				"roll_modifier_summary": strSummary,
				"roll_trait_summary": strTraitSummary,
				"roll_hit_location": hitLocationDescription,
				"roll_maneuver": maneuver,
				"roll_allout_attack": allOutAttack,
			};

			setAttrs(updateFields, {silent: true});

		});

	}

	/**
	 * Convert Javascript Map to a string value
	 * see: https://www.cloudhadoop.com/2018/09/typescript-how-to-convert-map-tofrom.html
	 */
	function mapToString(map) {

		let jsonObject = {};

		let mapString = "";

		map.forEach((value, key) => {  
    		mapString += `${value}\n`;
		});

		return mapString;

	}

	/**
	 * Determine visibility modifiers, if max skill 9 should apply
	 * and generate summary.
	 * 
	 * @param array values An array of field values
	 *
	 * @return array  [visibilityMod, max9, summary] [int, int, Map]
	 */
	function getVisibilityModifiers(values) {

		let visibilityMod = 0;

		// prevent NaN error: https://stackoverflow.com/questions/37998501/return-zero-if-input-value-is-nan
		let usedToBlind = parseInt(values.is_used_to_blindness) || 0;

		let visibilityCondition = parseInt(values.visiblity_condition) || 0;

		let darknessPenalty = parseInt(values.darkness_penalty) || 0;

		let nightVision = parseInt(values.night_vision) || 0;

		let adjustedDarknessPenalty = 0;

		let hasDarkVision = parseInt(values.has_dark_vision) || 0;

		let smokePenalty = parseInt(values.smoke_penalty) || 0;

		let fogPenalty = parseInt(values.fog_penalty) || 0;

		let blurPenalty = parseInt(values.blur_penalty) || 0;

		let otherPenalty = parseInt(values.other_vision_penalty) || 0;

		let max9 = 0;

		let summary = new Map();

		let summaryValue = "";

		switch (visibilityCondition) {
			case 1:
				// can't see anything
				visibilityMod = -10;
				max9 = 1;
				summaryValue = " (Can't see anything)";
				break;

			case 2:
				// can't see target
				visibilityMod = -6;
				max9 = 1;
				summaryValue = " (Can't see target)";
				break;

			case 3:
				// can't see target, but know location
				visibilityMod = -4;
				max9 = 1;
				summaryValue = " (Can't see anything, but now know location)";
				break;
		
			default:
				visibilityMod = 0;
				break;
		}

		// add darkness penalty, offset by nightvision
		if (!hasDarkVision && darknessPenalty) {

			adjustedDarknessPenalty = darknessPenalty + nightVision;

			if (adjustedDarknessPenalty > 0) {
				adjustedDarknessPenalty = 0;
			}

			visibilityMod = visibilityMod + adjustedDarknessPenalty;

		}
		
		visibilityMod = visibilityMod + smokePenalty;

		visibilityMod = visibilityMod + fogPenalty;

		visibilityMod = visibilityMod + blurPenalty;

		visibilityMod = visibilityMod + otherPenalty;

		// check for max modifiers
		if (usedToBlind && visibilityMod < -6) {
			visibilityMod = -6;
		} else if (visibilityMod < -10 ) {
			visibilityMod = -10;
		}

		if (visibilityMod !== 0) {

			summaryValue = `${visibilityMod} Due to visibility${summaryValue}`;

			summary.set("Visibility", summaryValue);

		}

		return [visibilityMod, max9, summary];

	}

	/**
	 * Determine the roll modifiers by the selected fields 
	 * and by getting information from the rollModifiers constant variable. 
	 * 
	 * @param object values An object of input fields
	 * 
	 * @return [int totalMod, bool max9, Map summary, Map traitSummary, string hitLocationDescription, string maneuverDescription, string allOutDescription]
	 */
	function getRollModifiers(values) {

		let summary = new Map();

		let traitSummary = new Map();

		let totalMod = 0;

		let hasHighPainThreshold = +values.has_high_pain_threshold;

		let hasLowPainThreshold = +values.has_low_pain_threshold;

		let max9 = 0;

		let hitLocationDescription = "";

		let maneuverDescription = "";

		let allOutDescription = "";

		// loop through each input values
		for (let key in values) {

			// get the value of the input field
			let value = +values[key];

			let modifier = 0;

			let description = "";

			let meleeMax9 = false;

			let defenderMod = 0;

			// get the field information by key
			// field = key (field_name): value = { int modifier, string description, bool affectsVisibility, bool isDropDown, bool isMax9, bool isTrait, bool checkPain}
			let field = rollModifiers.get(key);

			// ignore traits and affectsVisibility
			if (field && field.isTrait === false && field.affectsVisibility === false) {

				// check how to get modifier value
				if (key == "melee_maneuver") {

					[modifier, description, meleeMax9] = getModifierForMeleeManeuver(values.melee_maneuver);

					maneuverDescription = description;

				} else if (key == "ranged_maneuver") {

					[modifier, description] = getModifierForRangedManeuver(values.ranged_maneuver, Number(values.ranged_move_default_or_bulk));

					maneuverDescription = description;

				} else if (key == "defense_maneuver") {

					[modifier, description] = getModifierForDefenseManeuver(values.defense_maneuver);

					maneuverDescription = description;

				} else if (key == "melee_all_out_attack") {

					[modifier, description] = getModifierForAllOutAttack(values.melee_all_out_attack);

					allOutDescription = description;

				} else if (key == "posture") {

					[modifier, description] = getModifierForPosture(values.posture);

				} else if (key == "melee_height_difference") {

					[modifier, description] = getModifierForHeightDifference(values.melee_height_difference);

				} else if (key == "defense_height_difference") {

					[modifier, description] = getModifierForDefenseHeightDifference(values.defense_height_difference);

				} else if (key == "weapon_hand") {

					[modifier, description] = getModifierHandedness(values.weapon_hand, values.off_hand_training, values.dual_weapon_training);

				} else if (key == "ranged_weapon_hand") {

					[modifier, description] = getModifierHandedness(values.ranged_weapon_hand, values.ranged_off_hand_training, values.ranged_dual_weapon_training);

				} else if (key == "ranged_vehicle_conditions") {

					[modifier, description] = getModifierForVehicleConditions(values.ranged_vehicle_conditions);

				} else if (key == "spell_natures_strength") {

					[modifier, description] = getModifierForNaturesStrength(values.spell_natures_strength);

				} else if (field.isDropDown) {
					
					modifier = value;
				
				} else if (value) {
					
					// if checked, otherwise use the value in the field information object
					modifier = field.modifier;
				
				}

				// check for special modifiers
				if (key === "shock_penalty") {
					modifier = getShockPenalty(modifier, hasHighPainThreshold, hasLowPainThreshold);
				} else if (key === "pain_level") {
					modifier = getPainLevelPenalty(modifier, hasHighPainThreshold, hasLowPainThreshold);
				}

				totalMod += modifier;

				// check for special description
				if (key === "dialog_custom_roll_modifier" && values.dialog_custom_roll_modifier_reason) {

					description = values.dialog_custom_roll_modifier_reason;
				
				} else if (key === "hit_location_modifier" && values.hit_location) {
					
					// hit location row
					hitLocationDescription = values.hit_location;

					// summary 
					description = values.hit_location;

				} else if (key == "deceptive_strike" && modifier < 0) {

					defenderMod = modifier/2;

					description = `Deceptive Strike. Defender at ${defenderMod}.`;

				} else if ( key == "melee_maneuver" ||
							key == "melee_all_out_attack" || 
							key == "posture" ||
							key == "melee_height_difference" ||
							key == "defense_height_difference" ||
							key == "weapon_hand" || 
							key == "ranged_weapon_hand" ||
							key == "ranged_vehicle_conditions" ||
							key == "ranged_maneuver" || 
							key == "defense_maneuver" ||
							key == "spell_natures_strength" ) {

					// we already have the description

				} else {
					
					description = field.description;						
				
				}

				// only add a description if there's a modifier value
				if (modifier > 0) {
					summary.set(key, `+${modifier} ${description}`);
				} else if (modifier < 0) {
					
					summary.set(key, `${modifier} ${description}`);

					// apply max skill of 9 if field has it
					if (field.isMax9) {
						max9 = 1;
					}
				} else if (key == "mighty_blow" && values.mighty_blow) {

					summary.set(key, description);

				}

				// set max skill of 9 if the melee max 9 was set to true
				if (meleeMax9) {
					max9 = 1;
				}
				
			} else if (field && field.isTrait) {

				// if there's a trait with a selected modifier, display the modifier and the description
				if (field.isDropDown && value !== 0) {
					traitSummary.set(key, `+${value} ${field.description}`);
				} else if (value) {
					// if the trait is a checkbox, just show the description
					traitSummary.set(key, `${field.description}`);
				}

			}

		}
	
		return [totalMod, max9, summary, traitSummary, hitLocationDescription, maneuverDescription, allOutDescription];

	}

	/**
	 * Get modifier, description, and max skill of 9 
	 * for a melee maneuver
	 *
	 * @param string maneuver User's selected maneuver
	 *
	 * @return array [modifier, description, max9]
	 */
	function getModifierForMeleeManeuver(maneuver) {

		let modifier = 0;

		let description = "";

		let max9 = 0;

		switch (maneuver) {
			case "step-attack":
				modifier = 0;
				description = "Step and Attack";
				break;
		
			case "step-feint":
				modifier = 0;
				description = "Step and Feing";
				break;
		
			case "move-attack":
				modifier = -4;
				description = "Move and Attack";
				max9 = 1;
				break;
		
			case "move-wild-swing":
				modifier = -5;
				description = "Move and Wild Swing. Random hit location!";
				max9 = 1;
				break;
		
			case "move-slam":
				modifier = 0;
				description = "Move and Slam.";
				break;
		
			case "flying-tackle":
				modifier = 4;
				description = "Flying Tackle. Fall prone.";
				break;
		
			case "pounce":
				modifier = 4;
				description = "Pounce. Roll DX, Jump, or Acrobatics to avoid prone.";
				break;
		
			default:
				break;
		}
		
		return [modifier, description, max9];

	}

	/**
	 * Get modifier, description for a defense maneuver
	 *
	 * @param string maneuver User's selected maneuver
	 *
	 * @return array [modifier, description]
	 */
	 function getModifierForDefenseManeuver(maneuver) {

		let modifier = 0;

		let description = "";

		switch (maneuver) {
			case "step-attack":
				modifier = 0;
				description = "Normal Defense";
				break;
		
			case "all-out-defense-increased":
				modifier = 2;
				description = "All-Out Defense: Increased";
				break;
		
			case "all-out-defense-double":
				modifier = 0;
				description = "All-out Defense: Double";
				max9 = 1;
				break;
		
			case "moved-attack":
				modifier = 0;
				description = "Moved and Attacked, only dodge/block no retreat.";
				max9 = 1;
				break;
		
			default:
				break;
		}
		
		return [modifier, description];

	}

	/**
	 * Get modifier, description for a ranged maneuver
	 *
	 * @param string maneuver             User's selected maneuver
	 * @param int    defaultOrBulkPenalty The penalty to apply for move/attack. 
	 *
	 * @return array [modifier, description]
	 */
	 function getModifierForRangedManeuver(maneuver, defaultOrBulkPenalty) {

		let modifier = 0;

		let description = "";

		switch (maneuver) {
			case "step-attack":
				modifier = 0;
				description = "Step and Attack";
				break;
		
			case "move-attack-ranged":
				modifier = defaultOrBulkPenalty;
				description = "Move and Attack";
				break;
		
			case "all-out-determined":
				modifier = 1;
				description = "All-Out Attack, Determined";
				break;
		
			case "all-out-suppression":
				modifier = 0;
				description = "All-Out Attack, Suppression Fire";
				break;
		
			default:
				break;
		}
		
		return [modifier, description];

	}

	/**
	 * Get modifier, description, and max skill of 9 
	 * for an all-out attack
	 *
	 * @param string type Type of all-out attack
	 *
	 * @return array [modifier, description]
	 */
	function getModifierForAllOutAttack(type) {

		let modifier = 0;

		let description = "";

		switch (type) {
			case "0":
				modifier = 0;
				description = "";
				break;
		
			case "determined":
				modifier = 4;
				description = "All-Out Attack Determined.";
				break;
		
			case "double":
				modifier = 0;
				description = "All-Out Attack Double.";
				break;
		
			case "feint":
				modifier = 0;
				description = "All-Out Feint and Attack.";
				break;
		
			case "strong":
				modifier = 0;
				description = "All-out Attack Strong. +2 or +1 per die damage.";
				break;

			default:
				break;
		}
		
		return [modifier, description];

	}

	/**
	 * Get modifier, description, and max skill of 9 
	 * for attacker's posture
	 *
	 * @param string posture Attacker's posture
	 *
	 * @return array [modifier, description]
	 */
	function getModifierForPosture(posture) {

		let modifier = 0;

		let description = "";

		switch (posture) {
			case "0":
				modifier = 0;
				description = "";
				break;
		
			case "crawling":
				modifier = -4;
				description = "Crawling";
				break;
		
			case "prone":
				modifier = -4;
				description = "Prone";
				break;
		
			case "crouching":
				modifier = -2;
				description = "Crouching";
				break;
		
			case "kneeling":
				modifier = -2;
				description = "Kneeling";
				break;

			case "sitting":
				modifier = -2;
				description = "Sitting";
				break;

			default:
				break;
		}
		
		return [modifier, description];

	}

	/**
	 * Get modifier, description for difference in height
	 *
	 * @param string height Difference in height
	 *
	 * @return array [modifier, description]
	 */
	function getModifierForHeightDifference(height) {

		let modifier = 0;

		let description = "";

		switch (height) {
			case "2-higher-legs-feet":
				modifier = -2;
				description = "Leg/feet, if up to two feet higher.";
				break;
		
			case "2-higher-head-neck":
				modifier = 2;
				description = "Head/Neck, if up to two feet higher.";
				break;
		
			case "2-lower-legs-feet":
				modifier = 2;
				description = "Leg/feet, if up to two feet lower.";
				break;
		
			case "2-lower-head-neck":
				modifier = -2;
				description = "Head/Neck, if up to two feet lower.";
				break;

			case "3-higher-legs-feet":
				modifier = -2;
				description = "Legs/feet, if up to three feet higher.";
				break;

			case "3-higher-head-neck":
				modifier = 2;
				description = "Head/Neck, if up to three feet higher.";
				break;

			case "3-lower-legs-feet":
				modifier = 2;
				description = "Legs/feet, if up to three feet lower.";
				break;

			case "3-lower-head-neck":
				modifier = -2;
				description = "Head/Neck, if up to three feet lower.";
				break;

			case "4-higher-legs-feet":
				modifier = -20;
				description = "Can't hit feet, if up to four feet higher.";
				break;

			case "4-higher-head-neck":
				modifier = 2;
				description = "Head/Neck, if up to 4 feet higher.";
				break;

			case "4-lower-head-neck":
				modifier = -2;
				description = "Head/Neck, if up to 4 feet lower.";
				break;

			case "5-higher-legs-feet":
				modifier = -20;
				description = "Can't hit Left/feet, if up to 5 feet higher.";
				break;

			case "5-higher-head-neck":
				modifier = 2;
				description = "Head/Neck, if up to 5 feet higher.";
				break;

			case "5-lower-legs-feet":
				modifier = 2;
				description = "Legs/feet, if up to 5 feet lower.";
				break;

			case "5-lower-head-neck":
				modifier = -20;
				description = "Can't hit Head/Neck, if up to 5 feet lower.";
				break;

			case "6-higher-legs-feet":
				modifier = -20;
				description = "Can't hit Legs/feet, if up to 6 feet higher.";
				break;

			case "6-higher-head-neck":
				modifier = 2;
				description = "Head/Neck, if up to 6 feet higher.";
				break;

			case "6-lower-legs-feet":
				modifier = 2;
				description = "Legs/feet, if up to 6 feet lower.";
				break;

			case "6-lower-head-neck":
				modifier = -20;
				description = "Can't hit Head/Neck, if up to 6 feet lower.";
				break;

			default:
				break;
		}
		
		return [modifier, description];

	}

	/**
	 * Get defense modifier, description for difference in height
	 *
	 * @param string height Difference in height
	 *
	 * @return array [modifier, description]
	 */
	 function getModifierForDefenseHeightDifference(height) {

		let modifier = 0;

		let description = "";

		switch (height) {
			case "2-3-higher":
				modifier = 1;
				description = "2-3 feet above attacker.";
				break;
		
			case "3-4-higher":
				modifier = 2;
				description = "3-4 feet above attacker.";
				break;
		
			case "4-6-higher":
				modifier = 3;
				description = "4-6 feet above attacker.";
				break;
		
			case "2-3-below":
				modifier = -1;
				description = "2-3 feet below attacker.";
				break;
		
			case "3-4-below":
				modifier = -2;
				description = "3-4 feet below attacker.";
				break;
		
			case "4-6-below":
				modifier = -3;
				description = "4-6 feet below attacker.";
				break;
		
			default:
				break;
		}
		
		return [modifier, description];

	}

	/**
	 * Get modifier, description for vehicle conditions
	 *
	 * @param string condition What condition is vehicle experiencing
	 *
	 * @return array [modifier, description]
	 */
	function getModifierForVehicleConditions(condition) {

		let modifier = 0;

		let description = "";

		switch (condition) {
			case "air-handheld":
				modifier = -1;
				description = "Air vehicle. Using handheld weapon.";
				break;
		
			case "ground-good-road-handheld":
				modifier = -1;
				description = " Ground vehicle, good road. Using handheld weapon.";
				break;
		
			case "ground-bad-road-fixed":
				modifier = -1;
				description = "Ground vehicle, bad road. Weapon in fixed mount/hardpoint/carriage.";
				break;
		
			case "ground-bad-road-external":
				modifier = -2;
				description = "Ground vehicle, bad road. Weapon in external open mount.";
				break;

			case "ground-bad-road-handheld":
				modifier = -3;
				description = "Ground vehicle, bad road. Using handheld weapon.";
				break;

			case "ground-off-road-stabilized-turret":
				modifier = -1;
				description = "Ground vehicle, off-road. Weapon in stabalized turret/open mount.";
				break;

			case "ground-off-road-fixed":
				modifier = -2;
				description = "Ground vehicle, off-road. Weapon in fixed mount/hardpoint/carriage.";
				break;

			case "ground-off-road-external":
				modifier = -3;
				description = "Ground vehicle, off-road. Weapon in external open mount.";
				break;

			case "ground-off-road-handheld":
				modifier = -4;
				description = "Ground vehicle, off-road. Using handheld weapon.";
				break;

			case "water-calm-fixed":
				modifier = 2;
				description = "-1 : Water vehicle, calm. Weapon in fixed mount/hardpoint/carriage.";
				break;

			case "water-calm-external":
				modifier = -2;
				description = "Water vehicle, calm. Weapon in external mount.";
				break;

			case "water-calm-handheld":
				modifier = -3;
				description = "Water vehicle, calm. Using handheld weapon.";
				break;

			case "water-rough-stabilized-turret":
				modifier = -1;
				description = "Water vehicle, rough. Weapon in stabilized turret/open mount.";
				break;

			case "water-rough-fixed":
				modifier = -2;
				description = "Water vehicle, rough. Weapon in fixed mount/hardpoint/carriage.";
				break;

			case "water-rough-external":
				modifier = -3;
				description = "Water vehicle, rough. Weapon in external mount.";
				break;

			case "water-rough-handheld":
				modifier = -4;
				description = "Water vehicle, rough. Using handheld weapon.";
				break;

			default:
				break;
		}
		
		return [modifier, description];
	}

	/**
	 * Get modifier, description for nature's strength
	 *
	 * @param string strength The strength of nature
	 *
	 * @return array [modifier, description]
	 */
	function getModifierForNaturesStrength(strength) {

		let modifier = 0;

		let description = "";

		switch (strength) {
			case "wilderness-1":
				modifier = 1;
				description = "Primeval Wilderness.";
				break;
		
			case "wilderness-2":
				modifier = 2;
				description = "Primeval Wilderness.";
				break;
		
			case "wilderness-3":
				modifier = 3;
				description = "Primeval Wilderness.";
				break;
		
			case "wilderness-4":
				modifier = 1;
				description = "Primeval Wilderness.";
				break;
		
			case "wilderness-5":
				modifier = 1;
				description = "Primeval Wilderness.";
				break;
		
			case "not-pristine-wilderness-1":
				modifier = -1;
				description = "Not Pristine Wilderness";
				break;

			case "structures-2":
				modifier = -2;
				description = "Artificial Structures";
				break;
				
			case "structures-3":
				modifier = -3;
				description = "Artificial Structures";
				break;
				
			case "structures-4":
				modifier = -4;
				description = "Artificial Structures";
				break;
				
			case "defiled-5":
				modifier = -5;
				description = "Nature Defiled";
				break;
				
			case "defiled-6":
				modifier = -6;
				description = "Nature Defiled";
				break;
				
			case "defiled-7":
				modifier = -7;
				description = "Nature Defiled";
				break;
				
			case "defiled-8":
				modifier = -8;
				description = "Nature Defiled";
				break;
				
			case "defiled-9":
				modifier = -9;
				description = "Nature Defiled";
				break;
				
			case "supernatural-defiled-10":
				modifier = -10;
				description = "Nature Supernaturally Defiled";
				break;
				
			default:
				break;
		}
		
		return [modifier, description];
	}

	/**
	 * Gets modifier and description for 
	 * handedness.
	 * 
	 * @param string hand                 Single/Dual weapon attack
	 * @param int    off_hand_training    Off-Hand Weapon training
	 * @param int    dual_weapon_training Dual-Weapon training
	 *
	 * @return array [modifier, description]
	 */
	function getModifierHandedness(hand, off_hand_training, dual_weapon_training) {

		let offHandTraining = Number(off_hand_training);

		let dualWeaponTraining = Number(dual_weapon_training);

		let modifier = 0;

		let description = "";

		switch (hand) {
			case "off-hand":
				modifier = -4 + offHandTraining;
				description = "Off-hand";
				break;
		
			case "dual-weapon-primary-hand":
				modifier = -4 + dualWeaponTraining;
				if (modifier > 0) {
					modifier = 0;
				}
				description = "Dual-Weapon Attack.";
				break;
		
			case "dual-weapon-off-hand":
				modifier = -4 + dualWeaponTraining + offHandTraining;
				if (modifier > 0) {
					modifier = 0;
				}
				description = "Off-Hand Dual-Weapon Attack.";
				break;
		
			default:
				break;
		}

		return [modifier, description];

	}

	/**
	 * Get shock penalty, factor in high and low pain threshold
	 *
	 * @param int  shockPenalty         Original shock penalty
	 * @param bool hasHighPainThreshold Has trait
	 * @param bool hasLowPainThreshold  Has trait
	 *
	 * @return int New shock Penalty
	 */
	function getShockPenalty(shockPenalty, hasHighPainThreshold, hasLowPainThreshold) {

		let newPenalty = shockPenalty;

		if (newPenalty && hasHighPainThreshold) {

			newPenalty = 0;

		} else if (newPenalty && hasLowPainThreshold) {
			newPenalty = newPenalty * 2;
		}

		return newPenalty;
	}
	
	/**
	 * Get pain level penalty, factor in high and low pain threshold
	 *
	 * @param int  painLevel            Original pain level
	 * @param bool hasHighPainThreshold Has trait
	 * @param bool hasLowPainThreshold  Has trait
	 *
	 * @return int Penalty
	 */
	 function getPainLevelPenalty(painLevel, hasHighPainThreshold, hasLowPainThreshold) {

		let penalty = painLevel;

		// if high pain threshold, halve the pain penalty
		if (penalty && hasHighPainThreshold) {
		
			penalty = penalty / 2;
		
		} else if (penalty && hasLowPainThreshold) {
		
			penalty = penalty * 2;
		
		}

		return penalty;

	}

	// define each skill type section that can use
	// the tool modifier dialog box
	const toolSections = [
		"skill",
		"technique",
		"defense",
		"melee",
		"ranged",
		"spell",
	];

	// defines which section of the roll dialog to display
	// for skills.
	const displaySectionsForSkills = {
		"display_visibility_section": 1,
		"display_afflictions_section": 1,
		"display_tasks_section": 1,
		"display_equipment_section": 1,
		"display_attack_section": 0,
		"display_melee_maneuvers_section": 0,
		"display_ranged_maneuvers_section": 0,
		"display_defense_maneuvers_section": 0,
		"display_spell_modifiers_section": 0,
	};

	const displaySectionsForTechniques = {
		"display_visibility_section": 1,
		"display_afflictions_section": 1,
		"display_tasks_section": 1,
		"display_equipment_section": 1,
		"display_attack_section": 0,
		"display_melee_maneuvers_section": 0,
		"display_ranged_maneuvers_section": 0,
		"display_defense_maneuvers_section": 0,
		"display_spell_modifiers_section": 0,
	};

	const displaySectionsForDefense = {
		"display_visibility_section": 0,
		"display_afflictions_section": 0,
		"display_tasks_section": 0,
		"display_equipment_section": 0,
		"display_attack_section": 0,
		"display_melee_maneuvers_section": 0,
		"display_ranged_maneuvers_section": 0,
		"display_defense_maneuvers_section": 1,
		"display_spell_modifiers_section": 0,
	};

	const displaySectionsForMelee = {
		"display_visibility_section": 1,
		"display_afflictions_section": 1,
		"display_tasks_section": 0,
		"display_equipment_section": 0,
		"display_attack_section": 1,
		"display_melee_maneuvers_section": 1,
		"display_ranged_maneuvers_section": 0,
		"display_defense_maneuvers_section": 0,
		"display_spell_modifiers_section": 0,
	};

	const displaySectionsForRanged = {
		"display_visibility_section": 1,
		"display_afflictions_section": 1,
		"display_tasks_section": 0,
		"display_equipment_section": 0,
		"display_attack_section": 1,
		"display_melee_maneuvers_section": 0,
		"display_ranged_maneuvers_section": 1,
		"display_defense_maneuvers_section": 0,
		"display_spell_modifiers_section": 0,
	};

	const displaySectionsForSpell = {
		"display_visibility_section": 0,
		"display_afflictions_section": 1,
		"display_tasks_section": 0,
		"display_equipment_section": 0,
		"display_attack_section": 0,
		"display_melee_maneuvers_section": 0,
		"display_ranged_maneuvers_section": 0,
		"display_defense_maneuvers_section": 0,
		"display_spell_modifiers_section": 1,
	};

	// loop through each section and create event handlers
	// this reduces the amount of code that needs to be written
	toolSections.forEach(section => {

		// show modal box for skill modifiers for section
		on(`clicked:show_roll_modifiers_for_${section}`, (event) => {

			let basefields = {
				"show_roll_modifiers": 1,
				"roll_modifier_types": section
			};

			let fields;

			// determine which display sections to display on dialog box
			switch (section) {
				case "technique":
					fields = {
						...basefields,
						...displaySectionsForTechniques,
					};
					break;
			
				case "defense":
					fields = {
						...basefields,
						...displaySectionsForDefense,
					};
					break;
			
				case "melee":
					fields = {
						...basefields,
						...displaySectionsForMelee,
					};
					break;
			
				case "ranged":
					fields = {
						...basefields,
						...displaySectionsForRanged,
					};
					break;
			
				case "spell":
					fields = {
						...basefields,
						...displaySectionsForSpell,
					};
					break;
			
				case "skill":
				default:
					fields = {
						...basefields,
						...displaySectionsForSkills,
					};
					break;
			
			}

			setAttrs(fields, {silent:true});

		});

		/* If roll modifier is turned off, clear the values to avoid them from being used in roll template */
		on(`change:use_${section}_modifier_tool`, event => {

			let updateFields = {
				[`${section}_roll_modifier`]: 0,
				[`${section}_roll_modifier_summary`]: "",
				[`${section}_roll_trait_summary`]: "",
				[`${section}_roll_max_nine`]: 0, 
				[`${section}_roll_max_nine_value`]: 100,
				[`${section}_roll_hit_location`]: "",
				[`${section}_roll_maneuver`]: "",
				[`${section}_roll_allout_attack`]: "",
			}

			setAttrs(updateFields, {silent: true});

		});

		const CUSTOM_MOD_DESC = "custom modifier";

		/* check for manual changes to skill modifier boxes */
		on(`change:${section}_roll_modifier`, event => {

			let newValue = Number(event.newValue);

			if (isNaN(newValue)) {
				newValue = 0;
			}

			getAttrs([`${section}_roll_modifier`, `${section}_roll_modifier_summary`], values => {

				let summary = values[`${section}_roll_modifier_summary`];

				let [customMod, summaryUpdated] = updateCustomModifierSummary(newValue, summary, CUSTOM_MOD_DESC);

				let updateFields = {
					[`${section}_roll_modifier_summary`]: summaryUpdated,
					dialog_custom_roll_modifier: customMod
				}

				setAttrs(updateFields);

			});

		});

	});


	/**
	 * Updates the custom modifier line for a summary 
	 * and returns the corrected total
	 * Example: summary = -1 custom modifier¬-2 Encumbrance
	 *          note: ¬ is a line feed character
	 *          rollModifier = -5
	 * 			customModifier = rollModifier - (sum of other lines) = -5 - (-2) = -3
	 *          new summary = -3 custom modifier¬-2 Encumbrance
	 *          
	 *          
	 * @param int    rollModifier The value of the custom modifier
	 * @param string summary      The Current summary
	 * @param string modifierDesc The text that describes the roll modifier

	 * @return array [customModifier,summaryNew] 
	 */
	function updateCustomModifierSummary(rollModifier, summary, modifierDesc) {

		// after removing the custom modifier, sum up the remaining modifiers
		let totalMod = 0;

		// make sure to remove any carriage returns
		let summaryNew = summary.replaceAll("\r", "");

		// remove anything that matches the modifierDesc
		let pattern = new RegExp(`-?[0-9]\d* ${modifierDesc}\n`, "gi");

		summaryNew = summaryNew.replace(pattern, "");

		// create an array so we can pull out modifiers and update totalMod
		let arrSummary = summaryNew.split("\n");

		arrSummary.forEach(line => {

			let arrLine = line.split(" ");

			// the first element will always be the modifier number, unless a coder breaks the patter
			let modifier = Number(arrLine[0]);

			if (isNaN(modifier)) {
				modifier = 0;
			}

			totalMod += modifier;

		});

		// the remainder should go tothe custom Modifier
		let customModifier = rollModifier - totalMod;

		// if negative or postive value, add the description to the beginning
		if (customModifier !== 0) {

			summaryNew = `${customModifier} ${modifierDesc}\n` + summaryNew;

		}
	
		return [customModifier,summaryNew];

	}

	// check for change to hit location fields
	// easier to read and change list of fields using this method
	const arrChangeHitLocationFields = [
		"change:hit_location_type",
		"change:humanoid_location", 
		"change:humanoid_low_tech_location",
		"change:humanoid_martial_arts_location",
		"change:arachnoid_location",
		"change:avian_location", 
		"change:cancroid_location",
		"change:centaur_location",
		"change:hexapod_location",
		"change:ichthyoid_location",
		"change:octopod_location",
		"change:quadruped_location",
		"change:vehicle_location",
		"change:vermiform_location",
		"change:weapon_location",
		"change:grapple_modifier",
		"change:has_shield",
		"change:target_chink_in_armor",
		"change:target_size_modifier",
		"change:target_light_cover",
		"change:target_down",
		"change:target_partly_exposed",
		"change:target_intervening_figures",
	];

	const changeHitLocationFields = arrChangeHitLocationFields.join(" ");

	on(changeHitLocationFields, event => {
		
		updateHitLocationModifiers();

	});

	/**
	 * update the default drop-down based on selected type
	 *
	 * @param function callback function to run after update is completed
	 **/
	function updateHitLocationDropDownsByType(callback) {

		getAttrs(["hit_location_type"], values => {

			let type = values.hit_location_type;

			let updateFields;

			switch (type) {
				case "humanoid":
				case "arachnoid":
				case "avian":
				case "cancroid":
				case "centaur":
				case "hexapod":
				case "octopod":
				case "quadruped":
				case "vermiform":
					updateFields = {
						[`${type}_location`]: "torso-0"
					};
					break;
			
				case "humanoid_martial_arts":
				case "humanoid_low_tech":
					updateFields = {
						[`${type}_location`]: "chest-0"
					};
					break;
				
				case "vehicle":
					updateFields = {
						[`${type}_location`]: "body-0"
					};
					break;

				case "weapon":
					updateFields = {
						[`${type}_location`]: "damage-reach-c-5"
					};
					break;

				default:
					break;
			}

			setAttrs(updateFields, {silent: true}, callback);

		});

	}

	function updateHitLocationModifiers() {

		const fields = [
			"target_size_modifier",
			"hit_location_type",
			"humanoid_location", 
			"humanoid_low_tech_location",
			"humanoid_martial_arts_location",
			"arachnoid_location",
			"avian_location", 
			"cancroid_location",
			"centaur_location",
			"hexapod_location",
			"ichthyoid_location",
			"octopod_location",
			"quadruped_location",
			"vehicle_location",
			"vermiform_location",
			"weapon_location",
			"grapple_modifier",
			"has_shield",
			"target_chink_in_armor",
			"target_light_cover",
			"target_down",
			"target_partly_exposed",
			"target_intervening_figures",
			"size",
			"display_melee_maneuvers_section"
		];

		getAttrs(fields, values => {

			let type = values.hit_location_type;

			let location = values[`${type}_location`];

			let grapple = Number(values.grapple_modifier);

			let sizeModifier = Number(values.target_size_modifier) || 0;

			let characterSize = Number(values.size) || 0;

			let isMelee = values.display_melee_maneuvers_section == "1";

			let sizeModifierLabel = "SM";

			// if melee, use relative size modifier. See FAQ. http://www.sjgames.com/gurps/faq/FAQ4-3.html#SS3.4.2.23
			if (isMelee) {

				sizeModifier = sizeModifier - characterSize;

				sizeModifierLabel = "Relative SM";
			}

			let hasShield = Number(values.has_shield) === 1 ? true : false;

			let chinkInArmor = Number(values.target_chink_in_armor) === 1 ? true : false;

			let partlyExposed = Number(values.target_partly_exposed) === 1 ? true : false;

			let targetDown = Number(values.target_down) === 1 ? true : false;

			let lightCover = Number(values.target_light_cover) === 1 ? true : false;

			let interveningFigures = Number(values.target_intervening_figures);

			// make sure it's an integer
			interveningFigures = Math.floor(interveningFigures);

			// damage-reach-c-5
			// split into an array
			// [damage, reach, c, 5]
			// last element is the penalty
			let arrLocation = location.split("-");

			// remove the last element fromt they array
			// [damage, reach, c, 5]
			// locationMod = 5
			// arrLocation = [damage, reach, c, 5]
			let locationMod = arrLocation.splice(arrLocation.length - 1, 1);

			// convert to negative number
			locationMod = Number(locationMod) * -1;

			// now join the remaining pieces to get a description
			// [damage, reach, c, 5]
			// locationNote = "humanoid (SM 0)" + "damage reach c"

			// NOTE: some types of underscores, like humanoid_nartial_arts.
			let typeDescription = type.replace(/_/g, " ");

			let locationNote = `${typeDescription} (${sizeModifierLabel} ${sizeModifier}) ` + arrLocation.join(" ");

			// check for shield modifier
			if (hasShield && isHitLocationAffectedByShield(locationNote)) {

				locationMod = locationMod * 2;
				
				locationNote += " with a shield.";		

			}

			// check if target or hit location is partly exposed
			if (partlyExposed) {
				
				locationMod = locationMod - 2;

				locationNote += " Partly exposed.";
			}

			// check for proned target
			if (targetDown && isHitLocationAffectedByProne(locationNote)) {

				locationMod = locationMod - 2;

				locationNote += " Target Prone.";

			}

			// check for grappling
			if (grapple >= 0) {

				// divid the modifier by half and update the note
				locationMod = Math.floor(locationMod/2) + grapple;

				locationNote = "Grappling " + locationNote;

			}

			// check for chink in armor
			if (chinkInArmor && (arrLocation.includes("torso") || arrLocation.includes("chest") || arrLocation.includes("body") )) {

				locationMod = -8;

				locationNote += " chinks in armor. DR/2.";

			} else if (chinkInArmor) {

				locationMod = -10;

				locationNote += " chinks in armor. DR/2.";

			}

			// check for light cover
			if (lightCover) {

				locationMod += -2;

				locationNote += " Light cover.";

			}
			
			// check for intervening figures
			if (interveningFigures) {

				locationMod += interveningFigures * -4;

				locationNote += ` ${interveningFigures} intervening figures.`;

			}

			let finalMod = sizeModifier + locationMod;

			setAttrs({
				hit_location_modifier: finalMod,
				hit_location: locationNote,
			});

		});

	}

	/**
	 * Determine if hit location can be affected by a shield
	 * valid locations: arm, hand, leg, foot, pincer, wing, tail
	 * 
	 * @param string location Hit location being targeted
	 *
	 * @return bool
	 */
	function isHitLocationAffectedByShield(location) {
		
		let arrLocation = location.split(" ");

		const limbs = [
			"arm",
			"hand",
			"leg",
			"foot",
			"pincer",
			"wing",
			"tail"
		];

		let applyShield = false;

		limbs.forEach(limb => {

			if (arrLocation.includes(limb)) {
				applyShield = true;
			}
			
		});

		return applyShield;

	}

	/**
	 * Determine if hit location can be affected when a target is
	 * kneeling, sitting, crouching, or lying down
	 * valid locations: torso, chest, groin, leg
	 * 
	 * @param string location Hit location being targeted
	 * 
	 * @return bool
	 */
	 function isHitLocationAffectedByProne(location) {

		let arrLocation = location.split(" ");

		const locations = [
			"leg",
			"chest",
			"groin",
			"torso",
		];

		let applyProne = false;

		locations.forEach(location => {

			if (arrLocation.includes(location)) {
				applyProne = true;
			}
			
		});

		return applyProne;

	}

	// if range/speed change, update the modifier
	on("change:ranged_range_speed change:ranged_elevation", event => {

		updateRangeSpeedModifier();

	});

	/**
	 * Update the speed/range modifier based on number of hexes
	 * in attr_ranged_range_speed
	 */
	function updateRangeSpeedModifier() {
		
		getAttrs(["ranged_range_speed", "ranged_elevation"], values => {

			let hexes = Number(values.ranged_range_speed);

			let elevation = Number(values.ranged_elevation);

			hexes = addElevationModifier(hexes, elevation);

			let modifier = getModBySpeedRange(hexes);

			setAttrs({ranged_range_speed_modifier: modifier});

		});
	}

	/**
	 * Add in the elevation modifier to the ground ranged
	 *
	 * @param int range Distance between two targets at the same elevation
	 * @param int elavation If positive, the shooter is above the target, negative shooter is below the target
	 *
	 * @return int
	 */
	function addElevationModifier(range, elevation) {

		let rangeMod = 0;

		if (elevation > 0) {

			// firing downward
			rangeMod = Math.floor(elevation/2);

			// max elevation is half of ground distance
			if (rangeMod > Math.floor(range/2)) {

				rangeMod = Math.floor(range/2);

			}
			
			// firing downward reduces the range
			rangeMod = rangeMod * -1;

		} else if (elevation < 0) {

			// firing upward adds range, make the number positive
			rangeMod = elevation * -1;

		}

		// calculate the final range
		range += rangeMod;

		return range;

	}

	// if ranged rate of fire changed, update the modifier
	on("change:ranged_rof", event => {

		getAttrs(["ranged_rof"], values => {

			let modifier = getRateOfFireModifier(Number(values.ranged_rof));

			setAttrs({ranged_rof_modifier: modifier});

		});

	});

	// see: https://app.roll20.net/forum/post/7251390/slug%7D
	const modByRateOfFire = [ 
                    	{r:4, m:0},
                    	{r:8, m:1},
                    	{r:12, m:2},
                    	{r:16, m:3},
                    	{r:24, m:4},
                    	{r:49, m:5},
                    	{r:99, m:6},
                    	{r:199, m:7},
					];

	function getRateOfFireModifier(rof) {

		const entry = modByRateOfFire.find((o)=>o.r>=rof );
		
		// TODO: use formula. each x2 RoF add +1 to hit
		
    	// if no matches, return 8.
    	return (entry != undefined ? entry.m : 8);

	}

	// check for change to hit location fields
	// easier to read and change list of fields using this method
	const arrChangeTargetingSystems = [
		"change:ranged_scope_bonus",
		"change:ranged_vehicle_targeting_bonus", 
		"change:ranged_laser_sight",
		"change:ranged_accuracy_bonus",
		"change:vehicle_stability_rating",
		"change:vehicle_weapon_unstabilized", 
	];

	const changeTargetingSystems = arrChangeTargetingSystems.join(" ");

	on(changeTargetingSystems, event => {
		
		updateTargetingSystems();

	});

	function updateTargetingSystems() {

		const fields = [
			"ranged_scope_bonus",
			"ranged_vehicle_targeting_bonus",
			"ranged_laser_sight",
			"ranged_accuracy_bonus",
			"vehicle_stability_rating",
			"vehicle_weapon_unstabilized",
		];

		getAttrs(fields, values => {

			let modifier = 0;

			let scope = Number(values.ranged_scope_bonus);

			let targeting = Number(values.ranged_vehicle_targeting_bonus);

			let laser = Number(values.ranged_laser_sight);

			let stability = Number(values.vehicle_stability_rating);

			let unstabilized = Number(values.vehicle_weapon_unstabilized);

			let accuracy = Number(values.ranged_accuracy_bonus);

			modifier = scope + targeting + laser;

			// check for unstabilized vehicle weapon
			if (unstabilized && modifier > stability) {

				// targeting can't exceed the stability rating
				modifier = stability;

			} else if (modifier > accuracy) {
				
				// targeting can't exceed accuracy bonus
				modifier = accuracy;

			}

			setAttrs({ranged_targeting_system_modifier: modifier});

		});

	}

	// check for changes to move/attack and bulk
	on("change:ranged_maneuver change:ranged_bulk change:ranged_move_default_or_bulk", event => {

		updateRangedMoveAttackBulk();

	});

	function updateRangedMoveAttackBulk() {

		let fields = [
			"ranged_maneuver",
			"ranged_bulk",
		];

		getAttrs(fields, values => {

			let modifier = 0;

			let bulk = Number(values.ranged_bulk);

			if (values.ranged_maneuver == "move-attack-ranged") {

				modifier = -2;

				// check for bulky item
				if (bulk < modifier) {
					modifier = bulk;
				}

			}

			setAttrs({ranged_move_default_or_bulk: modifier});

		});

	}

	// handle armor hit location call to action
	on("clicked:armor_apply", (event) => {
	   
		clearArmorHitLocations();

		addArmorHitLocations();
	    
	});

	/**
	 * delete all the hit locations from the locations table
     *
	 */
	function clearArmorHitLocations() {

		getSectionIDs("repeating_hitlocation", (ids) => {

            // loop through the rows
			for (var i = 0; i < ids.length; i++) {
		
                removeRepeatingRow("repeating_hitlocation_" + ids[i]);
				
			}

		});

	}

	/**
	 * Add the hit locations based on the selected hit location type
	 */
	function addArmorHitLocations() {

		let fields = [
			"armor_hit_location_type",
			"hit_points_max",
			"size",
		];

		getAttrs(fields, values => {

			let type = values.armor_hit_location_type;

			let hitPoints = Number(values.hit_points_max);

			let sizeMod = Number(values.size);

			let locations = HIT_LOCATIONS_JSON.get(type);

			let rows = {};

			// loop through each location object in the array
			// location = {key: "torso", display: "Torso", penalty: 0, DR: 0, hp_divisor: 1, notes:""},
			locations.forEach(location => {

				let id = generateRowID();

				let penalty = sizeMod + Number(location.penalty);

				let divisor = Number(location.hp_divisor);

				let crippled = 0;

				if (divisor > 1) {
					crippled = Math.floor(hitPoints/divisor) + 1;
				}

				rows[`repeating_hitlocation_${id}_key`] = location.key;

				rows[`repeating_hitlocation_${id}_where`] = location.display;

				rows[`repeating_hitlocation_${id}_layer_1_front`] = location.DR;

				rows[`repeating_hitlocation_${id}_layer_1_back`] = location.DR;

				rows[`repeating_hitlocation_${id}_layer_summary_front`] = location.DR;

				rows[`repeating_hitlocation_${id}_layer_summary_back`] = location.DR;

				rows[`repeating_hitlocation_${id}_penalty`] = penalty;

				rows[`repeating_hitlocation_${id}_divisor`] = location.hp_divisor;

				rows[`repeating_hitlocation_${id}_crippled`] = crippled;

				rows[`repeating_hitlocation_${id}_notes`] = location.notes;

			});

			setAttrs(rows, {silent: true});

		});

		
	}

	/**
	 * Updates hit location table's penalty and crippled values
	 * we have to get all the IDs for each row. 
	 * Get original penalty value
	 * then update the final penalty, divisor, and disabled hit points
	 *
	 * @param int sizeDiff The size difference.
	 */
	function updateRepeatingHitLocationPenaltyCrippledValues(sizeDiff) {

		let fields = [
			"hit_points_max",
		];

		getAttrs(fields, values => {

			let hitPoints = Number(values.hit_points_max);

			// get all the section id numbers
			getSectionIDs("repeating_hitlocation", (ids) => {

				let repeatingFields = [];

				// get a list of values we need from the table rows
				for (var i = 0; i < ids.length; i++) {
				
					let penaltyProp = `repeating_hitlocation_${ids[i]}_penalty`;

					let divisorProp = `repeating_hitlocation_${ids[i]}_divisor`;

					repeatingFields.push(penaltyProp);

					repeatingFields.push(divisorProp);
				
				}
			
				// get the values
				getAttrs(repeatingFields, function (repeatingValues) {

					let updates = {};

					// loop through ids and create a list value to update
					for (var i = 0; i < ids.length; i++) {
				
						let penaltyProp = `repeating_hitlocation_${ids[i]}_penalty`;

						let penalty = Number(repeatingValues[penaltyProp]);

						let divisorProp = `repeating_hitlocation_${ids[i]}_divisor`;

						let divisor = Number(repeatingValues[divisorProp]);

						let newPenalty = sizeDiff + penalty;

						if (divisor < 0) {
							divisor = 1;
						}

						let crippled = 0;

						// only apply cripple valor if divisor is over 1.
						if (divisor > 1) {
							crippled = Math.floor(hitPoints / divisor) + 1;
						}

						let crippledProp = `repeating_hitlocation_${ids[i]}_crippled`;

						updates[penaltyProp] = newPenalty;

						updates[crippledProp] = crippled;
					
					}

					setAttrs(updates, {silent: true});
					
				});

			});

		});

	}

	// check if a hit location layor value changes. If so, update the armor summary
	[1, 2, 3, 4].forEach(layerId => {

		on(`change:repeating_hitlocation:layer_${layerId}_front change:repeating_hitlocation:layer_${layerId}_back`, event => {

			updateArmorSummary();

		});

	});

	/**
	 * Update the armor summary for a row when an armor layer is changed
	 */
	function updateArmorSummary() {
		
		// get all the values for each layer in this row
		let fields = [
				"repeating_hitlocation_layer_1_front",
				"repeating_hitlocation_layer_1_back",
				"repeating_hitlocation_layer_2_front",
				"repeating_hitlocation_layer_2_back",
				"repeating_hitlocation_layer_3_front",
				"repeating_hitlocation_layer_3_back",
				"repeating_hitlocation_layer_4_front",
				"repeating_hitlocation_layer_4_back",
		];

		getAttrs(fields, values => {

			let updates = {};

			// process the front then back locations
			["front", "back"].forEach(direction => {

				let isFlexible = false;

				let isSplit = false;

				let arrPrimaryArmor = [];

				let arrSplitArmor = [];

				let splitTypes = "";

				// sum up the total DR values. Can only do one split DR at this time
				[1, 2, 3, 4].forEach(layerNo => {

					let propName = `repeating_hitlocation_layer_${layerNo}_${direction}`;

					let armor = values[propName].toString();

					let firstDR = 0;

					let secondDR = 0;

					// remove any hardened notes
					const hardenedPattern = /\[.*\]/g;

					armor = armor.replace(hardenedPattern, "");

					if (armor.indexOf("*") != -1) {
						
						isFlexible = true;

						// be sure to remove *
						armor = armor.replace("*", "");
					}

					// check for split DR
					if (armor.indexOf("/") != -1) {

						isSplit = true;

						let arrArmor = armor.split("/");

						firstDR = Number(arrArmor[0]);

						if (isNaN(firstDR)) {
							firstDR = 0;
						}

						arrPrimaryArmor.push(firstDR);

						let arrSecondDR = arrArmor[1].split(" ");

						// pull out the first array, which should be DR
						secondDR = Number(arrSecondDR.splice(0, 1));

						if (isNaN(secondDR)) {
							secondDR = 0;
						}

						arrSplitArmor.push(secondDR);

						splitTypes = arrSecondDR.join(" ");

					} else {

						firstDR = Number(armor);

						if (isNaN(firstDR)) {
							firstDR = 0;
						}

						arrPrimaryArmor.push(firstDR);

						arrSplitArmor.push(firstDR);

					}

				});

				// see: https://stackoverflow.com/questions/1230233/how-to-find-the-sum-of-an-array-of-numbers
				let baseDR = arrPrimaryArmor.reduce((a, b) => a + b, 0);

				let splitDR = arrSplitArmor.reduce((a, b) => a + b, 0);

				let layerSummary = baseDR;

				if (splitDR !== baseDR && isFlexible) {

					layerSummary += `/${splitDR}* ${splitTypes}`;

				} else if (splitDR !== baseDR) {

					layerSummary += `/${splitDR} ${splitTypes}`;

				} else if (isFlexible) {

					layerSummary += `*`;

				}
				
				updates[`repeating_hitlocation_layer_summary_${direction}`] = layerSummary;

			});

			setAttrs(updates, {silent: true});

		});

	}

	// check if a hit locations damage divisor changed
	on(`change:repeating_hitlocation:divisor`, event => {

			updateHitLocationDisabledColumn();

	});

	/**
	 * Update the hit location disabled column for row that changed
	 * based on divisor and max hit points
	 */
	function updateHitLocationDisabledColumn() {

		let fields = [
			"hit_points_max",
			"repeating_hitlocation_divisor"
		];

		getAttrs(fields, values => {

			let hitPoints = Number(values.hit_points_max);

			let divisor = Number(values.repeating_hitlocation_divisor);

			let crippled = 0;

			if (divisor > 1) {

				crippled = Math.floor(hitPoints/divisor) + 1;

				let updates = {
					repeating_hitlocation_crippled: crippled
				};

				setAttrs(updates, {silent: true});

			}

		});
	}

	// check if damage table hit points were modified
	on (`change:repeating_hitlocation:damage`, event => {

		let previousValue = Number.isNaN(event.previousValue) ? 0 : Number(event.previousValue);

		let newValue = Number.isNaN(event.newValue) ? 0 : Number(event.newValue);

		updateCurrentHitPointsByDamageTable(previousValue, newValue);

	});


	/**
	 * If option to update Hit Points when changing damage table location damage
	 * is on, then update the current Hit Points.
	 * 
	 * @param int previousValue Value before damage was applied
	 * @param int newValue      Value after damage was applied
	 */
	function updateCurrentHitPointsByDamageTable(previousValue, newValue) {

		let arrValues = [
			"damage_update_hit_points",
			"hit_points"
		];
		
		getAttrs(arrValues, values => {

			let diff = 0;

			let updateHitPoints = values.damage_update_hit_points === "1";

			// if previous and newvalue are the same, use 0 for previous value
			if (previousValue === newValue) {
			
				// special case, use previous = 0 and just use the newValue
				diff = 0 - newValue;

			} else {
				
				// normal process
				diff = previousValue - newValue;
			
			}

			if (updateHitPoints) {

				let hitPoints = Number(values.hit_points);

				let newHitPoints = hitPoints - diff;

				setAttrs({hit_points: newHitPoints});

			}
		
		});

	}

	on("change:selected_token", event => {
		
		setSelectedMacro();

	});

	/**
	 * If checked, add selected macro to die roll
	 */
	function setSelectedMacro() {

		getAttrs(["selected_token"], values => {

			let macro = "";

			if (values.selected_token === "on") {

				macro = "@{selected|token_name}";

			}

			setAttrs({selected_token_macro: macro});

		});

	}

	on("change:target_token", event => {
		
		setTargetMacro();

	});

	/**
	 * If checked, add target macro to die roll
	 */
	function setTargetMacro() {

		getAttrs(["target_token"], values => {

			let targetMacro = "";

			if (values.target_token === "on") {

				targetMacro = "@{target|token_name}";

			}

			setAttrs({target_token_macro: targetMacro});

		});

	}

	["melee", "ranged", "spell", "skill", "technique", "defense"].forEach(section => {

		on(`clicked:${section}_roll_reset`, (event) => {

			resetRollModifiers(section);
	
		});

	});
	
	/**
	 * Reset the roll modifiers for a section
	 *
	 * @param string section Name of section to update.
	 */
	function resetRollModifiers(section) {

		let updates = {};

		updates[`${section}_roll_modifier`] = 0;
		updates[`${section}_roll_modifier_summary`] = "";
		updates[`${section}_roll_trait_summary`] = "";
		updates[`${section}_roll_hit_location`] = "";
		updates[`${section}_roll_allout_attack`] = "";
		updates[`${section}_roll_max_nine`] = 0;

		// if defense, also reset Defense Bonuses
		if (section == "defense") {
			updates[`${section}_apply_shield_db`] = 0;
			updates[`${section}_apply_magic_db`] = 0;
		}

		// check for resetting encumbrance
		if (section == "defense" || section == "skill") {
			updates[`${section}_roll_apply_encumbrance`] = 0;
		}
			
		setAttrs(updates, {silent: true});

	}

	["skill", "technique", "defense"].forEach(section => {

		on(`change:${section}_roll_apply_encumbrance change:encumbrance_level`, (event) => {

			applyEncumbrancePenalty(section);
	
		});

	});

	/**
	 * Apply encumbrance penalty to section and roll modifier tool
	 */
	function applyEncumbrancePenalty(section) {

		const fields = [
			"encumbrance_level",
			`${section}_roll_apply_encumbrance`,
			`${section}_roll_modifier_summary`,
			`${section}_roll_modifier`,
		];

		getAttrs(fields, values => {

			let currentEncumbrance = Number(values.encumbrance_level);

			let applyEncumbrance = Number(values[`${section}_roll_apply_encumbrance`]);

			let summary = values[`${section}_roll_modifier_summary`];

			let currentModifier = Number(values[`${section}_roll_modifier`]);

			let newSummary = "";

			let encumbranceModifier = 0;

			let encumbranceLevel = 0;

			// clear out any encumbrance modifiers
			[newSummary, encumbranceModifier] = getSummaryModifierForEncumbrance(summary);

			// if value for encumbranceModifier, update currentModifier
			if (encumbranceModifier < 0) {

				currentModifier += (-1 * encumbranceModifier);

			}

			if (applyEncumbrance === 1) {

				encumbranceLevel = -1 * currentEncumbrance;

				let encumbranceDesc = `${encumbranceLevel} Encumbered`;

				newSummary +=  encumbranceDesc + '\n';

				currentModifier += encumbranceLevel;

			}

			const updates = {};

			switch (section) {

				case "defense":
					updates[`defense_encumbered`] = encumbranceLevel;
					break;

				case "skill":
				case "technique":
				default:
					updates[`skill_encumbered`] = encumbranceLevel;
					break;

			}

			updates[`${section}_roll_modifier_summary`] = newSummary;

			updates[`${section}_roll_modifier`] = currentModifier;

			setAttrs(updates, {silent: true}, () => {

				totalRollModifiersDialogBox(section);

			});
			
		});

	}

	/**
	 * Parses the summary text to remove Encumbered and return
	 * the encumbered value
	 * @param string summary Summary of skill roll mods
	 *
	 * @return array [newSummary, encumberanceMod]
	 */
	function getSummaryModifierForEncumbrance(summary) {

		let encumbranceMod = 0;

		let newSummary = summary;

		[-1, -2, -3, -4].forEach(mod => {

			let enumbranceDesc = `${mod} Encumbered`;

			if (summary.includes(enumbranceDesc)) {

				encumbranceMod = mod;

				// remove the string from the summary
				newSummary = summary.replace(enumbranceDesc + '\n', "");

			}

		});

		return [newSummary, encumbranceMod];
	}

	
	["shield", "magic"].forEach(type => {

		on(`change:defense_apply_${type}_db`, (event) => {

			applyDefenseBonus(type);

		});

	});

	/**
	* Apply defense bonus to section and roll modifier tool
	*/
	function applyDefenseBonus(type) {

		const fields = [
			`defense_apply_${type}_db`,
			`defense_roll_modifier_summary`,
			`defense_roll_modifier`,
		];

		getAttrs(fields, values => {

			let applyDB = Number(values[`defense_apply_${type}_db`]);

			let summary = values.defense_roll_modifier_summary;

			let currentModifier = Number(values.defense_roll_modifier);

			let newSummary = "";

			let originalDB = 0;

			// clear out any encumbrance modifiers
			[newSummary, originalDB] = getSummaryModifierForDefenseBonus(summary, type);

			// if value for originalDB, update currentModifier
			if (originalDB > 0) {

				// remove DB modifier
				currentModifier -= originalDB;

			}

			if (applyDB > 0) {

				// captilize 
				let dbType = type.charAt(0).toUpperCase() + type.slice(1);

				let defenseBonusDesc = `+${applyDB} ${dbType} DB`;

				newSummary +=  defenseBonusDesc + '\n';

				currentModifier += applyDB;

			}

			const updates = {};

			updates[`${type}_db`] = applyDB;

			updates[`defense_roll_modifier_summary`] = newSummary;

			updates[`defense_roll_modifier`] = currentModifier;

			setAttrs(updates, {silent: true}, () => {

			 	totalRollModifiersDialogBox("defense");

			});
			
		});

	}

	/**
	* Parses the summary text to remove defense bonus text and return
	* the db value
	*
	* @param string summary Summary of skill roll mods
	* @param string type    Type of defense bonus: shield | magic
	* @return array [newSummary, originalDB]
	*/
	function getSummaryModifierForDefenseBonus(summary, type) {

		let originalDB = 0;

		let newSummary = summary;

		// captilize 
		type = type.charAt(0).toUpperCase() + type.slice(1);

		["+1", "+2", "+3", "+4", "+5"].forEach(mod => {

			let dbDesc = `${mod} ${type} DB`;

			if (summary.includes(dbDesc)) {

				originalDB = Number(mod);

				// remove the string from the summary
				newSummary = summary.replace(dbDesc + '\n', "");

			}

		});

		return [newSummary, originalDB];
	}

	// close roll modifiers, no updates
	on("clicked:import_gca", (event) => {

		setAttrs({"import_message": "Processing... If message doesn't clear, an error occurred."});

		importGCA();

	});

	on("clicked:import_reset", (event) => {

		setAttrs({
			"import_message": "Start Import",
			"json_data": ""
		});

	});

	/**
	 * Import GCA JSON into character sheet
	 */
	function importGCA() {

		getAttrs(["json_data", "import_notes"], values => {

			let data = String(values.json_data).trim();

			let importNotes = Boolean(values.import_notes);

			let success = true;

			let message = "";
			
			let jsonData;

			if (data) {

				try {

					jsonData = JSON.parse(data);

					// check for GCA signature
					let programName = String(jsonData.Character.Author.Program);

					if (programName.toLowerCase() != "gurps character assistant") {

						success = false;

						message = "Invalid GCA Data. Program name was not set to GURPS Character Assistant."

					}

				} catch (ex) {

					success = false;

					message = "Invalid JSON Data. " + ex.message;

				}


			} else {

				success = false;

				message = "Please copy/paste JSON Data into text area.";

			}

			if (success) {

				let importNotes = Boolean(values.import_notes);

				let uniqueKeys = {};

				importCharacterSheetWithGCA(uniqueKeys, jsonData, importNotes);

				// uniqueKeys is passed by reference. Gets updated while reading each repeating table.
				// getUniqueKeysForSheet(uniqueKeys, () => {
                //
				//     importCharacterSheetWithGCA(uniqueKeys, jsonData, importNotes);

				// });
				

			} else {

				setAttrs({"import_message": message});

			}

		});

	}

	/**
	 * Search for a matching idkey, if it exists return row ID
	 * Otherwise generate a new row id
	 * example:
	 * uniqueKeys = {
	 *    123: "-asdv35darev33",
	 *    456: "-kdidi786dev33",
	 * }
	 * 
	 * @param object uniqueKeys Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param string idkey      Search uniqueKeys for idkey
	 * 
	 * @return string
	 */ 
	function generateOrGetRowId(uniqueKeys, idkey) {

		let rowId;

		if ( !isEmpty(uniqueKeys) && uniqueKeys.hasOwnProperty(idkey)) {

			rowId = uniqueKeys[idkey];
		} else {

			rowId = generateRowID();

		}

		return rowId;

	}

	/**
	 * Determines if an object is empty
	 * see: https://coderwall.com/p/_g3x9q/how-to-check-if-javascript-object-is-empty
	 * 
	 * @param object obj Object to check
	 * 
	 * @return boolean
	 */
	function isEmpty(obj) {
		
		for(var key in obj) {
			if(obj.hasOwnProperty(key))
				return false;
		}

		return true;
	}

	/**
	 * Get all the unique keys and associated row ids. 
	 * This allows us to update existing rows instead of inserting new ones
	 * 
	 * @param object   uniqueKeys Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param function callback   Function to run after we're done getting data
	 */ 
	function getUniqueKeysForSheet(uniqueKeys, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		// sorry about this
		getUniqueKeysForTable("repeating_languages", uniqueKeys, () => {

			getUniqueKeysForTable("repeating_cultures", uniqueKeys, () => {

				getUniqueKeysForTable("repeating_traits", uniqueKeys, () => {
					
					getUniqueKeysForTable("repeating_perks", uniqueKeys, () => {

						getUniqueKeysForTable("repeating_quirks", uniqueKeys, () => {

							getUniqueKeysForTable("repeating_disadvantages", uniqueKeys, () => {

								getUniqueKeysForTable("repeating_racial", uniqueKeys, () => {

									getUniqueKeysForTable("repeating_skills", uniqueKeys, () => {

										getUniqueKeysForTable("repeating_techniquesrevised", uniqueKeys, () => {

											getUniqueKeysForTable("repeating_defense", uniqueKeys, () => {

												getUniqueKeysForTable("repeating_melee", uniqueKeys, () => {

													getUniqueKeysForTable("repeating_ranged", uniqueKeys, () => {

														getUniqueKeysForTable("repeating_item", uniqueKeys, () => {

															getUniqueKeysForTable("repeating_spells", uniqueKeys, () => {

																// finally return! Sorry1
																callback();

															});

														});

													});

												});

											});

										});

									});

								});

							});

						});

					});

				});

			});

		});

	}

	/**
	 * Get unique idkey and associated row id for a table
	 * 
	 * @param string table Name of repeating table
	 * @param object   uniqueKeys Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param function callback   Function to run after we're done getting data
	 */
	function getUniqueKeysForTable(table, uniqueKeys, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		getSectionIDs(table, (ids) => {

			if (ids.length === 0 ) {
				callback();
				return;
			}

			// get the idkey for each row.
			var fields = [];

			for (var i = 0; i < ids.length; i++) {
				
				fields.push(`${table}_${ids[i]}_idkey`);

			}

			getAttrs(fields, values => {

				// loop through each row
				for (let key in values) {

					let idkey;

					let rowId;

					if (values.hasOwnProperty(key)) {
						
						idkey = values[key];

						// get row id from the key name
						// example: repeating_melee_KEYHERE_idkey
						rowId = getRowIdFromRowFieldKey(key, table);

						if (idkey && rowId) {

							// add new key/value pair!
							uniqueKeys[idkey] = rowId;
							
						}

					}

				}
				
			});

		});

		callback();

	}

	/**
	 * Start processing GCA json data and update character sheet
	 * 
	 * @param object  uniqueKeys  Key values pairs for unique key and associated row id. Passed by reference
	 * @param json    jsonData    GCA json data
	 * @param boolean importNotes Option to also import notes.
	 */
	function importCharacterSheetWithGCA(uniqueKeys, jsonData, importNotes) {

		// keeps track of running totals
		let runningTotals = {
			"stun_check_mod": 0,
			"knockdown_check_mod": 0,
			"unconscious_check_mod": 0,
			"death_check_mod": 0,
			"apply_size_modifier": 0,
			"import_message": "Import has completed.",
			"json_data": "",
			"templates": [],
			"templateNotes": "",
			"templateNames": "",
		};

		/*
		Example:
		templates: [{
						name: "Dwarf (Dungeon Fantasy)",
						notes: "Dwarves are essentially hardy-but-stumpy humans...",
						keys: [181, 182, 183, 184, 185, 187, 188, 189, 191, 192]
					}];
		keys are advantages/disadvantages for the template. 
		NOTE: Don't care about skills/spells/techniques. Just advantages/disadvantages need to be moved to racial traits table
		*/

		importGcaNonRepeatingFields(uniqueKeys, jsonData, runningTotals, importNotes, () => {

			importGcaAdvantages(uniqueKeys, jsonData, runningTotals, importNotes, () => {

				importGcaPerksQuirks(uniqueKeys, jsonData, runningTotals, importNotes, () => {

					importGcaDisadvantages(uniqueKeys, jsonData, runningTotals, importNotes, () => {

						importGcaSkills(uniqueKeys, jsonData, runningTotals, importNotes, () => {

							importGcaTechniques(uniqueKeys, jsonData, runningTotals, importNotes, () => {

								importGcaEquipment(uniqueKeys, jsonData, runningTotals, importNotes, () => {

									importGcaSpells(uniqueKeys, jsonData, runningTotals, importNotes, () => {

										// remove the unnecessary properties
										delete runningTotals.templates;
										delete runningTotals.templateNames;
										delete runningTotals.templateNotes;

										// TODO: add callback to delete orphaned records
										setAttrs(runningTotals);

									});
								
								});

							});
							
						});
						
					});
					
				});
				
			});

		});

	}

	/**
	 * Update non-repeating fields, then process callback function
	 *
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      GCA json data
	 * @param object   runningTotals An object that keeps track of running totals
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      Function to run next
	 */
	function importGcaNonRepeatingFields(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let general = jsonData.Character.General;

		let attributes = jsonData.Character.Traits.Attribute;

		let advantages = getJsonArrayFromTrait(jsonData.Character.Traits.Advantage);

		let campaign = jsonData.Character.Campaign;

		let basePoints = Number(campaign.basepoints);

		let baseTL = Number(campaign.basetl);

		let miscNotes = "";

		if (jsonData.Character.Notes) {
			miscNotes = jsonData.Character.Notes;
		}

		let jsonSM = getTraitFromGcaAttributes(attributes, "Size Modifier");

		let sizeModifier = 0;

		let jsonStatus = getTraitFromGcaAttributes(attributes, "Status");

		let status = 0;

		let jsonMonthlyPay = getTraitFromGcaAttributes(attributes, "Monthly Pay");

		let monthlyPay = "0";

		let jsonRemainingFunds = getTraitFromGcaAttributes(attributes, "Remaining Funds");

		let remainingFunds = "0";

		let jsonCostOfLiving = getTraitFromGcaAttributes(attributes, "Cost of Living");

		let costOfLiving = "0";

		if (jsonSM && jsonSM.score) {
			sizeModifier = jsonSM.score;
		}

		if (sizeModifier > 0) {
			runningTotals.apply_size_modifier = 1; 
		}

		if (jsonStatus && jsonStatus.score) {
			status = jsonStatus.score;
		}

		if (jsonMonthlyPay && jsonMonthlyPay.score) {

			monthlyPay = formatNumber(jsonMonthlyPay.score);
			
		}

		if (jsonRemainingFunds && jsonRemainingFunds.score) {

			remainingFunds = formatNumber(jsonRemainingFunds.score);

		}

		if (jsonCostOfLiving && jsonCostOfLiving.score) {

			costOfLiving = formatNumber(jsonCostOfLiving.score);

		}

		let [strPts, strMod] = getCharacterPointsModFromGcaAttributes(attributes, "ST");

		let [dexPts, dexMod] = getCharacterPointsModFromGcaAttributes(attributes, "DX");

		let [intPts, intMod] = getCharacterPointsModFromGcaAttributes(attributes, "IQ");

		let [htPts, htMod] = getCharacterPointsModFromGcaAttributes(attributes, "HT");

		let [hpPts, hpMod] = getCharacterPointsModFromGcaAttributes(attributes, "Hit Points");

		let [fatPts, fatMod] = getCharacterPointsModFromGcaAttributes(attributes, "Fatigue Points");

		let [perPts, perMod] = getCharacterPointsModFromGcaAttributes(attributes, "Perception");

		let [visionPts, visionMod] = getCharacterPointsModFromGcaAttributes(attributes, "Acute Vision");

		let [hearPts, hearMod] = getCharacterPointsModFromGcaAttributes(attributes, "Acute Hearing");

		let [tastePts, tasteMod] = getCharacterPointsModFromGcaAttributes(attributes, "Acute Taste and Smell");

		let [touchPts, touchMod] = getCharacterPointsModFromGcaAttributes(attributes, "Acute Touch");

		let [willPts, willMod] = getCharacterPointsModFromGcaAttributes(attributes, "Will");

		let [fearPts, fearMod] = getCharacterPointsModFromGcaAttributes(attributes, "Fearlessness");

		// TODO: Howto update running total using fearMod

		let [speedPts, speedMod] = getCharacterPointsModFromGcaAttributes(attributes, "Basic Speed");

		// don't use moveMod for Basic Move, since that is derived from rounding down speed
		let [movePts, moveMod] = getCharacterPointsModFromGcaAttributes(attributes, "Basic Move");

		let racialUpdates = getTemplatesFromGca(uniqueKeys, jsonData, runningTotals);

		if (runningTotals.templateNotes) {

			miscNotes += "\n\nTemplate(s):\n\n" + runningTotals.templateNotes;

		}

		let notes = {
			general_appearance: general.appearance,
			income:             monthlyPay,
			stash:              remainingFunds,
			cost_of_living:		costOfLiving,
			misc_notes:         miscNotes,
		};

		let updates = {
			fullname:              general.name,
			playername:            general.playername,
			race:                  general.race,
			template_names:        runningTotals.templateNames,
			height:                general.height,
			weight:                general.weight,
			size:                  sizeModifier,
			age:                   general.age,
			total_points:          basePoints,
			tl:	                   baseTL,
			status:				   status,
			wealth:				   "Average",
			strength_points:       strPts,
			strength_mod:		   strMod,
			dexterity_points:      dexPts,
			dexterity_mod:		   dexMod,
			intelligence_points:   intPts,
			intelligence_mod:      intMod,
			health_points:         htPts,
			health_mod:            htMod,
			hit_points_points:     hpPts,
			hit_points_mod:		   hpMod,
			fatigue_points_points: fatPts,
			fatigue_points_mod:    fatMod,
			perception_points:     perPts,
			perception_mod:		   perMod,
			vision_points:         visionPts,
			vision_mod:            visionMod,
			hearing_points:        hearPts,
			hearing_mod:           hearMod,
			taste_smell_points:    tastePts,
			taste_smell_mod:       tasteMod,
			touch_points:          touchPts,
			touch_mod:             touchMod,
			willpower_points:      willPts,
			willpower_mod:         willMod,
			fear_check_points:     fearPts,
			basic_speed_points:    speedPts,
			basic_speed_mod:       speedMod,
			basic_move_points:     movePts
		};

		importNaturalAttacksFromGca(uniqueKeys, updates, attributes, importNotes);

		let updatesMerged;

		// check for merging in notes and racial traits
		if (importNotes && !isEmpty(racialUpdates)) {
			updatesMerged = {...updates, ...notes, ...racialUpdates};
		} else if (importNotes) {
			updatesMerged = {...updates, ...notes};
		} else if (racialUpdates) {
			updatesMerged = {...updates, ...racialUpdates};
		} else {
			updatesMerged = {...updates};
		}

		setAttrs(updatesMerged, {silent: false}, callback);

	}

	/**
	 * Add commas to a number. 
	 * see: https://blog.abelotech.com/posts/number-currency-formatting-javascript/
	 * 
	 * @param number num Number to format
	 * 
	 * @return string
	 */
	function formatNumber(num) {
 		return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
	}

	/**
	 * Get the character points and modifier for an attribute
	 *
	 * @param json   attributes JSON Attribute data. Array of elements
	 * @param string name       Name of the field to get CP for.
	 *
	 * @return array [points, modifier]
	 */
	function getCharacterPointsModFromGcaAttributes(attributes, name) {

		let points = 0;

		let modifier = 0;

		if (attributes) {

			// loop through the attributes
			attributes.forEach(attribute => {

				if (name.toLowerCase() === String(attribute.name).toLowerCase()) {

					points = Number(attribute.points);

					let baseScore = Number(attribute.basescore);

					let score = Number(attribute.score);

					modifier = score - baseScore;

				}

			});
			
		}
		
		if ( isNaN(points) ) {
			points = 0;
		}

		return [points, modifier];
	}

	/**
	 * Find a matching trait based name
	 * 
	 * @param json   attributes A list of attributes
	 * @param string name       Name of attribute to find
	 * 
	 * @return json Json element 
	 */
	function getTraitFromGcaAttributes(attributes, name) {

		let trait;

		attributes.forEach(attribute => {

			if (attribute.name.toLowerCase() === name.toLowerCase()) {

				trait = attribute;

			}

		});

		return trait;

	}

	/**
	 * Get the character points for an advantage
	 *
	 * @param json   advantages JSON Advantages data. Array of elements
	 * @param string name       Name of the field to get CP for.
	 *
	 * @return int
	 */
	 function getCharacterPointsFromGcaAdvantages(advantages, name) {

		let points = 0;

		if (advantages) {

			// loop through the advantages
			advantages.forEach(advantage => {

				if (name.toLowerCase() === String(advantage.name).toLowerCase()) {

					points = Number(advantage.points);

				}

			});

		}
		
		if ( isNaN(points) ) {
			points = 0;
		}

		return points;
	}

	const GCA_NATURAL_MELEE_ATTACKS = [
		"Bite",
		"Punch",
		"Kick",
	];

	/**
	 * Import natural attacks like punch and bite to melee/range tables
	 * Based on standard attributes from GCA
	 * 
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  updates     Object of Roll20 fields to update. Passed by reference
	 * @param json    attributes  A list of CGA attributes
	 * @param boolean importNotes Option to also import notes.
	 */
	function importNaturalAttacksFromGca(uniqueKeys, updates, attributes, importNotes) {

		GCA_NATURAL_MELEE_ATTACKS.forEach( name => {

			trait = getTraitFromGcaAttributes(attributes, name);

			if (trait) {

				getMeleeAttackFromGcaTrait(uniqueKeys, updates, trait, importNotes, true);

				getRangedAttackFromGcaTrait(uniqueKeys, updates, trait, importNotes);

				getDefenseFromGcaTrait(uniqueKeys, updates, trait);
			}

		});

	}

	const GCA_IGNORED_ADVANTAGES = [
		"Acute Vision",
		"Acute Hearing",
		"Acute Taste and Smell",
		"Acute Touch",
		"Fearlessness",
	];

	/**
	 * If a trait, like Advantage only has one advantage, 
	 * then the JSON is NOT an array. We have to convert that 
	 * element to an array
	 * NOTE: Classic single or array issue with json
	 * 
	 * @param json trait A trait(s) like advantages, perks, etc.
	 */ 
	function getJsonArrayFromTrait(trait) {

		let traits;

		if (Array.isArray(trait)) {
			traits = trait;
		} else if (trait) {
			// convert to an array
			traits = [trait];
		}

		return traits;

	}

	/**
	 * Gets templates from GCA. If found, runningTotals with template data
	 * Returns Repeating Racial Records to add, if template provides 
	 * additional attribute updates not covered by advantages/disadvantages
	 * 
	 * @param object uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json   jsonData      GCA JSON data
	 * @param object runningTotals Object that tracks running totals and changes. Passed by reference
	 * 
	 * @return object Repeating Racial Records
	 */ 
	function getTemplatesFromGca(uniqueKeys, jsonData, runningTotals) {

		let templates = getJsonArrayFromTrait(jsonData.Character.Traits.Template);

		let arrNames = [];

		let arrNotes = [];

		let templateToAdd;

		let racialUpdates = {};

		if (templates && templates.length) {

			templates.forEach(template => {

				let name = template.name;

				if (template.nameext) {
					name += ` (${template.nameext})`;
				}

				arrNames.push(name);

				let notes = getGcaNotesForTemplate(template);

				arrNotes.push(notes);

				let keys = [];

				if (template.pkids) {
					// get rid of spaces, just in case
					let ids = template.pkids.replaceAll(", ", ",");

					keys = ids.split(",");
				} 

				templateToAdd = {
					name: name,
					notes: notes,
					keys: keys
				};

				runningTotals.templates.push(templateToAdd);

				// check for additional racial row to get added
				// this fixes offset issues with stat updates 
				if (template.premodspoints) {

					getGcaRacialUpdates(uniqueKeys, racialUpdates, template, name);

				}
				
			});

			let templateNames = arrNames.join("|");

			let templateNotes = arrNotes.join("\n\n");

			runningTotals.templateNames = templateNames;

			runningTotals.templateNotes = templateNotes;
			
		}

		return racialUpdates;
		
	}

	/**
	 * Gets repeating racial record that accounts for attribute updates 
	 * not covered advantage/disadvantages
	 * example: Dwarf Gives: +1 to ST:HT, +3 to ST:Fatigue Points, -1 to ST:Basic Move
	 * 
	 * @param object uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object racialUpdates Object for updating repeating_racial table. Passed by reference
	 * @param json   template      GCA json object
	 * @param string templateName  Name of template that "gives" attributes
	 * 
	 * @return object
	 */
	function getGcaRacialUpdates(uniqueKeys, racialUpdates, template, templateName) {

		let idkey = template.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let baseFieldName = `repeating_racial_${rowId}`;

		racialUpdates[`${baseFieldName}_idkey`] = idkey;

		let gives = template.gives;

		gives = gives.replaceAll("ST:", "");

		racialUpdates[`${baseFieldName}_name`] = templateName + " gives: " + template.gives;

		racialUpdates[`${baseFieldName}_points`] = template.premodspoints;

		racialUpdates[`${baseFieldName}_ref`] = template.page;

		return racialUpdates;
	}

	/**
	 * If trait has melee stats, create entry on melee table
	 *
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Object of properties to update/add rows. passed by reference
	 * @param json    trait       JSON data for the trait
	 * @param boolean importNotes Option to also import notes.
	 * @param bool    force       Force function to process single melee attack
	 */
	function getMeleeAttackFromGcaTrait(uniqueKeys, rows, trait, importNotes, force = false) {

		if (trait.mode && trait.mode.includes("|") && trait.charreach && trait.charreach != "|") {

			getMultipleMeleeAttackModesFromGcaTrait(uniqueKeys, rows, trait, importNotes);

		} else if ( force || (trait.charreach && trait.charreach !== "|")) {

			getSingleMeleeAttackModeFromGcaTrait(uniqueKeys, rows, trait, importNotes);

		}

	}


	/**
	 * If trait only has a single attack mode, use this function
	 *
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Object of properties to update/add rows. passed by reference
	 * @param json    trait       JSON data for the trait
	 * @param boolean importNotes Option to also import notes.
	 * 
	 * @return object
	 */
	function getSingleMeleeAttackModeFromGcaTrait(uniqueKeys, rows, trait, importNotes) {

		let idkey = trait.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let baseFieldName = `repeating_melee_${rowId}`;

		let fullName = trait.name;

		if (trait.nameext && trait.nameext != trait.name){

			fullName += ` (${trait.nameext})`;

		}

		if (trait.levelnames) {

			levelName = getGcaLevelName(trait);

			if (levelName) {
				fullName += ` (${levelName})`;
			}
			
		}

		let reach = "c";

		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		let damage = getDamageDieFromGca(trait.chardamage);
		
		rows[`${baseFieldName}_damage`] = damage;

		rows[`${baseFieldName}_type`] = getDamageTypeFromGca(trait.chardamtype);

		if (trait.charreach) {

			reach = trait.charreach;

		}

		rows[`${baseFieldName}_reach`] = reach;

		rows[`${baseFieldName}_skill`] = trait.charskillscore;

		if (importNotes) {
			rows[`${baseFieldName}_notes`] = getRangedMeleeNotesFromGca(trait);
		}

		if (trait.chararmordivisor) {
		
			rows[`${baseFieldName}_armor_divisor`] = trait.chararmordivisor;
		
		}

	}

	/**
	 * The melee attack has several modes
	 * Need a row for each attack mode
	 * 
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Object of properties to update/add rows. passed by reference
	 * @param json    trait       JSON data for the trait
	 * @param boolean importNotes Option to also import notes.
	 */ 
	function getMultipleMeleeAttackModesFromGcaTrait(uniqueKeys, rows, trait, importNotes) {

		// example: "mode": "Staff swing|Staff thrust|Sword swing|Sword thrust"
		let arrModes = trait.mode.split("|");

		// example: "chardamage": "1d+1|1d|1d+1|1d-1",
		let arrDamage = trait.chardamage.split("|");

		// example: "chardamtype": "cr|cr|cr|cr",
		let arrDamType = trait.chardamtype.split("|");

		let damageNote = "";

		// example: "charreach": "1,2|1,2|1,2|2"
		let arrReach;

		if (trait.charreach) {
			arrReach = trait.charreach.split("|")
		}

		// example: "charskillscore": "11|11|5|5"
		let arrSkillLevel = trait.charskillscore.split("|");

		// example: "charskillused": "\"SK:Staff\"|\"SK:Staff\"|\"ST:DX\"-5|\"ST:DX\"-5"
		let arrSkillUsed = trait.charskillused.split("|");

		// example: "chararmordivisor": "|3",
		let arrDivisor = [];

		if (trait.chararmordivisor) {
			arrDivisor = trait.chararmordivisor.split("|");
		}

		// tracks which mode to use
		let index = 0;

		arrModes.forEach(mode => {

			if (mode.toLowerCase() === "thrown") {
				return;
			}

			// add a mode id to uniquely identify each attach mode
			let idkey = trait.IDKey.trim() + `-mode-${index}`;

			let rowId = generateOrGetRowId(uniqueKeys, idkey);

			let baseFieldName = `repeating_melee_${rowId}`;

			let fullName = trait.name;

			if (trait.nameext && trait.nameext != trait.name ) {

				fullName += ` (${trait.nameext})`;

			}

			fullName += ` (${mode})`;

			rows[`${baseFieldName}_idkey`] = idkey;

			rows[`${baseFieldName}_name`] = fullName;

			let damage = 0;

			let damageNote = "";

			if (arrDamage && arrDamage.length === 1) {
				damageNote = arrDamage[0];
				damage = arrDamage[0];
			} else if (arrDamage && arrDamage.length > 1) {
				damageNote = arrDamage[index];
				damage = arrDamage[index];
			}

			// replace "d" with "d6"
			damage = damage.replace("d", "d6");

			let damageType = "spec";

			if (arrDamType && arrDamType.length === 1) {
				damageType = arrDamType[0];
			} else if (arrDamType && arrDamType.length > 1) {
				damageType = arrDamType[index];
			}

			rows[`${baseFieldName}_damage`] = damage;

			rows[`${baseFieldName}_type`] = getDamageTypeFromGca(damageType);

			let reach = "c";

			if (arrReach && arrReach.length === 1) {
				reach = arrReach[0];
			} else if (arrReach && arrReach.length > 1) {
				reach = arrReach[index];
			}

			rows[`${baseFieldName}_reach`] = reach;

			let skillLevel = "10";

			if (arrSkillLevel && arrSkillLevel.length === 1) {
				skillLevel = arrSkillLevel[0];
			} else if (arrSkillLevel && arrSkillLevel.length > 1) {
				skillLevel = arrSkillLevel[index];
			}

			rows[`${baseFieldName}_skill`] = skillLevel;

			let damageNotes = `${damageNote} (${damageType})`;

			if (importNotes) {
				rows[`${baseFieldName}_notes`] = getRangedMeleeNotesFromGca(trait, arrSkillUsed[index], damageNotes);
			}
 			
			let divisor = 1;

			if (arrDivisor && arrDivisor.length === 1) {
				divisor = Number(arrDivisor[0]);
			} else if (arrDivisor && arrDivisor.length > 1) {
				divisor = Number(arrDivisor[index]);
			}
			
			if (isNaN(divisor) || divisor < 1) {
				divisor = 1;
			}

			rows[`${baseFieldName}_armor_divisor`] = divisor;
			
			index++;

		});

	}

	/**
	 * If trait has ranged stats, create entry on ranged table
	 *
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows  Object of properties to update/add rows. Passed by reference
	 * @param json    trait JSON data for the trait
	 * @param boolean importNotes Option to also import notes.
	 */
	function getRangedAttackFromGcaTrait(uniqueKeys, rows, trait, importNotes) {

		if (trait.mode && trait.mode.includes("|") && trait.characc && trait.characc != "|") {

			getMultipleRangedAttackModesFromGcaTrait(uniqueKeys, rows, trait, importNotes);

		} else if (trait.characc && trait.characc != "|") {

			getSingleRangedAttackModeFromGcaTrait(uniqueKeys, rows, trait, importNotes);

		}

	}

	/**
	 * If trait only has a single attack mode, use this function
	 *
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Object of properties to update/add rows. Passed by reference
	 * @param json    trait       JSON data for the trait
	 * @param boolean importNotes Option to also import notes.
	 */
	function getSingleRangedAttackModeFromGcaTrait(uniqueKeys, rows, trait, importNotes) {

		let idkey = trait.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);
		
		let baseFieldName = `repeating_ranged_${rowId}`;

		let fullName = trait.name;

		if (trait.nameext && trait.namext != trait.name ) {

			fullName += ` (${trait.nameext})`;

		}

		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		let damage = getDamageDieFromGca(trait.chardamage);

		rows[`${baseFieldName}_damage`] = damage;
		
		rows[`${baseFieldName}_type`] = getDamageTypeFromGca(trait.chardamtype);

		if (trait.characc) {
			rows[`${baseFieldName}_acc`] = trait.characc;
		} else {
			rows[`${baseFieldName}_acc`] = 0;
		}
		
		rows[`${baseFieldName}_range`] = getRangeFromGca(trait);

		if (trait.charskillscore) {
			rows[`${baseFieldName}_skill`] = trait.charskillscore;
		}

		if (trait.charrof) {
			rows[`${baseFieldName}_rof`] = trait.charrof;
		}

		if (trait.charshots) {
			rows[`${baseFieldName}_shots`] = trait.charshots;
		}

		if (trait.bulk) {
			rows[`${baseFieldName}_bulk`] = trait.bulk;
		}

		if (trait.charrcl) {
			rows[`${baseFieldName}_recoil`] = trait.charrcl;
		}
		
		if (trait.chararmordivisor) {
	
			rows[`${baseFieldName}_armor_divisor`] = trait.chararmordivisor;
		
		}
		
		if (importNotes) {
			rows[`${baseFieldName}_notes`] = getRangedMeleeNotesFromGca(trait);
		}
		
	}

	/**
	 * The ranged attack has several modes
	 * Need a row for each attack mode
	 * 
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Object of properties to update/add rows. Passed by reference
	 * @param json    trait       JSON data for the trait
	 * @param boolean importNotes Option to also import notes.
	 */ 
	function  getMultipleRangedAttackModesFromGcaTrait(uniqueKeys, rows, trait, importNotes) {

		// example: "mode": "Staff swing|Staff thrust|Sword swing|Sword thrust"
		let arrModes = trait.mode.split("|");

		// example: "chardamage": "1d+1|1d|1d+1|1d-1",
		let arrDamage;

		if (trait.chardamage) {
			arrDamage = trait.chardamage.split("|");
		}

		// example: "chardamtype": "cr|cr|cr|cr",
		let arrDamType;

		if (trait.chardamtype) {
			arrDamType = trait.chardamtype.split("|")
		}

		// example: "chararmordivisor": "|3",
		let arrDivisor = [];

		if (trait.chararmordivisor) {
			arrDivisor = trait.chararmordivisor.split("|");
		}

		// example: "charskillscore": "11|11|5|5"
		let arrSkillLevel = trait.charskillscore.split("|");

		// i.e: "characc": "4|4",
		let arrAcc;

		if (trait.characc) {
			arrAcc = trait.characc.split("|");
		}

		// i.e: "charrcl": "3|3",
		let arrRecoil;

		if (trait.charrcl) {
			arrRecoil = trait.charrcl.split("|")
		}

		// "charrof": "3|3",
		let arrRof;

		if (trait.charrof) {
			arrRof = trait.charrof.split("|")
		}

		// "charshots": "20+1(3)|20+1(3)",
		let arrShots;

		if (trait.charshots) {
			arrShots = trait.charshots.split("|");
		}

		// "charskillused": "\"SK:Guns (Pistol)\"|\"SK:Guns (Pistol)\"",
		let arrSkillUsed = trait.charskillused.split("|");

		// "charrangehalfdam": "180|180",
		let arrHalfRange;

		if (trait.charrangehalfdam) {
			arrHalfRange = trait.charrangehalfdam.split("|");
		}

		// "charrangemax": "2000|2000",
		let arrMaxRange;

		if (trait.charrangemax) {
			arrMaxRange = trait.charrangemax.split("|")
		}

		let arrBulk;

		if (trait.bulk) {
			arrBulk = trait.bulk.split("|");
		}

		let damageNote = "";

		// tracks which mode to use
		let index = 0;

		arrModes.forEach(mode => {

			if (mode.toLowerCase() === "swing" || mode.toLowerCase() === "thrust") {
				return;
			}

			let idkey = trait.IDKey.trim() + `-mode-${index}`;

			let rowId = generateOrGetRowId(uniqueKeys, idkey);

			let baseFieldName = `repeating_ranged_${rowId}`;

			let fullName = trait.name;

			if (trait.nameext && trait.nameext != trait.name ) {

				fullName += ` (${trait.nameext})`;

			}

			fullName += ` (${mode})`;

			rows[`${baseFieldName}_idkey`] = idkey;

			rows[`${baseFieldName}_name`] = fullName;

			let damage = "0";

			let damageNote = "";

			let damageTypeNote = "";

			if (arrDamage && arrDamage.length === 1) {

				damage = arrDamage[0];

				damageNote = arrDamage[0];

				// replace "d" with "d6"
				damage = damage.replace("d", "d6");

				rows[`${baseFieldName}_damage`] = damage;

			} else if (arrDamage && arrDamage.length > 1) {

				damage = arrDamage[index];

				damageNote = arrDamage[index];

				// replace "d" with "d6"
				damage = damage.replace("d", "d6");

				rows[`${baseFieldName}_damage`] = damage;

			}

			if (arrDamType && arrDamType.length === 1) {

				damageTypeNote = arrDamType[0];

				rows[`${baseFieldName}_type`] = getDamageTypeFromGca(arrDamType[0]);

			} else if (arrDamType && arrDamType.length > 1) {

				damageTypeNote = arrDamType[index];

				rows[`${baseFieldName}_type`] = getDamageTypeFromGca(arrDamType[index]);

			}

			if (arrAcc && arrAcc.length === 1) {
				rows[`${baseFieldName}_acc`] = arrAcc[0];
			} else if (arrAcc && arrAcc.length > 1) {
				rows[`${baseFieldName}_acc`] = arrAcc[index];
			}
			
			let halfRange = "";

			if (arrHalfRange && arrHalfRange.length === 1) {
				halfRange = arrHalfRange[0];
			} else if (arrHalfRange && arrHalfRange.length > 1) {
				halfRange = arrHalfRange[index];
			}

			let maxRange = "";

			if (arrMaxRange && arrMaxRange.length === 1) {
				maxRange = arrMaxRange[0];
			} else if (arrMaxRange && arrMaxRange.length > 1) {
				maxRange = arrMaxRange[index];
			} 

			rows[`${baseFieldName}_range`] = getRangeFromHalfMax(halfRange, maxRange);

			
			let skillLevel = "10";

			if (arrSkillLevel && arrSkillLevel.length === 1) {
				skillLevel = arrSkillLevel[0];
			} else if (arrSkillLevel && arrSkillLevel.length > 1) {
				skillLevel = arrSkillLevel[index];
			} 

			rows[`${baseFieldName}_skill`] = skillLevel;

			if (arrRof && arrRof.length === 1) {
				rows[`${baseFieldName}_rof`] = arrRof[0];
			} else if (arrRof && arrRof.length > 1) {
				rows[`${baseFieldName}_rof`] = arrRof[index];
			}
			
			if (arrShots && arrShots.length === 1) {
				rows[`${baseFieldName}_shots`] = arrShots[0];
			} else if (arrShots && arrShots.length > 1) {
				rows[`${baseFieldName}_shots`] = arrShots[index];
			}
			
			if (arrBulk && arrBulk.length === 1) {
				rows[`${baseFieldName}_bulk`] = arrBulk[0];
			} else if (arrBulk && arrBulk.length > 1) {
				rows[`${baseFieldName}_bulk`] = arrBulk[index];
			}

			if (arrRecoil && arrRecoil.length === 1) {
				rows[`${baseFieldName}_recoil`] = arrRecoil[0];
			} else if (arrRecoil && arrRecoil.length > 1) {
				rows[`${baseFieldName}_recoil`] = arrRecoil[index];
			}
			
			let divisor = 1;

			if (arrDivisor && arrDivisor.length === 1) {
				divisor = Number(arrDivisor[0]);
			} else if (arrDivisor && arrDivisor.length > 1) {
				divisor = Number(arrDivisor[index]);
			}

			if (isNaN(divisor) || divisor < 1) {
				divisor = 1;
			}

			rows[`${baseFieldName}_armor_divisor`] = divisor;
			
			let damageNotes = `${damageNote} (${damageTypeNote})`;

			if (importNotes) {
				rows[`${baseFieldName}_notes`] = getRangedMeleeNotesFromGca(trait, skillLevel, damageNotes);
			}
			
			index++;

		});

	}

	/**
	 * Check if trait has any defense mods
	 *
	 * @param object uniqueKeys Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object rows       Object of properties to update/add rows. Passed by reference
	 * @param json   trait      JSON data for the trait
	 */
	function getDefenseFromGcaTrait(uniqueKeys, rows, trait) {

		// determine defen
		let parryDefense = getDefenseForGcaTrait(trait, "parry");

		let blockDefense = getDefenseForGcaTrait(trait, "block");

		// it could be possible a trait has block & parry
		if (parryDefense === "multi") {

			getMultipleDefenseModesFromGcaTrait(uniqueKeys, rows, trait, "parry");

		} else if (parryDefense === "single") {

			getSingleDefenseModeFromGcaTrait(uniqueKeys, rows, trait, "parry");

		}

		// it could be possible a trait has block & parry
		if (blockDefense === "multi") {

			getMultipleDefenseModesFromGcaTrait(uniqueKeys, rows, trait, "block");

		} else if (blockDefense === "single") {

			getSingleDefenseModeFromGcaTrait(uniqueKeys, rows, trait, "block");

		}

	}

	/**
	 * Determines the defense type of a trait based on parry or block
	 * if it is single, multi, or not present
	 * 
	 * @param json trait GCA json data
	 * @param string checkFor What type of defense to check for. parry | block
	 *
	 * @return string Returns single|multi|empty if none
	 */ 
	function getDefenseForGcaTrait(trait, checkFor = "parry") {

		let defenseType;

		let parry;

		let blocklevel;

		if (checkFor.toLowerCase() === "parry") {

			if (trait.charparryscore) {

				parry = trait.charparryscore;

				// unset if value is "no"
				if (parry.toLowerCase() === "no" || parry == 0) {
					parry = null;
				}

			}

			if (parry && parry.includes("|")) {

				defenseType = "multi";

			} else if (parry) {

				defenseType = "single";

			}

		}

		if (checkFor.toLowerCase() === "block") {

			if (trait.blocklevel) {
			
				blocklevel = trait.blocklevel;

				// unset if value is "no"
				if (blocklevel.toLowerCase() === "no" || blocklevel == 0) {
					blocklevel = null;
				}

			}

			if (blocklevel && blocklevel.includes("|")) {

				defenseType = "multi";

			} else if (blocklevel) {

				defenseType = "single";

			}

		}

		return defenseType;

	}

	/**
	 * If trait only has a single defense mode, use this function
	 * Currenlty only handles parry and block
	 *
	 * @param object uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object rows        Object of properties to update/add rows. Passed by reference
	 * @param json   trait       JSON data for the trait
	 * @param string defenseType parry|block. Used to help determine defense type drop-down value
	 */
	function getSingleDefenseModeFromGcaTrait(uniqueKeys, rows, trait, defenseType) {

		let idkey = trait.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let baseFieldName = `repeating_defense_${rowId}`;

		let fullName = trait.name;

		if (trait.nameext && trait.nameext != trait.name) {

			fullName += ` (${trait.nameext})`;

		}

		let skill;

		let defenseDropDownValue;

		let defenseInfo;

		if (defenseType.toLowerCase() === "parry") {

			[skill, defenseDropDownValue, defenseInfo] = getParryDefenseInfoFromGca(trait.charparryscore, trait.name);

		} else {

			skill = Number(trait.blocklevel);

			defenseDropDownValue = "Block";

			defenseInfo = "";

		}

		// if no skill value, LEAVE!
		if (!skill || isNaN(skill)) {
			return;
		}
		
		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		rows[`${baseFieldName}_skill`] = skill;

		rows[`${baseFieldName}_type`] = defenseDropDownValue;

		rows[`${baseFieldName}_info`] = defenseInfo;

	}

	/**
	* The ranged attack has several modes
	* Need a row for each attack mode
	* 
	* @param object uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	* @param object rows        Object of properties to update/add rows. Passed by reference
	* @param json   trait       JSON data for the trait
	* @param string defenseType parry|block. Used to help determine defense type drop-down value
	*/ 
	function  getMultipleDefenseModesFromGcaTrait(uniqueKeys, rows, trait, defenseType) {

		// example: "mode": "Staff swing|Staff thrust|Sword swing|Sword thrust"
		let arrModes = trait.mode.split("|");

		// "charparryscore": "10|10|No",
		let arrParry;

		if (defenseType.toLowerCase() === "parry" && trait.charparryscore) {
			arrParry = trait.charparryscore.split("|");
		}

		// "charparryscore": "10|No|No",
		let arrBlock;

		if (defenseType.toLowerCase() === "block" && trait.blocklevel) {
			arrBlock = trait.blocklevel.split("|");
		}

		let skill;

		let defenseDropDownValue;

		let defenseInfo;

		let parryScore;

		// tracks which mode to use
		let index = 0;

		arrModes.forEach(mode => {

			// reset values because for loop;
			parryScore = null;

			skill = null;

			defenseDropDownValue = "";

			defenseInfo = "";

			if (defenseType.toLowerCase() === "parry") {

				parryScore = arrParry[index];

				[skill, defenseDropDownValue, defenseInfo] = getParryDefenseInfoFromGca(parryScore, trait.name);

			} else {

				skill = Number(arrBlock[index]);
				
				defenseDropDownValue = "Block";

				defenseInfo = "";
				
			}

			// if no skill, get out of loop
			if (!skill || isNaN(skill)) {
				return;
			}

			let idkey = trait.IDKey.trim() + `-mode-${index}`;

			let rowId = generateOrGetRowId(uniqueKeys, idkey);

			let baseFieldName = `repeating_defense_${rowId}`;

			let fullName = trait.name;

			if (trait.nameext && trait.nameext != trait.name) {

				fullName += ` (${trait.nameext})`;

			}

			fullName += ` (${mode})`;

			rows[`${baseFieldName}_idkey`] = idkey;

			rows[`${baseFieldName}_name`] = fullName;

			rows[`${baseFieldName}_skill`] = skill;

			rows[`${baseFieldName}_type`] = defenseDropDownValue;

			rows[`${baseFieldName}_info`] = defenseInfo;

			index++;

		});

	}

	/**
	 * Get parry defense information based on parry score
	 * i.e.: score of 12U returns [12, U, Parry] 
	 * 
	 * @param string parryScore Value to evaluate
	 * @param string name       Name of trait. Punch | Brawling = Unarmed Parry
	 * 
	 * @return array [skill, dropDownValue, defenseInfo]
	 */
	function getParryDefenseInfoFromGca(parryScore, name) {

		let skill;

		let dropDownValue;

		let defenseInfo = "";

		// check for unbalanced parry
		if (parryScore && parryScore.includes("U")) {
				
			defenseInfo = "U";

			// just need number
			skill = Number(parryScore.replace("U", ""));

		} else if (parryScore && parryScore.includes("F")) {

			defenseInfo = "F";

			// just need number
			skill = Number(parryScore.replace("F", ""));

		} else {

			skill = Number(parryScore);

		}

		// check skill is a number
		if (!skill || isNaN(skill)) {

			skill = null;

		};

		if (name.toLowerCase() === "punch" || name.toLowerCase() === "brawling" || name.toLowerCase() === "karate") {
			dropDownValue = "Unarmed Parry";
		} else {
			dropDownValue = "Parry";
		}

		return [skill, dropDownValue, defenseInfo];

	}

	/**
	 * Get Damage Die roll for use with Roll20
	 * Will convert variable die rolls to Roll20 macro prompt
	 */
	function getDamageDieFromGca(damageDie) {

		let dieRoll = "";

		if (!damageDie) {
			return dieRoll;
		}

		if (damageDie && damageDie.includes("~")) {

			// example: ~1d+1
			// remove ~
			damageDie = damageDie.replace("~", "");

			// array = [1, +1]
			let arrDamageDie = damageDie.split("d");

			let baseDie = 1;

			let dieModifier = "0";

			if (arrDamageDie.length === 1) {

				baseDie = arrDamageDie[0];

			} else if (arrDamageDie.length === 2) {

				baseDie = arrDamageDie[0];

				dieModifier = arrDamageDie[0];

			}
			
			dieRoll = getNumberOfDicePrompt(baseDie, dieModifier);

		} else {

			dieRoll = damageDie.replace("d", "d6");
		}

		return dieRoll;

	}

	/**
	 * Returns a Roll20 prompt macro to select number of dice for a roll
	 * example: GCA Roll = ~2d+1. 
	 *          baseDie = 1
	 * 			dieModifier = 1
	 * 			return a macro: ?{# of Dice|1d6|2d6|3d6|4d6|5d6}
	 * 
	 * @param int baseDie Base die roll
	 * @param int dieModifier Modifier applied to the die roll
	 * @param int optionCount Number of options to include in the drop-down
	 * 
	 * @return string Roll20 Macro Prompt
	 */
	function getNumberOfDicePrompt(baseDie, dieModifier, optionCount = 9) {

		let prompt;

		let arrOptions = [];

		let option;

		let optionDie;

		let optionDieMod;

		let options;

		// makee sure baseDie is a number
		baseDie = Number(baseDie);
		if (isNaN(baseDie)) {
			baseDie = 1;
		}

		dieModifier = Number(dieModifier);
		if (isNaN(dieModifier)) {
			dieModifier = 0;
		}

		if (optionCount < 0) {
			optionCount = 1;
		}

		// create the options
		for (counter = 1; counter <= optionCount; counter++) {

			optionDie = counter * baseDie;

			optionDieMod = counter * dieModifier;

			if (optionDieMod === 0) {

				option = `${optionDie}d6`;

			} else if (optionDieMod > 0) {

				option = `${optionDie}d6+${optionDieMod}`;

			} else {

				option = `${optionDie}d6-${optionDieMod}`;

			}
			
			arrOptions.push(option);

		}

		
		options = arrOptions.join("|");

		prompt = `?{# of Die|${options}}`;

		return prompt;
		
	}

	
	/**
	 * Gets ranged/melee notes GCA trait
	 * 
	 * @param json   trait     JSON data for the trait
	 * @param string skillUsed Used for multimode attack. Replaces trait.charskillused
	 * @param string damage    Used for multimode attack. Replaces trait.damage && trait.damtype
	 * 
	 * @return string
	 */ 
	function getRangedMeleeNotesFromGca(trait, skillUsed = "", damageNote = "") {

		let arrNotes = [];

		let notes = "";

		if (trait.usernotes) {
			arrNotes.push(trait.usernotes + "\n"); 
		}

		if (skillUsed) {

			arrNotes.push("Skill: " + skillUsed + "\n");

		} else if (trait.charskillused) {

			arrNotes.push("Skill: " + trait.charskillused + "\n");

		}

		if (damageNote) {

			arrNotes.push(`Damage: ${damageNote}` + "\n");

		} else if (trait.damage && trait.damtype) {

			arrNotes.push(`Damage: ${trait.damage} (${trait.damtype})` + "\n");

		} else if (trait.damage) {

			arrNotes.push(`Damage: ${trait.damage}` + "\n");

		}

		if (trait.gives) {
			arrNotes.push("Gives: " + trait.gives + "\n"); 
		}

		if (arrNotes.length) {
			notes = arrNotes.join("\n");
		}

		return notes;
	}

	/**
	 * Gets defense notes GCA trait
	 * 
	 * @param json   trait     JSON data for the trait
	 * 
	 * @return string
	 */ 
	function getDefenseNotesFromGca(trait) {

		let arrNotes = [];

		let notes = "";

		if (trait.usernotes) {
			arrNotes.push(trait.usernotes + "\n"); 
		}

		if (trait.charskillused) {

			arrNotes.push("Skill: " + trait.charskillused + "\n");

		}

		if (arrNotes.length) {
			notes = arrNotes.join("\n");
		}

		return notes;
	}

	/**
	 * Gets ranged value from GCA trait
	 * 
	 * @param json trait JSON data for the trait
	 * 
	 * @return string
	 */ 
	function getRangeFromGca(trait) {

		let range = "";

		if (trait.charrangehalfdam && trait.charrangemax) {

			range = trait.charrangehalfdam + "/" + trait.charrangemax; 
		
		} else if (trait.charrangehalfdam) {
			
			range = trait.charrangehalfdam; 
		
		} else if (trait.charrangemax) {
		
			range = trait.charrangemax; 
		
		}

		return range;
			
	}

	/**
	 * Returns the range of a weapon
	 * 
	 * @param string halfRange Half damage range
	 * @param string maxRange  Maximum range
	 * 
	 * @return string
	 */
	function getRangeFromHalfMax(halfRange, maxRange) {

		let range = "";

		if (halfRange && maxRange) {

			range = halfRange + "/" + maxRange; 
		
		} else if (halfRange) {
			
			range = halfRange; 
		
		} else if (maxRange) {
		
			range = maxRange; 
		
		}

		return range;
			
	}

	/**
	 * Gets the roll20 damage type based GCA damage type
	 * 
	 * @param string gcaDamageType GCA damage type
	 */
	function getDamageTypeFromGca(gcaDamageType) {

		let type = "";

		if (!gcaDamageType) {
			return type;
		}

		// if damage type contains a space, there's an additional damage type present
		// example: damage type = cr exp = Crush Explosive. 
		// we only want "cr"

		if (gcaDamageType.includes(" ")) {

			let arrType = gcaDamageType.split(" ");

			gcaDamageType = arrType[0];

		}

		switch(gcaDamageType) {

			case "aff":
				type = "Affliction (aff)";
				break;

			case "burn":
				type = "Burning (burn)";
				break;

			case "cor":
				type = "Corrosion (cor)";
				break;

			case "cr":
				type = "Crushing (cr)";
				break;

			case "cut":
				type = "Cutting (cut)";
				break;

			case "fat":
				type = "Fatigue (fat)";
				break;

			case "imp":
				type = "Impaling (imp)";
				break;

			case "pi-":
				type = "Small Piercing (pi-)";
				break;

			case "pi":
				type = "Piercing (pi)";
				break;

			case "pi+":
				type = "Large Piercing (pi+)";
				break;

			case "pi++":
				type = "Huge Piercing (pi++)";
				break;

			case "knock":
				type = "Knockback (knock)";
				break;

			case "tox":
				type = "Toxic (tox)";
				break;

			case "spec":
			default:
				type = "Special (spec)";
				break;


		}
		
		return type;

	}


	/**
	 * Loops advantages and add advantages
	 * TODO: Check to see if advantage already exists, then update
	 * 
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      Json DATA from GCA file
	 * @param object   runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      A function to run after updating is complete
	 */
	function importGcaAdvantages(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let advantages = getJsonArrayFromTrait(jsonData.Character.Traits.Advantage);

		// rows is passed by reference
		let rows = {};

		let saveRows = false;

		if (advantages && advantages.length) {

			advantages.forEach(advantage => {

				let name = advantage.name;

				let basedon = "";

				if (advantage.basedon) {
					basedon = advantage.basedon;
				}

				if (!GCA_IGNORED_ADVANTAGES.includes(name)) {

					saveRows = true;

					if (basedon == "Language - Native" || basedon == "Language - Native (Spoken)" || basedon == "Language - Native (Written)") {

						getGcaValuesForNativeLanguage(rows, name, basedon, advantage);

					} else if (basedon == "Language" || basedon == "Language (Spoken)" || basedon == "Language (Written)") {

						getGcaValuesForRepeatingLanguage(uniqueKeys, rows, name, basedon, advantage);

					} else if (basedon && basedon.includes("Cultural Familiarity")) {

						getGcaValuesForCulturalFamiliarity(uniqueKeys, rows, name, advantage);

					} else {

						getGcaAdvantageRow(uniqueKeys, rows, name, advantage, runningTotals, importNotes);

						getMeleeAttackFromGcaTrait(uniqueKeys, rows, advantage, importNotes);

						getRangedAttackFromGcaTrait(uniqueKeys, rows, advantage, importNotes);

						getDefenseFromGcaTrait(uniqueKeys, rows, advantage);
					}

					getGcaModifiersForAdvantage(rows, name, advantage, runningTotals, importNotes);

				}

			});

		}

		if (saveRows) {
			
			setAttrs(rows, {silent: false}, callback);

		} else {

			callback();

		}

	}

	/**
	 * Updates the rows value with an row for advantages
	 * 
	 * @param object  uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows          Object of properties to update/add rows. passed by Ref
	 * @param string  name          Name of the advantage
	 * @param json    advantage     JSON data for the advantage
	 * @param object  runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean importNotes   Option to also import notes.
	 */
	function getGcaAdvantageRow(uniqueKeys, rows, name, advantage, runningTotals, importNotes) {

		let idkey = advantage.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let baseFieldName = `repeating_traits_${rowId}`;

		let fullName = name;

		let levelName;

		let templateName = getGcaTemplateName(idkey, runningTotals);

		if (templateName) {

			// save to racial table instead.
			baseFieldName = `repeating_racial_${rowId}`;

			// if more than one template, prepend the template name
			if (runningTotals.templates.length > 1) {
			
				fullName = `[${templateName}] ${fullName}`;
			}

		}

		if (advantage.nameext) {

			fullName += ` (${advantage.nameext})`;

		}

		if (advantage.levelnames) {

			levelName = getGcaLevelName(advantage);

			if (levelName) {
				fullName += ` (${levelName})`;
			}

		}

		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		if (advantage.level) {
			rows[`${baseFieldName}_trait_level`] = Number(advantage.level);
		}

		if (advantage.points) {
			rows[`${baseFieldName}_points`] = Number(advantage.points);
		} else {
			rows[`${baseFieldName}_points`] = 0;
		}
		
		if (advantage.page) {
			rows[`${baseFieldName}_ref`] = advantage.page;
		}

		let notes = getGcaAdvantageNotes(advantage);

		if (importNotes && notes) {
			rows[`${baseFieldName}_notes`] = notes;
		}

		let controlRating = 0;

		if (levelName) {

			controlRating = getControlRatingByLevelName(levelName);
		
		} 
		
		if (controlRating === 0 ) {

			controlRating = getControlRatingByModifier(advantage);

		}

		if (controlRating > 0) {
			rows[`${baseFieldName}_foa`]  = controlRating;
		}

	}

	/**
	 * Attempts to get an associated template name to the unique key
	 * If no match, returns false
	 *
	 * @param string idkey GCA unique primary key to search for
	 * @param object runningTotals GCA import totals. Passed by reference. 
	 * 
	 * @return ?string
	 */
	function getGcaTemplateName(idkey, runningTotals) {

		let name = false;

		// for info on runningTotals see: function importCharacterSheetWithGCA(
		if (runningTotals.templates && runningTotals.templates.length) {

			runningTotals.templates.forEach(template => {

				if (template.keys && template.keys.includes(idkey)) {
					name = template.name;
				}

			});

		}

		return name;

	}

	/**
	 * Adds the row values for native language fields. 
	 * Currently, non-repeating
	 * 
	 * @param object rows      Object of row properties. Passed by reference
	 * @param string name      Name of advantage
	 * @param string basedon   Language based on
	 * @param json   advantage JSON data for advantage
	 */
	function getGcaValuesForNativeLanguage(rows, name, basedon, advantage) {

		basedon = basedon.toLowerCase();

		let writtenLevel = -3;

		let spokenLevel = -3;

		if (basedon && basedon.includes("spoken")) {

			spokenLevel = getLanguageValueFromGca(advantage.level);

			writtenLevel = -3;

		} else if (basedon && basedon.includes("written")) {

			spokenLevel = -3;

			writtenLevel = getLanguageValueFromGca(advantage.level);

		} else {

			spokenLevel = getLanguageValueFromGca(advantage.level);

			writtenLevel = spokenLevel;

		}

		let fullName = name;

		if (advantage.nameext) {

			fullName += ` (${advantage.nameext})`;

		}

		rows["name_native_language"] = fullName

		rows["native_language_idkey"] = advantage.IDKey;
		
		rows["native_language_spoken"] = spokenLevel;

		rows["native_language_written"] = writtenLevel;

	}

	/**
	 * Get the Roll20 language level from GCA level
	 * 
	 * @param string gcaLevel  The value for the GCA language level
	 * @param bool   repeating Get value for repeating language
	 * 
	 * @return int
	 */
	function getLanguageValueFromGca(gcaLevel, repeating = false) {

		gcaLevel = Number(gcaLevel);

		let roll20Level;

		if (repeating) {

			roll20Level = gcaLevel;
			
		} else {

			switch (gcaLevel) {

				case 1:
					roll20Level = -2
					break;
	
				case 2:
					roll20Level = -1;
					break;
	
				case 3:
					roll20Level = 0;
					break;
				
				default:
					roll20Level = -3;
					break;
	
			}
	
		}
		
		return roll20Level;
	}

	/**
	 * Adds the row values for repeating language fields. 
	 * 
	 * @param object uniqueKeys Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object rows       Object of row properties. Passed by reference
	 * @param string name       Name of advantage
	 * @param string basedon    Language based on
	 * @param json   advantage  JSON data for advantage
	 */
	function getGcaValuesForRepeatingLanguage(uniqueKeys, rows, name, basedon, advantage) {

		basedon =  basedon ? basedon.toLowerCase() : "";

		let idkey = advantage.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let baseFieldName = `repeating_languages_${rowId}`;

		let langName = name.toLowerCase();

		let writtenLevel = "-3";

		let spokenLevel = "-3";

		if (basedon.includes("spoken")) {

			spokenLevel = getLanguageValueFromGca(advantage.level, true);

			writtenLevel = "0";

		} else if (basedon.includes("written")) {

			spokenLevel = "0";

			writtenLevel = getLanguageValueFromGca(advantage.level, true);

		} else {

			spokenLevel = getLanguageValueFromGca(advantage.level, true);

			writtenLevel = spokenLevel;

		}

		let fullName = name;

		if (advantage.nameext) {

			fullName += ` (${advantage.nameext})`;

		}
		
		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		rows[`${baseFieldName}_spoken`] = spokenLevel;

		rows[`${baseFieldName}_written`] = writtenLevel;

		return rows;

	}

	/**
	 * Adds the row values for repeating cultural Familiarities fields. 
	 * 
	 * @param object uniqueKeys Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object rows       Object of row properties. passed by reference
	 * @param string name       Name of advantage
	 * @param json   advantage  JSON data for advantage
	 */
	function getGcaValuesForCulturalFamiliarity(uniqueKeys, rows, name, advantage) {

		let idkey = advantage.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let baseFieldName = `repeating_cultures_${rowId}`;

		let fullName = name;

		if (advantage.nameext) {

			fullName += ` (${advantage.nameext})`;

		}

		let points = 0;

		if (advantage.points) {
			points = Number(advantage.points);
		}
		
		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		rows[`${baseFieldName}_points`] = points;

	}

	/**
	 * Get notes for GCA advantage OR disadvantage
	 * 
	 * @param json advantage JSON object for an GCA advantage
	 */
	function getGcaAdvantageNotes(advantage) {

		let arrNotes = [];

		let notes = "";

		if (advantage.basedon && advantage.basedon != advantage.name) {
			arrNotes.push("Based On: " + advantage.basedon + "\n"); 
		}

		if (advantage.usernotes) {
			arrNotes.push(advantage.usernotes + "\n"); 
		}

		if (advantage.description) {
			arrNotes.push("Description: " + advantage.description + "\n"); 
		}

		let modNote = getGcaModifierNotes(advantage);

		if (modNote) {
			arrNotes.push(modNote);
		}

		if (arrNotes.length) {
			notes = arrNotes.join("\n");
		}

		return notes;
	}

	/**
	 * Gets modifier notes, if any
	 * 
	 * @param json advantage JSON object for an GCA advantage
	 */
	function getGcaModifierNotes(advantage) {

		let arrNotes = [];

		let notes = "";

		if (advantage.Modifier && advantage.Modifier.length) {

			for (let i = 0; i < advantage.Modifier.length; i++) {

				let modifier = advantage.Modifier[i];

				let theNote = `${modifier.name}, ${modifier.value}`;

				let subNote = "";

				// if there's sub-modifiers, get them
				if (modifier.Modifier) {
					
					subNote = getGcaModifierNotes(advantage);

					theNote += `(${subNote})`;

				}

				arrNotes.push(theNote);

			}
			
		} else if (advantage.Modifier) {

			let theNote = `${advantage.Modifier.name}, ${advantage.Modifier.value}`;

			let subNote = "";

			// if there's sub-modifiers, get them
			if (advantage.Modifier.Modifier) {
				
				subNote = getGcaModifierNotes(advantage.Modifier);

				theNote += `(${subNote})`;

			}

			arrNotes.push(theNote);

		}

		if (arrNotes.length) {
			notes = "Modifiers:\n" + arrNotes.join("\n") + "\n";
		}
		
		return notes;
	
	}

	/**
	 * Find additional bonuses and check boxes based on advantage name
	 * 
	 * @param object rows          Current set of rows. passed by reference
	 * @param string name          Name of the advantage
	 * @param json   advantage     GCA JSON advantage data
	 * @param object runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 */
	function getGcaModifiersForAdvantage(rows, name, advantage, runningTotals) {

		let nameCompare = name.toLowerCase();

		switch (nameCompare) {

			case "combat reflexes":
				rows["combat_reflexes"] = 1;
				break;

			case "lifting st":
				rows["lift_st_mod"] = advantage.level;
				break;

			case "striking st":
				rows["striking_st_mod"] = advantage.level;
				break;

			case "magery":
				rows["spell_bonus"] = advantage.level;
				break;

			case "wealth":
				rows["wealth"] = getGcaLevelName(advantage, "Average");
				break;

			case "fit":
				runningTotals.unconscious_check_mod += 1;
				runningTotals.death_check_mod += 1;
				break;

			case "very fit":
				runningTotals.unconscious_check_mod += 2;
				runningTotals.death_check_mod += 2;
				break;

			case "hard to kill":
				let deathMod = Number(advantage.level);
				if (isNaN(deathMod)) {
					deathMod = 0;
				}
				runningTotals.death_check_mod += deathMod;
				break;

			case "hard to subdue":
				let subdueMod = Number(advantage.level);
				if (isNaN(subdueMod)) {
					subdueMod = 0;
				}
				runningTotals.unconscious_check_mod += subdueMod;
				break;

			case "high pain threshold":
				runningTotals.stun_check_mod += 3;
				runningTotals.knockdown_check_mod += 3;
				break;

		}

	}

	/**
	 * Find additional modifiers and check boxes based on disadvantage name
	 * 
	 * @param object  rows          Current set of rows. Passed by reference
	 * @param string  name          Name of the disadvantage
	 * @param json    disadvantage  GCA json object
	 * @param object  runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean importNotes   Option to also import notes. possible future updates may need field
	 * 
	 * @return rows
	 */
	function getGcaModifiersDisadvantage(rows, name, disadvantage, runningTotals, importNotes) {

		let nameCompare = name.toLowerCase();

		switch (nameCompare) {

			case "wealth":
				rows["wealth"] = getGcaLevelName(disadvantage, "Average");
				break;

			case "low pain threshold":
				runningTotals.stun_check_mod += -3;
				runningTotals.knockdown_check_mod += -4;
				break;

		}

	}

	/**
	 * Updates Perks and Quirks
	 * TODO: Check to see if Perk or Quirk already exists, then update
	 * 
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      Json DATA from GCA file
	 * @param object   runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      A function to run after updating is complete
	 */
	function importGcaPerksQuirks(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let perks = getJsonArrayFromTrait(jsonData.Character.Traits.Perks);

		let quirks = getJsonArrayFromTrait(jsonData.Character.Traits.Quirk);

		let rows = {};

		if (perks && perks.length) {

			perks.forEach(perk => {

				let name = perk.name;

				getGcaValuesForPerksQuirks(uniqueKeys, "perk", rows, name, perk, runningTotals, importNotes);
				
			});

		}

		if (quirks && quirks.length) {

			quirks.forEach(quirk => {

				let name = quirk.name;

				getGcaValuesForPerksQuirks(uniqueKeys, "quirk", rows, name, quirk, runningTotals, importNotes);
				
			});

		}

		setAttrs(rows, {silent: false}, callback);

	}


	/**
	 * Get the row values for repeating perks or quirks
	 * 
	 * @param object  uniqueKeys     Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param string  type          Type = perk | quirk
	 * @param object  rows          Rows for setAttr() function. passed by reference
	 * @param string  name          Name of the quirk or perk
	 * @param json    perkOrQuirk   object of perk or quirk
	 * @param object  runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean importNotes   Option to also import notes.
	 */
	function getGcaValuesForPerksQuirks(uniqueKeys, type, rows, name, perkOrQuirk, runningTotals, importNotes) {

		let idkey = perkOrQuirk.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);
		
		let baseFieldName;

		let fullName = name;

		let templateName = getGcaTemplateName(idkey, runningTotals);
		
		if (templateName) {
			
			// save to racial table instead.
			baseFieldName = `repeating_racial_${rowId}`;

			// if more than one template, prepend the template name
			if (runningTotals.templates.length > 1) {
			
				fullName = `[${templateName}] ${fullName}`;
			}

		} else if (type === "perk") {
			
			baseFieldName = `repeating_perks_${rowId}`;
		
		} else {
			
			baseFieldName = `repeating_quirks_${rowId}`;
		
		}

		if (perkOrQuirk.nameext) {

			fullName += ` (${perkOrQuirk.nameext})`;

		}

		let points = 0;

		if (perkOrQuirk.points) {
			points = Number(perkOrQuirk.points);
		}
		
		rows[`${baseFieldName}_idkey`]  = idkey;

		rows[`${baseFieldName}_name`]   = fullName;

		rows[`${baseFieldName}_points`] = points;

		if (perkOrQuirk.page) {
			rows[`${baseFieldName}_ref`]    = perkOrQuirk.page;
		}
		
		if (importNotes && perkOrQuirk.usernotes) {
			rows[`${baseFieldName}_notes`]  = perkOrQuirk.usernotes;
		}

	}

	/**
	 * Import GCA disadvantages
	 * TODO: Add Update feature. Currently only does insert
	 *  
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      Json DATA from GCA file
	 * @param object   runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      A function to run after updating is complete
	 * 
	 * @return void
	 */
	function importGcaDisadvantages(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let disadvantages = getJsonArrayFromTrait(jsonData.Character.Traits.Disadvantage);

		let rows = {};

		if (disadvantages && disadvantages.length) {

			disadvantages.forEach(disadvantage => {

				let name = disadvantage.name;

				getGcaValuesForDisadvantage(uniqueKeys, rows, name, disadvantage, runningTotals, importNotes);

				getGcaModifiersDisadvantage(rows, name, disadvantage, runningTotals, importNotes);
				
			});

		}

		setAttrs(rows, {silent: false}, callback);

	}

	/**
	 * Get row values for the disadvantage
	 * check for additional non-repeating values based on name 
	 * 
	 * @param object  uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows          Rows for setAttr() function. Passed by Reference
	 * @param string  name          Name of the quirk or perk
	 * @param json    disadvantage  object disadvantage
	 * @param object  runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean importNotes   Option to also import notes.
	 */
	function getGcaValuesForDisadvantage(uniqueKeys, rows, name, disadvantage, runningTotals, importNotes)
	{
		let idkey = disadvantage.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);
		
		let fullName = name;

		let levelName;

		let baseFieldName = `repeating_disadvantages_${rowId}`;

		let templateName = getGcaTemplateName(idkey, runningTotals);

		if (templateName) {

			// save to racial table instead.
			baseFieldName = `repeating_racial_${rowId}`;

			// if more than one template, prepend the template name
			if (runningTotals.templates.length > 1) {
			
				fullName = `[${templateName}] ${fullName}`;
			}

		}

		if (disadvantage.nameext) {

			fullName += ` (${disadvantage.nameext})`;

		}

		if (disadvantage.levelnames) {

			levelName = getGcaLevelName(disadvantage);

			if (levelName) {
				fullName += ` (${levelName})`;
			}
			
		}

		let points = 0;

		if (disadvantage.points) {
			points = Number(disadvantage.points);
		}
		
		rows[`${baseFieldName}_idkey`]  = idkey;

		rows[`${baseFieldName}_name`]   = fullName;

		rows[`${baseFieldName}_points`] = points;

		if (disadvantage.page) {
			rows[`${baseFieldName}_ref`] = disadvantage.page;
		}
		
		if (importNotes) {
			rows[`${baseFieldName}_notes`]  = getGcaAdvantageNotes(disadvantage);
		}
		
		if (disadvantage.level) {
			rows[`${baseFieldName}_trait_level`]  = disadvantage.level;
		}

		let controlRating = 0;

		if (levelName) {

			controlRating = getControlRatingByLevelName(levelName);
		
		} 
		
		if (controlRating === 0 ) {

			controlRating = getControlRatingByModifier(disadvantage);

		}

		if (controlRating > 0) {
			rows[`${baseFieldName}_control_rating`]  = controlRating;
		}

		getGcaValuesByDisadvantageName(rows, name, disadvantage);

	}

	/**
	 * Get control or frequency number from level name
	 * 
	 * @param string levelName Name of level
	 * 
	 * @return int
	 */
	function getControlRatingByLevelName(levelName) {

		let rating = 0;

		if (levelName && levelName.includes("6 or less")) {
			
			rating = 6;
			
		} else if (levelName && levelName.includes("9 or less")) {
			
			rating = 9;
			
		} else if (levelName && levelName.includes("12 or less")) {
			
			rating = 12;
			
		} else if (levelName && levelName.includes("15 or less")) {
			
			rating = 15;
			
		}

		return rating;

	}

	/**
	 * Search Modifiers of an attribute for control
	 * or frequency values
	 * 
	 * @param json attribute Advantage or disadvantage to search modifiers
	 * 
	 * @return int
	 */ 
	function getControlRatingByModifier(attribute) {

		let rating = 0;

		let shortName = "";

		if (attribute.Modifier && attribute.Modifier.length) {

			for (let i = 0; i < attribute.Modifier.length; i++) {

				let modifier = attribute.Modifier[i];

				if (modifier.shortname && modifier.shortname.includes("or less")) {

					shortName = modifier.shortname;

				}
				
			}

		} else if (attribute.Modifier) {

			shortName = attribute.Modifier.shortname;

		}

		if (shortName && shortName.includes("6 or less")) {
			
			rating = 6;
			
		} else if (shortName && shortName.includes("9 or less")) {
			
			rating = 9;
			
		} else if (shortName && shortName.includes("12 or less")) {
			
			rating = 12;
			
		} else if (shortName && shortName.includes("15 or less")) {
			
			rating = 15;
			
		}	

		return rating;

	}

	/**
	 * Get any special non-repeating fields based on disadvantage name
	 * 
	 * @param object rows         Rows for setAttr() function. Pass by reference
	 * @param string name         Name of the quirk or perk
	 * @param json   disadvantage object of perk or quirk
	 * 
	 * @return object
	 */
	function getGcaValuesByDisadvantageName(rows, name, disadvantage) {

		let nameCheck = name.toLowerCase();

		switch (nameCheck) {

			case "appearance":
				
				if (disadvantage.points) {
					rows["appearance"] = disadvantage.points;
				}
				 
				break;

			default:
				// do nothing
				break;

		}
		
	}

	/**
	 * Parses the level name for a GCA attribute
	 * Such as advantage, disadvantage, perk, and quirk
	 * 
	 * @param json   attribute    JSON object for GCA attribute: advantage, disadvantage, etc.
	 * @param string defaultValue Default value if no value is found
	 * 
	 * @return string
	 */
	function getGcaLevelName(attribute, defaultValue = "") {

		let name = defaultValue;

		if (attribute && attribute.levelnames && attribute.levelnames.includes(",") && attribute.level) {

			// get rid of spaces between commas (seems to change from advantage to advantage)
			let levelNames = attribute.levelnames.replaceAll(", ", ",");

			let arrNames = levelNames.split(",");

			let level = Number(attribute.level);

			// NOTE: Appearance index needs to start at 1 so we can ignore "average"
			if (attribute.name.toLowerCase() !== "appearance" && attribute.name.toLowerCase() !== "wealth") {
				level = level - 1;
			}

			name = arrNames[level];
		
		}
		
		return name;

	}

	/**
	 * Import GCA Skills
	 * TODO: Add Update feature. Currently only does insert
	 *  
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      Json DATA from GCA file
	 * @param object   runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      A function to run after updating is complete
	 * 
	 * @return void
	 */
	function importGcaSkills(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let skills = getJsonArrayFromTrait(jsonData.Character.Traits.Skill);

		let rows = {};

		if (skills && skills.length) {

			skills.forEach(skill => {

				let name = skill.name;

				if (skill.type && !skill.type.includes("Tech")) {

					getGcaValuesForSkill(uniqueKeys, rows, name, skill, importNotes);

					getMeleeAttackFromGcaTrait(uniqueKeys, rows, skill, importNotes);

					getRangedAttackFromGcaTrait(uniqueKeys, rows, skill, importNotes);

					getDefenseFromGcaTrait(uniqueKeys, rows, skill);
				
				}
				
			});

		}

		setAttrs(rows, {silent: false}, callback);

	}

	/**
	 * Get values for repeating skill
	 * 
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Rows for setAttr() function. Passed by reference
	 * @param string  name        Name of the skill
	 * @param json    skill       object for skill
	 * @param boolean importNotes Option to also import notes.
	 */
	function getGcaValuesForSkill(uniqueKeys, rows, name, skill, importNotes) {

		let idkey = skill.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);
		
		let fullName = name;

		let baseFieldName = `repeating_skills_${rowId}`;

		let levelName;

		if (skill.nameext) {

			fullName += ` (${skill.nameext})`;

		}

		if (skill.levelnames) {

			levelName = getGcaLevelName(skill);

			if (levelName) {
				fullName += ` (${levelName})`;
			}
			
		}

		let points = 0;

		if (skill.points) {
			points = Number(skill.points);
		}
		
		rows[`${baseFieldName}_idkey`]  = idkey;

		rows[`${baseFieldName}_name`]   = fullName;

		rows[`${baseFieldName}_points`] = points;

		if (skill.page) {
			rows[`${baseFieldName}_ref`] = skill.page;
		}

		if (skill.tl) {
			rows[`${baseFieldName}_tl`] = skill.tl;
		}

		let [attributeValue, difficultyValue] = getSkillAttributeDifficultyForGca(skill.type);
		
		rows[`${baseFieldName}_base`] = attributeValue;

		rows[`${baseFieldName}_difficulty`] = difficultyValue;

		if (importNotes) {
			rows[`${baseFieldName}_notes`]  = getGcaNotesForSkillTechnique(skill);
		}
		
		// check for modifiers
		if (skill.level && skill.baselevel) {
			
			let skillLevel = Number(skill.level);

			let baseSkillLevel = Number(skill.baselevel);

			if (skillLevel !== baseSkillLevel) {

				let skillMod = skillLevel - baseSkillLevel;

				rows[`${baseFieldName}_bonus`]  = skillMod;

			}
		}
		
	}

	/**
	 * Returns an array of attribute and difficulty drop-down values
	 * 
	 * @param strin skillType Skill type: attribute/difficulty level
	 * 
	 * @return array [attributeValue, difficultyValue]
	 */
	function getSkillAttributeDifficultyForGca(skillType) {

		// type = DX/A
		let arrType = skillType.split("/");

		let attribute = arrType[0];

		let difficulty = arrType[1];

		let attributeValue;

		let difficultyValue;

		switch(attribute) {

			case "ST":
				attributeValue = "@{strength}";
				break;

			case "DX":
				attributeValue = "@{dexterity}";
				break;

			case "IQ":
				attributeValue = "@{intelligence}";
				break;

			case "HT":
				attributeValue = "@{health}";
				break;

			case "Will":
				attributeValue = "@{willpower}";
				break;

			case "Per":
				attributeValue = "@{perception}";
				break;

			default:
				attributeValue = "@{dexterity}";
				break;

		}

		switch(difficulty) {
			
			case "E":
				difficultyValue = -1;
				break;

			case "A":
				difficultyValue = -2;
				break;

			case "H":
				difficultyValue = -3;
				break;

			case "VH":
				difficultyValue = -4;
				break;

			case "WC":
				difficultyValue = "-5 + 1";
				break;

			default: 
				difficultyValue = -2;
				break;
		}

		return [attributeValue, difficultyValue];

	}

	/**
	 * Get any additional notes for skill/technique
	 * 
	 * @param json skillOrTechnique JSON object for skill or technique
	 * @param bool useBasedOn       If true, include basedon notes.
	 * @return string
	 */
	function getGcaNotesForSkillTechnique(skillOrTechnique, useBasedOn = true) {

		let arrNotes = [];

		let notes = "";

		if (useBasedOn && skillOrTechnique.basedon && skillOrTechnique.basedon != skillOrTechnique.name) {
			arrNotes.push("Based On: " + skillOrTechnique.basedon + "\n"); 
		}

		if (skillOrTechnique.usernotes) {
			arrNotes.push(skillOrTechnique.usernotes + "\n"); 
		}

		if (skillOrTechnique.description) {
			arrNotes.push(skillOrTechnique.description + "\n");
		}

		if (skillOrTechnique.gives) {
			arrNotes.push("Gives: " + skillOrTechnique.gives + "\n"); 
		}

		if (arrNotes.length) {
			notes = arrNotes.join("\n");
		}

		return notes;

	}

	/**
	 * Import GCA Techniques
	 * TODO: Add Update feature. Currently only does insert
	 *  
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      Json DATA from GCA file
	 * @param object   runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      A function to run after updating is complete
	 * 
	 * @return void
	 */
	function importGcaTechniques(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let skills = getJsonArrayFromTrait(jsonData.Character.Traits.Skill);

		let rows = {};

		if (skills && skills.length) {

			skills.forEach(skill => {

				let name = skill.name;

				if (skill.type && skill.type.includes("Tech")) {

					getGcaValuesForTechniques(uniqueKeys, rows, name, skill, skills, importNotes);

					getMeleeAttackFromGcaTrait(uniqueKeys, rows, skill, importNotes);

					getRangedAttackFromGcaTrait(uniqueKeys, rows, skill, importNotes);

					getDefenseFromGcaTrait(uniqueKeys, rows, skill, importNotes);
				
				}
				
			});

		}

		setAttrs(rows, {silent: false}, callback);

	}

	/**
	* Get values for repeating skill techniques
	* 
	* @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	* @param object  rows        Rows for setAttr() function. passed by reference
	* @param string  name        Name of the skill
	* @param json    skill       object for skill
	* @param json    skills      All the json skills from GCA
	* @param boolean importNotes Option to also import notes.
	*/
	function getGcaValuesForTechniques(uniqueKeys, rows, name, skill, skills, importNotes) {

		let idkey = skill.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let fullName = name;

		let baseFieldName = `repeating_techniquesrevised_${rowId}`;

		let points = 0;

		if (skill.points) {
			points = Number(skill.points);
		}

		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		rows[`${baseFieldName}_points`] = points;

		if (skill.page) {
			rows[`${baseFieldName}_ref`] = skill.page;
		}

		// NOTE: attributeValue is not needed, it just identifies the skill as a technique
		let difficultyValue = getTechniqueDifficultyFromGca(skill.type);

		rows[`${baseFieldName}_default`] = getGcaTechniqueDefaultValue(skill);

		rows[`${baseFieldName}_max_modifier`] = getGcaTechniqueMaxValue(skill);

		let baseSkill  = getGcaTechniqueBaseSkillInfo(skill, skills);

		if (baseSkill) {

			let parentName = baseSkill.name;

			if (baseSkill.nameext) {
				parentName += ` (${baseSkill.nameext})`;
			}

			rows[`${baseFieldName}_parent`] = parentName;

			rows[`${baseFieldName}_base_level`] = baseSkill.level;

		}

		rows[`${baseFieldName}_difficulty`] = difficultyValue;

		if (importNotes) {
			rows[`${baseFieldName}_notes`]  = getGcaNotesForSkillTechnique(skill, false);
		}
		
	}

	/**
	 * Parses the default value of a technique
	 * 
	 * @param json skill JSON object for skill
	 * 
	 * @return int
	 */
	function getGcaTechniqueDefaultValue(skill) {

		// example: "default": "\"SK:Brawling::level\" - 1",
		let techDefault = "";

		if (skill.default) {
			techDefault = skill.default;
		} 

		let arrDefault;

		let defaultValue = 0;

		if (techDefault && techDefault.includes(" - ")) {
			
			arrDefault = techDefault.split(" - ");

			defaultValue = -1 * Number(arrDefault[1]);

		} else if (techDefault && techDefault.includes(" + ")) {
			
			arrDefault = techDefault.split(" + ");

			defaultValue = Number(arrDefault[1]);

		}  

		return defaultValue;
	}

	/**
	 * Parses upto field to determine max value modifier
	 * 
	 * @param json skill JSON object for skill
	 * 
	 * @return int
	*/ 
	function getGcaTechniqueMaxValue(skill) {

		// example: "upto": "prereq + 4",
		let upto = "";

		if (skill.upto) {
			upto = skill.upto;
		}

		let arrUpto;

		let maxValue = 0;

		if (upto && upto.includes(" - ")) {
			
			arrUpto = upto.split(" - ");

			maxValue = -1 * Number(arrUpto[1]);

		} else if (upto && upto.includes(" + ")) {
			
			arrUpto = upto.split(" + ");

			maxValue = Number(arrUpto[1]);

		}  

		return maxValue;

	}

	/**
	 * Tries to find the base skill for technique
	 * returns matching skill object
	 * 
	 * @param json skill  Skill technique to find base skill for
	 * @param json skills A list of skills from GCA
	 * 
	 * @return json baseSkill
	 */
	function getGcaTechniqueBaseSkillInfo(skill, skills) {

		let baseSkill;

		skills.forEach(searchSkill => {

			if (searchSkill.IDKey.trim() === skill.deffromid.trim()) {
				baseSkill = searchSkill;
			}
			
		});

		return baseSkill;
	}

	/**
	 * Get the difficulty level of technique
	 * 
	 * @param string skillType skill type. example: Tech/A
	 */
	function getTechniqueDifficultyFromGca(skillType) {

		let difficulty = "Average";

		if (skillType === "Tech/H") {
			difficulty = "Hard";
		}

		return difficulty;

	}

	/**
	 * Import GCA Equipment 
	 * TODO: Add ability to update existing equipment
	 * 
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      GCA JSON data
	 * @param object   runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      Function to run after importing
	 */ 
	function importGcaEquipment(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let items = getJsonArrayFromTrait(jsonData.Character.Traits.Equipment);

		let rows = {};

		if (items && items.length) {

			items.forEach(item => {

				let name = item.name;

				getGcaValuesForEquipment(uniqueKeys, rows, name, item, importNotes);

				getMeleeAttackFromGcaTrait(uniqueKeys, rows, item, importNotes);

				getRangedAttackFromGcaTrait(uniqueKeys, rows, item, importNotes);
				
				getDefenseFromGcaTrait(uniqueKeys, rows, item);

			});

		}

		setAttrs(rows, {silent: false}, callback);

	}

	/**
	 * Get the row values for GCA equipment
	 * 
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Object for updating repeating table. passed by reference
	 * @param string  name        Name of equipment
	 * @param json    item        JSON object of equipment
	 * @param boolean importNotes Option to also import notes.
	 */ 
	function getGcaValuesForEquipment(uniqueKeys, rows, name, item, importNotes) {

		let idkey = item.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let fullName = name;

		let baseFieldName = `repeating_item_${rowId}`;

		if (item.nameext) {

			fullName += ` (${item.nameext})`;

		}

		if (item.levelnames) {

			levelName = getGcaLevelName(item);

			if (levelName) {
				fullName += ` (${levelName})`;
			}
			
		}

		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		if (item.location) {
			rows[`${baseFieldName}_location`] = item.location;
		}

		if (item.techlvl) {
			rows[`${baseFieldName}_tl`] = item.techlvl;
		}
		
		if (item.lc) {
			rows[`${baseFieldName}_legality_class`] = item.lc;
		}
		
		if (item.page) {
			rows[`${baseFieldName}_ref`] = item.page;
		}

		if (item.count) {
			rows[`${baseFieldName}_count`] = Number(item.count);
		}
		
		if (item.basecost) {
			rows[`${baseFieldName}_cost`] = Number(item.basecost);
		}
		
		if (item.baseweight) {
			rows[`${baseFieldName}_weight`] = Number(item.baseweight);
		}
		
		if (importNotes) {
			rows[`${baseFieldName}_notes`] = getGcaNotesForEquipment(item);
		}
		
	}

	/**
	 * Get any additional notes for equipment
	 * 
	 * @param json item   JSON object for item
	 *
	 * @return string
	 */
	function getGcaNotesForEquipment(item) {

		let arrNotes = [];

		let notes = "";

		if (item.usernotes) {
			arrNotes.push(item.usernotes + "\n"); 
		}

		if (item.description) {
			arrNotes.push(item.description + "\n");
		}

		if (item.gives) {
			arrNotes.push("Gives: " + item.gives + "\n"); 
		}

		if (arrNotes.length) {
			notes = arrNotes.join("\n");
		}

		return notes;

	}

	/**
	 * Get any additional notes for template
	 * 
	 * @param json item JSON object for item
	 *
	 * @return string
	 */
	function getGcaNotesForTemplate(item) {

		let arrNotes = [];

		let notes = "";

		if (item.gives) {
			arrNotes.push("Gives: " + item.gives + "\n"); 
		}

		if (item.features) {
			arrNotes.push("Features: " + item.features + "\n"); 
		}

		if (item.usernotes) {
			arrNotes.push(item.usernotes + "\n"); 
		}

		if (item.description) {
			arrNotes.push(item.description + "\n");
		}

		if (arrNotes.length) {
			notes = arrNotes.join("\n");
		}

		return notes;

	}

	/**
	 * Import GCA Spells 
	 * TODO: Add ability to update existing spells
	 * 
	 * @param object   uniqueKeys    Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param json     jsonData      GCA JSON data
	 * @param object   runningTotals An object that keeps track of running totals. NOTE: passed by reference
	 * @param boolean  importNotes   Option to also import notes.
	 * @param function callback      Function to run after importing
	 */ 
	function importGcaSpells(uniqueKeys, jsonData, runningTotals, importNotes, callback) {

		// make sure we have a valid function
		callback = callback || noop;

		let spells = getJsonArrayFromTrait(jsonData.Character.Traits.Spell);

		let rows = {};

		getAttrs(["spell_bonus"], values => {

			let magery = Number(values.spell_bonus);
			
			if (spells && spells.length) {

				spells.forEach(spell => {

					let name = spell.name;

					getGcaValuesForSpell(uniqueKeys, rows, name, spell, magery, importNotes);

					getMeleeAttackFromGcaTrait(uniqueKeys, rows, spell, importNotes);

					getRangedAttackFromGcaTrait(uniqueKeys, rows, spell, importNotes);

					getDefenseFromGcaTrait(uniqueKeys, rows, spell);
					
				});

			}

			setAttrs(rows, {silent: false}, callback);

		});

	}

	/**
	 * Get the row values for GCA Spell
	 * 
	 * @param object  uniqueKeys  Key values pairs for unique idkey and associated row id. Passed by reference
	 * @param object  rows        Object for updating repeating table. passed by reference
	 * @param string  name        Name of spell
	 * @param json    spell       JSON object of spell
	 * @param int     magery      Magery level of character
	 * @param boolean importNotes Option to also import notes.
	 * 
	 * @return object
	 */ 
	function getGcaValuesForSpell(uniqueKeys, rows, name, spell, magery, importNotes) {

		let idkey = spell.IDKey.trim();

		let rowId = generateOrGetRowId(uniqueKeys, idkey);

		let fullName = name;

		let baseFieldName = `repeating_spells_${rowId}`;

		if (spell.nameext) {

			fullName += ` (${spell.nameext})`;

		}

		if (spell.levelnames) {

			levelName = getGcaLevelName(spell);

			if (levelName) {
				fullName += ` (${levelName})`;
			}
			
		}

		rows[`${baseFieldName}_idkey`] = idkey;

		rows[`${baseFieldName}_name`] = fullName;

		rows[`${baseFieldName}_level`] = spell.level;

		rows[`${baseFieldName}_difficulty`] = getSpellDifficultyFromGca(spell.type);

		let spellModifier = 0;

		let spellBaseLevel = 0;

		if (spell.baselevel) {

			spellModifier = Number(spell.level) - ( Number(spell.baselevel ) + magery);

		}

		rows[`${baseFieldName}_spell_modifier`] = spellModifier;

		rows[`${baseFieldName}_points`] = Number(spell.points);

		let [spellClass, resistedby] = getSpellClassResistedByFromGca(spell);

		rows[`${baseFieldName}_spell_resisted_by`] = resistedby;

		rows[`${baseFieldName}_spell_class`] = spellClass;

		if (spell.duration) {
			rows[`${baseFieldName}_duration`] = spell.duration;
		}

		if (spell.castingcost) {
			rows[`${baseFieldName}_cost`] = spell.castingcost;
		}

		if (spell.time) {
			rows[`${baseFieldName}_casttime`] = spell.time;
		}

		if (spell.cat) {
			rows[`${baseFieldName}_spell_college`] = spell.cat;
		}

		if (importNotes) {
			rows[`${baseFieldName}_spell_notes`] = getSpellNotesFromGcaSpell(spell);
		}

		if (spell.ref) {

			rows[`${baseFieldName}_ref`] = spell.page;
		
		}

	}

	/**
	 * Get the spell difficulty based on spell type
	 * 
	 * @param string spellType Spell Type: IQ/H | IQ/VH
	 * 
	 * @return int
	 */
	function getSpellDifficultyFromGca(spellType) {

		let difficulty = -3;

		if (spellType === "IQ/VH") {
			difficulty = -4;
		}

		return difficulty;
	}

	/**
	 * Get the spell's class and resisted by (if any)
	 * from spell.class property
	 * 
	 * @param json spell GCA Spell JSON object
	 * 
	 * @return array [spellClass, resistedby]
	 */
	function getSpellClassResistedByFromGca(spell) {

		let spellClass;
		
		let resistedby = "";

		// example: "class": "Regular/R-HT",
		if (spell.class && spell.class.includes("/R-")) {

			let arrClass = spell.class.split("/R-");

			spellClass = arrClass[0];

			resistedby = arrClass[1];

		} else {

			spellClass = spell.class;

		}

		return [spellClass, resistedby];
	}

	/**
	 * Compiles spell notes from GCA Spell object
	 * 
	 * @param json spell GCA spell object
	 * 
	 * @return string
	 */
	function getSpellNotesFromGcaSpell(spell) {

		let arrNotes = [];

		let notes = "";

		if (spell.usernotes) {
			arrNotes.push(spell.usernotes + "\n"); 
		}

		if (spell.description) {
			arrNotes.push(spell.description + "\n"); 
		}

		if (spell.needs) {
			arrNotes.push("Needs: " + spell.needs + "\n"); 
		}

		if (spell.gives) {
			arrNotes.push("Gives: " + spell.gives + "\n"); 
		}

		if (arrNotes.length) {
			notes = arrNotes.join("\n");
		}

		return notes;

	}

	/*** MODIFIER PROMPT OPTIONS ***/

	// if roll option in header changes, update the sheet option
	on("change:roll_option_header", event => {

		getAttrs(["roll_option_header"], values => {

			let option = values.roll_option_header;

			setAttrs({roll_option: option});

		});

	});

	// check for roll options and changes to custom roll macro
	on("change:custom_roll_macro change:roll_option", event => {

		getAttrs(["roll_option", "custom_roll_macro"], values => {

			let rollOption = values.roll_option;

			rollOption = rollOption.trim();

			let customMacro = values.custom_roll_macro;

			customMacro = customMacro.trim();

			let rollMacro = "";

			if (rollOption === "deprecated") {

				rollMacro = "/w gm --l ";

			} else if (rollOption === "private") {

				rollMacro = "/w gm ";

			} else if (rollOption === "custom") {

				rollMacro = customMacro;

			}

			setAttrs({roll: rollMacro}, {silent: true}, () => {

				setAttrs({roll_option_header: rollOption});

			});

		});

	});

	/**
	 * Needed to add a new attr_roll_option to handle
	 * a custom roll macro. This code makes sure the 
	 * correct roll option is selected when the sheet opens.
	 */
	function syncRollOptions() {

		getAttrs(["roll"], values => {

			let rollValue = values.roll ?? "";

			let rollOption;

			console.log("rollValue", rollValue);

			rollValue = rollValue.trim();

			if (rollValue === "") {
				rollOption = "public";
			} else if (rollValue === "/w gm --l") {
				rollOption = "deprecated";
			} else if (rollValue === "/w gm") {
				rollOption = "private";
			} else {
				rollOption = "custom";
			}

			setAttrs({roll_option: rollOption, roll_option_header: rollOption}, {silent: true});

		});

	}

	/*** MODIFIER PROMPT OPTIONS ***/

	// if modifier option in header changes, update the sheet option
	on("change:modifier_option_header", event => {

		getAttrs(["modifier_option_header"], values => {

			updateModifierPromptValues(values.modifier_option_header);

		});

	});

	// check for modifier options
	on("change:modifier_option", event => {

		getAttrs(["modifier_option"], values => {

			updateModifierPromptValues(values.modifier_option);

		});

	});

	/**
	 * Sync the values for modifier, modifier_option,
	 * and modifier_option_header if a new prompt option is selected
	 * 
	 * @param string option 0 = no, 1 = single, 2 = extended
	 */
	function updateModifierPromptValues(option) {
		
		// no prompt
		let promptMacro = "0";

		if (option === "1") {

			// single prompt
			promptMacro = "[[?{Modifier|0}]]";

		} else if (option === "2") {

			// extended prompt
			promptMacro = "[[?{Modifier|0}]] +[[?{Shock|0}]] + [[?{Reeling or Staggered|0}]] + [[?{Off-Hand|0}]] + [[?{Familiarity|0}]]";

		}

		setAttrs({
			modifier: promptMacro,
			modifier_option: option,
			modifier_option_header: option		
		}, {silent: true});

	}

	/**
	 * Needed to add a new attr_modifier_option to handle
	 * skill modifier prompts. This code makes sure the 
	 * correct roll option is selected when the sheet opens.
	 */
	 function syncModifierPromptOptions() {

		getAttrs(["modifier"], values => {

			let modValue = values.modifier;

			let option = "0";

			modValue = modValue.trim();

			// check for old modifier prompt values and fix
			if (modValue === "?{Modifier|0}") {

				modValue = "[[?{Modifier|0}]]";

			} else if (modValue === "?{Modifier|0} + ?{Shock|0} + ?{Reeling or Staggered|0} + ?{Off-Hand|0} + ?{Familiarity|0}") {
				
				modValue = "[[?{Modifier|0}]] +[[?{Shock|0}]] + [[?{Reeling or Staggered|0}]] + [[?{Off-Hand|0}]] + [[?{Familiarity|0}]]";

			}

			if (modValue === "[[?{Modifier|0}]]") {
				option = "1";
			} else if (modValue === "[[?{Modifier|0}]] +[[?{Shock|0}]] + [[?{Reeling or Staggered|0}]] + [[?{Off-Hand|0}]] + [[?{Familiarity|0}]]") {
				option = "2";
			} 

			setAttrs({
				modifier: modValue,
				modifier_option: option, 
				modifier_option_header: option
			}, {silent: true});

		});

	}



</script>
